<!DOCTYPE html>
<html lang="en">
<head>
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  K-MUDANG Pro v4.12.6                                                         ‚ïë
‚ïë  Ancient Korean Four Pillars Destiny Analysis & Lottery Number Generator      ‚ïë
‚ïë                                                                                ‚ïë
‚ïë  v4.12.6 Changes (CRITICAL: 12Ïö¥ÏÑ± ÏùåÍ∞Ñ ÏàòÏ†ï) (MAJOR FIX - Ïã†Í∞ï/Ïã†ÏïΩ Î°úÏßÅ ÏõêÎ≥∏ Î∞©Ïãù ÌÜµÏùº):                  ‚ïë
‚ïë    - [FIX] calcStrength ÏõêÎ≥∏ Î∞©ÏãùÏúºÎ°ú Ï†ÑÎ©¥ Ïû¨ÏûëÏÑ±                              ‚ïë
‚ïë    - [FIX] ÏõîÎ†π Í∞ÄÏ§ëÏπò: ms*6 ‚Üí ms*4 (ÏõêÎ≥∏Í≥º ÎèôÏùº)                             ‚ïë
‚ïë    - [FIX] 12Ïö¥ÏÑ± Ï†êÏàò calcStrengthÏóê Ï∂îÍ∞Ä (ÏõêÎ≥∏ÏóêÏÑú ÎàÑÎùΩÎêêÎçò Î∂ÄÎ∂Ñ)            ‚ïë
‚ïë    - [FIX] ÌÜµÍ∑º Í≥ÑÏÇ∞ ÏõêÎ≥∏ Î∞©Ïãù ÌÜµÏùº                                            ‚ïë
‚ïë    - [FIX] Ï≤úÍ∞ÑÌï© Ïù∏Ï†ëÏÑ± Ï≤¥ÌÅ¨ Ïú†ÏßÄ                                             ‚ïë
‚ïë                                                                                ‚ïë
‚ïë  v4.12.3 Changes:                                                             ‚ïë
‚ïë    - [CRITICAL] calcDayPillar Áî≤Êàå(+10) Î≥¥Ï†ï ÏàòÏ†ï                             ‚ïë
‚ïë                                                                                ‚ïë
‚ïë  Business: K-MUDANG (ÏºÄÏù¥Î¨¥Îãπ) | Registration: 487-20-02668                   ‚ïë
‚ïë  Contact: kmudang.official@gmail.com                                          ‚ïë
‚ïë  Last Updated: 2025-01-16                                                     ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>K-MUDANG Pro | Four Pillars Destiny & Lottery</title>
<meta name="description" content="Ancient Korean Four Pillars Destiny Analysis for Powerball & Mega Millions. Professional Saju fortune reading.">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="K-MUDANG Pro | Four Pillars Destiny & Lottery">
<meta property="og:description" content="üîÆ Professional Four Pillars Analysis ¬∑ üé∞ Powerball & Mega Millions Numbers">
<meta property="og:image" content="https://raw.githubusercontent.com/shrmsdl-netizen/k-mudang/main/og-image.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Noto+Serif+KR:wght@400;700;900&family=Cinzel+Decorative:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- Paddle.js -->
<script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>

<script>
/* ========================================
   Toast Function (Early Definition)
   ======================================== */
function toast(msg) {
    const t = document.getElementById('toast');
    if (t) {
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    } else {
        console.log('Toast:', msg);
        alert(msg); // Fallback if toast element not ready
    }
}

/* ========================================
   Firebase & Paddle Configuration
   ======================================== */
const firebaseConfig = {
    apiKey: "AIzaSyBG8P5KYAo3vTcJBm0rNsAmTgRm8Nt3Rgw",
    authDomain: "k-mudang-pro.firebaseapp.com",
    projectId: "k-mudang-pro",
    storageBucket: "k-mudang-pro.firebasestorage.app",
    messagingSenderId: "287683280564",
    appId: "1:287683280564:web:6168a13d4f1302f0fe21e1",
    measurementId: "G-044J002H6P"
};

// Paddle Price IDs - Î≥µÏ±Ñ(Á¶èÂÇµ) ÏòµÏÖò
const PADDLE_PRICES = {
    basic: { id: 'pri_01kf06tck44xzkavtqz38gkmk2', amount: 10, label: '$10' },
    blessed: { id: 'pri_01kf094v5gc1nj6t9xeptsc0ck', amount: 20, label: '$20' },
    sacred: { id: 'pri_01kf095hgzg08a5nqy8v1g1vad', amount: 50, label: '$50' }
};
const PREMIUM_DURATION_HOURS = 24;

/* ========================================
   Premium State Management
   ======================================== */
let auth = null;
let db = null;
let currentUser = null;
let isPremium = false;
let premiumExpiry = null;
let firebaseReady = false;
let paddleReady = false;

// Initialize Firebase when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Check if running locally (file://)
    if (window.location.protocol === 'file:') {
        console.warn('Running locally - Firebase requires http:// or https://');
        setTimeout(() => {
            toast('‚ö†Ô∏è Local file detected. Please use a web server or deploy to test login/payment.');
        }, 1000);
    }
    
    // Initialize Firebase
    try {
        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            firebaseReady = true;
            console.log('Firebase initialized successfully');
            
            // Auth state listener
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    await checkPremiumStatus(user.uid);
                    // Create/update user document
                    db.collection('users').doc(user.uid).set({
                        email: user.email,
                        displayName: user.displayName,
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                } else {
                    isPremium = false;
                    premiumExpiry = null;
                }
                updateAuthUI();
            });
        } else {
            console.warn('Firebase SDK not loaded');
            setTimeout(() => toast('‚ö†Ô∏è Login service unavailable. Check internet connection.'), 1500);
            updateAuthUI(); // Still update UI for non-logged-in state
        }
    } catch (e) {
        console.error('Firebase init error:', e);
        setTimeout(() => toast('‚ö†Ô∏è Login service error: ' + e.message), 1500);
        updateAuthUI(); // Still update UI even on error
    }
    
    // Initialize Paddle
    try {
        if (typeof Paddle !== 'undefined') {
            Paddle.Initialize({ 
                token: 'live_8cdfa23600d1d845a7ede32e1be'
            });
            paddleReady = true;
            console.log('Paddle initialized successfully');
            
            // Listen for Paddle events
            if (Paddle.Checkout) {
                Paddle.Checkout.on('completed', (data) => {
                    if (currentUser) {
                        activatePremium(currentUser.uid);
                    }
                });
            }
        } else {
            console.warn('Paddle SDK not loaded');
        }
    } catch (e) {
        console.error('Paddle init error:', e);
    }
});

// Check premium status from Firestore
async function checkPremiumStatus(uid) {
    if (!db) return false;
    try {
        const doc = await db.collection('users').doc(uid).get();
        if (doc.exists) {
            const data = doc.data();
            if (data.premiumExpiry) {
                const expiry = data.premiumExpiry.toDate();
                if (expiry > new Date()) {
                    isPremium = true;
                    premiumExpiry = expiry;
                    return true;
                }
            }
        }
        isPremium = false;
        premiumExpiry = null;
        return false;
    } catch (e) {
        console.error('Premium check error:', e);
        return false;
    }
}

// Update UI based on auth/premium state
function updateAuthUI() {
    const authBar = document.getElementById('auth-bar');
    const loginBtn = document.getElementById('login-btn');
    const userInfo = document.getElementById('user-info');
    const userName = document.getElementById('user-name');
    const premiumBadge = document.getElementById('premium-badge');
    const premiumBtns = document.querySelectorAll('.premium-unlock-btn');
    const premiumLocks = document.querySelectorAll('.premium-lock');
    const premiumSections = document.querySelectorAll('.premium-section');
    
    if (currentUser) {
        loginBtn.style.display = 'none';
        userInfo.style.display = 'flex';
        userName.textContent = currentUser.displayName || currentUser.email;
        
        if (isPremium) {
            premiumBadge.style.display = 'inline-block';
            premiumBadge.textContent = 'üëë Premium';
            premiumBtns.forEach(btn => btn.style.display = 'none');
            premiumLocks.forEach(lock => lock.style.display = 'none');
            // Unlock premium sections
            premiumSections.forEach(section => section.classList.add('unlocked'));
        } else {
            premiumBadge.style.display = 'none';
            premiumBtns.forEach(btn => btn.style.display = 'inline-block');
            premiumLocks.forEach(lock => lock.style.display = 'flex');
            // Lock premium sections
            premiumSections.forEach(section => section.classList.remove('unlocked'));
        }
    } else {
        loginBtn.style.display = 'inline-flex';
        userInfo.style.display = 'none';
        premiumBadge.style.display = 'none';
        premiumBtns.forEach(btn => btn.style.display = 'inline-block');
        premiumLocks.forEach(lock => {
            lock.style.display = 'flex';
            lock.innerHTML = '<span style="color:var(--gold);">üîí Login required</span>';
        });
        // Lock premium sections (show overlay)
        premiumSections.forEach(section => section.classList.remove('unlocked'));
    }
}

// Google Sign In
async function googleSignIn() {
    // Check local file
    if (window.location.protocol === 'file:') {
        toast('‚ö†Ô∏è Login requires web server. Deploy to GitHub Pages or use localhost.');
        return;
    }
    
    if (!firebaseReady || !auth) {
        toast('‚è≥ Login service loading... Please wait and try again.');
        return;
    }
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        toast('Welcome, ' + result.user.displayName + '!');
    } catch (e) {
        console.error('Login error:', e);
        if (e.code === 'auth/popup-blocked') {
            toast('üö´ Popup blocked. Please allow popups for this site.');
        } else if (e.code === 'auth/cancelled-popup-request') {
            toast('Login cancelled.');
        } else {
            toast('‚ùå Login failed: ' + (e.message || 'Unknown error'));
        }
    }
}

// Sign Out
async function signOut() {
    if (!auth) return;
    try {
        await auth.signOut();
        toast('Signed out successfully');
    } catch (e) {
        console.error('Logout error:', e);
    }
}

// Paddle Checkout - Î≥µÏ±Ñ(Á¶èÂÇµ) Í∏àÏï° ÏÑ†ÌÉù
function openPremiumCheckout(tier = 'basic') {
    // Check local file
    if (window.location.protocol === 'file:') {
        toast('‚ö†Ô∏è Payment requires web server. Deploy to GitHub Pages to test.');
        return;
    }
    
    if (!currentUser) {
        toast('üîê Please login first to offer Á¶èÂÇµ');
        googleSignIn();
        return;
    }
    
    if (!paddleReady) {
        toast('‚è≥ Payment service loading... Please wait and try again.');
        return;
    }
    
    try {
        const price = PADDLE_PRICES[tier] || PADDLE_PRICES.basic;
        
        Paddle.Checkout.open({
            items: [{ priceId: price.id, quantity: 1 }],
            customer: { email: currentUser.email },
            customData: { 
                uid: currentUser.uid,
                tier: tier,
                amount: price.amount,
                purchaseTime: new Date().toISOString()
            },
            settings: {
                displayMode: 'overlay',
                theme: 'dark',
                locale: 'en'
            }
        });
    } catch (e) {
        console.error('Checkout error:', e);
        toast('‚ùå Payment error: ' + (e.message || 'Unknown error'));
    }
}

// Handle successful payment (called by webhook or client-side)
async function activatePremium(uid) {
    if (!db) return;
    const expiry = new Date();
    expiry.setHours(expiry.getHours() + PREMIUM_DURATION_HOURS);
    
    try {
        await db.collection('users').doc(uid).set({
            premiumExpiry: firebase.firestore.Timestamp.fromDate(expiry),
            lastPurchase: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        isPremium = true;
        premiumExpiry = expiry;
        updateAuthUI();
        toast('üéâ Premium activated for 24 hours!');
    } catch (e) {
        console.error('Premium activation error:', e);
    }
}

/* ========================================
   Premium Feature Gating
   ======================================== */
function requirePremium(feature) {
    if (!currentUser) {
        toast('üîí Please login to access ' + feature);
        return false;
    }
    if (!isPremium) {
        toast('üëë Premium required for ' + feature);
        return false;
    }
    return true;
}

</script>

<script>
(function(){
    document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && /^[IJCijc]$/.test(e.key)) || (e.ctrlKey && /^[USus]$/.test(e.key))) { e.preventDefault(); }
    });
    document.addEventListener('selectstart', function(e) { if (!/INPUT|TEXTAREA/.test(e.target.tagName)) e.preventDefault(); });
    document.addEventListener('dragstart', function(e) { e.preventDefault(); });
    document.addEventListener('copy', function(e) { e.preventDefault(); });
})();
</script>

<style>
/* ========================================
   Animations
   ======================================== */
@keyframes shimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }
@keyframes breathe { 0%, 100% { opacity: 0.04; transform: scale(1); } 50% { opacity: 0.07; transform: scale(1.02); } }
@keyframes dragonPulse { 0%, 100% { filter: drop-shadow(0 0 15px var(--theme-accent-glow)); } 50% { filter: drop-shadow(0 0 30px var(--theme-accent-glow)); } }
@keyframes ballDrop { 0% { transform: translateY(-30px) scale(0.5); opacity: 0; } 60% { transform: translateY(5px) scale(1.1); } 100% { transform: translateY(0) scale(1); opacity: 1; } }
@keyframes glowPulse { 0%, 100% { box-shadow: inset -3px -3px 10px rgba(0,0,0,0.4), inset 3px 3px 8px rgba(255,255,255,0.3), 0 0 25px var(--theme-glow), 0 8px 20px rgba(0,0,0,0.3); } 50% { box-shadow: inset -3px -3px 10px rgba(0,0,0,0.4), inset 3px 3px 8px rgba(255,255,255,0.3), 0 0 40px var(--theme-glow), 0 8px 20px rgba(0,0,0,0.3); } }
@keyframes buttonPulse { 0% { box-shadow: 0 4px 25px var(--theme-glow), 0 0 0 0 rgba(212, 175, 55, 0.7); } 70% { box-shadow: 0 4px 25px var(--theme-glow), 0 0 0 15px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 4px 25px var(--theme-glow), 0 0 0 0 rgba(212, 175, 55, 0); } }
@keyframes kofiPulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255,215,0,0.5); } 50% { transform: scale(1.02); box-shadow: 0 0 35px rgba(255,215,0,0.8); } }

/* ========================================
   CSS Variables
   ======================================== */
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
    --navy: #1a2332;
    --navy-light: #243447;
    --gold: #D4AF37;
    --gold-light: #F4D58D;
    --pearl: #F5F5F5;
    --gray: #9CA3AF;
    --theme-primary: #DC3545;
    --theme-secondary: #8B0000;
    --theme-accent: #FFD700;
    --theme-accent-glow: rgba(255, 215, 0, 0.4);
    --theme-glow: rgba(220, 53, 69, 0.4);
    --theme-bg-1: #1a1a2e;
    --theme-bg-2: #2d1f3d;
    --wood: #4CAF50;
    --fire: #F44336;
    --earth: #FF9800;
    --metal: #9E9E9E;
    --water: #2196F3;
}

body.powerball-mode {
    --theme-primary: #DC3545;
    --theme-secondary: #8B0000;
    --theme-accent: #FFD700;
    --theme-accent-glow: rgba(255, 215, 0, 0.4);
    --theme-glow: rgba(220, 53, 69, 0.4);
    --theme-bg-1: #1a1a2e;
    --theme-bg-2: #2d1f3d;
}

body.mega-mode {
    --theme-primary: #2E86DE;
    --theme-secondary: #003478;
    --theme-accent: #FFD700;
    --theme-accent-glow: rgba(255, 215, 0, 0.4);
    --theme-glow: rgba(46, 134, 222, 0.4);
    --theme-bg-1: #141E30;
    --theme-bg-2: #243B55;
}

body.saju-mode {
    --theme-primary: #D4AF37;
    --theme-secondary: #8B7020;
    --theme-accent: #FFD700;
    --theme-accent-glow: rgba(255, 215, 0, 0.4);
    --theme-glow: rgba(212, 175, 55, 0.4);
    --theme-bg-1: #1a1a2e;
    --theme-bg-2: #16213e;
}

body {
    font-family: 'Cormorant Garamond', 'Noto Serif KR', Georgia, serif;
    background: var(--navy);
    color: var(--pearl);
    min-height: 100vh;
    padding-bottom: 20px;
    line-height: 1.7;
    transition: all 0.5s ease;
}

/* ========================================
   Watermark & Bagua
   ======================================== */
.oracle-watermark {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    max-width: 500px;
    height: auto;
    max-height: 90vh;
    object-fit: contain;
    opacity: 0.15;
    filter: grayscale(30%) brightness(1.2);
    z-index: -1;
    pointer-events: none;
    transition: opacity 0.5s ease;
}

body.mega-mode .oracle-watermark {
    filter: grayscale(50%) brightness(1.3) hue-rotate(200deg);
    opacity: 0.12;
}

body.saju-mode .oracle-watermark {
    filter: grayscale(20%) brightness(1.1) sepia(20%);
    opacity: 0.18;
}

.bagua {
    position: fixed;
    font-size: 2.5rem;
    opacity: 0.4;
    pointer-events: none;
    z-index: 2;
    font-family: serif;
    line-height: 1;
    text-shadow: 0 0 20px currentColor, 0 0 40px currentColor;
    text-align: center;
    transition: all 0.5s ease;
}
.bagua-sub { font-size: 0.4em; display: block; margin-top: 5px; opacity: 0.8; font-family: 'Noto Serif KR', serif; }
.bagua.tl { top: 180px; left: 15px; color: #FFD700; }
.bagua.tr { top: 180px; right: 15px; color: #FF6B6B; }
.bagua.bl { bottom: 100px; left: 15px; color: #4ECDC4; }
.bagua.br { bottom: 100px; right: 15px; color: #A29BFE; }

body.mega-mode .bagua.tl { color: #87CEEB; }
body.mega-mode .bagua.tr { color: #E8E8E8; }
body.mega-mode .bagua.bl { color: #98D8C8; }
body.mega-mode .bagua.br { color: #B8B8FF; }

body.saju-mode .bagua.tl { color: #FFD700; }
body.saju-mode .bagua.tr { color: #FF7675; }
body.saju-mode .bagua.bl { color: #55EFC4; }
body.saju-mode .bagua.br { color: #A29BFE; }

/* ========================================
   Tab Navigation
   ======================================== */
.game-switcher {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 12px 10px;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.game-btn {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.5);
    padding: 10px 20px;
    font-family: 'Noto Serif KR', 'Cinzel Decorative', serif;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 1px;
    cursor: pointer;
    border-radius: 25px;
    transition: all 0.4s ease;
    min-width: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.tab-main { font-size: 14px; font-weight: 700; }
.tab-sub { font-size: 10px; opacity: 0.7; }

.game-btn:hover {
    border-color: var(--theme-accent);
    color: var(--pearl);
    transform: translateY(-2px);
}

.game-btn:active {
    transform: scale(0.95);
    transition: transform 0.1s ease;
}

.game-btn.active {
    background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
    border-color: var(--theme-accent);
    color: white;
    box-shadow: 0 4px 20px var(--theme-glow);
}

/* ========================================
   Layout
   ======================================== */
.container {
    max-width: 520px;
    margin: 0 auto;
    padding: 15px;
    position: relative;
    z-index: 10;
}

.tab-content { display: none; }
.tab-content.active { display: block; }

/* ========================================
   Header
   ======================================== */
header {
    text-align: center;
    padding: 25px 15px;
    position: relative;
}

.dragon-seal {
    width: 70px;
    height: 70px;
    margin: 0 auto 15px;
    animation: dragonPulse 3s ease-in-out infinite;
}

.dragon-seal svg { width: 100%; height: 100%; }

header h1 {
    font-family: 'Cinzel Decorative', serif;
    font-size: 2rem;
    font-weight: 900;
    background: linear-gradient(135deg, var(--gold), var(--gold-light), var(--gold));
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 3s linear infinite;
    letter-spacing: 3px;
}

.game-title {
    display: inline-block;
    font-size: 1rem;
    font-weight: 700;
    color: var(--theme-accent);
    margin-top: 8px;
    padding: 5px 15px;
    border: 1px solid var(--theme-accent);
    border-radius: 20px;
    letter-spacing: 2px;
}

.subtitle {
    font-size: 0.85rem;
    color: var(--gray);
    margin-top: 10px;
    letter-spacing: 1px;
}

/* ========================================
   Cards
   ======================================== */
.card {
    background: linear-gradient(145deg, rgba(36,52,71,0.9), rgba(26,35,50,0.95));
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.card.gold {
    border-color: rgba(212,175,55,0.3);
    background: linear-gradient(145deg, rgba(212,175,55,0.15), rgba(26,35,50,0.95));
}

.card h3 {
    font-size: 1rem;
    font-weight: 700;
    color: var(--theme-accent);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ========================================
   Form Elements
   ======================================== */
.form-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 15px;
}

.form-group { display: flex; flex-direction: column; gap: 5px; }

.form-group label {
    font-size: 11px;
    color: var(--gray);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.form-group select, .form-group input {
    background: #1a2332;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    padding: 12px 10px;
    color: #FFFFFF;
    font-size: 18px;
    font-weight: 600;
    font-family: 'Cinzel Decorative', 'Cormorant Garamond', serif;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

.form-group select {
    background: #1a2332 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23D4AF37' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E") no-repeat right 10px center;
    padding-right: 30px;
    cursor: pointer;
}

.form-group select option {
    background: #1a2332;
    color: #FFFFFF;
    font-size: 18px;
    font-family: 'Cinzel Decorative', 'Cormorant Garamond', serif;
    padding: 14px;
}

.form-group select:focus, .form-group input:focus {
    outline: none;
    border-color: var(--theme-accent);
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
}

.toggle-btns { display: flex; gap: 5px; }

.toggle-btn {
    flex: 1;
    padding: 8px;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    background: transparent;
    color: var(--gray);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.toggle-btn.on {
    background: var(--theme-primary);
    border-color: var(--theme-accent);
    color: white;
}

/* ========================================
   Buttons
   ======================================== */
.btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
    border: none;
    border-radius: 12px;
    color: white;
    font-family: inherit;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 20px var(--theme-glow);
    letter-spacing: 1px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px var(--theme-glow);
}

.btn:active { 
    transform: scale(0.95); 
    transition: transform 0.1s ease;
}

.btn-secondary {
    background: transparent;
    border: 1px solid var(--theme-accent);
    color: var(--theme-accent);
    box-shadow: none;
}

/* ========================================
   Ko-fi Button (Premium Gold)
   ======================================== */
.kofi-container {
    margin-top: 25px;
    padding: 20px;
    background: transparent;
    border: none;
    text-align: center;
}

.kofi-container p {
    color: var(--gold-light);
    font-size: 13px;
    margin-bottom: 15px;
    opacity: 0.85;
}

.kofi-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 16px 32px;
    background: #000000;
    border: 2px solid #D4AF37;
    border-radius: 12px;
    color: #D4AF37;
    font-family: 'Cinzel Decorative', serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 0 20px rgba(212,175,55,0.2), inset 0 0 0 0 rgba(212,175,55,0);
    letter-spacing: 1px;
}

.kofi-btn:hover {
    background: linear-gradient(135deg, rgba(212,175,55,0.25) 0%, rgba(212,175,55,0.15) 100%);
    border-color: #FFD700;
    color: #FFD700;
    transform: translateY(-2px);
    box-shadow: 0 0 35px rgba(212,175,55,0.4), 0 8px 25px rgba(0,0,0,0.3);
    text-shadow: 0 0 10px rgba(255,215,0,0.5);
}

.kofi-btn:active {
    transform: translateY(0);
}

.kofi-btn img {
    width: 24px;
    height: 24px;
}

/* ========================================
   Auth Bar & Premium UI
   ======================================== */
.auth-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    padding: 10px 15px;
    background: linear-gradient(135deg, rgba(0,0,0,0.5) 0%, rgba(26,35,50,0.8) 100%);
    border-bottom: 1px solid rgba(212,175,55,0.2);
}

.login-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: #fff;
    border: none;
    border-radius: 20px;
    color: #333;
    font-family: 'Noto Serif KR', serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.login-btn img {
    width: 18px;
    height: 18px;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-name {
    color: var(--pearl);
    font-size: 13px;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.premium-badge {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    animation: kofiPulse 2s infinite;
}

.logout-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: var(--gray);
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s;
}

.logout-btn:hover {
    background: rgba(255,255,255,0.2);
    color: var(--pearl);
}

.premium-unlock-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 14px 28px;
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FFD700 100%);
    background-size: 200% 200%;
    animation: shimmer 3s ease infinite;
    border: none;
    border-radius: 25px;
    color: #000;
    font-family: 'Cinzel Decorative', serif;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(255,215,0,0.4);
}

.premium-unlock-btn:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 6px 30px rgba(255,215,0,0.6);
}

.premium-lock {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px;
    background: linear-gradient(135deg, rgba(0,0,0,0.4) 0%, rgba(26,35,50,0.6) 100%);
    border: 1px dashed rgba(212,175,55,0.3);
    border-radius: 12px;
    text-align: center;
    min-height: 150px;
}

.premium-lock p {
    color: var(--gold);
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.premium-lock .price {
    color: var(--gold-light);
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 10px;
}

.premium-lock .duration {
    color: var(--gray);
    font-size: 0.85rem;
    margin-bottom: 20px;
}

/* Premium Section Overlay */
.premium-section {
    position: relative;
}

.premium-tag {
    font-size: 0.7rem;
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 8px;
    font-weight: 700;
}

.premium-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(26, 35, 50, 0.95);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    border-radius: 15px;
}

.premium-overlay-content {
    text-align: center;
    padding: 20px;
}

.premium-overlay-content p {
    color: var(--gold);
    margin-bottom: 10px;
    font-size: 1.1rem;
}

.premium-overlay-content .premium-price {
    color: var(--gold-light);
    font-size: 0.9rem;
    margin-bottom: 15px;
}

.premium-section.unlocked .premium-overlay {
    display: none;
}

.premium-section.unlocked .premium-tag {
    display: none;
}

/* ========================================
   Lottery Balls
   ======================================== */
.balls-container {
    display: flex;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
    padding: 20px 0;
    min-height: 80px;
}

.ball {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Cinzel Decorative', serif;
    font-weight: 900;
    font-size: 18px;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    background: linear-gradient(135deg, #DC3545, #8B0000);
    box-shadow: inset -3px -3px 10px rgba(0,0,0,0.4), inset 3px 3px 8px rgba(255,255,255,0.3), 0 0 25px var(--theme-glow), 0 8px 20px rgba(0,0,0,0.3);
    opacity: 0;
    animation: ballDrop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
}

.ball.powerball {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #1a1a2e;
    box-shadow: inset -3px -3px 10px rgba(0,0,0,0.3), inset 3px 3px 8px rgba(255,255,255,0.5), 0 0 30px rgba(255,215,0,0.5), 0 8px 20px rgba(0,0,0,0.3);
}

.ball.mega {
    background: linear-gradient(135deg, #2E86DE, #003478);
}

.ball.megaball {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #1a1a2e;
}

/* ========================================
   Saju Pillars
   ======================================== */
.pillars {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 15px;
}

.pillar {
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    padding: 12px 8px;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.1);
}

.pillar.dm {
    border-color: var(--gold);
    background: rgba(212,175,55,0.15);
}

.pillar-label {
    font-size: 10px;
    color: var(--gray);
    margin-bottom: 8px;
    text-transform: uppercase;
}

.pillar-stem {
    font-size: 28px;
    font-weight: 900;
    margin-bottom: 4px;
}

.pillar-branch {
    font-size: 24px;
    font-weight: 700;
}

.pillar-sub {
    font-size: 11px;
    color: var(--gray);
    margin-top: 5px;
}

.pillar-god {
    font-size: 10px;
    color: var(--theme-accent);
    margin-top: 5px;
    padding: 3px 6px;
    background: rgba(212,175,55,0.2);
    border-radius: 4px;
}

/* Element Colors */
.el-wood { color: var(--wood); }
.el-fire { color: var(--fire); }
.el-earth { color: var(--earth); }
.el-metal { color: var(--metal); }
.el-water { color: var(--water); }

/* ========================================
   Strength Bar
   ======================================== */
.strength-box {
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
}

.strength-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.strength-title { font-size: 13px; color: var(--gray); }

.strength-badge {
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 700;
}

.strength-badge.strong { background: var(--fire); color: white; }
.strength-badge.weak { background: var(--water); color: white; }
.strength-badge.balanced { background: var(--wood); color: white; }

.strength-bar {
    height: 8px;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    overflow: hidden;
}

.strength-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.8s ease;
}

.strength-fill.strong { background: linear-gradient(90deg, var(--fire), #ff6b6b); }
.strength-fill.weak { background: linear-gradient(90deg, var(--water), #74b9ff); }
.strength-fill.balanced { background: linear-gradient(90deg, var(--wood), #81c784); }

.factors {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-top: 12px;
}

.factor {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    padding: 6px 10px;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
}

.factor-label { color: var(--gray); }
.factor-value.pos { color: var(--fire); }
.factor-value.neg { color: var(--water); }

/* ========================================
   Element Bar
   ======================================== */
.element-bar {
    display: flex;
    height: 30px;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 10px;
}

.element-bar > div { transition: width 0.5s ease; }

.element-legend {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    font-size: 11px;
}

.element-legend span {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* ========================================
   Info Box
   ======================================== */
.info-box {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
}

.info-box p { font-size: 13px; line-height: 1.7; }

/* ========================================
   Luck Timeline
   ======================================== */
.luck-timeline {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 10px 0;
    scrollbar-width: thin;
}

.luck-item {
    flex: 0 0 70px;
    text-align: center;
    padding: 12px 8px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    border: 1px solid transparent;
}

.luck-item.current {
    border-color: var(--gold);
    background: rgba(212,175,55,0.2);
}

.luck-age { font-size: 11px; color: var(--gray); margin-bottom: 5px; }
.luck-pillar { font-size: 18px; font-weight: 700; }
.luck-element { font-size: 10px; color: var(--theme-accent); margin-top: 5px; }

/* ========================================
   Sinsal Grid
   ======================================== */
.sinsal-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.sinsal-item {
    padding: 12px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    border-left: 3px solid var(--gray);
}

.sinsal-item.good { border-color: var(--wood); }
.sinsal-item.bad { border-color: var(--fire); }

.sinsal-name { font-size: 13px; font-weight: 700; margin-bottom: 5px; }
.sinsal-desc { font-size: 11px; color: var(--gray); }

/* ========================================
   History
   ======================================== */
.history-section { margin-top: 15px; }

.history-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    margin-bottom: 8px;
}

.history-type {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 10px;
    background: var(--theme-primary);
    color: white;
}

.history-balls { display: flex; gap: 4px; flex-wrap: wrap; }

.history-balls .ball {
    width: 28px;
    height: 28px;
    font-size: 11px;
    animation: none;
    opacity: 1;
}

/* ========================================
   Toast
   ======================================== */
.toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 14px;
    z-index: 9999;
    opacity: 0;
    transition: all 0.3s;
    border: 1px solid var(--theme-accent);
}

.toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

/* ========================================
   Footer
   ======================================== */
footer {
    text-align: center;
    padding: 30px 15px;
    color: var(--gray);
    font-size: 12px;
}

footer a {
    color: var(--theme-accent);
    text-decoration: none;
}

/* ========================================
   Responsive
   ======================================== */
@media (max-width: 400px) {
    .game-switcher { gap: 4px; padding: 10px 5px; }
    .game-btn { padding: 8px 12px; font-size: 12px; min-width: auto; }
    .tab-main { font-size: 12px; }
    .tab-sub { font-size: 9px; }
    header h1 { font-size: 1.6rem; }
    .ball { width: 40px; height: 40px; font-size: 15px; }
    .pillar-stem { font-size: 22px; }
    .pillar-branch { font-size: 18px; }
    .bagua { font-size: 1.8rem; }
}

/* ========================================
   Mobile Touch Enhancement (v4.12.2)
   ======================================== */

/* Global touch settings */
* {
    -webkit-tap-highlight-color: rgba(212, 175, 55, 0.15);
    touch-action: manipulation;
}

/* Prevent text selection on interactive elements */
.btn, .game-btn, .toggle-btn, .kofi-btn, .card, .pillar,
.ball, .premium-unlock-btn, .legal-close, .tab-toggle {
    -webkit-user-select: none;
    user-select: none;
}

/* Enhanced button touch feedback */
.btn {
    transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    will-change: transform, box-shadow;
}

.btn:active {
    transform: scale(0.96);
    box-shadow: 0 2px 10px var(--theme-glow);
    transition: transform 0.08s ease-out, box-shadow 0.08s ease-out;
}

/* Game tab buttons */
.game-btn {
    transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    will-change: transform, border-color, color;
}

.game-btn:active {
    transform: scale(0.94);
    transition: transform 0.08s ease-out;
}

/* Toggle buttons */
.toggle-btn {
    transition: all 0.2s ease;
    will-change: transform, background, color;
}

.toggle-btn:active {
    transform: scale(0.92);
    transition: transform 0.06s ease-out;
}

/* Ko-fi / Premium buttons */
.kofi-btn {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform, box-shadow, background;
}

.kofi-btn:active {
    transform: scale(0.97) translateY(0);
    box-shadow: 0 0 15px rgba(212,175,55,0.3);
    transition: transform 0.08s ease-out, box-shadow 0.08s ease-out;
}

/* Premium unlock buttons */
.premium-unlock-btn {
    transition: all 0.2s ease;
    will-change: transform;
}

.premium-unlock-btn:active {
    transform: scale(0.95);
    transition: transform 0.08s ease-out;
}

/* Card touch feedback */
.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    will-change: transform;
}

.card:active {
    transform: scale(0.99);
    transition: transform 0.1s ease-out;
}

/* Pillar touch (for future interactions) */
.pillar {
    transition: transform 0.15s ease, border-color 0.15s ease;
    cursor: pointer;
}

.pillar:active {
    transform: scale(0.97);
    border-color: var(--gold);
    transition: transform 0.06s ease-out;
}

/* Ball touch feedback */
.ball {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    will-change: transform;
}

.ball:active {
    transform: scale(0.92);
    transition: transform 0.08s ease-out;
}

/* Legal close button */
.legal-close {
    transition: all 0.2s ease;
}

.legal-close:active {
    transform: scale(0.92);
    transition: transform 0.08s ease-out;
}

/* Form select touch enhancement */
.form-group select,
.form-group input {
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.form-group select:active,
.form-group input:active {
    border-color: var(--theme-accent);
    box-shadow: 0 0 8px rgba(212, 175, 55, 0.25);
}

/* Auth bar buttons */
#login-btn, #logout-btn {
    transition: all 0.2s ease;
}

#login-btn:active, #logout-btn:active {
    transform: scale(0.95);
    transition: transform 0.08s ease-out;
}

/* Mobile-specific enhancements */
@media (hover: none) and (pointer: coarse) {
    /* Increase touch targets */
    .btn {
        min-height: 48px;
        padding: 14px 20px;
    }
    
    .game-btn {
        min-height: 44px;
        padding: 12px 18px;
    }
    
    .toggle-btn {
        min-height: 40px;
        padding: 10px 12px;
    }
    
    /* Stronger active state on mobile */
    .btn:active {
        transform: scale(0.94);
    }
    
    .game-btn:active {
        transform: scale(0.92);
    }
    
    /* Ripple effect simulation */
    .btn::after,
    .game-btn::after,
    .kofi-btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.3s ease, height 0.3s ease, opacity 0.3s ease;
        pointer-events: none;
        opacity: 0;
    }
    
    .btn:active::after,
    .game-btn:active::after,
    .kofi-btn:active::after {
        width: 200%;
        height: 200%;
        opacity: 1;
        transition: width 0.1s ease, height 0.1s ease, opacity 0s;
    }
    
    /* Ensure buttons have position for ripple */
    .btn, .game-btn, .kofi-btn {
        position: relative;
        overflow: hidden;
    }
}
</style>
</head>
<body class="saju-mode">

<!-- Bagua decoration -->
<div class="bagua tl">‚ò∞<span class="bagua-sub">‰πæ</span></div>
<div class="bagua tr">‚ò∑<span class="bagua-sub">Âù§</span></div>
<div class="bagua bl">‚òµ<span class="bagua-sub">Âùé</span></div>
<div class="bagua br">‚ò≤<span class="bagua-sub">Èõ¢</span></div>

<img class="oracle-watermark" src="https://raw.githubusercontent.com/shrmsdl-netizen/k-mudang/main/og-image.png" alt="" />

<!-- 3-Tab Navigation -->
<div class="game-switcher">
    <button class="game-btn active" onclick="switchGame('saju')"><span class="tab-main">üîÆ Four Pillars</span><span class="tab-sub">ÂõõÊü±</span></button>
    <button class="game-btn" onclick="switchGame('powerball')"><span class="tab-main">üî¥ Powerball</span></button>
    <button class="game-btn" onclick="switchGame('mega')"><span class="tab-main">üîµ Mega Millions</span></button>
</div>

<!-- Auth Bar -->
<div class="auth-bar" id="auth-bar">
    <button class="login-btn" id="login-btn" onclick="googleSignIn()">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in with Google
    </button>
    <div class="user-info" id="user-info" style="display:none;">
        <span class="user-name" id="user-name"></span>
        <span class="premium-badge" id="premium-badge" style="display:none;">üëë Premium</span>
        <button class="logout-btn" onclick="signOut()">Logout</button>
    </div>
</div>

<div class="container">

    <!-- ========================================
         Tab 1: SAJU (ÂõõÊü±) Fortune
         ======================================== -->
    <div id="tab-saju" class="tab-content active">
        <header>
            <div class="dragon-seal">
                <svg viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="dragonGold1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700"/>
                            <stop offset="50%" style="stop-color:#FFA500"/>
                            <stop offset="100%" style="stop-color:#FFD700"/>
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="45" fill="none" stroke="url(#dragonGold1)" stroke-width="2"/>
                    <text x="50" y="58" text-anchor="middle" fill="url(#dragonGold1)" font-size="32" font-family="serif">Èæç</text>
                </svg>
            </div>
            <h1>K-MUDANG</h1>
            <span class="game-title">FORTUNE</span>
            <p class="subtitle">Ancient Korean Zodiac Algorithm</p>
        </header>

        <div class="card">
            <h3>üìÖ Birth Date & Time</h3>
            <div class="form-row">
                <div class="form-group"><label>Month</label><select id="saju-month"></select></div>
                <div class="form-group"><label>Day</label><select id="saju-day"></select></div>
                <div class="form-group"><label>Year</label><select id="saju-year"></select></div>
                <div class="form-group"><label>Hour</label><select id="saju-hour"></select></div>
            </div>
            <div class="form-row" style="grid-template-columns: repeat(2, 1fr);">
                <div class="form-group">
                    <label>Gender</label>
                    <div class="toggle-btns">
                        <button class="toggle-btn on" data-gender="m" onclick="setGender('m')">üë® M</button>
                        <button class="toggle-btn" data-gender="f" onclick="setGender('f')">üë© F</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Calendar</label>
                    <div class="toggle-btns">
                        <button class="toggle-btn on" data-cal="solar" onclick="setCalendar('solar')">‚òÄÔ∏è Solar</button>
                        <button class="toggle-btn" data-cal="lunar" onclick="setCalendar('lunar')">üåô Lunar</button>
                    </div>
                    <p id="lunar-notice" style="display:none;font-size:0.7rem;color:var(--gold);margin-top:5px;">üí° Solar calendar recommended for accuracy</p>
                </div>
            </div>
            <button class="btn" onclick="analyzeSaju()">üîÆ Analyze Fortune</button>
        </div>

        <div id="saju-result" style="display:none;">
            <!-- Four Pillars Chart - FREE -->
            <div class="card">
                <h3>üìú Four Pillars (Four Pillars Chart)</h3>
                <div class="pillars" id="pillars"></div>
                <!-- 12Ïö¥ÏÑ±/Í∞ïÏïΩÏùÄ PremiumÏúºÎ°ú Ïù¥Îèô -->
            </div>

            <!-- Premium Upsell for Full Analysis -->
            <div class="card" style="text-align:center;background:linear-gradient(135deg,rgba(255,215,0,0.08),rgba(255,193,7,0.03));border:1px solid rgba(212,175,55,0.2);">
                <p style="font-size:1.2rem;margin-bottom:10px;">üîÆ Unlock Full Destiny Analysis</p>
                <p style="font-size:0.85rem;color:var(--gray);margin-bottom:15px;">
                    70+ Advanced interpretations ¬∑ Life Cycles ¬∑ Divine Stars ¬∑ Monthly Fortune
                </p>
                <button class="premium-unlock-btn" onclick="openPremiumCheckout()">üôè Offer Á¶èÂÇµ ¬∑ Unlock Premium</button>
            </div>

            <!-- Strength & 12 States - PREMIUM -->
            <div class="card premium-section" id="card-strength">
                <h3>üí™ Day Master Strength <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="twelve-states"></div>
                <div class="strength-box" id="strength-box"></div>
            </div>

            <!-- Á¥çÈü≥(Sound Element)/ÂëΩÂÆÆ(Life Palace)/Conception - PREMIUM -->
            <div class="card premium-section" id="card-napeum">
                <h3>üéµ Á¥çÈü≥ & ÂëΩÂÆÆ <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="napeum-myunggung"></div>
            </div>

            <!-- Hidden Stems Analysis - PREMIUM -->
            <div class="card premium-section" id="card-jijanggan">
                <h3>üåø ÊîØËóèÂπ≤ Hidden Stems <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="jijanggan-analysis"></div>
            </div>

            <!-- Root & Stem Analysis - PREMIUM -->
            <div class="card premium-section" id="card-tonggeun">
                <h3>üå≥ ÈÄöÊ†πÈÄèÂπ≤ Root & Stem <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="tonggeun-analysis"></div>
            </div>

            <!-- Five Elements (‰∫îË°å) - PREMIUM -->
            <div class="card premium-section" id="card-elements">
                <h3>üåü Five Elements (‰∫îË°å) <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div class="element-bar" id="element-bar"></div>
                <div class="element-legend" id="element-legend"></div>
                <div id="element-analysis"></div>
            </div>

            <!-- Beneficial Elements (Áî®Á•û) - PREMIUM -->
            <div class="card gold premium-section" id="card-gods">
                <h3>‚öñÔ∏è Beneficial Elements (Áî®Á•û) <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="gods" class="gods-grid"></div>
                <div id="gods-detail"></div>
                <div id="gods-analysis"></div>
            </div>

            <!-- Six Relations (ÂÖ≠Ë¶™) Analysis - PREMIUM -->
            <div class="card premium-section" id="card-yukcheon">
                <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Six Relations (ÂÖ≠Ë¶™) <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="yukcheon-analysis"></div>
            </div>

            <!-- Structure - PREMIUM -->
            <div class="card premium-section" id="card-format">
                <h3>üèõÔ∏è Ê†ºÂ±Ä Structure <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="format"></div>
                <div id="format-analysis"></div>
            </div>

            <!-- Day Pillar Analysis - PREMIUM -->
            <div class="card premium-section" id="card-ilju">
                <h3>üìÖ Êó•Êü± Day Pillar Analysis <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="ilju"></div>
            </div>

            <!-- Position & Life Stages - PREMIUM -->
            <div class="card premium-section" id="card-gungwi">
                <h3>üè† Palace & Twelve States <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="gungwi-analysis"></div>
                <div id="twelve-states-full"></div>
            </div>

            <!-- Â§ßÈÅã(Life Cycle) - PREMIUM -->
            <div class="card premium-section" id="card-luck">
                <h3>üîÑ Life Cycles (Â§ßÈÅã) <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay" id="overlay-luck">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div class="luck-timeline" id="luck-timeline"></div>
                <div id="luck-detail"></div>
                <div id="gyoungi-analysis"></div>
            </div>

            <!-- Ìñ•ÌõÑ 10ÎÖÑ Ïö¥ - PREMIUM -->
            <div class="card premium-section" id="card-tenyears">
                <h3>üìà Next 10 Years Fortune <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay" id="overlay-tenyears">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="ten-years-luck"></div>
            </div>

            <!-- Monthly Fortune - PREMIUM -->
            <div class="card premium-section" id="card-monthly">
                <h3>üìÜ Monthly Fortune <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay" id="overlay-monthly">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="monthly-luck"></div>
            </div>

            <!-- Harmony/Clash Analysis - PREMIUM -->
            <div class="card premium-section" id="card-interactions">
                <h3>üîó Harmony & Clash <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="interactions"></div>
                <div id="banghap-amhap"></div>
                <div id="advanced-interactions"></div>
            </div>

            <!-- Í≥µÎßù - PREMIUM -->
            <div class="card premium-section" id="card-gongmang">
                <h3>‚≠ï Empty Void (Á©∫‰∫°) <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="gongmang"></div>
                <div id="gongmang-haeso"></div>
            </div>

            <!-- Ïã†ÏÇ¥ - PREMIUM -->
            <div class="card premium-section" id="card-sinsal">
                <h3>‚ú® Divine Stars (Á•ûÊÆ∫) <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="sinsal"></div>
                <div id="sinsal-position"></div>
                <div class="sinsal-grid" id="sinsal-grid"></div>
            </div>

            <!-- Today's Fortune - PREMIUM -->
            <div class="card gold premium-section" id="card-today">
                <h3>üåÖ Today's Fortune <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="today-fortune"></div>
            </div>

            <!-- AI Comprehensive Interpretation - PREMIUM -->
            <div class="card gold premium-section" id="card-ai">
                <h3>ü§ñ AI Interpretation <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="ai-interpretation"></div>
                <div style="margin-top:25px;text-align:center;padding:20px;background:linear-gradient(135deg,rgba(103,58,183,0.1),rgba(156,39,176,0.05));border-radius:12px;">
                    <p style="font-size:0.95rem;color:var(--gold);margin-bottom:8px;font-weight:bold;">
                        üèÜ The Pinnacle of Destiny Science
                    </p>
                    <p style="font-size:0.85rem;color:var(--gold-light);margin-bottom:15px;font-style:italic;line-height:1.6;">
                        Precision algorithms forged from classical texts, interpreted through cutting-edge AI.<br>
                        This is the most advanced Four Pillars reading available today.
                    </p>
                    <button class="btn" onclick="copySajuForAI()" style="background:linear-gradient(135deg,#8E44AD,#3498DB);margin:5px;padding:14px 28px;font-size:15px;">
                        üìã Copy for Gemini / ChatGPT
                    </button>
                    <p style="font-size:0.75rem;color:var(--gray);margin-top:12px;opacity:0.8;">
                        Paste into AI for a deeply personalized narrative interpretation
                    </p>
                </div>
            </div>

            <!-- Ï¢ÖÌï© Ìï¥ÏÑù - PREMIUM -->
            <div class="card gold premium-section" id="card-summary">
                <h3>üìñ Summary Analysis <span class="premium-tag">üëë Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>üôè Á¶èÂÇµ (Karma Offering)</p>
                        <p class="premium-price">$10 ¬∑ 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer Á¶èÂÇµ</button>
                    </div>
                </div>
                <div id="summary-analysis"></div>
            </div>

            <!-- ===== Share Section ===== -->
            <div class="card" style="text-align:center;background:linear-gradient(135deg,rgba(212,175,55,0.1),rgba(139,90,43,0.05));border:1px solid rgba(212,175,55,0.3);">
                <p style="font-size:1.1rem;margin-bottom:8px;">‚ú® Enjoying K-MUDANG?</p>
                <p style="font-size:0.9rem;color:var(--gray);margin-bottom:20px;">
                    Share the gift of cosmic insight with those who seek their fortune
                </p>
                <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
                    <button class="btn" onclick="shareApp()" style="background:linear-gradient(135deg,#25D366,#128C7E);padding:12px 24px;">
                        üì§ Share
                    </button>
                    <button class="btn" onclick="copyShareLink()" style="background:linear-gradient(135deg,#6c757d,#495057);padding:12px 24px;">
                        üîó Copy Link
                    </button>
                </div>
            </div>

            <!-- ===== Premium Unlock (Á¶èÂÇµ) ===== -->
            <div class="card" id="premium-section" style="text-align:center;background:linear-gradient(135deg,rgba(255,215,0,0.08),rgba(255,193,7,0.03));border:1px solid rgba(212,175,55,0.2);">
                <p style="font-size:1.4rem;margin-bottom:8px;">üôè Á¶èÂÇµ (Karma Offering)</p>
                <p style="font-size:0.95rem;color:var(--gold-light);line-height:1.7;margin-bottom:15px;font-style:italic;">
                    "Î≥µÏùÑ Î∞õÏïòÏúºÎ©¥ Î≥µÏ±ÑÎ•º ÎÇ¥Ïñ¥Ïïº ÌïúÎã§"<br>
                    <span style="font-size:0.8rem;color:var(--gray);">"Having received wisdom, an offering honors tradition."</span>
                </p>
                <p style="font-size:0.85rem;color:var(--gray);line-height:1.6;margin-bottom:15px;">
                    In Korean fortune-telling tradition, <strong style="color:var(--gold);">Á¶èÂÇµ (Bokchae)</strong> is the sacred exchange ‚Äî<br>
                    a grateful offering for cosmic insight received.
                </p>
                <p style="font-size:0.8rem;color:var(--gray);margin-bottom:20px;">
                    Unlock: Life Cycles (Â§ßÈÅã) ¬∑ 10-Year Fortune ¬∑ Monthly Fortune ¬∑ AI Copy
                </p>
                
                <!-- 3-Tier Offering Buttons -->
                <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-bottom:15px;">
                    <button class="premium-unlock-btn" onclick="openPremiumCheckout('basic')" style="padding:15px 25px;min-width:100px;">
                        <span style="display:block;font-size:1.3rem;font-weight:700;">$10</span>
                        <span style="display:block;font-size:0.7rem;opacity:0.8;">Basic</span>
                    </button>
                    <button class="premium-unlock-btn" onclick="openPremiumCheckout('blessed')" style="padding:15px 25px;min-width:100px;background:linear-gradient(135deg,#FFD700,#FFA500);box-shadow:0 0 20px rgba(255,215,0,0.3);">
                        <span style="display:block;font-size:1.3rem;font-weight:700;">$20</span>
                        <span style="display:block;font-size:0.7rem;opacity:0.8;">‚ú® Blessed</span>
                    </button>
                    <button class="premium-unlock-btn" onclick="openPremiumCheckout('sacred')" style="padding:15px 25px;min-width:100px;background:linear-gradient(135deg,#9B59B6,#8E44AD);">
                        <span style="display:block;font-size:1.3rem;font-weight:700;">$50</span>
                        <span style="display:block;font-size:0.7rem;opacity:0.8;">üîÆ Sacred</span>
                    </button>
                </div>
                
                <p class="duration" style="font-size:0.85rem;color:var(--gray);margin-bottom:15px;">24-hour full access ¬∑ All tiers unlock same features</p>
                <p style="font-size:0.75rem;color:var(--gold-light);opacity:0.9;">
                    üí´ Greater offerings attract greater blessings
                </p>
                <p style="font-size:0.7rem;color:var(--gray);margin-top:10px;opacity:0.6;">
                    üîí Secure payment via Paddle ¬∑ Instant activation
                </p>
            </div>

            <!-- ===== Classical Studies ===== -->
            <div class="card" style="text-align:center;background:linear-gradient(135deg,rgba(103,58,183,0.08),rgba(156,39,176,0.03));border:1px solid rgba(156,39,176,0.2);">
                <p style="font-size:1.1rem;margin-bottom:12px;">‚òØ Essence of Classical Destiny Studies (Á≤æÈ´ì)</p>
                <p style="font-size:0.85rem;color:var(--gold);margin-bottom:15px;">
                    „ÄéÊª¥Â§©È´ì„Äè ¬∑ „ÄéÂ≠êÂπ≥ÁúûË©Æ„Äè ¬∑ „ÄéÁ™ÆÈÄöÂØ∂Èëë„Äè
                </p>
                <p style="font-size:0.8rem;color:var(--gray);line-height:1.7;margin-bottom:15px;">
                    The authentic theories from three classical texts of Korean-Chinese astrology, modernized for the digital age.
                </p>
                <div style="font-size:0.75rem;color:var(--gray);opacity:0.8;line-height:1.8;">
                    <p>Ëê¨Ê≠≤ÊõÜ Perpetual Calendar ¬∑ ÁØÄÊ∞£ Solar Terms</p>
                    <p>Áî®Á•û Beneficial Elements ¬∑ Á¥çÈü≥ Sound Elements</p>
                    <p>ÂëΩÂÆÆ Life Palace ¬∑ ËÉéÂÖÉ Conception Origin ¬∑ ÊîØËóèÂπ≤ Hidden Stems</p>
                    <p>ÈÄöÊ†πÈÄèÂπ≤ Root & Stem ¬∑ ÊñπÂêà Directional Harmony ¬∑ ÊöóÂêà Hidden Harmony</p>
                    <p>ÂÖ≠ÂçÅÁî≤Â≠ê Êó•Êü±Ë´ñ 60 Pillars Day Master Theory</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         Tab 2: POWERBALL
         ======================================== -->
    <div id="tab-powerball" class="tab-content">
        <header>
            <div class="dragon-seal">
                <svg viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="dragonGold2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700"/>
                            <stop offset="50%" style="stop-color:#FFA500"/>
                            <stop offset="100%" style="stop-color:#FFD700"/>
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="45" fill="none" stroke="url(#dragonGold2)" stroke-width="2"/>
                    <text x="50" y="58" text-anchor="middle" fill="url(#dragonGold2)" font-size="32" font-family="serif">Èæç</text>
                </svg>
            </div>
            <h1>K-MUDANG</h1>
            <span class="game-title">POWERBALL</span>
            <p class="subtitle">Ancient Korean Zodiac Algorithm</p>
        </header>

        <div class="card">
            <h3>üìÖ Your Birth Date</h3>
            <div class="form-row" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group"><label>Month</label><select id="pb-month"></select></div>
                <div class="form-group"><label>Day</label><select id="pb-day"></select></div>
                <div class="form-group"><label>Year</label><select id="pb-year"></select></div>
            </div>
            <button class="btn btn-secondary" onclick="generatePowerball('quick')">üé≤ Quick Pick (Random)</button>
            <div style="margin-top:15px;padding:12px;background:rgba(255,215,0,0.05);border-radius:8px;border:1px solid rgba(212,175,55,0.2);">
                <p style="font-size:0.8rem;color:var(--gold);margin-bottom:8px;">üîÆ Want destiny-based numbers?</p>
                <button class="premium-unlock-btn" onclick="openPremiumCheckout()" style="padding:8px 16px;font-size:12px;">
                    üëë Unlock Destiny Numbers
                </button>
            </div>
        </div>

        <div class="card" id="pb-result" style="display:none;">
            <h3>üé∞ Your Numbers</h3>
            <div class="balls-container" id="pb-balls"></div>
            
            <!-- Premium Upsell -->
            <div style="text-align:center;margin-top:20px;padding:15px;background:rgba(255,215,0,0.05);border-radius:10px;">
                <p style="color:var(--gold);margin-bottom:10px;">üëë Want AI-powered destiny analysis?</p>
                <button class="premium-unlock-btn" onclick="openPremiumCheckout()" style="padding:10px 20px;font-size:12px;">
                    Unlock Premium $10
                </button>
            </div>
        </div>

        <div class="card history-section" id="pb-history" style="display:none;">
            <h3>üìã History</h3>
            <div id="pb-history-list"></div>
        </div>
    </div>

    <!-- ========================================
         Tab 3: MEGA MILLIONS
         ======================================== -->
    <div id="tab-mega" class="tab-content">
        <header>
            <div class="dragon-seal">
                <svg viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="dragonGold3" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700"/>
                            <stop offset="50%" style="stop-color:#FFA500"/>
                            <stop offset="100%" style="stop-color:#FFD700"/>
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="45" fill="none" stroke="url(#dragonGold3)" stroke-width="2"/>
                    <text x="50" y="58" text-anchor="middle" fill="url(#dragonGold3)" font-size="32" font-family="serif">Èæç</text>
                </svg>
            </div>
            <h1>K-MUDANG</h1>
            <span class="game-title">MEGA MILLIONS</span>
            <p class="subtitle">Ancient Korean Zodiac Algorithm</p>
        </header>

        <div class="card">
            <h3>üìÖ Your Birth Date</h3>
            <div class="form-row" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group"><label>Month</label><select id="mega-month"></select></div>
                <div class="form-group"><label>Day</label><select id="mega-day"></select></div>
                <div class="form-group"><label>Year</label><select id="mega-year"></select></div>
            </div>
            <button class="btn btn-secondary" onclick="generateMega('quick')">üé≤ Quick Pick (Random)</button>
            <div style="margin-top:15px;padding:12px;background:rgba(255,215,0,0.05);border-radius:8px;border:1px solid rgba(212,175,55,0.2);">
                <p style="font-size:0.8rem;color:var(--gold);margin-bottom:8px;">üîÆ Want destiny-based numbers?</p>
                <button class="premium-unlock-btn" onclick="openPremiumCheckout()" style="padding:8px 16px;font-size:12px;">
                    üëë Unlock Destiny Numbers
                </button>
            </div>
        </div>

        <div class="card" id="mega-result" style="display:none;">
            <h3>üé∞ Your Numbers</h3>
            <div class="balls-container" id="mega-balls"></div>
            
            <!-- Premium Upsell -->
            <div style="text-align:center;margin-top:20px;padding:15px;background:rgba(255,215,0,0.05);border-radius:10px;">
                <p style="color:var(--gold);margin-bottom:10px;">üëë Want AI-powered destiny analysis?</p>
                <button class="premium-unlock-btn" onclick="openPremiumCheckout()" style="padding:10px 20px;font-size:12px;">
                    Unlock Premium $10
                </button>
            </div>
        </div>

        <div class="card history-section" id="mega-history" style="display:none;">
            <h3>üìã History</h3>
            <div id="mega-history-list"></div>
        </div>
    </div>

</div>

<footer>
    <p style="color:var(--gold);margin-bottom:8px;">üîí Pursuing pure scholarly research without any advertisements</p>
    <p style="font-size:0.85rem;color:var(--gray);margin-bottom:10px;">Ancient Korean Zodiac Algorithm ¬∑ Four Pillars of Destiny</p>
    <p style="opacity:0.5;font-size:0.8rem;">¬© 2026 K-MUDANG Pro ¬∑ Institute of Destiny Studies (ÂëΩÁêÜÁ°èÁ©∂ÊâÄ)</p>
</footer>

<div class="toast" id="toast"></div>

<script>
/* ========================================
   1. Í∏∞Ï¥à Îç∞Ïù¥ÌÑ∞
   ======================================== */

// Historical winning numbers
const PAST_WINNERS = [
[1,4,16,23,31,41],[10,23,29,33,37,40],[9,13,21,25,32,42],[11,16,19,21,27,31],[14,27,30,31,40,42],[16,24,29,40,41,42],
[14,15,26,27,40,42],[2,9,16,25,26,40],[8,19,25,34,37,39],[2,4,16,17,36,39],[9,25,30,33,41,44],[1,7,36,37,41,42],
[2,11,21,25,39,45],[22,34,36,37,42,44],[2,6,12,19,33,44],[1,4,9,23,34,45],[6,13,27,35,40,41],[4,14,22,38,39,45],
[6,8,14,21,23,38],[3,5,15,16,44,45],[8,13,14,26,28,43],[5,17,18,23,30,33],[4,5,7,9,24,42],[1,6,11,20,31,35],
[7,16,34,37,38,43],[4,9,12,14,24,44],[2,10,12,13,23,29],[2,14,16,18,28,43],[3,6,7,8,27,35],[1,5,23,24,35,37],
[9,14,20,23,33,34],[11,16,21,22,28,42],[8,18,21,27,29,45],[1,4,7,23,28,43],[3,13,24,29,34,40],[5,6,17,22,28,31],
[3,4,14,15,22,26],[1,4,15,25,29,30],[4,6,14,16,24,40],[5,6,11,22,25,38],[12,19,24,26,38,43],[5,13,26,28,41,42],
[4,16,17,21,31,45],[2,5,6,30,31,36],[1,9,16,19,21,25],[7,8,27,30,36,43],[4,10,14,27,29,41],[10,11,25,27,28,31],
[4,9,12,30,39,43],[4,13,22,24,40,42],[3,12,17,34,36,40],[1,13,22,25,34,41],[3,6,10,13,27,42],[3,4,18,30,32,35],
[6,9,11,17,18,25],[8,10,14,28,38,40],[2,8,16,21,27,44],[4,21,23,24,39,41],[2,3,5,8,18,29],[6,12,18,32,40,43]
];
const PAST_SET = new Set(PAST_WINNERS.map(arr => [...arr].sort((a,b)=>a-b).join(',')));

// Heavenly Stems
const STEM = [
    {c:'Áî≤',k:'Wood+',e:'wood',y:true},{c:'‰πô',k:'Wood-',e:'wood',y:false},
    {c:'‰∏ô',k:'Fire+',e:'fire',y:true},{c:'‰∏Å',k:'Fire-',e:'fire',y:false},
    {c:'Êàä',k:'Earth+',e:'earth',y:true},{c:'Â∑±',k:'Earth-',e:'earth',y:false},
    {c:'Â∫ö',k:'Metal+',e:'metal',y:true},{c:'Ëæõ',k:'Metal-',e:'metal',y:false},
    {c:'Â£¨',k:'Water+',e:'water',y:true},{c:'Áô∏',k:'Water-',e:'water',y:false}
];

// Earthly Branches
const BRANCH = [
    {c:'Â≠ê',k:'Rat',e:'water',a:'Rat',m:'rat'},{c:'‰∏ë',k:'Ox',e:'earth',a:'Ox',m:'ox'},
    {c:'ÂØÖ',k:'Tiger',e:'wood',a:'Tiger',m:'tiger'},{c:'ÂçØ',k:'Rabbit',e:'wood',a:'Rabbit',m:'rabbit'},
    {c:'Ëæ∞',k:'Dragon',e:'earth',a:'Dragon',m:'dragon'},{c:'Â∑≥',k:'Snake',e:'fire',a:'Snake',m:'snake'},
    {c:'Âçà',k:'Horse',e:'fire',a:'Horse',m:'horse'},{c:'Êú™',k:'Goat',e:'earth',a:'Goat',m:'goat'},
    {c:'Áî≥',k:'Monkey',e:'metal',a:'Monkey',m:'monkey'},{c:'ÈÖâ',k:'Rooster',e:'metal',a:'Rooster',m:'rooster'},
    {c:'Êàå',k:'Dog',e:'earth',a:'Dog',m:'dog'},{c:'‰∫•',k:'Pig',e:'water',a:'Pig',m:'pig'}
];

// Hidden Stems(Âú∞ËóèÂπ≤) - Main/Middle/Side with days
// Hidden stems in each branch (Main=main energy, Middle, Side)
// days: days this energy operates days (based on 30 days)
const HIDDEN_STEMS = {
    0: [ // Â≠ê (Rat)
        {stem: 9, type: 'jung', days: 30, name: 'Áô∏(Main)'} // Yin Water 30 days
    ],
    1: [ // ‰∏ë (Ox)
        {stem: 9, type: 'yeo', days: 9, name: 'Áô∏(Side)'},  // Yin Water 9 days
        {stem: 7, type: 'jung', days: 3, name: 'Ëæõ(Middle)'}, // Yin Metal 3 days
        {stem: 5, type: 'jung', days: 18, name: 'Â∑±(Main)'} // Yin Earth 18 days
    ],
    2: [ // ÂØÖ (Tiger)
        {stem: 4, type: 'yeo', days: 7, name: 'Êàä(Side)'},  // Yang Earth 7 days
        {stem: 2, type: 'jung', days: 7, name: '‰∏ô(Middle)'}, // Yang Fire 7 days
        {stem: 0, type: 'jung', days: 16, name: 'Áî≤(Main)'} // Yang Wood 16 days
    ],
    3: [ // ÂçØ (Rabbit)
        {stem: 1, type: 'jung', days: 30, name: '‰πô(Main)'} // Tiger Wood 30 days
    ],
    4: [ // Ëæ∞ (Dragon)
        {stem: 1, type: 'yeo', days: 9, name: '‰πô(Side)'},  // Tiger Wood 9 days
        {stem: 9, type: 'jung', days: 3, name: 'Áô∏(Middle)'}, // Yin Water 3 days
        {stem: 4, type: 'jung', days: 18, name: 'Êàä(Main)'} // Yang Earth 18 days
    ],
    5: [ // Â∑≥ (Snake)
        {stem: 4, type: 'yeo', days: 5, name: 'Êàä(Side)'},  // Yang Earth 5 days
        {stem: 6, type: 'jung', days: 9, name: 'Â∫ö(Middle)'}, // Yang Metal 9 days
        {stem: 2, type: 'jung', days: 16, name: '‰∏ô(Main)'} // Yang Fire 16 days
    ],
    6: [ // Âçà (Horse)
        {stem: 5, type: 'yeo', days: 9, name: 'Â∑±(Side)'},  // Yin Earth 9 days
        {stem: 3, type: 'jung', days: 21, name: '‰∏Å(Main)'} // Yin Fire 21 days
    ],
    7: [ // Êú™ (Goat)
        {stem: 3, type: 'yeo', days: 9, name: '‰∏Å(Side)'},  // Yin Fire 9 days
        {stem: 1, type: 'jung', days: 3, name: '‰πô(Middle)'}, // Tiger Wood 3 days
        {stem: 5, type: 'jung', days: 18, name: 'Â∑±(Main)'} // Yin Earth 18 days
    ],
    8: [ // Áî≥ (Monkey)
        {stem: 4, type: 'yeo', days: 7, name: 'Êàä(Side)'},  // Yang Earth 7 days
        {stem: 8, type: 'jung', days: 7, name: 'Â£¨(Middle)'}, // Yang Water 7 days
        {stem: 6, type: 'jung', days: 16, name: 'Â∫ö(Main)'} // Yang Metal 16 days
    ],
    9: [ // ÈÖâ (Rooster)
        {stem: 7, type: 'jung', days: 30, name: 'Ëæõ(Main)'} // Yin Metal 30 days
    ],
    10: [ // Êàå (Dog)
        {stem: 7, type: 'yeo', days: 9, name: 'Ëæõ(Side)'},  // Yin Metal 9 days
        {stem: 3, type: 'jung', days: 3, name: '‰∏Å(Middle)'}, // Yin Fire 3 days
        {stem: 4, type: 'jung', days: 18, name: 'Êàä(Main)'} // Yang Earth 18 days
    ],
    11: [ // ‰∫• (Pig)
        {stem: 0, type: 'yeo', days: 7, name: 'Áî≤(Side)'},  // Yang Wood 7 days
        {stem: 8, type: 'jung', days: 23, name: 'Â£¨(Main)'} // Yang Water 23 days
    ]
};

// Five Elements
const ELEMENT = {
    wood:{c:'Êú®',k:'Wood',n:'Êú®(Wood)',color:'#4CAF50',icon:'üå≥',nums:[3,8,13,18,23,28,33,38,43]},
    fire:{c:'ÁÅ´',k:'Fire',n:'ÁÅ´(Fire)',color:'#F44336',icon:'üî•',nums:[2,7,12,17,22,27,32,37,42]},
    earth:{c:'Âúü',k:'Earth',n:'Âúü(Earth)',color:'#FF9800',icon:'üåç',nums:[5,10,15,20,25,30,35,40,45]},
    metal:{c:'Èáë',k:'Metal',n:'Èáë(Metal)',color:'#9E9E9E',icon:'‚öôÔ∏è',nums:[4,9,14,19,24,29,34,39,44]},
    water:{c:'Ê∞¥',k:'Water',n:'Ê∞¥(Water)',color:'#2196F3',icon:'üíß',nums:[1,6,11,16,21,26,31,36,41]}
};
const EL_ORDER = ['wood','fire','earth','metal','water'];

// Directional Harmony (ÊñπÂêà) - Í∞ôÏùÄ Î∞©Ìñ• 3ÏßÄÏßÄÍ∞Ä Î™®Ïó¨ Í∞ïÎ†•Ìïú Ïò§Ìñâ ÌòïÏÑ±
const BANGHAP = [
    {branches: [2,3,4], element: 'wood', name: 'ÂØÖÂçØËæ∞(Tiger-Rabbit-Dragon) ÊñπÂêà(Directional Harmony)', dir: 'Eastern Wood Direction'},   // ÂØÖÂçØËæ∞
    {branches: [5,6,7], element: 'fire', name: 'Â∑≥ÂçàÊú™(Snake-Horse-Goat) ÊñπÂêà(Directional Harmony)', dir: 'Southern Fire'},   // Â∑≥ÂçàÊú™
    {branches: [8,9,10], element: 'metal', name: 'Áî≥ÈÖâÊàå(Monkey-Rooster-Dog) ÊñπÂêà(Directional Harmony)', dir: 'Western Metal Direction'}, // Áî≥ÈÖâÊàå
    {branches: [11,0,1], element: 'water', name: '‰∫•Â≠ê‰∏ë(Pig-Rat-Ox) ÊñπÂêà(Directional Harmony)', dir: 'Northern Water Direction'}  // ‰∫•Â≠ê‰∏ë
];

// Hidden Harmony (ÊöóÂêà) - Hidden StemsÎÅºÎ¶¨Ïùò Ïà®ÏùÄ Harmony
const AMHAP = [
    {a: 2, b: 1, name: 'ÂØÖ‰∏ë(Tiger-Ox) Hidden Harmony', desc: 'ÂØÖ(Tiger) contains Yang Fire(‰∏ô) harmonizing with ‰∏ë(Ox) Yin Metal(Ëæõ)'},    // ÂØÖ-‰∏ë
    {a: 3, b: 8, name: 'ÂçØÁî≥(Rabbit-Monkey) Hidden Harmony', desc: 'ÂçØ(Rabbit) contains Yin Wood(‰πô) harmonizing with Áî≥(Monkey) Yang Metal(Â∫ö)'},    // ÂçØ-Áî≥
    {a: 4, b: 9, name: 'Ëæ∞ÈÖâ(Dragon-Rooster) Hidden Harmony', desc: 'Ëæ∞(Dragon) contains Yin Wood(‰πô) harmonizing with ÈÖâ(Rooster) Yang Metal(Â∫ö)'},    // Ëæ∞-ÈÖâ
    {a: 5, b: 8, name: 'Â∑≥Áî≥(Snake-Monkey) Hidden Harmony', desc: 'Â∑≥(Snake) contains Yang Fire(‰∏ô) harmonizing with Áî≥(Monkey) Yang Metal(Â∫ö)'},    // Â∑≥-Áî≥
    {a: 6, b: 1, name: 'Âçà‰∏ë(Horse-Ox) Hidden Harmony', desc: 'Âçà(Horse) contains Yin Fire(‰∏Å) harmonizing with ‰∏ë(Ox) Yin Earth(Â∑±)'},    // Âçà-‰∏ë
    {a: 6, b: 11, name: 'Âçà‰∫•(Horse-Pig) Hidden Harmony', desc: 'Âçà(Horse) contains Yin Fire(‰∏Å) harmonizing with ‰∫•(Pig) Yang Water(Â£¨)'}    // Âçà-‰∫•
];

// Sound-Element (Á¥çÈü≥) - Cosmic resonance of the 60 Pillars
const NAPEUM = [
    {name: 'Sea Metal (Êµ∑‰∏≠Èáë)', element: 'metal', nameK: 'Ìï¥Ï§ëÍ∏à', desc: 'Gold hidden beneath the ocean. A treasure waiting to be discovered within your soul.'},
    {name: 'Furnace Fire (Áàê‰∏≠ÁÅ´)', element: 'fire', nameK: 'ÎÖ∏Ï§ëÌôî', desc: 'Flames within the forge. Your spirit transforms raw potential into refined greatness.'},
    {name: 'Forest Wood (Â§ßÊûóÊú®)', element: 'wood', nameK: 'ÎåÄÎ¶ºÎ™©', desc: 'Towering trees of a great forest. Your presence commands respect and admiration.'},
    {name: 'Roadside Earth (Ë∑ØÂÇçÂúü)', element: 'earth', nameK: 'ÎÖ∏Î∞©ÌÜ†', desc: 'Earth along the path. You adapt gracefully wherever life takes you.'},
    {name: 'Sword Metal (ÂäçÈãíÈáë)', element: 'metal', nameK: 'Í≤ÄÎ¥âÍ∏à', desc: 'The blade\'s edge. Sharp intuition and decisive action define your spirit.'},
    {name: 'Mountain Fire (Â±±È†≠ÁÅ´)', element: 'fire', nameK: 'ÏÇ∞ÎëêÌôî', desc: 'Fire upon the peak. Lofty aspirations burn bright within you.'},
    {name: 'Valley Water (Êæó‰∏ãÊ∞¥)', element: 'water', nameK: 'Í∞ÑÌïòÏàò', desc: 'Crystal stream in the valley. Pure wisdom flows through your being.'},
    {name: 'Fortress Earth (ÂüéÈ†≠Âúü)', element: 'earth', nameK: 'ÏÑ±ÎëêÌÜ†', desc: 'Earth of castle walls. Unwavering strength protects what you cherish.'},
    {name: 'Wax Metal (ÁôΩË†üÈáë)', element: 'metal', nameK: 'Î∞±ÎûçÍ∏à', desc: 'Polished precious metal. Refined elegance marks your every endeavor.'},
    {name: 'Willow Wood (Ê•äÊü≥Êú®)', element: 'wood', nameK: 'ÏñëÎ•òÎ™©', desc: 'The graceful willow. Flexibility and beauty dance within your nature.'},
    {name: 'Spring Water (Ê≥â‰∏≠Ê∞¥)', element: 'water', nameK: 'Ï≤úÏ§ëÏàò', desc: 'Ever-flowing spring. Boundless vitality rises from your depths.'},
    {name: 'Roof Earth (Â±ã‰∏äÂúü)', element: 'earth', nameK: 'Ïò•ÏÉÅÌÜ†', desc: 'Earth upon the roof. You shelter and protect those you love.'},
    {name: 'Thunder Fire (ÈúπÈùÇÁÅ´)', element: 'fire', nameK: 'Î≤ΩÎ†•Ìôî', desc: 'Lightning\'s fire. Explosive brilliance illuminates your path.'},
    {name: 'Pine Wood (ÊùæÊ†¢Êú®)', element: 'wood', nameK: 'ÏÜ°Î∞±Î™©', desc: 'Evergreen pine. Eternal integrity through all seasons of life.'},
    {name: 'River Water (Èï∑ÊµÅÊ∞¥)', element: 'water', nameK: 'Ïû•Î•òÏàò', desc: 'The long river. Your influence flows far and wide with gentle persistence.'},
    {name: 'Sand Metal (Á†Ç‰∏≠Èáë)', element: 'metal', nameK: 'ÏÇ¨Ï§ëÍ∏à', desc: 'Gold within the sand. Hidden talents await their moment to shine.'},
    {name: 'Foothill Fire (Â±±‰∏ãÁÅ´)', element: 'fire', nameK: 'ÏÇ∞ÌïòÌôî', desc: 'Fire at mountain\'s base. Dormant power ready to ignite.'},
    {name: 'Plain Wood (Âπ≥Âú∞Êú®)', element: 'wood', nameK: 'ÌèâÏßÄÎ™©', desc: 'Trees of the plains. Your influence spreads across vast horizons.'},
    {name: 'Wall Earth (Â£Å‰∏äÂúü)', element: 'earth', nameK: 'Î≤ΩÏÉÅÌÜ†', desc: 'Earth upon walls. Artistic sensibility adorns your soul.'},
    {name: 'Gilded Metal (ÈáëÁÆîÈáë)', element: 'metal', nameK: 'Í∏àÎ∞ïÍ∏à', desc: 'Precious gold leaf. Dazzling beauty with delicate grace.'},
    {name: 'Lantern Fire (Ë¶ÜÁáàÁÅ´)', element: 'fire', nameK: 'Î≥µÎì±Ìôî', desc: 'Light of the lantern. Wisdom that illuminates the darkness for others.'},
    {name: 'Celestial Water (Â§©Ê≤≥Ê∞¥)', element: 'water', nameK: 'Ï≤úÌïòÏàò', desc: 'Waters of the Milky Way. Cosmic dreams flow through your consciousness.'},
    {name: 'Crossroad Earth (Â§ßÈ©õÂúü)', element: 'earth', nameK: 'ÎåÄÏó≠ÌÜ†', desc: 'Earth of the great station. Connection and exchange define your purpose.'},
    {name: 'Ornament Metal (ÈáµÈáßÈáë)', element: 'metal', nameK: 'Ï∞®Ï≤úÍ∏à', desc: 'Precious hairpin. Nobility and elegance grace your presence.'},
    {name: 'Mulberry Wood (Ê°ëÊüòÊú®)', element: 'wood', nameK: 'ÏÉÅÏûêÎ™©', desc: 'The mulberry tree. Practical wisdom yields abundant blessings.'},
    {name: 'Canyon Water (Â§ßÊ∫™Ê∞¥)', element: 'water', nameK: 'ÎåÄÍ≥ÑÏàò', desc: 'Waters of the great canyon. Depth and breadth define your spirit.'},
    {name: 'Desert Earth (Á†Ç‰∏≠Âúü)', element: 'earth', nameK: 'ÏÇ¨Ï§ëÌÜ†', desc: 'Earth within sand. Patient foundation-building brings lasting success.'},
    {name: 'Heavenly Fire (Â§©‰∏äÁÅ´)', element: 'fire', nameK: 'Ï≤úÏÉÅÌôî', desc: 'Fire in the heavens ‚Äî the Sun itself. Your radiance touches all around you.'},
    {name: 'Pomegranate Wood (Áü≥Ê¶¥Êú®)', element: 'wood', nameK: 'ÏÑùÎ•òÎ™©', desc: 'The pomegranate tree. Abundant fruits of your labor await harvest.'},
    {name: 'Ocean Water (Â§ßÊµ∑Ê∞¥)', element: 'water', nameK: 'ÎåÄÌï¥Ïàò', desc: 'The vast ocean. Infinite capacity to embrace all of life\'s currents.'}
];

// Season
const SEASON = {0:'winter',1:'winter',2:'spring',3:'spring',4:'spring',5:'summer',6:'summer',7:'summer',8:'autumn',9:'autumn',10:'autumn',11:'winter'};

// US Month abbreviations
const MONTH_ABBR = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

// Ten Gods (ÂçÅÁ•û) - The cosmic influences shaping your destiny
const TEN_GODS = {
    bijeon:{k:'ÊØîËÇ© Peer',c:'ÊØîËÇ©',e:'Peer',d:'The Alter Ego. Confidence and independence drive you. You thrive in equal partnerships.'},
    geupjae:{k:'Âä´Ë≤° Competitor',c:'Âä´Ë≤°',e:'Competitor',d:'The Ambition. A fierce competitive spirit burns within. Channel this drive to conquer, not to conflict.'},
    siksin:{k:'È£üÁ•û Eating God',c:'È£üÁ•û',e:'Eating God',d:'The Creator. Natural optimism and artistic talent flow through you. You are blessed with the joy of life.'},
    sanggwan:{k:'ÂÇ∑ÂÆò Expressor',c:'ÂÇ∑ÂÆò',e:'Expressor',d:'The Innovator. You break rules to create new ones. Your sharp wit and expression are your greatest weapons.'},
    pyeonjae:{k:'ÂÅèË≤° Indirect Wealth',c:'ÂÅèË≤°',e:'Indirect Wealth',d:'The Strategist. You see value where others don\'t. A risk-taker destined for dynamic wealth.'},
    jeongjae:{k:'Ê≠£Ë≤° Direct Wealth',c:'Ê≠£Ë≤°',e:'Direct Wealth',d:'The Steward. Honest effort builds your empire. You value stability, trust, and tangible results.'},
    pyeongwan:{k:'ÂÅèÂÆò Challenger',c:'ÂÅèÂÆò',e:'Challenger',d:'The Commander. Charisma and willpower define you. You are built to endure pressure and lead in crisis.'},
    jeonggwan:{k:'Ê≠£ÂÆò Direct Officer',c:'Ê≠£ÂÆò',e:'Direct Officer',d:'The Guardian. Honor and principles guide your path. You shine in structured environments and leadership.'},
    pyeonin:{k:'ÂÅèÂç∞ Indirect Seal',c:'ÂÅèÂç∞',e:'Indirect Seal',d:'The Philosopher. Unconventional wisdom and intuition are your guides. You see the hidden truths of the world.'},
    jeongin:{k:'Ê≠£Âç∞ Direct Seal',c:'Ê≠£Âç∞',e:'Direct Seal',d:'The Scholar. Loved and supported by many. Wisdom and learning are your lifelong companions.'}
};

// ÂçÅ‰∫åÈÅãÊòü(Twelve Life Stages) (ÂçÅ‰∫åÈÅãÊòü) - The cycle of cosmic energy
const TWELVE_STATES = [
    {k:'Èï∑Áîü(Birth)',l:12,d:'New life awakens. Fresh beginnings and infinite hope bless this phase.'},
    {k:'Ê≤êÊµ¥(Bath)',l:8,d:'The cleansing waters. Transformation brings temporary instability before renewal.'},
    {k:'ÂÜ†Â∏∂(Crown)',l:10,d:'Rising energy. Growth accelerates as opportunities unfold before you.'},
    {k:'Ëá®ÂÆò(Official)',l:11,d:'Peak vitality. Maximum energy propels you toward your greatest achievements.'},
    {k:'Â∏ùÊó∫(Peak)',l:12,d:'The summit. Power and status reach their zenith under heaven\'s favor.'},
    {k:'Ë°∞(Decline)',l:7,d:'Gentle descent. Wisdom accumulates as you embrace graceful transition.'},
    {k:'ÁóÖ(Illness)',l:4,d:'Waning strength. Rest and reflection restore what ambition has spent.'},
    {k:'Ê≠ª(Stillness)',l:3,d:'Completion approaches. Honor endings as you prepare for rebirth.'},
    {k:'Â¢ì(Storage)',l:2,d:'The hidden phase. Inner cultivation in silence precedes emergence.'},
    {k:'Áµ∂(Void)',l:1,d:'Complete emptiness. From the void, new possibilities are born.'},
    {k:'ËÉé(Conception)',l:5,d:'Life stirs. Seeds of future potential take root in cosmic soil.'},
    {k:'È§ä(Nurture)',l:6,d:'Gentle growth. Patient development builds strength for the journey ahead.'}
];

// Solar Terms Data (1940-2050) - yearly 12 solar terms [month,day,hour,minute]
// Index: 0=Ipchun(Feb),1=Gyeongchip(Mar),2=Cheongmyeong(Apr),3=Ipha(May),4=Mangjong(Jun),5=Soseo(Jul)
//        6=Ipchu(Aug),7=Baekro(Sep),8=Hanro(Oct),9=Ipdong(Nov),10=Daeseol(Dec),11=Sohan(Jan)
const SOLAR_TERMS = {
1940:[[2,5,1,8],[3,6,18,51],[4,5,23,17],[5,6,11,19],[6,6,15,30],[7,7,2,4],[8,8,11,44],[9,8,14,18],[10,9,5,53],[11,8,8,30],[12,7,1,15],[1,6,7,8]],
1941:[[2,4,6,50],[3,6,0,34],[4,5,5,3],[5,6,17,9],[6,6,21,22],[7,8,7,59],[8,8,17,40],[9,8,20,15],[10,9,11,51],[11,8,14,27],[12,7,7,12],[1,6,12,58]],
1942:[[2,4,12,34],[3,6,6,17],[4,5,10,49],[5,5,22,57],[6,6,3,11],[7,7,13,49],[8,7,23,31],[9,8,2,7],[10,8,17,43],[11,7,20,20],[12,7,13,5],[1,6,18,49]],
1943:[[2,4,18,21],[3,6,12,3],[4,5,16,36],[5,6,4,44],[6,6,8,59],[7,7,19,38],[8,8,5,21],[9,8,7,58],[10,8,23,35],[11,8,2,12],[12,7,18,57],[1,6,0,40]],
1944:[[2,5,0,23],[3,5,18,6],[4,4,22,42],[5,5,10,52],[6,5,15,9],[7,7,1,51],[8,7,11,36],[9,7,14,14],[10,8,5,51],[11,7,8,28],[12,7,1,12],[1,6,6,31]],
1945:[[2,4,6,19],[3,6,0,5],[4,5,4,41],[5,5,16,52],[6,5,21,9],[7,7,7,52],[8,7,17,38],[9,7,20,17],[10,8,11,54],[11,7,14,31],[12,7,7,14],[1,6,12,24]],
1946:[[2,4,12,3],[3,6,5,46],[4,5,10,21],[5,5,22,34],[6,6,2,53],[7,7,13,37],[8,7,23,25],[9,8,2,6],[10,8,17,44],[11,7,20,21],[12,7,13,5],[1,6,18,15]],
1947:[[2,4,17,51],[3,6,11,32],[4,5,16,6],[5,6,4,23],[6,6,8,44],[7,7,19,26],[8,8,5,16],[9,8,7,58],[10,8,23,37],[11,8,2,14],[12,7,18,58],[1,6,0,7]],
1948:[[2,4,23,42],[3,5,17,22],[4,4,21,57],[5,5,10,9],[6,5,14,30],[7,7,1,16],[8,7,11,7],[9,7,13,51],[10,8,5,29],[11,7,8,7],[12,7,0,50],[1,6,5,59]],
1949:[[2,4,5,22],[3,5,23,2],[4,5,3,35],[5,5,15,49],[6,5,20,13],[7,7,6,59],[8,7,16,53],[9,7,19,38],[10,8,11,18],[11,7,13,56],[12,7,6,39],[1,6,11,49]],
1950:[[2,4,11,3],[3,6,4,42],[4,5,9,14],[5,5,21,37],[6,6,2,2],[7,7,12,46],[8,7,22,43],[9,8,1,29],[10,8,17,9],[11,7,19,47],[12,7,12,30],[1,6,17,38]],
1951:[[2,4,16,52],[3,6,10,26],[4,5,14,59],[5,6,3,14],[6,6,7,42],[7,7,18,29],[8,8,4,26],[9,8,7,14],[10,8,22,55],[11,8,1,33],[12,7,18,16],[1,6,23,29]],
1952:[[2,4,22,53],[3,5,16,22],[4,4,20,56],[5,5,9,9],[6,5,13,35],[7,7,0,22],[8,7,10,19],[9,7,13,8],[10,8,4,48],[11,7,7,26],[12,7,0,9],[1,6,5,19]],
1953:[[2,4,4,45],[3,5,22,14],[4,5,2,48],[5,5,15,0],[6,5,19,25],[7,7,6,10],[8,7,16,7],[9,7,18,58],[10,8,10,39],[11,7,13,18],[12,7,6,1],[1,6,11,12]],
1954:[[2,4,10,30],[3,6,3,55],[4,5,8,28],[5,5,20,42],[6,6,1,10],[7,7,11,55],[8,7,21,54],[9,8,0,47],[10,8,16,29],[11,7,19,8],[12,7,11,52],[1,6,17,4]],
1955:[[2,4,16,17],[3,6,9,41],[4,5,14,15],[5,6,2,30],[6,6,6,59],[7,7,17,43],[8,8,3,44],[9,8,6,38],[10,8,22,21],[11,8,1,0],[12,7,17,44],[1,6,22,57]],
1956:[[2,4,22,12],[3,5,15,38],[4,4,20,12],[5,5,8,26],[6,5,12,54],[7,7,23,40],[8,7,9,40],[9,7,12,34],[10,8,4,16],[11,7,6,56],[12,6,23,40],[1,6,4,52]],
1957:[[2,4,3,55],[3,5,21,22],[4,5,1,57],[5,5,14,12],[6,5,18,42],[7,7,5,28],[8,7,15,28],[9,7,18,24],[10,8,10,7],[11,7,12,48],[12,7,5,33],[1,6,10,45]],
1958:[[2,4,9,48],[3,6,3,8],[4,5,7,42],[5,5,19,57],[6,6,0,27],[7,7,11,14],[8,7,21,16],[9,8,0,14],[10,8,15,58],[11,7,18,39],[12,7,11,24],[1,6,16,38]],
1959:[[2,4,15,42],[3,6,8,55],[4,5,13,28],[5,6,1,43],[6,6,6,14],[7,7,17,0],[8,8,3,2],[9,8,6,3],[10,8,21,49],[11,8,0,31],[12,7,17,16],[1,6,22,31]],
1960:[[2,4,21,42],[3,5,14,57],[4,4,19,30],[5,5,7,45],[6,5,12,16],[7,6,23,2],[8,7,8,59],[9,7,11,59],[10,8,3,41],[11,7,6,24],[12,6,23,9],[1,6,4,24]],
1961:[[2,4,3,22],[3,5,20,37],[4,5,1,12],[5,5,13,27],[6,5,18,0],[7,7,4,47],[8,7,14,48],[9,7,17,50],[10,8,9,34],[11,7,12,17],[12,7,5,3],[1,6,10,20]],
1962:[[2,4,9,17],[3,6,2,26],[4,5,6,59],[5,5,19,14],[6,5,23,47],[7,7,10,34],[8,7,20,37],[9,7,23,41],[10,8,15,27],[11,7,18,12],[12,7,10,59],[1,6,16,16]],
1963:[[2,4,15,8],[3,6,8,15],[4,5,12,48],[5,6,1,3],[6,6,5,38],[7,7,16,26],[8,8,2,30],[9,8,5,37],[10,8,21,24],[11,8,0,11],[12,7,16,57],[1,6,22,14]],
1964:[[2,4,21,4],[3,5,14,14],[4,4,18,47],[5,5,7,0],[6,5,11,33],[7,6,22,22],[8,7,8,25],[9,7,11,33],[10,8,3,21],[11,7,6,9],[12,6,22,56],[1,6,4,14]],
1965:[[2,4,2,45],[3,5,19,54],[4,5,0,29],[5,5,12,43],[6,5,17,19],[7,7,4,9],[8,7,14,13],[9,7,17,23],[10,8,9,13],[11,7,12,2],[12,7,4,51],[1,6,10,9]],
1966:[[2,4,8,37],[3,6,1,43],[4,5,6,16],[5,5,18,31],[6,5,23,5],[7,7,9,53],[8,7,20,0],[9,7,23,11],[10,8,14,59],[11,7,17,50],[12,7,10,38],[1,6,15,59]],
1967:[[2,4,14,30],[3,6,7,32],[4,5,12,4],[5,6,0,18],[6,6,4,52],[7,7,15,40],[8,8,1,49],[9,8,5,2],[10,8,20,52],[11,7,23,43],[12,7,16,32],[1,6,21,51]],
1968:[[2,4,20,27],[3,5,13,31],[4,4,17,59],[5,5,6,11],[6,5,10,45],[7,6,21,35],[8,7,7,40],[9,7,10,53],[10,8,2,44],[11,7,5,35],[12,6,22,24],[1,6,3,44]],
1969:[[2,4,2,7],[3,5,19,14],[4,4,23,49],[5,5,12,4],[6,5,16,40],[7,7,3,30],[8,7,13,36],[9,7,16,51],[10,8,8,41],[11,7,11,33],[12,7,4,22],[1,6,9,44]],
1970:[[2,4,7,45],[3,6,0,54],[4,5,5,30],[5,5,17,46],[6,5,22,24],[7,7,9,16],[8,7,19,24],[9,7,22,41],[10,8,14,32],[11,7,17,25],[12,7,10,14],[1,6,15,37]],
1971:[[2,4,13,25],[3,6,6,34],[4,5,11,10],[5,5,23,27],[6,6,4,6],[7,7,15,0],[8,8,1,11],[9,8,4,30],[10,8,20,22],[11,7,23,16],[12,7,16,5],[1,6,21,30]],
1972:[[2,4,19,20],[3,5,12,33],[4,4,17,3],[5,5,5,17],[6,5,9,53],[7,6,20,46],[8,7,6,55],[9,7,10,15],[10,8,2,7],[11,7,5,1],[12,6,21,50],[1,6,3,18]],
1973:[[2,4,1,3],[3,5,18,21],[4,4,22,53],[5,5,11,5],[6,5,15,43],[7,7,2,35],[8,7,12,44],[9,7,16,6],[10,8,7,59],[11,7,10,55],[12,7,3,45],[1,6,9,13]],
1974:[[2,4,6,58],[3,6,0,8],[4,5,4,40],[5,5,16,53],[6,5,21,29],[7,7,8,20],[8,7,18,29],[9,7,21,53],[10,8,13,45],[11,7,16,41],[12,7,9,31],[1,6,15,0]],
1975:[[2,4,12,58],[3,6,5,57],[4,5,10,28],[5,5,22,40],[6,6,3,14],[7,7,14,3],[8,8,0,10],[9,8,3,34],[10,8,19,26],[11,7,22,22],[12,7,15,12],[1,6,20,43]],
1976:[[2,4,18,39],[3,5,11,45],[4,4,16,17],[5,5,4,28],[6,5,9,4],[7,6,19,56],[8,7,6,5],[9,7,9,28],[10,8,1,19],[11,7,4,15],[12,6,21,3],[1,6,2,32]],
1977:[[2,4,0,33],[3,5,17,35],[4,4,22,6],[5,5,10,16],[6,5,14,50],[7,7,1,40],[8,7,11,48],[9,7,15,13],[10,8,7,4],[11,7,10,1],[12,7,2,49],[1,6,8,19]],
1978:[[2,4,6,26],[3,5,23,27],[4,5,3,56],[5,5,16,6],[6,5,20,37],[7,7,7,23],[8,7,17,30],[9,7,20,57],[10,8,12,47],[11,7,15,44],[12,7,8,32],[1,6,14,3]],
1979:[[2,4,12,12],[3,6,5,16],[4,5,9,47],[5,5,21,57],[6,6,2,28],[7,7,13,13],[8,7,23,20],[9,8,2,47],[10,8,18,38],[11,7,21,35],[12,7,14,23],[1,6,19,51]],
1980:[[2,4,18,9],[3,5,11,13],[4,4,15,40],[5,5,3,46],[6,5,8,16],[7,6,19,1],[8,7,5,9],[9,7,8,33],[10,8,0,23],[11,7,3,19],[12,6,20,6],[1,6,1,40]],
1981:[[2,3,23,55],[3,5,16,59],[4,4,21,27],[5,5,9,33],[6,5,14,3],[7,7,0,46],[8,7,10,55],[9,7,14,23],[10,8,6,13],[11,7,9,12],[12,7,2,0],[1,6,7,31]],
1982:[[2,4,5,45],[3,5,22,48],[4,5,3,17],[5,5,15,23],[6,5,19,51],[7,7,6,34],[8,7,16,43],[9,7,20,12],[10,8,12,3],[11,7,15,1],[12,7,7,49],[1,6,13,21]],
1983:[[2,4,11,39],[3,6,4,37],[4,5,9,7],[5,5,21,13],[6,6,1,41],[7,7,12,26],[8,7,22,36],[9,8,2,7],[10,8,17,57],[11,7,20,56],[12,7,13,44],[1,6,19,14]],
1984:[[2,4,17,18],[3,5,10,22],[4,4,14,52],[5,5,3,0],[6,5,7,32],[7,6,18,21],[8,7,4,31],[9,7,8,1],[10,8,23,51],[11,7,2,50],[12,6,19,37],[1,6,1,9]],
1985:[[2,3,23,11],[3,5,16,15],[4,4,20,45],[5,5,8,52],[6,5,13,22],[7,7,0,8],[8,7,10,18],[9,7,13,50],[10,8,5,40],[11,7,8,39],[12,7,1,28],[1,6,7,0]],
1986:[[2,4,5,8],[3,5,22,8],[4,5,2,36],[5,5,14,41],[6,5,19,10],[7,7,5,53],[8,7,16,4],[9,7,19,38],[10,8,11,29],[11,7,14,29],[12,7,7,18],[1,6,12,51]],
1987:[[2,4,11,7],[3,6,3,58],[4,5,8,24],[5,5,20,28],[6,6,0,55],[7,7,11,37],[8,7,21,49],[9,8,1,26],[10,8,17,18],[11,7,20,19],[12,7,13,8],[1,6,18,45]],
1988:[[2,4,16,42],[3,5,9,41],[4,4,14,13],[5,5,2,22],[6,5,6,54],[7,6,17,41],[8,7,3,53],[9,7,7,27],[10,8,23,18],[11,7,2,17],[12,6,19,4],[1,6,0,38]],
1989:[[2,3,22,27],[3,5,15,29],[4,4,20,3],[5,5,8,14],[6,5,12,48],[7,6,23,36],[8,7,9,47],[9,7,13,22],[10,8,5,12],[11,7,8,10],[12,7,0,57],[1,6,6,29]],
1990:[[2,4,4,14],[3,5,21,16],[4,5,1,47],[5,5,14,0],[6,5,18,37],[7,7,5,26],[8,7,15,38],[9,7,19,14],[10,8,11,3],[11,7,13,58],[12,7,6,44],[1,6,12,14]],
1991:[[2,4,10,8],[3,6,3,2],[4,5,7,30],[5,5,19,41],[6,6,0,19],[7,7,11,10],[8,7,21,25],[9,8,1,4],[10,8,16,53],[11,7,19,49],[12,7,12,34],[1,6,18,3]],
1992:[[2,4,15,48],[3,5,8,51],[4,4,13,22],[5,5,1,34],[6,5,6,12],[7,6,17,5],[8,7,3,18],[9,7,6,56],[10,8,22,45],[11,7,1,41],[12,6,18,25],[1,5,23,54]],
1993:[[2,3,21,37],[3,5,14,37],[4,4,19,10],[5,5,7,23],[6,5,12,2],[7,6,22,53],[8,7,9,7],[9,7,12,47],[10,8,4,36],[11,7,7,32],[12,7,0,17],[1,6,5,46]],
1994:[[2,4,3,30],[3,5,20,28],[4,5,1,1],[5,5,13,15],[6,5,17,55],[7,7,4,46],[8,7,15,1],[9,7,18,41],[10,8,10,30],[11,7,13,26],[12,7,6,11],[1,6,11,41]],
1995:[[2,4,9,13],[3,6,2,14],[4,5,6,48],[5,5,19,4],[6,5,23,47],[7,7,10,40],[8,7,20,55],[9,8,0,34],[10,8,16,22],[11,7,19,16],[12,7,11,59],[1,6,17,26]],
1996:[[2,4,15,7],[3,5,8,10],[4,4,12,42],[5,5,0,54],[6,5,5,32],[7,6,16,25],[8,7,2,40],[9,7,6,22],[10,8,22,12],[11,7,1,9],[12,6,17,53],[1,5,23,23]],
1997:[[2,3,20,51],[3,5,13,54],[4,4,18,28],[5,5,6,42],[6,5,11,24],[7,6,22,17],[8,7,8,32],[9,7,12,14],[10,8,4,1],[11,7,6,58],[12,6,23,42],[1,6,5,13]],
1998:[[2,4,2,56],[3,5,19,53],[4,5,0,24],[5,5,12,37],[6,5,17,15],[7,7,4,7],[8,7,14,22],[9,7,18,3],[10,8,9,51],[11,7,12,47],[12,7,5,32],[1,6,11,2]],
1999:[[2,4,8,57],[3,6,1,46],[4,5,6,16],[5,5,18,25],[6,5,23,2],[7,7,9,52],[8,7,20,7],[9,7,23,49],[10,8,15,38],[11,7,18,36],[12,7,11,22],[1,6,16,51]],
2000:[[2,4,14,40],[3,5,7,35],[4,4,12,5],[5,5,0,14],[6,5,4,50],[7,6,15,41],[8,7,1,54],[9,7,5,35],[10,8,21,24],[11,7,0,20],[12,6,17,4],[1,6,22,32]],
2001:[[2,3,20,28],[3,5,13,23],[4,4,17,55],[5,5,6,6],[6,5,10,44],[7,6,21,36],[8,7,7,50],[9,7,11,33],[10,8,3,21],[11,7,6,18],[12,6,23,2],[1,6,4,31]],
2002:[[2,4,2,24],[3,5,19,18],[4,4,23,48],[5,5,11,58],[6,5,16,35],[7,7,3,26],[8,7,13,42],[9,7,17,26],[10,8,9,16],[11,7,12,14],[12,7,4,59],[1,6,10,29]],
2003:[[2,4,8,5],[3,6,1,4],[4,5,5,37],[5,5,17,51],[6,5,22,31],[7,7,9,24],[8,7,19,40],[9,7,23,22],[10,8,15,10],[11,7,18,6],[12,7,10,49],[1,6,16,18]],
2004:[[2,4,13,56],[3,5,6,56],[4,4,11,26],[5,4,23,35],[6,5,4,12],[7,6,15,5],[8,7,1,20],[9,7,5,3],[10,8,20,52],[11,6,23,50],[12,6,16,34],[1,5,22,5]],
2005:[[2,3,19,42],[3,5,12,43],[4,4,17,16],[5,5,5,27],[6,5,10,5],[7,6,20,58],[8,7,7,12],[9,7,10,56],[10,8,2,46],[11,7,5,43],[12,6,22,27],[1,6,3,58]],
2006:[[2,4,1,27],[3,5,18,29],[4,4,22,59],[5,5,11,12],[6,5,15,52],[7,7,2,47],[8,7,13,3],[9,7,16,48],[10,8,8,36],[11,7,11,34],[12,7,4,18],[1,6,9,46]],
2007:[[2,4,7,18],[3,6,0,18],[4,5,4,46],[5,5,16,58],[6,5,21,36],[7,7,8,28],[8,7,18,45],[9,7,22,30],[10,8,14,20],[11,7,17,18],[12,7,10,3],[1,6,15,31]],
2008:[[2,4,13,0],[3,5,6,2],[4,4,10,33],[5,4,22,45],[6,5,3,23],[7,6,14,17],[8,7,0,31],[9,7,4,14],[10,8,20,2],[11,6,22,58],[12,6,15,41],[1,5,21,10]],
2009:[[2,3,18,49],[3,5,11,48],[4,4,16,18],[5,5,4,29],[6,5,9,8],[7,6,20,0],[8,7,6,14],[9,7,10,0],[10,8,1,49],[11,7,4,47],[12,6,21,32],[1,6,3,4]],
2010:[[2,4,0,48],[3,5,17,46],[4,4,22,15],[5,5,10,26],[6,5,15,5],[7,7,1,57],[8,7,12,11],[9,7,15,57],[10,8,7,45],[11,7,10,43],[12,7,3,27],[1,6,8,56]],
2011:[[2,4,6,32],[3,5,23,32],[4,5,4,2],[5,5,16,15],[6,5,20,55],[7,7,7,48],[8,7,18,2],[9,7,21,49],[10,8,13,38],[11,7,16,35],[12,7,9,19],[1,6,14,48]],
2012:[[2,4,12,22],[3,5,5,21],[4,4,9,49],[5,4,22,0],[6,5,2,38],[7,6,13,31],[8,6,23,45],[9,7,3,32],[10,8,19,21],[11,6,22,19],[12,6,15,3],[1,5,20,35]],
2013:[[2,3,18,13],[3,5,11,14],[4,4,15,42],[5,5,3,52],[6,5,8,29],[7,6,19,22],[8,7,5,37],[9,7,9,25],[10,8,1,14],[11,7,4,13],[12,6,21,0],[1,6,2,33]],
2014:[[2,4,0,3],[3,5,17,2],[4,4,21,30],[5,5,9,41],[6,5,14,18],[7,7,1,12],[8,7,11,28],[9,7,15,17],[10,8,7,7],[11,7,10,7],[12,7,2,52],[1,6,8,24]],
2015:[[2,4,5,58],[3,5,22,56],[4,5,3,24],[5,5,15,35],[6,5,20,12],[7,7,7,4],[8,7,17,18],[9,7,21,7],[10,8,12,56],[11,7,15,56],[12,7,8,41],[1,6,14,14]],
2016:[[2,4,11,46],[3,5,4,44],[4,4,9,12],[5,4,21,21],[6,5,2,0],[7,6,12,53],[8,6,23,7],[9,7,2,56],[10,8,18,45],[11,6,21,45],[12,6,14,31],[1,5,20,5]],
2017:[[2,3,17,33],[3,5,10,28],[4,4,14,56],[5,5,3,7],[6,5,7,47],[7,6,18,41],[8,7,4,54],[9,7,8,43],[10,8,0,32],[11,7,3,30],[12,6,20,16],[1,6,1,49]],
2018:[[2,3,23,28],[3,5,16,28],[4,4,20,54],[5,5,9,3],[6,5,13,40],[7,7,0,31],[8,7,10,44],[9,7,14,34],[10,8,6,23],[11,7,9,22],[12,7,2,7],[1,6,7,39]],
2019:[[2,4,5,14],[3,5,22,10],[4,5,2,40],[5,5,14,53],[6,5,19,33],[7,7,6,27],[8,7,16,41],[9,7,20,29],[10,8,12,17],[11,7,15,13],[12,7,7,56],[1,6,13,27]],
2020:[[2,4,10,58],[3,5,4,0],[4,4,8,30],[5,4,20,43],[6,5,1,22],[7,6,12,16],[8,6,22,29],[9,7,2,17],[10,8,18,5],[11,6,21,3],[12,6,13,46],[1,5,19,17]],
2021:[[2,3,16,58],[3,5,9,54],[4,4,14,22],[5,5,2,31],[6,5,7,8],[7,6,18,0],[8,7,4,13],[9,7,8,4],[10,7,23,56],[11,7,2,56],[12,6,19,42],[1,6,1,17]],
2022:[[2,3,22,50],[3,5,15,43],[4,4,20,11],[5,5,8,23],[6,5,12,59],[7,6,23,52],[8,7,10,5],[9,7,13,56],[10,8,5,47],[11,7,8,46],[12,7,1,30],[1,6,7,0]],
2023:[[2,4,4,42],[3,5,21,36],[4,5,2,3],[5,5,14,14],[6,5,18,51],[7,7,5,43],[8,7,15,56],[9,7,19,48],[10,8,11,38],[11,7,14,37],[12,7,7,22],[1,6,12,53]],
2024:[[2,4,10,26],[3,5,3,22],[4,4,7,50],[5,4,20,0],[6,5,0,38],[7,6,11,31],[8,6,21,43],[9,7,1,33],[10,8,17,22],[11,6,20,20],[12,6,13,4],[1,5,18,34]],
2025:[[2,3,16,10],[3,5,9,6],[4,4,13,32],[5,5,1,41],[6,5,6,17],[7,6,17,10],[8,7,3,23],[9,7,7,14],[10,7,23,4],[11,7,2,3],[12,6,18,48],[1,5,0,21]],
2026:[[2,3,22,2],[3,5,14,58],[4,4,19,27],[5,5,7,37],[6,5,12,14],[7,6,23,7],[8,7,9,20],[9,7,13,11],[10,8,5,1],[11,7,7,59],[12,7,0,44],[1,6,6,14]],
2027:[[2,4,3,46],[3,5,20,40],[4,5,1,9],[5,5,13,21],[6,5,17,59],[7,7,4,52],[8,7,15,6],[9,7,18,57],[10,8,10,47],[11,7,13,44],[12,7,6,29],[1,6,11,58]],
2028:[[2,4,9,31],[3,5,2,28],[4,4,6,57],[5,4,19,8],[6,4,23,46],[7,6,10,39],[8,6,20,52],[9,7,0,43],[10,8,16,32],[11,6,19,30],[12,6,12,15],[1,5,17,46]],
2029:[[2,3,15,20],[3,5,8,17],[4,4,12,46],[5,5,0,56],[6,5,5,33],[7,6,16,26],[8,7,2,38],[9,7,6,28],[10,7,22,18],[11,7,1,16],[12,6,18,1],[1,5,23,31]],
2030:[[2,3,21,8],[3,5,14,3],[4,4,18,32],[5,5,6,42],[6,5,11,20],[7,6,22,14],[8,7,8,27],[9,7,12,17],[10,8,4,6],[11,7,7,3],[12,6,23,48],[1,6,5,18]],
2031:[[2,4,2,58],[3,5,19,53],[4,5,0,20],[5,5,12,31],[6,5,17,8],[7,7,4,1],[8,7,14,15],[9,7,18,6],[10,8,9,55],[11,7,12,52],[12,7,5,36],[1,6,11,6]],
2032:[[2,4,8,48],[3,5,1,46],[4,4,6,14],[5,4,18,24],[6,4,23,0],[7,6,9,53],[8,6,20,7],[9,6,23,59],[10,8,15,49],[11,6,18,48],[12,6,11,33],[1,5,17,5]],
2033:[[2,3,14,33],[3,5,7,29],[4,4,11,58],[5,5,0,10],[6,5,4,48],[7,6,15,43],[8,7,1,57],[9,7,5,47],[10,7,21,37],[11,7,0,34],[12,6,17,18],[1,5,22,47]],
2034:[[2,3,20,27],[3,5,13,22],[4,4,17,49],[5,5,5,59],[6,5,10,36],[7,6,21,30],[8,7,7,44],[9,7,11,37],[10,8,3,27],[11,7,6,26],[12,6,23,12],[1,6,4,42]],
2035:[[2,4,2,15],[3,5,19,10],[4,4,23,38],[5,5,11,49],[6,5,16,27],[7,7,3,22],[8,7,13,36],[9,7,17,27],[10,8,9,16],[11,7,12,13],[12,7,4,58],[1,6,10,27]],
2036:[[2,4,8,2],[3,5,0,58],[4,4,5,26],[5,4,17,36],[6,4,22,14],[7,6,9,8],[8,6,19,22],[9,6,23,14],[10,8,15,3],[11,6,18,2],[12,6,10,47],[1,5,16,19]],
2037:[[2,3,13,52],[3,5,6,48],[4,4,11,16],[5,4,23,27],[6,5,4,4],[7,6,14,58],[8,7,1,12],[9,7,5,5],[10,7,20,55],[11,6,23,54],[12,6,16,39],[1,5,22,11]],
2038:[[2,3,19,40],[3,5,12,34],[4,4,17,2],[5,5,5,13],[6,5,9,51],[7,6,20,46],[8,7,7,1],[9,7,10,54],[10,8,2,44],[11,7,5,43],[12,6,22,28],[1,6,4,0]],
2039:[[2,4,1,32],[3,5,18,27],[4,4,22,55],[5,5,11,6],[6,5,15,44],[7,7,2,39],[8,7,12,54],[9,7,16,47],[10,8,8,37],[11,7,11,36],[12,7,4,21],[1,6,9,52]],
2040:[[2,4,7,18],[3,5,0,14],[4,4,4,42],[5,4,16,52],[6,4,21,30],[7,6,8,24],[8,6,18,39],[9,6,22,33],[10,8,14,22],[11,6,17,22],[12,6,10,8],[1,5,15,42]],
2041:[[2,3,13,4],[3,5,5,59],[4,4,10,28],[5,4,22,40],[6,5,3,20],[7,6,14,15],[8,7,0,30],[9,7,4,22],[10,8,20,11],[11,6,23,9],[12,6,15,53],[1,5,21,24]],
2042:[[2,3,18,52],[3,5,11,47],[4,4,16,14],[5,5,4,25],[6,5,9,2],[7,6,19,55],[8,7,6,10],[9,7,10,4],[10,8,1,54],[11,7,4,53],[12,6,21,39],[1,6,3,11]],
2043:[[2,4,0,41],[3,5,17,35],[4,4,22,2],[5,5,10,12],[6,5,14,50],[7,7,1,44],[8,7,11,59],[9,7,15,54],[10,8,7,44],[11,7,10,44],[12,7,3,30],[1,6,9,1]],
2044:[[2,4,6,27],[3,4,23,22],[4,4,3,49],[5,4,15,59],[6,4,20,37],[7,6,7,32],[8,6,17,47],[9,6,21,42],[10,8,13,32],[11,6,16,32],[12,6,9,18],[1,5,14,51]],
2045:[[2,3,12,17],[3,5,5,11],[4,4,9,37],[5,4,21,47],[6,5,2,23],[7,6,13,16],[8,6,23,31],[9,7,3,26],[10,7,19,16],[11,6,22,17],[12,6,15,3],[1,5,20,37]],
2046:[[2,3,18,7],[3,5,10,59],[4,4,15,25],[5,5,3,34],[6,5,8,11],[7,6,19,5],[8,7,5,21],[9,7,9,17],[10,8,1,7],[11,7,4,7],[12,6,20,53],[1,6,2,27]],
2047:[[2,3,23,53],[3,5,16,45],[4,4,21,12],[5,5,9,21],[6,5,13,58],[7,7,0,52],[8,7,11,8],[9,7,15,5],[10,8,6,56],[11,7,9,57],[12,7,2,44],[1,6,8,17]],
2048:[[2,4,5,37],[3,4,22,32],[4,4,3,0],[5,4,15,11],[6,4,19,49],[7,6,6,44],[8,6,16,59],[9,6,20,55],[10,8,12,44],[11,6,15,44],[12,6,8,30],[1,5,14,3]],
2049:[[2,3,11,27],[3,5,4,22],[4,4,8,49],[5,4,20,59],[6,5,1,37],[7,6,12,31],[8,6,22,46],[9,7,2,43],[10,7,18,33],[11,6,21,33],[12,6,14,20],[1,5,19,54]],
2050:[[2,3,17,17],[3,5,10,10],[4,4,14,36],[5,5,2,45],[6,5,7,21],[7,6,18,14],[8,7,4,29],[9,7,8,26],[10,8,0,17],[11,7,3,18],[12,6,20,5],[1,6,1,39]],
2051:[[2,3,23,3],[3,5,15,58],[4,4,20,24],[5,5,8,35],[6,5,13,13],[7,7,0,7],[8,7,10,22],[9,7,14,17],[10,8,6,7],[11,7,9,6],[12,7,1,52],[1,6,7,24]],
2052:[[2,4,4,48],[3,4,21,43],[4,4,2,11],[5,4,14,22],[6,4,19,0],[7,6,5,54],[8,6,16,9],[9,6,20,5],[10,8,11,55],[11,6,14,54],[12,6,7,40],[1,5,13,13]],
2053:[[2,3,10,38],[3,5,3,33],[4,4,7,59],[5,4,20,9],[6,5,0,47],[7,6,11,41],[8,6,21,57],[9,7,1,54],[10,7,17,44],[11,6,20,44],[12,6,13,30],[1,5,19,4]],
2054:[[2,3,16,27],[3,5,9,21],[4,4,13,47],[5,5,1,57],[6,5,6,35],[7,6,17,29],[8,7,3,44],[9,7,7,42],[10,7,23,33],[11,7,2,33],[12,6,19,20],[1,6,0,54]],
2055:[[2,3,22,15],[3,5,15,8],[4,4,19,33],[5,5,7,43],[6,5,12,21],[7,6,23,15],[8,7,9,31],[9,7,13,30],[10,8,5,21],[11,7,8,22],[12,7,1,9],[1,6,6,44]],
2056:[[2,4,4,1],[3,4,20,54],[4,4,1,20],[5,4,13,30],[6,4,18,8],[7,6,5,2],[8,6,15,18],[9,6,19,17],[10,8,11,8],[11,6,14,9],[12,6,6,56],[1,5,12,32]],
2057:[[2,3,9,51],[3,5,2,44],[4,4,7,9],[5,4,19,18],[6,5,23,55],[7,6,10,49],[8,6,21,5],[9,7,1,4],[10,7,16,55],[11,6,19,57],[12,6,12,45],[1,5,18,21]],
2058:[[2,3,15,39],[3,5,8,31],[4,4,12,55],[5,5,1,4],[6,5,5,41],[7,6,16,35],[8,7,2,52],[9,7,6,52],[10,7,22,44],[11,7,1,47],[12,6,18,35],[1,6,0,12]],
2059:[[2,3,21,27],[3,5,14,18],[4,4,18,42],[5,5,6,51],[6,5,11,28],[7,6,22,22],[8,7,8,39],[9,7,12,40],[10,8,4,32],[11,7,7,36],[12,7,0,25],[1,6,6,2]],
2060:[[2,4,3,13],[3,4,20,5],[4,4,0,29],[5,4,12,37],[6,4,17,14],[7,6,4,8],[8,6,14,25],[9,6,18,26],[10,8,10,18],[11,6,13,22],[12,6,6,11],[1,5,11,49]],
2061:[[2,3,9,2],[3,5,1,53],[4,4,6,17],[5,4,18,24],[6,4,23,0],[7,6,9,53],[8,6,20,10],[9,7,0,12],[10,7,16,4],[11,6,19,9],[12,6,11,59],[1,5,17,38]],
2062:[[2,3,14,50],[3,5,7,40],[4,4,12,3],[5,5,0,11],[6,5,4,47],[7,6,15,40],[8,7,1,57],[9,7,6,0],[10,7,21,53],[11,7,0,58],[12,6,17,48],[1,5,23,28]],
2063:[[2,3,20,37],[3,5,13,27],[4,4,17,49],[5,5,5,57],[6,5,10,33],[7,6,21,26],[8,7,7,44],[9,7,11,48],[10,8,3,41],[11,7,6,48],[12,6,23,38],[1,6,5,18]],
2064:[[2,4,2,23],[3,4,19,13],[4,3,23,35],[5,4,11,43],[6,4,16,19],[7,6,3,13],[8,6,13,30],[9,6,17,34],[10,8,9,26],[11,6,12,33],[12,6,5,24],[1,5,11,5]],
2065:[[2,3,8,12],[3,5,1,1],[4,4,5,23],[5,4,17,30],[6,4,22,5],[7,6,8,58],[8,6,19,15],[9,6,23,20],[10,7,15,13],[11,6,18,21],[12,6,11,12],[1,5,16,54]],
2066:[[2,3,14,0],[3,5,6,48],[4,4,11,10],[5,4,23,17],[6,5,3,52],[7,6,14,45],[8,7,1,2],[9,7,5,8],[10,7,21,2],[11,7,0,11],[12,6,17,2],[1,5,22,44]],
2067:[[2,3,19,47],[3,5,12,35],[4,4,16,56],[5,5,5,3],[6,5,9,38],[7,6,20,31],[8,7,6,49],[9,7,10,56],[10,8,2,50],[11,7,6,0],[12,6,22,52],[1,6,4,34]],
2068:[[2,4,1,32],[3,4,18,21],[4,3,22,42],[5,4,10,48],[6,4,15,23],[7,6,2,16],[8,6,12,33],[9,6,16,40],[10,8,8,33],[11,6,11,43],[12,6,4,35],[1,5,10,19]],
2069:[[2,3,7,21],[3,5,0,8],[4,4,4,29],[5,4,16,35],[6,4,21,9],[7,6,8,2],[8,6,18,19],[9,6,22,26],[10,7,14,20],[11,6,17,30],[12,6,10,22],[1,5,16,7]],
2070:[[2,3,13,8],[3,5,5,55],[4,4,10,15],[5,4,22,21],[6,5,2,55],[7,6,13,48],[8,7,0,5],[9,7,4,14],[10,7,20,9],[11,6,23,20],[12,6,16,13],[1,5,21,57]],
2071:[[2,3,18,55],[3,5,11,41],[4,4,16,1],[5,5,4,7],[6,5,8,41],[7,6,19,34],[8,7,5,52],[9,7,10,2],[10,8,1,57],[11,7,5,10],[12,6,22,2],[1,6,3,47]],
2072:[[2,4,0,40],[3,4,17,27],[4,3,21,47],[5,4,9,53],[6,4,14,27],[7,6,1,20],[8,6,11,37],[9,6,15,47],[10,8,7,42],[11,6,10,54],[12,6,3,47],[1,5,9,33]],
2073:[[2,3,6,29],[3,4,23,15],[4,4,3,34],[5,4,15,40],[6,4,20,13],[7,6,7,6],[8,6,17,23],[9,6,21,33],[10,7,13,28],[11,6,16,40],[12,6,9,34],[1,5,15,20]],
2074:[[2,3,12,16],[3,5,5,2],[4,4,9,21],[5,4,21,26],[6,5,1,59],[7,6,12,52],[8,6,23,9],[9,7,3,20],[10,7,19,16],[11,6,22,29],[12,6,15,22],[1,5,21,9]],
2075:[[2,3,18,3],[3,5,10,48],[4,4,15,7],[5,5,3,12],[6,5,7,45],[7,6,18,38],[8,7,4,56],[9,7,9,8],[10,8,1,4],[11,7,4,19],[12,6,21,12],[1,6,2,59]],
2076:[[2,3,23,49],[3,4,16,34],[4,3,20,52],[5,4,8,58],[6,4,13,31],[7,6,0,24],[8,6,10,41],[9,6,14,53],[10,8,6,49],[11,6,10,3],[12,6,2,57],[1,5,8,46]],
2077:[[2,3,5,37],[3,4,22,22],[4,4,2,40],[5,4,14,45],[6,4,19,17],[7,6,6,10],[8,6,16,27],[9,6,20,39],[10,7,12,35],[11,6,15,50],[12,6,8,44],[1,5,14,34]],
2078:[[2,3,11,25],[3,5,4,9],[4,4,8,26],[5,4,20,31],[6,5,1,3],[7,6,11,55],[8,6,22,13],[9,7,2,26],[10,7,18,23],[11,6,21,39],[12,6,14,34],[1,5,20,23]],
2079:[[2,3,17,12],[3,5,9,56],[4,4,14,13],[5,5,2,17],[6,5,6,49],[7,6,17,42],[8,7,3,59],[9,7,8,13],[10,8,0,10],[11,7,3,28],[12,6,20,22],[1,6,2,12]],
2080:[[2,3,22,58],[3,4,15,42],[4,3,19,58],[5,4,8,3],[6,4,12,35],[7,5,23,28],[8,6,9,45],[9,6,13,59],[10,8,5,55],[11,6,9,12],[12,6,2,7],[1,5,7,58]],
2081:[[2,3,4,46],[3,4,21,30],[4,4,1,46],[5,4,13,50],[6,4,18,22],[7,6,5,15],[8,6,15,32],[9,6,19,45],[10,7,11,42],[11,6,14,58],[12,6,7,54],[1,5,13,46]],
2082:[[2,3,10,34],[3,5,3,17],[4,4,7,33],[5,4,19,37],[6,5,0,8],[7,6,11,1],[8,6,21,18],[9,7,1,32],[10,7,17,30],[11,6,20,47],[12,6,13,43],[1,5,19,35]],
2083:[[2,3,16,21],[3,5,9,3],[4,4,13,19],[5,5,1,23],[6,5,5,54],[7,6,16,47],[8,7,3,5],[9,7,7,20],[10,7,23,18],[11,7,2,37],[12,6,19,33],[1,6,1,25]],
2084:[[2,3,22,7],[3,4,14,50],[4,3,19,5],[5,4,7,9],[6,4,11,40],[7,5,22,33],[8,6,8,50],[9,6,13,5],[10,8,5,3],[11,6,8,22],[12,6,1,18],[1,5,7,11]],
2085:[[2,3,3,55],[3,4,20,38],[4,4,0,53],[5,4,12,56],[6,4,17,26],[7,6,4,19],[8,6,14,36],[9,6,18,51],[10,7,10,49],[11,6,14,8],[12,6,7,4],[1,5,12,59]],
2086:[[2,3,9,43],[3,5,2,25],[4,4,6,40],[5,4,18,43],[6,4,23,13],[7,6,10,5],[8,6,20,22],[9,7,0,37],[10,7,16,36],[11,6,19,56],[12,6,12,53],[1,5,18,48]],
2087:[[2,3,15,30],[3,5,8,11],[4,4,12,26],[5,5,0,29],[6,5,4,59],[7,6,15,51],[8,7,2,9],[9,7,6,25],[10,7,22,24],[11,7,1,45],[12,6,18,42],[1,6,0,37]],
2088:[[2,3,21,16],[3,4,13,58],[4,3,18,12],[5,4,6,15],[6,4,10,45],[7,5,21,38],[8,6,7,55],[9,6,12,10],[10,8,4,9],[11,6,7,29],[12,6,0,26],[1,5,6,22]],
2089:[[2,3,3,4],[3,4,19,46],[4,4,0,0],[5,4,12,3],[6,4,16,32],[7,6,3,24],[8,6,13,41],[9,6,17,57],[10,7,9,56],[11,6,13,17],[12,6,6,14],[1,5,12,10]],
2090:[[2,3,8,52],[3,5,1,33],[4,4,5,46],[5,4,17,49],[6,4,22,18],[7,6,9,11],[8,6,19,28],[9,6,23,44],[10,7,15,43],[11,6,19,5],[12,6,12,3],[1,5,17,59]],
2091:[[2,3,14,39],[3,5,7,20],[4,4,11,34],[5,4,23,36],[6,5,4,5],[7,6,14,57],[8,7,1,14],[9,7,5,31],[10,7,21,31],[11,7,0,54],[12,6,17,52],[1,5,23,48]],
2092:[[2,3,20,25],[3,4,13,6],[4,3,17,19],[5,4,5,22],[6,4,9,51],[7,5,20,43],[8,6,7,0],[9,6,11,17],[10,8,3,16],[11,6,6,38],[12,5,23,36],[1,5,5,34]],
2093:[[2,3,2,13],[3,4,18,54],[4,3,23,7],[5,4,11,10],[6,4,15,38],[7,6,2,30],[8,6,12,47],[9,6,17,3],[10,7,9,3],[11,6,12,25],[12,6,5,23],[1,5,11,21]],
2094:[[2,3,8,1],[3,5,0,41],[4,4,4,53],[5,4,16,56],[6,4,21,24],[7,6,8,16],[8,6,18,33],[9,6,22,50],[10,7,14,50],[11,6,18,14],[12,6,11,12],[1,5,17,10]],
2095:[[2,3,13,48],[3,5,6,28],[4,4,10,40],[5,4,22,42],[6,5,3,10],[7,6,14,2],[8,7,0,19],[9,7,4,37],[10,7,20,38],[11,7,0,3],[12,6,17,1],[1,5,23,0]],
2096:[[2,3,19,34],[3,4,12,14],[4,3,16,26],[5,4,4,29],[6,4,8,57],[7,5,19,49],[8,6,6,5],[9,6,10,23],[10,8,2,23],[11,6,5,46],[12,5,22,45],[1,5,4,45]],
2097:[[2,3,1,23],[3,4,18,2],[4,3,22,14],[5,4,10,16],[6,4,14,43],[7,6,1,35],[8,6,11,52],[9,6,16,9],[10,7,8,9],[11,6,11,33],[12,6,4,32],[1,5,10,32]],
2098:[[2,3,7,10],[3,4,23,49],[4,4,4,1],[5,4,16,3],[6,4,20,30],[7,6,7,22],[8,6,17,39],[9,6,21,56],[10,7,13,57],[11,6,17,22],[12,6,10,21],[1,5,16,21]],
2099:[[2,3,12,57],[3,5,5,36],[4,4,9,47],[5,4,21,49],[6,5,2,16],[7,6,13,8],[8,6,23,25],[9,7,3,43],[10,7,19,44],[11,6,23,10],[12,6,16,9],[1,5,22,10]],
2100:[[2,3,18,44],[3,5,11,23],[4,4,15,34],[5,5,3,36],[6,5,8,3],[7,6,18,55],[8,7,5,11],[9,7,9,30],[10,8,1,31],[11,7,4,58],[12,6,21,57],[1,6,3,58]]
};

// Lunar calendar data (1900-2100) - hex encoded
const LUNAR_DATA=[
// 1900-1909
0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,
// 1910-1919
0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,
// 1920-1929
0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,
// 1930-1939
0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,
// 1940-1949
0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,
// 1950-1959
0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052d0,0x0a9a8,0x0e950,0x06aa0,
// 1960-1969
0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,
// 1970-1979
0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b5a0,0x195a6,
// 1980-1989
0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,
// 1990-1999
0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x055c0,0x0ab60,0x096d5,0x092e0,
// 2000-2009
0x0c960,0x0d954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,
// 2010-2019
0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930,
// 2020-2029
0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0x0ea65,0x0d530,
// 2030-2039
0x05aa0,0x076a3,0x096d0,0x04bd7,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45,
// 2040-2049
0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0,
// 2050-2059
0x14b63,0x09370,0x049f8,0x04970,0x064b0,0x168a6,0x0ea50,0x06b20,0x1a6c4,0x0aae0,
// 2060-2069
0x092e0,0x0d2e3,0x0c960,0x0d557,0x0d4a0,0x0da50,0x05d55,0x056a0,0x0a6d0,0x055d4,
// 2070-2079
0x052d0,0x0a9b8,0x0a950,0x0b4a0,0x0b6a6,0x0ad50,0x055a0,0x0aba4,0x0a5b0,0x052b0,
// 2080-2089
0x0b273,0x06930,0x07337,0x06aa0,0x0ad50,0x14b55,0x04b60,0x0a570,0x054e4,0x0d160,
// 2090-2099
0x0e968,0x0d520,0x0daa0,0x16aa6,0x056d0,0x04ae0,0x0a9d4,0x0a2d0,0x0d150,0x0f252,
// 2100
0x0d520
];
const LUNAR_START = 1900;

// Payment info
const MY_ACCOUNT = "ÏºÄÏù¥Î±ÖÌÅ¨ 100150462483 ÍπÄÎåÄÏù∏";

/* ========================================
   2. Îã§Íµ≠Ïñ¥
   ======================================== */

/* ========================================
   3. Ï†ÑÏó≠ ÏÉÅÌÉú
   ======================================== */
let GENDER = 'm';
let CALENDAR = 'solar';
let SAJU = null;
let GODS = null;
let BIRTH_YEAR = null;
let currentNumbers = [];
let history = [];

/* ========================================
   3-1. Ïπ¥Ïπ¥Ïò§ÌÜ° Í≥µÏú† Í∏∞Îä•
   ======================================== */
// Kakao SDK init (replace with real JS key for production)
// https://developers.kakao.com - register app and get JS key
const KAKAO_KEY = 'YOUR_KAKAO_JAVASCRIPT_KEY'; // TODO: Replace with real key

function initKakao() {
    if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
        try {
            Kakao.init(KAKAO_KEY);
            console.log('Kakao SDK initialized');
        } catch(e) {
            console.log('Kakao init skipped (key not set)');
        }
    }
}

function shareKakao() {
    const shareData = {
        title: 'üîÆ K-MUDANG Pro',
        text: 'Ancient destiny wisdom in a modern app\n\n‚ú® Expert-level Four Pillars Analysis\nüíï Scientific Compatibility Reading\nüçÄ Lottery with historical exclusion',
        url: window.location.href
    };
    
    // 1. Web Share API supported (mobile browser)
    if (navigator.share) {
        navigator.share(shareData)
            .then(() => toast('Shared successfully! üéâ'))
            .catch((err) => {
                if (err.name !== 'AbortError') {
                    copyShareLink();
                }
            });
        return;
    }
    
    // 2. If Kakao SDK initialized
    if (typeof Kakao !== 'undefined' && Kakao.isInitialized()) {
        try {
            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: 'üîÆ K-MUDANG Pro',
                    description: getShareText(),
                    imageUrl: getShareImageUrl(),
                    link: {
                        mobileWebUrl: window.location.href,
                        webUrl: window.location.href
                    }
                },
                buttons: [{
                    title: 'Check Your Fortune',
                    link: {
                        mobileWebUrl: window.location.href,
                        webUrl: window.location.href
                    }
                }]
            });
            return;
        } catch(e) {
            console.error('Kakao share error:', e);
        }
    }
    
    // 3. Fallback: copy link
    copyShareLink();
}

function getShareText() {
    return `Align your cosmic blueprint with fortune through authentic Korean astrology

‚ú® Professional Four Pillars destiny analysis
üé∞ Lottery numbers harmonized with your personal energy
‚òØ Where millennia-old Eastern wisdom meets modern fortune

Discover your destined path üîÆ`;
}

function getShareImageUrl() {
    return 'https://raw.githubusercontent.com/shrmsdl-netizen/k-mudang/main/og-image.png';
}

function shareApp() {
    const shareData = {
        title: 'üîÆ K-MUDANG Pro - Korean Astrology & Fortune',
        text: 'Harness ancient Four Pillars wisdom to align your cosmic energy with destiny-based lottery numbers.',
        url: window.location.href
    };
    
    if (navigator.share) {
        navigator.share(shareData)
            .then(() => toast('Shared successfully! üéâ'))
            .catch(() => copyShareLink());
    } else {
        copyShareLink();
    }
}

function copyShareLink() {
    const text = `üîÆ K-MUDANG Pro - Korean Astrology & Fortune

‚ú® Professional Four Pillars Destiny Analysis
üé∞ Lottery Numbers Aligned with Your Cosmic Energy
‚òØ Where Ancient Eastern Wisdom Meets Modern Fortune

üëâ ${window.location.href}`;

    navigator.clipboard.writeText(text).then(() => {
        toast('üìã Link copied to clipboard!');
    }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        toast('üìã Link copied to clipboard!');
    });
}

/* ========================================
   4. Ï¥àÍ∏∞Ìôî
   ======================================== */
function init() {
    // Kakao SDK init
    initKakao();
    
    const cy = new Date().getFullYear();
    
    // Initialize birthdate selects
    ['birth-year', 'partner-year'].forEach(id => {
        const el = document.getElementById(id);
        if (el) for (let i = cy; i >= 1940; i--) el.innerHTML += `<option value="${i}">${i}</option>`;
    });
    
    ['birth-month', 'partner-month'].forEach(id => {
        const el = document.getElementById(id);
        if (el) for (let i = 1; i <= 12; i++) el.innerHTML += `<option value="${i}">${MONTH_ABBR[i - 1]}</option>`;
    });
    
    ['birth-day', 'partner-day'].forEach(id => {
        const el = document.getElementById(id);
        if (el) for (let i = 1; i <= 31; i++) el.innerHTML += `<option value="${i}">${i}</option>`;
    });
    
    // Time select
    const hourEl = document.getElementById('birth-hour');
    if (hourEl) {
        const hours = ['Â≠êÊôÇ(23:30-01:29)','‰∏ëÊôÇ(01:30-03:29)','ÂØÖÊôÇ(03:30-05:29)','ÂçØÊôÇ(05:30-07:29)',
                       'Ëæ∞ÊôÇ(07:30-09:29)','Â∑≥ÊôÇ(09:30-11:29)','ÂçàÊôÇ(11:30-13:29)','Êú™ÊôÇ(13:30-15:29)',
                       'Áî≥ÊôÇ(15:30-17:29)','ÈÖâÊôÇ(17:30-19:29)','ÊàåÊôÇ(19:30-21:29)','‰∫•ÊôÇ(21:30-23:29)'];
        hours.forEach((t, i) => hourEl.innerHTML += `<option value="${i}">${t}</option>`);
        hourEl.innerHTML += `<option value="-1">Unknown</option>`;
    }
    
    // Update stats
    // Init complete
}

document.addEventListener('DOMContentLoaded', init);

/* ========================================
   5. Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
   ======================================== */
// toast already defined at top - this is a backup
if (typeof toast !== 'function') {
    function toast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }
}

function getBallColor(n) {
    if (n <= 10) return 'y';
    if (n <= 20) return 'b';
    if (n <= 30) return 'r';
    if (n <= 40) return 'g';
    return 'p';
}

function createBall(n, sm = false) {
    return `<div class="ball ${sm ? 'sm' : ''} ${getBallColor(n)}">${n}</div>`;
}

function setGender(g) {
    GENDER = g;
    document.querySelectorAll('[data-gender]').forEach(b => b.classList.toggle('on', b.dataset.gender === g));
}

function setCalendar(c) {
    CALENDAR = c;
    document.querySelectorAll('[data-cal]').forEach(b => b.classList.toggle('on', b.dataset.cal === c));
    const notice = document.getElementById('lunar-notice');
    if (notice) notice.style.display = c === 'lunar' ? 'block' : 'none';
}

function switchTab(name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.top-nav button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-footer').forEach(f => f.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    document.getElementById('footer-' + name)?.classList.add('active');
    event.currentTarget.classList.add('active');
}

function showFortune(type) {
    document.querySelectorAll('#fortune-tabs .sub-tab').forEach(t => t.classList.remove('on'));
    event.currentTarget.classList.add('on');
    renderFortune(type);
}

/* ========================================
   6. Î°úÎòê Î≤àÌò∏ ÏÉùÏÑ±
   ======================================== */
function generateLotto() {
    try {
        const container = document.getElementById('lotto-balls');
        if (!container) { toast('Screen error'); return; }
        
        const btn = event?.currentTarget;
        if (btn) {
            btn.disabled = true;
            btn.textContent = 'üé≤ Drawing...';
        }
        
        let counter = 0;
        const interval = setInterval(() => {
            const temp = Array.from({length: 6}, () => Math.floor(Math.random() * 45) + 1);
            container.innerHTML = temp.map(n => createBall(n)).join('');
            counter++;
            
            if (counter > 15) {
                clearInterval(interval);
                
                let nums, attempts = 0;
                do {
                    const pool = Array.from({length: 45}, (_, i) => i + 1);
                    nums = [];
                    for (let i = 0; i < 6; i++) {
                        const idx = Math.floor(Math.random() * pool.length);
                        nums.push(pool.splice(idx, 1)[0]);
                    }
                    nums.sort((a, b) => a - b);
                    attempts++;
                } while (PAST_SET.has(nums.join(',')) && attempts < 1000);
                
                currentNumbers = nums;
                container.innerHTML = nums.map(n => createBall(n)).join('');
                
                history.unshift(nums);
                if (history.length > 5) history.pop();
                
                document.getElementById('history-card').style.display = 'block';
                document.getElementById('history-list').innerHTML = history.map(h =>
                    `<div class="history-item">${h.map(n => createBall(n, true)).join('')}</div>`
                ).join('');
                
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üé≤ Generate Lucky Numbers';
                }
                
                if (SAJU) showTodayFortune();
            }
        }, 50);
    } catch (error) {
        console.error('Î°úÎòê ÏÉùÏÑ± Ïò§Î•ò:', error);
        toast('Error generating numbers.');
    }
}

function generateSajuLotto() {
    try {
        if (!GODS) { toast('Please analyze your Four Pillars first'); return; }
        
        const container = document.getElementById('saju-lotto-balls');
        if (!container) { toast('Screen error'); return; }
        
        const yongNums = ELEMENT[GODS.yong]?.nums || [];
        const heeNums = ELEMENT[GODS.hee]?.nums || [];
        const giNums = ELEMENT[GODS.gi]?.nums || [];
        
        let weightedPool = [];
        for (let i = 1; i <= 45; i++) {
            let weight = 1;
            if (yongNums.includes(i)) weight = 3;
            else if (heeNums.includes(i)) weight = 2;
            else if (giNums.includes(i)) weight = 0.5;
            for (let j = 0; j < weight * 2; j++) weightedPool.push(i);
        }
        
        let nums = [], attempts = 0;
        do {
            const selected = new Set();
            while (selected.size < 6) {
                const idx = Math.floor(Math.random() * weightedPool.length);
                selected.add(weightedPool[idx]);
            }
            nums = [...selected].sort((a, b) => a - b);
            attempts++;
        } while (PAST_SET.has(nums.join(',')) && attempts < 1000);
        
        currentNumbers = nums;
        container.innerHTML = nums.map(n => createBall(n)).join('');
        
        const yongCount = nums.filter(n => yongNums.includes(n)).length;
        toast(`Beneficial Element (${ELEMENT[GODS.yong].k}) √ó ${yongCount} included!`);
    } catch (error) {
        console.error('ÏÇ¨Ï£º Î°úÎòê ÏÉùÏÑ± Ïò§Î•ò:', error);
        toast('Error generating numbers.');
    }
}

/* ========================================
   7. [Pro] Ï†ïÎ∞Ä ÎßåÏÑ∏Î†• ÏóîÏßÑ - ÏùåÎ†•/ÏãúÏ∞®/Ï†àÍ∏∞ Î≥¥Ï†ï
   ======================================== */

// Lunar calendar data decoding (using LUNAR_DATA)
function getLunarYearDays(year) {
    const idx = year - LUNAR_START;
    if (idx < 0 || idx >= LUNAR_DATA.length) return null;
    const code = LUNAR_DATA[idx];
    
    const leapMonth = code & 0xF; // Leap month (0 if none)
    let totalDays = 0;
    const monthDays = [];
    
    // months 1-12 long/short
    for (let i = 0; i < 12; i++) {
        const bit = (code >> (16 - i)) & 1;
        const days = bit ? 30 : 29;
        monthDays.push(days);
        totalDays += days;
    }
    
    // Leap month
    let leapDays = 0;
    if (leapMonth > 0) {
        leapDays = ((code >> 16) & 1) ? 30 : 29;
        totalDays += leapDays;
    }
    
    return { leapMonth, monthDays, leapDays, totalDays };
}

function lunarToSolar(ly, lm, ld, isLeap = false) {
    if (ly < LUNAR_START || ly > LUNAR_START + LUNAR_DATA.length - 1) {
        return { year: ly, month: lm, day: ld };
    }
    
    // Base date: 1900-01-31 = Lunar 1900-01-01
    let offset = 0;
    
    // Yearly accumulation
    for (let y = LUNAR_START; y < ly; y++) {
        const data = getLunarYearDays(y);
        if (data) offset += data.totalDays;
    }
    
    // Monthly accumulation
    const yearData = getLunarYearDays(ly);
    if (yearData) {
        for (let m = 1; m < lm; m++) {
            offset += yearData.monthDays[m - 1];
            if (yearData.leapMonth === m) {
                offset += yearData.leapDays;
            }
        }
        if (isLeap && yearData.leapMonth === lm) {
            offset += yearData.monthDays[lm - 1];
        }
    }
    
    offset += ld - 1;
    
    // Calculate from base date
    const baseDate = new Date(1900, 0, 31);
    const resultDate = new Date(baseDate.getTime() + offset * 24 * 60 * 60 * 1000);
    
    return {
        year: resultDate.getFullYear(),
        month: resultDate.getMonth() + 1,
        day: resultDate.getDate()
    };
}

function adjustTime(y, m, d, h) {
    if (h < 0) return { y, m, d, h };
    let hour = h;
    // Korea DST correction
    const isDST = ((y >= 1948 && y <= 1951) || (y >= 1955 && y <= 1960) || (y >= 1987 && y <= 1988));
    if (isDST) hour -= 1;
    // True solar time correction (based on KST, about 30 min)
    hour = hour - 0.5;
    if (hour < 0) { hour += 12; d -= 1; }
    if (d < 1) { m -= 1; if (m < 1) { m = 12; y -= 1; } d = 28; }
    return { y, m, d, h: Math.floor(hour) };
}

/* ========================================
   8. [Pro] Ï†ïÎ∞Ä Ï†àÍ∏∞ Í≥ÑÏÇ∞ & ÏÇ¨Ï£º Í∏∞Îë•
   ======================================== */

// Solar term index: 0=Ipchun(Feb), 1=Gyeongchip(Mar)...10=Daeseol(Dec), 11=Sohan(Jan)
// Data format: [month, day, hour, minute]

// Precise solar term calculation (direct data lookup)
function getSolarTermTime(year, termIdx) {
    // Year with data, return directly
    if (SOLAR_TERMS[year] && SOLAR_TERMS[year][termIdx]) {
        const t = SOLAR_TERMS[year][termIdx];
        return { m: t[0], d: t[1], h: t[2], n: t[3] };
    }
    
    // Year without data, use nearest year
    const years = Object.keys(SOLAR_TERMS).map(Number).sort((a, b) => a - b);
    
    // Out of range
    if (year < years[0]) {
        const t = SOLAR_TERMS[years[0]][termIdx];
        return t ? { m: t[0], d: t[1], h: t[2], n: t[3] } : { m: termIdx + 2, d: 5, h: 12, n: 0 };
    }
    if (year > years[years.length - 1]) {
        const t = SOLAR_TERMS[years[years.length - 1]][termIdx];
        return t ? { m: t[0], d: t[1], h: t[2], n: t[3] } : { m: termIdx + 2, d: 5, h: 12, n: 0 };
    }
    
    // Find nearest year
    let closest = years[0];
    let minDiff = Math.abs(year - years[0]);
    for (const y of years) {
        if (Math.abs(year - y) < minDiff) {
            minDiff = Math.abs(year - y);
            closest = y;
        }
    }
    
    const t = SOLAR_TERMS[closest][termIdx];
    return t ? { m: t[0], d: t[1], h: t[2], n: t[3] } : { m: termIdx + 2, d: 5, h: 12, n: 0 };
}

// Date comparison: true if date1 >= date2
function isDateTimeGTE(m1, d1, h1, n1, m2, d2, h2, n2) {
    if (m1 !== m2) return m1 > m2;
    if (d1 !== d2) return d1 > d2;
    if (h1 !== h2) return h1 > h2;
    return n1 >= n2;
}

// Precise year pillar calculation (considers Ipchun time)
function calcYearPillar(y, m, d, h = 12) {
    // Calculate Ipchun time (termIdx = 0)
    const ipchun = getSolarTermTime(y, 0);
    
    // Convert current time to minutes (h is branch index, convert to time)
    // h=0(Â≠êÏãú)=23-01Ïãú, h=1(‰∏ëÏãú)=01-03Ïãú, ..., h=6(ÂçàÏãú)=11-13Ïãú
    const hourMap = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22];
    const currentHour = h >= 0 ? hourMap[h] || 12 : 12;
    const currentMin = 0;
    
    // Previous year if before Ipchun
    let adjY = y;
    if (m < ipchun.m || 
        (m === ipchun.m && d < ipchun.d) ||
        (m === ipchun.m && d === ipchun.d && currentHour < ipchun.h) ||
        (m === ipchun.m && d === ipchun.d && currentHour === ipchun.h && currentMin < ipchun.n)) {
        adjY--;
    }
    
    const si = (adjY - 4) % 10;
    const bi = (adjY - 4) % 12;
    return { s: STEM[si < 0 ? si + 10 : si], b: BRANCH[bi < 0 ? bi + 12 : bi] };
}

// Precise month pillar calculation (considers solar term time)
function calcMonthPillar(y, m, d, h = 12) {
    // Solar term mapping: solar month m term = termIdx m-2
    // Ipchun(Feb)=0, Gyeongchip(Mar)=1, Cheongmyeong(Apr)=2, ...
    // Daeseol(Dec)=10, Sohan(Jan)=11
    
    const hourMap = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22];
    const currentHour = h >= 0 ? hourMap[h] || 12 : 12;
    const currentMin = 0;
    
    // Get solar term time for this month
    let termIdx, checkYear = y;
    
    if (m === 1) {
        // January: Sohan(termIdx=11) based
        // Before Sohan = ÏûêÏõî(Â≠ê), ÏÜåÌïú ÌõÑ = Ï∂ïÏõî(‰∏ë)
        const sohan = getSolarTermTime(y, 11);
        
        let isAfterSohan = false;
        if (d > sohan.d || 
            (d === sohan.d && currentHour > sohan.h) ||
            (d === sohan.d && currentHour === sohan.h && currentMin >= sohan.n)) {
            isAfterSohan = true;
        }
        
        if (!isAfterSohan) {
            // Before Sohan = Zi month (based on previous year stem)
            const prevYearPillar = calcYearPillar(y - 1, 12, 15);
            const ysi = STEM.indexOf(prevYearPillar.s);
            // Zi month = Î™ÖÎ¶¨ÌïôÏ†Å 11Î≤àÏß∏ Îã¨
            const sajuMonth = 11;
            const msi = ((ysi % 5) * 2 + sajuMonth + 1) % 10;
            const mbi = 0; // Â≠ê
            return { s: STEM[msi], b: BRANCH[mbi] };
        } else {
            // After Sohan = Ï∂ïÏõî (Ï†ÑÎÖÑÎèÑ Ïó∞Í∞Ñ Í∏∞Ï§Ä, ÏûÖÏ∂ò Ï†ÑÏù¥ÎØÄÎ°ú)
            const prevYearPillar = calcYearPillar(y - 1, 12, 15);
            const ysi = STEM.indexOf(prevYearPillar.s);
            const sajuMonth = 12; // Chou month
            const msi = ((ysi % 5) * 2 + sajuMonth + 1) % 10;
            const mbi = 1; // ‰∏ë
            return { s: STEM[msi], b: BRANCH[mbi] };
        }
    }
    
    // 2Ïõî~12Ïõî
    termIdx = m - 2; // 2Ïõî=0(ÏûÖÏ∂ò), 3Ïõî=1(Í≤ΩÏπ©), ...
    const term = getSolarTermTime(y, termIdx);
    
    // Determine before/after solar term
    let isAfterTerm = false;
    if (m > term.m || 
        (m === term.m && d > term.d) ||
        (m === term.m && d === term.d && currentHour > term.h) ||
        (m === term.m && d === term.d && currentHour === term.h && currentMin >= term.n)) {
        isAfterTerm = true;
    }
    
    // Calculate Saju month
    // After Ipchun=Yin(1), After Gyeongchip=Mao(2), ...
    // Previous month if before solar term
    let sajuMonth;
    if (isAfterTerm) {
        sajuMonth = m - 1; // Solar Feb after Ipchun = Yin(1)
    } else {
        sajuMonth = m - 2; // Solar Feb before Ipchun = Chou(12)
    }
    
    if (sajuMonth <= 0) sajuMonth += 12;
    
    // Get year stem (ÏõîÏ£º Í≥ÑÏÇ∞ ÏãúÏóêÎäî Ìï¥Îãπ ÏãúÏ†êÏùò Ïó∞Ï£ºÎ•º Ïç®Ïïº Ìï®)
    const yp = calcYearPillar(y, m, d, h);
    const ysi = STEM.indexOf(yp.s);
    
    // Month stem formula: (Ïó∞Í∞Ñ%5)*2 + Ïõî + 1
    // Áî≤Â∑±year=‰∏ôÂØÖ, ‰πôÂ∫öyear=ÊàäÂØÖ...
    const msi = ((ysi % 5) * 2 + sajuMonth + 1) % 10;
    
    // Month branch: Ïù∏Ïõî(1)=ÂØÖ(2), Î¨òÏõî(2)=ÂçØ(3), ...
    const mbi = (sajuMonth + 1) % 12;
    
    return { s: STEM[msi], b: BRANCH[mbi] };
}

// Day pillar calculation - FIXED: 1900-01-01 = Áî≤Êàå(index 10) Î≥¥Ï†ï
function calcDayPillar(y, m, d) {
    // Î∞©Î≤ï 1: Date Í∞ùÏ≤¥ Í∏∞Î∞ò (Í≤ÄÏ¶ùÎêú Î°úÏßÅ)
    const baseDate = new Date(1900, 0, 1);  // 1900ÎÖÑ 1Ïõî 1Ïùº
    const targetDate = new Date(y, m - 1, d);
    
    // UTC/ÏãúÍ∞ÑÎåÄ Ïù¥Ïäà Î∞©ÏßÄ
    baseDate.setHours(12, 0, 0, 0);
    targetDate.setHours(12, 0, 0, 0);
    
    // ÏùºÏàò Ï∞®Ïù¥
    const diffTime = targetDate.getTime() - baseDate.getTime();
    const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
    
    // ‚òÖ‚òÖ‚òÖ ÌïµÏã¨: 1900-01-01ÏùÄ Áî≤ÊàåÏùº(10Î≤àÏß∏)Ïù¥ÎØÄÎ°ú +10 Î≥¥Ï†ï ÌïÑÏàò! ‚òÖ‚òÖ‚òÖ
    let dayIdx = (diffDays + 10) % 60;
    if (dayIdx < 0) dayIdx += 60;
    
    // 60Í∞ëÏûê Ïù∏Îç±Ïä§ ‚Üí Ï≤úÍ∞Ñ(10)/ÏßÄÏßÄ(12) Î∂ÑÎ¶¨
    const stemIdx = dayIdx % 10;
    const branchIdx = dayIdx % 12;
    
    return { s: STEM[stemIdx], b: BRANCH[branchIdx] };
}

// Hour pillar calculation (existing accurate logic)
function calcHourPillar(dayStem, h) {
    if (h < 0) return null;
    const hbi = h;
    const dsi = STEM.indexOf(dayStem);
    const hsi = (dsi * 2 + hbi) % 10;
    return { s: STEM[hsi], b: BRANCH[hbi] };
}

/* ========================================
   9. Hidden Stems/Ïã≠Ïã†/12Ïö¥ÏÑ±/StrongWeak
   ======================================== */

/* ----------------------------------------
   9-1. Complete Hidden Stems Analysis
   ---------------------------------------- */
function analyzeJijanggan(saju) {
    const dm = saju.day.s;
    const dmi = STEM.indexOf(dm);
    const result = { pillars: [], summary: { elements: {wood:0,fire:0,earth:0,metal:0,water:0}, gods: {}, tougans: [] } };
    
    const pillarNames = ['Year Branch', 'Month Branch', 'Day Branch', 'Hour Branch'];
    const branches = [saju.year?.b, saju.month?.b, saju.day?.b, saju.hour?.b];
    const stems = [saju.year?.s, saju.month?.s, saju.day?.s, saju.hour?.s];
    
    branches.forEach((branch, pIdx) => {
        if (!branch) return;
        const bi = BRANCH.findIndex(br => br.c === branch.c);
        const jj = HIDDEN_STEMS[bi];
        
        const pillarInfo = {
            name: pillarNames[pIdx],
            branch: branch,
            hidden: []
        };
        
        jj.forEach((h, hIdx) => {
            const hiddenStem = STEM[h.stem];
            const god = getTenGod(hiddenStem, dm);
            const isJunggi = hIdx === jj.length - 1; // Last is Main
            
            // Stem Emergence (Stem Reveal) Ï≤¥ÌÅ¨ - Hidden StemsÏù¥ Ï≤úÍ∞ÑÏóê ÎÇòÌÉÄÎÇ¨ÎäîÏßÄ
            const tougan = stems.some((s, si) => s && STEM.indexOf(s) === h.stem);
            
            // Root Connection (Root Analysis) Ï≤¥ÌÅ¨ - Ï≤úÍ∞ÑÏù¥ Hidden StemsÏóê ÎøåÎ¶¨Î•º ÎëêÏóàÎäîÏßÄ
            const tonggeun = stems.some((s, si) => {
                if (!s) return false;
                return STEM.indexOf(s) === h.stem;
            });
            
            const hiddenInfo = {
                stem: hiddenStem,
                type: isJunggi ? 'Main' : (hIdx === 0 ? 'Side' : 'Middle'),
                days: h.days,
                god: god,
                tougan: tougan,
                tonggeun: tonggeun,
                strength: isJunggi ? 1.0 : (hIdx === 0 ? 0.3 : 0.5) // Main:1.0, Middle:0.5, Side:0.3
            };
            
            pillarInfo.hidden.push(hiddenInfo);
            
            // Summary count
            result.summary.elements[hiddenStem.e] += hiddenInfo.strength;
            if (!result.summary.gods[god.k]) result.summary.gods[god.k] = 0;
            result.summary.gods[god.k] += hiddenInfo.strength;
            
            // Record emergence
            if (tougan && !result.summary.tougans.find(t => t.stem === h.stem)) {
                result.summary.tougans.push({ 
                    stem: h.stem, 
                    name: hiddenStem.c + hiddenStem.k, 
                    from: pillarNames[pIdx],
                    god: god.k
                });
            }
        });
        
        result.pillars.push(pillarInfo);
    });
    
    return result;
}

/* ----------------------------------------
   9-2. Root/Reveal Analysis
   ---------------------------------------- */
function analyzeTonggeunTougan(saju) {
    const result = { tonggeun: [], tougan: [] };
    const dm = saju.day.s;
    const pillarNames = ['Year', 'Month', 'Day', 'Hour'];
    const branchNames = ['Year Branch', 'Month Branch', 'Day Branch', 'Hour Branch'];
    const branches = [saju.year?.b, saju.month?.b, saju.day?.b, saju.hour?.b];
    const stems = [saju.year?.s, saju.month?.s, saju.day?.s, saju.hour?.s];
    
    // ====== ÌÜµÍ∑º Î∂ÑÏÑù (Í∞ôÏùÄ Ï≤úÍ∞ÑÏùÄ ÌïòÎÇòÎ°ú Ìï©Ïπ®) ======
    const stemRootsMap = {}; // {stemChar: {stem, god, roots[]}}
    const processedStemChars = new Set(); // Ïù¥ÎØ∏ Ï≤òÎ¶¨Ìïú Ï≤úÍ∞Ñ Î¨∏Ïûê
    
    stems.forEach((stem, sIdx) => {
        if (!stem) return;
        const si = STEM.indexOf(stem);
        const stemKey = stem.c; // Í∞ôÏùÄ Ï≤úÍ∞Ñ Î¨∏ÏûêÎ°ú Í∑∏Î£πÌôî
        
        // Ïù¥ÎØ∏ Ï≤òÎ¶¨Ìïú Ï≤úÍ∞ÑÏù¥Î©¥ Ïä§ÌÇµ (Ï§ëÎ≥µ Î∞©ÏßÄ)
        if (processedStemChars.has(stemKey)) return;
        processedStemChars.add(stemKey);
        
        branches.forEach((branch, bIdx) => {
            if (!branch) return;
            const bi = BRANCH.findIndex(br => br.c === branch.c);
            const jj = HIDDEN_STEMS[bi];
            
            jj.forEach((h, hIdx) => {
                if (h.stem === si) {
                    const isJunggi = hIdx === jj.length - 1;
                    const rootInfo = {
                        pillar: branchNames[bIdx],
                        branch: branch.c,
                        type: isJunggi ? 'Main' : (hIdx === 0 ? 'Side' : 'Middle'),
                        strength: isJunggi ? 'Strong' : (hIdx === 0 ? 'Weak' : 'Medium')
                    };
                    
                    if (!stemRootsMap[stemKey]) {
                        stemRootsMap[stemKey] = {
                            stem: stem.c + stem.k,
                            god: sIdx === 2 ? 'Day Master' : getTenGod(stem, dm).k,
                            roots: []
                        };
                    }
                    
                    // Ï§ëÎ≥µ root Ï≤¥ÌÅ¨ (Í∞ôÏùÄ pillar+branch Ï°∞Ìï©)
                    const exists = stemRootsMap[stemKey].roots.some(r => 
                        r.pillar === rootInfo.pillar && r.branch === rootInfo.branch
                    );
                    if (!exists) {
                        stemRootsMap[stemKey].roots.push(rootInfo);
                    }
                }
            });
        });
    });
    
    result.tonggeun = Object.values(stemRootsMap).filter(t => t.roots.length > 0);
    
    // ====== Ìà¨Í∞Ñ Î∂ÑÏÑù (Ï§ëÎ≥µ Ï†úÍ±∞) ======
    const touganSet = new Set();
    branches.forEach((branch, bIdx) => {
        if (!branch) return;
        const bi = BRANCH.findIndex(br => br.c === branch.c);
        const jj = HIDDEN_STEMS[bi];
        
        jj.forEach(h => {
            stems.forEach((stem, sIdx) => {
                if (!stem) return;
                if (STEM.indexOf(stem) === h.stem) {
                    const key = stem.c;
                    if (!touganSet.has(key)) {
                        touganSet.add(key);
                        result.tougan.push({
                            stem: stem.c + stem.k,
                            pillar: pillarNames[sIdx],
                            from: branchNames[bIdx],
                            god: sIdx === 2 ? 'Day Master' : getTenGod(stem, dm).k
                        });
                    }
                }
            });
        });
    });
    
    return result;
}

/* ----------------------------------------
   9-3. Ten Gods Detailed Analysis
   ---------------------------------------- */
function getTenGod(stem, dayStem) {
    const dEl = EL_ORDER.indexOf(dayStem.e);
    const sEl = EL_ORDER.indexOf(stem.e);
    const diff = (sEl - dEl + 5) % 5;
    const samePol = (dayStem.y === stem.y);
    const godKeys = ['bijeon','geupjae','siksin','sanggwan','pyeonjae','jeongjae','pyeongwan','jeonggwan','pyeonin','jeongin'];
    const godMap = { 0: samePol ? 0 : 1, 1: samePol ? 2 : 3, 2: samePol ? 4 : 5, 3: samePol ? 6 : 7, 4: samePol ? 8 : 9 };
    return TEN_GODS[godKeys[godMap[diff]]];
}

function getTwelveState(dayStem, branch) {
    // üî• 12Ïö¥ÏÑ± Í≥ÑÏÇ∞ - v4.12.6 CRITICAL FIX
    // Í∞Å ÏùºÍ∞ÑÏùò Ïû•ÏÉù ÏúÑÏπò (ÏßÄÏßÄ Ïù∏Îç±Ïä§)
    // ÏñëÍ∞Ñ: Áî≤:‰∫•(11), ‰∏ô:ÂØÖ(2), Êàä:ÂØÖ(2), Â∫ö:Â∑≥(5), Â£¨:Áî≥(8)
    // ÏùåÍ∞Ñ: ‰πô:Âçà(6), ‰∏Å:ÈÖâ(9), Â∑±:ÈÖâ(9), Ëæõ:Â≠ê(0), Áô∏:ÂçØ(3)
    const starts = [11, 6, 2, 9, 2, 9, 5, 0, 8, 3];
    const dsi = STEM.indexOf(dayStem);
    const bi = BRANCH.findIndex(br => br.c === branch.c);
    const start = starts[dsi];
    
    // ‚òÖ ÏñëÍ∞Ñ(ÈôΩÂπ≤): ÏàúÌñâ, ÏùåÍ∞Ñ(Èô∞Âπ≤): Ïó≠Ìñâ
    // ÏñëÍ∞Ñ: dsi % 2 === 0 (Áî≤‰∏ôÊàäÂ∫öÂ£¨ = 0,2,4,6,8)
    // ÏùåÍ∞Ñ: dsi % 2 === 1 (‰πô‰∏ÅÂ∑±ËæõÁô∏ = 1,3,5,7,9)
    const isYang = dsi % 2 === 0;
    const idx = isYang ? (bi - start + 12) % 12 : (start - bi + 12) % 12;
    return TWELVE_STATES[idx];
}

/* ========================================
   Sound-Element (Sound Element) Í≥ÑÏÇ∞
   ======================================== */
function calcNapeum(stem, branch) {
    const si = STEM.indexOf(stem);
    const bi = BRANCH.findIndex(br => br.c === branch.c);
    // 60Í∞ëÏûê ÏàúÏÑú Í≥ÑÏÇ∞
    const idx = (si * 6 + Math.floor(bi / 2)) % 30;
    const napeum = NAPEUM[idx];
    return {
        name: napeum.name,
        element: napeum.element,
        elementK: ELEMENT[napeum.element].k,
        desc: napeum.desc
    };
}

/* ========================================
   ÂëΩÂÆÆ(Life Palace) Í≥ÑÏÇ∞
   ======================================== */
function calcMyunggung(monthBranch, hourBranch) {
    // ÂëΩÂÆÆ(Life Palace) = (14 - Month Branch - Hour Branch) % 12
    const mbi = BRANCH.findIndex(br => br.c === monthBranch.c);
    const hbi = BRANCH.findIndex(br => br.c === hourBranch.c);
    const mgIdx = (14 - mbi - hbi + 24) % 12;
    const mgBranch = BRANCH[mgIdx];
    
    // ÂëΩÂÆÆ(Life Palace) interpretations
    const mgDesc = {
        0: {name: 'Â≠ê(Rat) Palace (Â≠êÂÆÆ)', trait: 'Wise and composed. Many secrets, active at night.', career: 'Research, Philosophy, Night industries'},
        1: {name: '‰∏ë(Ox) Palace (‰∏ëÂÆÆ)', trait: 'Diligent with persistence. Talent for accumulating wealth.', career: 'Finance, Real Estate, Agriculture'},
        2: {name: 'ÂØÖ(Tiger) Palace (ÂØÖÂÆÆ)', trait: 'Ambitious and brave. Strong leadership qualities.', career: 'Military, Politics, Sports'},
        3: {name: 'ÂçØ(Rabbit) Palace (ÂçØÂÆÆ)', trait: 'Gentle and artistic. Naturally popular.', career: 'Arts, Design, Service industries'},
        4: {name: 'Ëæ∞(Dragon) Palace (Ëæ∞ÂÆÆ)', trait: 'Unpredictable and mysterious. Big dreams.', career: 'Religion, Philosophy, Entrepreneurship'},
        5: {name: 'Â∑≥(Snake) Palace (Â∑≥ÂÆÆ)', trait: 'Wise and cautious. Keeps secrets well.', career: 'Law, Medicine, Counseling'},
        6: {name: 'Âçà(Horse) Palace (ÂçàÂÆÆ)', trait: 'Passionate and proactive. Values honor.', career: 'Politics, Entertainment, Education'},
        7: {name: 'Êú™(Goat) Palace (Êú™ÂÆÆ)', trait: 'Soft and artistic. Strong service spirit.', career: 'Arts, Religion, Healthcare'},
        8: {name: 'Áî≥(Monkey) Palace (Áî≥ÂÆÆ)', trait: 'Clever and witty. Excellent communication skills.', career: 'Sales, Diplomacy, IT'},
        9: {name: 'ÈÖâ(Rooster) Palace (ÈÖâÂÆÆ)', trait: 'Delicate perfectionist. Exceptional aesthetic sense.', career: 'Finance, Jewelry, Beauty'},
        10: {name: 'Êàå(Dog) Palace (ÊàåÂÆÆ)', trait: 'Loyal and faithful. Strong sense of responsibility.', career: 'Military, Police, Security'},
        11: {name: '‰∫•(Pig) Palace (‰∫•ÂÆÆ)', trait: 'Optimistic with great relationships. Much fortune.', career: 'Trade, Travel, Distribution'}
    };
    
    return {
        branch: mgBranch,
        index: mgIdx,
        ...mgDesc[mgIdx]
    };
}

/* ========================================
   ÌÉúÏõê(ËÉéÂÖÉ) Í≥ÑÏÇ∞
   ======================================== */
function calcTaewon(yearStem, monthStem, monthBranch) {
    // Conception Origin = Month Stem +1, Month Branch +3
    const msi = STEM.indexOf(monthStem);
    const mbi = BRANCH.findIndex(br => br.c === monthBranch.c);
    
    const tStem = STEM[(msi + 1) % 10];
    const tBranch = BRANCH[(mbi + 3) % 12];
    
    // Conception Origin influence on chart
    const napeum = calcNapeum(tStem, tBranch);
    
    return {
        stem: tStem,
        branch: tBranch,
        pillar: tStem.c + tBranch.c,
        napeum: napeum,
        desc: `Energy at conception. ${napeum.name} (${ELEMENT[napeum.element].k}) energy influence at birth.`
    };
}

/* ========================================
   Directional Harmony Analysis
   ======================================== */
function analyzeBanghap(saju) {
    const branches = [];
    if (saju.year) branches.push(BRANCH.findIndex(br => br.c === saju.year.b.c));
    if (saju.month) branches.push(BRANCH.findIndex(br => br.c === saju.month.b.c));
    if (saju.day) branches.push(BRANCH.findIndex(br => br.c === saju.day.b.c));
    if (saju.hour) branches.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    
    // üî• ÏõîÏßÄ Ïù∏Îç±Ïä§ (Ï§Ä Î∞©Ìï© ÌåêÎã®Ïö©) - Gemini Round 10
    const monthBranchIdx = saju.month ? BRANCH.findIndex(br => br.c === saju.month.b.c) : -1;
    
    const results = [];
    
    for (const bh of BANGHAP) {
        const has = bh.branches.map(b => branches.includes(b));
        const count = has.filter(x => x).length;
        
        if (count === 3) {
            // Complete Directional Harmony
            results.push({
                type: 'complete',
                name: bh.name,
                dir: bh.dir,
                element: bh.element,
                elementK: ELEMENT[bh.element].k,
                branches: bh.branches.map(b => BRANCH[b].c).join(''),
                power: 'Strong',
                desc: `${bh.dir} Complete! ${ELEMENT[bh.element].k} energy becomes very strong.`
            });
        } else if (count === 2) {
            // üî• Ï§Ä Î∞©Ìï©(Quasi Bureau) - ÏõîÏßÄ Ìè¨Ìï® Ïãú Îçî Í∞ïÎ†• - Gemini Round 10
            const missing = bh.branches.find((b, i) => !has[i]);
            const hasMonthBranch = has[bh.branches.indexOf(monthBranchIdx)] || bh.branches.some((b, i) => has[i] && b === monthBranchIdx);
            const isQuasi = bh.branches.filter((b, i) => has[i]).includes(monthBranchIdx);
            
            results.push({
                type: isQuasi ? 'quasi' : 'partial',
                name: isQuasi ? bh.name + ' Quasi Bureau' : bh.name + ' Incomplete',
                dir: bh.dir,
                element: bh.element,
                elementK: ELEMENT[bh.element].k,
                branches: bh.branches.filter((b, i) => has[i]).map(b => BRANCH[b].c).join(''),
                missing: BRANCH[missing].c,
                power: isQuasi ? 'Strong' : 'Medium',
                desc: isQuasi 
                    ? `Quasi ${bh.dir}! Month Branch included = ${ELEMENT[bh.element].k} energy is DOMINANT even without third branch.`
                    : `When ${BRANCH[missing].c} arrives, ${bh.dir} direction completes.`
            });
        }
    }
    
    return results;
}

/* ========================================
   Hidden Harmony Analysis
   ======================================== */
function analyzeAmhap(saju) {
    const branches = [];
    const pillars = ['Year Branch', 'Month Branch', 'Day Branch', 'Hour Branch'];
    
    if (saju.year) branches.push({idx: BRANCH.findIndex(br => br.c === saju.year.b.c), name: 'Year Branch', c: saju.year.b.c});
    if (saju.month) branches.push({idx: BRANCH.findIndex(br => br.c === saju.month.b.c), name: 'Month Branch', c: saju.month.b.c});
    if (saju.day) branches.push({idx: BRANCH.findIndex(br => br.c === saju.day.b.c), name: 'Day Branch', c: saju.day.b.c});
    if (saju.hour) branches.push({idx: BRANCH.findIndex(br => br.c === saju.hour.b.c), name: 'Hour Branch', c: saju.hour.b.c});
    
    const results = [];
    
    for (let i = 0; i < branches.length; i++) {
        for (let j = i + 1; j < branches.length; j++) {
            for (const ah of AMHAP) {
                if ((branches[i].idx === ah.a && branches[j].idx === ah.b) ||
                    (branches[i].idx === ah.b && branches[j].idx === ah.a)) {
                    results.push({
                        name: ah.name,
                        positions: `${branches[i].name}(${branches[i].c})‚Üî${branches[j].name}(${branches[j].c})`,
                        desc: ah.desc,
                        meaning: 'A hidden connection not visible on the surface. Represents secret bonds and unseen relationships.'
                    });
                }
            }
        }
    }
    
    return results;
}

/* ========================================
   Empty Void Resolution Analysis
   ======================================== */
function analyzeGongmangHaeso(saju, gongmang) {
    if (!gongmang || !gongmang.affected || gongmang.affected.length === 0) {
        return { hasGongmang: false, results: [] };
    }
    
    const branches = [];
    if (saju.year) branches.push(BRANCH.findIndex(br => br.c === saju.year.b.c));
    if (saju.month) branches.push(BRANCH.findIndex(br => br.c === saju.month.b.c));
    if (saju.day) branches.push(BRANCH.findIndex(br => br.c === saju.day.b.c));
    if (saju.hour) branches.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    
    const results = [];
    
    for (const affected of gongmang.affected) {
        // Find void branches
        const gmBranchIdx = BRANCH.findIndex(b => affected.includes(b.k) || affected.includes(b.c));
        if (gmBranchIdx === -1) continue;
        
        let resolved = false;
        let resolveMethod = '';
        
        // Clash resolution check
        const chungPair = (gmBranchIdx + 6) % 12;
        if (branches.includes(chungPair)) {
            resolved = true;
            resolveMethod = `Resolved by ${BRANCH[chungPair].c} Clash`;
        }
        
        // Trinity resolution check
        const samhapSets = [[0,4,8], [1,5,9], [2,6,10], [3,7,11]];
        for (const set of samhapSets) {
            if (set.includes(gmBranchIdx)) {
                const others = set.filter(s => s !== gmBranchIdx);
                if (others.every(o => branches.includes(o))) {
                    resolved = true;
                    resolveMethod = `Resolved by Trinity (${set.map(s => BRANCH[s].c).join('')})`;
                }
            }
        }
        
        results.push({
            position: affected,
            branch: BRANCH[gmBranchIdx].c,
            resolved: resolved,
            method: resolveMethod,
            effect: resolved ? 
                'Void is resolved ‚Äî this energy functions properly in your chart.' : 
                'Void remains unresolved ‚Äî this energy is weakened. May be activated during favorable Annual or Life Cycles.'
        });
    }
    
    return { hasGongmang: true, results };
}

/* ========================================
   Divine Star Position Analysis
   ======================================== */
function analyzeSinsalPosition(saju) {
    const results = [];
    const positions = [
        {name: 'Year Branch', b: saju.year?.b, meaning: 'Ancestors, Society', age: 'Childhood (0-15)'},
        {name: 'Month Branch', b: saju.month?.b, meaning: 'Parents, Siblings', age: 'Youth (15-30)'},
        {name: 'Day Branch', b: saju.day?.b, meaning: 'Spouse, Self', age: 'Middle age (30-45)'},
        {name: 'Hour Branch', b: saju.hour?.b, meaning: 'Children, Later years', age: 'Later years (45+)'}
    ];
    
    const ybi = BRANCH.findIndex(br => br.c === saju.year?.b?.c);
    
    // Peach Blossom position analysis
    const taohua = {0:9,1:6,2:3,3:0,4:9,5:6,6:3,7:0,8:9,9:6,10:3,11:0};
    for (const pos of positions) {
        if (!pos.b) continue;
        const bi = BRANCH.findIndex(br => br.c === pos.b.c);
        if (bi === taohua[ybi]) {
            results.push({
                sinsal: 'Peach Blossom (Ê°ÉËä±ÊÆ∫)',
                position: pos.name,
                interpretation: pos.name === 'Year Branch' ? 'Popular since childhood. Early romance possible.' :
                               pos.name === 'Month Branch' ? 'Popular during school years. Entertainment star quality.' :
                               pos.name === 'Day Branch' ? 'Attractive spouse. You also radiate charm.' :
                               'Beautiful or popular children. Popular even in later years.',
                advice: pos.name === 'Day Branch' ? 'Be mindful of temptation in your relationship' : 'Use your charm as a strength'
            });
        }
    }
    
    // Traveling Horse position analysis
    const yima = {0:2,1:11,2:8,3:5,4:2,5:11,6:8,7:5,8:2,9:11,10:8,11:5};
    for (const pos of positions) {
        if (!pos.b) continue;
        const bi = BRANCH.findIndex(br => br.c === pos.b.c);
        if (bi === yima[ybi]) {
            results.push({
                sinsal: 'Traveling Horse (È©õÈ¶¨ÊÆ∫)',
                position: pos.name,
                interpretation: pos.name === 'Year Branch' ? 'Ancestors moved frequently or lived away from home.' :
                               pos.name === 'Month Branch' ? 'Moved often in childhood. Study abroad possible.' :
                               pos.name === 'Day Branch' ? 'Frequent travel for work. Spouse is a busy person.' :
                               'Active in later years. Children may live far away.',
                advice: 'Staying still is not good. Stay active!'
            });
        }
    }
    
    // Canopy Star position analysis
    const huagai = {0:4,1:1,2:10,3:7,4:4,5:1,6:10,7:7,8:4,9:1,10:10,11:7};
    for (const pos of positions) {
        if (!pos.b) continue;
        const bi = BRANCH.findIndex(br => br.c === pos.b.c);
        if (bi === huagai[ybi]) {
            results.push({
                sinsal: 'Canopy Star (ËèØËìãÊÆ∫)',
                position: pos.name,
                interpretation: pos.name === 'Year Branch' ? 'Artists or religious figures among ancestors.' :
                               pos.name === 'Month Branch' ? 'Lonely during school years. Interest in art/philosophy.' :
                               pos.name === 'Day Branch' ? 'Spouse is artistic or spiritual. Values inner world.' :
                               'May dive into religion/philosophy in later years. Possible solitude.',
                advice: 'Find comfort in spiritual activities like art, religion, or academics'
            });
        }
    }
    
    return results;
}

/* ========================================
   Life Cycle Transition Analysis
   ======================================== */
function analyzeGyoungi(luck, birthYear, currentYear) {
    const age = currentYear - birthYear + 1;
    const results = [];
    
    for (let i = 0; i < luck.length - 1; i++) {
        const curr = luck[i];
        const next = luck[i + 1];
        
        // Cycle transition timing (Â§ßÈÅã(Life Cycle)Ïù¥ Î∞îÎÄåÍ∏∞ 1ÎÖÑ Ï†ÑÎ∂ÄÌÑ∞ 1ÎÖÑ ÌõÑ)
        const transitionAge = next.startAge;
        const transitionYear = birthYear + transitionAge - 1;
        
        // Check if current age is near transition (¬±2ÎÖÑ)
        if (Math.abs(age - transitionAge) <= 2) {
            // Stems Î≥ÄÌôî
            const stemChange = `${curr.s.c}‚Üí${next.s.c}`;
            const branchChange = `${curr.b.c}‚Üí${next.b.c}`;
            
            // Five Elements Î≥ÄÌôî
            const fromEl = ELEMENT[curr.s.e].k + ELEMENT[curr.b.e].k;
            const toEl = ELEMENT[next.s.e].k + ELEMENT[next.b.e].k;
            
            // Check if drastic change
            let intensity = 'normal';
            let warning = '';
            
            // Dramatic change if elements become destructive
            const elIdx1 = EL_ORDER.indexOf(curr.s.e);
            const elIdx2 = EL_ORDER.indexOf(next.s.e);
            if (Math.abs(elIdx1 - elIdx2) === 2 || Math.abs(elIdx1 - elIdx2) === 3) {
                intensity = 'strong';
                warning = 'Major elemental shift period. Significant life changes may come.';
            }
            
            // From good luck to bad, or vice versa
            if (curr.rating !== next.rating) {
                intensity = 'strong';
                if (curr.rating === 'good' && next.rating === 'bad') {
                    warning += ' Transitioning from good to challenging luck. Prepare in advance.';
                } else if (curr.rating === 'bad' && next.rating === 'good') {
                    warning += ' Difficult luck ends and good luck comes. Have hope!';
                }
            }
            
            results.push({
                transitionAge: transitionAge,
                transitionYear: transitionYear,
                from: `${curr.s.c}${curr.b.c} (${fromEl})`,
                to: `${next.s.c}${next.b.c} (${toEl})`,
                stemChange: stemChange,
                branchChange: branchChange,
                intensity: intensity,
                warning: warning || 'Life Cycle transitions naturally.',
                advice: intensity === 'strong' ? 
                    'This period is a major turning point. Make big decisions carefully!' :
                    'Adapt naturally to the changes ahead.',
                isCurrent: Math.abs(age - transitionAge) <= 1
            });
        }
    }
    
    return results;
}

function calcStrength(saju) {
    const dm = saju.day.s;
    const dme = dm.e;
    const mbi = BRANCH.indexOf(saju.month.b);
    const season = SEASON[mbi];
    let score = 0;
    const factors = [];
    
    // ====== Ïò§Ìñâ Í¥ÄÍ≥Ñ Ï†ïÏùò ======
    const peerEl = dme;  // ÎπÑÍ≤Å (Í∞ôÏùÄ Ïò§Ìñâ)
    const sealEl = EL_ORDER[(EL_ORDER.indexOf(dme) + 4) % 5];  // Ïù∏ÏÑ± (ÎÇòÎ•º ÏÉùÌï®)
    const exprEl = EL_ORDER[(EL_ORDER.indexOf(dme) + 1) % 5];  // ÏãùÏÉÅ (ÎÇ¥Í∞Ä ÏÉùÌï®)
    const wealthEl = EL_ORDER[(EL_ORDER.indexOf(dme) + 2) % 5]; // Ïû¨ÏÑ± (ÎÇ¥Í∞Ä Í∑πÌï®)
    const officerEl = EL_ORDER[(EL_ORDER.indexOf(dme) + 3) % 5]; // Í¥ÄÏÑ± (ÎÇòÎ•º Í∑πÌï®)
    const myEls = [peerEl, sealEl];
    
    // ====== ÏõêÎ≥∏ Î∞©Ïãù ÏßÄÏû•Í∞Ñ ÌÖåÏù¥Î∏î (Ïù∏Îç±Ïä§ Î∞∞Ïó¥) ======
    const jijanggan = {
        0:[9], 1:[9,7,5], 2:[0,2,4], 3:[1], 4:[4,1,9], 5:[2,4,6],
        6:[3,5], 7:[5,3,1], 8:[6,8,4], 9:[7], 10:[4,7,3], 11:[8,0]
    };
    
    // ====== Ï≤úÍ∞Ñ/ÏßÄÏßÄ ÏàòÏßë ======
    const allStems = [saju.year.s, saju.month.s, saju.hour?.s].filter(s => s);
    const allBranches = [saju.year.b, saju.month.b, saju.day.b, saju.hour?.b].filter(b => b);
    
    // ====== 1. Ï≤úÍ∞ÑÌï© Î¨¥Î†•Ìôî Ï≤¥ÌÅ¨ (Ïù∏Ï†ëÏÑ±) ======
    const STEM_COMBINE = [[0,5],[1,6],[2,7],[3,8],[4,9]];
    let disabledSeals = [];
    let disabledPeers = [];
    
    const adjacentPairs = [
        { pos1: 'year', pos2: 'month', s1: saju.year.s, s2: saju.month.s },
        { pos1: 'month', pos2: 'day', s1: saju.month.s, s2: saju.day.s },
        { pos1: 'day', pos2: 'hour', s1: saju.day.s, s2: saju.hour?.s }
    ];
    
    adjacentPairs.forEach(pair => {
        if (!pair.s1 || !pair.s2) return;
        const idx1 = STEM.indexOf(pair.s1);
        const idx2 = STEM.indexOf(pair.s2);
        const isCombine = STEM_COMBINE.some(([a, b]) => 
            (idx1 === a && idx2 === b) || (idx1 === b && idx2 === a)
        );
        if (isCombine) {
            if (pair.pos1 !== 'day') {
                if (pair.s1.e === sealEl) disabledSeals.push(idx1);
                if (pair.s1.e === peerEl) disabledPeers.push(idx1);
            }
            if (pair.pos2 !== 'day') {
                if (pair.s2.e === sealEl) disabledSeals.push(idx2);
                if (pair.s2.e === peerEl) disabledPeers.push(idx2);
            }
            factors.push({ l: 'üîó Â§©Âπ≤Âêà', v: `${pair.s1.c}${pair.s2.c}Âêà (${pair.pos1}-${pair.pos2})`, p: false });
        }
    });
    
    // ====== ‚òÖ‚òÖ‚òÖ 2. ÏõîÎ†πÎìùÎ†π (ÏõêÎ≥∏ Î∞©Ïãù: seasonScore * 4) ‚òÖ‚òÖ‚òÖ ======
    const seasonScore = { 
        spring: {wood:3, fire:2, earth:0, metal:-1, water:-2}, 
        summer: {fire:3, earth:2, metal:0, water:-1, wood:-2}, 
        autumn: {metal:3, water:2, wood:0, fire:-1, earth:-2}, 
        winter: {water:3, wood:2, fire:0, earth:-1, metal:-2} 
    };
    const ms = seasonScore[season][dme];
    const deukRyung = ms >= 2;
    score += ms * 4;  // ‚òÖ ÏõêÎ≥∏ Î∞©Ïãù: *4
    
    const monthNames = ['Â≠ê','‰∏ë','ÂØÖ','ÂçØ','Ëæ∞','Â∑≥','Âçà','Êú™','Áî≥','ÈÖâ','Êàå','‰∫•'];
    factors.push({ l: 'Êúà‰ª§ ÎìùÎ†π', v: `${monthNames[mbi]}Ïõî(${season}) ${deukRyung ? '‚úì ÎãπÎ†π' : '‚úó Ïã§Î†π'} (${ms >= 0 ? '+' : ''}${ms*4})`, p: deukRyung });
    
    // ====== 3. ÏßÄÏßÄ ÌÜµÍ∑º (ÏõêÎ≥∏ Î∞©Ïãù + Í∞ïÌôî) ======
    let roots = 0;
    let hasRealRoot = { day: false, hour: false };
    
    allBranches.forEach((b, idx) => {
        const bi = BRANCH.indexOf(b);
        const position = ['year', 'month', 'day', 'hour'][idx];
        
        // ÏßÄÏßÄ Î≥∏Í∏∞Í∞Ä ÎπÑÍ≤Å/Ïù∏ÏÑ±Ïù¥Î©¥ Í∞ïÌïú ÎøåÎ¶¨
        if (myEls.includes(b.e)) roots += 1.5;
        
        // ÏßÄÏû•Í∞Ñ Ï≤¥ÌÅ¨
        const hidden = jijanggan[bi] || [];
        hidden.forEach((hi, hidx) => {
            const hEl = STEM[hi].e;
            if (myEls.includes(hEl)) {
                roots += (hidx === 0 ? 0.5 : 0.3);  // Ï†ïÍ∏∞ > Ï§ëÍ∏∞/Ïó¨Í∏∞
                if (position === 'day') hasRealRoot.day = true;
                if (position === 'hour') hasRealRoot.hour = true;
            }
        });
    });
    
    const rootStrong = roots >= 3;
    score += Math.min(roots * 1.5, 8);  // ‚òÖ ÏõêÎ≥∏ Î∞©Ïãù
    factors.push({ l: 'ÏßÄÏßÄ ÌÜµÍ∑º', v: rootStrong ? `Í∞ï(${roots.toFixed(1)})` : `ÏïΩ(${roots.toFixed(1)})`, p: rootStrong });
    
    // ====== 4. Ï≤úÍ∞Ñ Ìà¨Ï∂ú (Ìï© Î¨¥Î†•Ìôî Î∞òÏòÅ) ======
    let helps = 0, attacks = 0;
    
    allStems.forEach((st, idx) => {
        const si = STEM.indexOf(st);
        
        // Ìï©ÏúºÎ°ú Î¨¥Î†•ÌôîÎêú Ï≤úÍ∞ÑÏùÄ Ï†úÏô∏
        if (disabledSeals.includes(si) || disabledPeers.includes(si)) {
            return;
        }
        
        if (myEls.includes(st.e)) helps++;
        if (st.e === officerEl) attacks += 1.5;
        if (st.e === wealthEl) attacks += 0.5;
    });
    
    score += helps * 2;
    score -= attacks;
    if (helps >= 1) factors.push({ l: 'Ï≤úÍ∞Ñ Ìà¨Ï∂ú', v: `ÎπÑÍ≤Å/Ïù∏ÏÑ± ${helps}Í∞ú`, p: true });
    
    // ====== 5. Í¥ÄÏÇ¥ ÏïïÎ∞ï ======
    let gwanCount = 0;
    [...allStems, ...allBranches].forEach(p => { if (p.e === officerEl) gwanCount++; });
    if (gwanCount >= 2) { 
        score -= 2; 
        factors.push({ l: 'Í¥ÄÏÇ¥ ÏïïÎ∞ï', v: `${gwanCount}Í∞ú (Ïã†ÏïΩ‚Üì)`, p: false }); 
    }
    
    // ====== 6. Ïû¨ÏÑ± Í≥ºÎã§ ======
    let jaeCount = 0;
    [...allStems, ...allBranches].forEach(p => { if (p.e === wealthEl) jaeCount++; });
    if (jaeCount >= 3) { 
        score -= 2; 
        factors.push({ l: 'Ïû¨ÏÑ± Í≥ºÎã§', v: `${jaeCount}Í∞ú (Ïã†ÏïΩ‚Üì)`, p: false }); 
    }
    
    // ====== ‚òÖ‚òÖ‚òÖ 7. ÏùºÏßÄ 12Ïö¥ÏÑ± (ÏõêÎ≥∏ Î∞©Ïãù Ï∂îÍ∞Ä!) ‚òÖ‚òÖ‚òÖ ======
    const ds = getTwelveState(dm, saju.day.b);
    const dsScore = ds.l >= 8 ? 3 : ds.l >= 6 ? 1 : ds.l >= 4 ? 0 : ds.l >= 2 ? -1 : -2;
    score += dsScore;
    factors.push({ l: 'ÏùºÏßÄ 12Ïö¥', v: `${ds.k}(${dsScore >= 0 ? '+' : ''}${dsScore})`, p: ds.l >= 6 });
    
    // ====== 8. ÎπÑÍ≤Å Í∞úÏàò ======
    let biCount = 0;
    [...allStems, ...allBranches].forEach(p => { if (p.e === dme) biCount++; });
    if (biCount >= 3) { 
        score += 2; 
        factors.push({ l: 'ÎπÑÍ≤Å Îã§Ïàò', v: `${biCount}Í∞ú (Ïã†Í∞ï‚Üë)`, p: true }); 
    }
    
    // ====== 9. Ïù∏ÏÑ± Í∞úÏàò ======
    let inCount = 0;
    [...allStems, ...allBranches].forEach(p => { if (p.e === sealEl) inCount++; });
    if (inCount >= 2) { 
        score += 1.5; 
        factors.push({ l: 'Ïù∏ÏÑ± ÏÉùÎ∂Ä', v: `${inCount}Í∞ú (Ïã†Í∞ï‚Üë)`, p: true }); 
    }
    
    // ====== Ïã†Í∞ï/Ïã†ÏïΩ ÌåêÏ†ï ======
    let type = 'balanced';
    let extreme = null;
    
    if (score >= 15) { type = 'strong'; extreme = 'Extreme Strong'; }
    else if (score >= 8) type = 'strong';
    else if (score >= 3) type = 'balanced';
    else if (score <= -5) { type = 'weak'; extreme = 'Extreme Weak'; }
    else if (score <= 2) type = 'weak';
    
    // Ïã§Ï†ú ÎøåÎ¶¨Í∞Ä ÏûàÏúºÎ©¥ Í∑πÏã†ÏïΩ Î∂àÍ∞Ä
    if ((hasRealRoot.day || hasRealRoot.hour) && extreme === 'Extreme Weak') {
        extreme = null;
        type = 'weak';
        factors.push({ l: '‚ö° ÎøåÎ¶¨ Î≥¥Ï†ï', v: 'Í∑πÏã†ÏïΩ‚ÜíÏã†ÏïΩ', p: true });
    }
    
    // ====== ÌçºÏÑºÌä∏ Î≥ÄÌôò (ÏõêÎ≥∏ Î∞©Ïãù) ======
    let pct = Math.min(100, Math.max(0, (score + 5) * 4));

    return { 
        type, 
        score: Math.round(score * 10) / 10, 
        pct: Math.round(pct), 
        factors, 
        extreme, 
        hourRoot: hasRealRoot.hour,
        dayRoot: hasRealRoot.day,
        disabledSeals,
        disabledPeers
    };
}

/* ========================================
   9-4. Ï°∞ÌõÑ(Ë™øÂÄô) Í≥†Í∏â Ï†ÅÏö©
   ======================================== */

// By month Ï°∞ÌõÑÏö©Ïã†Ìëú - Day MasterÎ≥Ñ Í∞Å ÏõîÏùò Ï°∞ÌõÑÏö©Ïã†
const JOHU_TABLE = {
    // Yang Wood (Áî≤Êú®)
    0: {
        0: {yong:'fire', sub:'wood', desc:'Winter Yang Wood (Áî≤) is frozen; it needs Fire for warmth'},  // Â≠ê(Rat) month
        1: {yong:'fire', sub:'wood', desc:'‰∏ë(Ox) month Earth-dominant season; Fire is needed to dispel the cold'},
        2: {yong:'water', sub:'fire', desc:'ÂØÖ(Tiger) month spring begins, Water nourishes roots'},
        3: {yong:'water', sub:'fire', desc:'ÂçØ(Rabbit) month Wood dominant, Water provides nourishment'},
        4: {yong:'water', sub:'metal', desc:'Ëæ∞(Dragon) month strong Earth; Water provides balance'},
        5: {yong:'water', sub:'metal', desc:'Â∑≥(Snake) month summer begins, with Water prevent dryness'},
        6: {yong:'water', sub:'metal', desc:'Âçà(Horse) month Fire dominant, Water is essential'},
        7: {yong:'water', sub:'metal', desc:'Êú™(Goat) month Earth dominant season, with Water to remove hot dryness'},
        8: {yong:'water', sub:'fire', desc:'Áî≥(Monkey) month strong Metal needs Water release'},
        9: {yong:'water', sub:'fire', desc:'ÈÖâ(Rooster) month Metal at its peak; Water releases the energy'},
        10: {yong:'fire', sub:'water', desc:'Êàå(Dog) month Earth energy, Fire nurtures Wood'},
        11: {yong:'fire', sub:'water', desc:'‰∫•(Pig) month strong Water needs Fire balance'}
    },
    // Yin Wood (‰πôÊú®)
    1: {
        0: {yong:'fire', sub:'water', desc:'Winter Yin Wood (‰πô) is weak warming with Fire'},
        1: {yong:'fire', sub:'water', desc:'‰∏ë(Ox) month cold is strong, Fire essential'},
        2: {yong:'water', sub:'fire', desc:'ÂØÖ(Tiger) month early spring, Water for growth'},
        3: {yong:'fire', sub:'water', desc:'ÂçØ(Rabbit) month Tiger Wood peak, Fire release'},
        4: {yong:'water', sub:'fire', desc:'Ëæ∞(Dragon) month Earth energy, Water nurtures Wood'},
        5: {yong:'water', sub:'metal', desc:'Â∑≥(Snake) month strong Fire needs Water nourishment'},
        6: {yong:'water', sub:'metal', desc:'Âçà(Horse) month hot period Water is essential'},
        7: {yong:'water', sub:'metal', desc:'Êú™(Goat) month hot dry, with Water cooling'},
        8: {yong:'fire', sub:'water', desc:'Áî≥(Monkey) month Metal peak, Fire controls Metal'},
        9: {yong:'fire', sub:'water', desc:'ÈÖâ(Rooster) month Metal peak, Fire protection'},
        10: {yong:'fire', sub:'water', desc:'Êàå(Dog) month Fire stored, warming with Fire'},
        11: {yong:'fire', sub:'wood', desc:'‰∫•(Pig) month Water peak, Fire balance'}
    },
    // Yang Fire (‰∏ôÁÅ´)
    2: {
        0: {yong:'wood', sub:'earth', desc:'Winter Yang Fire (‰∏ô) needs Wood nurturing'},
        1: {yong:'wood', sub:'fire', desc:'‰∏ë(Ox) month cold Earth, Wood nurtures Fire'},
        2: {yong:'water', sub:'metal', desc:'ÂØÖ(Tiger) month Wood creates Fire peak, Water balance'},
        3: {yong:'water', sub:'metal', desc:'ÂçØ(Rabbit) month Wood peak, Water balance'},
        4: {yong:'water', sub:'metal', desc:'Ëæ∞(Dragon) month Earth energy, Water nourishment'},
        5: {yong:'water', sub:'metal', desc:'Â∑≥(Snake) month Fire dominant, Water is essential'},
        6: {yong:'water', sub:'metal', desc:'Âçà(Horse) month sun at peak, with Water cooling down'},
        7: {yong:'water', sub:'metal', desc:'Êú™(Goat) month hot dry, with Water cooling'},
        8: {yong:'wood', sub:'water', desc:'Áî≥(Monkey) month Metal peak, Wood nurtures Fire'},
        9: {yong:'wood', sub:'water', desc:'ÈÖâ(Rooster) month Metal peak, Wood reinforcement'},
        10: {yong:'wood', sub:'water', desc:'Êàå(Dog) month dry Earth, Wood nurtures Fire'},
        11: {yong:'wood', sub:'fire', desc:'‰∫•(Pig) month Water dominant, with Wood bridging'}
    },
    // Yin Fire (‰∏ÅÁÅ´)
    3: {
        0: {yong:'wood', sub:'fire', desc:'Winter Yin Fire (‰∏Å) needs Wood to maintain flame'},
        1: {yong:'wood', sub:'fire', desc:'‰∏ë(Ox) month cold energy, Wood nurtures Fire'},
        2: {yong:'wood', sub:'water', desc:'ÂØÖ(Tiger) month growing Wood, Water balance'},
        3: {yong:'wood', sub:'water', desc:'ÂçØ(Rabbit) month Wood peak, Water balance'},
        4: {yong:'wood', sub:'water', desc:'Ëæ∞(Dragon) month damp Earth, Wood nurtures Fire'},
        5: {yong:'water', sub:'wood', desc:'Â∑≥(Snake) month Fire peak, Water for balance'},
        6: {yong:'water', sub:'wood', desc:'Âçà(Horse) month Fire at peak, Water is essential'},
        7: {yong:'water', sub:'wood', desc:'Êú™(Goat) month hot dry, with Water cooling'},
        8: {yong:'wood', sub:'fire', desc:'Áî≥(Monkey) month strong Metal needs Wood to nurture Fire'},
        9: {yong:'wood', sub:'fire', desc:'ÈÖâ(Rooster) month Metal peak, Wood reinforcement'},
        10: {yong:'wood', sub:'fire', desc:'Êàå(Dog) month Fire energy stored, with Wood to sustain'},
        11: {yong:'wood', sub:'fire', desc:'‰∫•(Pig) month Water controls Fire, with Wood bridging'}
    },
    // Yang Earth (ÊàäÂúü)
    4: {
        0: {yong:'fire', sub:'wood', desc:'Winter Yang Earth (Êàä) needs warming with Fire'},
        1: {yong:'fire', sub:'wood', desc:'‰∏ë(Ox) month cold Earth, Fire warmth'},
        2: {yong:'fire', sub:'wood', desc:'ÂØÖ(Tiger) month Wood controls Earth, Fire bridges'},
        3: {yong:'fire', sub:'metal', desc:'ÂçØ(Rabbit) month Wood peak, Fire controls'},
        4: {yong:'metal', sub:'water', desc:'Ëæ∞(Dragon) month Earth dominant, Metal release'},
        5: {yong:'water', sub:'metal', desc:'Â∑≥(Snake) month Fire peak, Water for balance'},
        6: {yong:'water', sub:'metal', desc:'Âçà(Horse) month dry Earth, Water is essential'},
        7: {yong:'water', sub:'metal', desc:'Êú™(Goat) month Earth dominant season, with Water nourishment'},
        8: {yong:'water', sub:'fire', desc:'Áî≥(Monkey) month strong Metal needs Water balance'},
        9: {yong:'fire', sub:'water', desc:'ÈÖâ(Rooster) month Metal peak, Fire balance'},
        10: {yong:'fire', sub:'water', desc:'Êàå(Dog) month Earth dominant, Fire nurtures Earth'},
        11: {yong:'fire', sub:'wood', desc:'‰∫•(Pig) month Water peak, Fire warmth'}
    },
    // Yin Earth (Â∑±Âúü)
    5: {
        0: {yong:'fire', sub:'wood', desc:'Winter Yin Earth (Â∑±) needs warming with Fire'},
        1: {yong:'fire', sub:'wood', desc:'‰∏ë(Ox) month cold damp Earth, with Fire for warmth'},
        2: {yong:'fire', sub:'water', desc:'ÂØÖ(Tiger) month Wood controls Earth, Fire protects'},
        3: {yong:'fire', sub:'water', desc:'ÂçØ(Rabbit) month Wood dominant, with Fire bridging'},
        4: {yong:'metal', sub:'water', desc:'Ëæ∞(Dragon) month Earth dominant, Metal release'},
        5: {yong:'water', sub:'metal', desc:'Â∑≥(Snake) month dry Earth, with Water nourishment'},
        6: {yong:'water', sub:'metal', desc:'Âçà(Horse) month Fire dominant, Water is essential'},
        7: {yong:'water', sub:'metal', desc:'Êú™(Goat) month Earth dominant season, with Water damp balance'},
        8: {yong:'water', sub:'fire', desc:'Áî≥(Monkey) month Metalenergy, with Water for moisture'},
        9: {yong:'fire', sub:'water', desc:'ÈÖâ(Rooster) month Metal dominant, with Fire for balance'},
        10: {yong:'fire', sub:'water', desc:'Êàå(Dog) month Earth dominant, Fire nurtures Earth'},
        11: {yong:'fire', sub:'wood', desc:'‰∫•(Pig) month Water dominant, with Fire to balance'}
    },
    // Yang Metal (Â∫öÈáë)
    6: {
        0: {yong:'fire', sub:'earth', desc:'Winter Yang Metal (Â∫ö) needs Fire for tempering'},
        1: {yong:'fire', sub:'earth', desc:'‰∏ë(Ox) month: Cold Metal needs Fire to melt'},
        2: {yong:'fire', sub:'water', desc:'ÂØÖ(Tiger) month Wood energy, with Fire protection'},
        3: {yong:'fire', sub:'earth', desc:'ÂçØ(Rabbit) month Wood dominant, with Fire bridging'},
        4: {yong:'water', sub:'fire', desc:'Ëæ∞(Dragon) month Earthenergy, with Water ÏÑ§Metal'},
        5: {yong:'water', sub:'earth', desc:'Â∑≥(Snake) month Fire peak, Water for balance'},
        6: {yong:'water', sub:'earth', desc:'Âçà(Horse) month Fire controls Metal, Water is essential'},
        7: {yong:'water', sub:'earth', desc:'Êú™(Goat) month hot dry, with Water cooling down'},
        8: {yong:'water', sub:'fire', desc:'Áî≥(Monkey) month Metal dominant, with Water to release'},
        9: {yong:'water', sub:'fire', desc:'ÈÖâ(Rooster) month Metal at peak, Water/Fire needed'},
        10: {yong:'fire', sub:'water', desc:'Êàå(Dog) month EarthÏÉùMetal, with Fire for tempering'},
        11: {yong:'fire', sub:'earth', desc:'‰∫•(Pig) month Water peak, Fire warmth'}
    },
    // Yin Metal (ËæõÈáë)
    7: {
        0: {yong:'fire', sub:'earth', desc:'Winter Yin Metal (Ëæõ) needs Fire for warmth'},
        1: {yong:'fire', sub:'earth', desc:'‰∏ë(Ox) month: Cold Metal needs Fire for warmth'},
        2: {yong:'water', sub:'fire', desc:'ÂØÖ(Tiger) month Wood energy, with Water cleansing'},
        3: {yong:'water', sub:'fire', desc:'ÂçØ(Rabbit) month Wood dominant, with Water for moisture'},
        4: {yong:'water', sub:'fire', desc:'Ëæ∞(Dragon) month Earthenergy, with Water for cleansing'},
        5: {yong:'water', sub:'earth', desc:'Â∑≥(Snake) month Fire peak, Water for balance'},
        6: {yong:'water', sub:'earth', desc:'Âçà(Horse) month Fire controls Metal, Water is essential'},
        7: {yong:'water', sub:'earth', desc:'Êú™(Goat) month hot dry, with Water cooling'},
        8: {yong:'water', sub:'fire', desc:'Áî≥(Monkey) month Metal dominant, with Water to release'},
        9: {yong:'water', sub:'fire', desc:'ÈÖâ(Rooster) month Metal at peak, with Water for cleansing'},
        10: {yong:'fire', sub:'water', desc:'Êàå(Dog) month Earthenergy, with Fire to shine'},
        11: {yong:'fire', sub:'earth', desc:'‰∫•(Pig) month Water peak, Fire balance'}
    },
    // Yang Water (Â£¨Ê∞¥)
    8: {
        0: {yong:'fire', sub:'earth', desc:'Winter Yang Water (Â£¨) needs Fire to melt the ice'},
        1: {yong:'fire', sub:'wood', desc:'‰∏ë(Ox) month: Cold Water needs Fire for warmth'},
        2: {yong:'earth', sub:'fire', desc:'ÂØÖ(Tiger) month WaterÏÉùWood, Earth for control'},
        3: {yong:'earth', sub:'fire', desc:'ÂçØ(Rabbit) month Wood energy, with Earth for balance'},
        4: {yong:'metal', sub:'fire', desc:'Ëæ∞(Dragon) month Earthenergy, with Metal generates Water'},
        5: {yong:'metal', sub:'water', desc:'Â∑≥(Snake) month Fire dominant, with Metal generates Water'},
        6: {yong:'metal', sub:'water', desc:'Âçà(Horse) month Fire at peak, Metal/Water needed'},
        7: {yong:'metal', sub:'water', desc:'Êú™(Goat) month Earth dominant, with Metal bridging'},
        8: {yong:'fire', sub:'earth', desc:'Áî≥(Monkey) month Metal generates Water, with Fire to balance'},
        9: {yong:'fire', sub:'earth', desc:'ÈÖâ(Rooster) month Metal dominant, with Fire for balance'},
        10: {yong:'fire', sub:'wood', desc:'Êàå(Dog) month Earthenergy, with Fire for warmth'},
        11: {yong:'fire', sub:'wood', desc:'‰∫•(Pig) month Water dominant, Fire is essential'}
    },
    // Yin Water (Áô∏Ê∞¥)
    9: {
        0: {yong:'fire', sub:'wood', desc:'Winter Yin Water (Áô∏) needs Fire to melt the ice'},
        1: {yong:'fire', sub:'wood', desc:'‰∏ë(Ox) month: Cold Water needs Fire for warmth'},
        2: {yong:'fire', sub:'metal', desc:'ÂØÖ(Tiger) month Wood energy, with Fire to release'},
        3: {yong:'fire', sub:'metal', desc:'ÂçØ(Rabbit) month Wood dominant, with Fire for balance'},
        4: {yong:'fire', sub:'metal', desc:'Ëæ∞(Dragon) month Earth controls Water, with Fire bridging'},
        5: {yong:'metal', sub:'water', desc:'Â∑≥(Snake) month Fire dominant, with Metal generates Water'},
        6: {yong:'metal', sub:'water', desc:'Âçà(Horse) month Fire at peak, Metal/Water needed'},
        7: {yong:'metal', sub:'water', desc:'Êú™(Goat) month Earth dominant, with Metal bridging'},
        8: {yong:'fire', sub:'wood', desc:'Áî≥(Monkey) month Metal generates Water, with Fire to balance'},
        9: {yong:'fire', sub:'wood', desc:'ÈÖâ(Rooster) month Metal dominant, with Fire to release Metal'},
        10: {yong:'fire', sub:'wood', desc:'Êàå(Dog) month Earthenergy, with Fire for warmth'},
        11: {yong:'fire', sub:'metal', desc:'‰∫•(Pig) month Water dominant, Fire is essential'}
    }
};

// Temperature-Humidity Balance ÌåêÎã®
function analyzeClimate(saju) {
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    const season = SEASON[mbi];
    
    let climate = {type: '', desc: '', needs: []};
    
    // Check branch Five Elements
    const brs = [saju.year?.b, saju.month?.b, saju.day?.b, saju.hour?.b].filter(b => b);
    const stems = [saju.year?.s, saju.month?.s, saju.day?.s, saju.hour?.s].filter(s => s);
    let fireCount = 0, waterCount = 0, earthCount = 0;
    brs.forEach(b => {
        if (b.e === 'fire') fireCount++;
        if (b.e === 'water') waterCount++;
        if (b.e === 'earth') earthCount++;
    });
    stems.forEach(s => {
        if (s.e === 'fire') fireCount++;
        if (s.e === 'water') waterCount++;
    });
    
    // v4.12.6: Í≥ÑÏ†àÎ≥Ñ Ï†ïÌôïÌïú Ï°∞ÌõÑ ÌëúÌòÑ (Gemini ÌîºÎìúÎ∞±)
    if (season === 'winter') {
        // Í≤®Ïö∏(‰∫•Â≠ê‰∏ë): Í∑πÌïú(Ê•µÂØí) - ÁÅ´Í∞Ä Ï†àÎåÄÏ†ÅÏúºÎ°ú ÌïÑÏöî
        if (fireCount >= 2) {
            climate.type = 'ÎÇúÎèô(ÊöñÂÜ¨)';
            climate.desc = 'Í≤®Ïö∏ÏÉùÏù¥ÎÇò ÁÅ´Í∞Ä ÌïúÍ∏∞Î•º Ìï¥ÏÜå. Í∑†Ìòï Ïû°Ìûò.';
            climate.needs = [];
        } else if (fireCount === 1) {
            climate.type = 'ÎØ∏Ìïú(ÂæÆÂØí)';
            climate.desc = 'Í≤®Ïö∏ÏÉùÏóê ÏïΩÍ∞ÑÏùò Ïò®Í∏∞. ÁÅ´ Î≥¥Ï∂© Ïãú Îçî Í∏∏Ìï®.';
            climate.needs = ['fire'];
        } else {
            climate.type = waterCount >= 2 ? 'Í∑πÌïú(Ê•µÂØí)' : 'ÌïúÎÉâ(ÂØíÂÜ∑)';
            climate.desc = 'ÌïúÎÉâÌïú ÏÇ¨Ï£º. ÁÅ´Î°ú Ïò®Í∏∞Í∞Ä Ï†àÏã§.';
            climate.needs = ['fire', 'wood'];
        }
    } else if (season === 'summer') {
        // Ïó¨Î¶Ñ(Â∑≥ÂçàÊú™): Ï°∞Ïó¥(Áá•ÁÜ±) - Ê∞¥Í∞Ä Ï†àÎåÄÏ†ÅÏúºÎ°ú ÌïÑÏöî
        if (waterCount >= 2) {
            climate.type = 'ÏñëÌïò(Ê∂ºÂ§è)';
            climate.desc = 'Ïó¨Î¶ÑÏÉùÏù¥ÎÇò Ê∞¥Í∞Ä ÎçîÏúÑÎ•º ÏãùÌûò. Í∑†Ìòï Ïû°Ìûò.';
            climate.needs = [];
        } else if (waterCount === 1) {
            climate.type = 'ÎØ∏Ïó¥(ÂæÆÁÜ±)';
            climate.desc = 'Ïó¨Î¶ÑÏÉùÏóê ÏïΩÍ∞ÑÏùò Ï≤≠Îüâ. Ê∞¥ Î≥¥Ï∂© Ïãú Îçî Í∏∏Ìï®.';
            climate.needs = ['water'];
        } else {
            climate.type = fireCount >= 2 ? 'Ï°∞Ïó¥(Áá•ÁÜ±)' : 'ÏóºÏó¥(ÁÇéÁÜ±)';
            climate.desc = 'Îú®Í≤ÅÍ≥† Í±¥Ï°∞Ìïú ÏÇ¨Ï£º. Ê∞¥Î°ú ÏÑúÎäòÌï®Ïù¥ Ï†àÏã§.';
            climate.needs = ['water', 'metal'];
        }
    } else if (season === 'spring') {
        // Î¥Ñ(ÂØÖÂçØ): ÌïúÏäµ(ÂØíÊøï)ÏóêÏÑú Ïò®Ìôî(Ê∫´Âíå)Î°ú - ÁÅ´Î°ú Îî∞ÎúªÌï® ÌïÑÏöî
        if (fireCount >= 2) {
            climate.type = 'Ïò®Ìôî(Ê∫´Âíå)';
            climate.desc = 'Î¥ÑÏÉùÏóê Ï∂©Î∂ÑÌïú Ïò®Í∏∞. ÎßåÎ¨ºÏù¥ ÏÜåÏÉùÌïòÎäî Ï¢ãÏùÄ Ï°∞Ìï©.';
            climate.needs = [];
        } else if (waterCount >= 2 && fireCount === 0) {
            climate.type = 'ÌïúÏäµ(ÂØíÊøï)';
            climate.desc = 'Î¥ÑÏÉùÏù¥ÎÇò Ê∞¥Í∞Ä ÎßéÏïÑ Ï∞®Í∞ëÍ≥† ÏäµÌï®. ÁÅ´Í∞Ä ÌïÑÏöî.';
            climate.needs = ['fire'];
        } else {
            climate.type = 'Ï≤≠Ìôî(Ê∑∏Âíå)';
            climate.desc = 'Î¥ÑÏùò Ï≤≠Î™ÖÌïú Í∏∞Ïö¥. Ïò®ÌôîÌïú ÏÇ¨Ï£º.';
            climate.needs = fireCount === 0 ? ['fire'] : [];
        }
    } else if (season === 'autumn') {
        // Í∞ÄÏùÑ(Áî≥ÈÖâ): Ï≤≠Îüâ(Ê∑∏Ê∂º)ÏóêÏÑú ÏÑúÎäò(ËÇÖÊÆ∫)Î°ú - ÁÅ´Î°ú Ïò®Í∏∞ ÌïÑÏöî
        if (fireCount >= 2) {
            climate.type = 'Ïò®Ï∂î(Ê∫´Áßã)';
            climate.desc = 'Í∞ÄÏùÑÏÉùÏóê Ï∂©Î∂ÑÌïú Ïò®Í∏∞. Í≤∞Ïã§Ïùò ÌíçÏöîÍ∞Ä Í∏∞ÎåÄÎê®.';
            climate.needs = [];
        } else if (waterCount >= 2 && fireCount === 0) {
            climate.type = 'ÎÉâÏ∂î(ÂÜ∑Áßã)';
            climate.desc = 'Í∞ÄÏùÑÏÉùÏóê Ê∞¥Í∞Ä ÎßéÏïÑ ÏåÄÏåÄÌï®. ÁÅ´Í∞Ä ÌïÑÏöî.';
            climate.needs = ['fire'];
        } else {
            climate.type = 'Ï≤≠Îüâ(Ê∑∏Ê∂º)';
            climate.desc = 'Í∞ÄÏùÑÏùò Ï≤≠ÎüâÌïú Í∏∞Ïö¥. ÏÑ†ÏÑ†Ìïú ÏÇ¨Ï£º.';
            climate.needs = [];
        }
    } else if (mbi === 1 || mbi === 4 || mbi === 7 || mbi === 10) {
        // ÂúüÏõî(‰∏ëËæ∞Êú™Êàå): ÏäµÌÜ†(ÊøïÂúü) ÎòêÎäî Ï°∞ÌÜ†(Áá•Âúü)
        if (earthCount >= 2) {
            const isWetEarth = mbi === 1 || mbi === 4; // ‰∏ëËæ∞ = ÏäµÌÜ†
            climate.type = isWetEarth ? 'ÏäµÌÜ†(ÊøïÂúü)' : 'Ï°∞ÌÜ†(Áá•Âúü)';
            climate.desc = isWetEarth ? 'ÏäµÌïú ÌÜ†Ïùò Í∏∞Ïö¥. ÁÅ´Î°ú Í±¥Ï°∞Ìï® ÌïÑÏöî.' : 'Í±¥Ï°∞Ìïú ÌÜ†Ïùò Í∏∞Ïö¥. Ê∞¥Î°ú Ïú§ÌÉùÌï® ÌïÑÏöî.';
            climate.needs = isWetEarth ? ['fire', 'wood'] : ['water'];
        } else {
            climate.type = 'Ï§ëÌôî(‰∏≠Âíå)';
            climate.desc = 'ÌÜ†ÏõîÏÉùÏùò Ï§ëÌôîÎêú Í∏∞Ïö¥.';
            climate.needs = [];
        }
    } else {
        climate.type = 'Ïò®Ìôî(Ê∫´Âíå)';
        climate.desc = 'Ïò®ÌôîÌïòÍ≥† Í∑†Ìòï Ïû°Ìûå ÏÇ¨Ï£º.';
        climate.needs = [];
    }
    
    return climate;
}

// Finding Disease-Medicine Beneficial Element
function findByungYak(saju, strength) {
    const dm = saju.day.s;
    const dmi = STEM.indexOf(dm);
    const ec = countElements(saju);
    
    let byung = null, yak = null;
    
    // Most common element (illness)
    let maxEl = null, maxCount = 0;
    for (let e of EL_ORDER) {
        if (ec[e] > maxCount && e !== dm.e) {
            maxCount = ec[e];
            maxEl = e;
        }
    }
    
    if (maxCount >= 3) {
        byung = maxEl;
        // Find remedy - element that controls illness
        const kontrolIdx = (EL_ORDER.indexOf(maxEl) + 3) % 5;
        yak = EL_ORDER[kontrolIdx];
    }
    
    return { byung, yak, desc: byung ? `${ELEMENT[byung].k} is excessive - ${ELEMENT[yak].k} controls it` : null };
}

function calcGods(saju, str) {
    const dm = saju.day.s;
    const dmi = STEM.indexOf(dm);
    const mbi = BRANCH.indexOf(saju.month.b);
    const season = SEASON[mbi];
    let yong, hee, gi, johu = null, johuDesc = '';
    let isFollower = false;  // Ï¢ÖÍ≤© Ïó¨Î∂Ä
    let followerType = null; // Ï¢ÖÍ≤© Ï¢ÖÎ•ò
    
    // ====== 0. Í∏∞ÌõÑ Î∂ÑÏÑù (Ï°∞ÌõÑ Ï≤¥ÌÅ¨Î•º ÏúÑÌï¥ Î®ºÏ†Ä Ïã§Ìñâ) ======
    const climate = analyzeClimate(saju);
    // v4.12.6: ÏÉà Ï°∞ÌõÑ ÌÉÄÏûÖÏóê ÎßûÍ≤å ÏàòÏ†ï
    const isTooCold = climate && (climate.type.includes('Í∑πÌïú') || climate.type.includes('ÌïúÎÉâ') || climate.type.includes('ÌïúÏäµ') || climate.type.includes('ÎÉâÏ∂î'));
    const isTooHot = climate && (climate.type.includes('Ï°∞Ïó¥') || climate.type.includes('ÏóºÏó¥'));
    const isTooDamp = climate && (climate.type.includes('ÏäµÌÜ†'));
    
    // ‚òÖ Ïò§Ìñâ Ïπ¥Ïö¥Ìä∏ (Ïù∏ÏÑ± Í≥ºÎã§/Ï¢ÖÍ≤© Ï≤¥ÌÅ¨Ïö©)
    const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
    const sealEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 4) % 5]; // Ïù∏ÏÑ± Ïò§Ìñâ
    const exprEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5]; // ÏãùÏÉÅ Ïò§Ìñâ
    const wealthEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5]; // Ïû¨ÏÑ± Ïò§Ìñâ
    const officerEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 3) % 5]; // Í¥ÄÏÑ± Ïò§Ìñâ
    
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if (p && p.s) elCount[p.s.e]++;
        if (p && p.b) elCount[p.b.e]++;
    });
    
    // ====== 1. Ï¢ÖÍ≤©(Follower) Ï≤¥ÌÅ¨ - v4.12.1 NEW ======
    // Ï°∞Í±¥: 10% ÎØ∏Îßå + ÏùºÏßÄ/ÏãúÏßÄ Î™®Îëê Î¨¥Í∑º
    const noRoot = !str.dayRoot && !str.hourRoot;
    
    if (str.pct < 10 && noRoot) {
        // Í∑πÏã†ÏïΩ + Î¨¥Í∑º = Ï¢ÖÍ≤© Í∞ÄÎä•ÏÑ±
        // ÏùºÍ∞Ñ Ïò§Ìñâ Ï†úÏô∏ÌïòÍ≥† Í∞ÄÏû• Í∞ïÌïú Ïò§Ìñâ
        const dmEl = dm.e;
        let maxEl = null, maxCount = 0;
        Object.entries(elCount).forEach(([el, cnt]) => {
            if (el !== dmEl && cnt > maxCount) {
                maxEl = el;
                maxCount = cnt;
            }
        });
        
        if (maxCount >= 4) {
            // Ìïú Ïò§ÌñâÏù¥ 4Í∞ú Ïù¥ÏÉÅÏù¥Î©¥ Ï¢ÖÍ≤© ÌôïÏ†ï
            isFollower = true;
            
            // Ï¢ÖÍ≤© Ï¢ÖÎ•ò ÌåêÏ†ï
            const relation = getElementRelation(dmEl, maxEl);
            if (relation === 'wealth') {
                followerType = 'Ï¢ÖÏû¨Í≤©';
                yong = maxEl;
                hee = EL_ORDER[(EL_ORDER.indexOf(maxEl) + 1) % 5];
                gi = sealEl;
            } else if (relation === 'officer') {
                followerType = 'Ï¢ÖÏÇ¥Í≤©';
                yong = maxEl;
                hee = EL_ORDER[(EL_ORDER.indexOf(maxEl) + 4) % 5];
                gi = dm.e;
            } else if (relation === 'expression') {
                followerType = 'Ï¢ÖÏïÑÍ≤©';
                yong = maxEl;
                hee = EL_ORDER[(EL_ORDER.indexOf(maxEl) + 1) % 5];
                gi = sealEl;
            } else {
                followerType = 'Ï¢ÖÍ∞ïÍ≤©';
                yong = maxEl;
                hee = EL_ORDER[(EL_ORDER.indexOf(maxEl) + 4) % 5];
                gi = EL_ORDER[(EL_ORDER.indexOf(maxEl) + 3) % 5];
            }
        }
    }
    
    // ====== 2. ÏùºÎ∞ò Í≤©Íµ≠ - Ïã†Í∞ï/Ïã†ÏïΩ Ïö©Ïã† ======
    if (!isFollower) {
        if (str.type === 'strong') { 
            yong = wealthEl;
            hee = exprEl;
            gi = sealEl;
        }
        else if (str.type === 'weak') { 
            yong = sealEl;
            hee = dm.e;
            gi = officerEl;
            
            // ‚òÖ Ìé∏Ïù∏ÌÉúÏôï(ÂÅèÂç∞Â§™Êó∫) Ï≤¥ÌÅ¨ - Ïù∏ÏÑ± Í≥ºÎã§ Ïãú Ïö©Ïã† ÏàòÏ†ï
            if (elCount[sealEl] >= 3) {
                yong = exprEl;
                hee = wealthEl;
                gi = sealEl;
                johuDesc = 'ÂÅèÂç∞Â§™Êó∫ - Excess Seal (3+) suffocates Day Master. Output needed to drain overflow.';
            }
        }
        else { 
            yong = exprEl;
            hee = wealthEl;
            gi = officerEl;
        }
    }
    
    // ====== 3. ‚òÖ‚òÖ‚òÖ Ï°∞ÌõÑ ÏòàÏô∏ Ï≤òÎ¶¨ (v4.12.1 Í∞ïÌôî) ‚òÖ‚òÖ‚òÖ ======
    const johuData = JOHU_TABLE[dmi] && JOHU_TABLE[dmi][mbi];
    
    if (johuData && !isFollower) {
        johu = johuData.yong;
        
        // Ìé∏Ïù∏ÌÉúÏôï ÏÉÅÌÉúÎ©¥ Ï°∞ÌõÑÏö©Ïã†Î≥¥Îã§ Ìé∏Ïù∏ÌÉúÏôï Î°úÏßÅ Ïö∞ÏÑ†
        if (elCount[sealEl] >= 3 && str.type === 'weak') {
            johuDesc = johuDesc || johuData.desc;
        } else {
            johuDesc = johuData.desc;
            
            // ‚òÖ Í∏àÏàòÏÉÅÍ¥ÄÍ≤© ÌäπÏàò Ï≤òÎ¶¨ (ÈáëÊ∞¥ÂÇ∑ÂÆòÂñúË¶ãÂÆò)
            const isMetalDM = dm.e === 'metal';
            const isWinterMonth = [10, 11, 0, 1].includes(mbi);
            const waterCount = [saju.year, saju.month, saju.day, saju.hour].filter(p => 
                p && ((p.s && p.s.e === 'water') || (p.b && p.b.e === 'water'))
            ).length;
            const isGeumsooSanggwan = isMetalDM && isWinterMonth && waterCount >= 2;
            
            // üî• ÌïµÏã¨: Í∑πÌïú Í∏∞ÌõÑ(ÎÑàÎ¨¥ Ï∂•Í±∞ÎÇò/Îú®Í≤ÅÍ±∞ÎÇò/ÏäµÌïòÎ©¥) Ï°∞ÌõÑ ÏµúÏö∞ÏÑ†
            if (isTooCold || isTooHot || isTooDamp) {
                if (johu !== gi) {
                    const prevYong = yong;
                    yong = johu;
                    hee = prevYong;
                    johuDesc += ' (Climate Priority Override)';
                }
            } else if (johu !== gi || isGeumsooSanggwan) {
                // Í∏àÏàòÏÉÅÍ¥ÄÍ≤©Ïù¥Î©¥ Í∏∞Ïã†ÎèÑ Î≥ÄÍ≤Ω
                if (isGeumsooSanggwan && johu === 'fire') {
                    gi = 'earth';
                    johuDesc = 'ÈáëÊ∞¥ÂÇ∑ÂÆòÂñúË¶ãÂÆò - Winter Metal needs Fire. Fire is beneficial.';
                }
                hee = yong;
                yong = johu;
            }
        }
    }
    
    // ====== 4. Î≥ëÏïΩ(ÁóÖËó•) Î∂ÑÏÑù ======
    const byungYak = findByungYak(saju, str);
    
    // ====== 5. Ïö©Ïã† ÌåêÎã® Í∑ºÍ±∞ ÏÉùÏÑ± ======
    const reasoning = [];
    
    if (isFollower) {
        reasoning.push(`„ÄêÏ¢ÖÍ≤©„Äë Ïã†Í∞ï ${str.pct}% (Í∑πÏã†ÏïΩ) + ÏùºÏßÄ/ÏãúÏßÄ Î¨¥Í∑º`);
        reasoning.push(`‚Üí ${followerType}: ${ELEMENT[yong]?.k || yong}Ïù¥ 4Í∞ú Ïù¥ÏÉÅÏúºÎ°ú ÏïïÎèÑÏ†Å`);
        reasoning.push(`‚Üí Ïö©Ïã†: ${ELEMENT[yong]?.k || yong} (ÌùêÎ¶ÑÏùÑ Îî∞Î¶Ñ)`);
    } else {
        // Í∏∞Î≥∏ Ïã†Í∞ï/Ïã†ÏïΩ Í∑ºÍ±∞
        if (str.type === 'strong') {
            reasoning.push(`„ÄêÏã†Í∞ï„Äë Ï†êÏàò ${str.score}Ï†ê (${str.pct}%)`);
            reasoning.push(`‚Üí Í∏∞Î≥∏ Ïö©Ïã†: ${ELEMENT[wealthEl]?.k || wealthEl} (Ïû¨ÏÑ± - ÏùºÍ∞ÑÏùÑ ÏÑ§Í∏∞)`);
        } else if (str.type === 'weak') {
            reasoning.push(`„ÄêÏã†ÏïΩ„Äë Ï†êÏàò ${str.score}Ï†ê (${str.pct}%)`);
            if (elCount[sealEl] >= 3) {
                reasoning.push(`‚Üí Ìé∏Ïù∏ÌÉúÏôï(${elCount[sealEl]}Í∞ú): Ïù∏ÏÑ± Í≥ºÎã§Î°ú ÏùºÍ∞Ñ ÏßàÏãù`);
                reasoning.push(`‚Üí Ïö©Ïã† ÏàòÏ†ï: ${ELEMENT[exprEl]?.k || exprEl} (ÏãùÏÉÅÏúºÎ°ú Ïù∏ÏÑ± ÏÑ§Í∏∞)`);
            } else {
                reasoning.push(`‚Üí Í∏∞Î≥∏ Ïö©Ïã†: ${ELEMENT[sealEl]?.k || sealEl} (Ïù∏ÏÑ± - ÏùºÍ∞ÑÏùÑ ÏÉùÌï®)`);
            }
        } else {
            reasoning.push(`„ÄêÏ§ëÌôî„Äë Ï†êÏàò ${str.score}Ï†ê (${str.pct}%)`);
            reasoning.push(`‚Üí Í∏∞Î≥∏ Ïö©Ïã†: ${ELEMENT[exprEl]?.k || exprEl} (ÏãùÏÉÅ - ÏûêÏó∞Ïä§Îü¨Ïö¥ ÌëúÌòÑ)`);
        }
        
        // Ï°∞ÌõÑ Ï†ÅÏö© Í∑ºÍ±∞
        if (johu && johuData) {
            const johuApplied = yong === johu;
            if (johuApplied) {
                reasoning.push(`„ÄêÏ°∞ÌõÑ„Äë ${johuData.desc}`);
                if (isTooCold || isTooHot || isTooDamp) {
                    reasoning.push(`‚Üí Í∑πÌïú Í∏∞ÌõÑ: Ï°∞ÌõÑ ÏµúÏö∞ÏÑ† Ï†ÅÏö©`);
                } else {
                    reasoning.push(`‚Üí Ï°∞ÌõÑÏö©Ïã† ${ELEMENT[johu]?.k || johu}Ïù¥ Í∏∞Ïã† ÏïÑÎãàÎØÄÎ°ú Ï†ÅÏö©`);
                }
            }
        }
        
        // Í∏àÏàòÏÉÅÍ¥ÄÍ≤©
        const isMetalDM = dm.e === 'metal';
        const isWinterMonth = [10, 11, 0, 1].includes(mbi);
        const waterCount = [saju.year, saju.month, saju.day, saju.hour].filter(p => 
            p && ((p.s && p.s.e === 'water') || (p.b && p.b.e === 'water'))
        ).length;
        if (isMetalDM && isWinterMonth && waterCount >= 2) {
            reasoning.push(`„ÄêÍ∏àÏàòÏÉÅÍ¥ÄÍ≤©„Äë ÈáëÊó•+ÂÜ¨Êúà+Ê∞¥2+: ÁÅ´Í∞Ä Í∏∞Ïã†‚ÜíÌù¨Ïã†ÏúºÎ°ú Î≥ÄÌôò`);
        }
    }
    
    // Î≥ëÏïΩ Í∑ºÍ±∞
    if (byungYak && byungYak.byung) {
        reasoning.push(`„ÄêÎ≥ëÏïΩ„Äë ${byungYak.desc}`);
    }
    
    // ====== v4.12.6 NEW: Ïö©Ïã† ÌååÍ¥¥ Ìå®ÌÑ¥ Í≤ΩÍ≥† ======
    const warnings = [];
    
    // ‚òÖ ÏàòÏ†ï: Ïö©Ïã†Ïù¥ ÏõêÍµ≠Ïóê 1Í∞ú Ïù¥ÏÉÅ ÏûàÏùÑ ÎïåÎßå "Ïö©Ïã† ÌååÍ¥¥" Ï≤¥ÌÅ¨
    // Ïö©Ïã†Ïù¥ 0Í∞úÎ©¥ "Ïö©Ïã†Î∂ÄÏû¨"Î°ú Ï≤òÎ¶¨ (ÏïÑÎûòÏóêÏÑú)
    
    // 1. Í∏àÎã§Î™©Ï†à(ÈáëÂ§öÊú®Êäò) - Èáë 3+ & Ïö©Ïã† Êú® 1+ ‚Üí ÎèÑÎÅºÍ∞Ä ÎÇòÎ¨¥Î•º ÏûêÎ¶Ñ
    if (elCount.metal >= 3 && yong === 'wood' && elCount.wood >= 1 && elCount.wood <= 2) {
        warnings.push({
            type: 'Í∏àÎã§Î™©Ï†à(ÈáëÂ§öÊú®Êäò)',
            desc: 'Èáë 3Í∞ú Ïù¥ÏÉÅÏù¥ Ïö©Ïã† Êú®ÏùÑ Í∑πÌåå ‚Üí Í≥ÑÌöç/ÏÑ±Ïû•Ïù¥ Í∫æÏûÑ',
            severity: 'high',
            advice: 'Èáë Í∏∞Ïö¥ ÌîºÌïòÍ≥† Ê∞¥Î°ú ÌÜµÍ¥Ä ÌïÑÏöî'
        });
        reasoning.push(`‚ö†Ô∏è„ÄêÏö©Ïã†ÌååÍ¥¥„Äë Í∏àÎã§Î™©Ï†à: Èáë${elCount.metal}Í∞úÍ∞Ä Ïö©Ïã† Êú®${elCount.wood}Í∞úÎ•º ÏûêÎ¶Ñ`);
    }
    
    // 2. ÌÜ†Îã§Í∏àÎß§(ÂúüÂ§öÈáëÂüã) - Âúü 4+ & Ïö©Ïã† Èáë 1+ ‚Üí ÌùôÏù¥ Í∏àÏùÑ Î¨ªÏùå
    if (elCount.earth >= 4 && yong === 'metal' && elCount.metal >= 1 && elCount.metal <= 2) {
        warnings.push({
            type: 'ÌÜ†Îã§Í∏àÎß§(ÂúüÂ§öÈáëÂüã)',
            desc: 'Âúü 4Í∞ú Ïù¥ÏÉÅÏù¥ Ïö©Ïã† ÈáëÏùÑ Îß§Î™∞ ‚Üí Ïû¨Îä•Ïù¥ ÎπõÏùÑ Î™ª Î¥Ñ',
            severity: 'high',
            advice: 'Êú®ÏúºÎ°ú ÂúüÎ•º ÏÜåÎ™®ÏãúÌÇ§Í±∞ÎÇò ÈáëÏùÑ Î≥¥Ï∂©'
        });
        reasoning.push(`‚ö†Ô∏è„ÄêÏö©Ïã†ÌååÍ¥¥„Äë ÌÜ†Îã§Í∏àÎß§: Âúü${elCount.earth}Í∞úÍ∞Ä Ïö©Ïã† Èáë${elCount.metal}Í∞úÎ•º Î¨ªÏùå`);
    }
    
    // 3. Î™©Îã§ÌôîÏãù(Êú®Â§öÁÅ´ÁÜÑ) - Êú® 4+ & Ïö©Ïã† ÁÅ´ 1+ ‚Üí Ï†ñÏùÄ ÎÇòÎ¨¥Í∞Ä Î∂àÏùÑ ÎÅî
    if (elCount.wood >= 4 && yong === 'fire' && elCount.fire >= 1 && elCount.fire <= 2) {
        warnings.push({
            type: 'Î™©Îã§ÌôîÏãù(Êú®Â§öÁÅ´ÁÜÑ)',
            desc: 'Êú® 4Í∞ú Ïù¥ÏÉÅÏù¥ Ïö©Ïã† ÁÅ´Î•º ÎçÆÏùå ‚Üí Ïó¥Ï†ïÏù¥ ÏßàÏãù',
            severity: 'medium',
            advice: 'Ï†ÅÏ†àÌïú ÁÅ´ Î≥¥Ï∂© ÌïÑÏöî'
        });
        reasoning.push(`‚ö†Ô∏è„ÄêÏö©Ïã†ÌååÍ¥¥„Äë Î™©Îã§ÌôîÏãù: Êú®${elCount.wood}Í∞úÍ∞Ä Ïö©Ïã† ÁÅ´${elCount.fire}Í∞úÎ•º ÎçÆÏùå`);
    }
    
    // 4. ÏàòÎã§ÌôîÏãù(Ê∞¥Â§öÁÅ´ÁÜÑ) - Ê∞¥ 3+ & ÏùºÍ∞Ñ ÁÅ´ ‚Üí Î¨ºÏù¥ Î∂àÏùÑ ÎÅî
    if (elCount.water >= 3 && dm.e === 'fire') {
        warnings.push({
            type: 'ÏàòÎã§ÌôîÏãù(Ê∞¥Â§öÁÅ´ÁÜÑ)',
            desc: 'Ê∞¥ 3Í∞ú Ïù¥ÏÉÅÏù¥ ÁÅ´ ÏùºÍ∞ÑÏùÑ Í∑πÌï® ‚Üí ÏùòÏßÄ/ÌôúÎ†• Ï†ÄÌïò',
            severity: 'high',
            advice: 'Êú®ÏúºÎ°ú Ê∞¥Î•º Ìù°ÏàòÌïòÍ≥† ÁÅ´Î•º ÏÉùÌï®'
        });
        reasoning.push(`‚ö†Ô∏è„ÄêÏúÑÌóò„Äë ÏàòÎã§ÌôîÏãù: Ê∞¥${elCount.water}Í∞úÍ∞Ä ÁÅ´ÏùºÍ∞ÑÏùÑ ÏúÑÌòë`);
    }
    
    // 5. ÌôîÎã§Í∏àÏÜå(ÁÅ´Â§öÈáëÂ∞ë) - ÁÅ´ 3+ & ÏùºÍ∞Ñ Èáë ‚Üí Î∂àÏù¥ Í∏àÏùÑ ÎÖπÏûÑ
    if (elCount.fire >= 3 && dm.e === 'metal') {
        warnings.push({
            type: 'ÌôîÎã§Í∏àÏÜå(ÁÅ´Â§öÈáëÂ∞ë)',
            desc: 'ÁÅ´ 3Í∞ú Ïù¥ÏÉÅÏù¥ Èáë ÏùºÍ∞ÑÏùÑ Í∑πÌï® ‚Üí ÏïïÎ∞ï/Ïä§Ìä∏Î†àÏä§ Í∑πÏã¨',
            severity: 'high',
            advice: 'ÂúüÎ°ú ÁÅ´Î•º ÏÜåÎ™®ÏãúÌÇ§Í≥† ÈáëÏùÑ ÏÉùÌï®'
        });
        reasoning.push(`‚ö†Ô∏è„ÄêÏúÑÌóò„Äë ÌôîÎã§Í∏àÏÜå: ÁÅ´${elCount.fire}Í∞úÍ∞Ä ÈáëÏùºÍ∞ÑÏùÑ ÎÖπÏûÑ`);
    }
    
    // 6. ÌôîÎã§ÏàòÎπà(ÁÅ´Â§öÊ∞¥Ë≤ß) - ÁÅ´ 3+ & Ïö©Ïã† Ê∞¥ 1+ ‚Üí Î∂àÏù¥ Î¨ºÏùÑ Ï¶ùÎ∞ú
    if (elCount.fire >= 3 && yong === 'water' && elCount.water >= 1 && elCount.water <= 2) {
        warnings.push({
            type: 'ÌôîÎã§ÏàòÎπà(ÁÅ´Â§öÊ∞¥Ë≤ß)',
            desc: 'ÁÅ´ 3Í∞ú Ïù¥ÏÉÅÏù¥ Ïö©Ïã† Ê∞¥Î•º Ï¶ùÎ∞ú ‚Üí ÏßÄÌòú/Ïû¨Î¨º Í≥†Í∞à',
            severity: 'high',
            advice: 'ÈáëÏúºÎ°ú ÁÅ´Î•º Ï†úÏñ¥ÌïòÍ≥† Ê∞¥Î•º ÏÉùÌï®'
        });
        reasoning.push(`‚ö†Ô∏è„ÄêÏö©Ïã†ÌååÍ¥¥„Äë ÌôîÎã§ÏàòÎπà: ÁÅ´${elCount.fire}Í∞úÍ∞Ä Ïö©Ïã† Ê∞¥${elCount.water}Í∞úÎ•º Ï¶ùÎ∞ú`);
    }
    
    // 7. Íµ∞ÎπÑÏüÅÏû¨(Áæ§ÊØîÁà≠Ë≤°) - ÎπÑÍ≤Å 4+ & Ïû¨ÏÑ± 1-2 ‚Üí ÌòïÏ†úÍ∞Ä Ïû¨Î¨º Îã§Ìàº
    const biCount = [...[saju.year, saju.month, saju.day, saju.hour].filter(p => p)]
        .filter(p => (p.s && p.s.e === dm.e) || (p.b && p.b.e === dm.e)).length;
    if (biCount >= 4 && elCount[wealthEl] >= 1 && elCount[wealthEl] <= 2) {
        warnings.push({
            type: 'Íµ∞ÎπÑÏüÅÏû¨(Áæ§ÊØîÁà≠Ë≤°)',
            desc: `ÎπÑÍ≤Å ${biCount}Í∞úÍ∞Ä Ïû¨ÏÑ± ${elCount[wealthEl]}Í∞úÎ•º Îã§Ìàº ‚Üí Ïû¨Î¨º ÏÜêÏã§/Í≤ΩÏüÅ Í≥ºÎã§`,
            severity: 'medium',
            advice: 'ÂÆòÊÆ∫Î°ú ÎπÑÍ≤Å Ï†úÏñ¥ ÎòêÎäî ÏãùÏÉÅÏúºÎ°ú ÏÑ§Í∏∞'
        });
        reasoning.push(`‚ö†Ô∏è„ÄêÌäπÏàò„Äë Íµ∞ÎπÑÏüÅÏû¨: ÎπÑÍ≤Å${biCount}Í∞ú vs Ïû¨ÏÑ±${elCount[wealthEl]}Í∞ú`);
    }
    
    // 8. Ïö©Ïã†Î∂ÄÏû¨ - Ïö©Ïã†Ïù¥ ÏõêÍµ≠Ïóê ÏóÜÏùå
    if (elCount[yong] === 0) {
        warnings.push({
            type: 'Ïö©Ïã†Î∂ÄÏû¨(Áî®Á•û‰∏çÂú®)',
            desc: `Ïö©Ïã† ${ELEMENT[yong].k}Ïù¥ ÏõêÍµ≠Ïóê ÏóÜÏùå ‚Üí ÎåÄÏö¥ÏóêÏÑú Î≥¥Ï∂© ÌïÑÏàò`,
            severity: 'medium',
            advice: 'ÎåÄÏö¥/ÏÑ∏Ïö¥ÏóêÏÑú Ïö©Ïã†Ïù¥ Ïò¨ ÎïåÍ∞Ä Í∏∞Ìöå'
        });
        reasoning.push(`‚ö†Ô∏è„ÄêÏ£ºÏùò„Äë Ïö©Ïã†Î∂ÄÏû¨: ${ELEMENT[yong].k}Ïù¥ ÏõêÍµ≠Ïóê ÏóÜÏùå, ÎåÄÏö¥ ÏùòÏ°¥`);
    }
    
    // 9. Í∏àÎã§Î™©Í∑π(ÈáëÂ§öÊú®Ââã) - Èáë 4+ & ÏùºÍ∞Ñ Êú® ‚Üí ÏùºÍ∞ÑÏù¥ Í∑πÎ∞õÏùå (Ïö©Ïã† Î¨¥Í¥Ä)
    if (elCount.metal >= 4 && dm.e === 'wood') {
        warnings.push({
            type: 'Í∏àÎã§Î™©Í∑π(ÈáëÂ§öÊú®Ââã)',
            desc: 'Èáë 4Í∞ú Ïù¥ÏÉÅÏù¥ Êú® ÏùºÍ∞ÑÏùÑ Í∑πÌï® ‚Üí ÏïïÎ∞ï/Í±¥Í∞ï(Í∞ÑÎã¥) Ï£ºÏùò',
            severity: 'high',
            advice: 'ÁÅ´Î°ú ÈáëÏùÑ Ï†úÏñ¥ÌïòÍ±∞ÎÇò Ê∞¥Î°ú ÌÜµÍ¥Ä'
        });
        reasoning.push(`‚ö†Ô∏è„ÄêÏùºÍ∞ÑÍ∑πÌåå„Äë Í∏àÎã§Î™©Í∑π: Èáë${elCount.metal}Í∞úÍ∞Ä Êú®ÏùºÍ∞ÑÏùÑ Í∑πÌï®`);
    }
    
    // 10. Î™©Îã§ÌÜ†Í∑π(Êú®Â§öÂúüÂâã) - Êú® 4+ & ÏùºÍ∞Ñ Âúü ‚Üí ÏùºÍ∞ÑÏù¥ Í∑πÎ∞õÏùå
    if (elCount.wood >= 4 && dm.e === 'earth') {
        warnings.push({
            type: 'Î™©Îã§ÌÜ†Í∑π(Êú®Â§öÂúüÂâã)',
            desc: 'Êú® 4Í∞ú Ïù¥ÏÉÅÏù¥ Âúü ÏùºÍ∞ÑÏùÑ Í∑πÌï® ‚Üí ÏúÑÏû•/ÏÜåÌôîÍ∏∞ Ï£ºÏùò',
            severity: 'high',
            advice: 'ÁÅ´Î°ú ÌÜµÍ¥Ä ÎòêÎäî ÈáëÏúºÎ°ú Êú® Ï†úÏñ¥'
        });
        reasoning.push(`‚ö†Ô∏è„ÄêÏùºÍ∞ÑÍ∑πÌåå„Äë Î™©Îã§ÌÜ†Í∑π: Êú®${elCount.wood}Í∞úÍ∞Ä ÂúüÏùºÍ∞ÑÏùÑ Í∑πÌï®`);
    }
    
    // 11. ÌÜ†Îã§ÏàòÍ∑π(ÂúüÂ§öÊ∞¥Ââã) - Âúü 4+ & ÏùºÍ∞Ñ Ê∞¥ ‚Üí ÏùºÍ∞ÑÏù¥ Í∑πÎ∞õÏùå
    if (elCount.earth >= 4 && dm.e === 'water') {
        warnings.push({
            type: 'ÌÜ†Îã§ÏàòÍ∑π(ÂúüÂ§öÊ∞¥Ââã)',
            desc: 'Âúü 4Í∞ú Ïù¥ÏÉÅÏù¥ Ê∞¥ ÏùºÍ∞ÑÏùÑ Í∑πÌï® ‚Üí Ïã†Ïû•/ÎπÑÎá®Í∏∞ Ï£ºÏùò',
            severity: 'high',
            advice: 'ÈáëÏúºÎ°ú ÌÜµÍ¥Ä ÎòêÎäî Êú®ÏúºÎ°ú Âúü Ï†úÏñ¥'
        });
        reasoning.push(`‚ö†Ô∏è„ÄêÏùºÍ∞ÑÍ∑πÌåå„Äë ÌÜ†Îã§ÏàòÍ∑π: Âúü${elCount.earth}Í∞úÍ∞Ä Ê∞¥ÏùºÍ∞ÑÏùÑ Í∑πÌï®`);
    }
    
    return { 
        yong, hee, gi, 
        type: str.type, 
        johu, johuDesc,
        climate,
        byungYak,
        sub: johuData?.sub || null,
        isFollower,
        followerType,
        sealExcess: elCount[sealEl] >= 3,
        warnings,  // ‚òÖ v4.12.6 Ïö©Ïã† ÌååÍ¥¥ Ìå®ÌÑ¥
        reasoning  // ‚òÖ Ïö©Ïã† ÌåêÎã® Í∑ºÍ±∞ Ï∂îÍ∞Ä
    };
}

// Ïò§Ìñâ Í¥ÄÍ≥Ñ ÌåêÏ†ï Ìó¨Ìçº (Ï¢ÖÍ≤©Ïö©)
function getElementRelation(dmEl, targetEl) {
    const idx = EL_ORDER.indexOf(dmEl);
    const tgtIdx = EL_ORDER.indexOf(targetEl);
    const diff = (tgtIdx - idx + 5) % 5;
    
    if (diff === 1) return 'expression';
    if (diff === 2) return 'wealth';
    if (diff === 3) return 'officer';
    if (diff === 4) return 'seal';
    return 'peer';
}

/* ========================================
   9-4-2. ÌÜµÌï© Î∂ÑÏÑù ÌååÏù¥ÌîÑÎùºÏù∏ (fullAnalysis)
   v4.12.3 NEW - Î™®Îì† Î∂ÑÏÑùÏùÑ ÌïòÎÇòÎ°ú ÌÜµÌï©
   ======================================== */

function fullAnalysis(saju) {
    const result = {
        // Í∏∞Î≥∏ Ï†ïÎ≥¥
        dayMaster: saju.day.s,
        monthBranch: saju.month.b,
        
        // 1Îã®Í≥Ñ: ÏÇºÌï©/Î∞©Ìï© Î∂ÑÏÑù
        combinations: null,
        
        // 2Îã®Í≥Ñ: Ï≤úÍ∞ÑÌï© Î∂ÑÏÑù
        stemCombines: null,
        
        // 3Îã®Í≥Ñ: Ïã†Í∞ï/Ïã†ÏïΩ Î∂ÑÏÑù
        strength: null,
        
        // 4Îã®Í≥Ñ: ÌïúÎÇúÏ°∞Ïäµ Î∂ÑÏÑù
        climate: null,
        
        // 5Îã®Í≥Ñ: Ïö©Ïã† Î∂ÑÏÑù
        gods: null,
        
        // ÏµúÏ¢Ö ÏöîÏïΩ
        summary: null
    };
    
    // ====== 1. ÏÇºÌï©/Î∞©Ìï© Î∂ÑÏÑù ======
    const branches = [saju.year.b, saju.month.b, saju.day.b, saju.hour?.b].filter(b => b);
    const branchIdxs = branches.map(b => BRANCH.indexOf(b));
    
    // ÏÇºÌï© (Harmony of Three)
    const SAMHAP = [
        {branches: [8, 0, 4], result: 'water', name: 'Áî≥Â≠êËæ∞ Ê∞¥Â±Ä'},
        {branches: [2, 6, 10], result: 'fire', name: 'ÂØÖÂçàÊàå ÁÅ´Â±Ä'},
        {branches: [11, 3, 7], result: 'wood', name: '‰∫•ÂçØÊú™ Êú®Â±Ä'},
        {branches: [5, 9, 1], result: 'metal', name: 'Â∑≥ÈÖâ‰∏ë ÈáëÂ±Ä'}
    ];
    
    // Î∞©Ìï© (Directional Harmony)
    const BANGHAP = [
        {branches: [2, 3, 4], result: 'wood', name: 'ÂØÖÂçØËæ∞ Êù±ÊñπÊú®'},
        {branches: [5, 6, 7], result: 'fire', name: 'Â∑≥ÂçàÊú™ ÂçóÊñπÁÅ´'},
        {branches: [8, 9, 10], result: 'metal', name: 'Áî≥ÈÖâÊàå Ë•øÊñπÈáë'},
        {branches: [11, 0, 1], result: 'water', name: '‰∫•Â≠ê‰∏ë ÂåóÊñπÊ∞¥'}
    ];
    
    const foundCombos = [];
    
    SAMHAP.forEach(sh => {
        const count = sh.branches.filter(b => branchIdxs.includes(b)).length;
        if (count >= 2) {
            foundCombos.push({
                type: count === 3 ? 'ÏÇºÌï©' : 'Î∞òÌï©',
                name: sh.name,
                result: sh.result,
                count
            });
        }
    });
    
    BANGHAP.forEach(bh => {
        const count = bh.branches.filter(b => branchIdxs.includes(b)).length;
        if (count >= 2) {
            foundCombos.push({
                type: count === 3 ? 'Î∞©Ìï©' : 'Î∞©Ìï©(2)',
                name: bh.name,
                result: bh.result,
                count
            });
        }
    });
    
    result.combinations = foundCombos;
    
    // ====== 2. Ï≤úÍ∞ÑÌï© Î∂ÑÏÑù (Ïù∏Ï†ëÏÑ± + Ìï©Ìôî ÏÑ±Î¶Ω Ï°∞Í±¥) ======
    // v4.12.6: "Î†àÍ≥†‚ÜíÏöîÎ¶¨" ÌïµÏã¨ - Í≥ÑÏ†àÏóê Îî∞Î•∏ Ìï©Ìôî ÏÑ±Î¶Ω Ïó¨Î∂Ä
    const STEM_COMBINE_RESULT = {
        '0-5': {result: 'earth', name: 'Áî≤Â∑±ÂêàÂúü', seasonBranches: [1,4,7,10]},  // ‰∏ëËæ∞Êú™Êàå(ÌÜ†Ïõî)
        '1-6': {result: 'metal', name: '‰πôÂ∫öÂêàÈáë', seasonBranches: [8,9]},       // Áî≥ÈÖâ(Í∏àÏõî)
        '2-7': {result: 'water', name: '‰∏ôËæõÂêàÊ∞¥', seasonBranches: [0,11]},      // Â≠ê‰∫•(ÏàòÏõî)
        '3-8': {result: 'wood', name: '‰∏ÅÂ£¨ÂêàÊú®', seasonBranches: [2,3]},        // ÂØÖÂçØ(Î™©Ïõî)
        '4-9': {result: 'fire', name: 'ÊàäÁô∏ÂêàÁÅ´', seasonBranches: [5,6]}         // Â∑≥Âçà(ÌôîÏõî)
    };
    
    const stemCombines = [];
    const positions = ['year', 'month', 'day', 'hour'];
    const monthBranchIdx = BRANCH.findIndex(b => b.c === saju.month.b.c);
    
    for (let i = 0; i < 3; i++) {
        const s1 = saju[positions[i]]?.s;
        const s2 = saju[positions[i+1]]?.s;
        if (!s1 || !s2) continue;
        
        const idx1 = STEM.indexOf(s1);
        const idx2 = STEM.indexOf(s2);
        
        const key1 = `${Math.min(idx1, idx2)}-${Math.max(idx1, idx2)}`;
        
        if (STEM_COMBINE_RESULT[key1]) {
            const combineData = STEM_COMBINE_RESULT[key1];
            
            // ‚òÖ Ìï©Ìôî ÏÑ±Î¶Ω Ï°∞Í±¥: ÏõîÏßÄÍ∞Ä Ìï©Ìôî Í≤∞Í≥º Ïò§ÌñâÏùò Í≥ÑÏ†àÏù¥Ïñ¥Ïïº Ìï®
            const canTransform = combineData.seasonBranches.includes(monthBranchIdx);
            
            // Ìà¨Ï∂ú Ï≤¥ÌÅ¨: Ìï©Ìôî Í≤∞Í≥º Ïò§ÌñâÏù¥ Ï≤úÍ∞ÑÏóê ÏûàÏúºÎ©¥ Ìï©ÌôîÎ†• Í∞ïÌôî
            const allStems = [saju.year?.s, saju.month?.s, saju.day?.s, saju.hour?.s].filter(s => s);
            const hasTouchal = allStems.some(s => s.e === combineData.result);
            
            let status, note;
            if (canTransform && hasTouchal) {
                status = 'ÏßÑÌï©Ìôî(ÁúûÂêàÂåñ)';
                note = `‚úÖ Í≥ÑÏ†à Ï†ÅÌï©(${BRANCH[monthBranchIdx].c}Ïõî) + Ìà¨Ï∂ú ‚Üí ÏôÑÏ†Ñ Î≥ÄÌôò`;
            } else if (canTransform) {
                status = 'Ìï©Ìôî(ÂêàÂåñ)';
                note = `Í≥ÑÏ†à Ï†ÅÌï©(${BRANCH[monthBranchIdx].c}Ïõî) ‚Üí ${ELEMENT[combineData.result].k}ÏúºÎ°ú Î≥ÄÌôò`;
            } else {
                status = 'Ìï©Ïù¥Î•ò(ÂêàËÄåÁïô)';
                note = `‚ö†Ô∏è ${BRANCH[monthBranchIdx].c}Ïõî = Í≥ÑÏ†à Î∂àÏùºÏπò ‚Üí Ìï©ÏùÄ ÌïòÎÇò Î≥ÄÌïòÏßÄ ÏïäÏùå`;
            }
            
            stemCombines.push({
                stems: `${s1.c}${s2.c}`,
                positions: `${positions[i]}-${positions[i+1]}`,
                ...combineData,
                isAdjacent: true,
                canTransform,
                hasTouchal,
                status,
                note
            });
        }
    }
    
    // ÎÖÑ-Ïãú ÏõêÍ±∞Î¶¨ Ìï© Ï≤¥ÌÅ¨ (Ê∞£ÁµÜ - Í∏∞Ïö¥Îßå Î¨∂ÏûÑ, Î≥ÄÌôò Î∂àÍ∞Ä)
    if (saju.year?.s && saju.hour?.s) {
        const yIdx = STEM.indexOf(saju.year.s);
        const hIdx = STEM.indexOf(saju.hour.s);
        const key = `${Math.min(yIdx, hIdx)}-${Math.max(yIdx, hIdx)}`;
        if (STEM_COMBINE_RESULT[key]) {
            stemCombines.push({
                stems: `${saju.year.s.c}${saju.hour.s.c}`,
                positions: 'year-hour',
                ...STEM_COMBINE_RESULT[key],
                isAdjacent: false,
                canTransform: false,
                status: 'Í∏∞Î∞ò(Ê∞£ÁµÜ)',
                note: '‚ö†Ô∏è ÏõêÍ±∞Î¶¨ Ìï© = Í∏∞Ïö¥Îßå Î¨∂ÏûÑ, ÌôîÌïôÏ†Å Î≥ÄÌôî ÏóÜÏùå'
            });
        }
    }
    
    result.stemCombines = stemCombines;
    
    // ====== 3. Ïã†Í∞ï/Ïã†ÏïΩ Î∂ÑÏÑù ======
    result.strength = calcStrength(saju);
    
    // ====== 4. ÌïúÎÇúÏ°∞Ïäµ Î∂ÑÏÑù ======
    result.climate = analyzeClimate(saju);
    
    // ====== 5. Ïö©Ïã† Î∂ÑÏÑù ======
    result.gods = calcGods(saju, result.strength);
    
    // ====== 6. ÏµúÏ¢Ö ÏöîÏïΩ ÏÉùÏÑ± ======
    const dm = saju.day.s;
    const gods = result.gods;
    const str = result.strength;
    
    const summaryLines = [];
    summaryLines.push(`„ÄêÏùºÍ∞Ñ„Äë ${dm.c}(${dm.k}) ${ELEMENT[dm.e].k}`);
    summaryLines.push(`„ÄêÏã†Í∞ï/Ïã†ÏïΩ„Äë ${str.type === 'strong' ? 'Ïã†Í∞ï' : str.type === 'weak' ? 'Ïã†ÏïΩ' : 'Ï§ëÌôî'} (${str.score}Ï†ê, ${str.pct}%)`);
    
    if (gods.isFollower) {
        summaryLines.push(`„ÄêÌäπÏàòÍ≤©Íµ≠„Äë ${gods.followerType}`);
    }
    
    summaryLines.push(`„ÄêÏö©Ïã†„Äë ${ELEMENT[gods.yong]?.k || gods.yong}`);
    summaryLines.push(`„ÄêÌù¨Ïã†„Äë ${ELEMENT[gods.hee]?.k || gods.hee}`);
    summaryLines.push(`„ÄêÍ∏∞Ïã†„Äë ${ELEMENT[gods.gi]?.k || gods.gi}`);
    
    if (gods.johu) {
        summaryLines.push(`„ÄêÏ°∞ÌõÑ„Äë ${ELEMENT[gods.johu]?.k || gods.johu} - ${gods.johuDesc}`);
    }
    
    if (result.climate) {
        summaryLines.push(`„ÄêÍ∏∞ÌõÑ„Äë ${result.climate.type} - ${result.climate.desc}`);
    }
    
    if (foundCombos.length > 0) {
        summaryLines.push(`„ÄêÏßÄÏßÄÌï©„Äë ${foundCombos.map(c => c.name).join(', ')}`);
    }
    
    if (stemCombines.length > 0) {
        // v4.12.6: Ìï©Ìôî ÏÑ±Î¶Ω Ïó¨Î∂Ä ÏÉÅÏÑ∏ ÌëúÏãú
        const combineDetails = stemCombines.map(c => {
            if (c.status === 'ÏßÑÌï©Ìôî(ÁúûÂêàÂåñ)') {
                return `‚úÖ${c.name}‚Üí${ELEMENT[c.result].k}(ÏßÑÌï©Ìôî)`;
            } else if (c.status === 'Ìï©Ìôî(ÂêàÂåñ)') {
                return `${c.name}‚Üí${ELEMENT[c.result].k}(Ìï©Ìôî)`;
            } else if (c.status === 'Ìï©Ïù¥Î•ò(ÂêàËÄåÁïô)') {
                return `‚ö†Ô∏è${c.name}(Ìï©Ïù¥Î•ò-Î∂àÎ≥Ä)`;
            } else {
                return `${c.name}(Í∏∞Î∞ò)`;
            }
        });
        summaryLines.push(`„ÄêÏ≤úÍ∞ÑÌï©„Äë ${combineDetails.join(', ')}`);
    }
    
    // ====== v4.12.6 NEW: Ïö©Ïã† ÌååÍ¥¥ Ìå®ÌÑ¥ Í≤ΩÍ≥† Ï∂úÎ†• ======
    if (gods.warnings && gods.warnings.length > 0) {
        const highWarnings = gods.warnings.filter(w => w.severity === 'high');
        const mediumWarnings = gods.warnings.filter(w => w.severity === 'medium');
        
        if (highWarnings.length > 0) {
            summaryLines.push(`üö®„ÄêÏúÑÌóòÍ≤ΩÍ≥†„Äë ${highWarnings.map(w => w.type).join(', ')}`);
        }
        if (mediumWarnings.length > 0) {
            summaryLines.push(`‚ö†Ô∏è„ÄêÏ£ºÏùòÏÇ¨Ìï≠„Äë ${mediumWarnings.map(w => w.type).join(', ')}`);
        }
    }
    
    result.summary = summaryLines;
    
    return result;
}


/* ========================================
   9-5. Six Relations Precision Analysis
   ======================================== */

// Six Relations definitions
const YUKCHEON = {
    m: { // Male
        'ÊØîËÇ© Peer': {relation: 'Brothers/Friends', desc: 'Equal relationship', detailed: 'Siblings, friends, colleagues, rivals'},
        'Âä´Ë≤° Competitor': {relation: 'Brothers/Rivals', desc: 'Competitive relationship', detailed: 'Half-siblings, cousins, competitors, partners'},
        'È£üÁ•û Eating God': {relation: 'Children(daughter)/Juniors', desc: 'What I create', detailed: 'Daughter, granddaughter, juniors, subordinates'},
        'ÂÇ∑ÂÆò Expressor': {relation: 'Children(son)/Talent', desc: 'What I express', detailed: 'Son, grandson, creativity, ideas'},
        'ÂÅèË≤° Indirect Wealth': {relation: 'Father/Lover', desc: 'Wealth I control', detailed: 'Father, mistress, lover, entertainment, speculation'},
        'Ê≠£Ë≤° Direct Wealth': {relation: 'Wife/Wealth', desc: 'Wealth I protect', detailed: 'Wife, salary, stable income'},
        'ÂÅèÂÆò Challenger': {relation: 'Children(son)/Career', desc: 'What controls me', detailed: 'Son, boss, power, pressure'},
        'Ê≠£ÂÆò Direct Officer': {relation: 'Children(daughter)/Honor', desc: 'What disciplines me', detailed: 'Daughter, honor, career, law'},
        'ÂÅèÂç∞ Indirect Seal': {relation: 'Stepmother/Foster', desc: 'Unconventional nurturing', detailed: 'Stepmother, foster mother'},
        'Ê≠£Âç∞ Direct Seal': {relation: 'Mother/Studies', desc: 'Proper nurturing', detailed: 'Mother, studies, documents, certificates'}
    },
    f: { // Female
        'ÊØîËÇ© Peer': {relation: 'Sisters/Friends', desc: 'Equal relationship', detailed: 'Sisters, friends, colleagues, rivals'},
        'Âä´Ë≤° Competitor': {relation: 'Sisters/Rivals', desc: 'Competitive relationship', detailed: 'Half-sisters, cousins, competitors'},
        'È£üÁ•û Eating God': {relation: 'Children(daughter)/Talent', desc: 'What I create', detailed: 'Daughter, granddaughter, expression, talent'},
        'ÂÇ∑ÂÆò Expressor': {relation: 'Children(son)/Romance', desc: 'What I express', detailed: 'Son, grandson, lover, charm'},
        'ÂÅèË≤° Indirect Wealth': {relation: 'Father-in-law/Wealth', desc: 'Wealth I control', detailed: 'Father-in-law, speculative wealth, windfall'},
        'Ê≠£Ë≤° Direct Wealth': {relation: 'Mother-in-law/Property', desc: 'Wealth I protect', detailed: 'Mother-in-law, stable income, salary'},
        'ÂÅèÂÆò Challenger': {relation: 'Lover/Man', desc: 'What controls me', detailed: 'Lover, affair, passionate man'},
        'Ê≠£ÂÆò Direct Officer': {relation: 'Husband/Honor', desc: 'What disciplines me', detailed: 'Husband, honor, career'},
        'ÂÅèÂç∞ Indirect Seal': {relation: 'Stepmother/Obstacle', desc: 'Unconventional nurturing', detailed: 'Stepmother, foster mother, incomplete studies'},
        'Ê≠£Âç∞ Direct Seal': {relation: 'Mother/Studies', desc: 'Proper nurturing', detailed: 'Mother, studies, documents'}
    }
};

// Position meanings
const YUKCHEON_POSITION = {
    year: {name: 'Year Pillar', meaning: 'Ancestors, Society, Early years (Ages 1-15)', body: 'Head/Face'},
    month: {name: 'Month Pillar', meaning: 'Parents, Siblings, Career, Youth (Ages 16-30)', body: 'Chest/Shoulders'},
    day: {name: 'Day Pillar', meaning: 'Self, Spouse, Home, Middle age (Ages 31-45)', body: 'Waist/Abdomen'},
    hour: {name: 'Hour Pillar', meaning: 'Children, Juniors, Later years (Ages 46+)', body: 'Legs/Feet'}
};

// Six Relations Analysis
function analyzeYukcheon(saju, gender) {
    const dm = saju.day.s;
    const g = gender || GENDER || 'm';
    const yukData = YUKCHEON[g];
    
    const result = {
        positions: [],   // Six Relations by position
        counts: {},      // Count by Six Relations
        analysis: [],    // Comprehensive analysis
        spouse: null,    // Spouse Analysis
        children: null,  // Children Analysis
        parents: null    // Parents Analysis
    };
    
    const pillars = [
        {pos: 'year', pillar: saju.year},
        {pos: 'month', pillar: saju.month},
        {pos: 'day', pillar: saju.day},
        {pos: 'hour', pillar: saju.hour}
    ];
    
    // Each pillar analysis
    pillars.forEach(({pos, pillar}) => {
        if (!pillar) return;
        
        // Stem Ten Gods
        const stemGod = pos === 'day' ? {k: 'Day Master', c: 'Êó•Âπ≤'} : getTenGod(pillar.s, dm);
        
        // Branch main stem Ten Gods
        const mainJJ = HIDDEN_STEMS[BRANCH.findIndex(br => br.c === pillar.b.c)];
        const mainStem = mainJJ && mainJJ.length > 0 ? STEM[mainJJ[mainJJ.length - 1].stem] : null;
        const branchGod = mainStem ? getTenGod(mainStem, dm) : null;
        
        const posInfo = YUKCHEON_POSITION[pos];
        const yukInfo = yukData[stemGod.k];
        
        result.positions.push({
            position: pos,
            posName: posInfo.name,
            posMeaning: posInfo.meaning,
            stem: pillar.s,
            branch: pillar.b,
            stemGod: stemGod.k,
            branchGod: branchGod ? branchGod.k : null,
            relation: yukInfo ? yukInfo.relation : 'Self',
            detailed: yukInfo ? yukInfo.detailed : 'ÏûêÍ∏∞ ÏûêÏã†'
        });
        
        // Count summary
        if (stemGod.k !== 'Day Master') {
            result.counts[stemGod.k] = (result.counts[stemGod.k] || 0) + 1;
        }
        if (branchGod) {
            result.counts[branchGod.k] = (result.counts[branchGod.k] || 0) + 0.5;
        }
    });
    
    // ========== Spouse Analysis ==========
    const spouseGod = g === 'm' ? 'Ê≠£Ë≤°(Direct Wealth)' : 'Ê≠£ÂÆò(Direct Officer)';
    const spouseAltGod = g === 'm' ? 'ÂÅèË≤°(Indirect Wealth)' : 'ÂÅèÂÆò(Challenger)';
    const spouseCount = result.counts[spouseGod] || 0;
    const spouseAltCount = result.counts[spouseAltGod] || 0;
    const dayBranchState = getTwelveState(dm, saju.day.b);
    
    // üî• ÏßÄÏû•Í∞ÑÏóêÏÑú Î∞∞Ïö∞ÏûêÏÑ± Ï∞æÍ∏∞ (Hidden but Present) - Gemini feedback
    let hiddenSpouse = {found: false, position: '', damaged: false, damageDesc: ''};
    const spouseElement = g === 'm' ? 
        EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5] :  // Ïû¨ÏÑ±ÏùÄ ÎÇ¥Í∞Ä Í∑πÌïòÎäî Ïò§Ìñâ
        EL_ORDER[(EL_ORDER.indexOf(dm.e) + 3) % 5];  // Í¥ÄÏÑ±ÏùÄ ÎÇòÎ•º Í∑πÌïòÎäî Ïò§Ìñâ
    
    pillars.forEach(({pos, pillar}) => {
        if (!pillar) return;
        const jjList = HIDDEN_STEMS[BRANCH.findIndex(br => br.c === pillar.b.c)];
        if (jjList) {
            jjList.forEach(jj => {
                const stem = STEM[jj.stem];
                if (stem.e === spouseElement) {
                    hiddenSpouse.found = true;
                    hiddenSpouse.position = pos;
                    hiddenSpouse.stem = stem;
                    // Ìôî(Fire)Í∞Ä ÎßéÏúºÎ©¥ Í∏à(Metal) Î∞∞Ïö∞ÏûêÏÑ±Ïù¥ ÎÖπÏùå
                    if (spouseElement === 'metal') {
                        const fireCount = (result.counts['È£üÁ•û(Eating God)'] || 0) + 
                                         (result.counts['ÂÇ∑ÂÆò(Expressor)'] || 0);
                        const fireEl = pillars.filter(p => p.pillar && 
                            (p.pillar.s.e === 'fire' || p.pillar.b.e === 'fire')).length;
                        if (fireEl >= 2) {
                            hiddenSpouse.damaged = true;
                            hiddenSpouse.damageDesc = 'Metal spouse melting under Fire excess';
                        }
                    }
                }
            });
        }
    });
    
    let spouseAnalysis = '';
    if (spouseCount === 0 && !hiddenSpouse.found) {
        spouseAnalysis = 'Spouse star absent. Marriage may come late or bonds may be weak. Romance arrives when it appears in Â§ßÈÅã(Life Cycle).';
    } else if (spouseCount === 0 && hiddenSpouse.found) {
        // ÏßÄÏû•Í∞ÑÏóêÎäî ÏûàÏßÄÎßå Ï≤úÍ∞ÑÏóê ÏóÜÏùå
        if (hiddenSpouse.damaged) {
            spouseAnalysis = `Spouse star in ${hiddenSpouse.position} branch (hidden) but ${hiddenSpouse.damageDesc}. Early marriage may face obstacles. Living separately (weekend couple) may actually preserve the relationship.`;
        } else {
            spouseAnalysis = `Spouse star hidden in ${hiddenSpouse.position} branch. Quiet attraction. Spouse appears when timing is right.`;
        }
    } else if (spouseCount >= 2) {
        spouseAnalysis = 'Strong spouse energy. Popular with opposite sex but watch for infidelity! Focus on one person.';
    } else {
        spouseAnalysis = 'Good spouse energy. You can meet a good partner.';
    }
    
    result.spouse = {
        god: spouseGod,
        count: spouseCount,
        hiddenSpouse: hiddenSpouse,
        dayBranch: dayBranchState,
        analysis: spouseAnalysis
    };
    
    // ========== Children Analysis ==========
    const childGod = g === 'm' ? ['ÂÅèÂÆò(Challenger)', 'Ê≠£ÂÆò(Direct Officer)'] : ['È£üÁ•û(Eating God)', 'ÂÇ∑ÂÆò(Expressor)'];
    const childCount = (result.counts[childGod[0]] || 0) + (result.counts[childGod[1]] || 0);
    const hourPillar = saju.hour;
    
    // üî• ÏãúÏ≤úÍ∞ÑÏóê ÏûêÎÖÄÏÑ± Ìà¨Ï∂ú Ï≤¥ÌÅ¨ - Gemini Round 4
    let hourStemChild = null;
    if (hourPillar) {
        const hourGod = getTenGod(hourPillar.s, dm);
        if (childGod.includes(hourGod.k)) {
            hourStemChild = {
                stem: hourPillar.s,
                god: hourGod.k,
                // ÌôîÍ∑πÍ∏à Îì± ÏÉÅÌÉú Ï≤¥ÌÅ¨
                underFire: hourPillar.b.e === 'fire' && hourPillar.s.e === 'metal'
            };
        }
    }
    
    let childAnalysis = '';
    if (!hourPillar) {
        childAnalysis = 'Birth hour needed for children analysis.';
    } else if (hourStemChild) {
        // ÏãúÏ≤úÍ∞ÑÏóê ÏûêÎÖÄÏÑ± Ìà¨Ï∂ú!
        if (hourStemChild.underFire) {
            childAnalysis = `Children star (${hourStemChild.god}) REVEALED on Hour Stem but sitting on Fire - children may face challenges or live far away. Early independence benefits them.`;
        } else {
            childAnalysis = `Children star (${hourStemChild.god}) REVEALED on Hour Stem. Children fortune is visible. Pay attention to their development.`;
        }
    } else if (childCount === 0) {
        childAnalysis = 'Children star absent. May have children late or few.';
    } else if (childCount >= 2) {
        childAnalysis = 'Strong children stars. Blessed with children fortune.';
    } else {
        childAnalysis = 'Moderate children fortune.';
    }
    
    result.children = {
        gods: childGod,
        count: childCount,
        hourStemChild: hourStemChild,
        analysis: childAnalysis
    };
    
    // ========== Parents Analysis ==========
    const fatherGod = 'ÂÅèË≤°(Indirect Wealth)';
    const motherGod = 'Ê≠£Âç∞(Direct Seal)';
    const fatherCount = result.counts[fatherGod] || 0;
    const motherCount = result.counts[motherGod] || 0;
    
    result.parents = {
        father: {god: fatherGod, count: fatherCount, analysis: fatherCount > 0 ? 'Strong father connection.' : 'Weak father connection.'},
        mother: {god: motherGod, count: motherCount, analysis: motherCount > 0 ? 'Deep mother connection.' : 'Somewhat weak mother connection.'}
    };
    
    // ========== Ï¢ÖÌï© Î∂ÑÏÑù ==========
    // Six relations quantity analysis
    for (let [god, count] of Object.entries(result.counts)) {
        if (count >= 2) {
            const info = yukData[god];
            if (info) {
                result.analysis.push({
                    type: 'many',
                    god,
                    count,
                    meaning: `${god} appears many times. Significant life events related to this relation..`
                });
            }
        }
    }
    
    // Check missing relations
    const allGods = ['ÊØîËÇ©(Peer)','Âä´Ë≤°(Competitor)','È£üÁ•û(Eating God)','ÂÇ∑ÂÆò(Expressor)','ÂÅèË≤°(Indirect Wealth)','Ê≠£Ë≤°(Direct Wealth)','ÂÅèÂÆò(Challenger)','Ê≠£ÂÆò(Direct Officer)','ÂÅèÂç∞(Indirect Seal)','Ê≠£Âç∞(Direct Seal)'];
    allGods.forEach(god => {
        if (!result.counts[god]) {
            const info = yukData[god];
            if (info) {
                result.analysis.push({
                    type: 'none',
                    god,
                    meaning: `${god}is missing. This connection may be weak in life..`
                });
            }
        }
    });
    
    return result;
}

/* ========================================
   10. Í≤©Íµ≠(Ê†ºÂ±Ä) Ï†ïÎ∞Ä ÌåêÏ†ï
   ======================================== */
   
// Regular Structure (8 types) data
const FORMATS_INNER = {
    'ÊØîËÇ©(Peer)':{n:'Peer Structure (ÊØîËÇ©Ê†º)',d:'The Self-Made Soul. Fierce independence and competitive fire drive you to forge your own path. Deep bonds with siblings and partners lead to success through collaboration. Channel your strong will with flexibility, and kingdoms will rise at your command.',b:'Entrepreneurship, Freelance, Athletics, Competition',lv:'Medium'},
    'Âä´Ë≤°(Competitor)':{n:'Competitor Structure (Âä´Ë≤°Ê†º)',d:'The Bold Challenger. Daring ambition and unshakeable courage propel you toward grand ventures. Your hunger for victory runs deep ‚Äî balance boldness with patience, and fortune shall favor the persistent warrior.',b:'Investment, Venture Capital, Sales, High-Risk Enterprise',lv:'Challenging'},
    'È£üÁ•û(Eating God)':{n:'Eating God Structure (È£üÁ•ûÊ†º)',d:'The Blessed Creator. Heaven has bestowed abundant talents and life\'s pleasures upon you. Artistic brilliance flows naturally, and fortune follows your optimistic spirit. Guard against complacency ‚Äî your gifts multiply when cultivated with diligence.',b:'Culinary Arts, Entertainment, Education, Creative Fields',lv:'Excellent'},
    'ÂÇ∑ÂÆò(Expressor)':{n:'Expressor Structure (ÂÇ∑ÂÆòÊ†º)',d:'The Rebel Genius. Brilliant creativity and sharp wit define your unconventional soul. Your free spirit resists all chains ‚Äî temper your tongue, for words cut deeper than swords. Channel rebellion into artistry, and the world will remember your name.',b:'Entertainment, Arts, Public Speaking, Innovation',lv:'Medium'},
    'ÂÅèË≤°(Indirect Wealth)':{n:'Indirect Wealth Structure (ÂÅèË≤°Ê†º)',d:'The Fortune Magnet. Business intuition and investment instincts run through your veins. Windfall opportunities find you naturally ‚Äî wide social networks amplify your luck. Guard your wandering heart, for stability nurtures lasting prosperity.',b:'Trading, Investment, Sales, Networking',lv:'Excellent'},
    'Ê≠£Ë≤°(Direct Wealth)':{n:'Direct Wealth Structure (Ê≠£Ë≤°Ê†º)',d:'The Steady Builder. Honest accumulation and patient persistence build your empire brick by brick. Trustworthiness is your greatest currency ‚Äî loyal partnerships and domestic harmony crown your efforts. Wealth grows slowly but eternally under your stewardship.',b:'Finance, Accounting, Management, Civil Service',lv:'Excellent'},
    'ÂÅèÂÆò(Challenger)':{n:'Challenger Structure (‰∏ÉÊÆ∫Ê†º)',d:'The Warrior Commander. Charisma and decisive action forge your path to power. The fire of ambition burns bright within ‚Äî master this force, and you become a legendary leader. Unchecked, it creates enemies. Refined, it conquers worlds.',b:'Military, Law, Politics, Martial Arts, Athletics',lv:'Medium'},
    'Ê≠£ÂÆò(Direct Officer)':{n:'Direct Officer Structure (Ê≠£ÂÆòÊ†º)',d:'The Noble Authority. Dignity and honor illuminate your every step. Organizations recognize your worth and elevate you swiftly. The cosmos favor those who walk the righteous path ‚Äî your integrity becomes your crown.',b:'Government, Corporation, Law, Education',lv:'Supreme'},
    'ÂÅèÂç∞(Indirect Seal)':{n:'Indirect Seal Structure (ÂÅèÂç∞Ê†º)',d:'The Mystic Scholar. Unconventional wisdom and esoteric knowledge call to your soul. Religious, philosophical, and occult matters fascinate your unique mind. Focus your scattered brilliance, and profound discoveries await.',b:'Research, Technology, Spirituality, Medicine',lv:'Medium'},
    'Ê≠£Âç∞(Direct Seal)':{n:'Direct Seal Structure (Ê≠£Âç∞Ê†º)',d:'The Blessed Scholar. Heaven\'s favor flows through maternal bonds and elder blessings. Academic pursuits and teaching call to your gentle soul. Your compassionate nature nurtures all who enter your sphere.',b:'Education, Publishing, Academia, Welfare',lv:'Excellent'}
};

// Special Structures (Â§ñÊ†º) - Extraordinary destiny patterns
const FORMATS_SPECIAL = {
    'jongwang': {n:'Following Power (ÂæûÊó∫Ê†º)', d:'Your Guardian Element blazes with overwhelming force. The cosmos demand you forge your own empire ‚Äî working under others suffocates your spirit. CEOs, entrepreneurs, and independent visionaries carry this rare blessing. Trust your unstoppable will.', b:'CEO, Entrepreneur, Political Leader, Independent Expert', lv:'Special'},
    'jonggang': {n:'Following Seal (ÂæûÂº∑Ê†º)', d:'Guardian Element and Seal energy unite in formidable strength. Academic glory and institutional authority await your claim. Professors, researchers, and high officials often bear this distinguished pattern.', b:'Professor, Researcher, High Government Official', lv:'Special'},
    'jonga': {n:'Following Expression (ÂæûÂÖíÊ†º)', d:'Creative energy overflows from your soul. Artistic brilliance and expressive genius demand freedom ‚Äî the stage, the canvas, the page all await your unique voice. Let your spirit roam free.', b:'Artist, Entertainer, Author, Content Creator', lv:'Special'},
    'jongjae': {n:'Following Wealth (ÂæûË≤°Ê†º)', d:'Wealth energy dominates your chart with magnetic force. Financial mastery flows through your veins ‚Äî business empires and investment fortunes bend to your intuition. Money and you share a destined bond.', b:'Financier, Business Mogul, Investor, Real Estate', lv:'Special'},
    'jongsal': {n:'Following Authority (ÂæûÊÆ∫Ê†º)', d:'Commanding energy fills every corner of your being. Power and prestige call to your warrior soul ‚Äî military leadership, political influence, and executive authority become your natural domain.', b:'Military Leader, Politician, Executive, Judge', lv:'Special'},
    'yangin': {n:'Sheep Blade Structure (ÁæäÂàÉÊ†º)', d:'The cosmic blade rests in your Day Pillar (Êó•Êü±) ‚Äî extraordinary power courses through you. Decisive action and crisis mastery define your path. Sharp edges may wound the careless, but heroes are forged from such steel.', b:'Military, Surgeon, Lawyer, Elite Athlete', lv:'Special'},
    'geonrok': {n:'Prime Structure (Âª∫Á•øÊ†º)', d:'Your Month Palace holds the Prime energy of your Guardian Element. Self-made success through persistent effort awaits ‚Äî career stability and mid-life prosperity reward your steady climb.', b:'Civil Service, Professional, Self-Employed', lv:'Excellent'},
    'woldeok': {n:'Moon Virtue Structure (ÊúàÂæ∑Ê†º)', d:'The Moon\'s blessing graces your chart. Virtue attracts aid in times of need ‚Äî your trustworthy character opens doors that remain closed to others. Official fortune shines upon you.', b:'Government, Education, Religious Service', lv:'Excellent'}
};

// Structure success/failure(ÊàêÊïó) ÌåêÎã®
function isFormatBroken(saju, formatGod) {
    const dm = saju.day.s;
    const dmEl = dm.e;
    const breakReasons = [];
    
    // Direct Officer break condition: Expressor breaks it
    if (formatGod === 'Ê≠£ÂÆò(Direct Officer)') {
        const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
        for (let p of allPillars) {
            const god = getTenGod(p.s, dm);
            if (god.k === 'ÂÇ∑ÂÆò(Expressor)') {
                breakReasons.push('Expressor sees Officer: Expression clashes with Authority (broken)');
            }
        }
    }
    
    // Eating God break condition: Indirect Seal breaks it
    if (formatGod === 'È£üÁ•û(Eating God)') {
        const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
        for (let p of allPillars) {
            const god = getTenGod(p.s, dm);
            if (god.k === 'ÂÅèÂç∞(Indirect Seal)') {
                breakReasons.push('Owl steals food: Indirect Seal overcomes Eating God (broken)');
            }
        }
    }
    
    // Wealth break condition: Many Peers break it
    if (formatGod === 'Ê≠£Ë≤°(Direct Wealth)' || formatGod === 'ÂÅèË≤°(Indirect Wealth)') {
        let biCount = 0;
        const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
        for (let p of allPillars) {
            const god = getTenGod(p.s, dm);
            if (god.k === 'ÊØîËÇ©(Peer)' || god.k === 'Âä´Ë≤°(Competitor)') biCount++;
        }
        if (biCount >= 2) {
            breakReasons.push('Peers rob wealth: Too many Peers steal the wealth (broken)');
        }
    }
    
    return breakReasons;
}

// Special structures (Ï¢ÖÍ≤©) ÌåêÏ†ï
function checkSpecialFormat(saju, strength) {
    if (!strength.extreme) return null;
    
    const dm = saju.day.s;
    const ec = countElements(saju);
    const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
    
    // üî• Five ElementsÎ≥Ñ Ïã≠Ïã† Í∞úÏàò ÏÑ∏Í∏∞ (Ï≤úÍ∞Ñ + ÏßÄÏû•Í∞Ñ Ìè¨Ìï®) - Gemini Round 9
    const godCounts = {bigeop:0, sikSang:0, jae:0, gwan:0, in:0};
    
    // Ï≤úÍ∞Ñ Ïã≠Ïã†
    allPillars.forEach(p => {
        const god = getTenGod(p.s, dm);
        if (['ÊØîËÇ©(Peer)','Âä´Ë≤°(Competitor)'].includes(god.k)) godCounts.bigeop++;
        if (['È£üÁ•û(Eating God)','ÂÇ∑ÂÆò(Expressor)'].includes(god.k)) godCounts.sikSang++;
        if (['ÂÅèË≤°(Indirect Wealth)','Ê≠£Ë≤°(Direct Wealth)'].includes(god.k)) godCounts.jae++;
        if (['ÂÅèÂÆò(Challenger)','Ê≠£ÂÆò(Direct Officer)'].includes(god.k)) godCounts.gwan++;
        if (['ÂÅèÂç∞(Indirect Seal)','Ê≠£Âç∞(Direct Seal)'].includes(god.k)) godCounts.in++;
    });
    
    // üî• ÏßÄÏû•Í∞Ñ Ïã≠Ïã†ÎèÑ Ïπ¥Ïö¥Ìä∏ (Î≥∏Í∏∞ ÏúÑÏ£º)
    allPillars.forEach(p => {
        const bi = BRANCH.findIndex(br => br.c === p.b.c);
        const hidden = HIDDEN_STEMS[bi];
        if (hidden) {
            hidden.forEach(h => {
                if (h.type === 'jung') {  // Î≥∏Í∏∞(Main)Îßå Ïπ¥Ïö¥Ìä∏
                    const hiddenStem = STEM[h.stem];
                    const god = getTenGod(hiddenStem, dm);
                    if (['ÂÅèË≤°(Indirect Wealth)','Ê≠£Ë≤°(Direct Wealth)'].includes(god.k)) godCounts.jae += 0.5;
                    if (['ÂÅèÂÆò(Challenger)','Ê≠£ÂÆò(Direct Officer)'].includes(god.k)) godCounts.gwan += 0.5;
                    if (['ÂÅèÂç∞(Indirect Seal)','Ê≠£Âç∞(Direct Seal)'].includes(god.k)) godCounts.in += 0.5;
                }
            });
        }
    });
    
    if (strength.extreme === 'Extreme Strong') {
        // Jong-wang: Extremely many Peers
        if (godCounts.bigeop >= 3) return FORMATS_SPECIAL.jongwang;
        // Follower of Strength: Ïù∏ÏÑ±Ïù¥ Îß§Ïö∞ ÎßéÏùå
        if (godCounts.in >= 2 && godCounts.bigeop >= 2) return FORMATS_SPECIAL.jonggang;
    }
    
    if (strength.extreme === 'Extreme Weak') {
        // Follower of Expression: ÏãùÏÉÅÏù¥ Îß§Ïö∞ ÎßéÏùå
        if (godCounts.sikSang >= 3) return FORMATS_SPECIAL.jonga;
        // Follower of Wealth: Ïû¨ÏÑ±Ïù¥ Îß§Ïö∞ ÎßéÏùå (ÏßÄÏû•Í∞Ñ Ìè¨Ìï® 2.5 Ïù¥ÏÉÅ)
        if (godCounts.jae >= 2.5) return {...FORMATS_SPECIAL.jongjae, fakeFollower: true};
        // Jong-sal: Extremely many Officers (ÏßÄÏû•Í∞Ñ Ìè¨Ìï® 2.5 Ïù¥ÏÉÅ)
        if (godCounts.gwan >= 2.5) return {...FORMATS_SPECIAL.jongsal, fakeFollower: true};
    }
    
    return null;
}

// Yang Blade Structure, PrimeÍ≤© Ï≤¥ÌÅ¨
function checkYangInGeonRok(saju) {
    const dm = saju.day.s;
    const dsi = STEM.indexOf(dm);
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    
    // Prime position (Day MasterÎ≥Ñ PrimeÏßÄ)
    const geonrokMap = {0:2, 1:3, 2:5, 3:6, 4:5, 5:6, 6:8, 7:9, 8:11, 9:0}; // Áî≤ÂØÖ, ‰πôÂçØ...
    // Yang Blade position (Prime Îã§Ïùå)
    const yanginMap = {0:3, 1:2, 2:6, 3:5, 4:6, 5:5, 6:9, 7:8, 8:0, 9:11}; // Áî≤ÂçØ, ‰πôÂØÖ...
    
    // If Month Branch is Prime PrimeÍ≤©
    if (mbi === geonrokMap[dsi]) {
        return FORMATS_SPECIAL.geonrok;
    }
    
    // If Day Branch is Yang Blade ÏñëÏù∏Í≤©
    const dbi = BRANCH.findIndex(br => br.c === saju.day.b.c);
    if (dbi === yanginMap[dsi]) {
        return {...FORMATS_SPECIAL.yangin, hasYangIn: true};
    }
    
    return null;
}

// Comprehensive structure determination
function calcFormat(saju, strength) {
    const str = strength || calcStrength(saju);
    
    // 1. ÌäπÏàòÍ≤© Ï≤¥ÌÅ¨
    const specialFormat = checkSpecialFormat(saju, str);
    if (specialFormat) {
        return {...specialFormat, type:'special', god:'Special'};
    }
    
    // 2. ÏñëÏù∏Í≤©/PrimeÍ≤© Ï≤¥ÌÅ¨
    const yangInGeonRok = checkYangInGeonRok(saju);
    if (yangInGeonRok && yangInGeonRok.n.includes('ÏñëÏù∏')) {
        return {...yangInGeonRok, type:'special', god:'Blade'};
    }
    
    // üî• 2.5 ÏãùÏã†Ï†úÏÇ¥(È£üÁ•ûÂà∂ÊÆ∫) Ï≤¥ÌÅ¨ - Gemini Round 6
    // Ìé∏Í¥Ä(Ïπ†ÏÇ¥)Ïù¥ 2Í∞ú Ïù¥ÏÉÅÏù¥Í≥† ÏãùÏã†Ïù¥ 1Í∞ú Ïù¥ÏÉÅÏù¥Î©¥ = ÏãùÏã†Ï†úÏÇ¥
    const dm = saju.day.s;
    const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
    let challengerCount = 0;
    let eatingGodCount = 0;
    allPillars.forEach(p => {
        const god = getTenGod(p.s, dm);
        if (god.k === 'ÂÅèÂÆò(Challenger)') challengerCount++;
        if (god.k === 'È£üÁ•û(Eating God)') eatingGodCount++;
    });
    // ÏßÄÏßÄ Ïà®ÏùÄ Í∞ÑÎèÑ Ï≤¥ÌÅ¨
    const allBranches = [saju.year.b, saju.month.b, saju.day.b, saju.hour?.b].filter(b => b);
    allBranches.forEach(b => {
        const bi = BRANCH.findIndex(br => br.c === b.c);
        const hidden = HIDDEN_STEMS[bi] || [];
        hidden.forEach(h => {
            const hStem = STEM[h.stem];
            const hGod = getTenGod(hStem, dm);
            if (hGod.k === 'ÂÅèÂÆò(Challenger)' && h.days >= 10) challengerCount += 0.5;
            if (hGod.k === 'È£üÁ•û(Eating God)' && h.days >= 10) eatingGodCount += 0.5;
        });
    });
    
    if (challengerCount >= 2 && eatingGodCount >= 1) {
        return {
            n: 'Crisis Solver Structure (È£üÁ•ûÂà∂ÊÆ∫Ê†º)',
            d: 'The Warrior Healer. Fierce external pressure (Challenger) meets your sharp skills (Eating God). You thrive in crisis ‚Äî solving problems others cannot. Not a peaceful artist, but a surgeon cutting through chaos. Your talent shines brightest under fire.',
            b: 'Medicine, Law, Engineering, Consulting, Crisis Management, Auditing',
            lv: 'Excellent',
            type: 'special',
            god: 'È£üÁ•ûÂà∂ÊÆ∫',
            isSikSinJeSal: true
        };
    }
    
    // 3. ÎÇ¥Í≤© ÌåêÏ†ï (Month Branch Hidden Stems MainÏùò Ïã≠Ïã†)
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    const jj = HIDDEN_STEMS[mbi];
    
    // Find main stem
    const mainJj = jj.find(j => j.days >= 16) || jj[jj.length - 1];
    const mainStem = STEM[mainJj.stem];
    const god = getTenGod(mainStem, saju.day.s);
    
    // ‚òÖ‚òÖ‚òÖ BUG-001 FIX: ÎÖÑÍ∞Ñ+ÏõîÍ∞Ñ Ìà¨Ï∂ú Ïö∞ÏÑ† Ï≤¥ÌÅ¨ (v4.5 Patch) ‚òÖ‚òÖ‚òÖ
    const validStructureGods = ['È£üÁ•û(Eating God)','ÂÇ∑ÂÆò(Expressor)','ÂÅèË≤°(Indirect Wealth)','Ê≠£Ë≤°(Direct Wealth)','ÂÅèÂÆò(Challenger)','Ê≠£ÂÆò(Direct Officer)','ÂÅèÂç∞(Indirect Seal)','Ê≠£Âç∞(Direct Seal)'];
    
    // ÎÖÑÍ∞Ñ Ïã≠Ïã† Ï≤¥ÌÅ¨
    const yearGod = getTenGod(saju.year.s, saju.day.s);
    const yearStemIdx = STEM.indexOf(saju.year.s);
    const yearHasRoot = jj.some(j => j.stem === yearStemIdx) || 
                        [saju.year.b, saju.month.b, saju.day.b, saju.hour?.b].filter(b=>b).some(branch => {
                            const bi = BRANCH.indexOf(branch);
                            return (HIDDEN_STEMS[bi] || []).some(h => h.stem === yearStemIdx);
                        });
    
    // ÏõîÍ∞Ñ Ïã≠Ïã† Ï≤¥ÌÅ¨
    const monthGod = getTenGod(saju.month.s, saju.day.s);
    const monthStemIdx = STEM.indexOf(saju.month.s);
    const monthHasRoot = jj.some(j => j.stem === monthStemIdx);
    
    // Ìà¨Ï∂ú Ïã≠Ïã† ÏßëÍ≥Ñ
    let emergentGods = {};
    if (validStructureGods.includes(yearGod.k) && yearHasRoot) {
        emergentGods[yearGod.k] = (emergentGods[yearGod.k] || 0) + 1;
    }
    if (validStructureGods.includes(monthGod.k) && monthHasRoot) {
        emergentGods[monthGod.k] = (emergentGods[monthGod.k] || 0) + 1;
    }
    
    // Í∞ÄÏû• ÎßéÏù¥ Ìà¨Ï∂úÎêú Ïã≠Ïã†ÏùÑ Í≤©Íµ≠ÏúºÎ°ú (Ìà¨Ï∂úÏù¥ ÏóÜÏúºÎ©¥ ÏõîÏßÄ Î≥∏Í∏∞ ÏÇ¨Ïö©)
    let finalGod = god.k;
    const emergentEntries = Object.entries(emergentGods);
    if (emergentEntries.length > 0) {
        // Í∞ÄÏû• ÎßéÏù¥ Ìà¨Ï∂úÎêú Í≤É ÏÑ†ÌÉù
        emergentEntries.sort((a,b) => b[1] - a[1]);
        finalGod = emergentEntries[0][0];
    }
    
    // Check Prime structure
    if (yangInGeonRok && yangInGeonRok.n.includes('Ëá®ÂÆò(Official)')) {
        return {...yangInGeonRok, type:'inner', god:'Ëá®ÂÆò(Official)'};
    }
    
    // 4. üî• ÏãùÏã†Ï†úÏÇ¥(È£üÁ•ûÂà∂ÊÆ∫) Íµ¨Ï°∞ Ï≤¥ÌÅ¨ - Gemini Round 6
    // Ìé∏Í¥Ä(Ïπ†ÏÇ¥)Ïù¥ 2Í∞ú Ïù¥ÏÉÅÏù¥Í≥†, ÏãùÏã†Ïù¥ 1Í∞ú Ïù¥ÏÉÅÏù¥Î©¥ = ÏãùÏã†Ï†úÏÇ¥
    let siksinJesal = false;
    const allPillarsForCheck = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
    let salCount = 0, sikCount = 0;
    allPillarsForCheck.forEach(p => {
        const stemGod = getTenGod(p.s, saju.day.s);
        if (stemGod.k === 'ÂÅèÂÆò(Challenger)') salCount++;
        if (stemGod.k === 'È£üÁ•û(Eating God)') sikCount++;
    });
    // ÏßÄÏßÄÏùò ÏßÄÏû•Í∞ÑÎèÑ Ï≤¥ÌÅ¨
    [saju.month.b, saju.hour?.b].filter(b => b).forEach(b => {
        const bi = BRANCH.findIndex(br => br.c === b.c);
        const jjList = HIDDEN_STEMS[bi] || [];
        jjList.forEach(jjItem => {
            const hiddenStem = STEM[jjItem.stem];
            const hiddenGod = getTenGod(hiddenStem, saju.day.s);
            if (hiddenGod.k === 'È£üÁ•û(Eating God)' && jjItem.days >= 10) sikCount++;
        });
    });
    
    if (salCount >= 2 && sikCount >= 1) {
        siksinJesal = true;
        // ÏãùÏã†Ï†úÏÇ¥Í≤©ÏúºÎ°ú Ïû¨Ï†ïÏùò
        return {
            n: 'Solving Structure (È£üÁ•ûÂà∂ÊÆ∫Ê†º)',
            d: 'The Crisis Manager. Your sharp skills (Eating God) neutralize overwhelming pressure (Challenger). You thrive in chaos where others crumble. Problem-solving, medicine, law, engineering, and turnaround consulting are your battlegrounds. Not a peaceful artist, but a surgeon with a scalpel.',
            b: 'Medicine, Law, Engineering, Consulting, Auditing, Crisis Management',
            lv: 'Excellent',
            god: 'È£üÁ•ûÂà∂ÊÆ∫',
            type: 'special',
            siksinJesal: true
        };
    }
    
    // 5. Check if structure is broken
    const breakReasons = isFormatBroken(saju, finalGod);
    
    // Convert key format: 'ÊØîËÇ© Peer' ‚Üí 'ÊØîËÇ©(Peer)'
    const formatKey = finalGod.replace(' ', '(') + ')';
    const f = FORMATS_INNER[formatKey] || FORMATS_INNER['Ê≠£ÂÆò(Direct Officer)'];
    return {
        ...f,
        god: finalGod,
        type: 'inner',
        broken: breakReasons.length > 0,
        breakReasons,
        tougan: monthGod.k !== god.k ? monthGod.k : null
    };
}

// Existing simple version (for compatibility)
function calcFormatSimple(saju) {
    const god = getTenGod(saju.month.s, saju.day.s);
    const f = FORMATS_INNER[god.k] || FORMATS_INNER['Ê≠£ÂÆò(Direct Officer)'];
    f.god = god.k;
    return f;
}

function getIljuDesc(ds, db) {
    // 60Í∞ëÏûê Day ÏÉÅÏÑ∏ Ìï¥ÏÑ§
    const iljuData = {
        'Áî≤Â≠ê':{t:'Áî≤Â≠êDay - Great tree above the ocean',d:'Rat Water nurtures Yang Wood - Brilliant mind with scholarly gifts. Intelligent and organized though sometimes prone to excessive worry. Night birth is especially favorable. Deep bond with spouse.',s:'Spouse is intellectual and supportive. Younger partners suit you. Water brings romantic encounters.'},
        'Áî≤ÂØÖ':{t:'Áî≤ÂØÖDay - Tree riding a tiger',d:'Same element as Day Branch brings strong pride and independence. Firstborn qualities with leadership potential. Stubborn and competitive nature.',s:'Spouse also has strong pride ‚Äî expect clashes. Mutual compromise is essential.'},
        'Áî≤Ëæ∞':{t:'Áî≤Ëæ∞Day - Tree ascending on a dragon',d:'Dragon Earth roots the Wood, bringing abundant talent. Great ambition with desire for success. Scholar star energy grants academic prowess and social recognition.',s:'Spouse is reliable with wealth fortune. Good compatibility with Rabbit and Rooster signs.'},
        'Áî≤Âçà':{t:'Áî≤ÂçàDay - Tree standing tall under the sun',d:'Wood creates Fire bringing talent to bloom. Glamorous with exceptional artistic sense. Quick-tempered, passionate, and popular.',s:'Spouse is lively and sociable. Fiery temperaments may clash ‚Äî mutual respect is key.'},
        'Áî≤Áî≥':{t:'Áî≤Áî≥Day - Tree struck by an axe',d:'Metal controls Wood bringing trials but overcoming makes you stronger. Develops decisiveness, drive, and resilience. Career fortune is present.',s:'Conflicts with spouse may arise. Accept differences and show consideration.'},
        'Áî≤Êàå':{t:'Áî≤ÊàåDay - Tree on autumn mountain',d:'Dog Earth contains Metal attacking Wood bringing solitude. Artistic talent with interest in religion and philosophy. Late bloomer type.',s:'Late marriage likely. Guard against separation.'},
        '‰πô‰∏ë':{t:'‰πô‰∏ëDay - Small grass in winter soil',d:'Ox Earth roots the Tiger Wood bringing persistence. Diligent, realistic, steadily accumulates wealth. May be introverted and passive.',s:'Spouse is dependable and financially stable.'},
        '‰πôÂçØ':{t:'‰πôÂçØDay - Spring flower',d:'Same element brings clear personal principles. Delicate, artistic, and popular. Gentle appearance hides stubborn nature.',s:'Spouse shares similar traits. With mutual respect, a blessed union.'},
        '‰πôÂ∑≥':{t:'‰πôÂ∑≥Day - Flower bathed in sunlight',d:'Wood creates Fire releasing talents. Brilliant speaker with great social skills. Popular with the opposite sex and blessed with romantic fortune.',s:'Spouse is passionate and fiery. Guard against infidelity!'},
        '‰πôÊú™':{t:'‰πôÊú™Day - Garden flower in summer',d:'Wood controls Earth bringing business acumen. Artistic sense with investment ability. Especially favorable Day for women.',s:'Spouse is gentle and family-oriented. Wealth grows after marriage.'},
        '‰πôÈÖâ':{t:'‰πôÈÖâDay - Flower touched by autumn frost',d:'Metal controls Wood bringing trials but patience brings success. Sharp and critical with strong potential for professional success.',s:'Conflicts with spouse may arise. Effort to harmonize is essential.'},
        '‰πô‰∫•':{t:'‰πô‰∫•Day - Duckweed floating on water',d:'Water nurtures Wood bringing abundant talent. Wise and scholarly with easy access to noble helpers. Flexible and adaptable nature.',s:'Spouse is intelligent with strong life skills.'},
        '‰∏ôÂ≠ê':{t:'‰∏ôÂ≠êDay - Sun in the night sky',d:'Water controls Fire bringing trials but inner strength prevails. Duality like warm sun reflected in cold water.',s:'Personality differences with spouse may arise. Complementing each other creates blessed union.'},
        '‰∏ôÂØÖ':{t:'‰∏ôÂØÖDay - Sun rising from the east',d:'Wood creates Fire making talents shine. Bright and energetic with leadership. Like morning sun brings hope and energy.',s:'Spouse is solid and dependable. Excellent spousal support awaits.'},
        '‰∏ôËæ∞':{t:'‰∏ôËæ∞Day - Sun above the clouds',d:'Dragon Earth channels Fire energy for talent expression. Great ambition with strong potential for social success.',s:'Spouse brings stability and wealth fortune.'},
        '‰∏ôÂçà':{t:'‰∏ôÂçàDay - Midday sun',d:'Fire energy peaks bringing passion and vitality. Quick-tempered with a strong competitive drive. Leadership qualities present.',s:'Spouse also has a fiery personality. Arguments happen but love burns passionate.'},
        '‰∏ôÁî≥':{t:'‰∏ôÁî≥Day - Evening sunset',d:'Fire controls Metal bringing financial acumen. Good business sense with wealth fortune. Type that improves in later years.',s:'Spouse is talented and earns well.'},
        '‰∏ôÊàå':{t:'‰∏ôÊàåDay - Bonfire on the mountain',d:'Dog Earth channels Fire bringing stability. Careful, responsible, and trusted. Strong interest in religion and philosophy.',s:'Spouse is solid and trustworthy. Late marriage may be favorable.'},
        '‰∏Å‰∏ë':{t:'‰∏Å‰∏ëDay - Candlelight',d:'Ox Earth channels Fire bringing calm. Introverted but warm-hearted. Steady effort type.',s:'Spouse is diligent and family-oriented. Stable married life awaits.'},
        '‰∏ÅÂçØ':{t:'‰∏ÅÂçØDay - Firefly in the forest',d:'Wood creates Fire bringing exceptional talent. Artistic sense with delicate nature. Easy to receive help from noble ones.',s:'Spouse is affectionate and artistic.'},
        '‰∏ÅÂ∑≥':{t:'‰∏ÅÂ∑≥Day - Blazing candle',d:'Strong Fire energy brings passion. Good focus, potential for success in one field. May have quick temper.',s:'Spouse is passionate and dynamic.'},
        '‰∏ÅÊú™':{t:'‰∏ÅÊú™Day - Evening sunset',d:'Fire creates Earth bringing children fortune. Warm and embracing nature caring for others. Strong interest in religion and service.',s:'Spouse is gentle and family-oriented.'},
        '‰∏ÅÈÖâ':{t:'‰∏ÅÈÖâDay - Flame that melts jewels',d:'Fire controls Metal bringing ability to handle wealth. Good with hands suited for technical work. Particular and perfectionist.',s:'Spouse is talented but personalities may clash.'},
        '‰∏Å‰∫•':{t:'‰∏Å‰∫•Day - Lighthouse over the sea',d:'Water controls Fire bringing trials but you bring hope to others. Wise with deep thoughts.',s:'Personality differences with spouse may arise.'},
        'ÊàäÂ≠ê':{t:'ÊàäÂ≠êDay - Embankment by the water',d:'Earth controls Water bringing wealth acquisition. Good business sense with wealth fortune. Realistic with quick calculations.',s:'Spouse is intelligent with strong vitality.'},
        'ÊàäÂØÖ':{t:'ÊàäÂØÖDay - Mountain in the forest',d:'Wood controls Earth but roots embrace the mountain. Blessed with virtue and noble helpers. scholarly talent present.',s:'Spouse is astute and resourceful.'},
        'ÊàäËæ∞':{t:'ÊàäËæ∞Day - Mountain where a dragon dwells',d:'Strong Earth energy brings reliability and trust. Great ambition with desire for success. Wealth and career fortune present.',s:'Spouse is trustworthy and stable.'},
        'ÊàäÂçà':{t:'ÊàäÂçàDay - Earth bathed in sunlight',d:'Fire creates Earth overflowing with energy. Active social and popular. Easy early success.',s:'Spouse is bright and energetic.'},
        'ÊàäÁî≥':{t:'ÊàäÁî≥Day - Mountain of minerals',d:'Earth creates Metal bringing wealth creation ability. Good business sense with investment ability. Practical and realistic.',s:'Spouse is brilliant and capable.'},
        'ÊàäÊàå':{t:'ÊàäÊàåDay - Tall mountain',d:'Earth energy peaks bringing stubbornness and determination. Once decided follows through to the end.',s:'May have stubbornness battles with spouse. Compromise is essential.'},
        'Â∑±‰∏ë':{t:'Â∑±‰∏ëDay - Fertile farmland',d:'Double Earth energy brings stability and steadiness. Real estate fortune with good saving habits.',s:'Spouse is diligent and family-oriented.'},
        'Â∑±ÂçØ':{t:'Â∑±ÂçØDay - Soil of the garden',d:'Wood controls Earth but like good soil nurturing flowers. Good children fortune with virtuous nature.',s:'Spouse is astute and resourceful.'},
        'Â∑±Â∑≥':{t:'Â∑±Â∑≥Day - Warm earth',d:'Fire creates Earth bringing noble helpers. Brilliant with many talents. Popular with great social fortune.',s:'Spouse is bright and lively.'},
        'Â∑±Êú™':{t:'Â∑±Êú™Day - Summer garden',d:'Double Earth energy brings steadiness. Good real estate fortune with comfortable later years.',s:'Spouse is gentle and family-oriented.'},
        'Â∑±ÈÖâ':{t:'Â∑±ÈÖâDay - Autumn field',d:'Earth creates Metal bringing wealth creation ability. Talented with artistic sense. Harvest time fortune.',s:'Spouse is brilliant and capable.'},
        'Â∑±‰∫•':{t:'Â∑±‰∫•Day - Embankment by the water',d:'Earth controls Water bringing wealth acquisition. Wise with quick calculations. Business acumen fortune.',s:'Spouse has strong life skills.'},
        'Â∫öÂ≠ê':{t:'Â∫öÂ≠êDay - Rock in winter sea',d:'Metal creates Water bringing exceptional wisdom. Intelligent with scholarly talent present. Cool and analytical.',s:'Spouse is intellectual and brilliant.'},
        'Â∫öÂØÖ':{t:'Â∫öÂØÖDay - Rock in the forest',d:'Metal controls Wood bringing financial acumen. Decisive with strong drive.',s:'May clash with spouse. Mutual compromise needed.'},
        'Â∫öËæ∞':{t:'Â∫öËæ∞Day - Swordsman riding a dragon',d:'Earth creates Metal bringing noble helpers. Career fortune with strong potential for social success.',s:'Spouse is trustworthy and solid.'},
        'Â∫öÂçà':{t:'Â∫öÂçàDay - Iron forged in fire',d:'Fire forges Metal making you stronger. Overcoming trials brings great success.',s:'Spouse is lively but conflicts may arise.'},
        'Â∫öÁî≥':{t:'Â∫öÁî≥Day - Steel',d:'Metal energy peaks bringing strength. Excellent decisiveness and execution. Warrior qualities present.',s:'Spouse also has a strong personality. Mutual respect is essential.'},
        'Â∫öÊàå':{t:'Â∫öÊàåDay - Ore within the mountain',d:'Earth creates Metal with deep roots. Late bloomer but achieves great success.',s:'Spouse is dependable and stable.'},
        'Ëæõ‰∏ë':{t:'Ëæõ‰∏ëDay - Gem beneath the earth',d:'Earth creates Metal with precious talent hidden. Late recognition but shines in the end.',s:'Spouse is diligent and family-oriented.'},
        'ËæõÂçØ':{t:'ËæõÂçØDay - Jewel hanging on a tree',d:'Metal controls Wood bringing financial acumen. Delicate with artistic sense.',s:'Spouse is affectionate but conflicts may arise.'},
        'ËæõÂ∑≥':{t:'ËæõÂ∑≥Day - Metal in the furnace',d:'Fire forges Metal through refinement. Overcoming trials makes you a shining jewel. Supported by noble helpers.',s:'Spouse is passionate but clashes may occur.'},
        'ËæõÊú™':{t:'ËæõÊú™Day - Dew on summer grass',d:'Earth creates Metal bringing stability. Artistic sense with rich emotions.',s:'Spouse is gentle and family-oriented.'},
        'ËæõÈÖâ':{t:'ËæõÈÖâDay - Perfect jewel',d:'Double Metal energy brings sharpness. Perfectionist with excellent aesthetic sense. artistic and technical talent present.',s:'Spouse may also be particular. Effort to harmonize is essential.'},
        'Ëæõ‰∫•':{t:'Ëæõ‰∫•Day - Pearl in the ocean',d:'Metal creates Water with wisdom flowing. Brilliant with rich emotions. exceptional artistic talent present.',s:'Spouse is intellectual and emotional.'},
        'Â£¨Â≠ê':{t:'Â£¨Â≠êDay - Deep ocean',d:'Water energy peaks bringing deep wisdom. Brilliant mind with scholarly talent present.',s:'Spouse is brilliant. Deep conversations are possible.'},
        'Â£¨ÂØÖ':{t:'Â£¨ÂØÖDay - Spring rain',d:'Water nurtures Wood reviving all things. Virtuous nature who loves giving. Receives help from noble ones.',s:'Spouse is solid and capable.'},
        'Â£¨Ëæ∞':{t:'Â£¨Ëæ∞Day - Water where a dragon dwells',d:'Earth blocks Water but dragon rides water to ascend. Great ambition with career fortune.',s:'Spouse is reliable with wealth fortune.'},
        'Â£¨Âçà':{t:'Â£¨ÂçàDay - Summer shower',d:'Water controls Fire bringing trials but inner strength prevails. Emotional fluctuations possible.',s:'Different personalities but complement well.'},
        'Â£¨Áî≥':{t:'Â£¨Áî≥Day - Valley stream',d:'Metal creates Water bringing clarity and brilliance. Intelligent with exceptional technical talent. eloquent speaking ability present.',s:'Spouse is brilliant and capable.'},
        'Â£¨Êàå':{t:'Â£¨ÊàåDay - Water blocked by a dam',d:'Earth blocks Water but eventually breaks through. Patience brings great success.',s:'Conflicts with spouse may arise.'},
        'Áô∏‰∏ë':{t:'Áô∏‰∏ëDay - Frozen spring',d:'Ox Earth hides Water energy within. Quiet but thinks deeply. Late bloomer type.',s:'Spouse is diligent and family-oriented.'},
        'Áô∏ÂçØ':{t:'Áô∏ÂçØDay - Morning dew',d:'Water nurtures Wood growing all things. Virtuous with children fortune. Delicate and emotional.',s:'Spouse is affectionate and artistic.'},
        'Áô∏Â∑≥':{t:'Áô∏Â∑≥Day - Hot steam',d:'Water controls Fire bringing many changes. Good adaptability with quick judgment.',s:'Spouse is active and passionate.'},
        'Áô∏Êú™':{t:'Áô∏Êú™Day - Summer evening rain',d:'Earth controls Water but moistens the earth. Embracing nature caring for others.',s:'Spouse is gentle and family-oriented.'},
        'Áô∏ÈÖâ':{t:'Áô∏ÈÖâDay - Clear spring water',d:'Metal creates Water bringing brilliance and artistry. Excellent aesthetic sense with intuitive fortune.',s:'Spouse is delicate and artistic.'},
        'Áô∏‰∫•':{t:'Áô∏‰∫•Day - Deep ocean',d:'Water energy peaks bringing deep wisdom. Excellent intuition with spiritual side.',s:'Spouse is intellectual. Deep conversations possible.'}
    };
    
    const key = ds.c + db.c;
    if (iljuData[key]) {
        return { title: iljuData[key].t, desc: iljuData[key].d, spouse: iljuData[key].s };
    }
    
    // Default interpretation (if no data)
    const stemDesc = {'Áî≤':'progressive and leadership-oriented','‰πô':'flexible and adaptable','‰∏ô':'bright and passionate','‰∏Å':'warm and delicate','Êàä':'reliable and stable','Â∑±':'embracing and realistic','Â∫ö':'decisive and strong','Ëæõ':'delicate and sensitive','Â£¨':'wise and fluid','Áô∏':'intuitive and emotional'};
    const branchTrait = ['active','diligent','progressive','delicate','flexible','clever','passionate','devoted','confident','stylish','loyal','wise'];
    return { 
        title: `${ds.c}${db.c} Day`, 
        desc: `You have a ${stemDesc[ds.c]} personality. The ${ELEMENT[ds.e].n}(${ds.c}) Day Master sitting on ${db.c}(${db.m}) gives you an inherently ${branchTrait[BRANCH.findIndex(br => br.c === db.c)]} nature.`, 
        spouse: `Your spouse may be ${branchTrait[BRANCH.findIndex(br => br.c === db.c)]} like the ${db.m}. Good connections possible in ${db.m} years.` 
    };
}

/* ========================================
   11. Â§ßÈÅã(Life Cycle)
   ======================================== */
function calcLuck(saju, birthYear, gender, gods) {
    const isYang = saju.year.s.y;
    const isMale = gender === 'm';
    const forward = (isYang && isMale) || (!isYang && !isMale);
    const periods = [];
    const msi = STEM.indexOf(saju.month.s);
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    const curYear = new Date().getFullYear();
    const curAge = curYear - birthYear;
    
    for (let i = 0; i < 10; i++) {
        const si = forward ? (msi + i + 1) % 10 : (msi - i - 1 + 10) % 10;
        const bi = forward ? (mbi + i + 1) % 12 : (mbi - i - 1 + 12) % 12;
        const age = 3 + i * 10;
        const isCur = curAge >= age && curAge < age + 10;
        const s = STEM[si], b = BRANCH[bi];
        
        let score = 0;
        let climateClash = false;
        
        if ([s.e, b.e].includes(gods.yong)) score += 2;
        if ([s.e, b.e].includes(gods.hee)) score += 1;
        if ([s.e, b.e].includes(gods.gi)) score -= 2;
        
        // üî• Ï°∞ÌõÑ Ïó≠Ïö¥ Ï≤¥ÌÅ¨ (Climate Clash) - Gemini feedback
        if (gods.climate) {
            const daeunEls = [s.e, b.e];
            // v4.12.6: ÏÉà Ï°∞ÌõÑ ÌÉÄÏûÖÏóê ÎßûÍ≤å ÏàòÏ†ï
            // Ï°∞Ïó¥/ÏóºÏó¥ + Fire ÎåÄÏö¥ = penalty (Îú®Í±∞Ïö¥Îç∞ Îçî Îú®Í±∞ÏõÄ)
            if ((gods.climate.type.includes('Ï°∞Ïó¥') || gods.climate.type.includes('ÏóºÏó¥')) && 
                daeunEls.filter(e => e === 'fire').length >= 1) {
                score -= 2;
                climateClash = true;
            }
            // Í∑πÌïú/ÌïúÎÉâ/ÌïúÏäµ/ÎÉâÏ∂î + Water ÎåÄÏö¥ = penalty (Ï∂îÏö¥Îç∞ Îçî Ï∂îÏõÄ)
            if ((gods.climate.type.includes('Í∑πÌïú') || gods.climate.type.includes('ÌïúÎÉâ') || 
                 gods.climate.type.includes('ÌïúÏäµ') || gods.climate.type.includes('ÎÉâÏ∂î')) && 
                daeunEls.filter(e => e === 'water').length >= 1) {
                score -= 2;
                climateClash = true;
            }
        }
        
        periods.push({ s, b, startAge: age, endAge: age + 9, isCur, climateClash, rating: score >= 2 ? 'good' : score <= -1 ? 'bad' : 'neutral', score });
    }
    return periods;
}

/* ========================================
   11-2. Â§ßÈÅã(Life Cycle)/Ê≠≤ÈÅã(Annual Fortune)/Monthly Fortune ÍµêÏ∞® Î∂ÑÏÑù
   ======================================== */
   
// Calculate Annual Fortune for specific year
/* ========================================
   11-2. YEAR LUCK ANALYSIS (Ê≠≤ÈÅã) - v4.0 Refactored
   Modularized with CONFIG + Helper Functions
   ======================================== */

// ===== YEAR LUCK CONFIGURATION =====
const YEAR_LUCK_CONFIG = {
    // Ï≤úÍ∞ÑÌï© (Áî≤Â∑±ÂêàÂúü, ‰πôÂ∫öÂêàÈáë, ‰∏ôËæõÂêàÊ∞¥, ‰∏ÅÂ£¨ÂêàÊú®, ÊàäÁô∏ÂêàÁÅ´)
    stemCombineMap: [[0,5,'earth'],[1,6,'metal'],[2,7,'water'],[3,8,'wood'],[4,9,'fire']],
    // Ïú°Ìï© (Â≠ê‰∏ë, ÂØÖ‰∫•, ÂçØÊàå, Ëæ∞ÈÖâ, Â∑≥Áî≥, ÂçàÊú™)
    branchCombineMap: [[0,1,'earth'],[2,11,'wood'],[3,10,'fire'],[4,9,'metal'],[5,8,'water'],[6,7,'fire']],
    // Ïú°Ìï¥ (Â≠êÊú™, ‰∏ëÂçà, ÂØÖÂ∑≥, ÂçØËæ∞, Áî≥‰∫•, ÈÖâÊàå)
    harmPairs: [[0,7],[1,6],[2,5],[3,4],[8,11],[9,10]],
    // ÏûêÌòï (Ëæ∞Ëæ∞, ÂçàÂçà, ÈÖâÈÖâ, ‰∫•‰∫•)
    selfPunishBranches: [4, 6, 9, 11],
    // Ïò§Ìñâ ÏÉÅÍ∑π
    keMap: {wood:'earth', earth:'water', water:'fire', fire:'metal', metal:'wood'},
    // ÏÇºÌï©
    samhapPatterns: [[2,6,10,'fire'],[8,0,4,'water'],[5,9,1,'metal'],[11,3,7,'wood']],
    // ÏñëÏù∏ ÏúÑÏπò
    yanginBranches: {
        'wood+':3,'wood-':2,'fire+':6,'fire-':5,'earth+':6,'earth-':5,
        'metal+':9,'metal-':8,'water+':0,'water-':11
    }
};

// ===== YEAR LUCK HELPER FUNCTIONS =====

// Ïö©Ïã†/Í∏∞Ïã† Í∏∞Î≥∏ Ï†êÏàò
function ylCheckYongGi(yp, gods) {
    let score = 0;
    if ([yp.s.e, yp.b.e].includes(gods.yong)) score += 3;
    if ([yp.s.e, yp.b.e].includes(gods.hee)) score += 2;
    if ([yp.s.e, yp.b.e].includes(gods.gi)) score -= 3;
    return { score };
}

// Ïö©Ïã† ÌîºÍ≥µÍ≤©
function ylCheckYongAttack(yp, gods) {
    const { keMap } = YEAR_LUCK_CONFIG;
    let active = false, desc = '', score = 0;
    [yp.s.e, yp.b.e].forEach(ye => {
        if (keMap[ye] === gods.yong) {
            active = true; score = -4;
            desc = `‚ö†Ô∏è BENEFICIAL ELEMENT UNDER ATTACK! ${ELEMENT[ye].n.toUpperCase()} destroys your ${ELEMENT[gods.yong].n} (${ye}ÂÖã${gods.yong}). Preserve, don't expand!`;
        }
    });
    return { active, desc, score };
}

// Íµ∞Í≤ÅÏüÅÏû¨
function ylCheckRobWealth(yp, saju, gods, strength) {
    const god = getTenGod(yp.s, saju.day.s);
    const isPeer = ['ÊØîËÇ©(Peer)', 'Âä´Ë≤°(Competitor)'].includes(god.k);
    if (strength.type === 'strong' && isPeer) {
        return { active: true, score: -3, desc: `‚öîÔ∏è ROBBERY WARNING (Áæ§Âä´Áà≠Ë≤°)! Strong chart + Peer year = Competitors steal wealth. Avoid partnerships.` };
    }
    return { active: false, score: 0, desc: '' };
}

// ÏÉÅÍ¥ÄÍ≤©+ÎπÑÍ≤ÅÏö¥
function ylCheckExpressorPeer(yp, saju, strength) {
    const god = getTenGod(yp.s, saju.day.s);
    const isPeer = ['ÊØîËÇ©(Peer)', 'Âä´Ë≤°(Competitor)'].includes(god.k);
    try {
        const format = calcFormat(saju, strength);
        if (format.god && (format.god.includes('ÂÇ∑ÂÆò') || format.god.includes('Expressor')) && isPeer) {
            return { active: true, score: -2, desc: `‚ö†Ô∏è REBEL + BAD FRIENDS (ÂÇ∑ÂÆò+ÊØîÂä´): High lawsuit risk! Channel energy into CREATION only.` };
        }
    } catch(e) {}
    return { active: false, score: 0, desc: '' };
}

// Ï°∞ÌõÑ Ïó≠Ïö¥
function ylCheckClimateClash(yp, gods) {
    if (!gods.climate) return { active: false, score: 0, desc: '' };
    const yearEls = [yp.s.e, yp.b.e];
    const climate = gods.climate.type;
    // v4.12.6: ÏÉà Ï°∞ÌõÑ ÌÉÄÏûÖÏóê ÎßûÍ≤å ÏàòÏ†ï
    if ((climate.includes('Ï°∞Ïó¥') || climate.includes('ÏóºÏó¥')) && yearEls.includes('fire')) {
        return { active: true, score: -(yearEls.filter(e => e === 'fire').length * 3), desc: 'Îú®Í±∞Ïö¥ ÏÇ¨Ï£ºÏóê ÁÅ´Í∞Ä ÎçîÌï¥Ï†∏ Ï°∞Ïó¥ Ïã¨Ìôî! Í±¥Í∞ï/Ïû¨Î¨º Ï£ºÏùò.' };
    }
    if ((climate.includes('Í∑πÌïú') || climate.includes('ÌïúÎÉâ') || climate.includes('ÌïúÏäµ') || climate.includes('ÎÉâÏ∂î')) && yearEls.includes('water')) {
        return { active: true, score: -(yearEls.filter(e => e === 'water').length * 3), desc: 'Ï∂îÏö¥ ÏÇ¨Ï£ºÏóê Ê∞¥Í∞Ä ÎçîÌï¥Ï†∏ ÌïúÍ∏∞ Ïã¨Ìôî! Ïö∞Ïö∏Ï¶ù/ÎÉâÏ¶ù Ï£ºÏùò.' };
    }
    return { active: false, score: 0, desc: '' };
}

// ÏÇºÌï© ÌòïÏÑ±
function ylCheckBureau(yp, saju) {
    const { samhapPatterns } = YEAR_LUCK_CONFIG;
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
    const allBr = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), BRANCH.findIndex(br => br.c === saju.day.b.c)];
    if (saju.hour) allBr.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    
    for (const [a, b, c, el] of samhapPatterns) {
        if (ypBi === b && allBr.includes(a) && allBr.includes(c)) {
            return { active: true, score: 3, element: el, desc: `üî• ${BRANCH[a].c}${BRANCH[b].c}${BRANCH[c].c} ${ELEMENT[el].n} Bureau formed! Clash NEUTRALIZED.` };
        }
        if ((ypBi === a || ypBi === c) && allBr.includes(b) && ((ypBi === a) ? allBr.includes(c) : allBr.includes(a))) {
            return { active: true, score: 3, element: el, desc: `üî• ${BRANCH[a].c}${BRANCH[b].c}${BRANCH[c].c} ${ELEMENT[el].n} Bureau formed!` };
        }
    }
    return { active: false, score: 0, element: null, desc: '' };
}

// ÏõîÏßÄÏ∂©
function ylCheckMonthClash(yp, saju, bureauFormed) {
    if (bureauFormed) return { active: false, score: 0, desc: '' };
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c), mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    if (Math.abs(ypBi - mbi) === 6) {
        const wang = [0, 3, 6, 9];
        const isWang = wang.includes(ypBi) && wang.includes(mbi);
        return { active: true, score: isWang ? -4 : -2, desc: `${yp.b.c}‚Üî${saju.month.b.c} CLASH! Career/social turbulence.` };
    }
    return { active: false, score: 0, desc: '' };
}

// ÏùºÏßÄÏ∂©
function ylCheckDayClash(yp, saju) {
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c), dbi = BRANCH.findIndex(br => br.c === saju.day.b.c);
    if (Math.abs(ypBi - dbi) === 6) {
        return { active: true, desc: `${yp.b.c}‚Üî${saju.day.b.c} CLASH attacks Day Branch (Spouse/Self)!` };
    }
    return { active: false, desc: '' };
}

// ÏñëÏù∏Ï∂©
function ylCheckYanginClash(yp, saju) {
    const { yanginBranches } = YEAR_LUCK_CONFIG;
    const dm = saju.day.s, dmKey = dm.e + (dm.p ? '+' : '-');
    const yanginIdx = yanginBranches[dmKey];
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c), dbi = BRANCH.findIndex(br => br.c === saju.day.b.c);
    if (dbi === yanginIdx && Math.abs(ypBi - dbi) === 6) {
        return { active: true, desc: `‚öîÔ∏è SHEEP BLADE CLASH (Ê≤ñÁæäÂàÉ)! High Risk High Return - Surgery OR windfall.` };
    }
    return { active: false, desc: '' };
}

// ÏÇºÏ§ëÏ≤©
function ylCheckTripleBranch(yp, saju) {
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
    const allBr = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), BRANCH.findIndex(br => br.c === saju.day.b.c)];
    if (saju.hour) allBr.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    const cnt = allBr.filter(b => b === ypBi).length;
    if (cnt >= 1) {
        const clash = (ypBi + 6) % 12;
        if (allBr.includes(clash)) {
            return { active: true, target: yp.b, desc: `${yp.b.c} energy DOUBLED! ${BRANCH[clash].c} overwhelmed (${cnt + 1}:1 attack).` };
        }
    }
    return { active: false, target: null, desc: '' };
}

// ÌÜµÍ¥Ä Î∂ÄÏû¨
function ylCheckMissingBridge(yp, saju, gods) {
    const elCount = {};
    [saju.year.s.e, saju.year.b.e, saju.month.s.e, saju.month.b.e, saju.day.s.e, saju.day.b.e].forEach(e => elCount[e] = (elCount[e]||0)+1);
    if (saju.hour) { elCount[saju.hour.s.e] = (elCount[saju.hour.s.e]||0)+1; elCount[saju.hour.b.e] = (elCount[saju.hour.b.e]||0)+1; }
    
    if ((elCount['water']||0) >= 3 && gods.yong === 'fire' && !(elCount['wood']||0) && [yp.s.e, yp.b.e].includes('fire')) {
        return { active: true, desc: `üåäüî• WATER-FIRE WAR without Bridge! No Wood to mediate. Remedy: Add Wood activities.` };
    }
    if ((elCount['metal']||0) >= 3 && gods.yong === 'fire' && !(elCount['earth']||0) && [yp.s.e, yp.b.e].includes('fire')) {
        return { active: true, desc: `‚öîÔ∏èüî• METAL-FIRE WAR without Bridge! No Earth to mediate.` };
    }
    return { active: false, desc: '' };
}

// Ï≤úÍ∞ÑÌï©
function ylCheckStemCombine(yp, saju, gods) {
    const { stemCombineMap } = YEAR_LUCK_CONFIG;
    const ypSi = STEM.indexOf(yp.s);
    const allSi = [STEM.indexOf(saju.year.s), STEM.indexOf(saju.month.s), STEM.indexOf(saju.day.s)];
    if (saju.hour) allSi.push(STEM.indexOf(saju.hour.s));
    
    for (const [a, b, resEl] of stemCombineMap) {
        if (ypSi === a || ypSi === b) {
            const tgt = ypSi === a ? b : a;
            if (allSi.includes(tgt)) {
                const tgtStem = STEM[tgt], myGod = getTenGod(tgtStem, saju.day.s);
                const ypGod = getTenGod(yp.s, saju.day.s);
                let desc = `üîó ${yp.s.c}+${tgtStem.c} COMBINE ‚Üí ${ELEMENT[resEl].n}.`;
                let score = 0;
                
                // üî• Ï≤úÍ∞ÑÌï© Î∞∞Ïã† ÏãúÎÇòÎ¶¨Ïò§ - Gemini Round 10
                // ÎπÑÍ≤Å(Ï°∞Î†•Ïûê)Ïù¥ Ïû¨ÏÑ±(Îèà)Í≥º Ìï©ÌïòÏó¨ Í¥ÄÏÑ±(ÏïïÎ∞ï)ÏúºÎ°ú Î≥ÄÌïòÎ©¥ Î∞∞Ïã†
                const isPeer = ['ÊØîËÇ©(Peer)', 'Âä´Ë≤°(Competitor)'].includes(ypGod.k);
                const isWealth = ['ÂÅèË≤°(Indirect Wealth)', 'Ê≠£Ë≤°(Direct Wealth)'].includes(myGod.k);
                const resultIsGi = resEl === gods.gi;
                const resultIsGwan = ['water', 'earth'].includes(resEl) && 
                    ((saju.day.s.e === 'fire' && resEl === 'water') || 
                     (saju.day.s.e === 'wood' && resEl === 'metal'));
                
                if (isPeer && isWealth && resultIsGi) {
                    desc = `‚ö†Ô∏è ${yp.s.c}+${tgtStem.c} COMBINE ‚Üí ${ELEMENT[resEl].n} (BETRAYAL): Your helper (${ypGod.k}) meets your wealth (${myGod.k}) and transforms into PRESSURE. Trust no one with money this year. Reject partnership offers.`;
                    score = -2;
                } else if (resultIsGi) {
                    desc = `‚ö†Ô∏è ${yp.s.c}+${tgtStem.c} COMBINE ‚Üí ${ELEMENT[resEl].n} (ÂøåÁ•û): Combine creates unfavorable element. Hidden sabotage.`;
                    score = -1;
                } else if (yp.s.e === gods.yong && ['È£üÁ•û(Eating God)', 'ÂÇ∑ÂÆò(Expressor)'].includes(myGod.k)) {
                    desc = `üîó ${yp.s.c}+${tgtStem.c} COMBINE (ÁæàÁµÜ): Promotion comes but freedom decreases. Golden handcuffs.`;
                    score = 1;
                }
                return { active: true, from: yp.s, to: tgtStem, result: resEl, targetGod: myGod.k, desc, score };
            }
        }
    }
    return { active: false, from: null, to: null, result: null, targetGod: null, desc: '', score: 0 };
}

// Ïú°Ìï©
function ylCheckBranchCombine(yp, saju, gods, strength) {
    const { branchCombineMap } = YEAR_LUCK_CONFIG;
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
    const allBr = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), BRANCH.findIndex(br => br.c === saju.day.b.c)];
    if (saju.hour) allBr.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    
    for (const [a, b, resEl] of branchCombineMap) {
        if (ypBi === a || ypBi === b) {
            const tgt = ypBi === a ? b : a;
            if (allBr.includes(tgt)) {
                const tgtBr = BRANCH[tgt];
                let desc = `ü§ù ${yp.b.c}+${tgtBr.c} COMBINE ‚Üí ${ELEMENT[resEl].n}.`;
                let score = 0;
                
                // üî• Ïã†Í∞ï/Ïã†ÏïΩÏóê Îî∞Î•∏ Ìï©Ïùò Í∏∏Ìùâ ÌåêÎã® - Gemini Round 9
                const isWeak = strength && strength.pct < 30;
                const combineIsGi = resEl === gods.gi;  // Ìï©Ìôî Í≤∞Í≥ºÍ∞Ä Í∏∞Ïã†Ïù¥Î©¥
                const combineIsYong = resEl === gods.yong;  // Ìï©Ìôî Í≤∞Í≥ºÍ∞Ä Ïö©Ïã†Ïù¥Î©¥
                
                if (saju.hour && BRANCH.findIndex(br => br.c === saju.hour.b.c) === tgt) {
                    if (isWeak && combineIsGi) {
                        // Ïã†ÏïΩÏù∏Îç∞ Í∏∞Ïã†ÏúºÎ°ú Ìï©Ìôî = ÏúÑÌóò
                        desc = `‚ö†Ô∏è ${yp.b.c}+${tgtBr.c} COMBINE ‚Üí ${ELEMENT[resEl].n}! WARNING: Weak chart but combine strengthens unfavorable element. Late-life/children axis under pressure. Health warning for kidneys/reproductive system.`;
                        score = -2;
                    } else if (combineIsYong) {
                        desc = `ü§ù ${yp.b.c}+${tgtBr.c} COMBINE ‚Üí ${ELEMENT[resEl].n}! Hour branch strengthened with Beneficial Element. Late-life foundation solidified.`;
                        score = 2;
                    } else {
                        desc = `ü§ù ${yp.b.c}+${tgtBr.c} COMBINE ‚Üí ${ELEMENT[resEl].n}! Hour branch strengthened.`;
                        score = 1;
                    }
                } else if (BRANCH.findIndex(br => br.c === saju.day.b.c) === tgt) {
                    if (isWeak && combineIsGi) {
                        desc = `‚ö†Ô∏è ${yp.b.c}+${tgtBr.c} COMBINE ‚Üí ${ELEMENT[resEl].n}! Spouse Palace transforms to unfavorable element. Relationship stress.`;
                        score = -1;
                    } else {
                        desc = `ü§ù ${yp.b.c}+${tgtBr.c} COMBINE ‚Üí ${ELEMENT[resEl].n}! Spouse Palace harmonized.`;
                        score = 1;
                    }
                }
                return { active: true, from: yp.b, to: tgtBr, result: resEl, desc, score };
            }
        }
    }
    return { active: false, from: null, to: null, result: null, desc: '', score: 0 };
}

// ÏûêÌòï
function ylCheckSelfPunishment(yp, saju) {
    const { selfPunishBranches } = YEAR_LUCK_CONFIG;
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
    if (!selfPunishBranches.includes(ypBi)) return { active: false, desc: '' };
    
    const allBr = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), BRANCH.findIndex(br => br.c === saju.day.b.c)];
    if (saju.hour) allBr.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    if (allBr.filter(b => b === ypBi).length < 1) return { active: false, desc: '' };
    
    const bn = yp.b.c;
    const descMap = {
        11: `üòî ${bn}${bn} SELF-PUNISHMENT: Doubled Water = depression, overthinking.`,
        6: `üî• ${bn}${bn} SELF-PUNISHMENT: Doubled Fire = impulsiveness, burnout.`,
        9: `‚ö†Ô∏è ${bn}${bn} SELF-PUNISHMENT: Doubled Metal = obsessive perfectionism.`,
        4: `‚ö†Ô∏è ${bn}${bn} SELF-PUNISHMENT: Doubled Earth = stubbornness.`
    };
    return { active: true, desc: descMap[ypBi] || `‚ö†Ô∏è ${bn}${bn} SELF-PUNISHMENT.` };
}

// ÏÉâÎÇú Í≤ΩÍ≥†
function ylCheckScandal(yp, saju) {
    if (!saju.hour) return { active: false, score: 0, desc: '' };
    const dm = saju.day.s;
    const hourGod = getTenGod(saju.hour.s, dm), ypGod = getTenGod(yp.s, dm);
    if (hourGod.k !== 'ÂÅèË≤°(Indirect Wealth)' || ypGod.k !== 'ÂÅèË≤°(Indirect Wealth)') return { active: false, score: 0, desc: '' };
    
    const { selfPunishBranches } = YEAR_LUCK_CONFIG;
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c), hBi = BRANCH.findIndex(br => br.c === saju.hour.b.c);
    if (ypBi === hBi && selfPunishBranches.includes(ypBi)) {
        return { active: true, score: -2, desc: `üö® SCANDAL ALERT (Ëâ≤Èõ£)! Hour Pillar + Indirect Wealth DOUBLED + Self-Punishment. High risk of scandal/gambling.` };
    }
    return { active: true, score: -2, desc: `‚ö†Ô∏è AFFAIR WARNING (Ëâ≤Èõ£): Indirect Wealth Echo on Hour Pillar. Temptation is a TRAP.` };
}

// Ïö©Ïã† Î∂ÄÏû¨
function ylCheckMissingYong(saju, gods, yongAttacked) {
    const els = {};
    [saju.year.s.e, saju.year.b.e, saju.month.s.e, saju.month.b.e, saju.day.s.e, saju.day.b.e].forEach(e => els[e] = true);
    if (saju.hour) { els[saju.hour.s.e] = true; els[saju.hour.b.e] = true; }
    if (els[gods.yong]) return { active: false, score: 0, desc: '' };
    
    let desc = `üõ°Ô∏è NO SHIELD (Áî®Á•û‰∏çÂú®): Beneficial Element (${ELEMENT[gods.yong].n}) MISSING! No defense when crisis hits.`;
    let score = 0;
    if (yongAttacked) { desc += ` AND this year attacks that absent element - DOUBLE DANGER!`; score = -2; }
    return { active: true, desc, score };
}

// Ïú°Ìï¥ Î∞∞Ïã†
function ylCheckHarmBetrayal(saju) {
    const { harmPairs } = YEAR_LUCK_CONFIG;
    const dBi = BRANCH.findIndex(br => br.c === saju.day.b.c), mBi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    for (const [a, b] of harmPairs) {
        if ((mBi === a && dBi === b) || (mBi === b && dBi === a)) {
            if ((mBi === 3 && dBi === 4) || (mBi === 4 && dBi === 3)) {
                return { active: true, desc: `üó°Ô∏è BETRAYAL RISK (ÂçØËæ∞ÂÆ≥): Month HARMS Day. Words or betrayal may damage foundation. Never co-sign loans.` };
            }
            return { active: true, desc: `‚ö†Ô∏è HARM (ÂÖ≠ÂÆ≥): Close relationships face friction.` };
        }
    }
    return { active: false, desc: '' };
}

// ===== Rating Í≤∞Ï†ï =====
function ylDetermineRating(r, score) {
    if (r.bureau.active && r.yongGi.score > 0) return 'breakthrough';
    if (r.yongAttack.active) return 'yong_attacked';
    if (r.robWealth.active) return 'rob_wealth';
    if (r.yanginClash.active) return 'surgery_risk';
    // v4.12.6: Ïá†Ïã†Ï∂©Ïôï - Ïö©Ïã†Ïù¥ ÏôÄÎèÑ Í∏∞Ïã†Ïóê ÏïïÎèÑ
    if (r.yongOverwhelmed && r.yongOverwhelmed.active) return 'yong_overwhelmed';
    // v4.12.6: Ìé∏Ïù∏ÎèÑÏãù
    if (r.pyunInDoShik && r.pyunInDoShik.active) return 'pyunin_doshik';
    // v4.12.6: ÏôïÏã†Ï∂©Î∞ú - ÏôïÌïú Ïò§ÌñâÏùÑ Ï∂©ÌïòÎ©¥ Ìè≠Î∞ú
    if (r.wangShinChungBal && r.wangShinChungBal.active) return 'wang_shin_chung_bal';
    if (r.dayClash.active && r.yongGi.score > 0) return 'volatile_wealth';
    if (r.monthClash.active && score > 0) return 'volatile';
    if (score >= 4) return 'great';
    if (score >= 1) return 'good';
    if (score <= -4) return 'danger';
    if (score <= -2) return 'bad';
    return 'neutral';
}

// v4.12.6 NEW: Ïá†Ïã†Ï∂©Ïôï(Ë°∞Á•ûÊ≤ñÊó∫) - Ïö©Ïã†Ïù¥ ÏôÄÎèÑ Í∏∞Ïã†Ïù¥ 3Î∞∞ Ïù¥ÏÉÅÏù¥Î©¥ ÏïïÎèÑÎê®
function ylCheckYongOverwhelmed(saju, gods) {
    const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if (p?.s) elCount[p.s.e]++;
        if (p?.b) elCount[p.b.e]++;
    });
    
    const yongCount = elCount[gods.yong] || 0;
    const giCount = elCount[gods.gi] || 0;
    
    // Í∏∞Ïã†Ïù¥ Ïö©Ïã†Ïùò 3Î∞∞ Ïù¥ÏÉÅÏù¥Î©¥ Ïá†Ïã†Ï∂©Ïôï
    if (giCount >= 3 && yongCount <= 1 && giCount >= yongCount * 3) {
        return {
            active: true,
            score: -2,
            desc: `‚ö†Ô∏è Ïá†Ïã†Ï∂©Ïôï(Ë°∞Á•ûÊ≤ñÊó∫): Í∏∞Ïã†(${ELEMENT[gods.gi].k}) ${giCount}Í∞ú vs Ïö©Ïã†(${ELEMENT[gods.yong].k}) ${yongCount}Í∞ú ‚Üí Ïö©Ïã†Ïù¥ ÏôÄÎèÑ Í∏∞Ïã†Ïóê ÏïïÎèÑÎê®`,
            giCount,
            yongCount
        };
    }
    return { active: false, score: 0, desc: '', giCount, yongCount };
}

// v4.12.6 NEW: ÏôïÏã†Ï∂©Î∞ú(Êó∫Á•ûÊ≤ñÁôº) - ÏõêÍµ≠Ïóê 4Í∞ú Ïù¥ÏÉÅÏù∏ Ïò§ÌñâÏùÑ ÏÑ∏Ïö¥Ïù¥ Ï∂©ÌïòÎ©¥ Ìè≠Î∞ú
function ylCheckWangShinChungBal(yp, saju) {
    // ÏõêÍµ≠ Ïò§Ìñâ Ïπ¥Ïö¥Ìä∏
    const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if (p?.s) elCount[p.s.e]++;
        if (p?.b) elCount[p.b.e]++;
    });
    
    // ‚òÖ ÏàòÏ†ï: 4Í∞ú Ïù¥ÏÉÅÏù∏ Ïò§ÌñâÎßå "Ïôï"ÏúºÎ°ú Í∞ÑÏ£º (Î™ÖÎ¶¨Ìïô Ï†ïÏÑù)
    const wangElements = Object.entries(elCount).filter(([el, cnt]) => cnt >= 4);
    if (wangElements.length === 0) return { active: false, score: 0, desc: '' };
    
    // ÏÑ∏Ïö¥ ÏßÄÏßÄÍ∞Ä ÏõêÍµ≠Ïùò ÏôïÌïú Ïò§ÌñâÏùÑ Ï∂©ÌïòÎäîÏßÄ Ï≤¥ÌÅ¨
    const clashPairs = {
        'Â≠ê': 'Âçà', 'Âçà': 'Â≠ê',
        '‰∏ë': 'Êú™', 'Êú™': '‰∏ë',
        'ÂØÖ': 'Áî≥', 'Áî≥': 'ÂØÖ',
        'ÂçØ': 'ÈÖâ', 'ÈÖâ': 'ÂçØ',
        'Ëæ∞': 'Êàå', 'Êàå': 'Ëæ∞',
        'Â∑≥': '‰∫•', '‰∫•': 'Â∑≥'
    };
    
    const yearBranch = yp.b.c;
    const clashTarget = clashPairs[yearBranch];
    
    if (!clashTarget) return { active: false, score: 0, desc: '' };
    
    // ÏõêÍµ≠ÏóêÏÑú Ï∂© ÎåÄÏÉÅ ÏßÄÏßÄÏùò Ïò§Ìñâ ÌôïÏù∏
    const branches = [saju.year.b, saju.month.b, saju.day.b, saju.hour?.b].filter(b => b);
    const targetBranches = branches.filter(b => b.c === clashTarget);
    
    if (targetBranches.length === 0) return { active: false, score: 0, desc: '' };
    
    // Ï∂© ÎåÄÏÉÅÏùò Ïò§ÌñâÏù¥ ÏôïÌïú Ïò§ÌñâÏù∏ÏßÄ ÌôïÏù∏
    const targetEl = targetBranches[0].e;
    const isWang = wangElements.some(([el, cnt]) => el === targetEl);
    
    if (isWang) {
        const wangCount = elCount[targetEl];
        return {
            active: true,
            score: -3,  // Îß§Ïö∞ ÏúÑÌóò
            desc: `üö® ÏôïÏã†Ï∂©Î∞ú(Êó∫Á•ûÊ≤ñÁôº): ${yearBranch}(ÏÑ∏Ïö¥)Ïù¥ ${clashTarget}(ÏõêÍµ≠)ÏùÑ Ï∂©! ${ELEMENT[targetEl].k}Ïù¥ ${wangCount}Í∞úÎ°ú ÏôïÌïúÎç∞ Í±¥ÎìúÎ¶º ‚Üí Ïû†ÏûêÎäî ÏÇ¨Ïûê ÏΩîÌÑ∏! ÎåÄÍ≤©Î≥Ä/ÏÇ¨Í≥†/ÌååÏû¨ ÏúÑÌóò`,
            wangElement: targetEl,
            wangCount
        };
    }
    
    return { active: false, score: 0, desc: '' };
}

// v4.12.6 NEW: Ìé∏Ïù∏ÎèÑÏãù(ÂÅèÂç∞ÂÄíÈ£ü) - ÏãùÏã†Í≤©Ïù∏Îç∞ Ìé∏Ïù∏Ïù¥ ÏãùÏã†ÏùÑ Ï∂©/Í∑πÌïòÎ©¥ Î∞•Í∑∏Î¶á Íπ®Ïßê
function ylCheckPyunInDoShik(saju, gods) {
    // ÏõîÏßÄÏùò ÏßÄÏû•Í∞Ñ Ï†ïÍ∏∞Î°ú Í≤©Íµ≠ ÌåêÏ†ï
    const monthBi = BRANCH.findIndex(b => b.c === saju.month.b.c);
    const dm = saju.day.s;
    
    // ÏãùÏã† Ïò§Ìñâ
    const shikShinEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5];
    // Ìé∏Ïù∏ Ïò§Ìñâ
    const pyunInEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 4) % 5];
    
    // ÏõîÏßÄÍ∞Ä ÏãùÏã† Ïò§ÌñâÏù∏ÏßÄ Ï≤¥ÌÅ¨ (ÏãùÏã†Í≤© Í∞ÄÎä•ÏÑ±)
    const isShikShinMonth = saju.month.b.e === shikShinEl;
    
    if (!isShikShinMonth) return { active: false, score: 0, desc: '' };
    
    // Ìé∏Ïù∏Ïù¥ ÏõêÍµ≠Ïóê ÏûàÎäîÏßÄ + Ï∂© Í¥ÄÍ≥ÑÏù∏ÏßÄ Ï≤¥ÌÅ¨
    const clashPairs = [[0,6],[1,7],[2,8],[3,9],[4,10],[5,11]]; // Â≠êÂçà, ‰∏ëÊú™, ÂØÖÁî≥, ÂçØÈÖâ, Ëæ∞Êàå, Â∑≥‰∫•
    const branches = [saju.year.b, saju.month.b, saju.day.b, saju.hour?.b].filter(b => b);
    const branchIndices = branches.map(b => BRANCH.findIndex(br => br.c === b.c));
    
    let hasPyunInClash = false;
    let clashDetail = '';
    
    // Ìé∏Ïù∏Ïù¥ ÏãùÏã†ÏùÑ Ï∂©ÌïòÎäîÏßÄ Ï≤¥ÌÅ¨
    branches.forEach((b, i) => {
        if (b.e === pyunInEl) {
            const bi = BRANCH.findIndex(br => br.c === b.c);
            // ÏõîÏßÄ(ÏãùÏã†)ÏôÄ Ï∂©Ïù∏ÏßÄ
            clashPairs.forEach(([a, c]) => {
                if ((bi === a && monthBi === c) || (bi === c && monthBi === a)) {
                    hasPyunInClash = true;
                    clashDetail = `${b.c}(Ìé∏Ïù∏) ‚Üî ${saju.month.b.c}(ÏãùÏã†)`;
                }
            });
        }
    });
    
    if (hasPyunInClash) {
        return {
            active: true,
            score: -2,
            desc: `‚ö†Ô∏è Ìé∏Ïù∏ÎèÑÏãù(ÂÅèÂç∞ÂÄíÈ£ü): ${clashDetail} Ï∂© ‚Üí Ïû¨Îä•ÏùÄ ÏûàÏúºÎÇò ÏòàÎØºÌï® ÎïåÎ¨∏Ïóê Í∏∞ÌöåÎ•º Í±∑Ïñ¥Ï∞®Îäî ÌòïÍµ≠. Î∞•Í∑∏Î¶áÏù¥ Íπ®ÏßÄÍ∏∞ Ïâ¨ÏõÄ.`,
            clashDetail
        };
    }
    
    return { active: false, score: 0, desc: '' };
}

// ===== MAIN: calcYearLuck (v4.0 Refactored) =====
function calcYearLuck(year, saju, gods) {
    const yp = calcYearPillar(year, 6, 1);
    const dm = saju.day.s;
    const god = getTenGod(yp.s, dm);
    const state = getTwelveState(dm, yp.b);
    const strength = calcStrength(saju);
    
    // Î™®Îì† Ï≤¥ÌÅ¨ Ïã§Ìñâ
    const r = {
        yongGi: ylCheckYongGi(yp, gods),
        yongAttack: ylCheckYongAttack(yp, gods),
        robWealth: ylCheckRobWealth(yp, saju, gods, strength),
        expressorPeer: ylCheckExpressorPeer(yp, saju, strength),
        climateClash: ylCheckClimateClash(yp, gods),
        bureau: ylCheckBureau(yp, saju),
        monthClash: ylCheckMonthClash(yp, saju, false),
        dayClash: ylCheckDayClash(yp, saju),
        yanginClash: ylCheckYanginClash(yp, saju),
        tripleBranch: ylCheckTripleBranch(yp, saju),
        missingBridge: ylCheckMissingBridge(yp, saju, gods),
        stemCombine: ylCheckStemCombine(yp, saju, gods),
        branchCombine: ylCheckBranchCombine(yp, saju, gods, strength),
        selfPunishment: ylCheckSelfPunishment(yp, saju),
        scandal: ylCheckScandal(yp, saju),
        missingYong: ylCheckMissingYong(saju, gods, false),
        harmBetrayal: ylCheckHarmBetrayal(saju),
        // v4.12.6 NEW: Ïá†Ïã†Ï∂©Ïôï + Ìé∏Ïù∏ÎèÑÏãù + ÏôïÏã†Ï∂©Î∞ú
        yongOverwhelmed: ylCheckYongOverwhelmed(saju, gods),
        pyunInDoShik: ylCheckPyunInDoShik(saju, gods),
        wangShinChungBal: ylCheckWangShinChungBal(yp, saju)
    };
    
    // ÏÇºÌï©Ïù¥Î©¥ ÏõîÏßÄÏ∂© Î¨¥Ìö®
    if (r.bureau.active) r.monthClash = { active: false, score: 0, desc: '' };
    
    // Ïö©Ïã† Î∂ÄÏû¨ + ÌîºÍ≥µÍ≤© Ïû¨Í≥ÑÏÇ∞
    r.missingYong = ylCheckMissingYong(saju, gods, r.yongAttack.active);
    
    // Ï¥ùÏ†ê
    const score = Object.values(r).reduce((s, x) => s + (x.score || 0), 0);
    
    // Rating
    const rating = ylDetermineRating(r, score);
    
    // Í≥µÎßù ÌÉàÏ∂ú
    let voidBreak = false, voidBreakDesc = '';
    try {
        const gm = calcGongmang(saju);
        const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
        if (gm && gm.indices) {
            gm.indices.forEach(vi => {
                if (Math.abs(ypBi - vi) === 6) {
                    voidBreak = true;
                    voidBreakDesc = `üîì ${yp.b.c} breaks Void (${BRANCH[vi].c})! Liberation year.`;
                }
            });
        }
    } catch(e) {}
    
    return {
        year, pillar: yp, god, state, score, rating,
        // Legacy compatibility
        climateClash: r.climateClash.active, climateClashDesc: r.climateClash.desc,
        monthClash: r.monthClash.active, monthClashDesc: r.monthClash.desc,
        bureauFormed: r.bureau.active, bureauDesc: r.bureau.desc,
        voidBreak, voidBreakDesc,
        dayClash: r.dayClash.active, dayClashDesc: r.dayClash.desc,
        yanginClash: r.yanginClash.active, yanginClashDesc: r.yanginClash.desc,
        tripleBranch: r.tripleBranch.active, tripleBranchDesc: r.tripleBranch.desc, tripleBranchTarget: r.tripleBranch.target,
        missingBridge: r.missingBridge.active, missingBridgeDesc: r.missingBridge.desc,
        stemCombine: r.stemCombine.active ? r.stemCombine : null, stemCombineDesc: r.stemCombine.desc,
        branchCombine: r.branchCombine.active ? r.branchCombine : null, branchCombineDesc: r.branchCombine.desc,
        selfPunishment: r.selfPunishment.active, selfPunishmentDesc: r.selfPunishment.desc,
        yongUnderAttack: r.yongAttack.active, yongAttackDesc: r.yongAttack.desc,
        robWealthThreat: r.robWealth.active, robWealthDesc: r.robWealth.desc,
        expressorPeerClash: r.expressorPeer.active, expressorPeerDesc: r.expressorPeer.desc,
        scandalWarning: r.scandal.active, scandalWarningDesc: r.scandal.desc,
        missingYong: r.missingYong.active, missingYongDesc: r.missingYong.desc,
        harmBetrayalWarning: r.harmBetrayal.active, harmBetrayalDesc: r.harmBetrayal.desc,
        // v4.12.6 NEW
        yongOverwhelmed: r.yongOverwhelmed.active, yongOverwhelmedDesc: r.yongOverwhelmed.desc,
        pyunInDoShik: r.pyunInDoShik.active, pyunInDoShikDesc: r.pyunInDoShik.desc,
        wangShinChungBal: r.wangShinChungBal.active, wangShinChungBalDesc: r.wangShinChungBal.desc
    };
}


// Life Cycles(Life Cycle) + Ê≠≤ÈÅã(Annual Fortune) ÍµêÏ∞® Î∂ÑÏÑù
function analyzeLuckCross(saju, birthYear, gender, gods, targetYear) {
    const luck = calcLuck(saju, birthYear, gender, gods);
    const curAge = targetYear - birthYear;
    const curDaeun = luck.find(l => curAge >= l.startAge && curAge < l.endAge) || luck[0];
    const yearLuck = calcYearLuck(targetYear, saju, gods);
    
    const result = {
        daeun: curDaeun,
        saeun: yearLuck,
        analysis: []
    };
    
    // Life Cycles(Life Cycle)-Ê≠≤ÈÅã(Annual Fortune) Í¥ÄÍ≥Ñ Î∂ÑÏÑù
    const dEl = [curDaeun.s.e, curDaeun.b.e];
    const sEl = [yearLuck.pillar.s.e, yearLuck.pillar.b.e];
    
    // Life Cycles(Life Cycle)-Ê≠≤ÈÅã(Annual Fortune) Harmony
    const ganHap = [[0,5],[1,6],[2,7],[3,8],[4,9]];
    const dsi = STEM.indexOf(curDaeun.s), ssi = STEM.indexOf(yearLuck.pillar.s);
    for (let [a,b] of ganHap) {
        if ((dsi===a && ssi===b) || (dsi===b && ssi===a)) {
            result.analysis.push({type:'good', text:'Life Cycle-Annual Fortune stem harmony! Fortune flows smoothly.'});
        }
    }
    
    // Life Cycles(Life Cycle)-Ê≠≤ÈÅã(Annual Fortune) Clash
    const dbi = BRANCH.findIndex(br => br.c === curDaeun.b.c), sbi = BRANCH.findIndex(br => br.c === yearLuck.pillar.b.c);
    if (Math.abs(dbi - sbi) === 6 || Math.abs(dbi - sbi) === 6) {
        result.analysis.push({type:'bad', text:'Life Cycle-Annual Fortune branch clash! Changes and challenges may arise.'});
    }
    
    // Life Cycles(Life Cycle)-ÏõêÍµ≠ Í¥ÄÍ≥Ñ
    const allBi = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), BRANCH.findIndex(br => br.c === saju.day.b.c)];
    if (saju.hour) allBi.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    
    allBi.forEach((bi, idx) => {
        const positions = ['Year Branch','Month Branch','Day Branch','Hour Branch'];
        // Annual Fortune clash with natal chart
        if (Math.abs(bi - sbi) === 6) {
            result.analysis.push({type:'warning', text:`Annual Fortune clashes with ${positions[idx]}! ${idx===2 ? 'Watch spouse or health!' : idx===0 ? 'Family elder matters possible.' : idx===1 ? 'Career or business changes possible.' : 'Children or junior matters possible.'}`});
        }
    });
    
    // ‚òÖ‚òÖ‚òÖ BUG-002 FIX: ÏÑ∏Ïö¥+ÏõêÍµ≠ Î∞©Ìï© ÏôÑÏÑ± Ï≤¥ÌÅ¨ (v4.5 Patch) ‚òÖ‚òÖ‚òÖ
    const DIRECTIONAL_BUREAU = [
        {branches: [2,3,4], element: 0, name: 'ÂØÖÂçØËæ∞(Tiger-Rabbit-Dragon) Êú®Â±Ä Eastern Wood'},
        {branches: [5,6,7], element: 1, name: 'Â∑≥ÂçàÊú™(Snake-Horse-Goat) ÁÅ´Â±Ä Southern Fire'},
        {branches: [8,9,10], element: 3, name: 'Áî≥ÈÖâÊàå(Monkey-Rooster-Dog) ÈáëÂ±Ä Western Metal'},
        {branches: [11,0,1], element: 4, name: '‰∫•Â≠ê‰∏ë(Pig-Rat-Ox) Ê∞¥Â±Ä Northern Water'}
    ];
    
    DIRECTIONAL_BUREAU.forEach(bureau => {
        // ÏõêÍµ≠Ïóê 2Í∞ú ÏûàÍ≥† ÏÑ∏Ïö¥Ïù¥ ÎÇòÎ®∏ÏßÄ 1Í∞úÎ•º Ï±ÑÏö∞ÎäîÏßÄ Ï≤¥ÌÅ¨
        const natalMatches = bureau.branches.filter(b => allBi.includes(b));
        const yearCompletes = bureau.branches.includes(sbi) && !allBi.includes(sbi);
        
        if (natalMatches.length >= 2 && yearCompletes) {
            const elNames = ['Wood','Fire','Earth','Metal','Water'];
            result.analysis.push({
                type: 'critical',
                text: `üî•üî•üî• ${bureau.name} Bureau COMPLETED! ${elNames[bureau.element]} energy explosion!`
            });
            
            // Î∞©Ìï© Ïò§ÌñâÏù¥ Í∏∞Ïã†Ïù¥Î©¥ Ï∂îÍ∞Ä Í≤ΩÍ≥†
            if (gods && bureau.element === gods.gi) {
                result.analysis.push({
                    type: 'danger',
                    text: `‚ö†Ô∏è Bureau result is UNFAVORABLE (ÂøåÁ•û)! Health and wealth at extreme risk!`
                });
                result.bureauDanger = true;
            }
        }
    });
    
    // ‚òÖ‚òÖ‚òÖ BUG-003 FIX: Ïú°Ìï© Í∏∞Ïã† Î≥ÄÌôî Ï≤¥ÌÅ¨ (v4.5 Patch) ‚òÖ‚òÖ‚òÖ
    const COMBINE_PAIRS = [[0,1,'earth'],[2,11,'wood'],[3,10,'fire'],[4,9,'metal'],[5,8,'water'],[6,7,'fire']];
    const elNameToIdx = {'wood':0,'fire':1,'earth':2,'metal':3,'water':4};
    
    allBi.forEach((bi, idx) => {
        COMBINE_PAIRS.forEach(([a, b, resultEl]) => {
            if ((bi === a && sbi === b) || (bi === b && sbi === a)) {
                const resultElIdx = elNameToIdx[resultEl];
                if (gods && resultElIdx === gods.gi) {
                    const positions = ['Year','Month','Day(Spouse)','Hour(Children)'];
                    result.analysis.push({
                        type: 'warning',
                        text: `‚ö†Ô∏è ${BRANCH[sbi].c}+${BRANCH[bi].c} combine ‚Üí ${resultEl.toUpperCase()}(ÂøåÁ•û)! ${positions[idx]} area affected.`
                    });
                }
            }
        });
    });
    
    // Total score
    result.totalScore = curDaeun.score + yearLuck.score;
    result.totalRating = result.totalScore >= 4 ? 'excellent' : 
                         result.totalScore >= 2 ? 'good' : 
                         result.totalScore >= 0 ? 'neutral' : 
                         result.totalScore >= -2 ? 'caution' : 'difficult';
    
    return result;
}

// Life Cycles(Life Cycle) Ï≤úÍ∞Ñ/ÏßÄÏßÄ 5ÎÖÑÏî© Î∂ÑÎ¶¨ Ìï¥ÏÑù
function analyzeDaeunDetail(daeun, saju, gods, startYear) {
    const dm = saju.day.s;
    
    // First 5 years: Heavenly Stem dominant
    const stemGod = getTenGod(daeun.s, dm);
    const stemAnalysis = {
        period: 'First Half',
        dominant: 'Stem',
        pillar: daeun.s.c,
        god: stemGod.k,
        element: daeun.s.e,
        isYong: daeun.s.e === gods.yong,
        isGi: daeun.s.e === gods.gi,
        desc: `${stemGod.k} energy dominates this period.`
    };
    
    // Last 5 years: Earthly Branch dominant
    const branchGod = getTenGod({e: daeun.b.e, y: true, c: '', k: ''}, dm); // Temp object
    const branchAnalysis = {
        period: 'Second Half',
        dominant: 'Branch',
        pillar: daeun.b.c,
        element: daeun.b.e,
        isYong: daeun.b.e === gods.yong,
        isGi: daeun.b.e === gods.gi,
        state: getTwelveState(dm, daeun.b),
        desc: `${ELEMENT[daeun.b.e].k}(${daeun.b.c}) energy is active in this cycle.`
    };
    
    return { stem: stemAnalysis, branch: branchAnalysis };
}

// 10Year Fortune ÎØ∏Î¶¨Î≥¥Í∏∞
function getNext10Years(saju, birthYear, gender, gods) {
    const curYear = new Date().getFullYear();
    const years = [];
    
    for (let i = 0; i < 10; i++) {
        const year = curYear + i;
        const cross = analyzeLuckCross(saju, birthYear, gender, gods, year);
        years.push({
            year,
            age: year - birthYear,
            rating: cross.totalRating,
            score: cross.totalScore,
            daeun: cross.daeun,
            saeun: cross.saeun
        });
    }
    
    // Find best year and caution year
    const bestYear = years.reduce((a, b) => a.score > b.score ? a : b);
    const worstYear = years.reduce((a, b) => a.score < b.score ? a : b);
    
    return { years, bestYear, worstYear };
}

// Monthly Fortune(ÊúàÈÅã) Í≥ÑÏÇ∞
function calcMonthLuck(year, month, saju, gods) {
    const mp = calcMonthPillar(year, month, 15);
    const dm = saju.day.s;
    const god = getTenGod(mp.s, dm);
    
    let score = 0;
    let climateClash = false;
    
    if ([mp.s.e, mp.b.e].includes(gods.yong)) score += 2;
    if ([mp.s.e, mp.b.e].includes(gods.hee)) score += 1;
    if ([mp.s.e, mp.b.e].includes(gods.gi)) score -= 2;
    
    // üî• Ï°∞ÌõÑ Ïó≠Ïö¥ Ï≤¥ÌÅ¨ (Climate Clash) - Gemini feedback
    // v4.12.6: ÏÉà Ï°∞ÌõÑ ÌÉÄÏûÖÏóê ÎßûÍ≤å ÏàòÏ†ï
    if (gods.climate) {
        const monthEls = [mp.s.e, mp.b.e];
        // Ï°∞Ïó¥/ÏóºÏó¥ + Fire month = DANGER
        if ((gods.climate.type.includes('Ï°∞Ïó¥') || gods.climate.type.includes('ÏóºÏó¥')) && 
            monthEls.filter(e => e === 'fire').length >= 1) {
            score -= 3;
            climateClash = true;
        }
        // Í∑πÌïú/ÌïúÎÉâ/ÌïúÏäµ/ÎÉâÏ∂î + Water month = DANGER
        if ((gods.climate.type.includes('Í∑πÌïú') || gods.climate.type.includes('ÌïúÎÉâ') ||
             gods.climate.type.includes('ÌïúÏäµ') || gods.climate.type.includes('ÎÉâÏ∂î')) && 
            monthEls.filter(e => e === 'water').length >= 1) {
            score -= 3;
            climateClash = true;
        }
    }
    
    return {
        month,
        pillar: mp,
        god,
        score,
        climateClash,
        rating: score >= 2 ? 'good' : score <= -2 ? 'bad' : 'neutral'
    };
}

// 12Í∞úÏõî Monthly Fortune Î∂ÑÏÑù
function getYearlyMonthLuck(year, saju, gods) {
    const months = [];
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);  // ÏõêÍµ≠ ÏõîÏßÄ
    
    for (let m = 1; m <= 12; m++) {
        const monthData = calcMonthLuck(year, m, saju, gods);
        
        // üî• ÏôïÏßÄÏ∂©(Êó∫ÊîØÊ≤ñ) Ï≤¥ÌÅ¨ - Gemini feedback
        // ÌôîÍ≥ºÎã§(Fire Excess) ÏÇ¨Ï£ºÏóêÏÑú ÏûêÏò§Ï∂©(Â≠êÂçàÊ≤ñ)ÏùÄ Ìè≠Î∞úÏ†Å
        const monthBi = BRANCH.findIndex(br => br.c === monthData.pillar.b.c);
        const isWangClash = Math.abs(monthBi - mbi) === 6;  // 6 = Ï∂©
        
        if (isWangClash && gods.climate && 
            (gods.climate.type.includes('Dry') || gods.climate.type.includes('Hot'))) {
            // ÌôîÍ≥ºÎã§ ÏÇ¨Ï£º + Ïàò(Water)Ïõî = ÏôïÏûêÏ∂©Î∞ú(Êó∫ËÄÖÊ≤ñÁôº) ÏúÑÌóò
            if (monthData.pillar.b.e === 'water') {
                monthData.score -= 3;  // Heavy penalty
                monthData.wangClash = true;
                monthData.wangClashDesc = 'Fire-Water Clash! Risk of cardiovascular shock.';
            }
        }
        
        months.push(monthData);
    }
    
    // Best month: climateClashÎÇò wangClashÍ∞Ä ÏóÜÎäî Îã¨ Ï§ëÏóêÏÑú ÏÑ†ÌÉù
    const safeBest = months.filter(m => !m.climateClash && !m.wangClash);
    const best = safeBest.length > 0 
        ? safeBest.reduce((a, b) => a.score > b.score ? a : b)
        : months.reduce((a, b) => a.score > b.score ? a : b);
    
    // Worst month
    const worst = months.reduce((a, b) => a.score < b.score ? a : b);
    
    // Wang Clash months
    const wangClashMonths = months.filter(m => m.wangClash).map(m => m.month);
    
    return { months, best, worst, wangClashMonths };
}

/* ========================================
   12. Complete Divine Stars (30Í∞ú+)
   ======================================== */
function calcSinsal(saju) {
    const ss = [];
    const dmi = STEM.indexOf(saju.day.s);
    const ybi = BRANCH.findIndex(br => br.c === saju.year.b.c);
    const dbi = BRANCH.findIndex(br => br.c === saju.day.b.c);
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    const hbi = saju.hour ? BRANCH.findIndex(br => br.c === saju.hour.b.c) : -1;
    const brs = [ybi, mbi, dbi];
    if (hbi >= 0) brs.push(hbi);
    
    // Stems Ïù∏Îç±Ïä§Îì§
    const ysi = STEM.indexOf(saju.year.s);
    const msi = STEM.indexOf(saju.month.s);
    const hsi = saju.hour ? STEM.indexOf(saju.hour.s) : -1;
    
    // ========== Í∏∏Ïã†(ÂêâÁ•û) ==========
    
    // 1. Â§©‰πôË≤¥‰∫∫(Heavenly Noble) (Â§©‰πôË≤¥‰∫∫) - ÏµúÍ≥† Í∏∏Ïã†
    const guiren = {0:[1,7],1:[0,8],2:[11,9],3:[11,9],4:[1,7],5:[0,8],6:[7,1],7:[6,2],8:[5,3],9:[5,3]};
    if (guiren[dmi] && brs.some(b => guiren[dmi].includes(b))) ss.push({n:'Â§©‰πôË≤¥‰∫∫(Heavenly Noble)',t:'good',d:'Supreme blessing! A guardian angel appears in every crisis. Official fortune and protection surround you.',i:'üëº',lv:'ÏµúÏÉÅ'});
    
    // 2. Ï≤úÎçïÍ∑ÄÏù∏ (Â§©Âæ∑Ë≤¥‰∫∫)
    const tiande = [9,8,7,6,5,4,3,2,1,0,9,8]; // By month
    if (mbi < 12 && (dmi === tiande[mbi] || brs.some(b => b === tiande[mbi]))) ss.push({n:'Â§©Âæ∑Ë≤¥‰∫∫(Heavens Virtue Noble)',t:'good',d:'Heavens virtue shines upon you! Living righteously multiplies your blessings tenfold.',i:'üåü',lv:'ÏÉÅ'});
    
    // 3. ÏõîÎçïÍ∑ÄÏù∏ (ÊúàÂæ∑Ë≤¥‰∫∫)
    const yuede = [2,6,2,6,4,8,4,8,0,6,0,6]; // By month Ï≤úÍ∞Ñ
    if (mbi < 12 && dmi === yuede[mbi]) ss.push({n:'ÊúàÂæ∑Ë≤¥‰∫∫(Moons Virtue Noble)',t:'good',d:'Moons blessing graces your path! Natural charisma draws trust and admiration. Official positions favor you.',i:'üåô',lv:'ÏÉÅ'});
    
    // 4. Î¨∏Ï∞ΩÍ∑ÄÏù∏ (ÊñáÊòåË≤¥‰∫∫)
    const munchang = {0:5,1:6,2:8,3:9,4:8,5:9,6:11,7:0,8:2,9:3};
    if (brs.includes(munchang[dmi])) ss.push({n:'ÊñáÊòåË≤¥‰∫∫(Scholar Star)',t:'good',d:'Brilliant scholarly mind! Exams, certifications, and academic pursuits bend to your will. Writing flows naturally.',i:'üìö',lv:'ÏÉÅ'});
    
    // 5. ÌïôÎãπÍ∑ÄÏù∏ (Â≠∏Â†ÇË≤¥‰∫∫)
    const xuetang = {0:11,1:6,2:2,3:9,4:2,5:9,6:5,7:0,8:8,9:3};
    if (brs.includes(xuetang[dmi])) ss.push({n:'Â≠∏Â†ÇË≤¥‰∫∫(Academy Noble)',t:'good',d:'Scholars destiny! Research and education lead to greatness. Professorship and expertise await.',i:'üéì',lv:'ÏÉÅ'});
    
    // 6. Ïû•ÏÑ±Í∑ÄÏù∏ (Â∞áÊòüË≤¥‰∫∫)
    const jiangx = {0:0,1:9,2:6,3:3,4:0,5:9,6:6,7:3,8:0,9:9,10:6,11:3}; // By Year Branch
    if (brs.includes(jiangx[ybi])) ss.push({n:'Â∞áÊòü(General Star)',t:'good',d:'Commanders spirit! Natural leadership draws followers. You are destined to lead.',i:'üéñÔ∏è',lv:'ÏÉÅ'});
    
    // 7. ÈáëËºø(Golden Carriage) (ÈáëËºø) - Î∞∞Ïö∞Ïûê Î≥µ
    const jinyu = {0:4,1:5,2:7,3:8,4:7,5:8,6:10,7:11,8:1,9:2};
    if (brs.includes(jinyu[dmi])) ss.push({n:'ÈáëËºø(Golden Carriage)',t:'good',d:'Supreme spouse fortune! Marriage unlocks your destiny. An ideal partner awaits.',i:'üíç',lv:'ÏÉÅ'});
    
    // 8. Î≥µÏÑ±Í∑ÄÏù∏ (Á¶èÊòüË≤¥‰∫∫)
    const fuxing = {0:2,1:3,2:5,3:6,4:5,5:6,6:8,7:9,8:11,9:0};
    if (brs.includes(fuxing[dmi])) ss.push({n:'Á¶èÊòüË≤¥‰∫∫(Fortune Noble)',t:'good',d:'Blessed chart! No worries about necessities. Lifetime abundance.',i:'üçÄ',lv:'ÏÉÅ'});
    
    // 9. ÏïîÎ°ù (ÊöóÁ•ø) - Ïà®ÏùÄ ÎÖπ
    const anlu = {0:11,1:10,2:1,3:0,4:1,5:0,6:3,7:2,8:5,9:4};
    if (brs.includes(anlu[dmi])) ss.push({n:'ÊöóÁ•ø(Hidden Fortune)',t:'good',d:'Hidden blessings flow! Invisible support guides you when you least expect it.',i:'üéÅ',lv:'Medium'});
    
    // 10. Prime (Âª∫Á•ø)
    const jianlu = {0:2,1:3,2:5,3:6,4:5,5:6,6:8,7:9,8:11,9:0};
    if (brs.includes(jianlu[dmi])) ss.push({n:'Âª∫Á•ø(Prime)',t:'good',d:'Self-made type! Success through own efforts. Stable career.',i:'üè†',lv:'ÏÉÅ'});
    
    // 11. Ï≤úÏùòÏÑ± (Â§©ÈÜ´Êòü)
    const tianyi = [11,0,1,2,3,4,5,6,7,8,9,10]; // By month
    if (mbi < 12 && brs.includes(tianyi[mbi])) ss.push({n:'Â§©ÈÜ´Êòü(Heavenly Doctor)',t:'good',d:'Medical calling! Doctors, nurses, pharmacists ‚Äî healing professions bring great fortune.',i:'üíä',lv:'Medium'});
    
    // ========== Ï§ëÏÑ±(‰∏≠ÊÄß) ==========
    
    // 12. È©õÈ¶¨(Traveling Horse) (È©õÈ¶¨ÊÆ∫)
    const yima = {0:2,1:11,2:8,3:5,4:2,5:11,6:8,7:5,8:2,9:11,10:8,11:5};
    if (brs.includes(yima[ybi])) ss.push({n:'È©õÈ¶¨(Traveling Horse)',t:'neutral',d:'Movement awakens fortune! Travel, relocation, overseas ventures ‚Äî motion is your medicine.',i:'üêé',lv:'Medium'});
    
    // 13. Ê°ÉËä±(Peach Blossom) (Ê°ÉËä±ÊÆ∫)
    const taohua = {0:9,1:6,2:3,3:0,4:9,5:6,6:3,7:0,8:9,9:6,10:3,11:0};
    if (brs.includes(taohua[ybi])) ss.push({n:'Ê°ÉËä±(Peach Blossom)',t:'neutral',d:'Irresistible charm! Magnetic attraction to opposite sex. Star quality ‚Äî guard against wandering heart.',i:'üå∏',lv:'Medium'});
    
    // 14. FireÍ∞úÏÇ¥ (ËèØËìãÊÆ∫)
    const huagai = {0:4,1:1,2:10,3:7,4:4,5:1,6:10,7:7,8:4,9:1,10:10,11:7};
    if (brs.includes(huagai[ybi])) ss.push({n:'ËèØËìã(Canopy Star)',t:'neutral',d:'Artists soul! Music, art, and writing flow naturally. Spiritual and philosophical depths call to you.',i:'üé®',lv:'Medium'});
    
    // 15. ÌôçÏóºÏÇ¥ (Á¥ÖËâ∂ÊÆ∫) - Ïù¥ÏÑ± Ïù∏Í∏∞
    const hongyan = {0:6,1:5,2:8,3:7,4:8,5:7,6:9,7:8,8:11,9:10};
    if (brs.includes(hongyan[dmi])) ss.push({n:'Á¥ÖËâ∂(Red Romance)',t:'neutral',d:'Sexy charm! Attractive to opposite sex. Entertainment aptitude, watch infidelity!',i:'üíã',lv:'Medium'});
    
    // ========== ÌùâÏã†(Âá∂Á•û) ==========
    
    // 16. Í¥¥Í∞ïÏÇ¥ (È≠ÅÁΩ°ÊÆ∫)
    const kuigang = [[6,4],[],[6,4],[],[6,10],[],[6,10],[],[],[]]; // Day Branch by Day Master
    if (kuigang[dmi] && kuigang[dmi].includes(dbi)) ss.push({n:'È≠ÅÁΩ°(Fierce Star)',t:'bad',d:'Fierce fire spirit! Charismatic leader potential ‚Äî temper your autocratic tendencies.',i:'‚ö°',lv:'ÏÉÅ'});
    
    // 17. ÏñëÏù∏ÏÇ¥ (ÁæäÂàÉÊÆ∫)
    const yangren = {0:3,1:2,2:6,3:5,4:6,5:5,6:9,7:8,8:0,9:11};
    if (dbi === yangren[dmi]) ss.push({n:'Sheep Blade (ÁæäÂàÉ)',t:'bad',d:'Sharp blade energy! Decisive but sharp. Suits military, surgeons, lawyers.',i:'üó°Ô∏è',lv:'ÏÉÅ'});
    
    // 18. Î∞±Ìò∏ÏÇ¥ (ÁôΩËôéÊÆ∫)
    const baihu = [6,7,8,9,10,11,0,1,2,3,4,5]; // By month
    if (mbi < 12 && brs.includes(baihu[mbi])) ss.push({n:'ÁôΩËôé(White Tiger)',t:'bad',d:'Accident alert! However, professions involving blood (medicine, culinary) transform this into blessing.',i:'üêØ',lv:'Medium'});
    
    // üî• 18-2. ÏùºÏ£º Î∞±Ìò∏ÎåÄÏÇ¥ (Êó•Êü±ÁôΩËôé) - Gemini Round 10
    // Áî≤Ëæ∞, ‰πôÂ∑≥, ‰∏ôÊàå, ‰∏Å‰∏ë, ÊàäËæ∞, Â∑±Â∑≥, Â∫öÊàå, Ëæõ‰∏ë, Â£¨Ëæ∞, Áô∏Â∑≥
    const dayPillarStr = saju.day.s.c + saju.day.b.c;
    const whiteTigerDays = ['Áî≤Ëæ∞', '‰πôÂ∑≥', '‰∏ôÊàå', '‰∏Å‰∏ë', 'ÊàäËæ∞', 'Â∑±Â∑≥', 'Â∫öÊàå', 'Ëæõ‰∏ë', 'Â£¨Ëæ∞', 'Áô∏Â∑≥'];
    if (whiteTigerDays.includes(dayPillarStr)) {
        ss.push({n:'Day Pillar White Tiger (Êó•Êü±ÁôΩËôé)',t:'bad',d:'White Tiger in your core pillar! Gentle normally, fierce when provoked. Blood-related events possible for self/spouse/children. Medical, religious, or healing professions transform this into blessing. For women: watch for difficult childbirth.',i:'üêÖ',lv:'High'});
    }
    
    // 19. Í≤ÅÏÇ¥ (Âä´ÊÆ∫)
    const jiesha = {0:5,1:2,2:11,3:8,4:5,5:2,6:11,7:8,8:5,9:2,10:11,11:8};
    if (brs.includes(jiesha[ybi])) ss.push({n:'Âä´ÊÆ∫(Robbery Star)',t:'bad',d:'Financial vulnerability! Guard against theft, fraud, bad investments. Never co-sign loans!',i:'üí∏',lv:'Medium'});
    
    // 20. ÎßùÏã†ÏÇ¥ (‰∫°Á•ûÊÆ∫)
    const wangshen = {0:9,1:6,2:3,3:0,4:9,5:6,6:3,7:0,8:9,9:6,10:3,11:0};
    if (brs.includes(wangshen[ybi]) && wangshen[ybi] !== taohua[ybi]) ss.push({n:'‰∫°Á•û(Disgrace Star)',t:'bad',d:'Reputation vulnerability! Guard social media, drinking occasions carefully.',i:'üò∞',lv:'Medium'});
    
    // 21. ÏõêÏßÑÏÇ¥ (ÊÄ®ÂóîÊÆ∫)
    const yuanchen = [[7],[6],[5],[4],[3],[2],[1],[0],[11],[10],[9],[8]];
    if (yuanchen[ybi] && brs.some(b => yuanchen[ybi].includes(b))) ss.push({n:'ÊÄ®Âóî(Resentment Star)',t:'bad',d:'Love-hate bonds entangle you. Navigate close relationships with care.',i:'üíî',lv:'Medium'});
    
    // 22. Í∑ÄÎ¨∏Í¥ÄÏÇ¥ (È¨ºÈñÄÈóúÊÆ∫)
    const guimen = [[5,6],[6,7],[7,8],[8,9],[9,10],[10,11],[11,0],[0,1],[1,2],[2,3],[3,4],[4,5]];
    if (guimen[ybi] && brs.some(b => guimen[ybi].includes(b))) ss.push({n:'È¨ºÈñÄÈóú(Spirit Gate)',t:'neutral',d:'Highly intuitive and spiritually sensitive. You have a sixth sense for art and people. Meditation is your power source.',i:'üîÆ',lv:'Medium'});
    
    // 23. ÌòÑÏπ®ÏÇ¥ (Êá∏ÈáùÊÆ∫) - Áî≤, Áî≥, ËæõÏóê ÏÑ∏Î°úÌöç
    if ([0,7].includes(dmi)) ss.push({n:'Êá∏Èáù(Needle Star)',t:'bad',d:'Needle-sharp energy! Critical perfectionist. Talent for acupuncture, precision crafts.',i:'üìç',lv:'Ìïò'});
    
    // 24. Ïú°Ìï¥ÏÇ¥ (ÂÖ≠ÂÆ≥ÊÆ∫)
    const liuhai = [[7],[6],[5],[4],[3],[2],[1],[0],[11],[10],[9],[8]];
    if (liuhai[dbi] && brs.some(b => liuhai[dbi].includes(b) && b !== dbi)) ss.push({n:'ÂÖ≠ÂÆ≥(Six Harms)',t:'bad',d:'Vulnerability through close ones. Navigate spouse and sibling relationships carefully.',i:'‚ö†Ô∏è',lv:'Medium'});
    
    // 25. Ï≤úÎùºÏßÄÎßù (Â§©ÁæÖÂú∞Á∂≤)
    const tianluodiwang = (dbi === 10 && [5,6].includes(mbi)) || (dbi === 11 && [9,10].includes(mbi));
    if (tianluodiwang) ss.push({n:'Â§©ÁæÖÂú∞Á∂≤(Heavens Net)',t:'bad',d:'Caught in heavens net. Guard against gossip, lawsuits. Feelings of entrapment may arise.',i:'üï∏Ô∏è',lv:'Medium'});
    
    // 26. Í≥†ÎûÄÏÇ¥ (Â≠§È∏ûÊÆ∫) - ÌòºÏûê ÏûàÎäî Í∏∞Îü¨Í∏∞
    const guluanM = [[0,2],[1,3],[2,5],[3,6],[4,5],[5,6],[6,8],[7,9],[8,11],[9,0]]; // Day Master+Branch combo (male)
    const guluanF = [[1,3],[0,2],[3,6],[2,5],[3,6],[2,5],[7,9],[6,8],[9,0],[8,11]]; // female
    const guluanCheck = GENDER === 'm' ? guluanM : guluanF;
    if (guluanCheck[dmi] && guluanCheck[dmi][1] === dbi) ss.push({n:'Â≠§È∏û(Lonely Swan)',t:'bad',d:'Solitary spirit dwells within. Late marriage or single tendencies. Solitude becomes your companion.',i:'ü¶¢',lv:'Ìïò'});
    
    // 27. ÏÇºÏû¨ (‰∏âÁÅΩ) - Year Branch Í∏∞Ï§Ä
    const sanzai = {0:[2,3,4],1:[2,3,4],2:[2,3,4],3:[5,6,7],4:[5,6,7],5:[5,6,7],6:[8,9,10],7:[8,9,10],8:[8,9,10],9:[11,0,1],10:[11,0,1],11:[11,0,1]};
    const curYear = new Date().getFullYear();
    const curYearBranch = (curYear - 4) % 12;
    if (sanzai[ybi] && sanzai[ybi].includes(curYearBranch)) ss.push({n:'‰∏âÁÅΩ(Three Calamities)',t:'bad',d:'Three Calamities period active! Exercise caution for 3 years. Avoid reckless expansion and major moves.',i:'üî•',lv:'Medium'});
    
    // 28. Î∞òÏïàÏÇ¥ (ÊîÄÈûçÊÆ∫)
    const panan = {0:2,1:3,2:5,3:6,4:5,5:6,6:8,7:9,8:11,9:0};
    if (brs.includes(panan[dmi])) ss.push({n:'ÊîÄÈûç(Climbing Saddle)',t:'good',d:'Good career luck! Promotion type in stable organizations. Suits corporations.',i:'üí∫',lv:'Medium'});
    
    // 29. Ï≤úÏ£ºÍ∑ÄÏù∏ (Â§©ÂªöË≤¥‰∫∫) - ÏãùÎ≥µ
    const tianchu = {0:5,1:6,2:8,3:9,4:8,5:9,6:11,7:0,8:2,9:3};
    if (brs.includes(tianchu[dmi])) ss.push({n:'Â§©ÂªöË≤¥‰∫∫(Heavenly Kitchen)',t:'good',d:'Blessed with food fortune! Never worry about hunger. Culinary talent awaits discovery.',i:'üçΩÔ∏è',lv:'Medium'});
    
    // 30. Ï≤úÏÇ¨(Â§©Ëµ¶) - ÌïòÎäòÏù¥ Ïö©ÏÑúÌïòÎäî ÎÇ†
    const tiansha = [[2,0],[3,1],[5,2],[6,3],[8,4],[9,5],[11,6],[0,7],[2,8],[3,9]]; // [Branch,Stem] combination
    if (tiansha.some(ts => dbi === ts[0] && dmi === ts[1])) ss.push({n:'Â§©Ëµ¶Êó•(Heavens Pardon)',t:'good',d:'Â§©Ëµ¶Êó•(Heavens Pardon) Day! Misfortunes transform into blessings. Divine forgiveness surrounds you.',i:'üïäÔ∏è',lv:'ÏÉÅ'});
    
    return ss.length ? ss : [{n:'No Special Stars',t:'neutral',d:'No exceptional divine stars. A peacefully balanced chart brings steady fortune.',i:'‚òØÔ∏è',lv:'Medium'}];
}

/* ========================================
   13. Ìï©Ï∂©ÌòïÌååÌï¥ (ÌôïÏû•Ìåê)
   ======================================== */
function calcInteractions(saju) {
    const res = [];
    const stems = [STEM.indexOf(saju.year.s), STEM.indexOf(saju.month.s), STEM.indexOf(saju.day.s)];
    const brs = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), BRANCH.findIndex(br => br.c === saju.day.b.c)];
    if (saju.hour) { stems.push(STEM.indexOf(saju.hour.s)); brs.push(BRANCH.findIndex(br => br.c === saju.hour.b.c)); }
    
    // ‚òÖ Ï§ëÎ≥µ Ï†úÍ±∞Ïö© Set
    const addedCombines = new Set();
    
    // StemsHarmony
    const stComb = [[0,5,'Áî≤Â∑± (Wood+Earth) combine to Earth'],[1,6,'‰πôÂ∫ö (Wood+Metal) combine to Metal'],[2,7,'‰∏ôËæõ (Fire+Metal) combine to Water'],[3,8,'‰∏ÅÂ£¨ (Fire+Water) combine to Wood'],[4,9,'ÊàäÁô∏ (Earth+Water) combine to Fire']];
    for (let [a,b,n] of stComb) {
        for (let i = 0; i < stems.length; i++) {
            for (let j = i+1; j < stems.length; j++) {
                if ((stems[i]===a && stems[j]===b) || (stems[i]===b && stems[j]===a)) {
                    const key = `Â§©Âêà:${Math.min(a,b)}-${Math.max(a,b)}`;
                    if (!addedCombines.has(key)) {
                        addedCombines.add(key);
                        res.push({t:'Â§©Âêà',c:`${STEM[a].c}+${STEM[b].c}`,m:n,d:'üí´ Heavenly stems unite to create new energy! This harmony brings smooth relationships, good timing, and opportunities. A blessing in your chart.'});
                    }
                }
            }
        }
    }
    
    // StemsÏ∂© (Â§©Âπ≤Ê≤ñ) - ÏÉàÎ°ú Ï∂îÍ∞Ä
    const stClash = [
        [0,6,'Áî≤Â∫ö (Wood vs Metal) clash','Strong decisiveness but many conflicts. Leadership vs authority!'],
        [1,7,'‰πôËæõ (Wood vs Metal) clash','Inner conflict. Flexibility vs rigidity collide.'],
        [2,8,'‰∏ôÂ£¨ (Fire vs Water) clash','Passion vs wisdom clash. Watch impulsiveness!'],
        [3,9,'‰∏ÅÁô∏ (Fire vs Water) clash','Emotion and reason clash. Mood swings possible.'],
        [4,4,'ÊàäÊàä (Earth+Earth) Peer','Stubborn with strong self-assertion.'],
        [5,5,'Â∑±Â∑± (Earth+Earth) Peer','Pure but may be indecisive.']
    ];
    for (let [a,b,n,desc] of stClash) {
        for (let i = 0; i < stems.length; i++) {
            for (let j = i+1; j < stems.length; j++) {
                if ((stems[i]===a && stems[j]===b) || (stems[i]===b && stems[j]===a)) {
                    res.push({t:'Â§©Ê≤ñ',c:`${STEM[a].c}‚Üî${STEM[b].c}`,m:n,d:desc});
                }
            }
        }
    }
    
    // Branch Six Harmony
    const hap = [[0,1,'Â≠ê‰∏ë(Rat-Ox) combine to Earth'],[2,11,'ÂØÖ‰∫•(Tiger-Pig) combine to Wood'],[3,10,'ÂçØÊàå(Rabbit-Dog) combine to Fire'],[4,9,'Ëæ∞ÈÖâ(Dragon-Rooster) combine to Metal'],[5,8,'Â∑≥Áî≥(Snake-Monkey) combine to Water'],[6,7,'ÂçàÊú™(Horse-Goat) combine to Fire']];
    for (let [a,b,n] of hap) {
        if (brs.includes(a) && brs.includes(b)) res.push({t:'ÂÖ≠Âêà',c:`${BRANCH[a].c}+${BRANCH[b].c}`,m:n,d:'üíï Six Harmony brings natural affinity and attraction. People find you likeable and trustworthy. Great for partnerships and relationships!'});
    }
    
    // Trinity
    const samhap = [[2,6,10,'ÂØÖÂçàÊàå(Tiger-Horse-Dog) Fire combination'],[5,9,1,'Â∑≥ÈÖâ‰∏ë(Snake-Rooster-Ox) Metal combination'],[8,0,4,'Áî≥Â≠êËæ∞(Monkey-Rat-Dragon) Water combination'],[11,3,7,'‰∫•ÂçØÊú™(Pig-Rabbit-Goat) Wood combination']];
    for (let [a,b,c,n] of samhap) {
        const has = [brs.includes(a), brs.includes(b), brs.includes(c)];
        if (has.filter(x=>x).length === 3) res.push({t:'‰∏âÂêà',c:`${BRANCH[a].c}${BRANCH[b].c}${BRANCH[c].c}`,m:n,d:'üåü Complete Trinity! Three branches unite to form a powerful elemental force. This brings strong support, teamwork, and the ability to achieve big goals.'});
        else if (has.filter(x=>x).length === 2 && has[1]) res.push({t:'ÂçäÂêà',c:has[0]?`${BRANCH[a].c}${BRANCH[b].c}`:has[2]?`${BRANCH[b].c}${BRANCH[c].c}`:'',m:n.split(' ')[0]+' half-combination',d:'‚≠ê Partial Trinity forming. The energy is building but not yet complete. When the missing branch appears in luck cycles, expect major positive changes!'});
    }
    
    // Clash
    const clash = [[0,6,'Â≠êÂçà(Rat-Horse) clash','North-south collision! Heart and reality conflict.'],[1,7,'‰∏ëÊú™(Ox-Goat) clash','Wealth-related changes coming.'],[2,8,'ÂØÖÁî≥(Tiger-Monkey) clash','Activity increases. Watch traffic safety!'],[3,9,'ÂçØÈÖâ(Rabbit-Rooster) clash','Document and contract issues may arise.'],[4,10,'Ëæ∞Êàå(Dragon-Dog) clash','Stubborn nature causes conflicts.'],[5,11,'Â∑≥‰∫•(Snake-Pig) clash','Plans may not go as expected.']];
    for (let [a,b,n,desc] of clash) {
        const ia = brs.indexOf(a), ib = brs.indexOf(b);
        if (ia >= 0 && ib >= 0) {
            const dist = Math.abs(ia - ib);
            const strength = dist === 1 ? '‚ö°Strong clash' : dist === 2 ? 'Moderate clash' : 'Weak clash';
            res.push({t:'Ê≤ñ',c:`${BRANCH[a].c}‚Üî${BRANCH[b].c}`,m:`${n} (${strength})`,d:desc});
        }
    }
    
    // Punishment (detailed) - ÏÇºÌòï, ÏÉÅÌòï, ÏûêÌòï
    // 1. ÏÇºÌòï (‰∏âÂàë) - Ïù∏ÏÇ¨Ïã†
    if (brs.includes(2) && brs.includes(5) && brs.includes(8)) {
        res.push({t:'‰∏âÂàë',c:'ÂØÖÂ∑≥Áî≥',m:'Punishment of Ingratitude',d:'‚ö†Ô∏è Triple Punishment present. Life may test you through unexpected betrayals or accidents. Stay humble, show gratitude, and be extra careful with safety. Challenges make you stronger.'});
    }
    // 2. Ï∂ïÏà†ÎØ∏ ÏÇºÌòï
    if (brs.includes(1) && brs.includes(10) && brs.includes(7)) {
        res.push({t:'‰∏âÂàë',c:'‰∏ëÊàåÊú™',m:'Punishment of Disrespect',d:'‚ö†Ô∏è Triple Earth Punishment. Your strong convictions can come across as stubbornness. Practice flexibility and respect others viewpoints. Softening your approach brings harmony.'});
    }
    // 3. ÏÉÅÌòï (Áõ∏Âàë) - Îëê Í∏ÄÏûê
    const brHyung = [
        [2,5,'ÂØÖÂ∑≥(Tiger-Snake) punishment','Part of ingratitude. Watch for betrayal and gossip!'],
        [5,8,'Â∑≥Áî≥(Snake-Monkey) punishment','Part of ingratitude. Cold and conflict-prone.'],
        [2,8,'ÂØÖÁî≥(Tiger-Monkey) punishment','Attraction despite clashing. Watch traffic safety!'],
        [1,10,'‰∏ëÊàå(Ox-Dog) punishment','Part of disrespect. Stubbornness causes conflicts!'],
        [10,7,'ÊàåÊú™(Dog-Goat) punishment','Part of disrespect. Earth signs clash!'],
        [1,7,'‰∏ëÊú™(Ox-Goat) punishment','Part of disrespect. Wealth conflicts!'],
        [0,3,'Â≠êÂçØ(Rat-Rabbit) punishment','Disrespect type. Easy to lose manners. Watch your words!']
    ];
    for (let [a,b,n,desc] of brHyung) {
        const ia = brs.indexOf(a), ib = brs.indexOf(b);
        if (ia >= 0 && ib >= 0) {
            // Skip if already in triple punishment
            if (!(brs.includes(2) && brs.includes(5) && brs.includes(8) && [2,5,8].includes(a) && [2,5,8].includes(b)) &&
                !(brs.includes(1) && brs.includes(10) && brs.includes(7) && [1,10,7].includes(a) && [1,10,7].includes(b))) {
                res.push({t:'Âàë',c:`${BRANCH[a].c}‚Üî${BRANCH[b].c}`,m:n,d:desc});
            }
        }
    }
    // 4. ÏûêÌòï (Ëá™Âàë) - Í∞ôÏùÄ Í∏ÄÏûêÎÅºÎ¶¨
    const selfPunish = {4:'Ëæ∞Ëæ∞(Dragon-Dragon) self-punishment',6:'ÂçàÂçà(Horse-Horse) self-punishment',9:'ÈÖâÈÖâ(Rooster-Rooster) self-punishment',11:'‰∫•‰∫•(Pig-Pig) self-punishment'};
    for (let i = 0; i < brs.length; i++) {
        for (let j = i+1; j < brs.length; j++) {
            if (brs[i] === brs[j] && selfPunish[brs[i]]) {
                res.push({t:'Ëá™Âàë',c:`${BRANCH[brs[i]].c}+${BRANCH[brs[j]].c}`,m:selfPunish[brs[i]],d:'ü™û Self-Punishment energy. You tend to be hard on yourself. Your greatest critic lives within. Practice self-compassion and celebrate small wins. You deserve kindness from yourself.'});
            }
        }
    }
    
    // Break
    const brPa = [[0,9,'Â≠êÈÖâ(Rat-Rooster) destruction','Relationships may break easily.'],[3,6,'ÂçØÂçà(Rabbit-Horse) destruction','Plans may go awry.'],[2,11,'ÂØÖ‰∫•(Tiger-Pig) destruction','Complete tasks properly.'],[4,1,'Ëæ∞‰∏ë(Dragon-Ox) destruction','Foundation may shake.']];
    for (let [a,b,n,desc] of brPa) {
        if (brs.includes(a) && brs.includes(b)) res.push({t:'Á†¥',c:`${BRANCH[a].c}‚Üî${BRANCH[b].c}`,m:n,d:desc});
    }
    
    // Harm
    const brHae = [[0,7,'Â≠êÊú™(Rat-Goat) harm','Close ones may hold you back.'],[1,6,'‰∏ëÂçà(Ox-Horse) harm','Watch partnerships!'],[2,5,'ÂØÖÂ∑≥(Tiger-Snake) harm','Jealousy may arise. Avoid showing off.'],[3,4,'ÂçØËæ∞(Rabbit-Dragon) harm','Small matters may cause big fights.']];
    for (let [a,b,n,desc] of brHae) {
        if (brs.includes(a) && brs.includes(b)) res.push({t:'ÂÆ≥',c:`${BRANCH[a].c}‚Üî${BRANCH[b].c}`,m:n,d:desc});
    }
    
    // Resentment - Important for compatibility
    const wonJin = [[0,7,'Â≠êÊú™(Rat-Goat) resentment'],[1,6,'‰∏ëÂçà(Ox-Horse) resentment'],[2,5,'ÂØÖÂ∑≥(Tiger-Snake) resentment'],[3,4,'ÂçØËæ∞(Rabbit-Dragon) resentment'],[4,3,'Ëæ∞ÂçØ(Dragon-Rabbit) resentment'],[5,2,'Â∑≥ÂØÖ(Snake-Tiger) resentment'],[6,1,'Âçà‰∏ë(Horse-Ox) resentment'],[7,0,'Êú™Â≠ê(Goat-Rat) resentment'],[8,11,'Áî≥‰∫•(Monkey-Pig) resentment'],[9,10,'ÈÖâÊàå(Rooster-Dog) resentment'],[10,9,'ÊàåÈÖâ(Dog-Rooster) resentment'],[11,8,'‰∫•Áî≥(Pig-Monkey) resentment']];
    for (let [a,b,n] of wonJin) {
        if (brs.includes(a) && brs.includes(b)) {
            res.push({t:'ÊÄ®Âóî',c:`${BRANCH[a].c}‚Üî${BRANCH[b].c}`,m:n,d:'üíî Resentment energy. A complex love-hate dynamic ‚Äî you cant live with them, cant live without them. In relationships, acknowledge the tension and communicate openly to transform it into growth.'});
        }
    }
    
    // Ghost Gate
    const guiMen = [[2,7,'ÂØÖÊú™(Tiger-Goat) Spirit Gate'],[3,8,'ÂçØÁî≥(Rabbit-Monkey) Intuitive Flash'],[4,9,'Ëæ∞ÈÖâ(Dragon-Rooster) Artistic Nerves'],[5,10,'Â∑≥Êàå(Snake-Dog) Deep Insight'],[6,11,'Âçà‰∫•(Horse-Pig) Mystic Gate'],[1,6,'‰∏ëÂçà(Ox-Horse) Emotional Depth']];
    for (let [a,b,n] of guiMen) {
        if (brs.includes(a) && brs.includes(b)) {
            res.push({t:'È¨ºÈñÄ',c:`${BRANCH[a].c}‚Üî${BRANCH[b].c}`,m:n,d:'üëÅÔ∏è Spirit Gate open. You possess extraordinary intuition and can sense what others cannot. This is a gift! Channel it through art, spirituality, meditation, or counseling. Trust your inner voice.'});
        }
    }
    
    return res.length ? res : [{t:'-',c:'none',m:'No special interactions',d:'No significant clash or harmony. A peaceful, balanced chart!'}];
}

/* ========================================
   14. Í≥µÎßù
   ======================================== */
function calcGongmang(saju) {
    if (!saju || !saju.day) return { gm: [], names: [], affected: [] };

    const stemIdx = STEM.findIndex(s => s.c === saju.day.s.c);
    const branchIdx = BRANCH.findIndex(b => b.c === saju.day.b.c);

    // Calculate remaining to Gui(9)
    const toGui = 9 - stemIdx; 
    const gm1 = (branchIdx + toGui + 1) % 12; // First emptiness
    const gm2 = (branchIdx + toGui + 2) % 12; // Second emptiness

    const gm = [gm1, gm2];
    const names = [BRANCH[gm1].c, BRANCH[gm2].c];
    
    const affected = [];
    const pillars = ['Year Branch','Month Branch','Day Branch','Hour Branch'];
    const brs = [
        BRANCH.findIndex(b => b.c === saju.year.b.c),
        BRANCH.findIndex(b => b.c === saju.month.b.c),
        BRANCH.findIndex(b => b.c === saju.day.b.c)
    ];
    if (saju.hour) brs.push(BRANCH.findIndex(b => b.c === saju.hour.b.c));

    brs.forEach((b, i) => { 
        if (gm.includes(b)) affected.push(pillars[i]); 
    });

    return { gm, names, affected };
}

/* ========================================
   14-0-1. Six Relations - Parents/Siblings/Children/Spouse fortune
   ======================================== */
function analyzeYukChinRon(saju, gender) {
    const dm = saju.day.s;
    const result = {
        father: null,    // Father (ÂÅèË≤°/Indirect Wealth)
        mother: null,    // Mother (Direct Seal/Indirect Seal)
        sibling: null,   // Sibling (Peer/Competitor)
        spouse: null,    // Spouse (M:Wealth, F:Officer)
        children: null   // Children (M:Officer, F:Food/Hurt)
    };
    
    // Ten Gods distribution analysis
    const godCount = {};
    const godPositions = {};
    const pillars = [
        {name: 'Year Pillar', pillar: saju.year},
        {name: 'Month', pillar: saju.month},
        {name: 'Day', pillar: saju.day},
    ];
    if (saju.hour) pillars.push({name: 'Hour', pillar: saju.hour});
    
    pillars.forEach(p => {
        if (p.name === 'Day') return; // Exclude Day Master
        const sGod = getTenGod(p.pillar.s, dm);
        const bGod = getTenGod(p.pillar.b, dm); // Based on branch main stem
        
        [sGod, bGod].forEach(god => {
            if (god) {
                if (!godCount[god.k]) godCount[god.k] = 0;
                if (!godPositions[god.k]) godPositions[god.k] = [];
                godCount[god.k]++;
                godPositions[god.k].push(p.name);
            }
        });
    });
    
    // 1. Î∂ÄÏπúÏö¥ (ÂÅèË≤°/Indirect Wealth)
    const fatherGod = 'ÂÅèË≤°(Indirect Wealth)';
    const fatherCount = godCount[fatherGod] || 0;
    if (fatherCount >= 2) {
        result.father = {status: 'strong', desc: 'Deep bond with father. You receive paternal support and blessings.', icon: 'üë®‚Äçüë¶'};
    } else if (fatherCount === 1) {
        result.father = {status: 'normal', desc: 'Normal relationship with father. Healthy distance works well.', icon: 'üë®'};
    } else {
        result.father = {status: 'weak', desc: 'Weak father bond or early separation possible.', icon: 'üë§'};
    }
    
    // 2. Î™®ÏπúÏö¥ (Direct Seal/Indirect Seal)
    const motherCount = (godCount['Ê≠£Âç∞(Direct Seal)'] || 0) + (godCount['ÂÅèÂç∞(Indirect Seal)'] || 0);
    if (motherCount >= 2) {
        result.mother = {status: 'strong', desc: 'Deep bond with mother. You receive abundant maternal love.', icon: 'üë©‚Äçüë¶'};
    } else if (motherCount === 1) {
        result.mother = {status: 'normal', desc: 'Normal relationship with mother.', icon: 'üë©'};
    } else {
        result.mother = {status: 'weak', desc: 'Weak mother bond or early independence likely.', icon: 'üë§'};
    }
    
    // 3. Sibling fortune (Peer/Competitor)
    const siblingCount = (godCount['ÊØîËÇ©(Peer)'] || 0) + (godCount['Âä´Ë≤°(Competitor)'] || 0);
    if (siblingCount >= 2) {
        result.sibling = {status: 'strong', desc: 'Many siblings or deep sibling bonds. Some competition possible.', icon: 'üë´'};
    } else if (siblingCount === 1) {
        result.sibling = {status: 'normal', desc: 'Average relationship with siblings.', icon: 'üßë‚Äçü§ù‚Äçüßë'};
    } else {
        result.sibling = {status: 'weak', desc: 'Few siblings or weak connection. Strong independence.', icon: 'üßç'};
    }
    
    // 4. Spouse Fortune (ÎÇ®:Ïû¨ÏÑ±, Ïó¨:Í¥ÄÏÑ±)
    let spouseCount, spouseGods;
    if (gender === 'm') {
        spouseCount = (godCount['Ê≠£Ë≤°(Direct Wealth)'] || 0) + (godCount['ÂÅèË≤°(Indirect Wealth)'] || 0);
        spouseGods = ['Ê≠£Ë≤°(Direct Wealth)', 'ÂÅèË≤°(Indirect Wealth)'];
    } else {
        spouseCount = (godCount['Ê≠£ÂÆò(Direct Officer)'] || 0) + (godCount['ÂÅèÂÆò(Challenger)'] || 0);
        spouseGods = ['Ê≠£ÂÆò(Direct Officer)', 'ÂÅèÂÆò(Challenger)'];
    }
    
    // Day Branch(Spouse Palace) Î∂ÑÏÑù
    const spouseGod = getTenGod(saju.day.b, dm);
    const spouseGodMatch = spouseGod && spouseGods.includes(spouseGod.k);
    
    if (spouseCount >= 2 && spouseGodMatch) {
        result.spouse = {status: 'excellent', desc: 'Excellent spouse fortune! You will meet a great partner.', icon: 'üíë'};
    } else if (spouseCount >= 1 || spouseGodMatch) {
        result.spouse = {status: 'good', desc: 'Good spouse fortune. Marriage brings stability.', icon: 'üíç'};
    } else {
        result.spouse = {status: 'normal', desc: 'Average spouse connection. Meeting later is fine.', icon: 'üíí'};
    }
    
    // 5. Children fortune (M:Officer, F:Food/Hurt)
    let childCount;
    if (gender === 'm') {
        childCount = (godCount['Ê≠£ÂÆò(Direct Officer)'] || 0) + (godCount['ÂÅèÂÆò(Challenger)'] || 0);
    } else {
        childCount = (godCount['È£üÁ•û(Eating God)'] || 0) + (godCount['ÂÇ∑ÂÆò(Expressor)'] || 0);
    }
    
    // Hour(Children Palace) Î∂ÑÏÑù
    const hasHour = !!saju.hour;
    if (childCount >= 2) {
        result.children = {status: 'strong', desc: 'Excellent children fortune! Your children will make you proud.', icon: 'üë∂üë∂'};
    } else if (childCount === 1) {
        result.children = {status: 'normal', desc: 'Normal children fortune. 1-2 children recommended.', icon: 'üë∂'};
    } else {
        result.children = {status: 'weak', desc: 'Weak children bond or late arrival possible. Effort is essential.', icon: 'üçº'};
    }
    
    return result;
}

/* ========================================
   14-0-2. ÏßàÎ≥ëÎ°†(ÁñæÁóÖË´ñ) - Ïò§ÌñâÎ≥Ñ Í±¥Í∞ï
   ======================================== */
function analyzeHealth(saju, gods) {
    const result = {
        strong: [],  // Strong elements (excess)
        weak: [],    // Weak elements (deficient)
        advice: []   // Health advice
    };
    
    // Five Elements calculation
    const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if (p && p.s) elCount[p.s.e]++;
        if (p && p.b) elCount[p.b.e]++;
    });
    
    // Five ElementsÎ≥Ñ Ïû•Í∏∞/ÏßàÎ≥ë Îß§Ìïë
    const healthMap = {
        wood: {
            organ: 'Liver, Gallbladder, Eyes, Muscles, Nails',
            excess: 'Headaches, red eyes, muscle cramps, irritability',
            deficient: 'Poor vision, fatigue, weak muscles, brittle nails',
            advice: 'Eat green vegetables, rest eyes, stretch regularly'
        },
        fire: {
            organ: 'Heart, Small Intestine, Tongue, Blood Vessels',
            excess: 'Insomnia, palpitations, tongue sores, high blood pressure',
            deficient: 'Low blood pressure, cold hands/feet, depression, lethargy',
            advice: 'Red foods (tomatoes, dates), cardio exercise, meditation'
        },
        earth: {
            organ: 'Spleen, Stomach, Lips, Flesh',
            excess: 'Poor digestion, obesity, cracked lips, excessive worry',
            deficient: 'Poor appetite, thinness, weak digestion, fatigue',
            advice: 'Yellow foods (sweet potato, pumpkin), regular meals, avoid overeating'
        },
        metal: {
            organ: 'Lungs, Large Intestine, Nose, Skin, Body Hair',
            excess: 'Skin problems, constipation, respiratory sensitivity',
            deficient: 'Frequent colds, dry skin, weak colon, sadness',
            advice: 'White foods (radish, pear, bellflower), breathing exercises, moisturize skin'
        },
        water: {
            organ: 'Kidneys, Bladder, Ears, Bones, Hair',
            excess: 'Swelling, bedwetting, excessive fear',
            deficient: 'Weak lower back, hair loss, tinnitus, low vitality, weak bones',
            advice: 'Black foods (black beans, seaweed), stay hydrated, lower back exercises'
        }
    };
    
    const elNames = {wood:'Wood(Êú®)', fire:'Fire(ÁÅ´)', earth:'Earth(Âúü)', metal:'Metal(Èáë)', water:'Water(Ê∞¥)'};
    
    // Analysis
    for (const el in elCount) {
        const count = elCount[el];
        const info = healthMap[el];
        
        if (count >= 3) {
            result.strong.push({
                element: elNames[el],
                count: count,
                organ: info.organ,
                symptom: info.excess,
                icon: '‚ö†Ô∏è'
            });
        } else if (count === 0) {
            result.weak.push({
                element: elNames[el],
                count: count,
                organ: info.organ,
                symptom: info.deficient,
                icon: '‚ùó'
            });
        }
    }
    
    // Yongsin/Í∏∞Ïã† Í∏∞Î∞ò Ï°∞Ïñ∏
    if (gods.yong) {
        const yongInfo = healthMap[gods.yong];
        if (yongInfo) {
            result.advice.push({
                title: `Beneficial Element (${elNames[gods.yong]}) reinforcement`,
                desc: yongInfo.advice,
                icon: 'üí™'
            });
        }
    }
    
    // Find weakest element
    let minEl = null, minCount = 10;
    for (const el in elCount) {
        if (elCount[el] < minCount) {
            minCount = elCount[el];
            minEl = el;
        }
    }
    if (minEl && healthMap[minEl]) {
        result.advice.push({
            title: `Lacking ${elNames[minEl]} reinforcement`,
            desc: healthMap[minEl].advice,
            icon: 'ü©∫'
        });
    }
    
    // Season Ï°∞Ïñ∏ (Month Branch Í∏∞Ï§Ä)
    const monthEl = saju.month.b.e;
    if (monthEl === 'water' || monthEl === 'metal') {
        result.advice.push({
            title: 'Watch for cold energy',
            desc: 'Born in autumn/winter - body may run cold. Stay warm!',
            icon: 'üî•'
        });
    } else if (monthEl === 'fire') {
        result.advice.push({
            title: 'Watch for hot energy',
            desc: 'Born in summer - body may run hot. Stay cool!',
            icon: '‚ùÑÔ∏è'
        });
    }
    
    return result;
}

/* ========================================
   14-0. Í∂ÅÏúÑ(ÂÆÆ‰Ωç) Î∂ÑÏÑù
   ======================================== */
function analyzeGungwi(saju, birthYear) {
    const dm = saju.day.s;
    const curAge = new Date().getFullYear() - birthYear;
    
    // Palace definitions
    const gungwi = [
        {
            name: 'Year Pillar',
            alias: 'Ancestor Palace¬∑Social Palace',
            pillar: saju.year,
            ageRange: 'Ages 1-15',
            represents: 'Ancestors, grandparents, social environment, early fortune',
            bodyPart: 'Head, face',
            relationM: 'Grandparents, maternal family',
            relationF: 'Grandmother, maternal family'
        },
        {
            name: 'Month(ÊúàÊü±)',
            alias: 'Parents Palace¬∑Career Palace',
            pillar: saju.month,
            ageRange: 'Ages 16-30',
            represents: 'Parents, siblings, career, business, youth fortune',
            bodyPart: 'Chest, shoulders',
            relationM: 'Father, siblings',
            relationF: 'Mother, sisters'
        },
        {
            name: 'Day(Êó•Êü±)',
            alias: 'Spouse Palace¬∑Self Palace',
            pillar: saju.day,
            ageRange: 'Ages 31-45',
            represents: 'Self, spouse, family, middle age fortune',
            bodyPart: 'Waist, abdomen',
            relationM: 'Spouse, self',
            relationF: 'Husband, self'
        },
        {
            name: 'Hour(ÊôÇÊü±)',
            alias: 'Children Palace¬∑Later Years Palace',
            pillar: saju.hour,
            ageRange: 'Ages 46+',
            represents: 'Children, students, juniors, later years, outcomes',
            bodyPart: 'Legs, feet',
            relationM: 'Children, juniors',
            relationF: 'Children, juniors'
        }
    ];
    
    // Analyze each palace
    return gungwi.map((g, idx) => {
        if (!g.pillar) return {...g, analysis: 'No hour data', god: null, state: null};
        
        const god = idx !== 2 ? getTenGod(g.pillar.s, dm) : null;
        const state = getTwelveState(dm, g.pillar.b);
        
        // Analyze palace status
        let analysis = '';
        let rating = 'neutral';
        
        // Determine palace energy by Twelve States
        if (state.l >= 9) {
            analysis = 'Strong energy period! Active and dynamic time.';
            rating = 'good';
        } else if (state.l >= 6) {
            analysis = 'Stable energy. A smooth and fortunate period.';
            rating = 'good';
        } else if (state.l >= 3) {
            analysis = 'Moderate energy. A period requiring effort.';
            rating = 'neutral';
        } else {
            analysis = 'Weak energy period. Avoid overexertion.';
            rating = 'bad';
        }
        
        // Additional analysis by Ten Gods
        if (god) {
            if (['Ê≠£ÂÆò(Direct Officer)','Ê≠£Ë≤°(Direct Wealth)','Ê≠£Âç∞(Direct Seal)'].includes(god.k)) {
                analysis += ` ${god.k} brings stability to this period.`;
                rating = 'good';
            } else if (['ÂÅèÂÆò(Challenger)','Âä´Ë≤°(Competitor)'].includes(god.k)) {
                analysis += ` ${god.k} brings transformation and challenges to this period.`;
            }
        }
        
        // Check if current age matches palace
        let isCurrent = false;
        if (idx === 0 && curAge <= 15) isCurrent = true;
        else if (idx === 1 && curAge >= 16 && curAge <= 30) isCurrent = true;
        else if (idx === 2 && curAge >= 31 && curAge <= 45) isCurrent = true;
        else if (idx === 3 && curAge >= 46) isCurrent = true;
        
        return {
            ...g,
            god,
            state,
            analysis,
            rating,
            isCurrent
        };
    });
}

/* ========================================
   14-0-2. 12Ïö¥ÏÑ± ÏôÑÏ†Ñ Î∂ÑÏÑù
   ======================================== */
function analyzeTwelveStates(saju) {
    const dm = saju.day.s;
    const result = {
        pillars: [],
        summary: '',
        dominant: null,
        lifeFlow: []
    };
    
    const pillarNames = ['Year Pillar', 'Month', 'Day', 'Hour'];
    const pillars = [saju.year, saju.month, saju.day, saju.hour];
    
    // Twelve States for each pillar
    pillars.forEach((p, idx) => {
        if (!p) return;
        const state = getTwelveState(dm, p.b);
        result.pillars.push({
            name: pillarNames[idx],
            branch: p.b,
            state: state,
            energy: state.l
        });
    });
    
    // Life flow analysis (12Ïö¥ÏÑ± ÏàúÏÑúÎåÄÎ°ú)
    const lifeStages = [
        {stage: 'Birth(Èï∑Áîü)', desc: 'New beginning, hope and possibilities', life: 'Infancy'},
        {stage: 'Bath(Ê≤êÊµ¥)', desc: 'Change and instability, new environment', life: 'Adolescence'},
        {stage: 'Crown(ÂÜ†Â∏∂)', desc: 'Growth and development, independence', life: 'Youth'},
        {stage: 'Prime(Âª∫Á•ø)', desc: 'Stability and prosperity, prime time', life: 'Adulthood'},
        {stage: 'Peak(Â∏ùÊó∫)', desc: 'Peak, zenith, power', life: 'Middle age'},
        {stage: 'Decline(Ë°∞)', desc: 'Beginning of descent, consolidation', life: 'Late middle age'},
        {stage: 'Illness(ÁóÖ)', desc: 'Weakness, watch health', life: 'Early elderly'},
        {stage: 'Stillness(Ê≠ª)', desc: 'Completion, ending', life: 'Elderly'},
        {stage: 'Storage(Â¢ì)', desc: 'Storage, accumulation, retirement', life: 'Late elderly'},
        {stage: 'Void(Áµ∂)', desc: 'Emptiness, severance', life: 'Later years'},
        {stage: 'Conception(ËÉé)', desc: 'Conception, preparation', life: 'New preparation'},
        {stage: 'Nurture(È§ä)', desc: 'Nurturing, protection', life: 'Recovery'}
    ];
    
    // Determine base energy by Day Branch Twelve States
    const dayState = getTwelveState(dm, saju.day.b);
    if (dayState.l >= 10) {
        result.summary = 'Very strong base energy! Full of vitality and drive.';
        result.dominant = 'strong';
    } else if (dayState.l >= 7) {
        result.summary = 'Good base energy. Stable and consistent.';
        result.dominant = 'good';
    } else if (dayState.l >= 4) {
        result.summary = 'Average base energy. Compensate with effort.';
        result.dominant = 'neutral';
    } else {
        result.summary = 'Weak base energy. Health management is important.';
        result.dominant = 'weak';
    }
    
    // Life flow (ÎÖÑ‚ÜíÏõî‚ÜíÏùº‚ÜíÏãú)
    result.lifeFlow = result.pillars.map((p, idx) => {
        const ageRange = ['Early years(1-15)', 'Youth(16-30)', 'Middle age(31-45)', 'Later years(46+)'][idx];
        return {
            period: ageRange,
            state: p.state.k,
            energy: p.energy,
            advice: p.energy >= 8 ? 'Active period!' : p.energy >= 5 ? 'Stable period' : p.energy >= 3 ? 'Patience period' : 'Recovery period'
        };
    });
    
    return result;
}

/* ========================================
   14-0-3. Advanced Harmony/Clash Analysis (Transformation, Resolution)
   ======================================== */
function analyzeAdvancedInteractions(saju) {
    const result = {
        hapHwa: [],      // Transformation analysis
        chungHaeso: [],  // Clash resolution analysis
        samhapGuk: [],   // Trinity analysis
        warnings: []
    };
    
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    const season = SEASON[mbi];
    const stems = [saju.year?.s, saju.month?.s, saju.day?.s, saju.hour?.s].filter(s => s);
    const stemIdxs = stems.map(s => STEM.indexOf(s));
    const brs = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), BRANCH.findIndex(br => br.c === saju.day.b.c)];
    if (saju.hour) brs.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    
    // ========== Stem Transformation Conditions ==========
    const ganHap = [
        {pair: [0,5], result: 'earth', name: 'Áî≤Â∑± (Wood+Earth) combine to Earth(Áî≤Â∑±ÂêàÂúü)', condition: 'EarthÏõî(Ëæ∞Êàå‰∏ëÊú™Êúà) ÎòêÎäî EarthÍ∞Ä ÏôïÏÑ±Ìï† Îïå'},
        {pair: [1,6], result: 'metal', name: '‰πôÂ∫ö (Wood+Metal) combine to Metal(‰πôÂ∫öÂêàÈáë)', condition: 'MetalÏõî(Áî≥ÈÖâÊúà) ÎòêÎäî MetalÏù¥ ÏôïÏÑ±Ìï† Îïå'},
        {pair: [2,7], result: 'water', name: '‰∏ôËæõ (Fire+Metal) combine to Water(‰∏ôËæõÂêàÊ∞¥)', condition: 'WaterÏõî(‰∫•Â≠êÊúà) ÎòêÎäî WaterÍ∞Ä ÏôïÏÑ±Ìï† Îïå'},
        {pair: [3,8], result: 'wood', name: '‰∏ÅÂ£¨ (Fire+Water) combine to Wood(‰∏ÅÂ£¨ÂêàÊú®)', condition: 'WoodÏõî(ÂØÖÂçØÊúà) ÎòêÎäî WoodÏù¥ ÏôïÏÑ±Ìï† Îïå'},
        {pair: [4,9], result: 'fire', name: 'ÊàäÁô∏ (Earth+Water) combine to Fire(ÊàäÁô∏ÂêàÁÅ´)', condition: 'FireÏõî(Â∑≥ÂçàÊúà) ÎòêÎäî FireÍ∞Ä ÏôïÏÑ±Ìï† Îïå'}
    ];
    
    for (let gh of ganHap) {
        if (stemIdxs.includes(gh.pair[0]) && stemIdxs.includes(gh.pair[1])) {
            // Harmony exists
            const resultEl = gh.result;
            let isHwa = false;
            let reason = '';
            
            // Check if month energy matches element
            const seasonEl = {spring:'wood', summer:'fire', autumn:'metal', winter:'water'};
            if (seasonEl[season] === resultEl) {
                isHwa = true;
                reason = `Month energy is ${ELEMENT[resultEl].k} - Combination formed!`;
            }
            // Check if branches have many of this element
            const resultElCount = brs.filter(b => BRANCH[b].e === resultEl).length;
            if (resultElCount >= 2) {
                isHwa = true;
                reason = `Branches have ${ELEMENT[resultEl].k} x${resultElCount} - Combination formed!`;
            }
            
            result.hapHwa.push({
                name: gh.name,
                stems: `${STEM[gh.pair[0]].c}+${STEM[gh.pair[1]].c}`,
                result: isHwa ? ELEMENT[resultEl].k : null,
                isHwa,
                reason: isHwa ? reason : 'üí´ Harmony exists but hasnt transformed yet. The energy is bonded but waiting for the right conditions to fully activate.'
            });
        }
    }
    
    // ========== Branch Trinity Formation Check ==========
    const samhap = [
        {branches: [2,6,10], result: 'fire', name: 'ÂØÖÂçàÊàå(Tiger-Horse-Dog) Fire combination(ÂØÖÂçàÊàå ÁÅ´Â±Ä)'},
        {branches: [5,9,1], result: 'metal', name: 'Â∑≥ÈÖâ‰∏ë(Snake-Rooster-Ox) Metal combination(Â∑≥ÈÖâ‰∏ë ÈáëÂ±Ä)'},
        {branches: [8,0,4], result: 'water', name: 'Áî≥Â≠êËæ∞(Monkey-Rat-Dragon) Water combination(Áî≥Â≠êËæ∞ Ê∞¥Â±Ä)'},
        {branches: [11,3,7], result: 'wood', name: '‰∫•ÂçØÊú™(Pig-Rabbit-Goat) Wood combination(‰∫•ÂçØÊú™ Êú®Â±Ä)'}
    ];
    
    for (let sh of samhap) {
        const hasCount = sh.branches.filter(b => brs.includes(b)).length;
        if (hasCount >= 2) {
            const hasCenter = brs.includes(sh.branches[1]); // Center branch (Ïò§ÌñâÏùò ÏôïÏßÄ)
            result.samhapGuk.push({
                name: sh.name,
                complete: hasCount === 3,
                hasCenter,
                result: ELEMENT[sh.result].k,
                desc: hasCount === 3 ? 
                    `Complete ${sh.name} formed! ${ELEMENT[sh.result].k} energy is strong.` :
                    hasCenter ? 
                    `${sh.name} half-combination. Center branch (${BRANCH[sh.branches[1]].c}) present - strong power.` :
                    `${sh.name} half-combination but lacks center branch - weak power.`
            });
        }
    }
    
    // ========== Clash Resolution Check ==========
    const clashPairs = [[0,6],[1,7],[2,8],[3,9],[4,10],[5,11]];
    for (let [a,b] of clashPairs) {
        if (brs.includes(a) && brs.includes(b)) {
            // Clash exists
            let isResolved = false;
            let resolveReason = '';
            
            // Check if resolved by harmony (Six Harmony)
            const hapPairs = [[0,1],[2,11],[3,10],[4,9],[5,8],[6,7]];
            for (let [ha, hb] of hapPairs) {
                if ((brs.includes(a) && (brs.includes(ha) && a === hb) || (brs.includes(hb) && a === ha)) ||
                    (brs.includes(b) && (brs.includes(ha) && b === hb) || (brs.includes(hb) && b === ha))) {
                    // If one of the clash parties Ìï©ÏùÑ ÎßåÎÇòÎ©¥ Ï∂©Ïù¥ ÏïΩÌï¥Ïßê
                    isResolved = true;
                    resolveReason = '‚úÖ Harmony energy neutralizes the clash. Conflicts are softened and transitions become smoother.';
                }
            }
            
            result.chungHaeso.push({
                clash: `${BRANCH[a].c}${BRANCH[b].c} Clash`,
                isResolved,
                reason: isResolved ? resolveReason : 'Active clash energy. Expect changes, conflicts, or restlessness. Stay flexible and avoid major decisions during turbulent times.'
            });
        }
    }
    
    // ========== Í≤ΩÍ≥† ÏÇ¨Ìï≠ ==========
    // Check Expressor-Officer clash
    const dm = saju.day.s;
    const godCounts = {};
    stems.forEach((s, idx) => {
        if (idx === 2) return; // Day Master Ï†úÏô∏
        const god = getTenGod(s, dm);
        godCounts[god.k] = (godCounts[god.k] || 0) + 1;
    });
    
    if (godCounts['ÂÇ∑ÂÆò(Expressor)'] && godCounts['Ê≠£ÂÆò(Direct Officer)']) {
        result.warnings.push({
            type: 'Officer Conflict (ÂÇ∑ÂÆòË¶ãÂÆò)',
            desc: '‚ö° Creative energy conflicts with authority. You may struggle in hierarchical environments. Embrace entrepreneurship, freelancing, or creative careers where you set your own rules!'
        });
    }
    
    if (godCounts['ÂÅèÂç∞(Indirect Seal)'] && godCounts['È£üÁ•û(Eating God)']) {
        result.warnings.push({
            type: 'Blocked Expression (Ê¢üÁ•ûÂ•™È£ü)',
            desc: 'üå´Ô∏è Your creative talents may feel suppressed. Dont let overthinking stop you from expressing yourself. Physical exercise and creative hobbies help release this blocked energy.'
        });
    }
    
    return result;
}

/* ========================================
   14-1. Hidden Stems(Âú∞ËóèÂπ≤) Î∂ÑÏÑù
   ======================================== */
// Return Hidden Stems info for specific branch
function getJijanggan(branch) {
    const bi = BRANCH.findIndex(br => br.c === branch.c);
    return HIDDEN_STEMS[bi] || [];
}

// Check if specific stem exists in Hidden Stems (Ìà¨Ï∂ú Ïó¨Î∂Ä)
function hasHiddenStem(branch, stemIdx) {
    const jj = getJijanggan(branch);
    return jj.some(j => j.stem === stemIdx);
}

// Analyze Day Master root connection (Root Analysis)ÌïòÎäîÏßÄ Î∂ÑÏÑù
// Root: Same element as Day Master Hidden StemsÏóê ÏûàÎäî Í≤ΩÏö∞
function analyzeRoot(dayStem, branch) {
    const jj = getJijanggan(branch);
    const dsEl = dayStem.e;
    const roots = [];
    
    jj.forEach(j => {
        const hiddenStem = STEM[j.stem];
        if (hiddenStem.e === dsEl) {
            // Root found
            const strength = j.days >= 16 ? 'strong' : j.days >= 7 ? 'medium' : 'weak';
            roots.push({
                stem: hiddenStem,
                days: j.days,
                type: j.type,
                strength,
                name: j.name
            });
        }
    });
    return roots;
}

// Analyze stem emergence in branches (Stem Reveal)ÌñàÎäîÏßÄ Î∂ÑÏÑù
// Emergence: stem character Hidden StemsÏóêÎèÑ Ï°¥Ïû¨ÌïòÎäî Í≤ΩÏö∞
function analyzeTougan(saju) {
    const result = [];
    const allStems = [
        {pillar: 'Year', stem: saju.year.s},
        {pillar: 'Month', stem: saju.month.s},
        {pillar: 'Day Master', stem: saju.day.s},
    ];
    if (saju.hour) allStems.push({pillar: 'Hour', stem: saju.hour.s});
    
    const allBranches = [
        {pillar: 'Year Branch', branch: saju.year.b},
        {pillar: 'Month Branch', branch: saju.month.b},
        {pillar: 'Day Branch', branch: saju.day.b},
    ];
    if (saju.hour) allBranches.push({pillar: 'Hour Branch', branch: saju.hour.b});
    
    allStems.forEach(st => {
        const si = STEM.indexOf(st.stem);
        allBranches.forEach(br => {
            const jj = getJijanggan(br.branch);
            jj.forEach(j => {
                if (j.stem === si) {
                    result.push({
                        stem: st.stem,
                        stemPillar: st.pillar,
                        branch: br.branch,
                        branchPillar: br.pillar,
                        days: j.days,
                        type: j.type,
                        desc: `${st.stem.c}(${st.pillar})Ïù¥ ${br.branch.c}(${br.pillar})Ïóê ÎøåÎ¶¨ÎÇ¥Î¶º`
                    });
                }
            });
        });
    });
    return result;
}

// Full Saju root analysis
function analyzeAllRoots(saju) {
    const dm = saju.day.s;
    const branches = [
        {name: 'Year Branch', branch: saju.year.b},
        {name: 'Month Branch', branch: saju.month.b},
        {name: 'Day Branch', branch: saju.day.b}
    ];
    if (saju.hour) branches.push({name: 'Hour Branch', branch: saju.hour.b});
    
    const allRoots = [];
    let totalScore = 0;
    
    branches.forEach(b => {
        const roots = analyzeRoot(dm, b.branch);
        roots.forEach(r => {
            let score = 0;
            if (r.strength === 'strong') score = 3;
            else if (r.strength === 'medium') score = 2;
            else score = 1;
            
            // Month Branch root is 2x
            if (b.name === 'Month Branch') score *= 2;
            // Day Branch root is 1.5x
            if (b.name === 'Day Branch') score *= 1.5;
            
            totalScore += score;
            allRoots.push({
                ...r,
                position: b.name,
                branch: b.branch,
                score
            });
        });
    });
    
    return { roots: allRoots, totalScore };
}

// Element count calculation (including Hidden Stems)
function countElementsAdvanced(saju) {
    const ec = {wood:0, fire:0, earth:0, metal:0, water:0};
    const details = {wood:[], fire:[], earth:[], metal:[], water:[]};
    
    // Stems (100% Î∞òÏòÅ)
    const stems = [
        {pos:'Year', s:saju.year.s},
        {pos:'Month', s:saju.month.s},
        {pos:'Day Master', s:saju.day.s}
    ];
    if (saju.hour) stems.push({pos:'Hour', s:saju.hour.s});
    
    stems.forEach(st => {
        ec[st.s.e] += 1;
        details[st.s.e].push(`${st.s.c}(${st.pos}) 1.0`);
    });
    
    // Branch main stem (100% Î∞òÏòÅ)
    const branches = [
        {pos:'Year Branch', b:saju.year.b},
        {pos:'Month Branch', b:saju.month.b},
        {pos:'Day Branch', b:saju.day.b}
    ];
    if (saju.hour) branches.push({pos:'Hour Branch', b:saju.hour.b});
    
    branches.forEach(br => {
        ec[br.b.e] += 1;
        details[br.b.e].push(`${br.b.c}(${br.pos}) 1.0`);
    });
    
    // Hidden Stems (ÎπÑÏú® Î∞òÏòÅ)
    branches.forEach(br => {
        const bi = BRANCH.findIndex(x => x.c === br.b.c);
        const jj = HIDDEN_STEMS[bi] || [];
        jj.forEach(j => {
            const hiddenStem = STEM[j.stem];
            const ratio = j.days / 30; // daysÏóê Îî∞Î•∏ ÎπÑÏú®
            ec[hiddenStem.e] += ratio * 0.5; // Hidden StemsÏùÄ 50% Í∞ÄÏ§ëÏπò
            details[hiddenStem.e].push(`${hiddenStem.c}(${br.pos}Ëóè) ${(ratio*0.5).toFixed(2)}`);
        });
    });
    
    return { counts: ec, details };
}

/* ========================================
   14-1-2. Ïò§Ìñâ Í∞úÏàò Í≥ÑÏÇ∞ (Îã®Ïàú)
   ======================================== */
function countElements(saju) {
    const ec = {wood:0, fire:0, earth:0, metal:0, water:0};
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if (!p) return;
        ec[p.s.e]++;
        ec[p.b.e]++;
    });
    return ec;
}

/* ========================================
   14-2. Detailed Analysis - Today's Fortune
   ======================================== */
function genTodayFortune(saju, gods) {
    const now = new Date();
    const ty = now.getFullYear(), tm = now.getMonth() + 1, td = now.getDate();
    const dp = calcDayPillar(ty, tm, td);
    const dm = saju.day.s;
    const god = getTenGod(dp.s, dm);
    const state = getTwelveState(dm, dp.b);
    
    const godMeaning = {
        'ÊØîËÇ©(Peer)': {r:3, l:'ü•ä Competitive Day', d:'Today, similar energies surround you. Rivals may appear or you may assert your opinions strongly.<br><br><strong>üí° Tip:</strong> Focus on solo tasks today.'},
        'Âä´Ë≤°(Competitor)': {r:2, l:'üí∏ Spending Alert', d:'Money tends to slip away today! Avoid impulse purchases or lending money to friends.<br><br><strong>üí° Tip:</strong> "Let me think about it tomorrow" is your magic spell!'},
        'È£üÁ•û(Eating God)': {r:4, l:'üçΩÔ∏è Delightful Day', d:'Everything feels relaxed and pleasant! Great for good food and hobbies.<br><br><strong>üí° Tip:</strong> Enjoy your favorite meal and let inspiration flow.'},
        'ÂÇ∑ÂÆò(Expressor)': {r:3, l:'üé§ Expression UP', d:'Words flow smoothly today! Presentations will go well. But watch out ‚Äî you might want to challenge authority!<br><br><strong>üí° Tip:</strong> Think for 3 seconds before speaking.'},
        'ÂÅèË≤°(Indirect Wealth)': {r:4, l:'üí∞ Unexpected Fortune', d:'Surprise money or great opportunities may come your way!<br><br><strong>üí° Tip:</strong> Get moving! Luck won\'t find you at home.'},
        'Ê≠£Ë≤°(Direct Wealth)': {r:4, l:'üíµ Stable Day', d:'Financial matters go smoothly. Good for contracts and deals.<br><br><strong>üí° Tip:</strong> Great day to start saving.'},
        'ÂÅèÂÆò(Challenger)': {r:2, l:'üò∞ Tense Day', d:'Sudden tasks or pressure may arise. Unexpected work might drop on you.<br><br><strong>üí° Tip:</strong> Manage your energy. Don\'t overexert.'},
        'Ê≠£ÂÆò(Direct Officer)': {r:5, l:'üèÜ Recognition Day', d:'Your best day! Your efforts may be recognized and praised.<br><br><strong>üí° Tip:</strong> Schedule important meetings today.'},
        'ÂÅèÂç∞(Indirect Seal)': {r:3, l:'üìö Solo Time', d:'You\'d rather be alone than in crowds. Perfect for study or reading.<br><br><strong>üí° Tip:</strong> How about reading a book at a quiet caf√©?'},
        'Ê≠£Âç∞(Direct Seal)': {r:4, l:'ü§ù Supportive Day', d:'Good day to receive help from others! Ask if you need anything.<br><br><strong>üí° Tip:</strong> Great for paperwork and contracts.'}
    };
    
    const info = godMeaning[god.k] || {r:3, l:'‚òÄÔ∏è Calm Day', d:'A peaceful day without major events.'};
    let bonus = '';
    if ([dp.s.e, dp.b.e].includes(gods.yong)) {
        info.r = Math.min(5, info.r + 1);
        bonus = '<div class="info-box good" style="margin-top:12px;"><p>‚ú® <strong>Lucky energy flows today!</strong> Things will go better than usual!</p></div>';
    } else if ([dp.s.e, dp.b.e].includes(gods.gi)) {
        info.r = Math.max(1, info.r - 1);
        bonus = '<div class="info-box warn" style="margin-top:12px;"><p>‚ö†Ô∏è <strong>Be cautious today!</strong> Postpone big decisions to tomorrow.</p></div>';
    }
    
    // Good/Bad hours
    const goodH = [], badH = [];
    const hourNames = ['Î∞§ 11Ïãú~ÏÉàÎ≤Ω 1Ïãú','ÏÉàÎ≤Ω 1~3Ïãú','ÏÉàÎ≤Ω 3~5Ïãú','ÏïÑÏπ® 5~7Ïãú','ÏïÑÏπ® 7~9Ïãú','Ïò§Ï†Ñ 9~11Ïãú','ÎÇÆ 11Ïãú~Ïò§ÌõÑ 1Ïãú','Ïò§ÌõÑ 1~3Ïãú','Ïò§ÌõÑ 3~5Ïãú','Ï†ÄÎÖÅ 5~7Ïãú','Ï†ÄÎÖÅ 7~9Ïãú','Î∞§ 9~11Ïãú'];
    for (let i = 0; i < 12; i++) {
        const hEl = BRANCH[i].e;
        if (hEl === gods.yong) goodH.push(hourNames[i]);
        else if (hEl === gods.gi) badH.push(hourNames[i]);
    }
    
    return `
        <div class="info-box gold">
            <p><strong>üìÖ Month ${tm}, Day ${td} Today's Fortune</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">Today's energy: ${dp.s.c}${dp.b.c} (${dp.b.m} Day)</p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'‚≠ê'.repeat(info.r)}${'‚òÜ'.repeat(5-info.r)}</span>
        </div>
        <div class="info-box">
            <p><strong>${info.l}</strong></p>
            <p style="margin-top:10px;line-height:1.8;">${info.d}</p>
        </div>
        ${bonus}
        <div class="info-box good" style="margin-top:12px;">
            <p><strong>‚è∞ Lucky Hours</strong><br>${goodH.length ? goodH.join(', ') : 'None in particular'}</p>
        </div>
        <div class="info-box warn" style="margin-top:12px;">
            <p><strong>‚è∞ Caution Hours</strong><br>${badH.length ? badH.join(', ') : 'None in particular'}</p>
        </div>
        <div class="info-box" style="margin-top:12px;">
            <p><strong>üìå Today's Energy: ${state.k}</strong><br>${state.d}</p>
        </div>`;
}

/* ========================================
   14-3. Detailed Analysis - Annual Fortune
   ======================================== */
function genYearFortune(saju, gods, year) {
    const yp = calcYearPillar(year, 2, 5);
    const dm = saju.day.s;
    const god = getTenGod(yp.s, dm);
    const state = getTwelveState(dm, yp.b);
    
    let rating = 3, desc = '';
    if ([yp.s.e, yp.b.e].includes(gods.yong)) { rating = 5; desc = 'Great year with Beneficial Element! Move actively!'; }
    else if ([yp.s.e, yp.b.e].includes(gods.hee)) { rating = 4; desc = 'Good year with Supporting Element! Things go smoothly.'; }
    else if ([yp.s.e, yp.b.e].includes(gods.gi)) { rating = 2; desc = 'Challenging Element year. Be cautious and avoid overexertion.'; }
    else { desc = 'A steady year. Keep working consistently.'; }
    
    if (state.l >= 9) { rating = Math.min(5, rating + 1); desc += ' 12Ïö¥ÏÑ±Ïù¥ Í∞ïÌï¥ÏÑú EnergyÍ∞Ä ÎÑòÏ≥êÏöî!'; }
    else if (state.l <= 3) { rating = Math.max(1, rating - 1); desc += ' 12Ïö¥ÏÑ±Ïù¥ ÏïΩÌï¥ÏÑú Ï≤¥Î†• Í¥ÄÎ¶¨Í∞Ä is essential.'; }
    
    // Monthly points
    const months = [];
    for (let m = 1; m <= 12; m++) {
        const mp = calcMonthPillar(year, m, 15);
        const mGod = getTenGod(mp.s, dm);
        let tip = '';
        if (['Ê≠£ÂÆò(Direct Officer)','Ê≠£Ë≤°(Direct Wealth)'].includes(mGod.k)) tip = 'üü¢ Ï¢ãÏùå';
        else if (['ÂÅèÂÆò(Challenger)','Âä´Ë≤°(Competitor)'].includes(mGod.k)) tip = 'üî¥ Ï£ºÏùò';
        else tip = 'üü° Average';
        months.push(`<span style="display:inline-block;margin:3px;padding:5px 8px;background:rgba(255,255,255,0.05);border-radius:5px;font-size:0.75rem;">${m} ${tip}</span>`);
    }
    
    return `
        <div class="info-box gold">
            <p><strong>üìÜ ${year}Year Fortune</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">${yp.s.c}${yp.b.c}ÎÖÑ (${yp.b.m} ${yp.b.a}Ïùò Ìï¥)</p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'‚≠ê'.repeat(rating)}${'‚òÜ'.repeat(5-rating)}</span>
        </div>
        <div class="info-box">
            <p><strong>This Year's God: ${god.k}</strong></p>
            <p style="margin-top:10px;line-height:1.8;">${desc}</p>
        </div>
        <div class="info-box" style="margin-top:12px;">
            <p><strong>üìå Annual Energy: ${state.k}</strong><br>${state.d}</p>
        </div>
        <div class="info-box" style="margin-top:12px;">
            <p><strong>üóìÔ∏è Monthly Highlights</strong></p>
            <div style="margin-top:10px;">${months.join('')}</div>
        </div>`;
}

/* ========================================
   14-4. Detailed Analysis - Career Fortune
   ======================================== */
function genCareerFortune(saju, str, gods) {
    const dm = saju.day.s;
    const ec = countElements(saju);
    const jaeEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5];
    const gwanEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 3) % 5];
    const sikEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5];
    
    let rating = 3, style = '', advice = '';
    
    if (str.type === 'strong' && ec[jaeEl] >= 2) {
        rating = 5; style = 'CEO Type';
        advice = 'Strong chart with many Wealth stars - natural entrepreneur! Excellent money management. Starting your own business leads to great success.';
    } else if (str.type === 'strong' && ec[gwanEl] >= 2) {
        rating = 4; style = 'Executive Type';
        advice = 'Strong chart with many Officer stars - you rise in organizations! Can reach high positions in government, corporations, or politics.';
    } else if (str.type === 'weak') {
        rating = 3; style = 'Specialist Type';
        advice = 'Weak chart suits teamwork over solo. Diving deep into a specialty can make you a recognized expert.';
    } else {
        rating = 4; style = 'Î≠êÎì† ÏûòÌïòÎäî Ïä§ÌÉÄÏùº';
        advice = 'Well balanced! You can adapt and succeed in any field.';
    }
    
    // Check Eating God
    if (ec[sikEl] >= 2) {
        advice += '<br><br>‚ú® <strong>With many Eating Gods, you make money through talent!</strong> You shine in art, technology, and creative fields.';
    }
    
    const careerByElement = {
        wood: 'ÍµêÏú°, Ï∂úÌåê, ÏùòÎ•ò, Í∞ÄÍµ¨, Ï°∞Í≤Ω, ÎÜçÏóÖ, ÌïúÏùòÌïô',
        fire: 'Ïó∞Ïòà, Î∞©ÏÜ°, ÏòàÏà†, IT, Ï†Ñenergy, Ï°∞Î™Ö, ÏùåÏãù',
        earth: 'Î∂ÄÎèôÏÇ∞, Í±¥Ï∂ï, ÎÜçÏóÖ, Ï§ëÍ∞ú, Ïú†ÌÜµ, Ï∞ΩÍ≥†ÏóÖ',
        metal: 'Í∏àÏúµ, Ï†úÏ°∞, ÏûêÎèôÏ∞®, Í∏∞Í≥Ñ, ÏùòÎ£åÍ∏∞energy, Î≤ïÏ°∞',
        water: 'Î¨¥Ïó≠, Ïú†ÌÜµ, Í¥ÄÍ¥ë, Ïñ¥ÏóÖ, ÏùåÎ£å, WaterÎ•ò, Ï≤≠ÏÜå'
    };
    
    return `
        <div class="info-box gold">
            <p><strong>üíº Career Fortune Analysis</strong></p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'‚≠ê'.repeat(rating)}${'‚òÜ'.repeat(5-rating)}</span>
            <p style="margin-top:10px;font-size:1.1rem;color:var(--gold);">${style}</p>
        </div>
        <div class="info-box">
            <p style="line-height:1.8;">${advice}</p>
        </div>
        <div class="info-box good" style="margin-top:12px;">
            <p><strong>üéØ Ïö©Ïã†(${ELEMENT[gods.yong].k}) Í¥ÄÎ†® ÏßÅÏóÖ</strong></p>
            <p style="margin-top:8px;">${careerByElement[gods.yong]}</p>
        </div>`;
}

/* ========================================
   14-5. Detailed Analysis - Love Fortune
   ======================================== */
function genLoveFortune(saju, str, gods) {
    const dm = saju.day.s;
    const dbi = BRANCH.findIndex(br => br.c === saju.day.b.c);
    const ec = countElements(saju);
    
    // Spouse element (M:Wealth, F:Officer)
    const spouseEl = GENDER === 'm' ? 
        EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5] : 
        EL_ORDER[(EL_ORDER.indexOf(dm.e) + 3) % 5];
    const spouseCount = ec[spouseEl];
    
    let rating = 3, desc = '';
    
    // Interpretation by spouse element count
    if (spouseCount === 0) {
        rating = 2;
        desc = 'Weak energy in spouse position. Connection may come late or not last long. Do not be too hasty!';
    } else if (spouseCount === 1) {
        rating = 4;
        desc = 'One true spouse connection! Cherish this person ‚Äî they are your destiny.';
    } else if (spouseCount === 2) {
        rating = 3;
        desc = 'Two spouse connections... Possible remarriage or choosing between two people.';
    } else {
        rating = 2;
        desc = 'Strong spouse connections. Be mindful of temptation! Focus on one person.';
    }
    
    // Spouse image from Day Branch
    const spouseByBranch = {
        0: 'Your spouse is smart and perceptive. Deep thinker who excels academically. May worry a lot though.',
        1: 'Your spouse is steady and diligent. The slow-and-steady type. Very reliable.',
        2: 'Your spouse is active and adventurous. Full of curiosity and energy!',
        3: 'Your spouse is sensitive and delicate. Artistic sense with skilled hands.',
        4: 'Your spouse is embracing and sociable. Has many friends and leadership qualities.',
        5: 'Your spouse is clever and articulate. Quick-witted with people skills.',
        6: 'Your spouse is bright and passionate. May be impatient but full of energy!',
        7: 'Your spouse is gentle and affectionate. Considerate and kind-hearted.',
        8: 'Your spouse is decisive and confident. Strong willpower and independence.',
        9: 'Your spouse is neat and stylish. May have talent in arts or beauty.',
        10: 'Your spouse is stubborn but loyal. Once decided, follows through to the end.',
        11: 'Your spouse is wise and adaptable. Gets along anywhere with flexibility.'
    };
    
    return `
        <div class="info-box gold">
            <p><strong>üíï Love & Marriage Fortune Analysis</strong></p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'‚≠ê'.repeat(rating)}${'‚òÜ'.repeat(5-rating)}</span>
        </div>
        <div class="info-box">
            <p style="line-height:1.8;">${desc}</p>
        </div>
        <div class="info-box" style="margin-top:12px;background:rgba(255,182,193,0.15);">
            <p><strong>üíë Spouse Image from Day Branch</strong></p>
            <p style="margin-top:10px;line-height:1.8;">${spouseByBranch[dbi]}</p>
        </div>`;
}

/* ========================================
   14-6. Detailed Analysis - Wealth Fortune
   ======================================== */
function genWealthFortune(saju, str, gods) {
    const dm = saju.day.s;
    const ec = countElements(saju);
    const jaeEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5];
    const sikEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5];
    const jaeCount = ec[jaeEl];
    const sikCount = ec[sikEl];
    
    let rating = 3, desc = '';
    
    if (str.type === 'strong' && jaeCount >= 2) {
        rating = 5;
        desc = 'Great wealth fortune! Strong chart with many Wealth stars means both ability and luck for money. Big success in business or investments possible!';
    } else if (str.type === 'strong' && jaeCount === 1) {
        rating = 4;
        desc = 'Steady earner type. Better with stable income like salary than big windfalls.';
    } else if (str.type === 'weak' && jaeCount >= 2) {
        rating = 2;
        desc = 'Money comes but goes easily. Weak chart with many Wealth stars is overwhelming. Build saving habits!';
    } else if (jaeCount === 0) {
        rating = 2;
        desc = 'Missing Wealth stars - Less interest in money or difficulty earning. Develop specialized skills!';
    } else {
        rating = 3;
        desc = 'Average wealth fortune. Steady effort can lead to upper-middle class lifestyle.';
    }
    
    // Check Eating God
    if (sikCount >= 2) {
        rating = Math.min(5, rating + 1);
        desc += '<br><br>‚ú® <strong>Eating GodÏù¥ ÎßéÏïÑÏÑú Ïû¨Îä•ÏúºÎ°ú Îèà Î≤ÑÎäî Íµ¨Ï°∞!</strong> Í∏∞Ïà†, ÏòàÏà†, Ï∞ΩÏûëÏúºÎ°ú Î∂ÄÏûê Îê† Ïàò present.';
    }
    
    return `
        <div class="info-box gold">
            <p><strong>üí∞ Wealth Fortune Analysis</strong></p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'‚≠ê'.repeat(rating)}${'‚òÜ'.repeat(5-rating)}</span>
        </div>
        <div class="info-box">
            <p style="line-height:1.8;">${desc}</p>
        </div>
        <div class="info-box good" style="margin-top:12px;">
            <p><strong>üéØ Ïû¨Water Ïö¥ Ïò¨Î¶¨Îäî Î≤ï</strong></p>
            <p style="margin-top:8px;">Your Beneficial Element is <strong>${ELEMENT[gods.yong].k}</strong> energy!<br>Lucky Number: ${ELEMENT[gods.yong].nums.slice(0,5).join(', ')}</p>
        </div>`;
}

/* ========================================
   14-7. Detailed Analysis - Health Fortune
   ======================================== */
function genHealthFortune(saju, str, gods) {
    const dm = saju.day.s;
    const ec = countElements(saju);
    
    const healthData = {
        wood: {o:'Liver, Gallbladder, Eyes', s:'Fatigue, poor vision, muscle cramps, brittle nails', a:'Eat green vegetables, stretch, rest eyes'},
        fire: {o:'Heart, Small Intestine, Tongue', s:'Palpitations, insomnia, tongue inflammation', a:'Regular sleep, meditation, red foods'},
        earth: {o:'Stomach, Spleen, Lips', s:'Indigestion, bloating, cracked lips', a:'Regular meals, yellow foods, walking'},
        metal: {o:'Lungs, Large Intestine, Nose', s:'Respiratory issues, skin problems, constipation', a:'Deep breathing, hiking, white foods, probiotics'},
        water: {o:'Kidneys, Bladder, Ears', s:'Swelling, back pain, reproductive issues, hearing loss', a:'Stay hydrated, black beans, warm baths'}
    };
    
    const sorted = Object.entries(ec).sort((a,b) => a[1] - b[1]);
    const weakest = sorted[0];
    const strongest = Object.entries(ec).sort((a,b) => b[1] - a[1])[0];
    
    let rating = str.type === 'weak' ? 3 : 4;
    
    return `
        <div class="info-box gold">
            <p><strong>üè• Health Fortune Analysis</strong></p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'‚≠ê'.repeat(rating)}${'‚òÜ'.repeat(5-rating)}</span>
        </div>
        <div class="info-box">
            <p><strong>Vulnerable Organs:</strong> ${healthData[dm.e].o}</p>
            <p style="margin-top:10px;"><strong>Watch for symptoms:</strong><br>${healthData[dm.e].s}</p>
            <p style="margin-top:10px;"><strong>Health Tips:</strong><br>${healthData[dm.e].a}</p>
        </div>
        ${weakest[1] === 0 ? `<div class="info-box warn" style="margin-top:12px;"><p><strong>‚ö†Ô∏è ${ELEMENT[weakest[0]].k} energy is missing!</strong><br>${healthData[weakest[0]].o} related health needs attention!<br><br>${healthData[weakest[0]].a}</p></div>` : ''}
        ${strongest[1] >= 4 ? `<div class="info-box" style="margin-top:12px;"><p><strong>üìå ${ELEMENT[strongest[0]].k} energy is excessive</strong><br>${healthData[strongest[0]].o} organs may be strained. Balance is key!</p></div>` : ''}
        <div class="info-box good" style="margin-top:12px;">
            <p><strong>üóìÔ∏è Í≥ÑÏ†àÎ≥Ñ Í±¥Í∞ï Í¥ÄÎ¶¨</strong></p>
            <p style="margin-top:8px;line-height:1.8;">
                ‚Ä¢ Î¥Ñ: Í∞Ñ, Îàà Í¥ÄÎ¶¨ / Ïä§Ìä∏Î†àÏπ≠<br>
                ‚Ä¢ Ïó¨Î¶Ñ: Ïã¨Ïû•, ÌòàÍ¥Ä / Drink plenty of water<br>
                ‚Ä¢ ÌôòÏ†àÍ∏∞: ÏÜåFireÍ∏∞ / Í∑úÏπôÏ†ÅÏù∏ ÏãùÏÇ¨<br>
                ‚Ä¢ Í∞ÄÏùÑ: Ìèê, Ìò∏Ìù°Í∏∞ / Îì±ÏÇ∞, Ïã¨Ìò∏Ìù°<br>
                ‚Ä¢ Í≤®Ïö∏: Ïã†Ïû•, Îºà / Î≥¥Ïò®, Î∞òÏã†Ïöï
            </p>
        </div>`;
}

/* ========================================
   14-8. Compatibility Analysis
   ======================================== */
function runMatch() {
    if (!SAJU) { toast('Please analyze your chart first!'); return; }
    
    const py = +document.getElementById('partner-year').value;
    const pm = +document.getElementById('partner-month').value;
    const pd = +document.getElementById('partner-day').value;
    
    if (!py || !pm || !pd) { toast('ÏÉÅÎåÄÎ∞© Please enter your birth date'); return; }
    
    const pSaju = {
        year: calcYearPillar(py, pm, pd),
        month: calcMonthPillar(py, pm, pd),
        day: calcDayPillar(py, pm, pd)
    };
    
    let score = 50, details = [];
    
    // 1. Day Master compatibility (Stem harmony)
    const myDm = STEM.indexOf(SAJU.day.s), pDm = STEM.indexOf(pSaju.day.s);
    const ganHap = [[0,5],[1,6],[2,7],[3,8],[4,9]];
    let ganMatch = false;
    for (let [a,b] of ganHap) if ((myDm===a && pDm===b) || (myDm===b && pDm===a)) { ganMatch = true; break; }
    if (ganMatch) { score += 20; details.push({t:'good', txt:'üíï Stem Harmony! Your Day Masters are soulmates!'}); }
    
    // 2. Day Branch compatibility (Branch harmony/clash)
    const myDb = BRANCH.findIndex(br => br.c === SAJU.day.b.c), pDb = BRANCH.findIndex(br => br.c === pSaju.day.b.c);
    const jiHap = [[0,1],[2,11],[3,10],[4,9],[5,8],[6,7]];
    const jiChung = [[0,6],[1,7],[2,8],[3,9],[4,10],[5,11]];
    for (let [a,b] of jiHap) if ((myDb===a && pDb===b) || (myDb===b && pDb===a)) { score += 15; details.push({t:'good', txt:'ü§ù Day Branch Six Harmony! Ìï®Íªò ÏûàÏúºÎ©¥ Ìé∏ÏïàÌïòÍ≥† ÏïàÏ†ïÍ∞êÏùÑ ÎäêÍª¥Ïöî.'}); break; }
    for (let [a,b] of jiChung) if ((myDb===a && pDb===b) || (myDb===b && pDb===a)) { score -= 15; details.push({t:'bad', txt:'üí• Day Branch clash! Friction is likely. Compromise is essential.'}); break; }
    
    // 3. Element generation/destruction
    const myEl = EL_ORDER.indexOf(SAJU.day.s.e), pEl = EL_ORDER.indexOf(pSaju.day.s.e);
    const saeng = [[0,2],[2,1],[1,3],[3,4],[4,0]];
    const keuk = [[0,3],[3,1],[1,4],[4,2],[2,0]];
    for (let [a,b] of saeng) if ((myEl===a && pEl===b) || (myEl===b && pEl===a)) { score += 10; details.push({t:'good', txt:`üå± Five Elements harmony! ${ELEMENT[SAJU.day.s.e].k}Í≥º ${ELEMENT[pSaju.day.s.e].k} support each other.`}); break; }
    for (let [a,b] of keuk) if ((myEl===a && pEl===b) || (myEl===b && pEl===a)) { score -= 10; details.push({t:'bad', txt:`‚öîÔ∏è Element Clash! Effort to harmonize is essential.`}); break; }
    if (SAJU.day.s.e === pSaju.day.s.e) { score += 5; details.push({t:'neutral', txt:`üîÑ Í∞ôÏùÄ ${ELEMENT[SAJU.day.s.e].k} element! Similar tendencies connect you.`}); }
    
    // 4. Zodiac Harmony
    const myTti = BRANCH.findIndex(br => br.c === SAJU.year.b.c), pTti = BRANCH.findIndex(br => br.c === pSaju.year.b.c);
    for (let [a,b] of jiHap) if ((myTti===a && pTti===b) || (myTti===b && pTti===a)) { score += 5; details.push({t:'good', txt:`üêæ Zodiac Six Harmony! ${BRANCH[myTti].a}and ${BRANCH[pTti].a}are a great match.`}); break; }
    for (let [a,b] of jiChung) if ((myTti===a && pTti===b) || (myTti===b && pTti===a)) { score -= 5; details.push({t:'bad', txt:`üêæ Zodiac Clash! ${BRANCH[myTti].a}and ${BRANCH[pTti].a}may have conflicts.`}); break; }
    
    score = Math.max(0, Math.min(100, score));
    
    let grade, color, summary;
    if (score >= 80) { grade = 'üíñ Soulmates'; color = '#e91e63'; summary = 'You two are a perfect match! Best compatibility.'; }
    else if (score >= 65) { grade = 'üíï Good Match'; color = '#9c27b0'; summary = 'You match well! A little effort brings happiness.'; }
    else if (score >= 50) { grade = 'üíõ Average Match'; color = '#ff9800'; summary = 'Average compatibility. Acknowledging differences improves it.'; }
    else if (score >= 35) { grade = 'üíî Effort Needed'; color = '#ff5722'; summary = 'Some friction exists. Compromise and understanding needed.'; }
    else { grade = 'üò¢ Challenging Match'; color = '#f44336'; summary = 'Challenging compatibility. But love can overcome it!'; }
    
    document.getElementById('match-result').innerHTML = `
        <div class="info-box" style="text-align:center;">
            <p style="font-size:2rem;color:${color}">${grade}</p>
            <p style="font-size:1.5rem;font-weight:bold;margin-top:10px;">${score}Ï†ê</p>
            <div style="background:#333;border-radius:10px;height:20px;margin:15px 0;">
                <div style="background:linear-gradient(90deg,#ff6b6b,#ee5a24);height:100%;border-radius:10px;width:${score}%"></div>
            </div>
            <p>${summary}</p>
        </div>
        <div class="info-box" style="margin-top:15px;">
            <p><strong>üìä Detailed Analysis</strong></p>
            <p style="margin-top:8px;"><strong>ÎÇò:</strong> ${SAJU.day.s.c}${SAJU.day.b.c}Day (${ELEMENT[SAJU.day.s.e].k})</p>
            <p><strong>ÏÉÅÎåÄ:</strong> ${pSaju.day.s.c}${pSaju.day.b.c}Day (${ELEMENT[pSaju.day.s.e].k})</p>
        </div>
        ${details.map(d => `<div class="info-box ${d.t === 'good' ? 'good' : d.t === 'bad' ? 'warn' : ''}" style="margin-top:10px;"><p>${d.txt}</p></div>`).join('')}
        <div class="info-box" style="margin-top:15px;">
            <p><strong>üí° Compatibility Tips</strong></p>
            <p style="margin-top:8px;">${score >= 65 ? 'Praise each others strengths!' : score >= 50 ? 'Acknowledge and respect your differences.' : 'Communicate more. Respect each others space.'}</p>
        </div>`;
}

/* ========================================
   15. ÏÇ¨Ï£º Î∂ÑÏÑù Ïã§Ìñâ
   ======================================== */
function analyzeSaju() {
    try {
        const y = +document.getElementById('saju-year').value;
        const m = +document.getElementById('saju-month').value;
        const d = +document.getElementById('saju-day').value;
        const h = document.getElementById('saju-hour').value;
        const hourVal = h === '' ? -1 : +h;
        
        // Validate input
        if (!y || !m || !d) { toast('Please enter your birth date'); return; }
        if (y < 1900 || y > 2100) { toast('Year must be between 1900-2100'); return; }
        if (m < 1 || m > 12) { toast('Month must be between 1-12'); return; }
        if (d < 1 || d > 31) { toast('Day must be between 1-31'); return; }
        
        let sy = y, sm = m, sd = d;
        if (CALENDAR === 'lunar') {
            const conv = lunarToSolar(y, m, d);
            if (!conv || !conv.year) { toast('Lunar conversion error. Try solar calendar'); return; }
            sy = conv.year; sm = conv.month; sd = conv.day;
        }
        
        const adj = adjustTime(sy, sm, sd, hourVal);
        if (!adj || !adj.y) { toast('Time adjustment error'); return; }
        
        SAJU = {
            year: calcYearPillar(adj.y, adj.m, adj.d),
            month: calcMonthPillar(adj.y, adj.m, adj.d),
            day: calcDayPillar(adj.y, adj.m, adj.d),
            hour: hourVal >= 0 ? calcHourPillar(calcDayPillar(adj.y, adj.m, adj.d).s, adj.h) : null
        };
        
        // Validate Saju calculation
        if (!SAJU.year || !SAJU.month || !SAJU.day) { 
            toast('Four Pillars calculation error. Please try again'); 
            return; 
        }
        
        BIRTH_YEAR = y;
        const str = calcStrength(SAJU);
        if (!str) { toast('Strength calculation error'); return; }
        
        GODS = calcGods(SAJU, str);
        if (!GODS) { toast('Beneficial element calculation error'); return; }
        
        renderSaju(str);
        document.getElementById('saju-result').style.display = 'block';
        
        // Update my-info-display if exists
        const infoDisplay = document.getElementById('my-info-display');
        if (infoDisplay) {
            infoDisplay.innerHTML = `<p style="color:var(--gold);">${SAJU.day.s.c}${SAJU.day.b.c}Day (${ELEMENT[SAJU.day.s.e].k})</p>`;
        }
        
        toast('üîÆ Fortune analysis complete!');
    } catch (error) {
        console.error('Four Pillars analysis error:', error);
        toast('Analysis error. Please check your input.');
    }
}

/* ========================================
   16. Î†åÎçîÎßÅ Ìï®ÏàòÎì§
   ======================================== */
function renderSaju(str) {
    try {
    // Saju pillars
    const pillars = ['hour','day','month','year'];
    const labels = ['Hour','Day','Month','Year'];
    document.getElementById('pillars').innerHTML = pillars.map((p, i) => {
        const pillar = SAJU[p];
        if (!pillar) return `<div class="pillar"><div class="pillar-label">${labels[i]}</div><div class="pillar-stem">-</div><div class="pillar-branch">-</div></div>`;
        const god = p !== 'day' ? getTenGod(pillar.s, SAJU.day.s) : null;
        return `<div class="pillar ${p === 'day' ? 'dm' : ''}">
            <div class="pillar-label">${labels[i]}</div>
            <div class="pillar-stem el-${pillar.s.e}">${pillar.s.c}</div>
            <div class="pillar-branch el-${pillar.b.e}">${pillar.b.c}</div>
            <div class="pillar-sub">${pillar.s.k}${pillar.b.k}</div>
            ${god ? `<div class="pillar-god">${god.k}</div>` : '<div class="pillar-god">Day Master</div>'}
        </div>`;
    }).join('');
    
    // Twelve States
    const un12 = getTwelveState(SAJU.day.s, SAJU.day.b);
    document.getElementById('twelve-states').innerHTML = `<div class="info-box"><p><strong>Day Branch Twelve State:</strong> ${un12.k} (Energy ${un12.l}/12)</p></div>`;
    
    // Strong/Weak
    const typeLabel = {strong:'Strong',weak:'Weak',balanced:'Balanced'};
    document.getElementById('strength-box').innerHTML = `
        <div class="strength-header">
            <span class="strength-title">Day Master Strength</span>
            <span class="strength-badge ${str.type}">${typeLabel[str.type]}${str.extreme ? ` (${str.extreme})` : ''}</span>
        </div>
        <div class="strength-bar"><div class="strength-fill ${str.type}" style="width:${str.pct}%"></div></div>
        <div class="factors">${str.factors.map(f => `<div class="factor"><span class="factor-label">${f.l}</span><span class="factor-value ${f.p ? 'pos' : 'neg'}">${f.v}</span></div>`).join('')}</div>
    `;
    
    // ========== Á¥çÈü≥(Sound Element)/ÂëΩÂÆÆ(Life Palace)/Conception (NEW) ==========
    const dayNapeum = calcNapeum(SAJU.day.s, SAJU.day.b);
    const yearNapeum = calcNapeum(SAJU.year.s, SAJU.year.b);
    const myunggung = SAJU.hour ? calcMyunggung(SAJU.month.b, SAJU.hour.b) : null;
    const taewon = calcTaewon(SAJU.year.s, SAJU.month.s, SAJU.month.b);
    
    document.getElementById('napeum-myunggung').innerHTML = `
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>üéµ Sound-Element (Sound Element)</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">Sound elements based on the 60 Sexagenary cycle</p>
            <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
                    <p style="font-size:0.8rem;color:var(--gray);">Day Sound Element</p>
                    <p style="font-weight:bold;margin-top:5px;color:var(--gold);">${SAJU.day.s.c}${SAJU.day.b.c} ‚Üí ${dayNapeum.name}</p>
                    <p style="font-size:0.85rem;margin-top:5px;">${dayNapeum.desc}</p>
                </div>
                <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
                    <p style="font-size:0.8rem;color:var(--gray);">Year Sound Element</p>
                    <p style="font-weight:bold;margin-top:5px;">${SAJU.year.s.c}${SAJU.year.b.c} ‚Üí ${yearNapeum.name}</p>
                    <p style="font-size:0.85rem;margin-top:5px;">${yearNapeum.desc}</p>
                </div>
            </div>
        </div>
        
        ${myunggung ? `
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>üè† Life Palace (ÂëΩÂÆÆ)</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">Life direction calculated from Month+Hour Branch</p>
            <div style="margin-top:12px;padding:15px;background:rgba(253,216,53,0.1);border-radius:8px;border-left:3px solid var(--gold);">
                <p style="font-weight:bold;font-size:1.1rem;color:var(--gold);">${myunggung.name}</p>
                <p style="margin-top:8px;"><strong>Tendency:</strong> ${myunggung.trait}</p>
                <p style="margin-top:5px;"><strong>Suitable fields:</strong> ${myunggung.career}</p>
            </div>
        </div>
        ` : '<div class="info-box" style="margin-bottom:10px;"><p><strong>üè† Life Palace (ÂëΩÂÆÆ)</strong></p><p style="color:var(--gray);margin-top:5px;">Birth hour required to calculate Life Palace.</p></div>'}
        
        <div class="info-box">
            <p><strong>üå± Conception Origin (ËÉéÂÖÉ)</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">Conception point: Month Stem+1, Month Branch+3</p>
            <div style="margin-top:12px;padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;">
                <p style="font-weight:bold;font-size:1.1rem;">${taewon.pillar}</p>
                <p style="margin-top:8px;">Sound Element: ${taewon.napeum.name} (${ELEMENT[taewon.napeum.element].k})</p>
                <p style="margin-top:5px;font-size:0.9rem;color:var(--gray);">${taewon.desc}</p>
            </div>
        </div>
    `;
    
    // ========== Hidden Stems Analysis (NEW) ==========
    const jjAnalysis = analyzeJijanggan(SAJU);
    document.getElementById('jijanggan-analysis').innerHTML = `
        <div class="info-box">
            <p style="margin-bottom:10px;font-size:0.85rem;color:var(--gray);">Hidden Heavenly Stems within Earthly Branches</p>
            ${jjAnalysis.pillars.map(p => `
                <div style="margin-bottom:15px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;">
                    <p style="font-weight:bold;color:var(--gold);">${p.name}: ${p.branch.c} ${p.branch.k}</p>
                    <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;">
                        ${p.hidden.map(h => `
                            <span style="padding:4px 10px;border-radius:15px;font-size:0.8rem;
                                background:${h.type === 'Main' ? 'rgba(76,175,80,0.3)' : h.type === 'Middle' ? 'rgba(255,152,0,0.3)' : 'rgba(158,158,158,0.3)'};
                                border:1px solid ${h.type === 'Main' ? 'var(--wood)' : h.type === 'Middle' ? 'var(--earth)' : 'var(--metal)'};">
                                ${h.stem.c} ${h.stem.k} ¬∑ ${h.type} ¬∑ ${h.days}d ¬∑ ${h.god.e || h.god.k}
                                ${h.tougan ? '<span style="color:var(--gold);">‚òÖ</span>' : ''}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `).join('')}
        </div>
        <div class="info-box" style="margin-top:10px;">
            <p><strong>üìä Hidden Stems Element Distribution</strong></p>
            <div style="margin-top:10px;display:flex;justify-content:space-around;">
                ${EL_ORDER.map(e => `
                    <div style="text-align:center;">
                        <div class="el-${e}" style="font-size:1.3rem;">${ELEMENT[e].icon}</div>
                        <div style="font-size:0.9rem;font-weight:bold;margin-top:2px;">${ELEMENT[e].c}</div>
                        <div style="font-size:0.65rem;color:var(--gray);">${ELEMENT[e].k}</div>
                        <div style="font-size:1rem;margin-top:5px;font-weight:bold;color:${ELEMENT[e].color};">${jjAnalysis.summary.elements[e].toFixed(1)}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // ========== Root & Stem Analysis (NEW) ==========
    const ttAnalysis = analyzeTonggeunTougan(SAJU);
    document.getElementById('tonggeun-analysis').innerHTML = `
        <div class="info-box">
            <p><strong>üå≥ Root Connection</strong> - Heavenly Stems rooted in Earthly Branches</p>
            <div style="margin-top:10px;">
                ${ttAnalysis.tonggeun.length ? ttAnalysis.tonggeun.map(t => `
                    <div style="padding:8px;margin:5px 0;background:rgba(76,175,80,0.1);border-radius:6px;border-left:3px solid var(--wood);">
                        <span style="font-weight:bold;">${t.pillar} ${t.stem}</span> (${t.god}) ‚Üí
                        ${t.roots.map(r => `<span style="margin-left:5px;padding:2px 6px;background:rgba(255,255,255,0.1);border-radius:4px;font-size:0.8rem;">${r.pillar}${r.branch} ${r.type}(${r.strength})</span>`).join('')}
                    </div>
                `).join('') : '<p style="color:var(--gray);font-size:0.9rem;">No rooted stems. Weak foundation.</p>'}
            </div>
        </div>
        <div class="info-box" style="margin-top:10px;">
            <p><strong>‚òÄÔ∏è Stem Emergence</strong> - Hidden Stems revealed in Heavenly Stems</p>
            <div style="margin-top:10px;">
                ${ttAnalysis.tougan.length ? ttAnalysis.tougan.map(t => `
                    <div style="padding:8px;margin:5px 0;background:rgba(253,216,53,0.1);border-radius:6px;border-left:3px solid var(--gold);">
                        <span style="font-weight:bold;">${t.stem}</span> (${t.god}) - from ${t.pillar} ‚Üí ${t.from} revealed
                    </div>
                `).join('') : '<p style="color:var(--gray);font-size:0.9rem;">No revealed hidden stems.</p>'}
            </div>
        </div>
    `;
    
    // Yongsin
    document.getElementById('gods').innerHTML = `
        <div class="god yong"><div class="god-title">Beneficial Element</div><div class="god-element el-${GODS.yong}">${ELEMENT[GODS.yong].c}</div><div class="god-name">${ELEMENT[GODS.yong].n}</div></div>
        <div class="god hee"><div class="god-title">Favorable Element</div><div class="god-element el-${GODS.hee}">${ELEMENT[GODS.hee].c}</div><div class="god-name">${ELEMENT[GODS.hee].n}</div></div>
        <div class="god gi"><div class="god-title">Unfavorable Element</div><div class="god-element el-${GODS.gi}">${ELEMENT[GODS.gi].c}</div><div class="god-name">${ELEMENT[GODS.gi].n}</div></div>
    `;
    
    // Yongsin ÏÉÅÏÑ∏ + Ï°∞ÌõÑ Í≥†Í∏â
    let godsDetailHtml = `<div class="info-box gold"><p>${ELEMENT[GODS.yong].n} energy brings you good fortune.</p></div>`;
    
    // Climate balance details
    if (GODS.johu) {
        godsDetailHtml += `
            <div class="info-box" style="margin-top:10px;">
                <p><strong>üå°Ô∏è Climate Adjustment Analysis</strong></p>
                <p style="margin-top:8px;font-size:0.9rem;">${GODS.johuDesc || 'Seasonal adjustment applied.'}</p>
                ${GODS.sub ? `<p style="margin-top:5px;font-size:0.85rem;color:var(--gray);">Secondary beneficial: ${ELEMENT[GODS.sub].k}(${ELEMENT[GODS.sub].c})</p>` : ''}
            </div>
        `;
    }
    
    // Cold-Warm-Damp balance
    if (GODS.climate) {
        godsDetailHtml += `
            <div class="info-box ${GODS.climate.needs.length ? 'warn' : ''}" style="margin-top:10px;">
                <p><strong>üå°Ô∏è Temperature-Humidity Balance: ${GODS.climate.type}</strong></p>
                <p style="margin-top:8px;font-size:0.9rem;">${GODS.climate.desc}</p>
                ${GODS.climate.needs.length ? `<p style="margin-top:5px;font-size:0.85rem;">Needed energy: ${GODS.climate.needs.map(e => ELEMENT[e].k).join(', ')}</p>` : ''}
            </div>
        `;
    }
    
    // Disease-Medicine
    if (GODS.byungYak && GODS.byungYak.byung) {
        godsDetailHtml += `
            <div class="info-box" style="margin-top:10px;">
                <p><strong>üíä Disease-Medicine Analysis</strong></p>
                <p style="margin-top:8px;font-size:0.9rem;">
                    Î≥ë(ÁóÖ): ${ELEMENT[GODS.byungYak.byung].k}(${ELEMENT[GODS.byungYak.byung].c}) excess<br>
                    ÏïΩ(Ëó•): ${ELEMENT[GODS.byungYak.yak].k}(${ELEMENT[GODS.byungYak.yak].c}) controls it
                </p>
            </div>
        `;
    }
    
    document.getElementById('gods-detail').innerHTML = godsDetailHtml;
    
    // ========== Six Relations (ÂÖ≠Ë¶™) Analysis (NEW) ==========
    const yukcheon = analyzeYukcheon(SAJU, GENDER);
    document.getElementById('yukcheon-analysis').innerHTML = `
        <div class="info-box" style="margin-bottom:10px;">
            <p style="font-size:0.85rem;color:var(--gray);">Analyzing family and relationships through the Ten Gods</p>
        </div>
        
        <!-- ÏúÑÏπòÎ≥Ñ Ïú°Ïπú -->
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px;">
            ${yukcheon.positions.map(p => `
                <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
                    <p style="font-size:0.8rem;color:var(--gray);">${p.posName}</p>
                    <p style="font-weight:bold;margin:5px 0;">${p.stem.c}${p.branch.c}</p>
                    <p style="font-size:0.9rem;">Stem: <span style="color:var(--gold);">${p.stemGod}</span></p>
                    ${p.branchGod ? `<p style="font-size:0.85rem;color:var(--gray);">Branch: ${p.branchGod}</p>` : ''}
                    <p style="font-size:0.8rem;margin-top:5px;">${p.relation}</p>
                </div>
            `).join('')}
        </div>
        
        <!-- Spouse Analysis -->
        <div class="info-box ${yukcheon.spouse.count > 0 ? 'good' : 'warn'}" style="margin-bottom:10px;">
            <p><strong>üíï Spouse Analysis</strong></p>
            <p style="margin-top:8px;font-size:0.9rem;">
                Spouse star (${yukcheon.spouse.god}): ${yukcheon.spouse.count > 0 ? yukcheon.spouse.count + '' : 'hidden'}<br>
                Day Branch Twelve State: ${yukcheon.spouse.dayBranch.k}
            </p>
            <p style="margin-top:5px;font-size:0.85rem;">${yukcheon.spouse.analysis}</p>
        </div>
        
        <!-- Children Analysis -->
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>üë∂ Children Analysis</strong></p>
            <p style="margin-top:8px;font-size:0.9rem;">
                Children star (${yukcheon.children.gods.join('/')}): ${yukcheon.children.count > 0 ? yukcheon.children.count.toFixed(1) + '' : 'hidden'}
            </p>
            <p style="margin-top:5px;font-size:0.85rem;">${yukcheon.children.analysis}</p>
        </div>
        
        <!-- Parents Analysis -->
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>üë®‚Äçüë©‚Äçüëß Parents Analysis</strong></p>
            <p style="margin-top:8px;font-size:0.9rem;">
                Father (ÂÅèË≤°/Indirect Wealth): ${yukcheon.parents.father.count > 0 ? 'present' : 'none'} - ${yukcheon.parents.father.analysis}<br>
                Mother (Ê≠£Âç∞/Direct Seal): ${yukcheon.parents.mother.count > 0 ? 'present' : 'none'} - ${yukcheon.parents.mother.analysis}
            </p>
        </div>
        
        <!-- Six Relations (ÂÖ≠Ë¶™) Special Notes -->
        ${yukcheon.analysis.length ? `
            <div class="info-box warn">
                <p><strong>üìå Six Relations (ÂÖ≠Ë¶™) Special Notes</strong></p>
                ${yukcheon.analysis.slice(0, 5).map(a => `
                    <p style="margin-top:8px;font-size:0.85rem;">
                        ${a.type === 'many' ? '‚ö°' : '‚≠ï'} ${a.meaning}
                    </p>
                `).join('')}
            </div>
        ` : ''}
    `;
    
    // Structure
    const fmt = calcFormat(SAJU);
    document.getElementById('format').innerHTML = `
        <div class="info-box gold">
            <p><strong>${fmt.n}</strong></p>
            <p style="margin-top:10px;line-height:1.8;">${fmt.d}</p>
            <p style="margin-top:10px;color:var(--gold);">üíº <strong>Suitable fields:</strong> ${fmt.b}</p>
        </div>`;
    
    // Day analysis
    const ilju = getIljuDesc(SAJU.day.s, SAJU.day.b);
    document.getElementById('ilju').innerHTML = `
        <div class="info-box">
            <p><strong style="font-size:16px;">${ilju.title}</strong></p>
            <p style="margin-top:12px;line-height:1.8;">${ilju.desc}</p>
            <div style="margin-top:15px;padding:12px;background:rgba(255,182,193,0.15);border-radius:8px;">
                <p>üíï <strong>Spouse Fortune</strong></p>
                <p style="margin-top:8px;line-height:1.6;">${ilju.spouse}</p>
            </div>
        </div>`;
    
    // ========== Í∂ÅÏúÑ(ÂÆÆ‰Ωç) Î∂ÑÏÑù (NEW) ==========
    const gungwi = analyzeGungwi(SAJU, BIRTH_YEAR);
    document.getElementById('gungwi-analysis').innerHTML = `
        <div class="info-box" style="margin-bottom:10px;">
            <p style="font-size:0.85rem;color:var(--gray);">The Four Pillars represent different life periods and relationships</p>
        </div>
        ${gungwi.map(g => `
            <div class="info-box ${g.rating === 'good' ? 'good' : g.rating === 'bad' ? 'warn' : ''}" style="margin-bottom:10px;${g.isCurrent ? 'border:2px solid var(--gold);' : ''}">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <p><strong>${g.name}</strong> <span style="color:var(--gray);font-size:0.85rem;">${g.alias}</span></p>
                    ${g.isCurrent ? '<span style="background:var(--gold);color:#000;padding:2px 8px;border-radius:10px;font-size:0.7rem;">Current</span>' : ''}
                </div>
                <p style="margin-top:8px;font-size:0.85rem;">
                    üìÖ <strong>${g.ageRange}</strong> ¬∑ 
                    ${g.pillar ? `${g.pillar.s.c}${g.pillar.b.c}` : '-'} ¬∑ 
                    ${g.god ? g.god.k : 'Day Master'} ¬∑ 
                    ${g.state ? g.state.k : '-'}
                </p>
                <p style="margin-top:5px;font-size:0.85rem;color:var(--gray);">
                    üë§ ${GENDER === 'm' ? g.relationM : g.relationF} ¬∑ ü¶¥ ${g.bodyPart}
                </p>
                <p style="margin-top:8px;line-height:1.6;">${g.analysis}</p>
            </div>
        `).join('')}
    `;
    
    // ========== 12Ïö¥ÏÑ± ÏôÑÏ†Ñ Î∂ÑÏÑù (NEW) ==========
    const ts = analyzeTwelveStates(SAJU);
    document.getElementById('twelve-states-full').innerHTML = `
        <div class="info-box ${ts.dominant === 'strong' ? 'good' : ts.dominant === 'weak' ? 'warn' : ''}">
            <p><strong>üìä Base Energy Status</strong></p>
            <p style="margin-top:8px;">${ts.summary}</p>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:15px 0;">
            ${ts.pillars.map(p => `
                <div style="text-align:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;
                    border-bottom:3px solid ${p.energy >= 9 ? 'var(--wood)' : p.energy >= 6 ? 'var(--gold)' : p.energy >= 3 ? 'var(--earth)' : 'var(--fire)'};">
                    <div style="font-size:0.8rem;color:var(--gray);">${p.name}</div>
                    <div style="font-size:1.3rem;margin:8px 0;">${p.state.k}</div>
                    <div style="font-size:0.9rem;">‚ö° ${p.energy}/12</div>
                </div>
            `).join('')}
        </div>
        <div class="info-box">
            <p><strong>üîÑ Life Energy Flow</strong></p>
            <div style="margin-top:10px;">
                ${ts.lifeFlow.map(lf => `
                    <div style="display:flex;align-items:center;padding:8px;margin:5px 0;background:rgba(255,255,255,0.03);border-radius:6px;">
                        <div style="width:80px;font-size:0.8rem;color:var(--gray);">${lf.period}</div>
                        <div style="width:60px;font-weight:bold;">${lf.state}</div>
                        <div style="flex:1;font-size:0.85rem;">${lf.advice}</div>
                        <div>${'‚≠ê'.repeat(Math.ceil(lf.energy/3))}${'‚òÜ'.repeat(4-Math.ceil(lf.energy/3))}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // Life Cycles(Life Cycle)
    const luck = calcLuck(SAJU, BIRTH_YEAR, GENDER, GODS);
    document.getElementById('luck-timeline').innerHTML = luck.map(l => `
        <div class="luck-item ${l.isCur ? 'current' : ''} ${l.rating}">
            <div class="luck-age">Ages ${l.startAge}-${l.endAge}</div>
            <div class="luck-pillar el-${l.s.e}">${l.s.c}${l.b.c}</div>
            <div class="luck-rating">${l.rating === 'good' ? 'üòä' : l.rating === 'bad' ? 'üò∞' : 'üòê'}</div>
        </div>
    `).join('');
    
    const curLuck = luck.find(l => l.isCur);
    if (curLuck) {
        document.getElementById('luck-detail').innerHTML = `<div class="info-box ${curLuck.rating === 'good' ? 'good' : curLuck.rating === 'bad' ? 'warn' : ''}"><p><strong>Current Life Cycle (Ages ${curLuck.startAge}-${curLuck.endAge}): ${curLuck.s.c}${curLuck.b.c}</strong><br>${curLuck.rating === 'good' ? 'Great fortune period! Take bold action.' : curLuck.rating === 'bad' ? 'Caution period. Avoid overexertion.' : 'Stable period. Stay consistent.'}</p></div>`;
    }
    
    // ========== Life Cycle Transition Analysis (NEW) ==========
    const gyoungi = analyzeGyoungi(luck, BIRTH_YEAR, new Date().getFullYear());
    document.getElementById('gyoungi-analysis').innerHTML = gyoungi.length ? `
        <div class="info-box" style="margin-bottom:10px;">
            <p style="font-size:0.85rem;color:var(--gray);">Knowing when your Life Cycle changes helps you prepare for life transitions.</p>
        </div>
        ${gyoungi.map(g => `
            <div class="info-box ${g.intensity === 'strong' ? 'warn' : ''} ${g.isCurrent ? 'gold' : ''}" style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <p><strong>üîÑ Age ${g.transitionAge} Transition</strong> (${g.transitionYear})</p>
                    ${g.isCurrent ? '<span style="background:var(--gold);color:#000;padding:2px 8px;border-radius:10px;font-size:0.7rem;">Current Transition!</span>' : ''}
                </div>
                <p style="margin-top:10px;font-size:1.1rem;text-align:center;">
                    <span style="color:var(--gray);">${g.from}</span>
                    <span style="margin:0 10px;">‚Üí</span>
                    <span style="color:var(--gold);">${g.to}</span>
                </p>
                <p style="margin-top:10px;line-height:1.6;">${g.warning}</p>
                <p style="margin-top:8px;font-size:0.9rem;color:var(--gray);">üí° ${g.advice}</p>
            </div>
        `).join('')}
    ` : `<div class="info-box"><p style="color:var(--gray);">No major transition period near current age.</p></div>`;
    
    // ========== 10Year Fortune ÎØ∏Î¶¨Î≥¥Í∏∞ (NEW) ==========
    const next10 = getNext10Years(SAJU, BIRTH_YEAR, GENDER, GODS);
    const ratingEmoji = {excellent:'üåü',good:'üòä',neutral:'üòê',caution:'‚ö†Ô∏è',difficult:'üò∞'};
    const ratingClass = {excellent:'good',good:'good',neutral:'',caution:'warn',difficult:'warn'};
    document.getElementById('ten-years-luck').innerHTML = `
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px;">
            ${next10.years.map(y => `
                <div style="flex:1;min-width:60px;padding:8px;text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;
                    border:1px solid ${y.rating === 'excellent' || y.rating === 'good' ? 'var(--wood)' : y.rating === 'difficult' || y.rating === 'caution' ? 'var(--fire)' : 'transparent'};">
                    <div style="font-size:0.75rem;color:var(--gray);">${y.year}</div>
                    <div style="font-size:1.1rem;">${ratingEmoji[y.rating]}</div>
                    <div style="font-size:0.7rem;color:var(--gray);">Age ${y.age}</div>
                </div>
            `).join('')}
        </div>
        <div class="info-box good">
            <p>üåü <strong>Best year: ${next10.bestYear.year}</strong> (Age ${next10.bestYear.age})<br>
            ${next10.bestYear.saeun.pillar.s.c}${next10.bestYear.saeun.pillar.b.c}, ${next10.bestYear.saeun.god.k} energy</p>
        </div>
        <div class="info-box warn" style="margin-top:10px;">
            <p>‚ö†Ô∏è <strong>Caution year: ${next10.worstYear.year}</strong> (Age ${next10.worstYear.age})<br>
            ${next10.worstYear.saeun.pillar.s.c}${next10.worstYear.saeun.pillar.b.c} - Take care of health!</p>
        </div>
    `;
    
    // ========== This Year Monthly Fortune (NEW) ==========
    const curYear = new Date().getFullYear();
    const monthlyLuck = getYearlyMonthLuck(curYear, SAJU, GODS);
    document.getElementById('monthly-luck').innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:15px;">
            ${monthlyLuck.months.map(m => `
                <div style="padding:10px;text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;
                    border:1px solid ${m.rating === 'good' ? 'var(--wood)' : m.rating === 'bad' ? 'var(--fire)' : 'transparent'};">
                    <div style="font-weight:bold;">${MONTH_ABBR[m.month - 1]}</div>
                    <div style="font-size:1.2rem;margin:5px 0;">${m.rating === 'good' ? 'üòä' : m.rating === 'bad' ? 'üò∞' : 'üòê'}</div>
                    <div style="font-size:0.7rem;color:var(--gray);">${m.pillar.s.c}${m.pillar.b.c}</div>
                    <div style="font-size:0.7rem;color:var(--gray);">${m.god.e || m.god.k}</div>
                </div>
            `).join('')}
        </div>
        <div class="info-box good">
            <p>üåü <strong>Best: ${MONTH_ABBR[monthlyLuck.best.month - 1]}</strong><br>${monthlyLuck.best.god.e || monthlyLuck.best.god.k} energy brings good fortune!</p>
        </div>
        <div class="info-box warn" style="margin-top:10px;">
            <p>‚ö†Ô∏è <strong>Caution: ${MONTH_ABBR[monthlyLuck.worst.month - 1]}</strong><br>${monthlyLuck.worst.god.e || monthlyLuck.worst.god.k} energy - take it easy.</p>
        </div>
    `;
    
    // Interactions
    const ints = calcInteractions(SAJU);
    document.getElementById('interactions').innerHTML = ints.length ? ints.map(i => `<div class="int-item"><div class="int-type">${i.t}</div><div><div class="int-chars">${i.c}</div><div class="int-meaning">${i.m} - ${i.d}</div></div></div>`).join('') : '<p style="color:var(--gray);">No special harmony or clash in chart.</p>';
    
    // ========== ÊñπÂêà(Directional Harmony)/ÊöóÂêà(Hidden Harmony) Î∂ÑÏÑù (NEW) ==========
    const banghap = analyzeBanghap(SAJU);
    const amhap = analyzeAmhap(SAJU);
    document.getElementById('banghap-amhap').innerHTML = `
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>üåÄ Directional Harmony (ÊñπÂêà)</strong> - Same direction branches form powerful element</p>
            ${banghap.length ? banghap.map(b => `
                <div style="margin-top:10px;padding:12px;background:rgba(${b.type === 'complete' ? '76,175,80' : '255,152,0'},0.1);border-radius:8px;border-left:3px solid ${b.type === 'complete' ? 'var(--wood)' : 'var(--earth)'};">
                    <p style="font-weight:bold;color:${b.type === 'complete' ? 'var(--wood)' : 'var(--earth)'};">${b.name} (${b.branches})</p>
                    <p style="margin-top:5px;font-size:0.9rem;">${b.dir}</p>
                    <p style="margin-top:5px;font-size:0.85rem;">${b.desc}</p>
                    ${b.type === 'partial' ? `<p style="margin-top:5px;font-size:0.8rem;color:var(--gray);">üí° When ${b.missing} arrives, Complete!</p>` : ''}
                </div>
            `).join('') : '<p style="margin-top:10px;color:var(--gray);font-size:0.9rem;">No Directional Harmony found.</p>'}
        </div>
        
        <div class="info-box">
            <p><strong>ü§´ Hidden Harmony (ÊöóÂêà)</strong> - Hidden harmony between branch stems</p>
            ${amhap.length ? amhap.map(a => `
                <div style="margin-top:10px;padding:12px;background:rgba(156,39,176,0.1);border-radius:8px;border-left:3px solid #9C27B0;">
                    <p style="font-weight:bold;color:#9C27B0;">${a.name}</p>
                    <p style="margin-top:5px;font-size:0.9rem;">${a.positions}</p>
                    <p style="margin-top:5px;font-size:0.85rem;">${a.desc}</p>
                    <p style="margin-top:5px;font-size:0.8rem;color:var(--gray);">üí´ ${a.meaning}</p>
                </div>
            `).join('') : '<p style="margin-top:10px;color:var(--gray);font-size:0.9rem;">No hidden harmony.</p>'}
        </div>
    `;
    
    // ========== Advanced Harmony/Clash Analysis ==========
    const advInt = analyzeAdvancedInteractions(SAJU);
    document.getElementById('advanced-interactions').innerHTML = `
        ${advInt.hapHwa.length ? `
            <div class="info-box" style="margin-bottom:10px;">
                <p><strong>üîÆ Stem Transformation Analysis</strong></p>
                ${advInt.hapHwa.map(h => `
                    <div style="margin-top:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:6px;border-left:3px solid ${h.isHwa ? 'var(--gold)' : 'var(--gray)'};">
                        <p><strong>${h.name}</strong> (${h.stems})</p>
                        <p style="font-size:0.85rem;color:${h.isHwa ? 'var(--gold)' : 'var(--gray)'};margin-top:5px;">
                            ${h.isHwa ? `‚ú® ${h.result} transformation complete! ${h.reason}` : `‚ö™ ${h.reason}`}
                        </p>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        ${advInt.samhapGuk.length ? `
            <div class="info-box" style="margin-bottom:10px;">
                <p><strong>üåÄ Trinity (‰∏âÂêà) Analysis</strong></p>
                ${advInt.samhapGuk.map(s => `
                    <div style="margin-top:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:6px;border-left:3px solid ${s.complete ? 'var(--wood)' : 'var(--earth)'};">
                        <p><strong>${s.name}</strong> ‚Üí ${s.result} energy</p>
                        <p style="font-size:0.85rem;margin-top:5px;">${s.desc}</p>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        ${advInt.chungHaeso.length ? `
            <div class="info-box ${advInt.chungHaeso.some(c => !c.isResolved) ? 'warn' : ''}" style="margin-bottom:10px;">
                <p><strong>‚ö° Clash Resolution Analysis</strong></p>
                ${advInt.chungHaeso.map(c => `
                    <div style="margin-top:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:6px;border-left:3px solid ${c.isResolved ? 'var(--wood)' : 'var(--fire)'};">
                        <p><strong>${c.clash}</strong></p>
                        <p style="font-size:0.85rem;color:${c.isResolved ? 'var(--wood)' : 'var(--fire)'};margin-top:5px;">${c.reason}</p>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        ${advInt.warnings.length ? `
            <div class="info-box warn">
                <p><strong>‚ö†Ô∏è Special Warnings</strong></p>
                ${advInt.warnings.map(w => `
                    <div style="margin-top:10px;">
                        <p><strong>${w.type}</strong></p>
                        <p style="font-size:0.85rem;margin-top:5px;">${w.desc}</p>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        ${!advInt.hapHwa.length && !advInt.samhapGuk.length && !advInt.chungHaeso.length && !advInt.warnings.length ?
            '<p style="color:var(--gray);">No special transformations or clashes. A peaceful chart!</p>' : ''}
    `;
    
    // Emptiness
    const gm = calcGongmang(SAJU);
    document.getElementById('gongmang').innerHTML = `<div class="info-box"><p><strong>Í≥µÎßù:</strong> ${gm.names.join(', ')}<br>${gm.affected.length ? `‚ö†Ô∏è ${gm.affected.join(', ')} has Empty Void (Á©∫‰∫°). This area energy is weak.` : 'No Empty Void (Á©∫‰∫°) in chart!'}</p></div>`;
    
    // ========== Í≥µÎßù Ìï¥ÏÜå Î∂ÑÏÑù (NEW) ==========
    const gmHaeso = analyzeGongmangHaeso(SAJU, gm);
    document.getElementById('gongmang-haeso').innerHTML = gmHaeso.hasGongmang ? `
        ${gmHaeso.results.map(r => `
            <div class="info-box ${r.resolved ? 'good' : 'warn'}" style="margin-bottom:10px;">
                <p><strong>${r.position} Í≥µÎßù (${r.branch})</strong></p>
                <p style="margin-top:8px;font-size:0.9rem;">
                    ${r.resolved ? 
                        `‚úÖ Ìï¥ÏÜåÎê®: ${r.method}` : 
                        `‚ùå Ìï¥ÏÜåÎêòÏßÄ ÏïäÏùå`}
                </p>
                <p style="margin-top:5px;font-size:0.85rem;color:var(--gray);">${r.effect}</p>
            </div>
        `).join('')}
        <div class="info-box" style="margin-top:10px;">
            <p><strong>üí° Empty Void (Á©∫‰∫°) Resolution Conditions</strong></p>
            <p style="margin-top:8px;font-size:0.85rem;line-height:1.6;">
                1. Clash resolution: Opposite branch present<br>
                2. Trinity resolution: Other two trinity branches present<br>
                3. Luck cycle resolution: Temporary when conditions met in luck cycles
            </p>
        </div>
    ` : '<div class="info-box"><p style="color:var(--gray);">No void in chart - resolution analysis not needed. üëç</p></div>';
    
    // Spirit Indicators
    const sinsal = calcSinsal(SAJU);
    document.getElementById('sinsal').innerHTML = sinsal.length ? sinsal.map(s => `<div class="sinsal ${s.t}"><div class="sinsal-icon">${s.i}</div><div><div class="sinsal-name">${s.n}</div><div class="sinsal-desc">${s.d}</div></div></div>`).join('') : '<p style="color:var(--gray);">No special divine stars.</p>';
    
    // ========== Ïã†ÏÇ¥ ÏúÑÏπòÎ≥Ñ Î∂ÑÏÑù (NEW) ==========
    const sinsalPos = analyzeSinsalPosition(SAJU);
    document.getElementById('sinsal-position').innerHTML = sinsalPos.length ? `
        <div class="info-box" style="margin-bottom:10px;">
            <p style="font-size:0.85rem;color:var(--gray);">The same Divine Star has different meanings depending on its position.</p>
        </div>
        ${sinsalPos.map(sp => `
            <div class="info-box" style="margin-bottom:10px;border-left:3px solid ${sp.sinsal.includes('Peach Blossom') ? '#e91e63' : sp.sinsal.includes('Traveling Horse') ? '#ff9800' : '#9c27b0'};">
                <p><strong>${sp.sinsal}</strong> - ${sp.position}</p>
                <p style="margin-top:8px;font-size:0.9rem;">${sp.interpretation}</p>
                <p style="margin-top:5px;font-size:0.85rem;color:var(--gold);">üí° ${sp.advice}</p>
            </div>
        `).join('')}
    ` : '<div class="info-box"><p style="color:var(--gray);">No major divine stars to analyze by position.</p></div>';
    
    // AI Comprehensive Interpretation
    document.getElementById('ai-interpretation').innerHTML = generateAIInterpretation(SAJU, GODS, BIRTH_YEAR, GENDER);
    
    // Summary Analysis
    const summaryEl = document.getElementById('summary-analysis');
    if (summaryEl) {
        const dm = SAJU.day.s;
        const str = calcStrength(SAJU);
        const format = calcFormat(SAJU);
        const curYear = new Date().getFullYear();
        const luck = calcLuck(SAJU, BIRTH_YEAR, GENDER, GODS);
        const curLuck = luck.find(l => l.isCur);
        
        summaryEl.innerHTML = `
            <div class="info-box gold" style="margin-bottom:15px;">
                <p style="font-size:1.1rem;font-weight:bold;margin-bottom:10px;">üìã Your Four Pillars at a Glance</p>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div class="info-box" style="margin:0;">
                    <p style="font-size:0.8rem;color:var(--gray);">Day Master</p>
                    <p style="font-size:1.2rem;font-weight:bold;color:var(--gold);">${dm.c} ${ELEMENT[dm.e].k}</p>
                    <p style="font-size:0.85rem;margin-top:5px;">${str.pct}% ${str.type === 'strong' ? 'üí™ Strong' : str.type === 'weak' ? 'üåä Gentle' : '‚öñÔ∏è Balanced'}</p>
                </div>
                <div class="info-box" style="margin:0;">
                    <p style="font-size:0.8rem;color:var(--gray);">Structure (Ê†ºÂ±Ä)</p>
                    <p style="font-size:1rem;font-weight:bold;">${format.k || format.name}</p>
                </div>
                <div class="info-box" style="margin:0;">
                    <p style="font-size:0.8rem;color:var(--gray);">Beneficial Element</p>
                    <p style="font-size:1.2rem;font-weight:bold;color:${ELEMENT[GODS.yong].color};">${ELEMENT[GODS.yong].icon} ${ELEMENT[GODS.yong].k}</p>
                </div>
                <div class="info-box" style="margin:0;">
                    <p style="font-size:0.8rem;color:var(--gray);">Current Life Cycle</p>
                    <p style="font-size:1rem;font-weight:bold;">${curLuck ? curLuck.s.c + curLuck.b.c : '-'}</p>
                    <p style="font-size:0.8rem;color:var(--gray);">${curLuck ? 'Ages ' + curLuck.startAge + '-' + curLuck.endAge : ''}</p>
                </div>
            </div>
            <div class="info-box" style="margin-top:10px;text-align:center;">
                <p style="font-size:0.9rem;"><strong>${curYear} Outlook:</strong> ${str.type === 'balanced' ? 'üåü Excellent adaptability!' : str.type === 'strong' ? 'üí™ Lead with confidence!' : 'ü§ù Collaborate for success!'}</p>
            </div>
        `;
    }
    
    // Today's Fortune direct display
    const todayEl = document.getElementById('today-fortune');
    if (todayEl) {
        todayEl.innerHTML = getTodayFortune();
    }
    
    // Init fortune reading (fortune-contentÍ∞Ä ÏûàÏúºÎ©¥)
    renderFortune('total');
    } catch (error) {
        console.error('ÏÇ¨Ï£º Î†åÎçîÎßÅ Ïò§Î•ò:', error);
        toast('Error displaying results.');
    }
}

function renderFortune(type) {
    const el = document.getElementById('fortune-content');
    if (!el) return; // Skip if element missing
    if (!SAJU) { el.innerHTML = '<p>Please analyze your Four Pillars first.</p>'; return; }
    
    const str = calcStrength(SAJU);
    
    // Use new detailed reading function
    if (type === 'today') {
        el.innerHTML = genTodayFortune(SAJU, GODS);
        return;
    }
    if (type === 'year') {
        const cy = new Date().getFullYear();
        el.innerHTML = genYearFortune(SAJU, GODS, cy);
        return;
    }
    if (type === 'career') {
        el.innerHTML = genCareerFortune(SAJU, str, GODS);
        return;
    }
    if (type === 'love') {
        el.innerHTML = genLoveFortune(SAJU, str, GODS);
        return;
    }
    if (type === 'wealth') {
        el.innerHTML = genWealthFortune(SAJU, str, GODS);
        return;
    }
    if (type === 'health') {
        el.innerHTML = genHealthFortune(SAJU, str, GODS);
        return;
    }
    
    // total (Í∏∞Î≥∏Í∞í)
    const dm = SAJU.day.s;
    const yongEl = ELEMENT[GODS.yong];
    const colorAdvice = {
        wood: { color: 'Ï¥àÎ°ùÏÉâ, Ï≤≠Î°ùÏÉâ', dir: 'ÎèôÏ™Ω', num: '3, 8', item: 'Wood ÏÜåÌíà, ÏãùWater, Ï±Ö' },
        fire: { color: 'Îπ®Í∞ÑÏÉâ, Î≥¥ÎùºÏÉâ', dir: 'ÎÇ®Ï™Ω', num: '2, 7', item: 'Ï°∞Î™Ö, Ï∫îÎì§, Ï†ÑÏûêÍ∏∞Í∏∞' },
        earth: { color: 'ÎÖ∏ÎûÄÏÉâ, Í∞àÏÉâ', dir: 'Ï§ëÏïô', num: '5, 10', item: 'ÎèÑÏûêenergy, ÌÅ¨Î¶¨Ïä§ÌÉà, Î∂ÄÎèôÏÇ∞' },
        metal: { color: 'Ìù∞ÏÉâ, MetalÏÉâ, ÏùÄÏÉâ', dir: 'ÏÑúÏ™Ω', num: '4, 9', item: 'Í∏àÏÜç Ïï°ÏÑ∏ÏÑúÎ¶¨, ÏãúÍ≥Ñ, ÏûêÎèôÏ∞®' },
        water: { color: 'Í≤ÄÏùÄÏÉâ, ÌååÎûÄÏÉâ', dir: 'Î∂ÅÏ™Ω', num: '1, 6', item: 'WaterÏ°±Í¥Ä, Î∂ÑWater, Í∑∏Î¶º' }
    };
    const yongAdvice = colorAdvice[GODS.yong];
    
    const typeDesc = {
        strong: `<strong>üî• Strong Chart!</strong><br><br>You have a strong will and don't get swayed by others.<br><br><strong>Strengths:</strong> Leadership, Quick decisions, Independence, Drive<br><strong>Watch out:</strong> Too strong can seem stubborn. Listen to others sometimes!`,
        weak: `<strong>üíß Gentle Chart!</strong><br><br>You cooperate well and live harmoniously with others.<br><br><strong>Strengths:</strong> Perceptive, Adaptable, Considerate, Noble helpers<br><strong>Watch out:</strong> Don't be too cautious. Be confident!`,
        balanced: `<strong>‚öñÔ∏è Balanced Chart!</strong><br><br>Strong when needed, gentle when appropriate ‚Äî the versatile type! This is the best state in Saju!<br><br><strong>Strengths:</strong> Quick situational judgment, Best adaptability, Thrives anywhere`
    };
    
    el.innerHTML = `
        <div class="info-box gold">
            <p><strong>üìä Overall Fortune Analysis</strong></p>
        </div>
        <div class="info-box" style="margin-top:12px;">
            <p style="line-height:1.8;">${typeDesc[GODS.type]}</p>
        </div>
        ${str.extreme ? `<div class="info-box warn" style="margin-top:12px;"><p><strong>‚ö° ${str.extreme} Chart!</strong><br>${str.extreme === 'Extreme Strong' ? 'Extremely strong energy ‚Äî possibly a Special Structure (ÂæûÊ†º). Living by your own will leads to success!' : 'Extremely weak energy ‚Äî possibly a Special Structure (ÂæûÊ†º). Following others and collaborating leads to success!'}</p></div>` : ''}
        <div class="info-box good" style="margin-top:15px;">
            <p><strong>üéØ Beneficial Element Guide</strong></p>
            <p style="margin-top:8px;">Your Beneficial Element is <strong>${yongEl.n}(${yongEl.k})</strong> ‚Äî keep this energy close!</p>
            <ul style="margin-top:10px;margin-left:15px;line-height:1.8;">
                <li>üé® Lucky Color: ${yongAdvice.color}</li>
                <li>üß≠ Lucky Direction: ${yongAdvice.dir}</li>
                <li>üî¢ Lucky Number: ${yongAdvice.num}</li>
                <li>‚ú® Lucky Item: ${yongAdvice.item}</li>
            </ul>
        </div>`;
}

function getTodayFortune() {
    const today = new Date();
    const dp = calcDayPillar(today.getFullYear(), today.getMonth() + 1, today.getDate());
    const god = getTenGod(dp.s, SAJU.day.s);
    
    const isYong = [dp.s.e, dp.b.e].includes(GODS.yong);
    const isHee = [dp.s.e, dp.b.e].includes(GODS.hee);
    const isGi = [dp.s.e, dp.b.e].includes(GODS.gi);
    
    let rating, advice;
    if (isYong) {
        rating = '‚ú® Great Fortune';
        advice = 'Today your Beneficial Element energy is strong! Push forward with important matters. Active movement brings good results.';
    } else if (isHee) {
        rating = 'üòä Good';
        advice = 'Supporting Element helps today. Plans proceed smoothly. New attempts bring fortune.';
    } else if (isGi) {
        rating = '‚ö†Ô∏è Caution';
        advice = 'Challenging Element energy is strong today. Avoid overexertion, postpone major decisions, and focus on existing tasks.';
    } else {
        rating = 'üòê Neutral';
        advice = 'An ordinary day. Maintain your routine and find small joys.';
    }
    
    return `<div class="info-box">
        <p><strong>üìÖ Today's Fortune</strong> <span style="color:var(--gold);">(${dp.s.c}${dp.b.c} Day)</span></p>
        <div style="margin-top:12px;text-align:center;font-size:18px;">${rating}</div>
        <p style="margin-top:12px;line-height:1.8;">
            Today's day energy: <strong>${dp.s.c}${dp.b.c}</strong> (${ELEMENT[dp.s.e].k}${ELEMENT[dp.b.e].k})<br>
            Today's Influence: <strong>${god.k}</strong> - ${god.d}
        </p>
        <div style="margin-top:15px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
            <p><strong>üí° Today's Advice</strong></p>
            <p style="margin-top:8px;line-height:1.6;">${advice}</p>
        </div>
    </div>`;
}

function getYearFortune() {
    const cy = new Date().getFullYear();
    const yp = calcYearPillar(cy, 6, 1);
    const god = getTenGod(yp.s, SAJU.day.s);
    
    const isYong = [yp.s.e, yp.b.e].includes(GODS.yong);
    const isHee = [yp.s.e, yp.b.e].includes(GODS.hee);
    const isGi = [yp.s.e, yp.b.e].includes(GODS.gi);
    
    let rating, advice;
    if (isYong) {
        rating = 'üåü Excellent Year';
        advice = 'This is your Beneficial Element year! A once-in-10-years opportunity. Actively challenge yourself and expand. Big decisions like career change, starting business, or marriage bring fortune.';
    } else if (isHee) {
        rating = 'üòä Good Year';
        advice = 'Supporting Element helps this year. Work goes smoothly and help comes easily. Expand connections and invest in learning.';
    } else if (isGi) {
        rating = '‚ö†Ô∏è Caution Year';
        advice = 'Challenging Element year. Avoid overexpansion or risky investments. Focus on health and maintain stability while building inner strength.';
    } else {
        rating = 'üòê Neutral Year';
        advice = 'A stable year without major changes. Stay focused on your work and prepare for next opportunities.';
    }
    
    return `<div class="info-box">
        <p><strong>üìÜ ${cy} Year Fortune</strong> <span style="color:var(--gold);">(${yp.s.c}${yp.b.c})</span></p>
        <div style="margin-top:12px;text-align:center;font-size:18px;">${rating}</div>
        <p style="margin-top:12px;line-height:1.8;">
            Annual Fortune: <strong>${yp.s.c}${yp.b.c}</strong> (${ELEMENT[yp.s.e].k} ${ELEMENT[yp.b.e].k})<br>
            This Year's God: <strong>${god.k}</strong> - ${god.d}
        </p>
        <div style="margin-top:15px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
            <p><strong>üí° Advice for This Year</strong></p>
            <p style="margin-top:8px;line-height:1.6;">${advice}</p>
        </div>
        <div style="margin-top:12px;padding:12px;background:rgba(253,216,53,0.1);border-radius:8px;">
            <p><strong>üìÖ Favorable Months</strong></p>
            <p style="margin-top:8px;">${ELEMENT[GODS.yong].k} energy peaks in: ${getGoodMonths()}</p>
        </div>
    </div>`;
}

function getGoodMonths() {
    const monthElements = ['water','water','wood','wood','earth','fire','fire','earth','metal','metal','earth','water'];
    const goodMonths = [];
    monthElements.forEach((el, i) => {
        if (el === GODS.yong || el === GODS.hee) goodMonths.push(MONTH_ABBR[i]);
    });
    return goodMonths.length ? goodMonths.join(', ') : 'Second half of year brings more fortune';
}

/* ========================================
   AI Ï¢ÖÌï© Ìï¥ÏÑù ÏóîÏßÑ
   ======================================== */
function generateAIInterpretation(saju, gods, birthYear, gender) {
    const dm = saju.day.s;
    const str = calcStrength(saju);
    const currentYear = new Date().getFullYear();
    const age = currentYear - birthYear + 1;
    
    // Gather analysis results
    const interactions = calcInteractions(saju);
    const format = calcFormat(saju);
    const sinsal = calcSinsal(saju);
    const gongmang = calcGongmang(saju);
    const luck = calcLuck(saju, birthYear, gender, gods);
    const curLuck = luck.find(l => l.isCur);
    
    // ‰∫îË°å(Five Elements) distribution
    const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if(p && p.s) elCount[p.s.e]++;
        if(p && p.b) elCount[p.b.e]++;
    });
    
    // Strongest/Weakest elements
    const maxEl = Object.entries(elCount).reduce((a,b) => b[1] > a[1] ? b : a);
    const minEl = Object.entries(elCount).filter(e => e[1] === 0);
    
    // Harmony/Clash analysis
    const hasGoodHap = interactions.some(i => i.t.includes('Âêà'));
    const hasBadChung = interactions.some(i => i.t.includes('Ê≤ñ'));
    
    // Good/Bad stars
    const goodSinsal = sinsal.filter(s => s.t === 'good');
    const badSinsal = sinsal.filter(s => s.t === 'bad');
    
    // ========== Core Message ==========
    let coreMessage = '';
    let priority = [];
    
    const dmName = `${dm.c} ${ELEMENT[dm.e].k}`;
    const dmHanja = `${dm.c}${ELEMENT[dm.e].c}`;
    
    if (str.type === 'strong') {
        coreMessage = `<strong>${dmName} (${dmHanja})</strong> Day Master is ${str.pct}% <span style="color:var(--fire);">Strong</span>. You have a powerful will and lead your own path in life.`;
        priority.push('Forge your own path - independence suits you best');
    } else if (str.type === 'weak') {
        coreMessage = `<strong>${dmName} (${dmHanja})</strong> Day Master is ${str.pct}% <span style="color:var(--water);">Weak</span>. You shine brightest through cooperation and harmony with others.`;
        priority.push('Partner with the right people - collaboration is your key');
    } else {
        coreMessage = `<strong>${dmName} (${dmHanja})</strong> Day Master is ${str.pct}% <span style="color:var(--gold);">Balanced</span>. You can adapt flexibly to any situation.`;
        priority.push('Adaptability is your superpower');
    }
    
    // Conflict analysis
    let conflictAnalysis = [];
    
    if (hasBadChung && hasGoodHap) {
        conflictAnalysis.push({
            type: 'resolved',
            msg: 'Your chart has both Clash and Harmony - conflicts tend to resolve themselves. You experience growth through challenges.'
        });
    } else if (hasBadChung) {
        conflictAnalysis.push({
            type: 'caution',
            msg: 'Your chart contains Clash energy - expect changes and some conflicts. However, these can become opportunities for growth.'
        });
    }
    
    if (minEl.length >= 2) {
        conflictAnalysis.push({
            type: 'missing',
            msg: `Missing ${minEl.map(e => ELEMENT[e[0]].display).join(', ')} elements. Your Beneficial Element (${ELEMENT[gods.yong].n}) naturally compensates for this.`
        });
    }
    
    if (str.extreme) {
        conflictAnalysis.push({
            type: 'extreme',
            msg: `This is an ${str.extreme === 'Extreme Strong' ? 'Extremely Strong' : 'Extremely Weak'} chart. ${str.extreme === 'Extreme Strong' ? 'Following your own will leads to success.' : 'Delegating and collaborating is your key to success.'}`
        });
    }
    
    // Timing guide
    let timingGuide = '';
    const yearPillar = calcYearPillar(currentYear, 6, 1);
    const isYongYear = [yearPillar.s.e, yearPillar.b.e].includes(gods.yong);
    const isGiYear = [yearPillar.s.e, yearPillar.b.e].includes(gods.gi);
    
    if (curLuck) {
        const isGoodLuck = curLuck.rating === 'good';
        const luckEl = ELEMENT[curLuck.s.e].n;
        
        if (isGoodLuck && isYongYear) {
            timingGuide = `üåü <strong>Golden Opportunity!</strong><br>Both your Â§ßÈÅã(Life Cycle) and this year are favorable. Ages ${curLuck.startAge}-${curLuck.endAge} (${curLuck.s.c}${curLuck.b.c}) with ${luckEl} energy supporting you, plus ${currentYear} is your Beneficial Year. <span style="color:var(--gold);">Take bold action now!</span>`;
        } else if (isGoodLuck && isGiYear) {
            timingGuide = `‚öñÔ∏è <strong>Mixed Energies</strong><br>Your Â§ßÈÅã(Life Cycle) brings fortune but this year has challenging energy. Stay the course - short-term difficulties won't derail your upward trajectory. <span style="color:var(--earth);">Build foundations for next year.</span>`;
        } else if (!isGoodLuck && isYongYear) {
            timingGuide = `üí´ <strong>Year of Reversal!</strong><br>Though your current Â§ßÈÅã(Life Cycle) is weak, this year brings Beneficial energy. Don't miss this window! <span style="color:var(--gold);">Act now for good results.</span>`;
        } else if (!isGoodLuck && isGiYear) {
            timingGuide = `üõ°Ô∏è <strong>Time for Patience</strong><br>Both Â§ßÈÅã(Life Cycle) and yearly energy require caution. Focus on <span style="color:var(--water);">health and inner strength</span> rather than expansion. Better times are coming.`;
        } else {
            timingGuide = `üòä <strong>Steady Flow</strong><br>Ages ${curLuck.startAge}-${curLuck.endAge} Â§ßÈÅã(Life Cycle) (${curLuck.s.c}${curLuck.b.c}). Consistency is your best strategy.`;
        }
    }
    
    // Personal advice
    let personalAdvice = [];
    
    if (age < 30) {
        personalAdvice.push({icon:'üìö', title:'Advice for 20s', msg:`Study or gain experience in ${ELEMENT[gods.yong].n}-related fields. This becomes a lifelong asset.`});
    } else if (age < 40) {
        personalAdvice.push({icon:'üöÄ', title:'Advice for 30s', msg:`What you build now bears fruit in your 40s. Develop expertise in ${format.b.split(',')[0]} areas.`});
    } else if (age < 50) {
        personalAdvice.push({icon:'üéØ', title:'Advice for 40s', msg:'Time to leverage your experience and lead. Mentoring others also benefits you.'});
    } else {
        personalAdvice.push({icon:'üå≥', title:'Life Wisdom', msg:'Share your wisdom and prioritize health. Spiritual richness is true happiness.'});
    }
    
    const yongAdvice = {
        wood: {actions:['East direction', 'Morning exercise', 'Green colors', 'Reading/Learning', 'New beginnings'], avoid:'Excessive competition, metal decor'},
        fire: {actions:['South direction', 'Social gatherings', 'Red accents', 'Social media', 'Public speaking'], avoid:'Dark environments, isolation'},
        earth: {actions:['Center positions', 'Real estate', 'Yellow/Brown colors', 'Building trust', 'Stable investments'], avoid:'Frequent moves, sudden changes'},
        metal: {actions:['West direction', 'Finance/Investment', 'White/Silver colors', 'Setting principles', 'Organization'], avoid:'Indecisiveness, chaotic environments'},
        water: {actions:['North direction', 'Flexible thinking', 'Black/Blue colors', 'Networking', 'Travel'], avoid:'Stubbornness, staying in one place'}
    };
    
    const yongAction = yongAdvice[gods.yong];
    personalAdvice.push({
        icon:'‚ú®',
        title:`Using ${ELEMENT[gods.yong].n} (Beneficial Element)`,
        msg:`Recommended: ${yongAction.actions.slice(0,3).join(', ')}<br>Avoid: ${yongAction.avoid}`
    });
    
    personalAdvice.push({
        icon:'üíº',
        title:'Career Aptitude',
        msg:`Based on your ${format.n}: ${format.b}`
    });
    
    if (goodSinsal.length > 0) {
        personalAdvice.push({
            icon:'üåü',
            title:'Lucky Stars',
            msg:`You have ${goodSinsal.map(s => s.n).join(', ')}. Trust this energy and take bold action!`
        });
    }
    
    // ========== Generate HTML ==========
    let html = `
        <div style="padding:15px;background:linear-gradient(135deg,rgba(156,39,176,0.1),rgba(103,58,183,0.05));border-radius:12px;margin-bottom:15px;">
            <p style="font-size:0.85rem;color:var(--gray);margin-bottom:10px;">üß† AI Comprehensive Analysis of Your Four Pillars</p>
            <p style="line-height:1.8;font-size:1rem;">${coreMessage}</p>
        </div>
    `;
    
    if (conflictAnalysis.length > 0) {
        html += `
            <div class="info-box ${conflictAnalysis.some(c => c.type === 'caution' || c.type === 'extreme') ? 'warn' : ''}" style="margin-bottom:15px;">
                <p style="margin-bottom:10px;"><strong>‚öñÔ∏è Energy Conflict Analysis</strong></p>
                ${conflictAnalysis.map(c => `
                    <div style="padding:10px;margin:8px 0;background:rgba(255,255,255,0.05);border-radius:8px;border-left:3px solid ${c.type === 'caution' ? 'var(--fire)' : c.type === 'resolved' ? 'var(--wood)' : 'var(--gold)'};">
                        <p style="font-size:0.9rem;line-height:1.6;">${c.msg}</p>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    html += `
        <div class="info-box gold" style="margin-bottom:15px;">
            <p style="margin-bottom:10px;"><strong>üìÖ Current Period Guide (${currentYear}, Age ${age})</strong></p>
            <p style="line-height:1.8;font-size:0.95rem;">${timingGuide}</p>
        </div>
    `;
    
    html += `
        <div class="info-box" style="margin-bottom:15px;">
            <p style="margin-bottom:12px;"><strong>üí° Personalized Advice</strong></p>
            ${personalAdvice.map(a => `
                <div style="padding:12px;margin:8px 0;background:rgba(255,255,255,0.05);border-radius:8px;">
                    <p style="font-weight:bold;margin-bottom:5px;">${a.icon} ${a.title}</p>
                    <p style="font-size:0.9rem;line-height:1.6;color:var(--gray);">${a.msg}</p>
                </div>
            `).join('')}
        </div>
    `;
    
    if (priority.length > 0) {
        html += `
            <div style="padding:15px;background:linear-gradient(135deg,var(--gold),var(--gold-dark));border-radius:12px;color:var(--red-dark);text-align:center;">
                <p style="font-weight:bold;font-size:1.1rem;">üéØ Key Message</p>
                <p style="margin-top:8px;font-size:0.95rem;">"${priority[0]}"</p>
            </div>
        `;
    }
    
    return html;
}

function showTodayFortune() {
    const el = document.getElementById('today-fortune');
    if (!el) return;
    const content = document.getElementById('today-fortune-content');
    if (content) {
        content.innerHTML = getTodayFortune();
    }
}

/* ========================================
   AI Interpretation Copy Function
   ======================================== */
function copySajuForAI() {
    if (!SAJU) { toast('Please analyze your Four Pillars first'); return; }
    
    // Premium check
    if (!requirePremium('AI Interpretation Copy')) {
        return;
    }
    
    try {
        const str = calcStrength(SAJU);
        const dm = SAJU.day.s;
        const dmName = `${dm.c} ${ELEMENT[dm.e].k}`;
        const gods = GODS;
        const format = calcFormat(SAJU);
        const interactions = calcInteractions(SAJU) || [];
        const sinsal = calcSinsal(SAJU) || [];
        const gongmang = calcGongmang(SAJU);
        const luck = calcLuck(SAJU, BIRTH_YEAR, GENDER, GODS) || [];
        const curLuck = luck.find(l => l.isCur);
        const currentYear = new Date().getFullYear();
        const age = currentYear - BIRTH_YEAR + 1;
        const ilju = getIljuDesc(SAJU.day.s, SAJU.day.b);
        
        // Five Elements calculation
        const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
        [SAJU.year, SAJU.month, SAJU.day, SAJU.hour].forEach(p => {
            if(p && p.s) elCount[p.s.e]++;
            if(p && p.b) elCount[p.b.e]++;
        });
        
        // ====== ÏßÄÏû•Í∞Ñ(Hidden Stems) Ìè¨Ìï® Ïò§Ìñâ Ï≤¥ÌÅ¨ (v4.8 fix) ======
        const hiddenElCount = {wood:0, fire:0, earth:0, metal:0, water:0};
        const JIJANGGAN_MAP = {
            0: [9],           // Â≠ê: Áô∏
            1: [5,7,9],       // ‰∏ë: Â∑±,Ëæõ,Áô∏
            2: [0,2,4],       // ÂØÖ: Áî≤,‰∏ô,Êàä
            3: [1],           // ÂçØ: ‰πô
            4: [4,9,1],       // Ëæ∞: Êàä,Áô∏,‰πô
            5: [2,4,6],       // Â∑≥: ‰∏ô,Êàä,Â∫ö
            6: [3,5],         // Âçà: ‰∏Å,Â∑±
            7: [5,3,1],       // Êú™: Â∑±,‰∏Å,‰πô
            8: [6,8,4],       // Áî≥: Â∫ö,Â£¨,Êàä
            9: [7],           // ÈÖâ: Ëæõ
            10:[4,7,3],       // Êàå: Êàä,Ëæõ,‰∏Å
            11:[8,0]          // ‰∫•: Â£¨,Áî≤
        };
        [SAJU.year.b, SAJU.month.b, SAJU.day.b, SAJU.hour?.b].filter(b => b).forEach(b => {
            const bi = BRANCH.findIndex(br => br.c === b.c);
            const hidden = JIJANGGAN_MAP[bi] || [];
            hidden.forEach(hi => { hiddenElCount[STEM[hi].e]++; });
        });
        
        // Ten Gods calculation
        const yearGod = getTenGod(SAJU.year.s, dm);
        const monthGod = getTenGod(SAJU.month.s, dm);
        const hourGod = SAJU.hour ? getTenGod(SAJU.hour.s, dm) : null;
        
        // Ïã≠Ïã† Ï§ëÎ≥µ Ï≤¥ÌÅ¨ - Í∞ôÏùÄ Ïã≠Ïã†Ïù¥Î©¥ Í∞ÑÎûµÌôî
        const monthGodDesc = (monthGod.k === yearGod.k) 
            ? `Same as Year Stem (${yearGod.k}), amplifying its influence`
            : `${monthGod.k} - ${monthGod.d}`;
        const hourGodDesc = hourGod 
            ? (hourGod.k === yearGod.k || hourGod.k === monthGod.k)
                ? `Same as above (${hourGod.k})`
                : `${hourGod.k} - ${hourGod.d}`
            : null;
        
        // Twelve States Í≥ÑÏÇ∞
        const yearState = getTwelveState(dm, SAJU.year.b);
        const monthState = getTwelveState(dm, SAJU.month.b);
        const dayState = getTwelveState(dm, SAJU.day.b);
        const hourState = SAJU.hour ? getTwelveState(dm, SAJU.hour.b) : null;
        
        // Hidden Stems Analysis (safe)
        let jjText = '';
        try {
            const jjAnalysis = analyzeJijanggan(SAJU);
            if (jjAnalysis && jjAnalysis.pillars) {
                jjText = `‚Ä¢ Year Branch ${SAJU.year.b.c}: ${jjAnalysis.pillars[0]?.hidden?.map(h => h.stem.c + '(' + h.stem.k + ',' + h.type + ',' + h.god.k + ')').join(', ') || '-'}
‚Ä¢ Month Branch ${SAJU.month.b.c}: ${jjAnalysis.pillars[1]?.hidden?.map(h => h.stem.c + '(' + h.stem.k + ',' + h.type + ',' + h.god.k + ')').join(', ') || '-'}
‚Ä¢ Day Branch ${SAJU.day.b.c}: ${jjAnalysis.pillars[2]?.hidden?.map(h => h.stem.c + '(' + h.stem.k + ',' + h.type + ',' + h.god.k + ')').join(', ') || '-'}`;
                if (SAJU.hour && jjAnalysis.pillars[3]) {
                    jjText += `\n‚Ä¢ Hour Branch ${SAJU.hour.b.c}: ${jjAnalysis.pillars[3]?.hidden?.map(h => h.stem.c + '(' + h.stem.k + ',' + h.type + ',' + h.god.k + ')').join(', ') || '-'}`;
                }
            }
        } catch(e) { jjText = '‚Ä¢ Hidden Stems analysis unavailable'; }
        
        // Root/Stem Analysis (safe)
        let ttText = '';
        try {
            const ttAnalysis = analyzeTonggeunTougan(SAJU);
            const tgText = ttAnalysis?.tonggeun?.length ? 
                ttAnalysis.tonggeun.map(t => t.stem + ' roots in ' + (t.roots?.map(r => r.pillar + r.branch).join(',') || '')).join('; ') : 'No roots';
            const tuText = ttAnalysis?.tougan?.length ? 
                ttAnalysis.tougan.map(t => t.stem + '(' + t.god + ')').join(', ') : 'No stems revealed';
            ttText = `‚Ä¢ Roots (ÈÄöÊ†π): ${tgText}\n‚Ä¢ Stems Revealed (ÈÄèÂπ≤): ${tuText}`;
        } catch(e) { ttText = '‚Ä¢ Root/Stem analysis unavailable'; }
        
        // Six Relations (ÂÖ≠Ë¶™) Analysis (safe)
        let ycText = '';
        try {
            const yukcheon = analyzeYukcheon(SAJU, GENDER);
            if (yukcheon) {
                // Î∞∞Ïö∞ÏûêÏÑ± ÏÉÅÌÉú ÌåêÎ≥Ñ
                let spouseStatus = '';
                if (yukcheon.spouse?.count > 0) {
                    spouseStatus = yukcheon.spouse.count + ' visible';
                } else if (yukcheon.spouse?.hiddenSpouse?.found) {
                    if (yukcheon.spouse.hiddenSpouse.damaged) {
                        spouseStatus = 'Hidden but Damaged (' + yukcheon.spouse.hiddenSpouse.position + ' branch - ' + yukcheon.spouse.hiddenSpouse.damageDesc + ')';
                    } else {
                        spouseStatus = 'Hidden in ' + yukcheon.spouse.hiddenSpouse.position + ' branch (latent)';
                    }
                } else {
                    spouseStatus = 'Hidden (latent in chart)';
                }
                
                // üî• ÏûêÎÖÄÏÑ± ÏÉÅÌÉú ÌåêÎ≥Ñ - Gemini Round 4
                let childStatus = '';
                if (yukcheon.children?.hourStemChild) {
                    const hsc = yukcheon.children.hourStemChild;
                    if (hsc.underFire) {
                        childStatus = `REVEALED on Hour Stem (${hsc.stem.c}) but under Fire - challenged`;
                    } else {
                        childStatus = `REVEALED on Hour Stem (${hsc.stem.c})`;
                    }
                } else if (yukcheon.children?.count > 0) {
                    childStatus = 'Visible';
                } else {
                    childStatus = 'Hidden (may manifest in Life Cycles)';
                }
                
                ycText = `‚Ä¢ ÈÖçÂÅ∂Êòü(Spouse Star) (${yukcheon.spouse?.god || '-'}): ${spouseStatus} - ${yukcheon.spouse?.analysis || 'Check Divine Stars for hidden potential'}
‚Ä¢ Â≠êÂ•≥Êòü(Children Star) (${yukcheon.children?.gods?.join('/') || '-'}): ${childStatus} - ${yukcheon.children?.analysis || 'Check Life Cycles for timing'}
‚Ä¢ Father (ÂÅèË≤°/Indirect Wealth): ${yukcheon.parents?.father?.analysis || '-'}
‚Ä¢ Mother (Ê≠£Âç∞/Direct Seal): ${yukcheon.parents?.mother?.analysis || '-'}`;
            }
        } catch(e) { ycText = '‚Ä¢ Six Relations (ÂÖ≠Ë¶™) analysis unavailable'; }
        
        // ÂÆÆ‰Ωç(Palace Analysis) (safe)
        let gwText = '';
        try {
            const gungwi = analyzeGungwi(SAJU, BIRTH_YEAR);
            if (gungwi && Array.isArray(gungwi)) {
                gwText = gungwi.map(g => '‚Ä¢ ' + g.name + ' (' + g.ageRange + '): ' + (g.status || 'Neutral') + ' - ' + (g.twelveState || '') + (g.isCurrent ? ' ‚óÄ CURRENT' : '')).join('\n');
            }
        } catch(e) { gwText = '‚Ä¢ Palace analysis unavailable'; }
        
        // Next 10 Years (safe)
        let next10Text = '';
        try {
            const next10 = getNext10Years(SAJU, BIRTH_YEAR, GENDER, GODS);
            if (next10) {
                next10Text = `‚Ä¢ Best Year: ${next10.bestYear?.year || '-'} (Age ${next10.bestYear?.age || '-'})
‚Ä¢ Caution Year: ${next10.worstYear?.year || '-'} (Age ${next10.worstYear?.age || '-'})`;
            }
        } catch(e) { next10Text = '‚Ä¢ 10-year forecast unavailable'; }
        
        // Monthly Fortune (safe)
        let monthText = '';
        try {
            const monthlyLuck = getYearlyMonthLuck(currentYear, SAJU, GODS);
            if (monthlyLuck) {
                // Find climate clash months
                const climateClashMonths = monthlyLuck.months.filter(m => m.climateClash).map(m => m.month);
                // Find wang clash months (ÏûêÏò§Ï∂© Îì±)
                const wangClashMonths = monthlyLuck.wangClashMonths || [];
                monthText = `‚Ä¢ Best Month: ${monthlyLuck.best?.month || '-'} (${monthlyLuck.best?.god?.k || '-'})
‚Ä¢ Caution Month: ${monthlyLuck.worst?.month || '-'} (${monthlyLuck.worst?.god?.k || '-'})${climateClashMonths.length ? `
‚Ä¢ ‚ö†Ô∏è Climate Clash Months: ${climateClashMonths.join(', ')} - Extra caution for health!` : ''}${wangClashMonths.length ? `
‚Ä¢ üî• Fire-Water Clash Months: ${wangClashMonths.join(', ')} - Cardiovascular shock risk! Avoid sudden temperature changes.` : ''}`;
            }
        } catch(e) { monthText = '‚Ä¢ Monthly forecast unavailable'; }
        
        // Á¥çÈü≥(Sound Element)/ÂëΩÂÆÆ(Life Palace)/Conception (safe)
        let napeumText = '';
        try {
            const dayNapeum = calcNapeum(SAJU.day.s, SAJU.day.b);
            const yearNapeum = calcNapeum(SAJU.year.s, SAJU.year.b);
            napeumText = `‚Ä¢ Day Sound Element: ${SAJU.day.s.c}${SAJU.day.b.c} ‚Üí ${dayNapeum.name} (${dayNapeum.elementK}) - ${dayNapeum.desc}
‚Ä¢ Year Sound Element: ${SAJU.year.s.c}${SAJU.year.b.c} ‚Üí ${yearNapeum.name} (${yearNapeum.elementK})`;
        } catch(e) { napeumText = '‚Ä¢ Sound Element unavailable'; }
        
        let myunggungText = '';
        try {
            if (SAJU.hour) {
                const myunggung = calcMyunggung(SAJU.month.b, SAJU.hour.b);
                myunggungText = `‚Ä¢ Life Palace (ÂëΩÂÆÆ): ${myunggung.name}
‚Ä¢ Tendency: ${myunggung.trait}
‚Ä¢ Suitable Fields: ${myunggung.career}`;
            } else {
                myunggungText = '‚Ä¢ Life Palace: Cannot calculate without Hour';
            }
        } catch(e) { myunggungText = '‚Ä¢ Life Palace unavailable'; }
        
        let taewonText = '';
        try {
            const taewon = calcTaewon(SAJU.year.s, SAJU.month.s, SAJU.month.b);
            taewonText = `‚Ä¢ Conception Origin (ËÉéÂÖÉ): ${taewon.pillar}
‚Ä¢ Conception Sound Element: ${taewon.napeum.name} (${taewon.napeum.elementK})`;
        } catch(e) { taewonText = '‚Ä¢ Conception Origin unavailable'; }
        
        // ÊñπÂêà(Directional Harmony)/ÊöóÂêà(Hidden Harmony) (safe)
        let banghapText = '';
        try {
            const banghap = analyzeBanghap(SAJU);
            banghapText = banghap.length ? banghap.map(b => 
                `‚Ä¢ ${b.name} (${b.branches}): ${b.dir} ${b.type === 'complete' ? 'COMPLETE!' : 'Incomplete'}`
            ).join('\n') : '‚Ä¢ No Directional Harmony';
        } catch(e) { banghapText = '‚Ä¢ ÊñπÂêà(Directional Harmony) unavailable'; }
        
        let amhapText = '';
        try {
            const amhap = analyzeAmhap(SAJU);
            amhapText = amhap.length ? amhap.map(a => 
                `‚Ä¢ ${a.name}: ${a.positions} - ${a.desc}`
            ).join('\n') : '‚Ä¢ No Hidden Harmony';
        } catch(e) { amhapText = '‚Ä¢ Hidden Harmony unavailable'; }
        
        // Generate text
        let text = `===== FOUR PILLARS OF DESTINY (SAJU) ANALYSIS =====

„ÄêBASIC INFO„Äë
‚Ä¢ Birth Year: ${BIRTH_YEAR} (${GENDER === 'm' ? 'Male' : 'Female'}, Age ${age-1})
‚Ä¢ Day Master: ${dm.c} ${ELEMENT[dm.e].n} (${dm.c}${ELEMENT[dm.e].c})

„ÄêFOUR PILLARS CHART (Year/Month/Day/Hour)„Äë
‚Ä¢ Heavenly Stems: ${SAJU.year.s.c}(${SAJU.year.s.k}) ${SAJU.month.s.c}(${SAJU.month.s.k}) ${SAJU.day.s.c}(${SAJU.day.s.k}) ${SAJU.hour ? SAJU.hour.s.c+'('+SAJU.hour.s.k+')' : 'Unknown'}
‚Ä¢ Earthly Branches: ${SAJU.year.b.c}(${SAJU.year.b.k}) ${SAJU.month.b.c}(${SAJU.month.b.k}) ${SAJU.day.b.c}(${SAJU.day.b.k}) ${SAJU.hour ? SAJU.hour.b.c+'('+SAJU.hour.b.k+')' : 'Unknown'}

„ÄêTEN GODS (Based on Stems)„Äë
‚Ä¢ Year Stem ${SAJU.year.s.c}: ${yearGod.k} - ${yearGod.d}
‚Ä¢ Month Stem ${SAJU.month.s.c}: ${monthGodDesc}
‚Ä¢ Day Stem ${SAJU.day.s.c}: Self (Day Master)
${hourGod ? '‚Ä¢ Hour Stem ' + SAJU.hour.s.c + ': ' + hourGodDesc : '‚Ä¢ Hour Stem: Unknown'}

„ÄêTWELVE LIFE STAGES (Based on Day Master)„Äë
‚Ä¢ Year Branch ${SAJU.year.b.c}: ${yearState.k} (Energy ${yearState.l}/12)
‚Ä¢ Month Branch ${SAJU.month.b.c}: ${monthState.k} (Energy ${monthState.l}/12)
‚Ä¢ Day Branch ${SAJU.day.b.c}: ${dayState.k} (Energy ${dayState.l}/12)
${hourState ? '‚Ä¢ Hour Branch ' + SAJU.hour.b.c + ': ' + hourState.k + ' (Energy ' + hourState.l + '/12)' : '‚Ä¢ Hour Branch: Unknown'}

„ÄêFIVE ELEMENTS DISTRIBUTION„Äë
‚Ä¢ Wood (Êú®): ${elCount.wood}
‚Ä¢ Fire (ÁÅ´): ${elCount.fire}
‚Ä¢ Earth (Âúü): ${elCount.earth}
‚Ä¢ Metal (Èáë): ${elCount.metal}
‚Ä¢ Water (Ê∞¥): ${elCount.water}
‚Ä¢ Missing Elements: ${(() => {
    const missing = Object.entries(elCount).filter(e => e[1] === 0);
    if (missing.length === 0) return 'None';
    return missing.map(([el, cnt]) => {
        if (hiddenElCount[el] > 0) {
            return ELEMENT[el].c + '(' + ELEMENT[el].n + ') - Weak (Hidden in branches)';
        }
        return ELEMENT[el].c + '(' + ELEMENT[el].n + ')';
    }).join(', ');
})()}

„ÄêDAY MASTER STRENGTH„Äë
‚Ä¢ Strength: ${str.pct}% (${str.type === 'strong' ? 'STRONG Body' : str.type === 'weak' ? 'WEAK Body' : 'BALANCED'})
${str.extreme ? '‚Ä¢ Special Note: ' + (str.extreme === 'Extreme Strong' ? 'Extremely Strong' : 'Extremely Weak') + ' chart (Possible Special Format)' : ''}
${(() => {
    // v4.12.1: Ïã§Ï†ú ÌÜµÍ∑º Ï†ïÎ≥¥ (ÏßÄÏû•Í∞Ñ Í∏∞Ï§Ä)
    let rootInfo = '';
    if (str.dayRoot || str.hourRoot) {
        rootInfo = '‚Ä¢ ‚ö° REAL ROOTS (ÏßÄÏû•Í∞Ñ Í∏∞Ï§Ä): ';
        if (str.dayRoot) rootInfo += 'Day Branch has Peer/Seal in hidden stems. ';
        if (str.hourRoot) rootInfo += 'Hour Branch has Peer/Seal in hidden stems. ';
        rootInfo += 'Hidden resilience - not helpless despite low percentage.';
    } else if (str.type === 'weak') {
        rootInfo = '‚Ä¢ ‚ö†Ô∏è NO REAL ROOTS: Day Master lacks Peer/Seal in branch hidden stems. Flexible but needs external support.';
    }
    return rootInfo;
})()}
${(() => {
    // v4.12.1: Ï≤úÍ∞ÑÌï© Î¨¥Î†•Ìôî Ï†ïÎ≥¥
    if (str.disabledSeals?.length || str.disabledPeers?.length) {
        const disabled = [];
        if (str.disabledSeals?.length) {
            str.disabledSeals.forEach(si => disabled.push(STEM[si].c + '(Seal)'));
        }
        if (str.disabledPeers?.length) {
            str.disabledPeers.forEach(si => disabled.push(STEM[si].c + '(Peer)'));
        }
        return '‚Ä¢ üîó STEM COMBINE NEUTRALIZATION: ' + disabled.join(', ') + ' disabled by Â§©Âπ≤Âêà. These helpers cannot support Day Master.';
    }
    return '';
})()}
${(() => {
    // üî• Ïû¨Îã§Ïã†ÏïΩ(Ë≤°Â§öË∫´Âº±) Ï≤¥ÌÅ¨ - Gemini Round 3
    const dm = SAJU.day.s;
    const wealthEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5];  // Ïû¨ÏÑ± Ïò§Ìñâ
    const wealthCount = elCount[wealthEl] || 0;
    if (str.type === 'weak' && wealthCount >= 3) {
        return '‚Ä¢ üí∞ WEALTH OVERLOAD (Ë≤°Â§öË∫´Âº±): ' + wealthCount + ' Wealth elements overwhelming weak Day Master! ' +
               'Metaphor: "Small boat carrying elephant." ' +
               'Strategy: Do NOT chase money directly. Lock assets in Real Estate/Documents. Let spouse manage finances. Health first, money second.';
    }
    return '';
})()}
${(() => {
    // Rooted check - ÏùºÏßÄ/ÏãúÏßÄÏóê Î°ùÏôïÏßÄÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
    const dmEl = SAJU.day.s.e;
    const dayState = getTwelveState(SAJU.day.s, SAJU.day.b);
    const hourState = SAJU.hour ? getTwelveState(SAJU.day.s, SAJU.hour.b) : null;
    const strongStates = [11, 12]; // Í±¥Î°ù(11), Ï†úÏôï(12)
    const hasRoot = strongStates.includes(dayState.l) || (hourState && strongStates.includes(hourState.l));
    
    // üî• ÎøåÎ¶¨ Í≥µÍ≤© Ï≤¥ÌÅ¨ (ÏùºÏßÄ-ÏãúÏßÄ Ï∂©) - Gemini Round 3
    let rootUnderAttack = false;
    let attackDesc = '';
    if (SAJU.hour) {
        const dbi = BRANCH.findIndex(br => br.c === SAJU.day.b.c);
        const hbi = BRANCH.findIndex(br => br.c === SAJU.hour.b.c);
        // Ïú°Ï∂© Ï≤¥ÌÅ¨ (6 Ï∞®Ïù¥)
        if (Math.abs(dbi - hbi) === 6) {
            rootUnderAttack = true;
            attackDesc = `Day-Hour Clash (${SAJU.day.b.c}‚Üî${SAJU.hour.b.c})! Root is under attack from spouse palace.`;
        }
    }
    
    if (str.type === 'weak' && hasRoot) {
        if (rootUnderAttack) {
            return '‚Ä¢ ‚ö†Ô∏è ROOT UNDER ATTACK: Day Master has root in ' + 
                   (hourState && strongStates.includes(hourState.l) ? 'Hour Branch (' + hourState.k + ')' : 'Day Branch') +
                   ' BUT ' + attackDesc + 
                   ' Late-life instability. Spouse conflicts may drain vitality. Guard cardiovascular health especially in later years.';
        } else {
            return '‚Ä¢ ‚ö° ROOT ANALYSIS: Despite low percentage, Day Master has STRONG ROOTS in ' + 
                   (strongStates.includes(dayState.l) ? 'Day Branch (' + dayState.k + ')' : '') +
                   (strongStates.includes(dayState.l) && hourState && strongStates.includes(hourState.l) ? ' and ' : '') +
                   (hourState && strongStates.includes(hourState.l) ? 'Hour Branch (' + hourState.k + ')' : '') +
                   '. Hidden resilience and late-blooming potential. Not helpless - just selective about when to fight.';
        }
    }
    return '';
})()}
${(() => {
    // üî• Î¨¥ÏãùÏÉÅ(ÁÑ°È£üÂÇ∑) ÌÜµÍ¥Ä Î∂ÄÏû¨ Ï≤¥ÌÅ¨ - Gemini Round 5
    // ÏàòÌôîÏÉÅÏ†Ñ(Ê∞¥ÁÅ´Áõ∏Êà∞)Ïù∏Îç∞ Î™©(Êú®)Ïù¥ ÏóÜÎäî Í≤ΩÏö∞
    const dm = SAJU.day.s;
    const outputEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5];  // ÏãùÏÉÅ Ïò§Ìñâ
    const wealthEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5];  // Ïû¨ÏÑ± Ïò§Ìñâ
    
    // ÏùºÍ∞ÑÏù¥ Ê∞¥Ïù¥Í≥† Ïû¨ÏÑ±(ÁÅ´)Ïù¥ Í∞ïÌïúÎç∞ Êú®(ÌÜµÍ¥Ä)Ïù¥ ÏóÜÎäî Í≤ΩÏö∞
    if (dm.e === 'water' && elCount['wood'] === 0 && elCount['fire'] >= 2) {
        return '‚Ä¢ ‚ö†Ô∏è NO BRIDGE (ÁÑ°ÈÄöÈóú): Water (self) vs Fire (wealth) war with NO Wood mediator! ' +
               'Danger: Chasing money directly leads to health collapse. ' +
               'Solution: BUILD WOOD activities - learning, hobbies, plants, yoga, charity. This creates the bridge between effort and reward.';
    }
    // ÏùºÍ∞ÑÏù¥ ÁÅ´Ïù¥Í≥† Ïû¨ÏÑ±(Èáë)Ïù¥ Í∞ïÌïúÎç∞ Âúü(ÌÜµÍ¥Ä)Ïù¥ ÏóÜÎäî Í≤ΩÏö∞
    if (dm.e === 'fire' && elCount['earth'] === 0 && elCount['metal'] >= 2) {
        return '‚Ä¢ ‚ö†Ô∏è NO BRIDGE (ÁÑ°ÈÄöÈóú): Fire (self) vs Metal (wealth) war with NO Earth mediator! ' +
               'Danger: Wealth goals burn you out. ' +
               'Solution: BUILD EARTH activities - stability, real estate, documentation, grounding practices.';
    }
    return '';
})()}
${(() => {
    // üî• Ïó¨Î™Ö ÎπÑÍ≤Å Í≥ºÎã§ Ï≤¥ÌÅ¨ - Gemini Round 5
    if (GENDER !== 'f') return '';  // ÎÇ®Î™ÖÏùÄ Ìï¥Îãπ ÏóÜÏùå
    
    const dm = SAJU.day.s;
    // ÎπÑÍ≤¨/Í≤ÅÏû¨ Ïπ¥Ïö¥Ìä∏ (Í∞ôÏùÄ Ïò§Ìñâ)
    let peerCount = 0;
    const stems = [SAJU.year.s, SAJU.month.s, SAJU.day.s];
    if (SAJU.hour) stems.push(SAJU.hour.s);
    stems.forEach(s => {
        if (s.e === dm.e) peerCount++;
    });
    
    // ÏùºÏßÄÍ∞Ä Ï∂©ÏùÑ Î∞õÎäîÏßÄ Ï≤¥ÌÅ¨
    const dayBranchIdx = BRANCH.findIndex(br => br.c === SAJU.day.b.c);
    let dayClashed = false;
    const branches = [SAJU.year.b, SAJU.month.b];
    if (SAJU.hour) branches.push(SAJU.hour.b);
    branches.forEach(b => {
        if (Math.abs(BRANCH.findIndex(br => br.c === b.c) - dayBranchIdx) === 6) dayClashed = true;
    });
    
    if (peerCount >= 3 && dayClashed) {
        return '‚Ä¢ ‚ö†Ô∏è FEMALE PEER OVERLOAD (Â•≥ÂëΩÊØîÂä´Â§ö+Êó•ÊîØÊ≤ñ): ' + peerCount + ' same-element stems AND spouse palace clashed! ' +
               'Meaning: Competition in romantic sphere. Husband may face pressure. ' +
               'Advice: Maintain independence but avoid power struggles. "Weekend marriage" or separate hobbies preserve harmony.';
    } else if (peerCount >= 3) {
        return '‚Ä¢ ‚ö†Ô∏è FEMALE PEER OVERLOAD (Â•≥ÂëΩÊØîÂä´Â§ö): ' + peerCount + ' same-element stems. Strong independence but romantic competition possible. ' +
               'Advice: Choose partner who respects your autonomy. Avoid competing with spouse.';
    }
    return '';
})()}

„ÄêBENEFICIAL ELEMENTS (Áî®Á•û System)„Äë
‚Ä¢ Beneficial God (Áî®Á•û): ${ELEMENT[GODS.yong].n} (${ELEMENT[GODS.yong].c}) - Most needed element
‚Ä¢ Favorable God (ÂñúÁ•û): ${ELEMENT[GODS.hee].n} (${ELEMENT[GODS.hee].c}) - Supports beneficial element
‚Ä¢ Unfavorable God (ÂøåÁ•û): ${ELEMENT[GODS.gi].n} (${ELEMENT[GODS.gi].c}) - Element to avoid
${GODS.reasoning?.length ? '\n„ÄêÁî®Á•û DETERMINATION REASONING„Äë\n' + GODS.reasoning.map(r => '‚Ä¢ ' + r).join('\n') : ''}
${GODS.warnings?.length ? '\n„Äê‚ö†Ô∏è CRITICAL WARNINGS (Áî®Á•û Destruction Patterns)„Äë\n' + GODS.warnings.map(w => '‚Ä¢ üö® ' + w.type + ': ' + w.desc + '\n  ‚Üí Advice: ' + w.advice).join('\n') : ''}
${GODS.isFollower ? '‚Ä¢ üåÄ FOLLOWER CHART (' + GODS.followerType + '): Extremely weak Day Master follows the dominant element. DO NOT fight the trend - ride it. Years bringing ' + ELEMENT[GODS.yong].n + ' are FAVORABLE, not threatening.' : ''}
${GODS.sealExcess ? '‚Ä¢ ‚ö†Ô∏è SEAL EXCESS (ÂÅèÂç∞Â§™Êó∫): 3+ Seal elements suffocating Day Master. Output (Expression) needed to drain the overflow.' : ''}
${GODS.johu ? '‚Ä¢ Seasonal Adjustment: ' + (GODS.johuDesc || '') : ''}
${GODS.climate ? '‚Ä¢ Climate Balance: ' + GODS.climate.type + ' - ' + GODS.climate.desc : ''}

„ÄêPERSONALITY STRUCTURE (Ê†ºÂ±Ä)„Äë
‚Ä¢ ${format.n}
‚Ä¢ Characteristics: ${format.d}
${str.pct < 20 && format.n.includes('Wealth') ? '‚Ä¢ ‚ö†Ô∏è WEAK CHART WARNING: With low strength (' + str.pct.toFixed(1) + '%), this becomes "Anxious Chaser" rather than "Steady Builder". Wealth overwhelms instead of supports. Health-first strategy required.' : ''}
${format.fakeFollower ? '‚Ä¢ ‚ö†Ô∏è FAKE FOLLOWER ALERT: This may be a "Following Wealth/Officer" structure. If true, years that strengthen the dominant element (Fire/Earth) become FAVORABLE, not dangerous. Extreme volatility interpretation required.' : ''}
‚Ä¢ Suitable Fields: ${format.b}

„Äê60 PILLARS DAY MASTER THEORY - ${SAJU.day.s.c}${SAJU.day.b.c} Day„Äë
‚Ä¢ ${ilju.title}
‚Ä¢ Personality: ${ilju.desc?.substring(0, 100) || ''}...
‚Ä¢ Spouse Fortune: ${ilju.spouse?.substring(0, 80) || ''}...

„ÄêHIDDEN STEMS (ÊîØËóèÂπ≤)„Äë
${jjText}

„ÄêSOUND ELEMENT (Á¥çÈü≥)„Äë
${napeumText}

„ÄêLIFE PALACE (ÂëΩÂÆÆ)„Äë
${myunggungText}

„ÄêCONCEPTION ORIGIN (ËÉéÂÖÉ)„Äë
${taewonText}

„ÄêROOT & STEM ANALYSIS (ÈÄöÊ†πÈÄèÂπ≤)„Äë
${ttText}

„ÄêSIX RELATIONS (ÂÖ≠Ë¶™)„Äë
${ycText}

„ÄêPALACE ANALYSIS (ÂÆÆ‰Ωç) - Life Periods„Äë
${gwText}

„ÄêHARMONY & CLASH (ÂêàÊ≤ñÂàëÁ†¥ÂÆ≥)„Äë
${interactions.length ? interactions.map(i => '‚Ä¢ ' + i.t + ': ' + i.c + ' - ' + i.m).join('\n') : '‚Ä¢ No significant interactions'}

„ÄêDIRECTIONAL HARMONY (ÊñπÂêà)„Äë
${banghapText}

„ÄêHIDDEN HARMONY (ÊöóÂêà)„Äë
${amhapText}

„ÄêEMPTY VOID (Á©∫‰∫°)„Äë
‚Ä¢ Void Branches: ${gongmang?.names?.join(', ') || 'None'}
${gongmang?.affected?.length ? '‚Ä¢ Affected Positions: ' + gongmang.affected.join(', ') : '‚Ä¢ No void in Four Pillars'}

„ÄêDIVINE STARS (Á•ûÊÆ∫)„Äë
${sinsal.length ? sinsal.map(s => '‚Ä¢ ' + s.n + ' (' + (s.t === 'good' ? 'Auspicious' : s.t === 'bad' ? 'Inauspicious' : 'Neutral') + '): ' + s.d).join('\n') : '‚Ä¢ No significant divine stars'}

„ÄêLIFE CYCLES (Â§ßÈÅã) - 10-Year Periods„Äë
${luck.slice(0,8).map(l => '‚Ä¢ Ages ' + l.startAge + '-' + l.endAge + ': ' + l.s.c + l.b.c + ' (' + ELEMENT[l.s.e].n + '/' + ELEMENT[l.b.e].n + ')' + (l.isCur ? ' ‚óÄ CURRENT' : '')).join('\n')}

„ÄêCURRENT FORTUNE„Äë
‚Ä¢ Current Â§ßÈÅã(Life Cycle): ${curLuck ? curLuck.s.c + curLuck.b.c + ' (Ages ' + curLuck.startAge + '-' + curLuck.endAge + ')' : 'Calculating...'}
‚Ä¢ Cycle Rating: ${curLuck ? (curLuck.rating === 'good' ? 'FAVORABLE' : curLuck.rating === 'bad' ? 'CHALLENGING' : 'NEUTRAL') : '-'}${curLuck && curLuck.climateClash ? ' ‚ö†Ô∏è Climate Clash!' : ''}
‚Ä¢ ${currentYear} Ê≠≤ÈÅã(Annual Fortune): ${(() => { const yp = calcYearPillar(currentYear, 6, 1); return yp.s.c + yp.b.c + ' (' + ELEMENT[yp.s.e].n + '/' + ELEMENT[yp.b.e].n + ')'; })()}
${(() => {
    const yearLuck = calcYearLuck(currentYear, SAJU, GODS);
    const ratingText = yearLuck.rating === 'breakthrough' ? 'üöÄ BREAKTHROUGH - Grand Opportunity Year!' :
                       yearLuck.rating === 'yong_attacked' ? 'üö® DANGER - Beneficial Element Under Attack! Preserve assets!' :
                       yearLuck.rating === 'rob_wealth' ? '‚öîÔ∏è DANGER - Wealth Robbery Year (Áæ§Âä´Áà≠Ë≤°)! Avoid partnerships!' :
                       yearLuck.rating === 'surgery_risk' ? '‚öîÔ∏è HIGH RISK HIGH RETURN - Wealth OR Surgery Year (Ê≤ñÁæäÂàÉ)' :
                       yearLuck.rating === 'volatile_wealth' ? 'üí∞‚ö†Ô∏è VOLATILE WEALTH - Big money but health/spouse risk' :
                       yearLuck.rating === 'yong_overwhelmed' ? '‚ö†Ô∏è Ïá†Ïã†Ï∂©Ïôï(Ë°∞Á•ûÊ≤ñÊó∫) - Ïö©Ïã†Ïù¥ ÏôÄÎèÑ Í∏∞Ïã†Ïóê ÏïïÎèÑÎê®! Î≥¥ÏàòÏ†ÅÏúºÎ°ú!' :
                       yearLuck.rating === 'pyunin_doshik' ? '‚ö†Ô∏è Ìé∏Ïù∏ÎèÑÏãù(ÂÅèÂç∞ÂÄíÈ£ü) - Î∞•Í∑∏Î¶á Íπ®Ïßê Ï£ºÏùò! ÏòàÎØºÌï® Í≤ΩÍ≥Ñ!' :
                       yearLuck.rating === 'wang_shin_chung_bal' ? 'üö® ÏôïÏã†Ï∂©Î∞ú(Êó∫Á•ûÊ≤ñÁôº) - Ïû†ÏûêÎäî ÏÇ¨Ïûê ÏΩîÌÑ∏! ÎåÄÍ≤©Î≥Ä/ÏÇ¨Í≥†/ÌååÏû¨ Í∑πÎèÑ Ï£ºÏùò!' :
                       yearLuck.rating === 'great' ? 'EXCELLENT' : 
                       yearLuck.rating === 'good' ? 'FAVORABLE' : 
                       yearLuck.rating === 'volatile' ? '‚ö° VOLATILE - Beneficial but UNSTABLE (gains come with losses)' :
                       yearLuck.rating === 'danger' ? '‚ö†Ô∏è DANGER - VERY CAUTION' :
                       yearLuck.rating === 'bad' ? 'CHALLENGING' : 'NEUTRAL';
    let result = '‚Ä¢ ' + currentYear + ' Annual Rating: ' + ratingText;
    
    // üî• Ïö©Ïã† ÌîºÍ≥µÍ≤© Í≤ΩÍ≥† (ÏµúÏö∞ÏÑ†) - Gemini Round 7
    if (yearLuck.yongUnderAttack) {
        result += '\n‚Ä¢ ' + yearLuck.yongAttackDesc;
    }
    // üî• Íµ∞Í≤ÅÏüÅÏû¨ Í≤ΩÍ≥† - Gemini Round 7
    if (yearLuck.robWealthThreat) {
        result += '\n‚Ä¢ ' + yearLuck.robWealthDesc;
    }
    // üî• ÏÉÅÍ¥ÄÍ≤©+ÎπÑÍ≤ÅÏö¥ Í≤ΩÍ≥† - Gemini Round 7
    if (yearLuck.expressorPeerClash) {
        result += '\n‚Ä¢ ' + yearLuck.expressorPeerDesc;
    }
    // ÏÇºÌï©(Bureau) ÌòïÏÑ± Ïãú Ïö∞ÏÑ† ÌëúÏãú
    if (yearLuck.bureauFormed) {
        result += '\n‚Ä¢ üî• BUREAU FORMED: ' + yearLuck.bureauDesc;
    }
    // Í≥µÎßù ÌÉàÏ∂ú ÌëúÏãú
    if (yearLuck.voidBreak) {
        result += '\n‚Ä¢ üîì VOID BREAK (ËÑ´Á©∫): ' + yearLuck.voidBreakDesc;
    }
    // üî• ÏñëÏù∏Ï∂© Í≤ΩÍ≥† (ÏµúÏö∞ÏÑ†)
    if (yearLuck.yanginClash) {
        result += '\n‚Ä¢ ' + yearLuck.yanginClashDesc;
    }
    // üî• ÏùºÏßÄÏ∂© Í≤ΩÍ≥† (ÏÇºÌï© Ïãú Î¨¥Ïãú)
    if (yearLuck.dayClash && !yearLuck.bureauFormed) {
        result += '\n‚Ä¢ ‚ö†Ô∏è DAY CLASH: ' + yearLuck.dayClashDesc + ' Spouse/Health turbulence.';
    }
    // üî• ÏÇºÏ§ëÏ≤© Í≤ΩÍ≥†
    if (yearLuck.tripleBranch && yearLuck.tripleBranchDesc) {
        result += '\n‚Ä¢ üî•üî• TRIPLE BRANCH: ' + yearLuck.tripleBranchDesc;
    }
    if (yearLuck.climateClash) {
        result += '\n‚Ä¢ ‚ö†Ô∏è CLIMATE CLASH WARNING: ' + yearLuck.climateClashDesc;
    }
    // ÏÇºÌï© ÌòïÏÑ± Ïãú ÏõîÏßÄÏ∂© Í≤ΩÍ≥† Î¨¥Ïãú (ÌÉêÌï©ÎßùÏ∂©)
    if (yearLuck.monthClash && !yearLuck.bureauFormed) {
        result += '\n‚Ä¢ üî• MONTH CLASH WARNING: ' + yearLuck.monthClashDesc;
    }
    // üî• ÌÜµÍ¥Ä Î∂ÄÏû¨ Í≤ΩÍ≥† - Gemini Round 5
    if (yearLuck.missingBridge) {
        result += '\n‚Ä¢ ' + yearLuck.missingBridgeDesc;
    }
    // üî• Ï≤úÍ∞ÑÌï© - Gemini Round 6
    if (yearLuck.stemCombine) {
        result += '\n‚Ä¢ ' + yearLuck.stemCombineDesc;
    }
    // üî• Ïú°Ìï© - Gemini Round 6
    if (yearLuck.branchCombine) {
        result += '\n‚Ä¢ ' + yearLuck.branchCombineDesc;
    }
    // üî• ÏûêÌòï - Gemini Round 6
    if (yearLuck.selfPunishment) {
        result += '\n‚Ä¢ ' + yearLuck.selfPunishmentDesc;
    }
    // üî• ÏÉâÎÇú Í≤ΩÍ≥† - Gemini Round 8
    if (yearLuck.scandalWarning) {
        result += '\n‚Ä¢ ' + yearLuck.scandalWarningDesc;
    }
    // üî• Ïö©Ïã† Î∂ÄÏû¨ Í≤ΩÍ≥† - Gemini Round 8
    if (yearLuck.missingYong) {
        result += '\n‚Ä¢ ' + yearLuck.missingYongDesc;
    }
    // üî• Ïú°Ìï¥ Î∞∞Ïã† Í≤ΩÍ≥† - Gemini Round 8
    if (yearLuck.harmBetrayalWarning) {
        result += '\n‚Ä¢ ' + yearLuck.harmBetrayalDesc;
    }
    // v4.12.6 NEW: Ïá†Ïã†Ï∂©Ïôï/Ìé∏Ïù∏ÎèÑÏãù/ÏôïÏã†Ï∂©Î∞ú
    if (yearLuck.yongOverwhelmed) {
        result += '\n‚Ä¢ ' + yearLuck.yongOverwhelmedDesc;
    }
    if (yearLuck.pyunInDoShik) {
        result += '\n‚Ä¢ ' + yearLuck.pyunInDoShikDesc;
    }
    if (yearLuck.wangShinChungBal) {
        result += '\n‚Ä¢ ' + yearLuck.wangShinChungBalDesc;
    }
    return result;
})()}
${(() => {
    const yp = calcYearPillar(currentYear, 6, 1);
    const yearLuck = calcYearLuck(currentYear, SAJU, GODS);
    
    // ÏÇºÌï©Ïù¥ ÌòïÏÑ±ÎêòÎ©¥ Ï∂© Í≤ΩÍ≥† Î¨¥Ïãú (ÌÉêÌï©ÎßùÏ∂©)
    if (yearLuck.bureauFormed) {
        return '';  // BureauÍ∞Ä Ï∂©ÏùÑ Ìï¥ÏÜåÌï®
    }
    
    const clashMap = [[0,6],[1,7],[2,8],[3,9],[4,10],[5,11]];
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
    const mbBi = BRANCH.findIndex(br => br.c === SAJU.month.b.c);
    const dbBi = BRANCH.findIndex(br => br.c === SAJU.day.b.c);
    const warnings = [];
    clashMap.forEach(([a,b]) => {
        if ((ypBi === a && mbBi === b) || (ypBi === b && mbBi === a)) {
            warnings.push('‚ö†Ô∏è ANNUAL-MONTH CLASH (' + yp.b.c + '‚Üî' + SAJU.month.b.c + '): High volatility year! Career/Health changes possible.');
        }
        if ((ypBi === a && dbBi === b) || (ypBi === b && dbBi === a)) {
            warnings.push('‚ö†Ô∏è ANNUAL-DAY CLASH (' + yp.b.c + '‚Üî' + SAJU.day.b.c + '): Watch spouse relations and personal health!');
        }
    });
    return warnings.length ? '‚Ä¢ ' + warnings.join('\n‚Ä¢ ') : '';
})()}
${(() => {
    // üî• Pillar Echo Ï≤¥ÌÅ¨ - Gemini feedback
    const yp = calcYearPillar(currentYear, 6, 1);
    const ypSi = STEM.indexOf(yp.s);
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
    const fuyin = [];
    
    // üî• ÎåÄÏö¥ Î≥µÏùå (Life Cycle Echo) - Gemini Round 5
    if (curLuck && STEM.indexOf(curLuck.s) === ypSi && BRANCH.findIndex(br => br.c === curLuck.b.c) === ypBi) {
        fuyin.push('üî•üî• LIFE CYCLE ECHO (Â§ßÈÅã‰ºèÂêü): Annual Fortune MATCHES your current decade! Your decade\'s theme is CONCENTRATED into this year. Whatever challenges or opportunities this decade brings - they crystallize NOW. High stakes year. Success or setback will be magnified.');
    }
    
    // ÎÖÑÏ£º Î≥µÏùå
    if (STEM.indexOf(SAJU.year.s) === ypSi && BRANCH.findIndex(br => br.c === SAJU.year.b.c) === ypBi) {
        fuyin.push('üîÑ YEAR PILLAR ECHO (‰ºèÂêü): Grand reset of foundations. Family/ancestry matters highlighted.');
    }
    // ÏõîÏ£º Î≥µÏùå (Í∞ÄÏû• Ï§ëÏöî!)
    if (STEM.indexOf(SAJU.month.s) === ypSi && BRANCH.findIndex(br => br.c === SAJU.month.b.c) === ypBi) {
        fuyin.push('üîÑ MONTH PILLAR ECHO (‰ºèÂêü): Social/Career axis reset! Major job change, relocation, or life direction shift incoming. Do not resist - flow with the reset.');
    }
    // ÏùºÏ£º Î≥µÏùå - Ïã†Í∞ï/Ïã†ÏïΩÏóê Îî∞Îùº Ìï¥ÏÑù Îã§Î¶Ñ
    if (STEM.indexOf(SAJU.day.s) === ypSi && BRANCH.findIndex(br => br.c === SAJU.day.b.c) === ypBi) {
        const str = calcStrength(SAJU);
        if (str.type === 'strong') {
            fuyin.push('‚ö†Ô∏è DAY PILLAR ECHO (‰ºèÂêü): Your strong energy DOUBLES! Risk of overconfidence, ego conflicts, or health strain from excess. Channel power carefully - too much fire burns the house.');
        } else {
            fuyin.push('üîÑ DAY PILLAR ECHO (‰ºèÂêü): Your core identity energy is doubled. For weak charts, this can be empowering - but also exhausting. Rest frequently. Major self-transformation year.');
        }
    }
    // ÏãúÏ£º Î≥µÏùå - üî• Ìé∏Ïû¨Î©¥ ÏÉâÎÇú Í≤ΩÍ≥† (Gemini Round 8)
    if (SAJU.hour && STEM.indexOf(SAJU.hour.s) === ypSi && BRANCH.findIndex(br => br.c === SAJU.hour.b.c) === ypBi) {
        const hourGod = getTenGod(SAJU.hour.s, SAJU.day.s);
        if (hourGod.k === 'ÂÅèË≤°(Indirect Wealth)') {
            fuyin.push('üö® HOUR PILLAR ECHO (‰ºèÂêü) + INDIRECT WEALTH: Secret life axis DOUBLED! High risk of romantic scandal, gambling, or hidden expenses. This is NOT a creative opportunity - it is a TRAP. Stay home at night. Reject temptation.');
        } else if (hourGod.k === 'Ê≠£Ë≤°(Direct Wealth)') {
            fuyin.push('‚ö†Ô∏è HOUR PILLAR ECHO (‰ºèÂêü): Wealth in later years axis reset. Financial restructuring for retirement. Avoid risky investments.');
        } else if (['È£üÁ•û(Eating God)', 'ÂÇ∑ÂÆò(Expressor)'].includes(hourGod.k)) {
            fuyin.push('üîÑ HOUR PILLAR ECHO (‰ºèÂêü): Expression/creativity axis reset. Old projects end, new ones begin. Channel energy into creation, not conflict.');
        } else if (['ÂÅèÂÆò(Challenger)', 'Ê≠£ÂÆò(Direct Officer)'].includes(hourGod.k)) {
            fuyin.push('üîÑ HOUR PILLAR ECHO (‰ºèÂêü): Children/authority axis reset. Changes in children\'s lives or your public role. Patience required.');
        } else {
            fuyin.push('üîÑ HOUR PILLAR ECHO (‰ºèÂêü): Later years axis reset. Significant shift in retirement plans, legacy, or children matters.');
        }
    }
    
    // üî• ÏÇºÏ§ë Î≥µÏùå Ï≤¥ÌÅ¨ (ÎåÄÏö¥+ÏÑ∏Ïö¥+ÏõêÍµ≠ ÎèôÏùº)
    if (curLuck && SAJU.hour) {
        const daeunMatch = STEM.indexOf(curLuck.s) === ypSi && BRANCH.findIndex(br => br.c === curLuck.b.c) === ypBi;
        const hourMatch = STEM.indexOf(SAJU.hour.s) === ypSi && BRANCH.findIndex(br => br.c === SAJU.hour.b.c) === ypBi;
        if (daeunMatch && hourMatch) {
            fuyin.push('üî•üî•üî• TRIPLE ECHO! Life Cycle + Annual + Hour Pillar ALL MATCH (' + yp.s.c + yp.b.c + '). EXTREMELY RARE. Life-altering transformation. Health demands extra attention as energy triples.');
        }
    }
    
    return fuyin.length ? '‚Ä¢ ' + fuyin.join('\n‚Ä¢ ') : '';
})()}

„ÄêNEXT 10 YEARS PREVIEW„Äë
${next10Text}

„Äê${currentYear} MONTHLY FORTUNE„Äë
${monthText}

===== AI INTERPRETATION REQUEST =====

[ROLE DEFINITION]
You are "The Oriental Oracle," a modern interpreter of ancient Asian destiny science (Saju/Four Pillars).
- Tone: Mystical but logical, empathetic, and sophisticated. Like a wise mentor giving life-changing advice.
- Language: English (Global Standard). Use terms like "Beneficial Element" instead of "Beneficial Element".
- Formatting: Use Markdown. Bold key phrases. No long walls of text. Keep each section concise but insightful.

[TASK]
Current Date for Analysis: ${currentYear}-01-15 (Interpret fortune based on this year)
Interpret the provided "Four Pillars of Destiny" chart data into a personalized life guide.

[OUTPUT SECTIONS]

1. üåå **THE CORE SELF (Born Nature)**
   - Interpret the Day Master (${dmName}) and the Day Pillar image
   - Describe their innate personality using metaphors (e.g., "Like a tree in winter...")
   - Highlight the interplay between their dominant Ten Gods

2. ‚öîÔ∏è **CAREER & HIDDEN TALENTS**
   - Based on the Structure (${format.n}), what is their "Superpower"?
   - Suggest 2-3 modern career fields that align with their chart
   - Entrepreneur vs. Organization: Which fits better and why?

3. üí∞ **WEALTH & SUCCESS STRATEGY**
   - Analyze the Wealth Star configuration. Is it "Windfall" or "Steady Builder"?
   - Give one specific financial advice based on their Strong/Weak chart
   - If Hidden Harmony exists, mention hidden income potential

4. ‚ù§Ô∏è **LOVE & RELATIONSHIPS**
   - Interpret the Spouse Palace (Day Branch). What kind of partner fits them?
   - Describe their ideal relationship dynamic
   - Any constructive warnings phrased positively

5. üè• **HEALTH & VITALITY**
   - Identify vulnerable areas based on Five Elements imbalance
   - Practical prevention and lifestyle advice

6. üóìÔ∏è **${currentYear} FORTUNE FORECAST**
   - How does the current Life Cycle interact with this year's energy?
   - Key theme for ${currentYear} in ONE powerful word
   - Top opportunity and main caution for this year

7. üîÆ **THE ORACLE'S VERDICT**
   - One final, powerful sentence summarizing their destiny
   - Lucky action/item suggestion based on their Beneficial Element (${ELEMENT[gods.yong].n})
   - Empowering closing message

[INTERPRETATION GUIDELINES]
1. **Handling Conflicts:** If 'Six Relations' shows "Hidden" spouse/children but 'Divine Stars' shows Golden Carriage or similar blessings, prioritize Divine Stars as "hidden potential." Explain that the blessing exists but requires the right timing (Life Cycle) to manifest.
2. **"Hidden" means "Latent," not "Never":** When spouse/children stars are hidden, interpret as requiring conscious effort or patience until the favorable Life Cycle arrives‚Äînever as permanent absence.
3. **Tone Check:** Avoid fatalistic language. Instead of "You lack children fortune," say "Children blessings may arrive later, or your creative legacy will flourish."
4. **Balance:** Always pair challenges with solutions. If a difficult element appears, immediately suggest its remedy through Beneficial Element or favorable Divine Stars.
5. **Data Sanity Check:** If the provided 'Strength %' seems logically inconsistent with 'Five Elements Distribution' (e.g., many attacking elements but 90%+ strength), PRIORITIZE the visual distribution of elements. Interpret based on the actual balance of the 8 characters, not just the calculated number.
6. **Auto-Validation (Silent Fix):** If the provided 'Structure' label appears inconsistent with actual Ten Gods distribution (e.g., labeled "Direct Officer" but Challenger/Seal dominates), silently recalculate and use the correct structure. Do not mention this correction unless directly asked.

[ADVANCED CHART DYNAMICS - CRITICAL]
1. **The "Bureau" Effect (‰∏âÂêà):**
   - Check if branches form complete "Three Harmony" (e.g., Pig-Rabbit-Goat ‰∫•ÂçØÊú™ = Wood, Tiger-Horse-Dog ÂØÖÂçàÊàå = Fire, Monkey-Rat-Dragon Áî≥Â≠êËæ∞ = Water, Snake-Rooster-Ox Â∑≥ÈÖâ‰∏ë = Metal).
   - **Scenario A (Support):** If Bureau MATCHES Day Master element (e.g., Fire Bureau for Fire DM), treat as "Extremely Strong" regardless of calculated strength. Advice: "You have unstoppable drive and massive potential."
   - **Scenario B (Pressure):** If Bureau CONQUERS Day Master (e.g., Wood Bureau for Earth DM, Fire Bureau for Metal DM), interpret as "Heavy Responsibility / Seven Killings Pressure." Advice: "You feel immense pressure to be perfect. You carry the weight of the world. Mental rest and delegation are crucial. Do not try to control everything alone."
2. **Stem Combinations:** When Day Master combines with another stem (e.g., Áî≤Â∑±Âêà = Earth, ‰πôÂ∫öÂêà = Metal), interpret the psychological bond. Day Master + Officer combination = "inseparable from reputation and honor."
3. **Handling Low Strength (0-20%):** Do NOT interpret as helplessness. Describe as "Extreme Sensitivity and Flexibility." Advise collaboration with strong partners rather than fighting alone. Weak charts often have exceptional intuition.
4. **Charm + Weakness Warning:** If Peach Blossom stars (Ê°ÉËä±) are present with weak Day Master, advise "Set firm boundaries in relationships. Your charm is a gift, but you need a shield to avoid being swayed."
5. **Directional Harmony (ÊñπÂêà):** If three branches from same direction appear (e.g., Tiger-Rabbit-Dragon ÂØÖÂçØËæ∞ = Eastern Wood), this amplifies that element dramatically. Factor this into element balance analysis.
6. **Data Conflict Resolution:** If "Strength %" contradicts "Extreme Weak/Strong" labels, TRUST THE PERCENTAGE. High percentage (80-100%) = Strong chart, Low percentage (0-20%) = Weak chart. Ignore conflicting text labels.
7. **Fire Bureau Special (ÂØÖÂçàÊàå):** When Tiger-Horse-Dog forms Fire Bureau, the chart becomes a "furnace." Any Water element (especially Officer/Career) gets "evaporated." Interpret as: "Career stability vs Personal passion conflict. Subject dislikes being controlled. Advise autonomous careers: Solo professional, Creator, Commander, Performer."
8. **Twin Stems (Double ‰∏ô, Double Áî≤, etc.):** When same stem appears twice, interpret as "spotlight + competition." The subject craves attention but faces rivalry from peers/siblings. Channel this into competitive fields.
9. **Wealth Strategy for Strong Fire:** When Fire is overwhelming, Metal (Wealth) melts instantly. Advise: "Do NOT chase money directly. Build unique Skills/Brand (Earth) first to cool the Fire, then Wealth follows naturally. Going straight for money = burning money."
10. **Health Mapping by Element Imbalance:**
    - Excess Fire ‚Üí Cardiovascular, inflammation, anxiety
    - Weak/Evaporating Water ‚Üí Kidney, hormones, burnout
    - Melting Metal ‚Üí Respiratory, skin, large intestine
    - Excess Wood ‚Üí Liver, anger management, muscles
    - Weak Earth ‚Üí Digestive, worry, spleen
11. **Tiger-Monkey Clash (ÂØÖÁî≥Ê≤ñ) - Physical Warning:**
    - When Tiger and Monkey clash, especially attacking Day Branch (Spouse Palace/Body), warn about: Traffic safety, Spine/Joint health, and Relationship friction.
    - Advice: "Living apart occasionally (business trips, separate hobbies) actually improves marriage by mitigating the clash energy."
12. **Zero Element vs Structure Conflict:**
    - If an element shows "0" but Structure depends on that element (e.g., Water=0 but "Direct Officer Structure"), OVERRIDE the structure interpretation.
    - Zero Water + Officer Structure = "Free Spirit who dislikes control." Do NOT recommend government/corporate jobs. Recommend: Freelance, Entrepreneurship, Sales, or roles with schedule autonomy.
13. **PILLAR ECHO (‰ºèÂêü) Phenomenon:**
    - When Life Cycle pillar MATCHES the Day Pillar exactly (same stem+branch), this is "Pillar Echo" (‰ºèÂêü) = Grand Reset.
    - Interpretation: "Not retirement, but Second Youth. Your core identity energy is DOUBLED. Use this boosted power to conquer past challenges."
14. **Traveling Horse (È©õÈ¶¨) Dominance:**
    - If chart contains multiple movement branches (Tiger ÂØÖ, Monkey Áî≥, Snake Â∑≥, Pig ‰∫•), the subject MUST move to prosper.
    - Advice: "Motion is your Money. Businesses involving travel, logistics, trade, or dynamic interactions suit you. Sitting at a desk blocks fortune."
15. **Multiple Same Branches (Double/Triple):**
    - Double Monkey (Áî≥Áî≥), Double Tiger (ÂØÖÂØÖ), etc. = Amplified attack or support.
    - Two Monkeys attacking one Tiger = "Constant external pressure on your foundation. Build resilience, diversify support systems."
16. **Annual Fortune Clash Analysis:**
    - When the year's energy (Ê≠≤ÈÅã) clashes with natal pillars, specify: Which pillar is hit? Year=Elders, Month=Career, Day=Spouse/Self, Hour=Children/Projects.
    - Fire year hitting Metal month = "Career income fluctuates. High earning potential but also high expenses. Control impulsive investments."
17. **Mother Overload (Excess Wood/Seals):**
    - If chart has 3+ Wood elements for Fire Day Master, warn about "Analysis Paralysis" or "Dependency."
    - Metaphor: "Too much firewood suffocates the flame."
    - Advice: "Stop learning/planning, start DOING. You have enough input; you need output (Earth/Expression). Cut the mental cord from parents/mentors to truly succeed."
18. **Rob Wealth Threat (Áæ§Âä´Áà≠Ë≤°):**
    - If Hour Pillar contains Competitor/Rob Wealth with strong roots (e.g., ‰∏ôÂçà) while Wealth star is isolated or weak.
    - Critical Warning: "Your Wealth is being watched by strong rivals."
    - Advice: "NEVER co-sign loans. Be cautious with partnerships. Do not flash cash. Lock assets in illiquid forms (Real Estate/Bonds) so 'friends' cannot borrow."
19. **Ghost Gate Sensitivity (ÂçØÁî≥/ÂØÖ‰∫• È¨ºÈñÄ):**
    - Rabbit-Monkey or Tiger-Pig interaction = heightened intuition but prone to anxiety.
    - Trait: "Genius intuition but risk of neurosis/overthinking."
    - Career: "Channel hypersensitivity into Precision Art, Design, Strategy, or Psychology. If unused professionally, it becomes mental stress."
20. **Structure Label Override:**
    - If Ten Gods distribution contradicts the Structure label (e.g., "Direct Officer Structure" but strong Competitors/Seals dominate), IGNORE the label.
    - Describe personality based on ACTUAL dominant Ten Gods, not the Structure name. Strong Competitor = "Competitive and Ambitious" regardless of 'Officer' label.
21. **Rat-Rabbit Punishment (Â≠êÂçØÂàë - Rude Punishment):**
    - If Rat (Â≠ê) and Rabbit (ÂçØ) appear together in the chart.
    - Meaning: Conflict between two Peach Blossoms = interpersonal friction, potential scandals.
    - Warning: "Be careful of friction caused by rudeness or ingratitude. Watch for gossip involving opposite sex."
    - Health: "Check reproductive/urinary system health regularly."
22. **Wealth Overload (Ë≤°Â§öË∫´Âº± - Rich but Weak):**
    - If Wealth elements are excessive (3+) but Day Master is Weak (0-30%).
    - Metaphor: "A small boat trying to carry an elephant."
    - Analysis: "Surrounded by opportunities/money, but grabbing it all will sink you (health issues or loss)."
    - Strategy: "Do NOT hold cash yourself. Put assets in spouse's name or lock in Real Estate/long-term investments. Let a strong partner manage finances. Health first, money second."
23. **Expressor vs Officer Clash (ÂÇ∑ÂÆòË¶ãÂÆò):**
    - If Expressor/Hurting Officer (ÂÇ∑ÂÆò) appears 2+ times while Direct Officer (Ê≠£ÂÆò) is present.
    - Meaning: "Rebel meets Authority" = inner conflict between creativity and conformity.
    - Override: Do NOT interpret as "model employee" even if labeled "Officer Structure."
    - Advice: "You are allergic to incompetent authority. Standard corporate hierarchy suffocates you. Seek roles with autonomy: Specialist, Consultant, Creative Director, or Entrepreneur."
24. **Dog-Goat Punishment (ÊàåÊú™Âàë - Bullying Punishment):**
    - If Dog (Êàå) and Goat (Êú™) appear together.
    - Meaning: Two Storages (Â¢ì) clash = internal pressure, self-doubt, or betrayal by trusted ones.
    - Warning: "Be cautious of those closest to you. Sometimes loyalty is tested from within."
    - Health: "Watch for skin issues, digestive problems, or chronic inflammation."
25. **Annual Fortune Clash with Month (Â≠êÂçàÊ≤ñ/ÂçØÈÖâÊ≤ñ):**
    - If Annual Fortune branch clashes with Month Branch (Rat-Horse Â≠êÂçà, Rabbit-Rooster ÂçØÈÖâ, Tiger-Monkey ÂØÖÁî≥, etc.).
    - Meaning: Month = Career/Society/Health core. This clash = "Great Turnover" year.
    - Warning: "High volatility year. Major changes in career, social status, or health possible."
    - Opportunity: "If Beneficial Element, could trigger massive windfall or breakthrough."
    - Health: "Month Branch clash often affects cardiovascular system. Regular checkups essential."
26. **Missing Element Strategy (Critical):**
    - Identify 'Missing Elements' from the data and interpret its psychological/health impact.
    - **Missing Output (No Metal for Earth DM, No Water for Fire DM, etc.):** "Internalizes stress. Needs conscious creative outlet or physical exercise to release pressure. Risk of psychosomatic illness (stomach, nerves)."
    - **Missing Wealth:** "Wealth is not about hoarding but flow. Focus on skills (Output) or Status (Officer), money follows naturally."
    - **Missing Officer:** "Dislikes rigid rules and authority. Needs freedom-based career with autonomy."
    - **Missing Seal (Resource):** "Self-made type. Cannot rely on inheritance or parents. Must study constantly to build own safety net."
27. **Beneficial Element Hierarchy:**
    - If 'Strength %' suggests Follower Chart (0-5%) but 'Beneficial Elements' suggests Regular Chart remedy (e.g., Fire/Seal for weak Earth), **ALWAYS TRUST THE 'BENEFICIAL ELEMENTS' SECTION.**
    - The 'Beneficial God (Áî®Á•û)' is the absolute prescription for this chart, overruling any implied logic from extreme Strength %.
    - Do NOT advise "follow the strong element" if Beneficial Element says otherwise.
28. **Bureau vs Clash Interaction (ÂêàÊ≤ñÁõ∏Êà∞):**
    - When Three Harmony (‰∏âÂêà) and Six Clash (ÂÖ≠Ê≤ñ) exist simultaneously (e.g., ‰∫•ÂçØÊú™ Wood Bureau but ÂçØÈÖâ clash):
    - The clash "attacks" the bureau's core. If Day Branch clashes with Bureau member, interpret as: "Internal conflict between social pressure (Bureau) and personal defense mechanism (Clash)."
    - Meaning: "You feel external pressure (Bureau element) but your sharp skill/tongue (clashing element) breaks it apart."
    - Advice: "Use your critical thinking as a shield, not a sword. The Bureau wants to overwhelm you, but your Day Branch is your secret weapon."
29. **Beneficial Element Re-Validation:**
    - If the chart already has 3+ of the "Beneficial Element" in stems/branches, it may be OVER-SUPPLIED.
    - Example: Water listed as Beneficial but chart has Áô∏Áô∏ + ‰∫• = Water overflow. True need may be FIRE (output/expression) instead.
    - Rule: "If Beneficial Element is already abundant (3+), consider its OUTPUT element as the true remedy."
    - For Wood DM with excess Water: "You don't need more water. You need sunlight (Fire) to bloom."
30. **Triple Same Branch (‰∏âÈáçÂú∞ÊîØ):**
    - If same branch appears 3 times (e.g., Êú™Êú™Êú™, Áî≥Áî≥Áî≥), this is extremely rare.
    - **Personality:** Obsessive focus on one area. Either genius specialist or dangerously narrow.
    - **Canopy Star (ËèØËìã) Triple:** "Destined for spiritual, artistic, or highly specialized technical fields. Normal office jobs will suffocate."
    - **Spouse Palace Duplication:** If Day Branch is duplicated in Month/Hour, warn: "Complex romantic history possible. Late marriage or unconventional partnership may bring stability."
    - **Career Advice:** "Do NOT try to be a generalist. Go deep, not wide. Your obsession becomes your superpower."
31. **Hour Branch Root Override (ÊôÇÊîØÈÄöÊ†π):**
    - If Strength shows 0-10% but Hour Branch contains Day Master's strong root (e.g., ÂØÖ for ‰πô, Âçà for ‰∏Å):
    - Do NOT interpret as "helpless follower."
    - Meaning: "Appears weak but has hidden reserves. Late bloomer with indomitable will in later years (age 50+)."
    - The Hour Pillar represents ages 46+ and final legacy.
    - Advice: "Others underestimate you. Your true power awakens in your later years. The Tiger/Horse in your Hour is your secret weapon."
32. **Climate vs Annual Fortune Clash (Ë™øÂÄôÈÄÜÈÅã):**
    - If chart is "Extreme Dry/Hot" (Fire excess, Water=0) and Annual Fortune brings MORE Fire (‰∏ôÂçà, ‰∏ÅÂ∑≥):
    - **CRITICAL WARNING:** "Fire on Fire = Burning. Health and wealth are under threat."
    - Health: "Cardiovascular, inflammation, dehydration, anger issues. Drink water, avoid spicy food, stay cool."
    - Wealth: "Do NOT make impulsive investments. Fire melts your discipline. Preserve, don't expand."
    - Reverse also applies: If "Extreme Cold" (Water excess, Fire=0) and Annual brings more Water ‚Üí "Drowning risk. Depression, stagnation."
33. **CRITICAL: If '2026 Annual Rating' shows 'DANGER' or 'Climate Clash Warning':**
    - This is the HIGHEST PRIORITY warning. DO NOT interpret the year as favorable regardless of other factors.
    - In Section 6 (2026 FORTUNE FORECAST), explicitly state: "This year demands extreme caution."
    - Health Warning MUST include specific organs: 
      - For Dry/Fire clash ‚Üí Cardiovascular, blood pressure, stroke, kidney depletion.
      - ALSO for Fire excess: Metal (Lung, Large Intestine, Skin) melts under Fire. Warn about respiratory issues, skin troubles, and intestinal inflammation.
      - For Cold/Water clash ‚Üí Depression, hormonal imbalance, reproductive health.
    - Financial Advice MUST be: "Preserve capital. No expansion. No new investments. Pay off debts."
    - Theme Word MUST be cautionary: "PRESERVATION" or "DEFENSE" or "COOLING" - never optimistic words.
35. **PILLAR ECHO (‰ºèÂêü) Year - Pillar Reset Warning:**
    - If data shows "MONTH PILLAR ECHO", this is CRITICAL for career/social interpretation.
    - DO NOT interpret the year as stable. Explicitly warn: "Major life direction change incoming."
    - The reset is not negative - frame as "forced upgrade" or "cosmic reboot."
    - Advice: "Resistance creates suffering. Flow with changes. Pack light - travel may be required."
34. **Rooted Weak Chart Interpretation (ÎøåÎ¶¨ ÍπäÏùÄ Ïã†ÏïΩ):**
    - If "ROOT ANALYSIS" section shows strong roots despite low Strength %, interpret as: "Deceptively weak. The subject appears fragile but possesses iron will and hidden reserves."
    - Metaphor for Wood DM with roots: "A bamboo bending in typhoon - flexible yet unbreakable."
    - Career advice: "You thrive under pressure that would crush others. Choose roles requiring endurance over raw power."
    - Do NOT interpret as helpless or dependent. This type succeeds through strategic patience, not brute force.
36. **VOLATILE Rating Interpretation (Ïö©Ïã†Ïö¥Ïù∏Îç∞ ÏõîÏßÄÏ∂©):**
    - If '2026 Annual Rating' shows 'VOLATILE', this means Beneficial Element arrived BUT clashes with Month Branch.
    - Metaphor: "The sun appeared, but storm clouds block it." Or "Gift with a poisoned ribbon."
    - In Section 6 (2026 FORTUNE FORECAST), state: "Opportunities arrive but come with equal challenges. Gains are not free."
    - Health Warning: "Month clash = Cardiovascular stress. Avoid sudden temperature changes. Regular checkups mandatory."
    - Theme Word: "TURBULENCE" or "TRADE-OFF" - never pure optimism.
    - For elderly subjects (65+): "This is NOT the year for aggressive expansion. Every gain extracts a price. Prioritize health over wealth."
37. **ROOT UNDER ATTACK Interpretation (Íπ®ÏßÑ ÎøåÎ¶¨):**
    - If "ROOT UNDER ATTACK" appears in DAY MASTER STRENGTH section, the Day-Hour clash damages the late-life foundation.
    - Meaning: "The crown exists but the throne is shaking." Outward status may not reflect inner stability.
    - For spouse interpretation: "Spouse relationship is the source of both support AND stress. Living separately periodically may preserve the bond."
    - Health: "Heart/Small Intestine vulnerable. Avoid overwork in later years."
    - Legacy: "Children or projects may require extra attention to succeed. Do not take their success for granted."
38. **Wealth Overload Interpretation (Ïû¨Îã§Ïã†ÏïΩ - Managing the Flood):**
    - If "WEALTH OVERLOAD" appears, do NOT interpret wealth positively. Wealth is a threat, not a blessing.
    - Metaphor: "Drowning in money." The subject cannot hold onto wealth without health consequences.
    - Override: Ignore "Steward/Builder" interpretations. Use "Survivor" or "Manager of the Flood" instead.
    - Strategy: "Delegate. Invest in Real Estate, not liquid assets. Spouse manages finances. Take profits early."
    - Health: "Excess Wealth (Water for Earth DM) directly attacks the body (spleen, digestion, immune system)."
39. **BREAKTHROUGH Rating - Bureau + Beneficial Element (ÌÉêÌï©ÎßùÏ∂© - ÏÇºÌï©Ïù¥ Ï∂©ÏùÑ Ìï¥ÏÜå):**
    - If '2026 Annual Rating' shows 'BREAKTHROUGH', this is the BEST POSSIBLE rating.
    - The Three Harmony Bureau has NEUTRALIZED any clash. Do NOT mention clash warnings.
    - Interpretation: "The stars have aligned. A major life breakthrough is imminent."
    - For Fire Bureau (ÂØÖÂçàÊàå) with Fire Beneficial: "Your frozen potential thaws into explosive bloom. Career, reputation, and passion ignite."
    - For Water Bureau (Áî≥Â≠êËæ∞) with Water Beneficial: "The floodgates open. Wealth, wisdom, and hidden opportunities pour in."
    - Theme Word: "IGNITION" or "BREAKTHROUGH" or "BLOOM" - pure optimism is warranted.
    - Health Note: If Fire Bureau forms, Water (Kidney) depletes. Hydrate, rest kidneys. If Water Bureau forms, Fire (Heart) struggles. Gentle cardio.
40. **VOID BREAK - Liberation Year (ÌÉàÍ≥µ - Í≥µÎßù ÌÉàÏ∂ú):**
    - If 'ËÑ´Á©∫' or 'VOID BREAK' appears, this is a liberation year.
    - Meaning: "The prison of stagnation is shattered. Hidden talents and blocked paths suddenly open."
    - Career: "Projects that were stuck for years suddenly move forward. People who ignored you now pay attention."
    - Advice: "This is your second chance. Do not waste it on hesitation. The void was holding you back - now you're free."
41. **Double Seal Warning (ÂÅèÂç∞ÈÅéÂ§ö - Mother Overload):**
    - If same Seal (Âç∞) appears twice in Stems (e.g., Â£¨Â£¨ or Áô∏Áô∏), interpret as "Too Much Support."
    - Metaphor: "A tree drowning in water cannot flower."
    - Meaning: "Overthinking paralysis. Too much planning, not enough action. Parental shadow is too strong."
    - Advice: "Stop absorbing. Start outputting. Your Beneficial Element (likely Fire/Expression) is the cure."
    - For 2026: If Fire year comes, celebrate: "The sun finally breaks through the clouds."
42. **SURGERY_RISK / HIGH RISK HIGH RETURN Rating (Ê≤ñÁæäÂàÉ - Sheep Blade Clash):**
    - If '2026 Annual Rating' shows 'SURGERY_RISK' or mentions 'Ê≤ñÁæäÂàÉ', this is CRITICAL.
    - Meaning: Annual Fortune branch clashes with Day Master's Sheep Blade (strongest root position).
    - Metaphor: "A warrior's sword is struck - it may shatter OR slice through obstacles."
    - Interpretation: "This year is ALL or NOTHING. Massive wealth breakthrough OR major surgery/accident."
    - Health: "Blood-related events likely. Deflection: Donate blood, get tattoo, dental work, or minor cosmetic procedure to 'pre-pay' the blood debt."
    - Wealth: "If you take risks, they WILL pay off massively - but prepare for physical cost."
    - Theme Word: "GAMBIT" or "HIGH STAKES" - acknowledge both extremes.
43. **VOLATILE_WEALTH Rating (Ïö©Ïã†+ÏùºÏßÄÏ∂©):**
    - If '2026 Annual Rating' shows 'VOLATILE_WEALTH', the Beneficial Element arrived BUT clashes with Spouse Palace (Day Branch).
    - Metaphor: "Fortune knocks but kicks down your front door."
    - Meaning: Wealth opportunities come with relationship/health sacrifices.
    - Health: Spouse Palace clash attacks kidneys (Water DM), heart (Fire DM), or liver (Wood DM).
    - Advice: "Take the money but protect your marriage. Schedule separate vacations. Health checkups mandatory."
    - For females: "Husband's health or career may face turbulence. Support him quietly."
44. **TRIPLE ECHO (Â§ßÈÅã+Ê≠≤ÈÅã+ÏõêÍµ≠ Î≥µÏùå):**
    - If 'TRIPLE ECHO' appears, this is EXTREMELY RARE and POWERFUL.
    - Meaning: Life Cycle + Annual Fortune + one natal pillar ALL share the same stem+branch.
    - Energy: "Your decade's theme is TRIPLED this year. Unavoidable transformation."
    - Warning: "Too much of any energy can burn out. If Fire triples, kidneys fail. If Water triples, heart weakens."
    - Advice: "Ride the wave but rest frequently. This year writes your legacy - make it count."
45. **NO BRIDGE Warning (ÁÑ°ÈÄöÈóú - Missing Mediator):**
    - If 'NO BRIDGE' appears, there's a direct elemental war without a mediator.
    - Example: Water DM with Fire wealth but NO Wood (output) to connect them.
    - Meaning: "You want the result but skip the process. Greed without foundation."
    - Danger: "Health collapses while chasing money. Legal issues from shortcuts."
    - Solution: "Artificially CREATE the missing element through activities: Wood = learning, hobbies, plants; Earth = stability, documentation; Fire = passion, networking."
46. **FEMALE PEER OVERLOAD (Â•≥ÂëΩÊØîÂä´Â§ö):**
    - If 'FEMALE PEER OVERLOAD' appears, the woman has 3+ same-element stems.
    - Meaning: "Strong independence but romantic competition field. Other women may orbit your partner."
    - If Spouse Palace is also clashed: "Marriage requires extra effort. Maintain separate identities."
    - Advice: "Choose a partner who is secure in himself. Do not compete WITH your spouse - compete ALONGSIDE him."
    - Career benefit: "This energy makes you a fierce competitor in business. Channel rivalry professionally."
47. **LIFE CYCLE ECHO (Â§ßÈÅã‰ºèÂêü):**
    - If 'LIFE CYCLE ECHO' appears, Annual Fortune exactly matches the current Life Cycle pillar.
    - Meaning: "Your entire decade's theme is concentrated into THIS year."
    - Interpretation: "Whatever your 10-year mission is, 2026 is the climax. Success or failure crystallizes now."
    - If beneficial: "Accelerated achievement. What takes others 10 years, you accomplish in 1."
    - If challenging: "Concentrated pressure. Every challenge of the decade hits at once. Survive this year, and the rest is easy."
48. **SHEEP BLADE CLASH (Ê≤ñÁæäÂàÉ) - Surgery/Windfall Warning:**
    - If 'SHEEP BLADE CLASH' or 'Ê≤ñÁæäÂàÉ' appears, the Day Branch (self/body) holds a "blade" that is being struck.
    - Meaning: "The blade you carry is provoked. Either you cut others (success) or cut yourself (injury/surgery)."
    - High Risk High Return: "This is NOT a neutral year. Expect either major windfall OR major health event. Rarely in between."
    - Health Prevention: "Proactive blood-letting deflects misfortune: blood donation, dental surgery, tattoo, minor cosmetic procedure. Let the 'blood debt' be paid voluntarily."
    - For females (especially 40s): "Gynecological checkup mandatory. Uterus/ovary issues commonly manifest under this clash."
    - Financial advice: "If money comes, immediately lock it in illiquid assets (real estate). Do not hold cash - it attracts trouble."
49. **VOLATILE WEALTH Rating (ÏùºÏßÄÏ∂© + Ïö©Ïã†Ïö¥):**
    - If '2026 Annual Rating' shows 'VOLATILE WEALTH', this means beneficial element arrived BUT clashes with Day Branch (Spouse Palace/Self).
    - Metaphor: "Gold mine in earthquake zone." Money flows, but foundation shakes.
    - In Section 6 (2026 FORTUNE FORECAST), state: "Wealth comes but at personal cost. Health and relationships pay the price for financial gains."
    - Spouse Warning: "Partner may feel neglected or stressed. Schedule mandatory couple time."
    - Health: "Day Branch = your body. Clash = physical stress. Regular checkups, no overwork."
    - Strategy: "Take profits EARLY. Do not chase more. Know when to stop."
50. **DAY BRANCH OVERWHELMED (1:2 or 1:3 Attack):**
    - When Annual Fortune branch matches Life Cycle branch AND/OR Hour Branch, creating 2 or 3 identical branches attacking Day Branch.
    - If '1:2 attack' or '1:3 attack' appears, this is SEVERE pressure on self/spouse/health.
    - Physical risk: "Your body's foundation is under siege. Surgery, hospitalization, or chronic health issues likely."
    - Relationship: "Spouse Palace under fire. Separation energy is strong - temporary distance (travel, separate hobbies) actually PROTECTS the marriage."
    - For 40+ females with Water Day Master: "Â≠ê under attack by multiple Âçà = reproductive system stress. Hormonal checkup essential."
51. **STEM COMBINE (Â§©Âπ≤Âêà) - Golden Handcuffs:**
    - If 'Â§©Âπ≤Âêà' or 'COMBINE' appears between Annual stem and natal stem.
    - Áî≤Â∑±ÂêàÂúü, ‰πôÂ∫öÂêàÈáë, ‰∏ôËæõÂêàÊ∞¥, ‰∏ÅÂ£¨ÂêàÊú®, ÊàäÁô∏ÂêàÁÅ´.
    - When Beneficial stem combines with Expression (È£üÁ•û/ÂÇ∑ÂÆò): "Promotion comes but freedom decreases. Your talent is recognized but now controlled."
    - Metaphor: "Golden handcuffs - you get paid more but work harder."
    - Advice: "Accept the trade-off. This is how careers advance. Your cage is comfortable."
52. **BRANCH COMBINE (ÂÖ≠Âêà) - Foundation Strengthened:**
    - If 'ÂÖ≠Âêà' or 'BRANCH COMBINE' appears between Annual branch and natal branch.
    - Â≠ê‰∏ëÂêàÂúü, ÂØÖ‰∫•ÂêàÊú®, ÂçØÊàåÂêàÁÅ´, Ëæ∞ÈÖâÂêàÈáë, Â∑≥Áî≥ÂêàÊ∞¥, ÂçàÊú™ÂêàÁÅ´.
    - When combining with Hour Branch: "Late-life foundation solidified. Projects and children blessed."
    - When combining with Day Branch: "Spouse Palace harmonized. Relationship improves."
    - Positive sign: Combine generally neutralizes potential clashes for that year.
53. **SELF-PUNISHMENT (Ëá™Âàë) - Internal Sabotage:**
    - If 'Ëá™Âàë' appears: Ëæ∞Ëæ∞, ÂçàÂçà, ÈÖâÈÖâ, ‰∫•‰∫• = same branch doubled.
    - ‰∫•‰∫• (Pig-Pig): "Doubled Water = depression, overthinking, isolation. Fire year helps dry this melancholy."
    - ÂçàÂçà (Horse-Horse): "Doubled Fire = impulsiveness, burnout, heart stress. Cool down frequently."
    - ÈÖâÈÖâ (Rooster-Rooster): "Doubled Metal = obsessive perfectionism, respiratory issues."
    - Ëæ∞Ëæ∞ (Dragon-Dragon): "Doubled Earth = stubbornness, digestive problems."
    - Advice: "The enemy is within. Self-awareness prevents self-destruction."
54. **CRISIS SOLVER STRUCTURE (È£üÁ•ûÂà∂ÊÆ∫Ê†º):**
    - If Structure shows 'È£üÁ•ûÂà∂ÊÆ∫' or 'Crisis Solver', do NOT interpret as peaceful artist.
    - Meaning: Strong external pressure (Challenger/Seven Killings) is being controlled by your skills (Eating God).
    - Personality: "You are a surgeon, not a chef. Your talent is cutting through chaos, not creating beauty."
    - Career: "Medicine, Law, Engineering, Consulting, Crisis Management, Auditing - jobs where problems need solving."
    - Psychology: "You feel calm when others panic. Pressure is your natural habitat."
    - Warning: "Without crisis to solve, you may create drama. Find healthy outlets for your warrior energy."
55. **ROOTED WEAK CHART (ÊôÇÊîØÈÄöÊ†π) - Hidden Reserves:**
    - If Strength shows 0-20% BUT Hour Branch contains Day Master's root.
    - Do NOT interpret as helpless follower.
    - Meaning: "Appears weak but has hidden reserves. Late bloomer with indomitable will."
    - The Hour Pillar = ages 46+ and final legacy.
    - Advice: "Others underestimate you. Your true power awakens in later years."
    - Psychology: "Stubborn despite soft appearance. The bamboo bends but never breaks."
56. **BENEFICIAL ELEMENT UNDER ATTACK (Ïö©Ïã†ÌîºÍ≥µÍ≤© - Friend vs Foe):**
    - CRITICAL: If Annual element CONQUERS Beneficial Element (e.g., Fire year + Metal Beneficial = Fire melts Metal).
    - Five Elements conquest: Êú®ÂÖãÂúü, ÂúüÂÖãÊ∞¥, Ê∞¥ÂÖãÁÅ´, ÁÅ´ÂÖãÈáë, ÈáëÂÖãÊú®
    - Rating: DANGER - regardless of other positive factors.
    - Metaphor: "Your best ally is being assassinated by this year's energy."
    - Advice: "Do NOT expand. Do NOT invest. Do NOT trust new partnerships. This year is for PRESERVATION only."
    - Financial: "Assets you chase will evaporate. Lock wealth in real estate. Avoid liquid investments."
57. **WEALTH ROBBERY YEAR (Áæ§Âä´Áà≠Ë≤° - Strong Chart + Peer Year):**
    - If chart is STRONG (80%+) AND Annual Fortune is Peer (ÊØîËÇ©) or Competitor (Âä´Ë≤°).
    - Meaning: "Bandits are circling your treasury. Your own friends/siblings become rivals."
    - Warning: "Never co-sign loans. Never start partnerships. Keep wealth hidden."
    - Business: "Employees may betray. Partners may steal. Solo operation is safest."
    - Health: "Stress from competition leads to cardiovascular strain."
58. **EXPRESSOR STRUCTURE + PEER YEAR (ÏÉÅÍ¥ÄÍ≤© + ÎπÑÍ≤ÅÏö¥):**
    - If Structure is Expressor/Hurting Officer AND Annual is Peer/Competitor.
    - Meaning: "A rebel (Expressor) gains bad-influence friends (Peers). Together they attack authority."
    - Warning: "HIGH RISK of lawsuit, public conflict with superiors, or career self-destruction."
    - Psychology: "Your talent makes you arrogant. Your friends encourage recklessness."
    - Advice: "Channel ALL energy into CREATION (art, writing, building). Zero energy for POLITICS (office drama, arguments)."
59. **SCANDAL ALERT - Male + Hour Indirect Wealth Echo (ÎÇ®Î™Ö ÏãúÏ£º Ìé∏Ïû¨ Î≥µÏùå):**
    - If Male chart has Hour Pillar = Indirect Wealth AND Annual Fortune matches Hour Pillar.
    - Meaning: "The door to secret life opens. New women/entertainment temptations arrive."
    - CRITICAL WARNING: "This is NOT romance, it's a TRAP. Scandal destroys family and career."
    - If Self-Punishment (ÂçàÂçà) added: "DOUBLE DANGER. Gambling addiction or affair leads to ruin."
    - Advice: "Stay home at night. Reject temptation. Every 'opportunity' is poisoned bait."
60. **NO SHIELD - Missing Beneficial Element (Ïö©Ïã† Î∂ÄÏû¨):**
    - If Beneficial Element is completely ABSENT from natal chart (zero in all 8 characters).
    - Meaning: "No natural defense when crisis hits. Like a soldier without armor."
    - Psychology: "Cannot self-regulate desires. Excess becomes addiction."
    - If yong_attacked: "DOUBLE DANGER - attacked element doesn't even exist to defend."
    - Remedy: "Artificially CREATE beneficial element through: Metal = discipline, weights, strict schedule; Water = meditation, swimming; Fire = passion projects, socializing; Wood = learning, plants, nature; Earth = stability, documentation, grounding."
61. **HARM BETRAYAL (ÂÖ≠ÂÆ≥ - Î∞∞Ïã† Í≤ΩÍ≥†):**
    - Six Harm pairs: Â≠êÊú™, ‰∏ëÂçà, ÂØÖÂ∑≥, ÂçØËæ∞, Áî≥‰∫•, ÈÖâÊàå.
    - If Month Branch and Day Branch form Harm: "Closest people damage your foundation."
    - ÂçØËæ∞ÂÆ≥ Special: "Your WORDS (Rabbit/Expressor) destroy your FOUNDATION (Dragon/Storage). Verbal mistakes or a colleague's betrayal."
    - Advice: "Never co-sign loans. No joint investments. Trust actions, not words."
    - Health: For ÂçØËæ∞ÂÆ≥: "Liver (Wood) attacks Spleen (Earth). Digestive issues from stress."
62. **WATER EVAPORATION - Fire Year on Weak Water DM (ÏàòÏ¶ùÎ∞ú Í≤ΩÍ≥†):**
    - If Day Master is Water (Â£¨/Áô∏) with low strength (0-30%) AND Annual Fortune is pure Fire (‰∏ôÂçà, ‰∏ÅÂ∑≥).
    - Metaphor: "Last drop of water boiling away in a furnace."
    - Health WARNING: "Kidney depletion, bladder inflammation, hormonal collapse, panic attacks."
    - Psychology: "Mental hysteria. Cannot cope with pressure."
    - Advice: "Drink water constantly. Avoid saunas, hot places, spicy food. Mental health support essential."
63. **BRANCH COMBINE TO UNFAVORABLE ELEMENT (Ïú°Ìï©Ïù¥ Í∏∞Ïã†ÏúºÎ°ú Î≥ÄÌôî):**
    - If Annual Branch combines with natal branch AND result element is Unfavorable God (ÂøåÁ•û).
    - Example: Âçà+Êú™‚ÜíFire for Weak Water DM. Fire is enemy, not friend.
    - Interpretation: "The alliance strengthens your enemy. What looks like harmony is actually betrayal."
    - For Hour Branch combine: "Late-life/children axis transforms into pressure zone. Reproductive/kidney health warning."
    - DO NOT interpret positively just because "combine" occurred.
64. **WEAK CHART + WEALTH STRUCTURE = ANXIOUS CHASER:**
    - If Strength < 20% AND Structure is Wealth-based (Direct/Indirect Wealth).
    - Override: Do NOT use terms like "Steady Builder" or "Patient Accumulator."
    - Reality: "Wealth overwhelms the weak Day Master. Subject chases money to exhaustion."
    - Health: "Stress-induced illness. Digestive problems. Anxiety disorders."
    - Strategy: "Let spouse or partner manage finances. Focus on health FIRST, money SECOND."
65. **FAKE FOLLOWER CHART (Í∞ÄÏ¢ÖÍ≤© Í≤ΩÍ≥†):**
    - If Strength = 0-5% AND no root in any branch AND dominant element has 4+ appearances.
    - Possibility: This may be a "Follower Chart" (Ï¢ÖÍ≤©) where subject should FOLLOW the dominant element.
    - Paradox: If true Follower, then Fire year (2026) is GOOD because it strengthens the King.
    - If fake Follower: Fire year is DEADLY because weak Water evaporates.
    - Advice: "Extreme volatility. If you fully surrender to the trend, you win. If you resist, you break."
    - Safe interpretation: "Do NOT make major decisions this year. Observe which way the wind truly blows."
66. **LIFE CYCLE DIRECTION VERIFICATION (ÎåÄÏö¥ ÏàúÏó≠ ÌôïÏù∏):**
    - Life Cycle direction rule: Yang Year Male = Forward, Yang Year Female = Reverse, Yin Year Male = Reverse, Yin Year Female = Forward.
    - Yang Year = Year Stem is Áî≤‰∏ôÊàäÂ∫öÂ£¨ (Yang stems).
    - If data shows Life Cycle that doesn't match this rule, flag as potential calculation error.
    - CRITICAL: Wrong Life Cycle direction = Wrong decade = Wrong life advice. Verify before interpreting.
67. **DAY PILLAR WHITE TIGER (ÏùºÏ£º Î∞±Ìò∏ÎåÄÏÇ¥):**
    - Day Pillars: Áî≤Ëæ∞, ‰πôÂ∑≥, ‰∏ôÊàå, ‰∏Å‰∏ë, ÊàäËæ∞, Â∑±Â∑≥, Â∫öÊàå, Ëæõ‰∏ë, Â£¨Ëæ∞, Áô∏Â∑≥.
    - If 'Day Pillar White Tiger' appears in Divine Stars, this is SIGNIFICANT.
    - Personality: "Gentle and calm normally, but explosive when angered. Like a sleeping tiger."
    - Warning: "Blood-related events possible for self, spouse, or children (surgery, accident, difficult childbirth)."
    - Remedy: "Working in medical, religious, military, or healing professions TRANSFORMS this energy into blessing."
    - For women: "Childbirth may be difficult. Caesarean section possible. Monitor pregnancy closely."
68. **STEM COMBINE BETRAYAL (Ï≤úÍ∞ÑÌï© Î∞∞Ïã† - Helper turns Foe):**
    - If Annual Stem combines with Monthly Stem to create an UNFAVORABLE element.
    - Example: ‰∏ô(Fire helper for weak Fire DM) + Ëæõ(Wealth) ‚Üí Ê∞¥(Water/Pressure). Helper becomes attacker.
    - Metaphor: "A friend enters your house, falls in love with your money, and becomes your creditor."
    - Warning: "Do NOT trust friends' investment advice. Business partners may betray. The helper is not what they seem."
    - Advice: "Rely on branch roots (Âú∞ÊîØ), not stem alliances (Â§©Âπ≤). Act alone."
69. **GRAVE DAY PILLAR (ÏûÖÎ¨òÏùºÏ£º - Self-Grave):**
    - When Day Branch = Storage/Grave (Â¢ì) stage for Day Master.
    - Example: ‰∏ôÊàå (Fire DM in Fire's Grave), Â£¨Ëæ∞ (Water DM in Water's Grave).
    - Personality: "NOT active starter. Instead: philosophical, introspective, hoarding tendency."
    - Override: Do NOT interpret as "energetic" or "new beginnings" even if other factors seem positive.
    - Wealth: "Collects but rarely spends. May appear stingy. Assets hidden or locked away."
    - Spouse: "Day Branch = Spouse Palace. Grave energy means 'controlled spouse' or 'late marriage'."
    - Psychology: "Outwardly bright (especially ‰∏ôÊàå Sun), but inner melancholy exists. Religious/spiritual inclination."
70. **TWELVE STAGES OVERRIDE (12Ïö¥ÏÑ± Ïû¨Í≤ÄÏ¶ù):**
    - If Day Branch shows "Birth(Èï∑Áîü)" but Day Master actually sits in Grave position, data is WRONG.
    - Quick check for Fire DM: ÂØÖ=Birth, Âçà=Peak, Êàå=Grave. If Êàå shows "Birth", calculation error.
    - Quick check for Water DM: Áî≥=Birth, Â≠ê=Peak, Ëæ∞=Grave. If Ëæ∞ shows "Birth", calculation error.
    - ALWAYS verify 12 Stages against classical tables before interpreting.
`;

        navigator.clipboard.writeText(text).then(() => {
            toast('üìã Copied! Paste into Gemini or ChatGPT');
        }).catch(() => {
            // Fallback: textarea
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            toast('üìã Copied to clipboard!');
        });
    } catch(err) {
        console.error('Copy error:', err);
        toast('Error copying to clipboard');
    }
}

/* ========================================
   POWERBALL & MEGA MILLIONS
   ======================================== */
let pbHistory = [];
let megaHistory = [];

// Five ElementsÎ≥Ñ Îü≠ÌÇ§ ÎÑòÎ≤Ñ (ÎÅùÏûêÎ¶¨ Í∏∞Ï§Ä)
const ELEMENT_LUCKY_ENDINGS = {
    water: [1, 6],  // Ê∞¥
    fire: [2, 7],   // ÁÅ´
    wood: [3, 8],   // Êú®
    metal: [4, 9],  // Èáë
    earth: [5, 0]   // Âúü
};

// Generate numbers for specific element (1~max Î≤îÏúÑ)
function getElementNumbers(element, max) {
    const endings = ELEMENT_LUCKY_ENDINGS[element] || [1, 6];
    const nums = [];
    for(let i = 1; i <= max; i++) {
        const lastDigit = i % 10;
        if(endings.includes(lastDigit)) {
            nums.push(i);
        }
    }
    return nums;
}

// Extract Yongsin element from Saju
function getYongsinElement(saju) {
    const dmi = STEM.indexOf(saju.day.s);  // Day Master index
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);  // Month branch index
    
    // JOHU_TABLEÏóêÏÑú Ïö©Ïã† Ï∞æÍ∏∞
    if(JOHU_TABLE[dmi] && JOHU_TABLE[dmi][mbi]) {
        return JOHU_TABLE[dmi][mbi].yong;
    }
    
    // Default: Day Master generating element
    const dayElement = saju.day.s.e;
    const supportMap = {water:'wood', wood:'fire', fire:'earth', earth:'metal', metal:'water'};
    return supportMap[dayElement] || 'fire';
}

function generatePowerball(type) {
    // Premium check for destiny-based numbers
    if (type === 'destiny' && !isPremium) {
        toast('üëë Destiny Numbers require Premium. Please offer Á¶èÂÇµ.');
        openPremiumCheckout();
        return;
    }
    
    const y = +document.getElementById('pb-year').value;
    const m = +document.getElementById('pb-month').value;
    const d = +document.getElementById('pb-day').value;
    
    let numbers = [];
    let powerball;
    
    if(type === 'destiny' && y && m && d) {
        // Saju-based number generation
        const saju = {
            year: calcYearPillar(y, m, d),
            month: calcMonthPillar(y, m, d),
            day: calcDayPillar(y, m, d)
        };
        
        // Extract Yongsin element
        const yongsin = getYongsinElement(saju);
        const luckyNums = getElementNumbers(yongsin, 69);
        
        // Generate hash seed (including Saju info)
        const dayElement = saju.day.s.e;
        const seed = `${y}-${m}-${d}-${dayElement}-${yongsin}-PB-${Date.now()}`;
        let hash = 0;
        for(let i = 0; i < seed.length; i++) {
            hash = ((hash << 5) - hash) + seed.charCodeAt(i);
            hash = hash & hash;
        }
        
        const used = new Set();
        
        // 1) Include 2 Yongsin element numbers
        for(let i = 0; i < 2 && luckyNums.length > 0; i++) {
            hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
            const idx = hash % luckyNums.length;
            const n = luckyNums[idx];
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        
        // 2) Remaining numbers hash-based
        while(numbers.length < 5) {
            hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
            const n = (hash % 69) + 1;
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        numbers.sort((a,b) => a-b);
        
        // Powerball (1-26) - Ïö©Ïã† Ïò§Ìñâ Î∞òÏòÅ
        const luckyPB = getElementNumbers(yongsin, 26);
        hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
        if(luckyPB.length > 0 && hash % 3 !== 0) {  // 66% chance for Yongsin number
            powerball = luckyPB[hash % luckyPB.length];
        } else {
            powerball = (hash % 26) + 1;
        }
        
        toast(`üîÆ Destiny numbers generated! (${yongsin.toUpperCase()} energy)`);
    } else {
        // Quick Pick
        const used = new Set();
        while(numbers.length < 5) {
            const n = Math.floor(Math.random() * 69) + 1;
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        numbers.sort((a,b) => a-b);
        powerball = Math.floor(Math.random() * 26) + 1;
        
        toast('üé≤ Quick Pick generated!');
    }
    
    // Display
    const container = document.getElementById('pb-balls');
    container.innerHTML = '';
    
    numbers.forEach((n, i) => {
        setTimeout(() => {
            const ball = document.createElement('div');
            ball.className = 'ball';
            ball.textContent = n;
            ball.style.animationDelay = `${i * 0.1}s`;
            container.appendChild(ball);
        }, i * 200);
    });
    
    setTimeout(() => {
        const pb = document.createElement('div');
        pb.className = 'ball powerball';
        pb.textContent = powerball;
        container.appendChild(pb);
    }, 1200);
    
    document.getElementById('pb-result').style.display = 'block';
    
    // Save to history
    pbHistory.unshift({ type: type === 'destiny' ? 'DESTINY' : 'QUICK', numbers, powerball });
    if(pbHistory.length > 5) pbHistory.pop();
    renderPbHistory();
}

function renderPbHistory() {
    if(pbHistory.length === 0) return;
    document.getElementById('pb-history').style.display = 'block';
    document.getElementById('pb-history-list').innerHTML = pbHistory.map(h => `
        <div class="history-item">
            <span class="history-type">${h.type}</span>
            <div class="history-balls">
                ${h.numbers.map(n => `<div class="ball" style="animation:none;opacity:1;">${n}</div>`).join('')}
                <div class="ball powerball" style="animation:none;opacity:1;">${h.powerball}</div>
            </div>
        </div>
    `).join('');
}

function generateMega(type) {
    // Premium check for destiny-based numbers
    if (type === 'destiny' && !isPremium) {
        toast('üëë Destiny Numbers require Premium. Please offer Á¶èÂÇµ.');
        openPremiumCheckout();
        return;
    }
    
    const y = +document.getElementById('mega-year').value;
    const m = +document.getElementById('mega-month').value;
    const d = +document.getElementById('mega-day').value;
    
    let numbers = [];
    let megaball;
    
    if(type === 'destiny' && y && m && d) {
        // Saju-based number generation
        const saju = {
            year: calcYearPillar(y, m, d),
            month: calcMonthPillar(y, m, d),
            day: calcDayPillar(y, m, d)
        };
        
        // Extract Yongsin element
        const yongsin = getYongsinElement(saju);
        const luckyNums = getElementNumbers(yongsin, 70);
        
        // Generate hash seed (including Saju info)
        const dayElement = saju.day.s.e;
        const seed = `${y}-${m}-${d}-${dayElement}-${yongsin}-MEGA-${Date.now()}`;
        let hash = 0;
        for(let i = 0; i < seed.length; i++) {
            hash = ((hash << 5) - hash) + seed.charCodeAt(i);
            hash = hash & hash;
        }
        
        const used = new Set();
        
        // 1) Include 2 Yongsin element numbers
        for(let i = 0; i < 2 && luckyNums.length > 0; i++) {
            hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
            const idx = hash % luckyNums.length;
            const n = luckyNums[idx];
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        
        // 2) Remaining numbers hash-based
        while(numbers.length < 5) {
            hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
            const n = (hash % 70) + 1;
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        numbers.sort((a,b) => a-b);
        
        // Megaball (1-25) - Ïö©Ïã† Ïò§Ìñâ Î∞òÏòÅ
        const luckyMB = getElementNumbers(yongsin, 25);
        hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
        if(luckyMB.length > 0 && hash % 3 !== 0) {  // 66% chance for Yongsin number
            megaball = luckyMB[hash % luckyMB.length];
        } else {
            megaball = (hash % 25) + 1;
        }
        
        toast(`üîÆ Destiny numbers generated! (${yongsin.toUpperCase()} energy)`);
    } else {
        const used = new Set();
        while(numbers.length < 5) {
            const n = Math.floor(Math.random() * 70) + 1;
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        numbers.sort((a,b) => a-b);
        megaball = Math.floor(Math.random() * 25) + 1;
        
        toast('üé≤ Quick Pick generated!');
    }
    
    const container = document.getElementById('mega-balls');
    container.innerHTML = '';
    
    numbers.forEach((n, i) => {
        setTimeout(() => {
            const ball = document.createElement('div');
            ball.className = 'ball mega';
            ball.textContent = n;
            ball.style.animationDelay = `${i * 0.1}s`;
            container.appendChild(ball);
        }, i * 200);
    });
    
    setTimeout(() => {
        const mb = document.createElement('div');
        mb.className = 'ball megaball';
        mb.textContent = megaball;
        container.appendChild(mb);
    }, 1200);
    
    document.getElementById('mega-result').style.display = 'block';
    
    megaHistory.unshift({ type: type === 'destiny' ? 'DESTINY' : 'QUICK', numbers, megaball });
    if(megaHistory.length > 5) megaHistory.pop();
    renderMegaHistory();
}

function renderMegaHistory() {
    if(megaHistory.length === 0) return;
    document.getElementById('mega-history').style.display = 'block';
    document.getElementById('mega-history-list').innerHTML = megaHistory.map(h => `
        <div class="history-item">
            <span class="history-type">${h.type}</span>
            <div class="history-balls">
                ${h.numbers.map(n => `<div class="ball mega" style="animation:none;opacity:1;">${n}</div>`).join('')}
                <div class="ball megaball" style="animation:none;opacity:1;">${h.megaball}</div>
            </div>
        </div>
    `).join('');
}

/* ========================================
   TAB SWITCHING
   ======================================== */
function switchGame(game) {
    // Deactivate all tabs
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.game-btn').forEach(b => b.classList.remove('active'));
    
    // Activate selected tab
    document.getElementById(`tab-${game}`).classList.add('active');
    event.target.closest('.game-btn').classList.add('active');
    
    // Change theme
    document.body.className = game + '-mode';
}

/* ========================================
   INITIALIZATION
   ======================================== */
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Saju selects
    const sajuYear = document.getElementById('saju-year');
    const sajuMonth = document.getElementById('saju-month');
    const sajuDay = document.getElementById('saju-day');
    const sajuHour = document.getElementById('saju-hour');
    
    for(let y = 2025; y >= 1940; y--) {
        const opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        if(y === 1990) opt.selected = true;
        sajuYear.appendChild(opt);
    }
    for(let m = 1; m <= 12; m++) {
        const opt = document.createElement('option');
        opt.value = m; opt.textContent = MONTH_ABBR[m - 1];
        sajuMonth.appendChild(opt);
    }
    for(let d = 1; d <= 31; d++) {
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = d;
        sajuDay.appendChild(opt);
    }
    
    const hourOpts = ['Unknown','Â≠ê(23-01)','‰∏ë(01-03)','ÂØÖ(03-05)','ÂçØ(05-07)','Ëæ∞(07-09)','Â∑≥(09-11)','Âçà(11-13)','Êú™(13-15)','Áî≥(15-17)','ÈÖâ(17-19)','Êàå(19-21)','‰∫•(21-23)'];
    hourOpts.forEach((h,i) => {
        const opt = document.createElement('option');
        opt.value = i === 0 ? '' : (i-1);
        opt.textContent = h;
        sajuHour.appendChild(opt);
    });
    
    // Powerball ÏÖÄÎ†âÌä∏ Ï¥àÍ∏∞Ìôî
    ['pb', 'mega'].forEach(prefix => {
        const yearSel = document.getElementById(`${prefix}-year`);
        const monthSel = document.getElementById(`${prefix}-month`);
        const daySel = document.getElementById(`${prefix}-day`);
        
        for(let y = 2010; y >= 1940; y--) {
            const opt = document.createElement('option');
            opt.value = y; opt.textContent = y;
            if(y === 1990) opt.selected = true;
            yearSel.appendChild(opt);
        }
        for(let m = 1; m <= 12; m++) {
            const opt = document.createElement('option');
            opt.value = m; opt.textContent = MONTH_ABBR[m - 1];
            monthSel.appendChild(opt);
        }
        for(let d = 1; d <= 31; d++) {
            const opt = document.createElement('option');
            opt.value = d; opt.textContent = d;
            daySel.appendChild(opt);
        }
    });
});

/* ========================================
   LEGAL PAGE NAVIGATION
   ======================================== */
function showLegalPage(page) {
    document.querySelectorAll('.legal-page').forEach(p => p.style.display = 'none');
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    document.getElementById('legal-' + page).style.display = 'block';
    window.scrollTo(0, 0);
    // Update URL hash without triggering reload
    history.pushState(null, null, '#' + page);
}

function closeLegalPage() {
    document.querySelectorAll('.legal-page').forEach(p => p.style.display = 'none');
    document.querySelector('.tab-content.active').style.display = 'block';
    // Clear hash
    history.pushState(null, null, window.location.pathname);
}

// Handle URL hash on page load and hash change (for Paddle verification)
function handleUrlHash() {
    const hash = window.location.hash.replace('#', '');
    if (hash === 'terms' || hash === 'privacy' || hash === 'refund') {
        showLegalPage(hash);
    }
}

// Check hash on page load
window.addEventListener('load', handleUrlHash);
// Check hash on hash change
window.addEventListener('hashchange', handleUrlHash);

</script>

<!-- ========================================
     LEGAL PAGES
     ======================================== -->

<!-- TERMS OF SERVICE -->
<div id="legal-terms" class="legal-page" style="display:none;">
    <div class="legal-container">
        <button class="legal-close" onclick="closeLegalPage()">‚úï Close</button>
        <h1>üìú Terms of Service</h1>
        <p class="legal-updated">Last Updated: January 2025</p>
        
        <h2>1. ACCEPTANCE OF TERMS</h2>
        <p>By accessing K-MUDANG ("Service"), you agree to these Terms of Service.</p>
        
        <h2>2. SERVICE DESCRIPTION</h2>
        <p>K-MUDANG provides:</p>
        <ul>
            <li>Four Pillars of Destiny (Saju) analysis</li>
            <li>AI-powered fortune interpretation</li>
            <li>Lottery number generation based on metaphysical algorithms</li>
        </ul>
        
        <h2>3. ENTERTAINMENT PURPOSE</h2>
        <p>This Service is for <strong>ENTERTAINMENT PURPOSES ONLY</strong>.</p>
        <ul>
            <li>We do NOT guarantee lottery winnings</li>
            <li>We do NOT predict actual future events</li>
            <li>Saju analysis is based on traditional Korean metaphysics, not science</li>
        </ul>
        
        <h2>4. PAYMENT & REFUNDS</h2>
        <ul>
            <li>Premium access is granted for 24 hours after payment</li>
            <li>All sales are final. No refunds (see Refund Policy for exceptions)</li>
            <li>Payment processed securely via Paddle</li>
        </ul>
        
        <h2>5. USER RESPONSIBILITIES</h2>
        <ul>
            <li>You must be 18+ to use this Service</li>
            <li>You are responsible for your gambling decisions</li>
            <li>Do not spend more than you can afford to lose</li>
        </ul>
        
        <h2>6. INTELLECTUAL PROPERTY</h2>
        <ul>
            <li>All content, algorithms, and AI prompts are owned by K-MUDANG</li>
            <li>Unauthorized copying or redistribution is prohibited</li>
        </ul>
        
        <h2>7. LIMITATION OF LIABILITY</h2>
        <p>K-MUDANG is not liable for:</p>
        <ul>
            <li>Financial losses from lottery play</li>
            <li>Decisions made based on Saju readings</li>
            <li>Any damages arising from use of this Service</li>
        </ul>
        
        <h2>8. GOVERNING LAW</h2>
        <p>These Terms are governed by the laws of the Republic of Korea.</p>
        
        <h2>9. CONTACT</h2>
        <p>For questions: <a href="/cdn-cgi/l/email-protection#513a3c2435303f367f3e3737383238303d11363c30383d7f323e3c"><span class="__cf_email__" data-cfemail="452e283021242b226b2a23232c262c2429052228242c296b262a28">[email&#160;protected]</span></a></p>
    </div>
</div>

<!-- PRIVACY POLICY -->
<div id="legal-privacy" class="legal-page" style="display:none;">
    <div class="legal-container">
        <button class="legal-close" onclick="closeLegalPage()">‚úï Close</button>
        <h1>üîí Privacy Policy</h1>
        <p class="legal-updated">Last Updated: January 2025</p>
        
        <h2>1. INFORMATION WE COLLECT</h2>
        
        <h3>a) Account Information:</h3>
        <ul>
            <li>Email address (via Google Sign-In)</li>
            <li>Name (from Google profile)</li>
        </ul>
        
        <h3>b) Birth Information (User Provided):</h3>
        <ul>
            <li>Birth date, time, and gender</li>
            <li>Used solely for Saju calculation</li>
        </ul>
        
        <h3>c) Payment Information:</h3>
        <ul>
            <li>Processed by Paddle</li>
            <li>We do NOT store credit card numbers</li>
        </ul>
        
        <h2>2. HOW WE USE YOUR INFORMATION</h2>
        <ul>
            <li>To provide Saju analysis</li>
            <li>To process payments</li>
            <li>To improve our Service</li>
            <li>To send service-related notifications</li>
        </ul>
        
        <h2>3. DATA STORAGE</h2>
        <ul>
            <li>Stored securely in Google Firebase (Seoul, Korea)</li>
            <li>Birth data is encrypted</li>
            <li>Retained until account deletion</li>
        </ul>
        
        <h2>4. DATA SHARING</h2>
        <p>We do NOT sell your data. We share data only with:</p>
        <ul>
            <li>Google (Authentication)</li>
            <li>Paddle (Payment processing)</li>
            <li>Analytics providers</li>
        </ul>
        
        <h2>5. YOUR RIGHTS</h2>
        <p>You may:</p>
        <ul>
            <li>Access your data</li>
            <li>Delete your account</li>
            <li>Request data export</li>
        </ul>
        
        <h2>6. COOKIES</h2>
        <p>We use essential cookies for:</p>
        <ul>
            <li>Authentication</li>
            <li>Session management</li>
        </ul>
        
        <h2>7. CHILDREN'S PRIVACY</h2>
        <p>This Service is not for users under 18.</p>
        
        <h2>8. CHANGES TO POLICY</h2>
        <p>We may update this Policy. Continued use means acceptance.</p>
        
        <h2>9. CONTACT</h2>
        <p>Privacy questions: <a href="/cdn-cgi/l/email-protection#0962647c6d68676e27666f6f606a606865496e64686065276a6664"><span class="__cf_email__" data-cfemail="4e25233b2a2f202960212828272d272f220e29232f2722602d2123">[email&#160;protected]</span></a></p>
    </div>
</div>

<!-- REFUND POLICY -->
<div id="legal-refund" class="legal-page" style="display:none;">
    <div class="legal-container">
        <button class="legal-close" onclick="closeLegalPage()">‚úï Close</button>
        <h1>üí∞ Refund Policy</h1>
        <p class="legal-updated">Last Updated: January 2025</p>
        
        <h2>1. DIGITAL PRODUCTS - NO REFUNDS</h2>
        <p>K-MUDANG provides digital fortune-telling services and AI-generated content.</p>
        <p>Due to the nature of digital products, <strong>ALL SALES ARE FINAL</strong>.</p>
        <p>Once you receive your Saju analysis or lottery numbers, the service has been fully delivered and cannot be "returned."</p>
        
        <h2>2. EXCEPTIONS</h2>
        <p>We may offer refunds ONLY in these cases:</p>
        <ul>
            <li>Technical error prevented access to paid content</li>
            <li>Duplicate charge (charged twice for same purchase)</li>
            <li>Service was completely unavailable for 24+ hours</li>
        </ul>
        
        <h2>3. HOW TO REQUEST</h2>
        <p>If you believe you qualify for an exception:</p>
        <ul>
            <li>Email: <a href="/cdn-cgi/l/email-protection#c9a2a4bcada8a7aee7a6afafa0aaa0a8a589aea4a8a0a5e7aaa6a4"><span class="__cf_email__" data-cfemail="1f74726a7b7e717831707979767c767e735f78727e7673317c7072">[email&#160;protected]</span></a></li>
            <li>Include: Your email, purchase date, reason</li>
            <li>Response time: Within 48 hours</li>
        </ul>
        
        <h2>4. PROCESSING</h2>
        <p>Approved refunds will be processed within 5-7 business days to the original payment method.</p>
        
        <h2>5. CONTACT</h2>
        <p>Questions about refunds: <a href="/cdn-cgi/l/email-protection#1873756d7c79767f36777e7e717b717974587f75797174367b7775"><span class="__cf_email__" data-cfemail="4e25233b2a2f202960212828272d272f220e29232f2722602d2123">[email&#160;protected]</span></a></p>
    </div>
</div>

<!-- ========================================
     FOOTER
     ======================================== -->
<footer class="legal-footer">
    <div class="disclaimer">
        <strong>‚ö†Ô∏è Disclaimer:</strong> K-MUDANG is an entertainment service based on traditional Korean Saju (Four Pillars of Destiny) logic and AI interpretation. 
        This service does not guarantee lottery winnings or predict future events. 
        Lottery numbers are generated using metaphysical algorithms for entertainment purposes only. 
        Please gamble responsibly.
    </div>
    
    <div class="copyright">
        ¬© 2025 K-MUDANG. All Rights Reserved.<br>
        <span class="ip-notice">The AI-Saju Integration Protocol is a proprietary methodology of K-MUDANG.</span>
    </div>
    
    <div class="legal-links">
        <a href="#terms" onclick="showLegalPage('terms'); return false;">Terms of Service</a> | 
        <a href="#privacy" onclick="showLegalPage('privacy'); return false;">Privacy Policy</a> | 
        <a href="#refund" onclick="showLegalPage('refund'); return false;">Refund Policy</a> | 
        <a href="/cdn-cgi/l/email-protection#6803051d0c09060f46070e0e010b010904280f05090104460b0705">Contact</a>
    </div>
</footer>

<style>
/* Legal Pages CSS */
.legal-page {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--navy);
    z-index: 9999;
    overflow-y: auto;
    padding: 20px;
}

.legal-container {
    max-width: 800px;
    margin: 0 auto;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: 15px;
    padding: 40px;
}

.legal-close {
    float: right;
    background: rgba(212, 175, 55, 0.2);
    border: 1px solid var(--gold);
    color: var(--gold);
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
}

.legal-close:hover {
    background: var(--gold);
    color: var(--navy);
}

.legal-page h1 {
    color: var(--gold);
    font-family: 'Cinzel Decorative', serif;
    margin-bottom: 10px;
}

.legal-updated {
    color: #888;
    font-style: italic;
    margin-bottom: 30px;
}

.legal-page h2 {
    color: #F4D58D;
    margin-top: 30px;
    margin-bottom: 15px;
    border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    padding-bottom: 10px;
}

.legal-page h3 {
    color: #ccc;
    margin-top: 20px;
    margin-bottom: 10px;
}

.legal-page p {
    color: #bbb;
    line-height: 1.8;
    margin-bottom: 15px;
}

.legal-page ul {
    color: #bbb;
    margin-left: 20px;
    margin-bottom: 15px;
}

.legal-page li {
    margin-bottom: 8px;
    line-height: 1.6;
}

.legal-page a {
    color: var(--gold);
}

.legal-page strong {
    color: #fff;
}

/* Footer CSS */
.legal-footer {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-top: 1px solid rgba(212, 175, 55, 0.3);
    padding: 30px 20px;
    margin-top: 50px;
    text-align: center;
    font-size: 0.85rem;
    color: #9CA3AF;
}

.legal-footer .disclaimer {
    max-width: 800px;
    margin: 0 auto 20px;
    padding: 15px;
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
    line-height: 1.6;
}

.legal-footer .copyright {
    margin-bottom: 15px;
}

.legal-footer .ip-notice {
    font-size: 0.75rem;
    opacity: 0.7;
}

.legal-footer .legal-links {
    margin-top: 15px;
}

.legal-footer .legal-links a {
    color: var(--gold);
    text-decoration: none;
    transition: opacity 0.3s;
}

.legal-footer .legal-links a:hover {
    opacity: 0.7;
}

/* Mobile Footer */
@media (max-width: 768px) {
    .legal-footer {
        padding: 20px 15px;
        font-size: 0.8rem;
    }
    .legal-footer .disclaimer {
        padding: 12px;
    }
}
</style>

<!-- ========================================
     TEST SUITE (v4.12.2)
     ÏΩòÏÜîÏóêÏÑú runAllTests() Ïã§Ìñâ
     ======================================== -->
<script>
/* ========================================
   K-MUDANG Test Suite
   Run: runAllTests() in console
   ======================================== */

// Test helper functions
function createTestSaju(yStem, yBranch, mStem, mBranch, dStem, dBranch, hStem, hBranch) {
    return {
        year: { s: STEM[yStem], b: BRANCH[yBranch] },
        month: { s: STEM[mStem], b: BRANCH[mBranch] },
        day: { s: STEM[dStem], b: BRANCH[dBranch] },
        hour: hStem !== null ? { s: STEM[hStem], b: BRANCH[hBranch] } : null
    };
}

function testResult(name, expected, actual, details = '') {
    const pass = expected === actual;
    const icon = pass ? '‚úÖ' : '‚ùå';
    console.log(`${icon} ${name}: Expected "${expected}", Got "${actual}" ${details}`);
    return pass;
}

// ====== 1. Ïã†Í∞ï/Ïã†ÏïΩ ÌÖåÏä§Ìä∏ ======
function testStrength() {
    console.log('\nüìä ===== Ïã†Í∞ï/Ïã†ÏïΩ (calcStrength) ÌÖåÏä§Ìä∏ =====');
    let passed = 0, total = 0;
    
    // Test 1: Í∞ëÎ™©(Áî≤Êú®) Ïù∏Ïõî(ÂØÖÊúà) - ÎãπÎ†π + ÌÜµÍ∑º = Ïã†Í∞ï
    // Áî≤ÂØÖ ‰∏ôÂØÖ Áî≤ÂØÖ Áî≤ÂØÖ (Í∑πÏã†Í∞ï ÏºÄÏù¥Ïä§)
    const test1 = createTestSaju(0, 2, 2, 2, 0, 2, 0, 2);
    const str1 = calcStrength(test1);
    total++;
    if (testResult('Í∞ëÎ™© Ïù∏Ïõî ÎãπÎ†π+ÌÜµÍ∑º', 'strong', str1.type, `(score: ${str1.score})`)) passed++;
    
    // Test 2: Í∞ëÎ™©(Áî≤Êú®) Ïú†Ïõî(ÈÖâÊúà) - Ïã§Î†π + Î¨¥Í∑º = Ïã†ÏïΩ
    // Â∫öÁî≥ ‰πôÈÖâ Áî≤Êàå ‰∏ôÂØÖ
    const test2 = createTestSaju(6, 8, 1, 9, 0, 10, 2, 2);
    const str2 = calcStrength(test2);
    total++;
    if (testResult('Í∞ëÎ™© Ïú†Ïõî Ïã§Î†π', 'weak', str2.type, `(score: ${str2.score})`)) passed++;
    
    // Test 3: Ï†ïÌôî(‰∏ÅÁÅ´) Ïò§Ïõî(ÂçàÊúà) - ÎãπÎ†π = Ïã†Í∞ï
    // ‰∏ôÂçà Áî≤Âçà ‰∏ÅÂ∑≥ Â£¨ÂØÖ
    const test3 = createTestSaju(2, 6, 0, 6, 3, 5, 8, 2);
    const str3 = calcStrength(test3);
    total++;
    if (testResult('Ï†ïÌôî Ïò§Ïõî ÎãπÎ†π', 'strong', str3.type, `(score: ${str3.score})`)) passed++;
    
    // Test 4: Í≤ΩÍ∏à(Â∫öÈáë) ÏûêÏõî(Â≠êÊúà) - ÏÑ§Í∏∞ = Ïã†ÏïΩ
    // Â£¨Â≠ê Â£¨Â≠ê Â∫öÂ≠ê Â£¨Âçà
    const test4 = createTestSaju(8, 0, 8, 0, 6, 0, 8, 6);
    const str4 = calcStrength(test4);
    total++;
    if (testResult('Í≤ΩÍ∏à ÏûêÏõî ÏÑ§Í∏∞Í≥ºÎã§', 'weak', str4.type, `(score: ${str4.score})`)) passed++;
    
    // Test 5: Î¨¥ÌÜ†(ÊàäÂúü) ÎØ∏Ïõî(Êú™Êúà) - ÌÜ†ÏôïÏö©ÏÇ¨ = Ïã†Í∞ï
    // ÊàäÂçà Â∑±Êú™ ÊàäÊàå ÊàäËæ∞
    const test5 = createTestSaju(4, 6, 5, 7, 4, 10, 4, 4);
    const str5 = calcStrength(test5);
    total++;
    if (testResult('Î¨¥ÌÜ† ÎØ∏Ïõî ÌÜ†ÏôïÏö©ÏÇ¨', 'strong', str5.type, `(score: ${str5.score})`)) passed++;
    
    console.log(`\nÏã†Í∞ï/Ïã†ÏïΩ ÌÖåÏä§Ìä∏: ${passed}/${total} ÌÜµÍ≥º`);
    return { passed, total };
}

// ====== 2. Ï≤úÍ∞ÑÌï© Ïù∏Ï†ëÏÑ± ÌÖåÏä§Ìä∏ ======
function testStemCombine() {
    console.log('\nüîó ===== Ï≤úÍ∞ÑÌï© Ïù∏Ï†ëÏÑ± ÌÖåÏä§Ìä∏ =====');
    let passed = 0, total = 0;
    
    // Test 1: Í∞ëÍ∏∞Ìï© (ÎÖÑ-Ïõî) - Ïù∏Ï†ë ‚Üí Ìï© ÏÑ±Î¶Ω
    // Áî≤Â≠ê Â∑±‰∏ë Â£¨ÂØÖ Â∫öËæ∞  (ÎÖÑÍ∞Ñ Áî≤ + ÏõîÍ∞Ñ Â∑± = Ìï©)
    const test1 = createTestSaju(0, 0, 5, 1, 8, 2, 6, 4);
    const str1 = calcStrength(test1);
    const hasAdjacentCombine1 = str1.factors.some(f => f.l === 'üîó Â§©Âπ≤Âêà');
    total++;
    if (testResult('Í∞ëÍ∏∞Ìï© ÎÖÑ-Ïõî Ïù∏Ï†ë', true, hasAdjacentCombine1)) passed++;
    
    // Test 2: ÏùÑÍ≤ΩÌï© (Ïõî-Ïùº) - Ïù∏Ï†ë ‚Üí Ìï© ÏÑ±Î¶Ω
    // Â£¨Â≠ê ‰πô‰∏ë Â∫öÂØÖ ‰∏ôËæ∞  (ÏõîÍ∞Ñ ‰πô + ÏùºÍ∞Ñ Â∫ö = Ìï©)
    const test2 = createTestSaju(8, 0, 1, 1, 6, 2, 2, 4);
    const str2 = calcStrength(test2);
    const hasAdjacentCombine2 = str2.factors.some(f => f.l === 'üîó Â§©Âπ≤Âêà');
    total++;
    if (testResult('ÏùÑÍ≤ΩÌï© Ïõî-Ïùº Ïù∏Ï†ë', true, hasAdjacentCombine2)) passed++;
    
    // Test 3: Î≥ëÏã†Ìï© (Ïùº-Ïãú) - Ïù∏Ï†ë ‚Üí Ìï© ÏÑ±Î¶Ω
    // Â£¨Â≠ê Â£¨‰∏ë ‰∏ôÂØÖ ËæõËæ∞  (ÏùºÍ∞Ñ ‰∏ô + ÏãúÍ∞Ñ Ëæõ = Ìï©)
    const test3 = createTestSaju(8, 0, 8, 1, 2, 2, 7, 4);
    const str3 = calcStrength(test3);
    const hasAdjacentCombine3 = str3.factors.some(f => f.l === 'üîó Â§©Âπ≤Âêà');
    total++;
    if (testResult('Î≥ëÏã†Ìï© Ïùº-Ïãú Ïù∏Ï†ë', true, hasAdjacentCombine3)) passed++;
    
    // Test 4: Í∞ëÍ∏∞ (ÎÖÑ-Ïãú) - ÎπÑÏù∏Ï†ë ‚Üí Ìï© Î∂àÏÑ±Î¶Ω
    // Áî≤Â≠ê Â£¨‰∏ë Â£¨ÂØÖ Â∑±Ëæ∞  (ÎÖÑÍ∞Ñ Áî≤ + ÏãúÍ∞Ñ Â∑± = ÎπÑÏù∏Ï†ë, Ìï© Î∂àÏÑ±Î¶Ω)
    const test4 = createTestSaju(0, 0, 8, 1, 8, 2, 5, 4);
    const str4 = calcStrength(test4);
    // Ìï© factorÍ∞Ä ÏûàÎçîÎùºÎèÑ ÎÖÑ-Ïãú Ï°∞Ìï©ÏùÄ ÏóÜÏñ¥Ïïº Ìï®
    const hasYearHourCombine = str4.factors.some(f => 
        f.l === 'üîó Â§©Âπ≤Âêà' && f.v.includes('year-hour')
    );
    total++;
    if (testResult('Í∞ëÍ∏∞ ÎÖÑ-Ïãú ÎπÑÏù∏Ï†ë Î∂àÏÑ±Î¶Ω', false, hasYearHourCombine)) passed++;
    
    console.log(`\nÏ≤úÍ∞ÑÌï© Ïù∏Ï†ëÏÑ± ÌÖåÏä§Ìä∏: ${passed}/${total} ÌÜµÍ≥º`);
    return { passed, total };
}

// ====== 3. ÌÜ†ÏôïÏö©ÏÇ¨ ÌÖåÏä§Ìä∏ ======
function testEarthMonth() {
    console.log('\nüåç ===== ÌÜ†ÏôïÏö©ÏÇ¨ ÌÖåÏä§Ìä∏ =====');
    let passed = 0, total = 0;
    
    // Ëæ∞Êàå‰∏ëÊú™ ÏõîÏóê Âúü ÏùºÍ∞ÑÏùÄ ÎãπÎ†π
    const earthMonths = [
        { branch: 1, name: '‰∏ëÏõî' },  // ‰∏ë
        { branch: 4, name: 'Ëæ∞Ïõî' },  // Ëæ∞
        { branch: 7, name: 'Êú™Ïõî' },  // Êú™
        { branch: 10, name: 'ÊàåÏõî' }  // Êàå
    ];
    
    earthMonths.forEach(em => {
        // ÊàäÂúü ÏùºÍ∞Ñ in ÂúüÏõî
        const saju = createTestSaju(4, 0, 4, em.branch, 4, 2, 4, 6);
        const str = calcStrength(saju);
        const isDeukRyung = str.factors.some(f => f.l === 'Êúà‰ª§ ÎìùÎ†π' && f.v.includes('ÎãπÎ†π'));
        total++;
        if (testResult(`Î¨¥ÌÜ† ${em.name} ÌÜ†ÏôïÏö©ÏÇ¨ ÎãπÎ†π`, true, isDeukRyung)) passed++;
    });
    
    console.log(`\nÌÜ†ÏôïÏö©ÏÇ¨ ÌÖåÏä§Ìä∏: ${passed}/${total} ÌÜµÍ≥º`);
    return { passed, total };
}

// ====== 4. Ïö©Ïã† ÌåêÏ†ï ÌÖåÏä§Ìä∏ ======
function testGods() {
    console.log('\n‚≠ê ===== Ïö©Ïã† (calcGods) ÌÖåÏä§Ìä∏ =====');
    let passed = 0, total = 0;
    
    // Test 1: Ïã†Í∞ï ‚Üí ÏÑ§Í∏∞(ÏãùÏÉÅ/Ïû¨ÏÑ±) Ïö©Ïã†
    // Áî≤ÂØÖ ‰∏ôÂØÖ Áî≤ÂØÖ Áî≤ÂØÖ (Í∑πÏã†Í∞ï)
    const test1 = createTestSaju(0, 2, 2, 2, 0, 2, 0, 2);
    const str1 = calcStrength(test1);
    const gods1 = calcGods(test1, str1);
    // Ïã†Í∞ïÏùÄ ÁÅ´(ÏãùÏÉÅ) ÎòêÎäî Âúü(Ïû¨ÏÑ±) Ïö©Ïã†
    const validYong1 = ['fire', 'earth'].includes(gods1.yong);
    total++;
    if (testResult('Ïã†Í∞ï ÏÑ§Í∏∞Ïö©Ïã†', true, validYong1, `(Ïö©Ïã†: ${gods1.yong})`)) passed++;
    
    // Test 2: Ïã†ÏïΩ ‚Üí Î∂ÄÏ°∞(Ïù∏ÏÑ±/ÎπÑÍ≤Å) Ïö©Ïã†
    // Â∫öÁî≥ ËæõÈÖâ Áî≤Êàå ‰∏ôÂØÖ
    const test2 = createTestSaju(6, 8, 7, 9, 0, 10, 2, 2);
    const str2 = calcStrength(test2);
    const gods2 = calcGods(test2, str2);
    // Ïã†ÏïΩ Í∞ëÎ™©ÏùÄ Ê∞¥(Ïù∏ÏÑ±) ÎòêÎäî Êú®(ÎπÑÍ≤Å) Ïö©Ïã†
    const validYong2 = ['water', 'wood'].includes(gods2.yong);
    total++;
    if (testResult('Ïã†ÏïΩ Î∂ÄÏ°∞Ïö©Ïã†', true, validYong2, `(Ïö©Ïã†: ${gods2.yong})`)) passed++;
    
    // Test 3: Ï°∞ÌõÑ ÌÖåÏä§Ìä∏ - ÎèôÏ†àÍ∏∞ ÌôîÏö©Ïã†
    // Â£¨Â≠ê Â£¨Â≠ê Áî≤Â≠ê Áî≤Â≠ê (Í≤®Ïö∏ + Ê∞¥ ÎßéÏùå ‚Üí ÁÅ´ Ï°∞ÌõÑ)
    const test3 = createTestSaju(8, 0, 8, 0, 0, 0, 0, 0);
    const str3 = calcStrength(test3);
    const gods3 = calcGods(test3, str3);
    // Í≤®Ïö∏ Í∞ëÎ™©ÏùÄ Ï°∞ÌõÑÎ°ú ÁÅ´Í∞Ä ÌïÑÏöî
    total++;
    if (testResult('ÎèôÏ†àÍ∏∞ Ï°∞ÌõÑÏö©Ïã†', 'fire', gods3.johu, `(Ï°∞ÌõÑ: ${gods3.johu})`)) passed++;
    
    // Test 4: ÌïòÏ†àÍ∏∞ ÏàòÏö©Ïã†
    // ‰∏ôÂçà Áî≤Âçà ‰∏ÅÂ∑≥ ‰∏ôÂçà (Ïó¨Î¶Ñ + ÁÅ´ ÎßéÏùå ‚Üí Ê∞¥ Ï°∞ÌõÑ)
    const test4 = createTestSaju(2, 6, 0, 6, 3, 5, 2, 6);
    const str4 = calcStrength(test4);
    const gods4 = calcGods(test4, str4);
    // Ïó¨Î¶Ñ Ï†ïÌôîÎäî Ï°∞ÌõÑÎ°ú Ê∞¥Í∞Ä ÌïÑÏöî
    total++;
    if (testResult('ÌïòÏ†àÍ∏∞ Ï°∞ÌõÑÏö©Ïã†', 'water', gods4.johu, `(Ï°∞ÌõÑ: ${gods4.johu})`)) passed++;
    
    console.log(`\nÏö©Ïã† ÌÖåÏä§Ìä∏: ${passed}/${total} ÌÜµÍ≥º`);
    return { passed, total };
}

// ====== 5. Ï¢ÖÍ≤© ÌÖåÏä§Ìä∏ ======
function testFollower() {
    console.log('\nüåä ===== Ï¢ÖÍ≤© ÌÖåÏä§Ìä∏ =====');
    let passed = 0, total = 0;
    
    // Test 1: Ï¢ÖÏû¨Í≤© (Ïû¨ÏÑ± 4Í∞ú Ïù¥ÏÉÅ, Í∑πÏã†ÏïΩ, Î¨¥Í∑º)
    // ÊàäËæ∞ ÊàäÂçà ‰πôÊú™ ÊàäÊàå (Âúü4Í∞ú, ‰πôÊú® Í∑πÏã†ÏïΩ)
    const test1 = createTestSaju(4, 4, 4, 6, 1, 7, 4, 10);
    const str1 = calcStrength(test1);
    const gods1 = calcGods(test1, str1);
    total++;
    if (str1.pct < 15 && gods1.isFollower) {
        if (testResult('Ï¢ÖÏû¨Í≤© ÌåêÏ†ï', 'Ï¢ÖÏû¨Í≤©', gods1.followerType)) passed++;
    } else {
        // Ï¢ÖÍ≤© Ï°∞Í±¥ ÎØ∏Ï∂©Ï°± ÏãúÏóêÎèÑ Ï≤¥ÌÅ¨
        console.log(`‚ö†Ô∏è Ï¢ÖÏû¨Í≤© ÌåêÏ†ï: pct=${str1.pct}, isFollower=${gods1.isFollower}`);
        testResult('Ï¢ÖÏû¨Í≤© ÌåêÏ†ï', 'Ï¢ÖÏû¨Í≤©', gods1.followerType || 'ÏùºÎ∞òÍ≤©');
    }
    
    // Test 2: Ï¢ÖÏÇ¥Í≤© ÌÖåÏä§Ìä∏
    // Áî≤Â≠ê ‰∏ôÂØÖ ËæõÈÖâ Â∫öÁî≥ - Ïã†Í∏àÏù¥ Î™©ÌôîÏóê ÎëòÎü¨Ïã∏ÏûÑ
    const test2 = createTestSaju(0, 0, 2, 2, 7, 9, 6, 8);
    const str2 = calcStrength(test2);
    total++;
    testResult('Ï¢ÖÏÇ¥Í≤© ÌõÑÎ≥¥ Ïã†ÏïΩ Ï≤¥ÌÅ¨', true, str2.pct < 50, `(pct: ${str2.pct})`);
    
    console.log(`\nÏ¢ÖÍ≤© ÌÖåÏä§Ìä∏: ${passed}/${total} ÌÜµÍ≥º (ÏùºÎ∂Ä ÏºÄÏù¥Ïä§Îäî Ï°∞Í±¥ Ï≤¥ÌÅ¨)`);
    return { passed, total };
}

// ====== 6. Í∏àÏàòÏÉÅÍ¥ÄÍ≤© ÌÖåÏä§Ìä∏ ======
function testGoldWaterFormat() {
    console.log('\nüíß ===== Í∏àÏàòÏÉÅÍ¥ÄÍ≤© ÌÖåÏä§Ìä∏ =====');
    let passed = 0, total = 0;
    
    // Í∏àÏàòÏÉÅÍ¥ÄÍ≤© Ï°∞Í±¥: Èáë ÏùºÍ∞Ñ + ÂÜ¨Êúà + Ê∞¥ ÏãùÏÉÅ ÏôïÏÑ±
    // Â∫öÂ≠ê Â£¨Â≠ê Â∫öÂ≠ê Â£¨Âçà (Í≤ΩÍ∏à ÏûêÏõî, Ïàò ÎßéÏùå)
    const test1 = createTestSaju(6, 0, 8, 0, 6, 0, 8, 6);
    const str1 = calcStrength(test1);
    const format1 = calcFormat(test1, str1);
    
    // Í∏àÏàòÏÉÅÍ¥ÄÍ≤© ÌåêÏ†ï Ï≤¥ÌÅ¨
    const isGoldWater = format1.name && format1.name.includes('ÈáëÊ∞¥');
    total++;
    if (testResult('Í∏àÏàòÏÉÅÍ¥ÄÍ≤© ÌåêÏ†ï', true, isGoldWater, `(Í≤©Íµ≠: ${format1.name})`)) passed++;
    
    // Í∏àÏàòÏÉÅÍ¥ÄÍ≤©Ïù¥Î©¥ Í¥ÄÏÑ±(ÁÅ´) Í∏∞Ìîº
    if (isGoldWater) {
        const gods1 = calcGods(test1, str1);
        const avoidsFire = gods1.gi === 'fire';
        total++;
        if (testResult('Í∏àÏàòÏÉÅÍ¥ÄÍ≤© Ìôî Í∏∞Ìîº', true, avoidsFire, `(Í∏∞Ïã†: ${gods1.gi})`)) passed++;
    }
    
    console.log(`\nÍ∏àÏàòÏÉÅÍ¥ÄÍ≤© ÌÖåÏä§Ìä∏: ${passed}/${total} ÌÜµÍ≥º`);
    return { passed, total };
}

// ====== 7. Ìé∏Ïù∏ÌÉúÏôï ÌÖåÏä§Ìä∏ ======
function testSealExcess() {
    console.log('\nüìö ===== Ìé∏Ïù∏ÌÉúÏôï ÌÖåÏä§Ìä∏ =====');
    let passed = 0, total = 0;
    
    // Ïù∏ÏÑ±Í≥ºÎã§ Ï°∞Í±¥: Ïù∏ÏÑ± 3Í∞ú Ïù¥ÏÉÅ ‚Üí ÏãùÏÉÅÏúºÎ°ú ÏÑ§Í∏∞
    // Áî≤Â≠ê Â£¨ÂØÖ ‰∏ôÂçà Â£¨Ëæ∞ (Î≥ëÌôî ÏùºÍ∞Ñ, Î™©+Ïàò Ïù∏ÏÑ± ÎßéÏùå)
    const test1 = createTestSaju(0, 0, 8, 2, 2, 6, 8, 4);
    const str1 = calcStrength(test1);
    const gods1 = calcGods(test1, str1);
    
    // Ïù∏ÏÑ± Ïò§Ìñâ Ïπ¥Ïö¥Ìä∏
    const sealEl = 'wood'; // Î≥ëÌôîÏùò Ïù∏ÏÑ±ÏùÄ Î™©
    let sealCount = 0;
    [test1.year, test1.month, test1.day, test1.hour].forEach(p => {
        if (p && p.s && p.s.e === sealEl) sealCount++;
        if (p && p.b && p.b.e === sealEl) sealCount++;
    });
    
    total++;
    testResult('Ïù∏ÏÑ± Ïπ¥Ïö¥Ìä∏', true, sealCount >= 2, `(Ïù∏ÏÑ±: ${sealCount}Í∞ú)`);
    
    // Ïù∏ÏÑ±Í≥ºÎã§ Ïãú ÏãùÏÉÅ Ïö©Ïã† Ï≤¥ÌÅ¨
    if (sealCount >= 3) {
        const exprEl = 'earth'; // Î≥ëÌôîÏùò ÏãùÏÉÅÏùÄ ÌÜ†
        total++;
        if (testResult('Ïù∏ÏÑ±Í≥ºÎã§ ÏãùÏÉÅÏö©Ïã†', exprEl, gods1.yong, `(Ïö©Ïã†: ${gods1.yong})`)) passed++;
    }
    
    console.log(`\nÌé∏Ïù∏ÌÉúÏôï ÌÖåÏä§Ìä∏: ${passed}/${total} ÌÜµÍ≥º`);
    return { passed, total };
}

// ====== 8. Î∞©Ìï©/ÏÇºÌï© ÌÖåÏä§Ìä∏ ======
function testCombinations() {
    console.log('\nüî• ===== Î∞©Ìï©/ÏÇºÌï© ÌÖåÏä§Ìä∏ =====');
    let passed = 0, total = 0;
    
    // Î∞©Ìï© ÌÖåÏä§Ìä∏: ÂØÖÂçØËæ∞ Î™©Íµ≠
    // Áî≤ÂØÖ ‰πôÂçØ ‰∏ôËæ∞ ‰∏ÅÂ∑≥
    const test1 = createTestSaju(0, 2, 1, 3, 2, 4, 3, 5);
    const str1 = calcStrength(test1);
    const hasDirectional = str1.factors.some(f => f.l === 'üî• ÊñπÂêà');
    total++;
    if (testResult('ÂØÖÂçØËæ∞ Î∞©Ìï©', true, hasDirectional)) passed++;
    
    // ÏÇºÌï© ÌÖåÏä§Ìä∏: ÂØÖÂçàÊàå ÌôîÍµ≠
    // Áî≤ÂØÖ ‰∏ôÂçà ÊàäÊàå Â∫öÂ≠ê
    const test2 = createTestSaju(0, 2, 2, 6, 4, 10, 6, 0);
    const str2 = calcStrength(test2);
    const hasThreeHarmony = str2.factors.some(f => f.l === 'üî• ‰∏âÂêà');
    total++;
    if (testResult('ÂØÖÂçàÊàå ÏÇºÌï©', true, hasThreeHarmony)) passed++;
    
    console.log(`\nÎ∞©Ìï©/ÏÇºÌï© ÌÖåÏä§Ìä∏: ${passed}/${total} ÌÜµÍ≥º`);
    return { passed, total };
}

// ====== Î©îÏù∏ ÌÖåÏä§Ìä∏ Ïã§Ìñâ Ìï®Ïàò ======
function runAllTests() {
    console.clear();
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë        K-MUDANG Pro v4.12.3 Test Suite                 ‚ïë');
    console.log('‚ïë        ÏÇ¨Ï£º Í≥ÑÏÇ∞ Î°úÏßÅ Í≤ÄÏ¶ù                              ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    
    const results = [];
    
    // ‚òÖ‚òÖ‚òÖ Í∞ÄÏû• Ï§ëÏöîÌïú ÏùºÏ£º Í≥ÑÏÇ∞ ÌÖåÏä§Ìä∏ Î®ºÏ†Ä! ‚òÖ‚òÖ‚òÖ
    results.push(testDayPillar());
    
    results.push(testStrength());
    results.push(testStemCombine());
    results.push(testEarthMonth());
    results.push(testGods());
    results.push(testFollower());
    results.push(testGoldWaterFormat());
    results.push(testSealExcess());
    results.push(testCombinations());
    
    // Ï¥ùÌï© Í≥ÑÏÇ∞
    const totalPassed = results.reduce((sum, r) => sum + r.passed, 0);
    const totalTests = results.reduce((sum, r) => sum + r.total, 0);
    
    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log(`‚ïë  üìä ÏµúÏ¢Ö Í≤∞Í≥º: ${totalPassed}/${totalTests} ÌÖåÏä§Ìä∏ ÌÜµÍ≥º`);
    console.log(`‚ïë  ${totalPassed === totalTests ? '‚úÖ ALL PASS!' : '‚ö†Ô∏è ÏùºÎ∂Ä Ïã§Ìå® - Î°úÏßÅ ÌôïÏù∏ ÌïÑÏöî'}`);
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    
    return { passed: totalPassed, total: totalTests };
}

// ====== 0. ÏùºÏ£º(Êó•Êü±) Í≥ÑÏÇ∞ Í≤ÄÏ¶ù ÌÖåÏä§Ìä∏ - Í∞ÄÏû• Ï§ëÏöî! ======
function testDayPillar() {
    console.log('\nüìÖ ===== ÏùºÏ£º(Êó•Êü±) Í≥ÑÏÇ∞ Í≤ÄÏ¶ù ÌÖåÏä§Ìä∏ [CRITICAL] =====');
    let passed = 0, total = 0;
    
    // Í∞ùÍ¥ÄÏ†Å ÏÜåÏä§Î°ú Í≤ÄÏ¶ùÎêú ÌÖåÏä§Ìä∏ ÏºÄÏù¥Ïä§
    // KASI(ÌïúÍµ≠Ï≤úÎ¨∏Ïó∞Íµ¨Ïõê), ÏúÑÌÇ§Î∞±Í≥º, Ïñ∏Î°†Í∏∞ÏÇ¨
    const testCases = [
        { y: 1900, m: 1, d: 1, expected: 'Áî≤Êàå', desc: '1900-01-01 Í∏∞Ï§ÄÏùº' },
        { y: 1900, m: 1, d: 2, expected: '‰πô‰∫•', desc: '1900-01-02 Í∏∞Ï§ÄÏùº+1' },
        { y: 2000, m: 1, d: 1, expected: 'ÊàäÂçà', desc: '2000-01-01 Î∞ÄÎ†àÎãàÏóÑ' },
        { y: 2024, m: 1, d: 1, expected: 'Áî≤Â≠ê', desc: '2024-01-01 (ÏúÑÌÇ§Î∞±Í≥º Í≤ÄÏ¶ù)' },
        { y: 2024, m: 3, d: 1, expected: 'Áî≤Â≠ê', desc: '2024-03-01 (ÏúÑÌÇ§Î∞±Í≥º Í≤ÄÏ¶ù)' },
        { y: 2025, m: 12, d: 21, expected: 'Áî≤Â≠ê', desc: '2025-12-21 (Ï§ëÎ∂ÄÏùºÎ≥¥ Í≤ÄÏ¶ù)' },
        { y: 2026, m: 1, d: 16, expected: 'Â∫öÂØÖ', desc: '2026-01-16 (KASI Í≤ÄÏ¶ù)' },
        { y: 2026, m: 1, d: 20, expected: 'Áî≤Âçà', desc: '2026-01-20 (KASI Í≤ÄÏ¶ù)' },
    ];
    
    testCases.forEach(tc => {
        const result = calcDayPillar(tc.y, tc.m, tc.d);
        const actual = result.s.c + result.b.c;
        const pass = actual === tc.expected;
        total++;
        if (pass) passed++;
        
        const icon = pass ? '‚úÖ' : '‚ùå';
        console.log(`${icon} ${tc.desc}: Expected "${tc.expected}", Got "${actual}"`);
    });
    
    console.log(`\nÏùºÏ£º Í≥ÑÏÇ∞ ÌÖåÏä§Ìä∏: ${passed}/${total} ÌÜµÍ≥º`);
    if (passed !== total) {
        console.log('üö® ÏùºÏ£º Í≥ÑÏÇ∞ Ïò§Î•ò! Î™®Îì† ÏÇ¨Ï£º Î∂ÑÏÑùÏù¥ ÌãÄÎ¶ΩÎãàÎã§!');
    }
    return { passed, total };
}

// Í∞úÎ≥Ñ ÌÖåÏä§Ìä∏ Ïã§Ìñâ Ìó¨Ìçº
function runTest(name) {
    const tests = {
        day: testDayPillar,      // ‚òÖ Í∞ÄÏû• Ï§ëÏöî!
        dayPillar: testDayPillar,
        strength: testStrength,
        stem: testStemCombine,
        earth: testEarthMonth,
        gods: testGods,
        follower: testFollower,
        goldwater: testGoldWaterFormat,
        seal: testSealExcess,
        combine: testCombinations
    };
    
    if (tests[name]) {
        console.clear();
        tests[name]();
    } else {
        console.log('ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÌÖåÏä§Ìä∏:', Object.keys(tests).join(', '));
    }
}

// ÏΩòÏÜîÏóê ÎèÑÏõÄÎßê ÌëúÏãú
console.log('üß™ K-MUDANG Test Suite loaded. Run: runAllTests() or runTest("strength")');
</script>

</body>
</html>