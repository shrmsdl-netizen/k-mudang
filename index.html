<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>K-MUDANG | Ancient Korean Zodiac Algorithm</title>
<meta name="description" content="Ancient Korean Zodiac Algorithm for Powerball & Mega Millions. Professional Four Pillars Analysis.">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="K-MUDANG | Ancient Korean Zodiac Algorithm">
<meta property="og:description" content="ğŸ”® Professional Four Pillars Analysis Â· ğŸ° Powerball & Mega Millions Numbers">
<meta property="og:image" content="https://raw.githubusercontent.com/shrmsdl-netizen/k-mudang/main/og-image.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Noto+Serif+KR:wght@400;700;900&family=Cinzel+Decorative:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
/* ========================================
   Animations
   ======================================== */
@keyframes shimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }
@keyframes breathe { 0%, 100% { opacity: 0.04; transform: scale(1); } 50% { opacity: 0.07; transform: scale(1.02); } }
@keyframes dragonPulse { 0%, 100% { filter: drop-shadow(0 0 15px var(--theme-accent-glow)); } 50% { filter: drop-shadow(0 0 30px var(--theme-accent-glow)); } }
@keyframes ballDrop { 0% { transform: translateY(-30px) scale(0.5); opacity: 0; } 60% { transform: translateY(5px) scale(1.1); } 100% { transform: translateY(0) scale(1); opacity: 1; } }
@keyframes glowPulse { 0%, 100% { box-shadow: inset -3px -3px 10px rgba(0,0,0,0.4), inset 3px 3px 8px rgba(255,255,255,0.3), 0 0 25px var(--theme-glow), 0 8px 20px rgba(0,0,0,0.3); } 50% { box-shadow: inset -3px -3px 10px rgba(0,0,0,0.4), inset 3px 3px 8px rgba(255,255,255,0.3), 0 0 40px var(--theme-glow), 0 8px 20px rgba(0,0,0,0.3); } }
@keyframes buttonPulse { 0% { box-shadow: 0 4px 25px var(--theme-glow), 0 0 0 0 rgba(212, 175, 55, 0.7); } 70% { box-shadow: 0 4px 25px var(--theme-glow), 0 0 0 15px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 4px 25px var(--theme-glow), 0 0 0 0 rgba(212, 175, 55, 0); } }
@keyframes kofiPulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255,215,0,0.5); } 50% { transform: scale(1.02); box-shadow: 0 0 35px rgba(255,215,0,0.8); } }

/* ========================================
   CSS Variables
   ======================================== */
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
    --navy: #1a2332;
    --navy-light: #243447;
    --gold: #D4AF37;
    --gold-light: #F4D58D;
    --pearl: #F5F5F5;
    --gray: #9CA3AF;
    --theme-primary: #DC3545;
    --theme-secondary: #8B0000;
    --theme-accent: #FFD700;
    --theme-accent-glow: rgba(255, 215, 0, 0.4);
    --theme-glow: rgba(220, 53, 69, 0.4);
    --theme-bg-1: #1a1a2e;
    --theme-bg-2: #2d1f3d;
    --wood: #4CAF50;
    --fire: #F44336;
    --earth: #FF9800;
    --metal: #9E9E9E;
    --water: #2196F3;
}

body.powerball-mode {
    --theme-primary: #DC3545;
    --theme-secondary: #8B0000;
    --theme-accent: #FFD700;
    --theme-accent-glow: rgba(255, 215, 0, 0.4);
    --theme-glow: rgba(220, 53, 69, 0.4);
    --theme-bg-1: #1a1a2e;
    --theme-bg-2: #2d1f3d;
}

body.mega-mode {
    --theme-primary: #2E86DE;
    --theme-secondary: #003478;
    --theme-accent: #FFD700;
    --theme-accent-glow: rgba(255, 215, 0, 0.4);
    --theme-glow: rgba(46, 134, 222, 0.4);
    --theme-bg-1: #141E30;
    --theme-bg-2: #243B55;
}

body.saju-mode {
    --theme-primary: #D4AF37;
    --theme-secondary: #8B7020;
    --theme-accent: #FFD700;
    --theme-accent-glow: rgba(255, 215, 0, 0.4);
    --theme-glow: rgba(212, 175, 55, 0.4);
    --theme-bg-1: #1a1a2e;
    --theme-bg-2: #16213e;
}

body {
    font-family: 'Cormorant Garamond', 'Noto Serif KR', Georgia, serif;
    background: var(--navy);
    color: var(--pearl);
    min-height: 100vh;
    padding-bottom: 20px;
    line-height: 1.7;
    transition: all 0.5s ease;
}

/* ========================================
   Watermark & Bagua
   ======================================== */
.oracle-watermark {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    max-width: 500px;
    height: auto;
    max-height: 90vh;
    object-fit: contain;
    opacity: 0.15;
    filter: grayscale(30%) brightness(1.2);
    z-index: -1;
    pointer-events: none;
    transition: opacity 0.5s ease;
}

body.mega-mode .oracle-watermark {
    filter: grayscale(50%) brightness(1.3) hue-rotate(200deg);
    opacity: 0.12;
}

body.saju-mode .oracle-watermark {
    filter: grayscale(20%) brightness(1.1) sepia(20%);
    opacity: 0.18;
}

.bagua {
    position: fixed;
    font-size: 2.5rem;
    opacity: 0.4;
    pointer-events: none;
    z-index: 2;
    font-family: serif;
    line-height: 1;
    text-shadow: 0 0 20px currentColor, 0 0 40px currentColor;
    text-align: center;
    transition: all 0.5s ease;
}
.bagua-sub { font-size: 0.4em; display: block; margin-top: 5px; opacity: 0.8; font-family: 'Noto Serif KR', serif; }
.bagua.tl { top: 180px; left: 15px; color: #FFD700; }
.bagua.tr { top: 180px; right: 15px; color: #FF6B6B; }
.bagua.bl { bottom: 100px; left: 15px; color: #4ECDC4; }
.bagua.br { bottom: 100px; right: 15px; color: #A29BFE; }

body.mega-mode .bagua.tl { color: #87CEEB; }
body.mega-mode .bagua.tr { color: #E8E8E8; }
body.mega-mode .bagua.bl { color: #98D8C8; }
body.mega-mode .bagua.br { color: #B8B8FF; }

body.saju-mode .bagua.tl { color: #FFD700; }
body.saju-mode .bagua.tr { color: #FF7675; }
body.saju-mode .bagua.bl { color: #55EFC4; }
body.saju-mode .bagua.br { color: #A29BFE; }

/* ========================================
   Tab Navigation
   ======================================== */
.game-switcher {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 12px 10px;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.game-btn {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.5);
    padding: 10px 20px;
    font-family: 'Noto Serif KR', 'Cinzel Decorative', serif;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 1px;
    cursor: pointer;
    border-radius: 25px;
    transition: all 0.4s ease;
    min-width: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.tab-main { font-size: 14px; font-weight: 700; }
.tab-sub { font-size: 10px; opacity: 0.7; }

.game-btn:hover {
    border-color: var(--theme-accent);
    color: var(--pearl);
    transform: translateY(-2px);
}

.game-btn:active {
    transform: scale(0.95);
    transition: transform 0.1s ease;
}

.game-btn.active {
    background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
    border-color: var(--theme-accent);
    color: white;
    box-shadow: 0 4px 20px var(--theme-glow);
}

/* ========================================
   Layout
   ======================================== */
.container {
    max-width: 520px;
    margin: 0 auto;
    padding: 15px;
    position: relative;
    z-index: 10;
}

.tab-content { display: none; }
.tab-content.active { display: block; }

/* ========================================
   Header
   ======================================== */
header {
    text-align: center;
    padding: 25px 15px;
    position: relative;
}

.dragon-seal {
    width: 70px;
    height: 70px;
    margin: 0 auto 15px;
    animation: dragonPulse 3s ease-in-out infinite;
}

.dragon-seal svg { width: 100%; height: 100%; }

header h1 {
    font-family: 'Cinzel Decorative', serif;
    font-size: 2rem;
    font-weight: 900;
    background: linear-gradient(135deg, var(--gold), var(--gold-light), var(--gold));
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 3s linear infinite;
    letter-spacing: 3px;
}

.game-title {
    display: inline-block;
    font-size: 1rem;
    font-weight: 700;
    color: var(--theme-accent);
    margin-top: 8px;
    padding: 5px 15px;
    border: 1px solid var(--theme-accent);
    border-radius: 20px;
    letter-spacing: 2px;
}

.subtitle {
    font-size: 0.85rem;
    color: var(--gray);
    margin-top: 10px;
    letter-spacing: 1px;
}

/* ========================================
   Cards
   ======================================== */
.card {
    background: linear-gradient(145deg, rgba(36,52,71,0.9), rgba(26,35,50,0.95));
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.card.gold {
    border-color: rgba(212,175,55,0.3);
    background: linear-gradient(145deg, rgba(212,175,55,0.15), rgba(26,35,50,0.95));
}

.card h3 {
    font-size: 1rem;
    font-weight: 700;
    color: var(--theme-accent);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ========================================
   Form Elements
   ======================================== */
.form-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 15px;
}

.form-group { display: flex; flex-direction: column; gap: 5px; }

.form-group label {
    font-size: 11px;
    color: var(--gray);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.form-group select, .form-group input {
    background: #1a2332;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    padding: 12px 10px;
    color: #FFFFFF;
    font-size: 18px;
    font-weight: 600;
    font-family: 'Cinzel Decorative', 'Cormorant Garamond', serif;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

.form-group select {
    background: #1a2332 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23D4AF37' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E") no-repeat right 10px center;
    padding-right: 30px;
    cursor: pointer;
}

.form-group select option {
    background: #1a2332;
    color: #FFFFFF;
    font-size: 18px;
    font-family: 'Cinzel Decorative', 'Cormorant Garamond', serif;
    padding: 14px;
}

.form-group select:focus, .form-group input:focus {
    outline: none;
    border-color: var(--theme-accent);
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
}

.toggle-btns { display: flex; gap: 5px; }

.toggle-btn {
    flex: 1;
    padding: 8px;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    background: transparent;
    color: var(--gray);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.toggle-btn.on {
    background: var(--theme-primary);
    border-color: var(--theme-accent);
    color: white;
}

/* ========================================
   Buttons
   ======================================== */
.btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
    border: none;
    border-radius: 12px;
    color: white;
    font-family: inherit;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 20px var(--theme-glow);
    letter-spacing: 1px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px var(--theme-glow);
}

.btn:active { 
    transform: scale(0.95); 
    transition: transform 0.1s ease;
}

.btn-secondary {
    background: transparent;
    border: 1px solid var(--theme-accent);
    color: var(--theme-accent);
    box-shadow: none;
}

/* ========================================
   Ko-fi Button (Premium Gold)
   ======================================== */
.kofi-container {
    margin-top: 25px;
    padding: 20px;
    background: transparent;
    border: none;
    text-align: center;
}

.kofi-container p {
    color: var(--gold-light);
    font-size: 13px;
    margin-bottom: 15px;
    opacity: 0.85;
}

.kofi-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 16px 32px;
    background: #000000;
    border: 2px solid #D4AF37;
    border-radius: 12px;
    color: #D4AF37;
    font-family: 'Cinzel Decorative', serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 0 20px rgba(212,175,55,0.2), inset 0 0 0 0 rgba(212,175,55,0);
    letter-spacing: 1px;
}

.kofi-btn:hover {
    background: linear-gradient(135deg, rgba(212,175,55,0.25) 0%, rgba(212,175,55,0.15) 100%);
    border-color: #FFD700;
    color: #FFD700;
    transform: translateY(-2px);
    box-shadow: 0 0 35px rgba(212,175,55,0.4), 0 8px 25px rgba(0,0,0,0.3);
    text-shadow: 0 0 10px rgba(255,215,0,0.5);
}

.kofi-btn:active {
    transform: translateY(0);
}

.kofi-btn img {
    width: 24px;
    height: 24px;
}

/* ========================================
   Lottery Balls
   ======================================== */
.balls-container {
    display: flex;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
    padding: 20px 0;
    min-height: 80px;
}

.ball {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Cinzel Decorative', serif;
    font-weight: 900;
    font-size: 18px;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    background: linear-gradient(135deg, #DC3545, #8B0000);
    box-shadow: inset -3px -3px 10px rgba(0,0,0,0.4), inset 3px 3px 8px rgba(255,255,255,0.3), 0 0 25px var(--theme-glow), 0 8px 20px rgba(0,0,0,0.3);
    opacity: 0;
    animation: ballDrop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
}

.ball.powerball {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #1a1a2e;
    box-shadow: inset -3px -3px 10px rgba(0,0,0,0.3), inset 3px 3px 8px rgba(255,255,255,0.5), 0 0 30px rgba(255,215,0,0.5), 0 8px 20px rgba(0,0,0,0.3);
}

.ball.mega {
    background: linear-gradient(135deg, #2E86DE, #003478);
}

.ball.megaball {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #1a1a2e;
}

/* ========================================
   Saju Pillars
   ======================================== */
.pillars {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 15px;
}

.pillar {
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    padding: 12px 8px;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.1);
}

.pillar.dm {
    border-color: var(--gold);
    background: rgba(212,175,55,0.15);
}

.pillar-label {
    font-size: 10px;
    color: var(--gray);
    margin-bottom: 8px;
    text-transform: uppercase;
}

.pillar-stem {
    font-size: 28px;
    font-weight: 900;
    margin-bottom: 4px;
}

.pillar-branch {
    font-size: 24px;
    font-weight: 700;
}

.pillar-sub {
    font-size: 11px;
    color: var(--gray);
    margin-top: 5px;
}

.pillar-god {
    font-size: 10px;
    color: var(--theme-accent);
    margin-top: 5px;
    padding: 3px 6px;
    background: rgba(212,175,55,0.2);
    border-radius: 4px;
}

/* Element Colors */
.el-wood { color: var(--wood); }
.el-fire { color: var(--fire); }
.el-earth { color: var(--earth); }
.el-metal { color: var(--metal); }
.el-water { color: var(--water); }

/* ========================================
   Strength Bar
   ======================================== */
.strength-box {
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
}

.strength-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.strength-title { font-size: 13px; color: var(--gray); }

.strength-badge {
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 700;
}

.strength-badge.strong { background: var(--fire); color: white; }
.strength-badge.weak { background: var(--water); color: white; }
.strength-badge.balanced { background: var(--wood); color: white; }

.strength-bar {
    height: 8px;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    overflow: hidden;
}

.strength-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.8s ease;
}

.strength-fill.strong { background: linear-gradient(90deg, var(--fire), #ff6b6b); }
.strength-fill.weak { background: linear-gradient(90deg, var(--water), #74b9ff); }
.strength-fill.balanced { background: linear-gradient(90deg, var(--wood), #81c784); }

.factors {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-top: 12px;
}

.factor {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    padding: 6px 10px;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
}

.factor-label { color: var(--gray); }
.factor-value.pos { color: var(--fire); }
.factor-value.neg { color: var(--water); }

/* ========================================
   Element Bar
   ======================================== */
.element-bar {
    display: flex;
    height: 30px;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 10px;
}

.element-bar > div { transition: width 0.5s ease; }

.element-legend {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    font-size: 11px;
}

.element-legend span {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* ========================================
   Info Box
   ======================================== */
.info-box {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
}

.info-box p { font-size: 13px; line-height: 1.7; }

/* ========================================
   Luck Timeline
   ======================================== */
.luck-timeline {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 10px 0;
    scrollbar-width: thin;
}

.luck-item {
    flex: 0 0 70px;
    text-align: center;
    padding: 12px 8px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    border: 1px solid transparent;
}

.luck-item.current {
    border-color: var(--gold);
    background: rgba(212,175,55,0.2);
}

.luck-age { font-size: 11px; color: var(--gray); margin-bottom: 5px; }
.luck-pillar { font-size: 18px; font-weight: 700; }
.luck-element { font-size: 10px; color: var(--theme-accent); margin-top: 5px; }

/* ========================================
   Sinsal Grid
   ======================================== */
.sinsal-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.sinsal-item {
    padding: 12px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    border-left: 3px solid var(--gray);
}

.sinsal-item.good { border-color: var(--wood); }
.sinsal-item.bad { border-color: var(--fire); }

.sinsal-name { font-size: 13px; font-weight: 700; margin-bottom: 5px; }
.sinsal-desc { font-size: 11px; color: var(--gray); }

/* ========================================
   History
   ======================================== */
.history-section { margin-top: 15px; }

.history-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    margin-bottom: 8px;
}

.history-type {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 10px;
    background: var(--theme-primary);
    color: white;
}

.history-balls { display: flex; gap: 4px; flex-wrap: wrap; }

.history-balls .ball {
    width: 28px;
    height: 28px;
    font-size: 11px;
    animation: none;
    opacity: 1;
}

/* ========================================
   Toast
   ======================================== */
.toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 14px;
    z-index: 9999;
    opacity: 0;
    transition: all 0.3s;
    border: 1px solid var(--theme-accent);
}

.toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

/* ========================================
   Footer
   ======================================== */
footer {
    text-align: center;
    padding: 30px 15px;
    color: var(--gray);
    font-size: 12px;
}

footer a {
    color: var(--theme-accent);
    text-decoration: none;
}

/* ========================================
   Responsive
   ======================================== */
@media (max-width: 400px) {
    .game-switcher { gap: 4px; padding: 10px 5px; }
    .game-btn { padding: 8px 12px; font-size: 12px; min-width: auto; }
    .tab-main { font-size: 12px; }
    .tab-sub { font-size: 9px; }
    header h1 { font-size: 1.6rem; }
    .ball { width: 40px; height: 40px; font-size: 15px; }
    .pillar-stem { font-size: 22px; }
    .pillar-branch { font-size: 18px; }
    .bagua { font-size: 1.8rem; }
}
</style>
</head>
<body class="saju-mode">

<!-- Bagua decoration -->
<div class="bagua tl">â˜°<span class="bagua-sub">ä¹¾</span></div>
<div class="bagua tr">â˜·<span class="bagua-sub">å¤</span></div>
<div class="bagua bl">â˜µ<span class="bagua-sub">å</span></div>
<div class="bagua br">â˜²<span class="bagua-sub">é›¢</span></div>

<img class="oracle-watermark" src="https://raw.githubusercontent.com/shrmsdl-netizen/k-mudang/main/og-image.png" alt="" />

<!-- 3-Tab Navigation -->
<div class="game-switcher">
    <button class="game-btn active" onclick="switchGame('saju')"><span class="tab-main">ğŸ”® å››æŸ±</span><span class="tab-sub">Fortune</span></button>
    <button class="game-btn" onclick="switchGame('powerball')"><span class="tab-main">ğŸ”´ Powerball</span></button>
    <button class="game-btn" onclick="switchGame('mega')"><span class="tab-main">ğŸ”µ Mega</span></button>
</div>

<div class="container">

    <!-- ========================================
         Tab 1: SAJU (å››æŸ±) Fortune
         ======================================== -->
    <div id="tab-saju" class="tab-content active">
        <header>
            <div class="dragon-seal">
                <svg viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="dragonGold1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700"/>
                            <stop offset="50%" style="stop-color:#FFA500"/>
                            <stop offset="100%" style="stop-color:#FFD700"/>
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="45" fill="none" stroke="url(#dragonGold1)" stroke-width="2"/>
                    <text x="50" y="58" text-anchor="middle" fill="url(#dragonGold1)" font-size="32" font-family="serif">é¾</text>
                </svg>
            </div>
            <h1>K-MUDANG</h1>
            <span class="game-title">FORTUNE</span>
            <p class="subtitle">Ancient Korean Zodiac Algorithm</p>
        </header>

        <div class="card">
            <h3>ğŸ“… Birth Date & Time</h3>
            <div class="form-row">
                <div class="form-group"><label>Month</label><select id="saju-month"></select></div>
                <div class="form-group"><label>Day</label><select id="saju-day"></select></div>
                <div class="form-group"><label>Year</label><select id="saju-year"></select></div>
                <div class="form-group"><label>Hour</label><select id="saju-hour"></select></div>
            </div>
            <div class="form-row" style="grid-template-columns: repeat(2, 1fr);">
                <div class="form-group">
                    <label>Gender</label>
                    <div class="toggle-btns">
                        <button class="toggle-btn on" data-gender="m" onclick="setGender('m')">ğŸ‘¨ M</button>
                        <button class="toggle-btn" data-gender="f" onclick="setGender('f')">ğŸ‘© F</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Calendar</label>
                    <div class="toggle-btns">
                        <button class="toggle-btn on" data-cal="solar" onclick="setCalendar('solar')">â˜€ï¸ Solar</button>
                        <button class="toggle-btn" data-cal="lunar" onclick="setCalendar('lunar')">ğŸŒ™ Lunar</button>
                    </div>
                </div>
            </div>
            <button class="btn" onclick="analyzeSaju()">ğŸ”® Analyze Fortune</button>
        </div>

        <div id="saju-result" style="display:none;">
            <!-- Four Pillars Chart -->
            <div class="card">
                <h3>ğŸ“œ Four Pillars (Four Pillars Chart)</h3>
                <div class="pillars" id="pillars"></div>
                <div id="twelve-states"></div>
                <div class="strength-box" id="strength-box"></div>
            </div>

            <!-- ç´éŸ³(Sound Element)/å‘½å®®(Life Palace)/Conception -->
            <div class="card">
                <h3>ğŸµ ç´éŸ³(Sound Element) & å‘½å®®(Life Palace)</h3>
                <div id="napeum-myunggung"></div>
            </div>

            <!-- æ”¯è—å¹²(Hidden Stems) ë¶„ì„ -->
            <div class="card">
                <h3>ğŸŒ¿ æ”¯è—å¹²(Hidden Stems) (æ”¯è—å¹²(Hidden Stems))</h3>
                <div id="jijanggan-analysis"></div>
            </div>

            <!-- é€šæ ¹é€å¹²(Root & Stem Analysis) -->
            <div class="card">
                <h3>ğŸŒ³ é€šæ ¹é€å¹²(Root & Stem Analysis)</h3>
                <div id="tonggeun-analysis"></div>
            </div>

            <!-- äº”è¡Œ(Five Elements) Distribution -->
            <div class="card">
                <h3>ğŸŒŸ äº”è¡Œ(Five Elements) Distribution</h3>
                <div class="element-bar" id="element-bar"></div>
                <div class="element-legend" id="element-legend"></div>
                <div id="element-analysis"></div>
            </div>

            <!-- ç”¨ç¥(Beneficial Elements) -->
            <div class="card gold">
                <h3>âš–ï¸ ç”¨ç¥(Beneficial Elements) (ìš©ì‹ )</h3>
                <div id="gods" class="gods-grid"></div>
                <div id="gods-detail"></div>
                <div id="gods-analysis"></div>
            </div>

            <!-- å…­è¦ª(Six Relations) Analysis -->
            <div class="card">
                <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å…­è¦ª(Six Relations) (ìœ¡ì¹œ)</h3>
                <div id="yukcheon-analysis"></div>
            </div>

            <!-- ê²©êµ­ -->
            <div class="card">
                <h3>ğŸ›ï¸ æ ¼å±€(Personality Structure) (ê²©êµ­)</h3>
                <div id="format"></div>
                <div id="format-analysis"></div>
            </div>

            <!-- æ—¥æŸ±(æ—¥æŸ±(Day Pillar))ë¡  -->
            <div class="card">
                <h3>ğŸ“… æ—¥æŸ±(æ—¥æŸ±(Day Pillar)) Analysis (æ—¥æŸ±(æ—¥æŸ±(Day Pillar))ë¡ )</h3>
                <div id="ilju"></div>
            </div>

            <!-- ê¶ìœ„/12ìš´ì„± ìƒì„¸ -->
            <div class="card">
                <h3>ğŸ  Palace & Twelve States</h3>
                <div id="gungwi-analysis"></div>
                <div id="twelve-states-full"></div>
            </div>

            <!-- å¤§é‹(Life Cycle) -->
            <div class="card">
                <h3>ğŸ”„ å¤§é‹(Life Cycle)s (å¤§é‹(Life Cycle))</h3>
                <div class="luck-timeline" id="luck-timeline"></div>
                <div id="luck-detail"></div>
                <div id="gyoungi-analysis"></div>
            </div>

            <!-- í–¥í›„ 10ë…„ ìš´ -->
            <div class="card">
                <h3>ğŸ“ˆ Next 10 Years Fortune</h3>
                <div id="ten-years-luck"></div>
            </div>

            <!-- Monthly Fortune -->
            <div class="card">
                <h3>ğŸ“† Monthly Fortune</h3>
                <div id="monthly-luck"></div>
            </div>

            <!-- í•©ì¶© ë¶„ì„ -->
            <div class="card">
                <h3>ğŸ”— Harmony & Clash (í•©ì¶©)</h3>
                <div id="interactions"></div>
                <div id="banghap-amhap"></div>
                <div id="advanced-interactions"></div>
            </div>

            <!-- ê³µë§ -->
            <div class="card">
                <h3>â­• ç©ºäº¡(Empty Void) (ê³µë§)</h3>
                <div id="gongmang"></div>
                <div id="gongmang-haeso"></div>
            </div>

            <!-- ì‹ ì‚´ -->
            <div class="card">
                <h3>âœ¨ ç¥æ®º(Divine Stars) (ì‹ ì‚´)</h3>
                <div id="sinsal"></div>
                <div id="sinsal-position"></div>
                <div class="sinsal-grid" id="sinsal-grid"></div>
            </div>

            <!-- Today's Fortune -->
            <div class="card gold">
                <h3>ğŸŒ… Today's Fortune</h3>
                <div id="today-fortune"></div>
            </div>

            <!-- AI ì¢…í•© í•´ì„ -->
            <div class="card gold">
                <h3>ğŸ¤– AI Interpretation</h3>
                <div id="ai-interpretation"></div>
                <div style="margin-top:25px;text-align:center;padding:20px;background:linear-gradient(135deg,rgba(103,58,183,0.1),rgba(156,39,176,0.05));border-radius:12px;">
                    <p style="font-size:0.9rem;color:var(--gold-light);margin-bottom:15px;font-style:italic;">
                        âœ¨ The ultimate synergy: Ancient algorithmic precision meets modern AI eloquence
                    </p>
                    <button class="btn" onclick="copySajuForAI()" style="background:linear-gradient(135deg,#8E44AD,#3498DB);margin:5px;padding:14px 28px;font-size:15px;">
                        ğŸ“‹ Copy for Gemini / ChatGPT
                    </button>
                    <p style="font-size:0.75rem;color:var(--gray);margin-top:12px;opacity:0.8;">
                        Paste into AI for a deeply personalized narrative interpretation
                    </p>
                </div>
            </div>

            <!-- ì¢…í•© í•´ì„ -->
            <div class="card gold">
                <h3>ğŸ“– Summary Analysis</h3>
                <div id="summary-analysis"></div>
            </div>

            <!-- ===== Share Section ===== -->
            <div class="card" style="text-align:center;background:linear-gradient(135deg,rgba(212,175,55,0.1),rgba(139,90,43,0.05));border:1px solid rgba(212,175,55,0.3);">
                <p style="font-size:1.1rem;margin-bottom:8px;">âœ¨ Enjoying K-MUDANG?</p>
                <p style="font-size:0.9rem;color:var(--gray);margin-bottom:20px;">
                    Share this ancient Korean fortune wisdom with your loved ones
                </p>
                <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
                    <button class="btn" onclick="shareApp()" style="background:linear-gradient(135deg,#25D366,#128C7E);padding:12px 24px;">
                        ğŸ“¤ Share
                    </button>
                    <button class="btn" onclick="copyShareLink()" style="background:linear-gradient(135deg,#6c757d,#495057);padding:12px 24px;">
                        ğŸ”— Copy Link
                    </button>
                </div>
            </div>

            <!-- ===== Karma Offering (ë³µì±„) ===== -->
            <div class="card" style="text-align:center;background:linear-gradient(135deg,rgba(255,215,0,0.08),rgba(255,193,7,0.03));border:1px solid rgba(212,175,55,0.2);">
                <p style="font-size:1.2rem;margin-bottom:8px;">ğŸ™ Karma Offering (ç¦å‚µ)</p>
                <p style="font-size:0.9rem;color:var(--gray);line-height:1.6;margin-bottom:5px;">
                    Having received wisdom, an offering honors tradition.
                </p>
                <p style="font-size:0.85rem;color:var(--gold);margin-bottom:20px;">
                    Shared blessings return doubled.
                </p>
                <a href="https://ko-fi.com/kmudang" target="_blank" class="kofi-btn" style="display:inline-block;">
                    â˜• Offer Karma (Boost Luck)
                </a>
                <p style="font-size:0.75rem;color:var(--gray);margin-top:15px;opacity:0.7;">
                    ğŸ”’ No ads, no impure energy â€” only pure Ki (æ°£) resides here
                </p>
                <p style="font-size:0.7rem;color:var(--gray);margin-top:8px;opacity:0.5;">
                    Offerings are voluntary gestures of gratitude.
                </p>
            </div>

            <!-- ===== Classical Studies ===== -->
            <div class="card" style="text-align:center;background:linear-gradient(135deg,rgba(103,58,183,0.08),rgba(156,39,176,0.03));border:1px solid rgba(156,39,176,0.2);">
                <p style="font-size:1.1rem;margin-bottom:12px;">â˜¯ Essence of Classical Destiny Studies (ç²¾é«“)</p>
                <p style="font-size:0.85rem;color:var(--gold);margin-bottom:15px;">
                    ã€æ»´å¤©é«“ã€ Â· ã€å­å¹³çœè©®ã€ Â· ã€çª®é€šå¯¶é‘‘ã€
                </p>
                <p style="font-size:0.8rem;color:var(--gray);line-height:1.7;margin-bottom:15px;">
                    The authentic theories from three classical texts of Korean-Chinese astrology, modernized for the digital age.
                </p>
                <div style="font-size:0.75rem;color:var(--gray);opacity:0.8;line-height:1.8;">
                    <p>Perpetual Calendar (è¬æ­²æ›†) Â· Solar Terms Adjustment (ç¯€æ°£)</p>
                    <p>ç”¨ç¥(Beneficial Elements) (èª¿å€™ç”¨ç¥) Â· ç´éŸ³(Sound Element)s (ç´éŸ³äº”è¡Œ)</p>
                    <p>å‘½å®®(Life Palace) (å‘½å®®) Â· èƒå…ƒ(Conception Origin) (èƒå…ƒ) Â· æ”¯è—å¹²(Hidden Stems) (æ”¯è—å¹²)</p>
                    <p>é€šæ ¹é€å¹²(Root & Stem Analysis) (é€šæ ¹é€å¹²) Â· æ–¹åˆ(Directional Harmony) (æ–¹åˆ) Â· æš—åˆ(Hidden Harmony) (æš—åˆ)</p>
                    <p>60 Pillars æ—¥ä¸»(Day Master) Theory (å…­åç”²å­ æ—¥æŸ±è«–)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         Tab 2: POWERBALL
         ======================================== -->
    <div id="tab-powerball" class="tab-content">
        <header>
            <div class="dragon-seal">
                <svg viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="dragonGold2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700"/>
                            <stop offset="50%" style="stop-color:#FFA500"/>
                            <stop offset="100%" style="stop-color:#FFD700"/>
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="45" fill="none" stroke="url(#dragonGold2)" stroke-width="2"/>
                    <text x="50" y="58" text-anchor="middle" fill="url(#dragonGold2)" font-size="32" font-family="serif">é¾</text>
                </svg>
            </div>
            <h1>K-MUDANG</h1>
            <span class="game-title">POWERBALL</span>
            <p class="subtitle">Ancient Korean Zodiac Algorithm</p>
        </header>

        <div class="card">
            <h3>ğŸ“… Your Birth Date</h3>
            <div class="form-row" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group"><label>Month</label><select id="pb-month"></select></div>
                <div class="form-group"><label>Day</label><select id="pb-day"></select></div>
                <div class="form-group"><label>Year</label><select id="pb-year"></select></div>
            </div>
            <button class="btn" onclick="generatePowerball('destiny')">ğŸ”® Destiny Numbers</button>
            <button class="btn btn-secondary" style="margin-top:10px;" onclick="generatePowerball('quick')">ğŸ² Quick Pick</button>
        </div>

        <div class="card" id="pb-result" style="display:none;">
            <h3>ğŸ° Your Numbers</h3>
            <div class="balls-container" id="pb-balls"></div>
            
            <!-- Ko-fi Button -->
            <div class="kofi-container">
                <a href="https://ko-fi.com/kmudang" target="_blank" class="kofi-btn">
                    â˜• Offer Karma (Boost Luck)
                </a>
            </div>
        </div>

        <div class="card history-section" id="pb-history" style="display:none;">
            <h3>ğŸ“‹ History</h3>
            <div id="pb-history-list"></div>
        </div>
    </div>

    <!-- ========================================
         Tab 3: MEGA MILLIONS
         ======================================== -->
    <div id="tab-mega" class="tab-content">
        <header>
            <div class="dragon-seal">
                <svg viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="dragonGold3" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700"/>
                            <stop offset="50%" style="stop-color:#FFA500"/>
                            <stop offset="100%" style="stop-color:#FFD700"/>
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="45" fill="none" stroke="url(#dragonGold3)" stroke-width="2"/>
                    <text x="50" y="58" text-anchor="middle" fill="url(#dragonGold3)" font-size="32" font-family="serif">é¾</text>
                </svg>
            </div>
            <h1>K-MUDANG</h1>
            <span class="game-title">MEGA MILLIONS</span>
            <p class="subtitle">Ancient Korean Zodiac Algorithm</p>
        </header>

        <div class="card">
            <h3>ğŸ“… Your Birth Date</h3>
            <div class="form-row" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group"><label>Month</label><select id="mega-month"></select></div>
                <div class="form-group"><label>Day</label><select id="mega-day"></select></div>
                <div class="form-group"><label>Year</label><select id="mega-year"></select></div>
            </div>
            <button class="btn" onclick="generateMega('destiny')">ğŸ”® Destiny Numbers</button>
            <button class="btn btn-secondary" style="margin-top:10px;" onclick="generateMega('quick')">ğŸ² Quick Pick</button>
        </div>

        <div class="card" id="mega-result" style="display:none;">
            <h3>ğŸ° Your Numbers</h3>
            <div class="balls-container" id="mega-balls"></div>
            
            <!-- Ko-fi Button -->
            <div class="kofi-container">
                <a href="https://ko-fi.com/kmudang" target="_blank" class="kofi-btn">
                    â˜• Offer Karma (Boost Luck)
                </a>
            </div>
        </div>

        <div class="card history-section" id="mega-history" style="display:none;">
            <h3>ğŸ“‹ History</h3>
            <div id="mega-history-list"></div>
        </div>
    </div>

</div>

<footer>
    <p style="color:var(--gold);margin-bottom:8px;">ğŸ”’ Pursuing pure scholarly research without any advertisements</p>
    <p style="font-size:0.85rem;color:var(--gray);margin-bottom:10px;">Ancient Korean Zodiac Algorithm Â· Four Pillars of Destiny</p>
    <p style="opacity:0.5;font-size:0.8rem;">Â© 2026 K-MUDANG Pro Â· Institute of Destiny Studies (å‘½ç†ç¡ç©¶æ‰€)</p>
</footer>

<div class="toast" id="toast"></div>

<script>
/* ========================================
   1. ê¸°ì´ˆ ë°ì´í„°
   ======================================== */

// ì—­ëŒ€ ë‹¹ì²¨ë²ˆí˜¸
const PAST_WINNERS = [
[1,4,16,23,31,41],[10,23,29,33,37,40],[9,13,21,25,32,42],[11,16,19,21,27,31],[14,27,30,31,40,42],[16,24,29,40,41,42],
[14,15,26,27,40,42],[2,9,16,25,26,40],[8,19,25,34,37,39],[2,4,16,17,36,39],[9,25,30,33,41,44],[1,7,36,37,41,42],
[2,11,21,25,39,45],[22,34,36,37,42,44],[2,6,12,19,33,44],[1,4,9,23,34,45],[6,13,27,35,40,41],[4,14,22,38,39,45],
[6,8,14,21,23,38],[3,5,15,16,44,45],[8,13,14,26,28,43],[5,17,18,23,30,33],[4,5,7,9,24,42],[1,6,11,20,31,35],
[7,16,34,37,38,43],[4,9,12,14,24,44],[2,10,12,13,23,29],[2,14,16,18,28,43],[3,6,7,8,27,35],[1,5,23,24,35,37],
[9,14,20,23,33,34],[11,16,21,22,28,42],[8,18,21,27,29,45],[1,4,7,23,28,43],[3,13,24,29,34,40],[5,6,17,22,28,31],
[3,4,14,15,22,26],[1,4,15,25,29,30],[4,6,14,16,24,40],[5,6,11,22,25,38],[12,19,24,26,38,43],[5,13,26,28,41,42],
[4,16,17,21,31,45],[2,5,6,30,31,36],[1,9,16,19,21,25],[7,8,27,30,36,43],[4,10,14,27,29,41],[10,11,25,27,28,31],
[4,9,12,30,39,43],[4,13,22,24,40,42],[3,12,17,34,36,40],[1,13,22,25,34,41],[3,6,10,13,27,42],[3,4,18,30,32,35],
[6,9,11,17,18,25],[8,10,14,28,38,40],[2,8,16,21,27,44],[4,21,23,24,39,41],[2,3,5,8,18,29],[6,12,18,32,40,43]
];
const PAST_SET = new Set(PAST_WINNERS.map(arr => [...arr].sort((a,b)=>a-b).join(',')));

// ì²œê°„(å¤©å¹²)
const STEM = [
    {c:'ç”²',k:'ê°‘',e:'wood',y:true},{c:'ä¹™',k:'ì„',e:'wood',y:false},
    {c:'ä¸™',k:'ë³‘',e:'fire',y:true},{c:'ä¸',k:'ì •',e:'fire',y:false},
    {c:'æˆŠ',k:'ë¬´',e:'earth',y:true},{c:'å·±',k:'ê¸°',e:'earth',y:false},
    {c:'åºš',k:'ê²½',e:'metal',y:true},{c:'è¾›',k:'ì‹ ',e:'metal',y:false},
    {c:'å£¬',k:'ì„',e:'water',y:true},{c:'ç™¸',k:'ê³„',e:'water',y:false}
];

// ì§€ì§€(åœ°æ”¯)
const BRANCH = [
    {c:'å­',k:'ì',e:'water',a:'ì¥',m:'rat'},{c:'ä¸‘',k:'ì¶•',e:'earth',a:'ì†Œ',m:'ox'},
    {c:'å¯…',k:'ì¸',e:'wood',a:'í˜¸ë‘ì´',m:'tiger'},{c:'å¯',k:'ë¬˜',e:'wood',a:'í† ë¼',m:'rabbit'},
    {c:'è¾°',k:'ì§„',e:'earth',a:'ìš©',m:'dragon'},{c:'å·³',k:'ì‚¬',e:'fire',a:'ë±€',m:'snake'},
    {c:'åˆ',k:'ì˜¤',e:'fire',a:'ë§',m:'horse'},{c:'æœª',k:'ë¯¸',e:'earth',a:'ì–‘',m:'goat'},
    {c:'ç”³',k:'ì‹ ',e:'metal',a:'ì›ìˆ­ì´',m:'monkey'},{c:'é…‰',k:'ìœ ',e:'metal',a:'ë‹­',m:'rooster'},
    {c:'æˆŒ',k:'ìˆ ',e:'earth',a:'ê°œ',m:'dog'},{c:'äº¥',k:'í•´',e:'water',a:'ë¼ì§€',m:'pig'}
];

// æ”¯è—å¹²(Hidden Stems)(åœ°è—å¹²) - Main/Middle/Side with ì¼Water
// ê° ì§€ì§€ì— ìˆ¨ì–´ìˆëŠ” ì²œê°„ (Main=ë³¸ê¸°, Middle, Side)
// days: í•´ë‹¹ ê¸°ìš´ì´ ì‘ìš©í•˜ëŠ” ì¼Water (30ì¼ ê¸°ì¤€)
const JIJANGGAN = {
    0: [ // å­ (ì)
        {stem: 9, type: 'jung', days: 30, name: 'ç™¸(Main)'} // ê³„Water 30ì¼
    ],
    1: [ // ä¸‘ (ì¶•)
        {stem: 9, type: 'yeo', days: 9, name: 'ç™¸(Side)'},  // ê³„Water 9ì¼
        {stem: 7, type: 'jung', days: 3, name: 'è¾›(Middle)'}, // ì‹ Metal 3ì¼
        {stem: 5, type: 'jung', days: 18, name: 'å·±(Main)'} // ê¸°í†  18ì¼
    ],
    2: [ // å¯… (ì¸)
        {stem: 4, type: 'yeo', days: 7, name: 'æˆŠ(Side)'},  // ë¬´í†  7ì¼
        {stem: 2, type: 'jung', days: 7, name: 'ä¸™(Middle)'}, // ë³‘Fire 7ì¼
        {stem: 0, type: 'jung', days: 16, name: 'ç”²(Main)'} // ê°‘ëª© 16ì¼
    ],
    3: [ // å¯ (ë¬˜)
        {stem: 1, type: 'jung', days: 30, name: 'ä¹™(Main)'} // ì„ëª© 30ì¼
    ],
    4: [ // è¾° (ì§„)
        {stem: 1, type: 'yeo', days: 9, name: 'ä¹™(Side)'},  // ì„ëª© 9ì¼
        {stem: 9, type: 'jung', days: 3, name: 'ç™¸(Middle)'}, // ê³„Water 3ì¼
        {stem: 4, type: 'jung', days: 18, name: 'æˆŠ(Main)'} // ë¬´í†  18ì¼
    ],
    5: [ // å·³ (ì‚¬)
        {stem: 4, type: 'yeo', days: 5, name: 'æˆŠ(Side)'},  // ë¬´í†  5ì¼
        {stem: 6, type: 'jung', days: 9, name: 'åºš(Middle)'}, // ê²½Metal 9ì¼
        {stem: 2, type: 'jung', days: 16, name: 'ä¸™(Main)'} // ë³‘Fire 16ì¼
    ],
    6: [ // åˆ (ì˜¤)
        {stem: 5, type: 'yeo', days: 9, name: 'å·±(Side)'},  // ê¸°í†  9ì¼
        {stem: 3, type: 'jung', days: 21, name: 'ä¸(Main)'} // ì •Fire 21ì¼
    ],
    7: [ // æœª (ë¯¸)
        {stem: 3, type: 'yeo', days: 9, name: 'ä¸(Side)'},  // ì •Fire 9ì¼
        {stem: 1, type: 'jung', days: 3, name: 'ä¹™(Middle)'}, // ì„ëª© 3ì¼
        {stem: 5, type: 'jung', days: 18, name: 'å·±(Main)'} // ê¸°í†  18ì¼
    ],
    8: [ // ç”³ (ì‹ )
        {stem: 4, type: 'yeo', days: 7, name: 'æˆŠ(Side)'},  // ë¬´í†  7ì¼
        {stem: 8, type: 'jung', days: 7, name: 'å£¬(Middle)'}, // ì„Water 7ì¼
        {stem: 6, type: 'jung', days: 16, name: 'åºš(Main)'} // ê²½Metal 16ì¼
    ],
    9: [ // é…‰ (ìœ )
        {stem: 7, type: 'jung', days: 30, name: 'è¾›(Main)'} // ì‹ Metal 30ì¼
    ],
    10: [ // æˆŒ (ìˆ )
        {stem: 7, type: 'yeo', days: 9, name: 'è¾›(Side)'},  // ì‹ Metal 9ì¼
        {stem: 3, type: 'jung', days: 3, name: 'ä¸(Middle)'}, // ì •Fire 3ì¼
        {stem: 4, type: 'jung', days: 18, name: 'æˆŠ(Main)'} // ë¬´í†  18ì¼
    ],
    11: [ // äº¥ (í•´)
        {stem: 0, type: 'yeo', days: 7, name: 'ç”²(Side)'},  // ê°‘ëª© 7ì¼
        {stem: 8, type: 'jung', days: 23, name: 'å£¬(Main)'} // ì„Water 23ì¼
    ]
};

// ì˜¤í–‰
const ELEMENT = {
    wood:{c:'æœ¨',k:'Wood',n:'æœ¨(Wood)',color:'#4CAF50',icon:'ğŸŒ³',nums:[3,8,13,18,23,28,33,38,43]},
    fire:{c:'ç«',k:'Fire',n:'ç«(Fire)',color:'#F44336',icon:'ğŸ”¥',nums:[2,7,12,17,22,27,32,37,42]},
    earth:{c:'åœŸ',k:'Earth',n:'åœŸ(Earth)',color:'#FF9800',icon:'ğŸŒ',nums:[5,10,15,20,25,30,35,40,45]},
    metal:{c:'é‡‘',k:'Metal',n:'é‡‘(Metal)',color:'#9E9E9E',icon:'âš™ï¸',nums:[4,9,14,19,24,29,34,39,44]},
    water:{c:'æ°´',k:'Water',n:'æ°´(Water)',color:'#2196F3',icon:'ğŸ’§',nums:[1,6,11,16,21,26,31,36,41]}
};
const EL_ORDER = ['wood','fire','earth','metal','water'];

// æ–¹åˆ(Directional Harmony)(æ–¹åˆ) - ê°™ì€ ë°©í–¥ 3ì§€ì§€ê°€ ëª¨ì—¬ ê°•ë ¥í•œ ì˜¤í–‰ í˜•ì„±
const BANGHAP = [
    {branches: [2,3,4], element: 'wood', name: 'å¯…å¯è¾°(Tiger-Rabbit-Dragon) æ–¹åˆ(Directional Harmony)', dir: 'Eastern Wood Direction'},   // å¯…å¯è¾°
    {branches: [5,6,7], element: 'fire', name: 'å·³åˆæœª(Snake-Horse-Goat) æ–¹åˆ(Directional Harmony)', dir: 'Southern Fire'},   // å·³åˆæœª
    {branches: [8,9,10], element: 'metal', name: 'ç”³é…‰æˆŒ(Monkey-Rooster-Dog) æ–¹åˆ(Directional Harmony)', dir: 'Western Metal Direction'}, // ç”³é…‰æˆŒ
    {branches: [11,0,1], element: 'water', name: 'äº¥å­ä¸‘(Pig-Rat-Ox) æ–¹åˆ(Directional Harmony)', dir: 'Northern Water Direction'}  // äº¥å­ä¸‘
];

// æš—åˆ(Hidden Harmony)(æš—åˆ) - æ”¯è—å¹²(Hidden Stems)ë¼ë¦¬ì˜ ìˆ¨ì€ Harmony
const AMHAP = [
    {a: 2, b: 1, name: 'å¯…ä¸‘(Tiger-Ox) æš—åˆ(Hidden Harmony)', desc: 'å¯…(Tiger) contains Bing(ä¸™) harmonizing with ä¸‘(Ox) Xin(è¾›)'},    // å¯…-ä¸‘
    {a: 3, b: 8, name: 'å¯ç”³(Rabbit-Monkey) æš—åˆ(Hidden Harmony)', desc: 'å¯(Rabbit) contains Yi(ä¹™) harmonizing with ç”³(Monkey) Geng(åºš)'},    // å¯-ç”³
    {a: 4, b: 9, name: 'è¾°é…‰(Dragon-Rooster) æš—åˆ(Hidden Harmony)', desc: 'è¾°(Dragon) contains Yi(ä¹™) harmonizing with é…‰(Rooster) Geng(åºš)'},    // è¾°-é…‰
    {a: 5, b: 8, name: 'å·³ç”³(Snake-Monkey) æš—åˆ(Hidden Harmony)', desc: 'å·³(Snake) contains Bing(ä¸™) harmonizing with ç”³(Monkey) Geng(åºš)'},    // å·³-ç”³
    {a: 6, b: 1, name: 'åˆä¸‘(Horse-Ox) æš—åˆ(Hidden Harmony)', desc: 'åˆ(Horse) contains Ding(ä¸) harmonizing with ä¸‘(Ox) Ji(å·±)'},    // åˆ-ä¸‘
    {a: 6, b: 11, name: 'åˆäº¥(Horse-Pig) æš—åˆ(Hidden Harmony)', desc: 'åˆ(Horse) contains Ding(ä¸) harmonizing with äº¥(Pig) Ren(å£¬)'}    // åˆ-äº¥
];

// Sound-Element (ç´éŸ³) - Cosmic resonance of the 60 Pillars
const NAPEUM = [
    {name: 'Sea Metal (æµ·ä¸­é‡‘)', element: 'metal', nameK: 'í•´ì¤‘ê¸ˆ', desc: 'Gold hidden beneath the ocean. A treasure waiting to be discovered within your soul.'},
    {name: 'Furnace Fire (çˆä¸­ç«)', element: 'fire', nameK: 'ë…¸ì¤‘í™”', desc: 'Flames within the forge. Your spirit transforms raw potential into refined greatness.'},
    {name: 'Forest Wood (å¤§æ—æœ¨)', element: 'wood', nameK: 'ëŒ€ë¦¼ëª©', desc: 'Towering trees of a great forest. Your presence commands respect and admiration.'},
    {name: 'Roadside Earth (è·¯å‚åœŸ)', element: 'earth', nameK: 'ë…¸ë°©í† ', desc: 'Earth along the path. You adapt gracefully wherever life takes you.'},
    {name: 'Sword Metal (åŠé‹’é‡‘)', element: 'metal', nameK: 'ê²€ë´‰ê¸ˆ', desc: 'The blade\'s edge. Sharp intuition and decisive action define your spirit.'},
    {name: 'Mountain Fire (å±±é ­ç«)', element: 'fire', nameK: 'ì‚°ë‘í™”', desc: 'Fire upon the peak. Lofty aspirations burn bright within you.'},
    {name: 'Valley Water (æ¾—ä¸‹æ°´)', element: 'water', nameK: 'ê°„í•˜ìˆ˜', desc: 'Crystal stream in the valley. Pure wisdom flows through your being.'},
    {name: 'Fortress Earth (åŸé ­åœŸ)', element: 'earth', nameK: 'ì„±ë‘í† ', desc: 'Earth of castle walls. Unwavering strength protects what you cherish.'},
    {name: 'Wax Metal (ç™½è Ÿé‡‘)', element: 'metal', nameK: 'ë°±ëê¸ˆ', desc: 'Polished precious metal. Refined elegance marks your every endeavor.'},
    {name: 'Willow Wood (æ¥ŠæŸ³æœ¨)', element: 'wood', nameK: 'ì–‘ë¥˜ëª©', desc: 'The graceful willow. Flexibility and beauty dance within your nature.'},
    {name: 'Spring Water (æ³‰ä¸­æ°´)', element: 'water', nameK: 'ì²œì¤‘ìˆ˜', desc: 'Ever-flowing spring. Boundless vitality rises from your depths.'},
    {name: 'Roof Earth (å±‹ä¸ŠåœŸ)', element: 'earth', nameK: 'ì˜¥ìƒí† ', desc: 'Earth upon the roof. You shelter and protect those you love.'},
    {name: 'Thunder Fire (éœ¹é‚ç«)', element: 'fire', nameK: 'ë²½ë ¥í™”', desc: 'Lightning\'s fire. Explosive brilliance illuminates your path.'},
    {name: 'Pine Wood (æ¾æ ¢æœ¨)', element: 'wood', nameK: 'ì†¡ë°±ëª©', desc: 'Evergreen pine. Eternal integrity through all seasons of life.'},
    {name: 'River Water (é•·æµæ°´)', element: 'water', nameK: 'ì¥ë¥˜ìˆ˜', desc: 'The long river. Your influence flows far and wide with gentle persistence.'},
    {name: 'Sand Metal (ç ‚ä¸­é‡‘)', element: 'metal', nameK: 'ì‚¬ì¤‘ê¸ˆ', desc: 'Gold within the sand. Hidden talents await their moment to shine.'},
    {name: 'Foothill Fire (å±±ä¸‹ç«)', element: 'fire', nameK: 'ì‚°í•˜í™”', desc: 'Fire at mountain\'s base. Dormant power ready to ignite.'},
    {name: 'Plain Wood (å¹³åœ°æœ¨)', element: 'wood', nameK: 'í‰ì§€ëª©', desc: 'Trees of the plains. Your influence spreads across vast horizons.'},
    {name: 'Wall Earth (å£ä¸ŠåœŸ)', element: 'earth', nameK: 'ë²½ìƒí† ', desc: 'Earth upon walls. Artistic sensibility adorns your soul.'},
    {name: 'Gilded Metal (é‡‘ç®”é‡‘)', element: 'metal', nameK: 'ê¸ˆë°•ê¸ˆ', desc: 'Precious gold leaf. Dazzling beauty with delicate grace.'},
    {name: 'Lantern Fire (è¦†ç‡ˆç«)', element: 'fire', nameK: 'ë³µë“±í™”', desc: 'Light of the lantern. Wisdom that illuminates the darkness for others.'},
    {name: 'Celestial Water (å¤©æ²³æ°´)', element: 'water', nameK: 'ì²œí•˜ìˆ˜', desc: 'Waters of the Milky Way. Cosmic dreams flow through your consciousness.'},
    {name: 'Crossroad Earth (å¤§é©›åœŸ)', element: 'earth', nameK: 'ëŒ€ì—­í† ', desc: 'Earth of the great station. Connection and exchange define your purpose.'},
    {name: 'Ornament Metal (é‡µé‡§é‡‘)', element: 'metal', nameK: 'ì°¨ì²œê¸ˆ', desc: 'Precious hairpin. Nobility and elegance grace your presence.'},
    {name: 'Mulberry Wood (æ¡‘æŸ˜æœ¨)', element: 'wood', nameK: 'ìƒìëª©', desc: 'The mulberry tree. Practical wisdom yields abundant blessings.'},
    {name: 'Canyon Water (å¤§æºªæ°´)', element: 'water', nameK: 'ëŒ€ê³„ìˆ˜', desc: 'Waters of the great canyon. Depth and breadth define your spirit.'},
    {name: 'Desert Earth (ç ‚ä¸­åœŸ)', element: 'earth', nameK: 'ì‚¬ì¤‘í† ', desc: 'Earth within sand. Patient foundation-building brings lasting success.'},
    {name: 'Heavenly Fire (å¤©ä¸Šç«)', element: 'fire', nameK: 'ì²œìƒí™”', desc: 'Fire in the heavens â€” the Sun itself. Your radiance touches all around you.'},
    {name: 'Pomegranate Wood (çŸ³æ¦´æœ¨)', element: 'wood', nameK: 'ì„ë¥˜ëª©', desc: 'The pomegranate tree. Abundant fruits of your labor await harvest.'},
    {name: 'Ocean Water (å¤§æµ·æ°´)', element: 'water', nameK: 'ëŒ€í•´ìˆ˜', desc: 'The vast ocean. Infinite capacity to embrace all of life\'s currents.'}
];

// ê³„ì ˆ
const SEASON = {0:'winter',1:'winter',2:'spring',3:'spring',4:'spring',5:'summer',6:'summer',7:'summer',8:'autumn',9:'autumn',10:'autumn',11:'winter'};

// åç¥(Ten Gods) (åç¥) - The cosmic influences shaping your destiny
const TEN_GODS = {
    bijeon:{k:'æ¯”è‚©(Peer)',c:'æ¯”è‚©',d:'Your cosmic twin. Confidence, independence, and the spirit of brotherhood flow through you.'},
    geupjae:{k:'åŠ«è²¡(Rob Wealth)',c:'åŠ«è²¡',d:'The challenger. Fierce competitive fire burns within â€” channel it wisely to avoid loss.'},
    siksin:{k:'é£Ÿç¥(Eating God)',c:'é£Ÿç¥',d:'The muse within. Creative genius and abundant fortune bless your endeavors.'},
    sanggwan:{k:'å‚·å®˜(Hurting Officer)',c:'å‚·å®˜',d:'The rebel artist. Brilliant expression flows freely â€” temper sharp words with wisdom.'},
    pyeonjae:{k:'åè²¡(Indirect Wealth)',c:'åè²¡',d:'Fortune\'s wild card. Business acumen brings windfall â€” guard against restless heart.'},
    jeongjae:{k:'æ­£è²¡(Direct Wealth)',c:'æ­£è²¡',d:'Honest prosperity. Patient accumulation and steady hands build lasting wealth.'},
    pyeongwan:{k:'åå®˜(Seven Killings)',c:'åå®˜',d:'The warrior spirit. Fierce drive conquers obstacles â€” balance ambition with peace.'},
    jeonggwan:{k:'æ­£å®˜(Direct Officer)',c:'æ­£å®˜',d:'Noble authority. Honor and recognition flow to those who walk with dignity.'},
    pyeonin:{k:'åå°(Indirect Seal)',c:'åå°',d:'The mystic mind. Unconventional wisdom and hidden knowledge guide your path.'},
    jeongin:{k:'æ­£å°(Direct Seal)',c:'æ­£å°',d:'Heaven\'s blessing. Academic fortune and elder support illuminate your journey.'}
};

// åäºŒé‹æ˜Ÿ(Twelve Life Stages) (åäºŒé‹æ˜Ÿ) - The cycle of cosmic energy
const TWELVE_STATES = [
    {k:'é•·ç”Ÿ(Birth)',l:12,d:'New life awakens. Fresh beginnings and infinite hope bless this phase.'},
    {k:'æ²æµ´(Bath)',l:8,d:'The cleansing waters. Transformation brings temporary instability before renewal.'},
    {k:'å† å¸¶(Crown)',l:10,d:'Rising energy. Growth accelerates as opportunities unfold before you.'},
    {k:'è‡¨å®˜(Official)',l:11,d:'Peak vitality. Maximum energy propels you toward your greatest achievements.'},
    {k:'å¸æ—º(Peak)',l:12,d:'The summit. Power and status reach their zenith under heaven\'s favor.'},
    {k:'è¡°(Decline)',l:7,d:'Gentle descent. Wisdom accumulates as you embrace graceful transition.'},
    {k:'ç—…(Illness)',l:4,d:'Waning strength. Rest and reflection restore what ambition has spent.'},
    {k:'æ­»(Death)',l:3,d:'Completion approaches. Honor endings as you prepare for rebirth.'},
    {k:'å¢“(Tomb)',l:2,d:'The hidden phase. Inner cultivation in silence precedes emergence.'},
    {k:'çµ¶(Cut)',l:1,d:'Complete emptiness. From the void, new possibilities are born.'},
    {k:'èƒ(Conception)',l:5,d:'Life stirs. Seeds of future potential take root in cosmic soil.'},
    {k:'é¤Š(Nurture)',l:6,d:'Gentle growth. Patient development builds strength for the journey ahead.'}
];

// ì ˆê¸° ë°ì´í„° (1950-2050)
const SOLAR_TERMS = {
    1950:[{m:2,d:4,h:16,n:52},{m:3,d:6,h:10,n:36},{m:4,d:5,h:15,n:1},{m:5,d:6,h:3,n:8},{m:6,d:6,h:7,n:18},{m:7,d:7,h:17,n:53},{m:8,d:8,h:3,n:32},{m:9,d:8,h:6,n:7},{m:10,d:8,h:21,n:43},{m:11,d:8,h:0,n:21},{m:12,d:7,h:17,n:8}],
    1960:[{m:2,d:5,h:4,n:23},{m:3,d:5,h:22,n:7},{m:4,d:5,h:2,n:30},{m:5,d:5,h:14,n:36},{m:6,d:5,h:18,n:45},{m:7,d:7,h:5,n:19},{m:8,d:7,h:14,n:58},{m:9,d:7,h:17,n:32},{m:10,d:8,h:9,n:8},{m:11,d:7,h:11,n:47},{m:12,d:7,h:4,n:33}],
    1970:[{m:2,d:4,h:16,n:46},{m:3,d:6,h:10,n:29},{m:4,d:5,h:14,n:51},{m:5,d:6,h:2,n:55},{m:6,d:6,h:7,n:2},{m:7,d:7,h:17,n:35},{m:8,d:8,h:3,n:14},{m:9,d:8,h:5,n:48},{m:10,d:8,h:21,n:23},{m:11,d:8,h:0,n:1},{m:12,d:7,h:16,n:48}],
    1980:[{m:2,d:5,h:4,n:10},{m:3,d:5,h:21,n:51},{m:4,d:5,h:2,n:10},{m:5,d:5,h:14,n:11},{m:6,d:5,h:18,n:16},{m:7,d:7,h:4,n:47},{m:8,d:7,h:14,n:26},{m:9,d:7,h:16,n:59},{m:10,d:8,h:8,n:35},{m:11,d:7,h:11,n:14},{m:12,d:7,h:4,n:0}],
    1990:[{m:2,d:4,h:15,n:14},{m:3,d:6,h:8,n:53},{m:4,d:5,h:13,n:9},{m:5,d:6,h:1,n:8},{m:6,d:6,h:5,n:12},{m:7,d:7,h:15,n:42},{m:8,d:8,h:1,n:20},{m:9,d:8,h:3,n:53},{m:10,d:8,h:19,n:28},{m:11,d:7,h:22,n:6},{m:12,d:7,h:14,n:52}],
    2000:[{m:2,d:4,h:20,n:32},{m:3,d:5,h:14,n:14},{m:4,d:4,h:18,n:32},{m:5,d:5,h:6,n:31},{m:6,d:5,h:10,n:35},{m:7,d:7,h:21,n:2},{m:8,d:7,h:6,n:39},{m:9,d:7,h:9,n:11},{m:10,d:8,h:0,n:45},{m:11,d:7,h:3,n:22},{m:12,d:7,h:20,n:7}],
    2010:[{m:2,d:4,h:7,n:42},{m:3,d:6,h:1,n:21},{m:4,d:5,h:5,n:36},{m:5,d:5,h:17,n:33},{m:6,d:5,h:21,n:37},{m:7,d:7,h:8,n:6},{m:8,d:7,h:17,n:45},{m:9,d:7,h:20,n:17},{m:10,d:8,h:11,n:51},{m:11,d:7,h:14,n:28},{m:12,d:7,h:7,n:13}],
    2020:[{m:2,d:4,h:18,n:3},{m:3,d:5,h:11,n:43},{m:4,d:4,h:16,n:0},{m:5,d:5,h:3,n:57},{m:6,d:5,h:8,n:1},{m:7,d:6,h:18,n:30},{m:8,d:7,h:4,n:8},{m:9,d:7,h:6,n:40},{m:10,d:8,h:22,n:14},{m:11,d:7,h:0,n:51},{m:12,d:7,h:17,n:36}],
    2025:[{m:2,d:3,h:23,n:10},{m:3,d:5,h:16,n:47},{m:4,d:4,h:21,n:2},{m:5,d:5,h:8,n:57},{m:6,d:5,h:13,n:0},{m:7,d:6,h:23,n:28},{m:8,d:7,h:9,n:6},{m:9,d:7,h:11,n:37},{m:10,d:8,h:3,n:11},{m:11,d:7,h:5,n:48},{m:12,d:7,h:22,n:33}],
    2026:[{m:2,d:4,h:5,n:2},{m:3,d:5,h:22,n:38},{m:4,d:5,h:2,n:52},{m:5,d:5,h:14,n:48},{m:6,d:5,h:18,n:51},{m:7,d:7,h:5,n:20},{m:8,d:7,h:14,n:58},{m:9,d:7,h:17,n:29},{m:10,d:8,h:9,n:3},{m:11,d:7,h:11,n:40},{m:12,d:7,h:4,n:25}],
    2030:[{m:2,d:4,h:16,n:38},{m:3,d:6,h:10,n:14},{m:4,d:5,h:14,n:28},{m:5,d:6,h:2,n:24},{m:6,d:6,h:6,n:28},{m:7,d:7,h:16,n:57},{m:8,d:8,h:2,n:36},{m:9,d:8,h:5,n:8},{m:10,d:8,h:20,n:42},{m:11,d:7,h:23,n:19},{m:12,d:7,h:16,n:5}]
};

// ìŒë ¥ ë°ì´í„°
const LUNAR_DATA=[0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052d0,0x0a9a8,0x0e950,0x06aa0,0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b5a0,0x195a6,0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x055c0,0x0ab60,0x096d5,0x092e0,0x0c960,0x0d954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930,0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0x0ea65,0x0d530,0x05aa0,0x076a3,0x096d0,0x04bd7,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45,0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0];
const LUNAR_START = 1900;

// ê³„ì¢Œ ì •ë³´
const MY_ACCOUNT = "ì¼€ì´ë±…í¬ 100150462483 ê¹€ëŒ€ì¸";

/* ========================================
   2. ë‹¤êµ­ì–´
   ======================================== */

/* ========================================
   3. ì „ì—­ ìƒíƒœ
   ======================================== */
let GENDER = 'm';
let CALENDAR = 'solar';
let SAJU = null;
let GODS = null;
let BIRTH_YEAR = null;
let currentNumbers = [];
let history = [];

/* ========================================
   3-1. ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ê¸°ëŠ¥
   ======================================== */
// ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” (ì‹¤ì œ ë°°í¬ ì‹œ JavaScript í‚¤ë¡œ êµì²´ í•„ìš”)
// https://developers.kakao.com ì—ì„œ ì•± ë“±ë¡ í›„ JavaScript í‚¤ ë°œê¸‰
const KAKAO_KEY = 'YOUR_KAKAO_JAVASCRIPT_KEY'; // TODO: ì‹¤ì œ í‚¤ë¡œ êµì²´

function initKakao() {
    if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
        try {
            Kakao.init(KAKAO_KEY);
            console.log('Kakao SDK initialized');
        } catch(e) {
            console.log('Kakao init skipped (key not set)');
        }
    }
}

function shareKakao() {
    const shareData = {
        title: 'ğŸ€ ì‚¬ì£¼ë¡œë˜ Pro',
        text: 'ì²œë…„ ëª…ë¦¬í•™ì˜ ì§€í˜œë¥¼ í˜„ëŒ€ì ìœ¼ë¡œ êµ¬í˜„í•œ ì‚¬ì£¼ ë¶„ì„ ì•±\n\nâœ¨ ì „ë¬¸ê°€ Waterì¤€ ì‚¬ì£¼íŒ”ì ë¶„ì„\nğŸ’• ê³¼í•™ì  ê¶í•© ì§„ë‹¨\nğŸ€ ì—­ëŒ€ ë‹¹ì²¨ë²ˆí˜¸ ì œì™¸ ë¡œë˜',
        url: window.location.href
    };
    
    // 1. Web Share API ì§€ì› ì‹œ (ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €)
    if (navigator.share) {
        navigator.share(shareData)
            .then(() => toast('Shared successfully! ğŸ‰'))
            .catch((err) => {
                if (err.name !== 'AbortError') {
                    copyShareLink();
                }
            });
        return;
    }
    
    // 2. ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”ëœ ê²½ìš°
    if (typeof Kakao !== 'undefined' && Kakao.isInitialized()) {
        try {
            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: 'ğŸ€ ì‚¬ì£¼ë¡œë˜ Pro',
                    description: getShareText(),
                    imageUrl: getShareImageUrl(),
                    link: {
                        mobileWebUrl: window.location.href,
                        webUrl: window.location.href
                    }
                },
                buttons: [{
                    title: 'ë‚˜ë„ ìš´ì„¸ ë³´ê¸°',
                    link: {
                        mobileWebUrl: window.location.href,
                        webUrl: window.location.href
                    }
                }]
            });
            return;
        } catch(e) {
            console.error('Kakao share error:', e);
        }
    }
    
    // 3. í´ë°±: ë§í¬ ë³µì‚¬
    copyShareLink();
}

function getShareText() {
    return `Ancient Korean Four Pillars wisdom, modernized for today

âœ¨ Professional-level destiny analysis
ğŸ€ Destiny-based lottery numbers
â˜¯ 1000-year-old Korean astrology

Unlock the secrets of your fate ğŸ”®`;
}

function getShareImageUrl() {
    return 'https://raw.githubusercontent.com/shrmsdl-netizen/k-mudang/main/og-image.png';
}

function shareApp() {
    const shareData = {
        title: 'ğŸ”® K-MUDANG Pro - Ancient Korean Fortune',
        text: 'Discover your destiny with authentic Four Pillars analysis + Lucky lottery numbers!',
        url: window.location.href
    };
    
    if (navigator.share) {
        navigator.share(shareData)
            .then(() => toast('Shared successfully! ğŸ‰'))
            .catch(() => copyShareLink());
    } else {
        copyShareLink();
    }
}

function copyShareLink() {
    const text = `ğŸ”® K-MUDANG Pro - Ancient Korean Fortune

âœ¨ AI-Powered Four Pillars Analysis
ğŸ€ Destiny-Based Lottery Numbers
â˜¯ 1000-Year-Old Korean Wisdom

ğŸ‘‰ ${window.location.href}`;

    navigator.clipboard.writeText(text).then(() => {
        toast('ğŸ“‹ Link copied to clipboard!');
    }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        toast('ğŸ“‹ Link copied to clipboard!');
    });
}

/* ========================================
   4. ì´ˆê¸°í™”
   ======================================== */
function init() {
    // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
    initKakao();
    
    const cy = new Date().getFullYear();
    
    // ìƒë…„ì›”ì¼ ì…€ë ‰íŠ¸ ì´ˆê¸°í™”
    ['birth-year', 'partner-year'].forEach(id => {
        const el = document.getElementById(id);
        if (el) for (let i = cy; i >= 1940; i--) el.innerHTML += `<option value="${i}">${i}</option>`;
    });
    
    ['birth-month', 'partner-month'].forEach(id => {
        const el = document.getElementById(id);
        if (el) for (let i = 1; i <= 12; i++) el.innerHTML += `<option value="${i}">${i}</option>`;
    });
    
    ['birth-day', 'partner-day'].forEach(id => {
        const el = document.getElementById(id);
        if (el) for (let i = 1; i <= 31; i++) el.innerHTML += `<option value="${i}">${i}</option>`;
    });
    
    // ì‹œê°„ ì…€ë ‰íŠ¸
    const hourEl = document.getElementById('birth-hour');
    if (hourEl) {
        const hours = ['å­æ™‚(23:30-01:29)','ä¸‘æ™‚(01:30-03:29)','å¯…æ™‚(03:30-05:29)','å¯æ™‚(05:30-07:29)',
                       'è¾°æ™‚(07:30-09:29)','å·³æ™‚(09:30-11:29)','åˆæ™‚(11:30-13:29)','æœªæ™‚(13:30-15:29)',
                       'ç”³æ™‚(15:30-17:29)','é…‰æ™‚(17:30-19:29)','æˆŒæ™‚(19:30-21:29)','äº¥æ™‚(21:30-23:29)'];
        hours.forEach((t, i) => hourEl.innerHTML += `<option value="${i}">${t}</option>`);
        hourEl.innerHTML += `<option value="-1">ëª¨ë¦„</option>`;
    }
    
    // í†µê³„ ì—…ë°ì´íŠ¸
    // ì´ˆê¸°í™” ì™„ë£Œ
}

document.addEventListener('DOMContentLoaded', init);

/* ========================================
   5. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
   ======================================== */
function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

function getBallColor(n) {
    if (n <= 10) return 'y';
    if (n <= 20) return 'b';
    if (n <= 30) return 'r';
    if (n <= 40) return 'g';
    return 'p';
}

function createBall(n, sm = false) {
    return `<div class="ball ${sm ? 'sm' : ''} ${getBallColor(n)}">${n}</div>`;
}

function setGender(g) {
    GENDER = g;
    document.querySelectorAll('[data-gender]').forEach(b => b.classList.toggle('on', b.dataset.gender === g));
}

function setCalendar(c) {
    CALENDAR = c;
    document.querySelectorAll('[data-cal]').forEach(b => b.classList.toggle('on', b.dataset.cal === c));
}

function switchTab(name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.top-nav button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-footer').forEach(f => f.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    document.getElementById('footer-' + name)?.classList.add('active');
    event.currentTarget.classList.add('active');
}

function showFortune(type) {
    document.querySelectorAll('#fortune-tabs .sub-tab').forEach(t => t.classList.remove('on'));
    event.currentTarget.classList.add('on');
    renderFortune(type);
}

/* ========================================
   6. ë¡œë˜ ë²ˆí˜¸ ìƒì„±
   ======================================== */
function generateLotto() {
    try {
        const container = document.getElementById('lotto-balls');
        if (!container) { toast('Screen error'); return; }
        
        const btn = event?.currentTarget;
        if (btn) {
            btn.disabled = true;
            btn.textContent = 'ğŸ² ì¶”ì²¨ ì¤‘...';
        }
        
        let counter = 0;
        const interval = setInterval(() => {
            const temp = Array.from({length: 6}, () => Math.floor(Math.random() * 45) + 1);
            container.innerHTML = temp.map(n => createBall(n)).join('');
            counter++;
            
            if (counter > 15) {
                clearInterval(interval);
                
                let nums, attempts = 0;
                do {
                    const pool = Array.from({length: 45}, (_, i) => i + 1);
                    nums = [];
                    for (let i = 0; i < 6; i++) {
                        const idx = Math.floor(Math.random() * pool.length);
                        nums.push(pool.splice(idx, 1)[0]);
                    }
                    nums.sort((a, b) => a - b);
                    attempts++;
                } while (PAST_SET.has(nums.join(',')) && attempts < 1000);
                
                currentNumbers = nums;
                container.innerHTML = nums.map(n => createBall(n)).join('');
                
                history.unshift(nums);
                if (history.length > 5) history.pop();
                
                document.getElementById('history-card').style.display = 'block';
                document.getElementById('history-list').innerHTML = history.map(h =>
                    `<div class="history-item">${h.map(n => createBall(n, true)).join('')}</div>`
                ).join('');
                
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ² í–‰ìš´ì˜ ë²ˆí˜¸ ìƒì„±';
                }
                
                if (SAJU) showTodayFortune();
            }
        }, 50);
    } catch (error) {
        console.error('ë¡œë˜ ìƒì„± ì˜¤ë¥˜:', error);
        toast('ë²ˆí˜¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function generateSajuLotto() {
    try {
        if (!GODS) { toast('Please analyze your Four Pillars first'); return; }
        
        const container = document.getElementById('saju-lotto-balls');
        if (!container) { toast('Screen error'); return; }
        
        const yongNums = ELEMENT[GODS.yong]?.nums || [];
        const heeNums = ELEMENT[GODS.hee]?.nums || [];
        const giNums = ELEMENT[GODS.gi]?.nums || [];
        
        let weightedPool = [];
        for (let i = 1; i <= 45; i++) {
            let weight = 1;
            if (yongNums.includes(i)) weight = 3;
            else if (heeNums.includes(i)) weight = 2;
            else if (giNums.includes(i)) weight = 0.5;
            for (let j = 0; j < weight * 2; j++) weightedPool.push(i);
        }
        
        let nums = [], attempts = 0;
        do {
            const selected = new Set();
            while (selected.size < 6) {
                const idx = Math.floor(Math.random() * weightedPool.length);
                selected.add(weightedPool[idx]);
            }
            nums = [...selected].sort((a, b) => a - b);
            attempts++;
        } while (PAST_SET.has(nums.join(',')) && attempts < 1000);
        
        currentNumbers = nums;
        container.innerHTML = nums.map(n => createBall(n)).join('');
        
        const yongCount = nums.filter(n => yongNums.includes(n)).length;
        toast(`ìš©ì‹ (${ELEMENT[GODS.yong].k}) ${yongCount}ê°œ í¬í•¨!`);
    } catch (error) {
        console.error('ì‚¬ì£¼ ë¡œë˜ ìƒì„± ì˜¤ë¥˜:', error);
        toast('ë²ˆí˜¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

/* ========================================
   7. ìŒë ¥/ì‹œì°¨ ë³´ì •
   ======================================== */
function lunarToSolar(ly, lm, ld) {
    // ê°„ì†ŒFireëœ ìŒë ¥ ë³€í™˜ (ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ë” ì •í™•í•œ ë°ì´í„° í•„ìš”)
    return { year: ly, month: lm, day: ld };
}

function adjustTime(y, m, d, h) {
    if (h < 0) return { y, m, d, h };
    let hour = h;
    const isDST = ((y >= 1948 && y <= 1951) || (y >= 1955 && y <= 1960) || (y >= 1987 && y <= 1988));
    if (isDST) hour -= 1;
    hour = hour - 0.5; // 30ë¶„ ë³´ì •
    if (hour < 0) { hour += 12; d -= 1; }
    if (d < 1) { m -= 1; if (m < 1) { m = 12; y -= 1; } d = 28; }
    return { y, m, d, h: Math.floor(hour) };
}

/* ========================================
   8. ì‚¬ì£¼ ê³„ì‚°
   ======================================== */
function calcYearPillar(y, m, d) {
    let adjY = y;
    if (m < 2 || (m === 2 && d < 4)) adjY--;
    const si = (adjY - 4) % 10;
    const bi = (adjY - 4) % 12;
    return { s: STEM[si < 0 ? si + 10 : si], b: BRANCH[bi < 0 ? bi + 12 : bi] };
}

function calcMonthPillar(y, m, d) {
    let adjM = m;
    if (d < 5) adjM--;
    if (adjM <= 0) { adjM = 12; y--; }
    const yp = calcYearPillar(y, m, d);
    const ysi = STEM.indexOf(yp.s);
    const msi = ((ysi % 5) * 2 + adjM + 1) % 10;
    const mbi = (adjM + 1) % 12;
    return { s: STEM[msi], b: BRANCH[mbi] };
}

function calcDayPillar(y, m, d) {
    const a = Math.floor((14 - m) / 12);
    const adjY = y + 4800 - a;
    const adjM = m + 12 * a - 3;
    const jdn = d + Math.floor((153 * adjM + 2) / 5) + 365 * adjY + Math.floor(adjY / 4) - Math.floor(adjY / 100) + Math.floor(adjY / 400) - 32045;
    const baseJdn = 2415021;
    const diff = jdn - baseJdn;
    return { s: STEM[((diff % 10) + 10) % 10], b: BRANCH[((diff % 12) + 12) % 12] };
}

function calcHourPillar(dayStem, h) {
    if (h < 0) return null;
    const hbi = h;
    const dsi = STEM.indexOf(dayStem);
    const hsi = (dsi * 2 + hbi) % 10;
    return { s: STEM[hsi], b: BRANCH[hbi] };
}

/* ========================================
   9. æ”¯è—å¹²(Hidden Stems)/ì‹­ì‹ /12ìš´ì„±/StrongWeak
   ======================================== */

/* ----------------------------------------
   9-1. æ”¯è—å¹²(Hidden Stems)(åœ°è—å¹²) ì™„ì „ ë¶„ì„
   ---------------------------------------- */
function analyzeJijanggan(saju) {
    const dm = saju.day.s;
    const dmi = STEM.indexOf(dm);
    const result = { pillars: [], summary: { elements: {wood:0,fire:0,earth:0,metal:0,water:0}, gods: {}, tougans: [] } };
    
    const pillarNames = ['Year Branch', 'Month Branch', 'Day Branch', 'Hour Branch'];
    const branches = [saju.year?.b, saju.month?.b, saju.day?.b, saju.hour?.b];
    const stems = [saju.year?.s, saju.month?.s, saju.day?.s, saju.hour?.s];
    
    branches.forEach((branch, pIdx) => {
        if (!branch) return;
        const bi = BRANCH.indexOf(branch);
        const jj = JIJANGGAN[bi];
        
        const pillarInfo = {
            name: pillarNames[pIdx],
            branch: branch,
            hidden: []
        };
        
        jj.forEach((h, hIdx) => {
            const hiddenStem = STEM[h.stem];
            const god = getTenGod(hiddenStem, dm);
            const isJunggi = hIdx === jj.length - 1; // ë§ˆì§€ë§‰ì´ Main
            
            // Stem Emergence (Tu-gan) ì²´í¬ - æ”¯è—å¹²(Hidden Stems)ì´ ì²œê°„ì— ë‚˜íƒ€ë‚¬ëŠ”ì§€
            const tougan = stems.some((s, si) => s && STEM.indexOf(s) === h.stem);
            
            // Root Connection (Tong-geun) ì²´í¬ - ì²œê°„ì´ æ”¯è—å¹²(Hidden Stems)ì— ë¿Œë¦¬ë¥¼ ë‘ì—ˆëŠ”ì§€
            const tonggeun = stems.some((s, si) => {
                if (!s) return false;
                return STEM.indexOf(s) === h.stem;
            });
            
            const hiddenInfo = {
                stem: hiddenStem,
                type: isJunggi ? 'Main' : (hIdx === 0 ? 'Side' : 'Middle'),
                days: h.days,
                god: god,
                tougan: tougan,
                tonggeun: tonggeun,
                strength: isJunggi ? 1.0 : (hIdx === 0 ? 0.3 : 0.5) // Main:1.0, Middle:0.5, Side:0.3
            };
            
            pillarInfo.hidden.push(hiddenInfo);
            
            // ìš”ì•½ ì§‘ê³„
            result.summary.elements[hiddenStem.e] += hiddenInfo.strength;
            if (!result.summary.gods[god.k]) result.summary.gods[god.k] = 0;
            result.summary.gods[god.k] += hiddenInfo.strength;
            
            // íˆ¬ê°„ ê¸°ë¡
            if (tougan && !result.summary.tougans.find(t => t.stem === h.stem)) {
                result.summary.tougans.push({ 
                    stem: h.stem, 
                    name: hiddenStem.c + hiddenStem.k, 
                    from: pillarNames[pIdx],
                    god: god.k
                });
            }
        });
        
        result.pillars.push(pillarInfo);
    });
    
    return result;
}

/* ----------------------------------------
   9-2. í†µê·¼/íˆ¬ê°„ ë¶„ì„
   ---------------------------------------- */
function analyzeTonggeunTougan(saju) {
    const result = { tonggeun: [], tougan: [] };
    const dm = saju.day.s;
    const pillarNames = ['å¹´æŸ±(å¹´æŸ±(Year Pillar))', 'Month', 'Day', 'Hour'];
    const branches = [saju.year?.b, saju.month?.b, saju.day?.b, saju.hour?.b];
    const stems = [saju.year?.s, saju.month?.s, saju.day?.s, saju.hour?.s];
    
    // ê° ì²œê°„ì— ëŒ€í•´ í†µê·¼ ì—¬ë¶€ ì²´í¬
    stems.forEach((stem, sIdx) => {
        if (!stem) return;
        const si = STEM.indexOf(stem);
        const roots = [];
        
        branches.forEach((branch, bIdx) => {
            if (!branch) return;
            const bi = BRANCH.indexOf(branch);
            const jj = JIJANGGAN[bi];
            
            jj.forEach((h, hIdx) => {
                if (h.stem === si) {
                    const isJunggi = hIdx === jj.length - 1;
                    roots.push({
                        pillar: pillarNames[bIdx].slice(0, 1) + 'ì§€',
                        branch: branch.c,
                        type: isJunggi ? 'Main' : (hIdx === 0 ? 'Side' : 'Middle'),
                        strength: isJunggi ? 'ê°•' : (hIdx === 0 ? 'ì•½' : 'ì¤‘')
                    });
                }
            });
        });
        
        if (roots.length > 0) {
            result.tonggeun.push({
                pillar: pillarNames[sIdx],
                stem: stem.c + stem.k,
                god: sIdx === 2 ? 'æ—¥ä¸»(Day Master)' : getTenGod(stem, dm).k,
                roots: roots
            });
        }
    });
    
    // íˆ¬ê°„ ì²´í¬ - æ”¯è—å¹²(Hidden Stems)ì´ ì²œê°„ì— ë‚˜íƒ€ë‚¬ëŠ”ì§€
    branches.forEach((branch, bIdx) => {
        if (!branch) return;
        const bi = BRANCH.indexOf(branch);
        const jj = JIJANGGAN[bi];
        
        jj.forEach(h => {
            stems.forEach((stem, sIdx) => {
                if (!stem) return;
                if (STEM.indexOf(stem) === h.stem) {
                    const existing = result.tougan.find(t => t.stem === stem.c + stem.k);
                    if (!existing) {
                        result.tougan.push({
                            stem: stem.c + stem.k,
                            pillar: pillarNames[sIdx],
                            from: pillarNames[bIdx].slice(0, 1) + 'ì§€',
                            god: sIdx === 2 ? 'æ—¥ä¸»(Day Master)' : getTenGod(stem, dm).k
                        });
                    }
                }
            });
        });
    });
    
    return result;
}

/* ----------------------------------------
   9-3. ì‹­ì‹  ìƒì„¸ ë¶„ì„
   ---------------------------------------- */
function getTenGod(stem, dayStem) {
    const dEl = EL_ORDER.indexOf(dayStem.e);
    const sEl = EL_ORDER.indexOf(stem.e);
    const diff = (sEl - dEl + 5) % 5;
    const samePol = (dayStem.y === stem.y);
    const godKeys = ['bijeon','geupjae','siksin','sanggwan','pyeonjae','jeongjae','pyeongwan','jeonggwan','pyeonin','jeongin'];
    const godMap = { 0: samePol ? 0 : 1, 1: samePol ? 2 : 3, 2: samePol ? 4 : 5, 3: samePol ? 6 : 7, 4: samePol ? 8 : 9 };
    return TEN_GODS[godKeys[godMap[diff]]];
}

function getTwelveState(dayStem, branch) {
    const starts = [11, 6, 2, 9, 2, 9, 5, 0, 8, 3];
    const dsi = STEM.indexOf(dayStem);
    const bi = BRANCH.indexOf(branch);
    const start = starts[dsi];
    const dir = dayStem.y ? 1 : -1;
    return TWELVE_STATES[(start + dir * bi + 120) % 12];
}

/* ========================================
   Sound-Element (Nap-eum) ê³„ì‚°
   ======================================== */
function calcNapeum(stem, branch) {
    const si = STEM.indexOf(stem);
    const bi = BRANCH.indexOf(branch);
    // 60ê°‘ì ìˆœì„œ ê³„ì‚°
    const idx = (si * 6 + Math.floor(bi / 2)) % 30;
    const napeum = NAPEUM[idx];
    return {
        name: napeum.name,
        element: napeum.element,
        elementK: ELEMENT[napeum.element].k,
        desc: napeum.desc
    };
}

/* ========================================
   å‘½å®®(Life Palace) (Myung-gung) ê³„ì‚°
   ======================================== */
function calcMyunggung(monthBranch, hourBranch) {
    // å‘½å®®(Life Palace) = (14 - Month Branch - Hour Branch) % 12
    const mbi = BRANCH.indexOf(monthBranch);
    const hbi = BRANCH.indexOf(hourBranch);
    const mgIdx = (14 - mbi - hbi + 24) % 12;
    const mgBranch = BRANCH[mgIdx];
    
    // å‘½å®®(Life Palace) interpretations
    const mgDesc = {
        0: {name: 'å­(Rat) Palace (å­å®®)', trait: 'Wise and composed. Many secrets, active at night.', career: 'Research, Philosophy, Night industries'},
        1: {name: 'ä¸‘(Ox) Palace (ä¸‘å®®)', trait: 'Diligent with persistence. Talent for accumulating wealth.', career: 'Finance, Real Estate, Agriculture'},
        2: {name: 'å¯…(Tiger) Palace (å¯…å®®)', trait: 'Ambitious and brave. Strong leadership qualities.', career: 'Military, Politics, Sports'},
        3: {name: 'å¯(Rabbit) Palace (å¯å®®)', trait: 'Gentle and artistic. Naturally popular.', career: 'Arts, Design, Service industries'},
        4: {name: 'è¾°(Dragon) Palace (è¾°å®®)', trait: 'Unpredictable and mysterious. Big dreams.', career: 'Religion, Philosophy, Entrepreneurship'},
        5: {name: 'å·³(Snake) Palace (å·³å®®)', trait: 'Wise and cautious. Keeps secrets well.', career: 'Law, Medicine, Counseling'},
        6: {name: 'åˆ(Horse) Palace (åˆå®®)', trait: 'Passionate and proactive. Values honor.', career: 'Politics, Entertainment, Education'},
        7: {name: 'æœª(Goat) Palace (æœªå®®)', trait: 'Soft and artistic. Strong service spirit.', career: 'Arts, Religion, Healthcare'},
        8: {name: 'ç”³(Monkey) Palace (ç”³å®®)', trait: 'Clever and witty. Excellent communication skills.', career: 'Sales, Diplomacy, IT'},
        9: {name: 'é…‰(Rooster) Palace (é…‰å®®)', trait: 'Delicate perfectionist. Exceptional aesthetic sense.', career: 'Finance, Jewelry, Beauty'},
        10: {name: 'æˆŒ(Dog) Palace (æˆŒå®®)', trait: 'Loyal and faithful. Strong sense of responsibility.', career: 'Military, Police, Security'},
        11: {name: 'äº¥(Pig) Palace (äº¥å®®)', trait: 'Optimistic with great relationships. Much fortune.', career: 'Trade, Travel, Distribution'}
    };
    
    return {
        branch: mgBranch,
        index: mgIdx,
        ...mgDesc[mgIdx]
    };
}

/* ========================================
   íƒœì›(èƒå…ƒ) ê³„ì‚°
   ======================================== */
function calcTaewon(yearStem, monthStem, monthBranch) {
    // íƒœì› = ì›”ê°„ +1, Month Branch +3
    const msi = STEM.indexOf(monthStem);
    const mbi = BRANCH.indexOf(monthBranch);
    
    const tStem = STEM[(msi + 1) % 10];
    const tBranch = BRANCH[(mbi + 3) % 12];
    
    // íƒœì›ì´ ì‚¬ì£¼ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
    const napeum = calcNapeum(tStem, tBranch);
    
    return {
        stem: tStem,
        branch: tBranch,
        pillar: tStem.c + tBranch.c,
        napeum: napeum,
        desc: `Energy at conception. ${napeum.name}(${napeum.elementK})energy influence at birth.`
    };
}

/* ========================================
   æ–¹åˆ(Directional Harmony)(æ–¹åˆ) ë¶„ì„
   ======================================== */
function analyzeBanghap(saju) {
    const branches = [];
    if (saju.year) branches.push(BRANCH.indexOf(saju.year.b));
    if (saju.month) branches.push(BRANCH.indexOf(saju.month.b));
    if (saju.day) branches.push(BRANCH.indexOf(saju.day.b));
    if (saju.hour) branches.push(BRANCH.indexOf(saju.hour.b));
    
    const results = [];
    
    for (const bh of BANGHAP) {
        const has = bh.branches.map(b => branches.includes(b));
        const count = has.filter(x => x).length;
        
        if (count === 3) {
            // ì™„ì „ æ–¹åˆ(Directional Harmony)
            results.push({
                type: 'complete',
                name: bh.name,
                dir: bh.dir,
                element: bh.element,
                elementK: ELEMENT[bh.element].k,
                branches: bh.branches.map(b => BRANCH[b].c).join(''),
                power: 'ê°•ë ¥',
                desc: `${bh.dir} Complete! ${ELEMENT[bh.element].k} energy becomes very strong.`
            });
        } else if (count === 2) {
            // 2ê°œ æ–¹åˆ(Directional Harmony) (íšŒêµ­ ê°€ëŠ¥ì„±)
            const missing = bh.branches.find((b, i) => !has[i]);
            results.push({
                type: 'partial',
                name: bh.name + ' Incomplete',
                dir: bh.dir,
                element: bh.element,
                elementK: ELEMENT[bh.element].k,
                branches: bh.branches.filter((b, i) => has[i]).map(b => BRANCH[b].c).join(''),
                missing: BRANCH[missing].c,
                power: 'ì¤‘ê°„',
                desc: `${BRANCH[missing].c}ê°€ ì˜¤ë©´ ${bh.dir}ì´ ì™„ì„±ë©ë‹ˆë‹¤.`
            });
        }
    }
    
    return results;
}

/* ========================================
   æš—åˆ(Hidden Harmony)(æš—åˆ) ë¶„ì„
   ======================================== */
function analyzeAmhap(saju) {
    const branches = [];
    const pillars = ['Year Branch', 'Month Branch', 'Day Branch', 'Hour Branch'];
    
    if (saju.year) branches.push({idx: BRANCH.indexOf(saju.year.b), name: 'Year Branch', c: saju.year.b.c});
    if (saju.month) branches.push({idx: BRANCH.indexOf(saju.month.b), name: 'Month Branch', c: saju.month.b.c});
    if (saju.day) branches.push({idx: BRANCH.indexOf(saju.day.b), name: 'Day Branch', c: saju.day.b.c});
    if (saju.hour) branches.push({idx: BRANCH.indexOf(saju.hour.b), name: 'Hour Branch', c: saju.hour.b.c});
    
    const results = [];
    
    for (let i = 0; i < branches.length; i++) {
        for (let j = i + 1; j < branches.length; j++) {
            for (const ah of AMHAP) {
                if ((branches[i].idx === ah.a && branches[j].idx === ah.b) ||
                    (branches[i].idx === ah.b && branches[j].idx === ah.a)) {
                    results.push({
                        name: ah.name,
                        positions: `${branches[i].name}(${branches[i].c})â†”${branches[j].name}(${branches[j].c})`,
                        desc: ah.desc,
                        meaning: 'ê²‰ìœ¼ë¡œëŠ” ì•ˆ ë“œëŸ¬ë‚˜ì§€ë§Œ ì†ìœ¼ë¡œ í†µí•˜ëŠ” ê´€ê³„. ìˆ¨ê²¨ì§„ ì¸ì—°, ë¹„ë°€ìŠ¤ëŸ¬ìš´ ê´€ê³„ë¥¼ ì˜ë¯¸.'
                    });
                }
            }
        }
    }
    
    return results;
}

/* ========================================
   ê³µë§ í•´ì†Œ ë¶„ì„
   ======================================== */
function analyzeGongmangHaeso(saju, gongmang) {
    if (!gongmang || !gongmang.affected || gongmang.affected.length === 0) {
        return { hasGongmang: false, results: [] };
    }
    
    const branches = [];
    if (saju.year) branches.push(BRANCH.indexOf(saju.year.b));
    if (saju.month) branches.push(BRANCH.indexOf(saju.month.b));
    if (saju.day) branches.push(BRANCH.indexOf(saju.day.b));
    if (saju.hour) branches.push(BRANCH.indexOf(saju.hour.b));
    
    const results = [];
    
    for (const affected of gongmang.affected) {
        // ê³µë§ ì§€ì§€ ì°¾ê¸°
        const gmBranchIdx = BRANCH.findIndex(b => affected.includes(b.k) || affected.includes(b.c));
        if (gmBranchIdx === -1) continue;
        
        let resolved = false;
        let resolveMethod = '';
        
        // ì¶©ìœ¼ë¡œ í•´ì†Œ ì²´í¬
        const chungPair = (gmBranchIdx + 6) % 12;
        if (branches.includes(chungPair)) {
            resolved = true;
            resolveMethod = `${BRANCH[chungPair].c}(ì¶©)ìœ¼ë¡œ ê³µë§ í•´ì†Œ`;
        }
        
        // Trinityìœ¼ë¡œ í•´ì†Œ ì²´í¬
        const samhapSets = [[0,4,8], [1,5,9], [2,6,10], [3,7,11]];
        for (const set of samhapSets) {
            if (set.includes(gmBranchIdx)) {
                const others = set.filter(s => s !== gmBranchIdx);
                if (others.every(o => branches.includes(o))) {
                    resolved = true;
                    resolveMethod = `Trinity(${set.map(s => BRANCH[s].c).join('')})ìœ¼ë¡œ ê³µë§ í•´ì†Œ`;
                }
            }
        }
        
        results.push({
            position: affected,
            branch: BRANCH[gmBranchIdx].c,
            resolved: resolved,
            method: resolveMethod,
            effect: resolved ? 
                'ê³µë§ì´ í•´ì†Œë˜ì–´ í•´ë‹¹ ê¸°ìš´ì´ ì œ ì—­í• ì„ í•©ë‹ˆë‹¤.' : 
                'ê³µë§ì´ í•´ì†Œë˜ì§€ ì•Šì•„ í•´ë‹¹ energy is weak. æ­²é‹(Annual Fortune)ì´ë‚˜ å¤§é‹(Life Cycle)ì—ì„œ í•´ì†Œë  ìˆ˜.'
        });
    }
    
    return { hasGongmang: true, results };
}

/* ========================================
   ì‹ ì‚´ ìœ„ì¹˜ë³„ í•´ì„
   ======================================== */
function analyzeSinsalPosition(saju) {
    const results = [];
    const positions = [
        {name: 'Year Branch', b: saju.year?.b, meaning: 'ì¡°ìƒ, ì‚¬íšŒ', age: 'ìœ ë…„ê¸°(0-15ì„¸)'},
        {name: 'Month Branch', b: saju.month?.b, meaning: 'ë¶€ëª¨, í˜•ì œ', age: 'Youthê¸°(15-30ì„¸)'},
        {name: 'Day Branch', b: saju.day?.b, meaning: 'ë°°ìš°ì, Self', age: 'Middle ageê¸°(30-45ì„¸)'},
        {name: 'Hour Branch', b: saju.hour?.b, meaning: 'Children, Later years', age: 'Later years (45+)'}
    ];
    
    const ybi = BRANCH.indexOf(saju.year?.b);
    
    // æ¡ƒèŠ±(Peach Blossom) ìœ„ì¹˜ ë¶„ì„
    const taohua = {0:9,1:6,2:3,3:0,4:9,5:6,6:3,7:0,8:9,9:6,10:3,11:0};
    for (const pos of positions) {
        if (!pos.b) continue;
        const bi = BRANCH.indexOf(pos.b);
        if (bi === taohua[ybi]) {
            results.push({
                sinsal: 'æ¡ƒèŠ±(Peach Blossom)(æ¡ƒèŠ±æ®º)',
                position: pos.name,
                interpretation: pos.name === 'Year Branch' ? 'ì–´ë¦´ ë•Œë¶€í„° ì¸ê¸°ê°€ ë§ìŒ. ì´ë¥¸ ì—°ì•  ê°€ëŠ¥ì„±.' :
                               pos.name === 'Month Branch' ? 'í•™ì°½ì‹œì ˆ ì¸ê¸° ë§ìŒ. ì—°ì˜ˆì¸ ê¸°ì§ˆ.' :
                               pos.name === 'Day Branch' ? 'ë°°ìš°ìê°€ ë§¤ë ¥ì . Selfë„ ë§¤ë ¥ì´ ë„˜ì¹¨.' :
                               'ìë…€ê°€ ì˜ˆì˜ê±°ë‚˜ ì¸ê¸° ë§ìŒ. ë§ë…„ì—ë„ ì¸ê¸°.',
                advice: pos.name === 'Day Branch' ? 'ë°°ìš°ìì™€ì˜ ê´€ê³„ì—ì„œ ë°”ëŒê¸° ì¡°ì‹¬' : 'ë§¤ë ¥ì„ ì¥ì ìœ¼ë¡œ í™œìš©í•˜ì„¸ìš”'
            });
        }
    }
    
    // é©›é¦¬(Traveling Horse) ìœ„ì¹˜ ë¶„ì„
    const yima = {0:2,1:11,2:8,3:5,4:2,5:11,6:8,7:5,8:2,9:11,10:8,11:5};
    for (const pos of positions) {
        if (!pos.b) continue;
        const bi = BRANCH.indexOf(pos.b);
        if (bi === yima[ybi]) {
            results.push({
                sinsal: 'é©›é¦¬(Traveling Horse)(é©›é¦¬æ®º)',
                position: pos.name,
                interpretation: pos.name === 'Year Branch' ? 'ì¡°ìƒì´ ì´ì‚¬ê°€ ë§ì•˜ê±°ë‚˜ íƒ€í–¥ì‚´ì´.' :
                               pos.name === 'Month Branch' ? 'ì–´ë¦° ì‹œì ˆ ì´ì‚¬ê°€ ë§ìŒ. í•´ì™¸ ìœ í•™ ê°€ëŠ¥.' :
                               pos.name === 'Day Branch' ? 'ì§ì—…ìƒ ì¶œì¥/ì´ë™ì´ ë§ìŒ. ë°°ìš°ìê°€ ë°”ìœ ì‚¬ëŒ.' :
                               'ë§ë…„ì—ë„ í™œë™ì . ìë…€ê°€ ë©€ë¦¬ ê°.',
                advice: 'ê°€ë§Œíˆ ìˆìœ¼ë©´ ì•ˆ ì¢‹ìŒ. í™œë°œíˆ ì›€ì§ì´ì„¸ìš”!'
            });
        }
    }
    
    // Fireê°œì‚´ ìœ„ì¹˜ ë¶„ì„
    const huagai = {0:4,1:1,2:10,3:7,4:4,5:1,6:10,7:7,8:4,9:1,10:10,11:7};
    for (const pos of positions) {
        if (!pos.b) continue;
        const bi = BRANCH.indexOf(pos.b);
        if (bi === huagai[ybi]) {
            results.push({
                sinsal: 'è¯è“‹(Canopy Star) (è¯è“‹æ®º)',
                position: pos.name,
                interpretation: pos.name === 'Year Branch' ? 'ì¡°ìƒ ì¤‘ ì˜ˆìˆ ê°€ë‚˜ ì¢…êµì¸exists.' :
                               pos.name === 'Month Branch' ? 'í•™ì°½ì‹œì ˆ ì™¸ë¡œì›€. ì˜ˆìˆ /ì² í•™ì— ê´€ì‹¬.' :
                               pos.name === 'Day Branch' ? 'ë°°ìš°ìê°€ ì˜ˆìˆ ì ì´ê±°ë‚˜ ì¢…êµì . ì •ì‹ ì„¸ê³„ ì¤‘ì‹œ.' :
                               'ë§ë…„ì— ì¢…êµ/ì² í•™ì— ë¹ ì§. ê³ ë…í•  ìˆ˜ present.',
                advice: 'ì˜ˆìˆ , ì¢…êµ, í•™ë¬¸ ë“± ì •ì‹ ì  í™œë™ì—ì„œ ìœ„ì•ˆì„ ì°¾ìœ¼ì„¸ìš”'
            });
        }
    }
    
    return results;
}

/* ========================================
   å¤§é‹(Life Cycle) êµìš´ê¸° ë¶„ì„
   ======================================== */
function analyzeGyoungi(luck, birthYear, currentYear) {
    const age = currentYear - birthYear + 1;
    const results = [];
    
    for (let i = 0; i < luck.length - 1; i++) {
        const curr = luck[i];
        const next = luck[i + 1];
        
        // êµìš´ê¸° ì‹œì  (å¤§é‹(Life Cycle)ì´ ë°”ë€Œê¸° 1ë…„ ì „ë¶€í„° 1ë…„ í›„)
        const transitionAge = next.startAge;
        const transitionYear = birthYear + transitionAge - 1;
        
        // Current ë‚˜ì´ê°€ êµìš´ê¸° ê·¼ì²˜ì¸ì§€ ì²´í¬ (Â±2ë…„)
        if (Math.abs(age - transitionAge) <= 2) {
            // ì²œê°„ ë³€í™”
            const stemChange = `${curr.s.c}â†’${next.s.c}`;
            const branchChange = `${curr.b.c}â†’${next.b.c}`;
            
            // ì˜¤í–‰ ë³€í™”
            const fromEl = ELEMENT[curr.s.e].k + ELEMENT[curr.b.e].k;
            const toEl = ELEMENT[next.s.e].k + ELEMENT[next.b.e].k;
            
            // ê¸‰ê²©í•œ ë³€í™”ì¸ì§€ ì²´í¬
            let intensity = 'normal';
            let warning = '';
            
            // ì˜¤í–‰ì´ ìƒê·¹ìœ¼ë¡œ ë³€í•˜ë©´ ê¸‰ê²©í•œ ë³€í™”
            const elIdx1 = EL_ORDER.indexOf(curr.s.e);
            const elIdx2 = EL_ORDER.indexOf(next.s.e);
            if (Math.abs(elIdx1 - elIdx2) === 2 || Math.abs(elIdx1 - elIdx2) === 3) {
                intensity = 'strong';
                warning = 'Major elemental shift period. Significant life changes may come.';
            }
            
            // ì¢‹ì€ ìš´ì—ì„œ ë‚˜ìœ ìš´ìœ¼ë¡œ, ë˜ëŠ” ë°˜ëŒ€
            if (curr.rating !== next.rating) {
                intensity = 'strong';
                if (curr.rating === 'good' && next.rating === 'bad') {
                    warning += ' ì¢‹ì€ ìš´ì—ì„œ ì–´ë ¤ìš´ ìš´ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤. ë¯¸ë¦¬ ëŒ€ë¹„í•˜ì„¸ìš”.';
                } else if (curr.rating === 'bad' && next.rating === 'good') {
                    warning += ' ì–´ë ¤ìš´ ìš´ì´ ëë‚˜ê³  ì¢‹ì€ ìš´ì´ ì˜µë‹ˆë‹¤. í¬ë§ì„ ê°€ì§€ì„¸ìš”!';
                }
            }
            
            results.push({
                transitionAge: transitionAge,
                transitionYear: transitionYear,
                from: `${curr.s.c}${curr.b.c} (${fromEl})`,
                to: `${next.s.c}${next.b.c} (${toEl})`,
                stemChange: stemChange,
                branchChange: branchChange,
                intensity: intensity,
                warning: warning || 'å¤§é‹(Life Cycle)ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì „í™˜ë©ë‹ˆë‹¤.',
                advice: intensity === 'strong' ? 
                    'ì´ ì‹œê¸°ëŠ” ì¸ìƒì˜ ì¤‘ìš”í•œ ì „í™˜ì ì…ë‹ˆë‹¤. í° ê²°ì •ì€ ì‹ ì¤‘í•˜ê²Œ!' :
                    'ë³€í™”ì— ìì—°ìŠ¤ëŸ½ê²Œ ì ì‘í•˜ë©´ ë©ë‹ˆë‹¤.',
                isCurrent: Math.abs(age - transitionAge) <= 1
            });
        }
    }
    
    return results;
}

function calcStrength(saju) {
    const dm = saju.day.s;
    const dme = dm.e;
    const season = SEASON[BRANCH.indexOf(saju.month.b)];
    let score = 0;
    const factors = [];
    
    // ì˜¤í–‰ ê´€ê³„ ê³„ì‚°
    const myEls = [dme, EL_ORDER[(EL_ORDER.indexOf(dme) + 4) % 5]]; // ë¹„ê² + ì¸ì„±
    const jaes = [EL_ORDER[(EL_ORDER.indexOf(dme) + 2) % 5]]; // ì¬ì„±
    const gwans = [EL_ORDER[(EL_ORDER.indexOf(dme) + 3) % 5]]; // ê´€ì‚´
    
    // 1. ì›”ë ¹ë“ë ¹ (ê°€ì¥ ì¤‘ìš”, 40%)
    const seasonScore = { spring:{wood:3,fire:2,earth:0,metal:-1,water:-2}, summer:{fire:3,earth:2,metal:0,water:-1,wood:-2}, autumn:{metal:3,water:2,wood:0,fire:-1,earth:-2}, winter:{water:3,wood:2,fire:0,earth:-1,metal:-2} };
    const ms = seasonScore[season][dme];
    const deukRyung = ms >= 2;
    score += ms * 4;
    factors.push({ l: 'ì›”ë ¹ë“ë ¹', v: deukRyung ? `ë“ë ¹(+${ms*4})` : `ì‹¤ë ¹(${ms*4})`, p: deukRyung });
    
    // 2. ì§€ì§€ í†µê·¼ (ë¿Œë¦¬, 30%) - æ”¯è—å¹²(Hidden Stems) Main/Middle/Side êµ¬ë¶„
    let roots = 0;
    const allBr = [saju.year.b, saju.month.b, saju.day.b, saju.hour?.b].filter(b => b);
    const jijanggan = {0:[9],1:[9,7,5],2:[0,2,4],3:[1],4:[4,1,9],5:[2,4,6],6:[3,5],7:[5,3,1],8:[6,8,4],9:[7],10:[4,7,3],11:[8,0]};
    allBr.forEach(b => {
        const bi = BRANCH.indexOf(b);
        if (myEls.includes(b.e)) roots += 1.5; // ë³¸ê¸°ê°€ ë¹„ê²/ì¸ì„±
        const hidden = jijanggan[bi] || [];
        hidden.forEach((hi, idx) => {
            const hEl = STEM[hi].e;
            if (myEls.includes(hEl)) roots += (idx === 0 ? 0.5 : 0.3); // Main > Middle > Side
        });
    });
    const rootStrong = roots >= 3;
    score += Math.min(roots * 1.5, 8);
    factors.push({ l: 'ì§€ì§€í†µê·¼', v: rootStrong ? `ê°•(${roots.toFixed(1)})` : `ì•½(${roots.toFixed(1)})`, p: rootStrong });
    
    // 3. ì²œê°„ íˆ¬ì¶œ - ë¹„ê²/ì¸ì„± vs ê´€ì‚´/ì¬ì„±
    let helps = 0, attacks = 0;
    const allSt = [saju.year.s, saju.month.s, saju.hour?.s].filter(s => s);
    allSt.forEach(st => {
        if (myEls.includes(st.e)) helps++;
        if (gwans.includes(st.e)) attacks += 1.5;
        if (jaes.includes(st.e)) attacks += 0.5;
    });
    score += helps * 2;
    score -= attacks;
    if (helps >= 1) factors.push({ l: 'ì²œê°„íˆ¬ì¶œ', v: `ë¹„ê²ì¸ì„± ${helps}ê°œ`, p: true });
    
    // 4. ê´€ì‚´ ì••ë°•
    let gwanCount = 0;
    [...allSt, ...allBr].forEach(p => { if (gwans.includes(p.e)) gwanCount++; });
    if (gwanCount >= 2) { score -= 2; factors.push({ l: 'ê´€ì‚´ì••ë°•', v: `${gwanCount}ê°œ (Weakâ†“)`, p: false }); }
    
    // 5. ì¬ì„± ê³¼ë‹¤
    let jaeCount = 0;
    [...allSt, ...allBr].forEach(p => { if (jaes.includes(p.e)) jaeCount++; });
    if (jaeCount >= 3) { score -= 2; factors.push({ l: 'ì¬ì„±ê³¼ë‹¤', v: `${jaeCount}ê°œ (Weakâ†“)`, p: false }); }
    
    // 6. Day Branch 12ìš´ì„±
    const ds = getTwelveState(dm, saju.day.b);
    const dsScore = ds.l >= 8 ? 3 : ds.l >= 6 ? 1 : ds.l >= 4 ? 0 : ds.l >= 2 ? -1 : -2;
    score += dsScore;
    factors.push({ l: 'Day Branch12ìš´', v: `${ds.k}(${dsScore >= 0 ? '+' : ''}${dsScore})`, p: ds.l >= 6 });
    
    // 7. ë¹„ê² ê°œìˆ˜
    let biCount = 0;
    [...allSt, ...allBr].forEach(p => { if (p.e === dme) biCount++; });
    if (biCount >= 3) { score += 2; factors.push({ l: 'ë¹„ê²ë‹¤Water', v: `${biCount}ê°œ (Strongâ†‘)`, p: true }); }
    
    // 8. ì¸ì„± ê°œìˆ˜
    const inEl = EL_ORDER[(EL_ORDER.indexOf(dme) + 4) % 5];
    let inCount = 0;
    [...allSt, ...allBr].forEach(p => { if (p.e === inEl) inCount++; });
    if (inCount >= 2) { score += 1.5; factors.push({ l: 'ì¸ì„±ìƒë¶€', v: `${inCount}ê°œ (Strongâ†‘)`, p: true }); }
    
    // ê·¹Strong/ê·¹Weak íŒì •
    let type = 'balanced';
    let extreme = null;
    if (score >= 15) { type = 'strong'; extreme = 'ê·¹Strong'; }
    else if (score >= 8) type = 'strong';
    else if (score >= 3) type = 'balanced';
    else if (score <= -5) { type = 'weak'; extreme = 'ê·¹Weak'; }
    else if (score <= 2) type = 'weak';
    
    return { type, score: Math.round(score * 10) / 10, pct: Math.round(Math.min(100, Math.max(0, (score + 5) * 4))), factors, extreme };
}

/* ========================================
   9-4. ì¡°í›„(èª¿å€™) ê³ ê¸‰ ì ìš©
   ======================================== */

// ì›”ë³„ ì¡°í›„ìš©ì‹ í‘œ - æ—¥ä¸»(Day Master)ë³„ ê° ì›”ì˜ ì¡°í›„ìš©ì‹ 
const JOHU_TABLE = {
    // ç”²æœ¨ (ê°‘ëª©)
    0: {
        0: {yong:'fire', sub:'wood', desc:'Winter Jia Wood is frozen warming with Fire'},  // å­(Rat) month
        1: {yong:'fire', sub:'wood', desc:'ä¸‘(Ox) month Earth dominant season, with Fire removing cold'},
        2: {yong:'water', sub:'fire', desc:'å¯…(Tiger) month spring begins, Water nourishes roots'},
        3: {yong:'water', sub:'fire', desc:'å¯(Rabbit) month Woodì™•, Water provides nourishment'},
        4: {yong:'water', sub:'metal', desc:'è¾°(Dragon) month strong Earth energy needs Water balance'},
        5: {yong:'water', sub:'metal', desc:'å·³(Snake) month summer begins, with Water prevent dryness'},
        6: {yong:'water', sub:'metal', desc:'åˆ(Horse) month Fireì™•, Water is essential'},
        7: {yong:'water', sub:'metal', desc:'æœª(Goat) month Earth dominant season, with Water hot dry ì œê±°'},
        8: {yong:'water', sub:'fire', desc:'ç”³(Monkey) month strong Metal needs Water release'},
        9: {yong:'water', sub:'fire', desc:'é…‰(Rooster) month Metal peak, Water from Metal'},
        10: {yong:'fire', sub:'water', desc:'æˆŒ(Dog) month Earth energy, Fire nurtures Wood'},
        11: {yong:'fire', sub:'water', desc:'äº¥(Pig) month strong Water needs Fire balance'}
    },
    // ä¹™æœ¨ (ì„ëª©)
    1: {
        0: {yong:'fire', sub:'water', desc:'Winter Yi Wood is weak warming with Fire'},
        1: {yong:'fire', sub:'water', desc:'ä¸‘(Ox) month cold is strong, Fire essential'},
        2: {yong:'water', sub:'fire', desc:'å¯…(Tiger) month early spring, Water for growth'},
        3: {yong:'fire', sub:'water', desc:'å¯(Rabbit) month Yi Wood peak, Fire release'},
        4: {yong:'water', sub:'fire', desc:'è¾°(Dragon) month Earthê¸°ìš´, with Water ìƒWood'},
        5: {yong:'water', sub:'metal', desc:'å·³(Snake) month strong Fire needs Water nourishment'},
        6: {yong:'water', sub:'metal', desc:'åˆ(Horse) month hot period Water is essential'},
        7: {yong:'water', sub:'metal', desc:'æœª(Goat) month hot dry, with Water cooling'},
        8: {yong:'fire', sub:'water', desc:'ç”³(Monkey) month Metal peak, Fire controls Metal'},
        9: {yong:'fire', sub:'water', desc:'é…‰(Rooster) month Metal peak, Fire protection'},
        10: {yong:'fire', sub:'water', desc:'æˆŒ(Dog) month Fireê¸° ìˆ˜ì¥, warming with Fire'},
        11: {yong:'fire', sub:'wood', desc:'äº¥(Pig) month Water peak, Fire balance'}
    },
    // ä¸™ç« (ë³‘Fire)
    2: {
        0: {yong:'wood', sub:'earth', desc:'Winter Bing Fire needs Wood nurturing'},
        1: {yong:'wood', sub:'fire', desc:'ä¸‘(Ox) month cold Earth, Wood nurtures Fire'},
        2: {yong:'water', sub:'metal', desc:'å¯…(Tiger) month Wood creates Fire peak, Water balance'},
        3: {yong:'water', sub:'metal', desc:'å¯(Rabbit) month Wood peak, Water balance'},
        4: {yong:'water', sub:'metal', desc:'è¾°(Dragon) month Earth energy, Water nourishment'},
        5: {yong:'water', sub:'metal', desc:'å·³(Snake) month Fireì™•, Water is essential'},
        6: {yong:'water', sub:'metal', desc:'åˆ(Horse) month sun at peak, with Water cooling down'},
        7: {yong:'water', sub:'metal', desc:'æœª(Goat) month hot dry, with Water cooling'},
        8: {yong:'wood', sub:'water', desc:'ç”³(Monkey) month Metal peak, Wood nurtures Fire'},
        9: {yong:'wood', sub:'water', desc:'é…‰(Rooster) month Metal peak, Wood reinforcement'},
        10: {yong:'wood', sub:'water', desc:'æˆŒ(Dog) month dry Earth, Wood nurtures Fire'},
        11: {yong:'wood', sub:'fire', desc:'äº¥(Pig) month Waterì™•, with Wood bridging'}
    },
    // ä¸ç« (ì •Fire)
    3: {
        0: {yong:'wood', sub:'fire', desc:'Winter Ding Fire needs Wood to maintain flame'},
        1: {yong:'wood', sub:'fire', desc:'ä¸‘(Ox) month cold energy, Wood nurtures Fire'},
        2: {yong:'wood', sub:'water', desc:'å¯…(Tiger) month growing Wood, Water balance'},
        3: {yong:'wood', sub:'water', desc:'å¯(Rabbit) month Wood peak, Water balance'},
        4: {yong:'wood', sub:'water', desc:'è¾°(Dragon) month damp Earth, Wood nurtures Fire'},
        5: {yong:'water', sub:'wood', desc:'å·³(Snake) month Fire peak, Water ì¡°í›„'},
        6: {yong:'water', sub:'wood', desc:'åˆ(Horse) month Fire at peak, Water is essential'},
        7: {yong:'water', sub:'wood', desc:'æœª(Goat) month hot dry, with Water cooling'},
        8: {yong:'wood', sub:'fire', desc:'ç”³(Monkey) month strong Metal needs Wood to nurture Fire'},
        9: {yong:'wood', sub:'fire', desc:'é…‰(Rooster) month Metal peak, Wood reinforcement'},
        10: {yong:'wood', sub:'fire', desc:'æˆŒ(Dog) month Fireê¸° ìˆ˜ì¥, with Wood ìœ ì§€'},
        11: {yong:'wood', sub:'fire', desc:'äº¥(Pig) month Waterê·¹Fire, with Wood bridging'}
    },
    // æˆŠåœŸ (ë¬´í† )
    4: {
        0: {yong:'fire', sub:'wood', desc:'Winter Wu Earth needs warming with Fire'},
        1: {yong:'fire', sub:'wood', desc:'ä¸‘(Ox) month cold Earth, Fire warmth'},
        2: {yong:'fire', sub:'wood', desc:'å¯…(Tiger) month Wood attacks Earth, Fire bridges'},
        3: {yong:'fire', sub:'metal', desc:'å¯(Rabbit) month Wood peak, Fire controls'},
        4: {yong:'metal', sub:'water', desc:'è¾°(Dragon) month Earth dominant, Metal release'},
        5: {yong:'water', sub:'metal', desc:'å·³(Snake) month Fire peak, Water ì¡°í›„'},
        6: {yong:'water', sub:'metal', desc:'åˆ(Horse) month dry Earth, Water is essential'},
        7: {yong:'water', sub:'metal', desc:'æœª(Goat) month Earth dominant season, with Water nourishment'},
        8: {yong:'water', sub:'fire', desc:'ç”³(Monkey) month strong Metal needs Water balance'},
        9: {yong:'fire', sub:'water', desc:'é…‰(Rooster) month Metal peak, Fire balance'},
        10: {yong:'fire', sub:'water', desc:'æˆŒ(Dog) month Earth dominant, Fire nurtures Earth'},
        11: {yong:'fire', sub:'wood', desc:'äº¥(Pig) month Water peak, Fire warmth'}
    },
    // å·±åœŸ (ê¸°í† )
    5: {
        0: {yong:'fire', sub:'wood', desc:'Winter Ji Earth needs warming with Fire'},
        1: {yong:'fire', sub:'wood', desc:'ä¸‘(Ox) month cold damp Earth, with Fire ì˜¨ê¸°'},
        2: {yong:'fire', sub:'water', desc:'å¯…(Tiger) month Wood attacks Earth, Fire protects'},
        3: {yong:'fire', sub:'water', desc:'å¯(Rabbit) month Woodì™•, with Fire bridging'},
        4: {yong:'metal', sub:'water', desc:'è¾°(Dragon) month Earth dominant, Metal release'},
        5: {yong:'water', sub:'metal', desc:'å·³(Snake) month dry Earth, with Water nourishment'},
        6: {yong:'water', sub:'metal', desc:'åˆ(Horse) month Fireì™•, Water is essential'},
        7: {yong:'water', sub:'metal', desc:'æœª(Goat) month Earth dominant season, with Water damp balance'},
        8: {yong:'water', sub:'fire', desc:'ç”³(Monkey) month Metalê¸°, with Water ìœ¤ê¸°'},
        9: {yong:'fire', sub:'water', desc:'é…‰(Rooster) month Metalì™•, with Fire ê· í˜•'},
        10: {yong:'fire', sub:'water', desc:'æˆŒ(Dog) month Earth dominant, Fire nurtures Earth'},
        11: {yong:'fire', sub:'wood', desc:'äº¥(Pig) month Waterì™•, with Fire ì¡°ì ˆ'}
    },
    // åºšé‡‘ (ê²½Metal)
    6: {
        0: {yong:'fire', sub:'earth', desc:'ê²¨ìš¸ ê²½Metalì€ with Fire ë‹¨ë ¨'},
        1: {yong:'fire', sub:'earth', desc:'ä¸‘(Ox) month í•œMetal, with Fire ë…¹ì„'},
        2: {yong:'fire', sub:'water', desc:'å¯…(Tiger) month Woodê¸°ìš´, with Fire ë³´í˜¸'},
        3: {yong:'fire', sub:'earth', desc:'å¯(Rabbit) month Woodì™•, with Fire bridging'},
        4: {yong:'water', sub:'fire', desc:'è¾°(Dragon) month Earthê¸°, with Water ì„¤Metal'},
        5: {yong:'water', sub:'earth', desc:'å·³(Snake) month Fire peak, Water ì¡°í›„'},
        6: {yong:'water', sub:'earth', desc:'åˆ(Horse) month Fireê·¹Metal, Water is essential'},
        7: {yong:'water', sub:'earth', desc:'æœª(Goat) month hot dry, with Water cooling down'},
        8: {yong:'water', sub:'fire', desc:'ç”³(Monkey) month Metalì™•, with Water ì„¤ê¸°'},
        9: {yong:'water', sub:'fire', desc:'é…‰(Rooster) month Metalê·¹ì„±, æ°´ç« í•„ìš”'},
        10: {yong:'fire', sub:'water', desc:'æˆŒ(Dog) month EarthìƒMetal, with Fire ë‹¨ë ¨'},
        11: {yong:'fire', sub:'earth', desc:'äº¥(Pig) month Water peak, Fire warmth'}
    },
    // è¾›é‡‘ (ì‹ Metal)
    7: {
        0: {yong:'fire', sub:'earth', desc:'ê²¨ìš¸ ì‹ Metalì€ warming with Fire'},
        1: {yong:'fire', sub:'earth', desc:'ä¸‘(Ox) month í•œMetal, with Fire ì˜¨ê¸°'},
        2: {yong:'water', sub:'fire', desc:'å¯…(Tiger) month Woodê¸°ìš´, with Water ì„¸ì •'},
        3: {yong:'water', sub:'fire', desc:'å¯(Rabbit) month Woodì™•, with Water ìœ¤ê¸°'},
        4: {yong:'water', sub:'fire', desc:'è¾°(Dragon) month Earthê¸°, with Water ì”»ê¹€'},
        5: {yong:'water', sub:'earth', desc:'å·³(Snake) month Fire peak, Water ì¡°í›„'},
        6: {yong:'water', sub:'earth', desc:'åˆ(Horse) month Fireê·¹Metal, Water is essential'},
        7: {yong:'water', sub:'earth', desc:'æœª(Goat) month hot dry, with Water cooling'},
        8: {yong:'water', sub:'fire', desc:'ç”³(Monkey) month Metalì™•, with Water ì„¤ê¸°'},
        9: {yong:'water', sub:'fire', desc:'é…‰(Rooster) month Metalê·¹ì„±, with Water ì„¸ì •'},
        10: {yong:'fire', sub:'water', desc:'æˆŒ(Dog) month Earthê¸°, with Fire ë¹›ë‚¨'},
        11: {yong:'fire', sub:'earth', desc:'äº¥(Pig) month Water peak, Fire balance'}
    },
    // å£¬æ°´ (ì„Water)
    8: {
        0: {yong:'fire', sub:'earth', desc:'ê²¨ìš¸ ì„WaterëŠ” with Fire ì–¼ìŒ ë…¹ì„'},
        1: {yong:'fire', sub:'wood', desc:'ä¸‘(Ox) month í•œWater, with Fire ì˜¨ê¸°'},
        2: {yong:'earth', sub:'fire', desc:'å¯…(Tiger) month WaterìƒWood, åœŸë¡œ ì œì–´'},
        3: {yong:'earth', sub:'fire', desc:'å¯(Rabbit) month Woodê¸°ìš´, åœŸë¡œ ê· í˜•'},
        4: {yong:'metal', sub:'fire', desc:'è¾°(Dragon) month Earthê¸°, with Metal ìƒWater'},
        5: {yong:'metal', sub:'water', desc:'å·³(Snake) month Fireì™•, with Metal ìƒWater'},
        6: {yong:'metal', sub:'water', desc:'åˆ(Horse) month Fire at peak, é‡‘æ°´ í•„ìš”'},
        7: {yong:'metal', sub:'water', desc:'æœª(Goat) month Earth dominant, with Metal bridging'},
        8: {yong:'fire', sub:'earth', desc:'ç”³(Monkey) month MetalìƒWater, with Fire ì¡°ì ˆ'},
        9: {yong:'fire', sub:'earth', desc:'é…‰(Rooster) month Metalì™•, with Fire ê· í˜•'},
        10: {yong:'fire', sub:'wood', desc:'æˆŒ(Dog) month Earthê¸°, with Fire ì˜¨ê¸°'},
        11: {yong:'fire', sub:'wood', desc:'äº¥(Pig) month Waterì™•, ç«ê°€ í•„ìˆ˜'}
    },
    // ç™¸æ°´ (ê³„Water)
    9: {
        0: {yong:'fire', sub:'wood', desc:'ê²¨ìš¸ ê³„WaterëŠ” with Fire ì–¼ìŒ ë…¹ì„'},
        1: {yong:'fire', sub:'wood', desc:'ä¸‘(Ox) month í•œWater, with Fire ì˜¨ê¸°'},
        2: {yong:'fire', sub:'metal', desc:'å¯…(Tiger) month Woodê¸°ìš´, with Fire ì„¤ê¸°'},
        3: {yong:'fire', sub:'metal', desc:'å¯(Rabbit) month Woodì™•, with Fire ê· í˜•'},
        4: {yong:'fire', sub:'metal', desc:'è¾°(Dragon) month Earthê·¹Water, with Fire bridging'},
        5: {yong:'metal', sub:'water', desc:'å·³(Snake) month Fireì™•, with Metal ìƒWater'},
        6: {yong:'metal', sub:'water', desc:'åˆ(Horse) month Fire at peak, é‡‘æ°´ í•„ìš”'},
        7: {yong:'metal', sub:'water', desc:'æœª(Goat) month Earth dominant, with Metal bridging'},
        8: {yong:'fire', sub:'wood', desc:'ç”³(Monkey) month MetalìƒWater, with Fire ì¡°ì ˆ'},
        9: {yong:'fire', sub:'wood', desc:'é…‰(Rooster) month Metalì™•, with Fire ì„¤Metal'},
        10: {yong:'fire', sub:'wood', desc:'æˆŒ(Dog) month Earthê¸°, with Fire ì˜¨ê¸°'},
        11: {yong:'fire', sub:'metal', desc:'äº¥(Pig) month Waterì™•, ç«ê°€ í•„ìˆ˜'}
    }
};

// Temperature-Humidity Balance íŒë‹¨
function analyzeClimate(saju) {
    const mbi = BRANCH.indexOf(saju.month.b);
    const season = SEASON[mbi];
    
    let climate = {type: '', desc: '', needs: []};
    
    // ì§€ì§€ì˜ äº”è¡Œ(Five Elements) Distribution ì²´í¬
    const brs = [saju.year?.b, saju.month?.b, saju.day?.b, saju.hour?.b].filter(b => b);
    let fireCount = 0, waterCount = 0, earthCount = 0;
    brs.forEach(b => {
        if (b.e === 'fire') fireCount++;
        if (b.e === 'water') waterCount++;
        if (b.e === 'earth') earthCount++;
    });
    
    // ê¸°ë³¸ ê¸°í›„ íŒë‹¨
    if (season === 'winter') {
        climate.type = waterCount >= 2 ? 'ê·¹í•œ(æ¥µå¯’)' : 'í•œ(å¯’)';
        climate.desc = 'Cold chart. Needs warming Fire energy.';
        climate.needs = ['fire', 'wood'];
    } else if (season === 'summer') {
        climate.type = fireCount >= 2 ? 'ê·¹ì¡°(æ¥µç‡¥)' : 'ì¡°(ç‡¥)';
        climate.desc = 'Hot and dry chart. Needs cooling Water energy.';
        climate.needs = ['water', 'metal'];
    } else if (mbi === 1 || mbi === 4 || mbi === 7 || mbi === 10) {
        // Earth dominant season
        if (earthCount >= 2) {
            climate.type = 'ìŠµ(æ¿•)';
            climate.desc = 'Humid chart. Needs Fire to dry.';
            climate.needs = ['fire', 'wood'];
        } else {
            climate.type = 'Balanced(ä¸­å’Œ)';
            climate.desc = 'Balanced climate chart.';
            climate.needs = [];
        }
    } else {
        climate.type = 'ì˜¨(æº«)';
        climate.desc = 'Mild and temperate chart.';
        climate.needs = [];
    }
    
    return climate;
}

// ë³‘ì•½(ç—…è—¥) ìš©ì‹  ì°¾ê¸°
function findByungYak(saju, strength) {
    const dm = saju.day.s;
    const dmi = STEM.indexOf(dm);
    const ec = countElements(saju);
    
    let byung = null, yak = null;
    
    // ê°€ì¥ ë§ì€ ì˜¤í–‰ (ë³‘)
    let maxEl = null, maxCount = 0;
    for (let e of EL_ORDER) {
        if (ec[e] > maxCount && e !== dm.e) {
            maxCount = ec[e];
            maxEl = e;
        }
    }
    
    if (maxCount >= 3) {
        byung = maxEl;
        // ì•½(è—¥) ì°¾ê¸° - ë³‘ì„ ì œì–´í•˜ëŠ” ì˜¤í–‰
        const kontrolIdx = (EL_ORDER.indexOf(maxEl) + 3) % 5;
        yak = EL_ORDER[kontrolIdx];
    }
    
    return { byung, yak, desc: byung ? `${ELEMENT[byung].k}ì´ ê³¼ë‹¤í•˜ë‹ˆ ${ELEMENT[yak].k}ìœ¼ë¡œ ì œì–´` : null };
}

function calcGods(saju, str) {
    const dm = saju.day.s;
    const dmi = STEM.indexOf(dm);
    const mbi = BRANCH.indexOf(saju.month.b);
    const season = SEASON[mbi];
    let yong, hee, gi, johu = null, johuDesc = '';
    
    // 1. ê¸°ë³¸ ìš©ì‹  (Strong/Weak ê¸°ì¤€)
    if (str.type === 'strong') { 
        yong = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5]; // ì¬ì„±
        hee = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5]; // ì‹ìƒ
        gi = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 4) % 5];  // ì¸ì„±
    }
    else if (str.type === 'weak') { 
        yong = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 4) % 5]; // ì¸ì„±
        hee = dm.e; // ë¹„ê²
        gi = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 3) % 5];  // ê´€ì‚´
    }
    else { 
        yong = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5]; // ì‹ìƒ
        hee = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5]; // ì¬ì„±
        gi = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 3) % 5];  // ê´€ì‚´
    }
    
    // 2. ì¡°í›„ìš©ì‹  ê³ ê¸‰ ì ìš© (ì›”ë³„ í…Œì´ë¸” ì‚¬ìš©)
    const johuData = JOHU_TABLE[dmi] && JOHU_TABLE[dmi][mbi];
    if (johuData) {
        johu = johuData.yong;
        johuDesc = johuData.desc;
        
        // ì¡°í›„ìš©ì‹ ì´ ê¸°ì‹ ì´ ì•„ë‹ˆë©´ ìš°ì„  ì ìš©
        if (johu !== gi) {
            hee = yong;
            yong = johu;
        }
    }
    
    // 3. í•œë‚œdamp balance ë¶„ì„
    const climate = analyzeClimate(saju);
    
    // 4. ë³‘ì•½ ë¶„ì„
    const byungYak = findByungYak(saju, str);
    
    return { 
        yong, hee, gi, 
        type: str.type, 
        johu, johuDesc,
        climate,
        byungYak,
        sub: johuData?.sub || null
    };
}

/* ========================================
   9-5. ìœ¡ì¹œ(å…­è¦ª) ì •ë°€ ë¶„ì„
   ======================================== */

// ìœ¡ì¹œ ì •ì˜
const YUKCHEON = {
    m: { // ë‚¨ì
        'æ¯”è‚©(Peer)': {relation: 'í˜•ì œ/ì¹œêµ¬', desc: 'ë‚˜ì™€ ë™ë“±í•œ ê´€ê³„', detailed: 'í˜•ì œìë§¤, ì¹œêµ¬, ë™ë£Œ, ê²½ìŸì'},
        'åŠ«è²¡(Rob Wealth)': {relation: 'í˜•ì œ/ê²½ìŸì', desc: 'ë‚˜ì™€ ê²½ìŸí•˜ëŠ” ê´€ê³„', detailed: 'ì´ë³µí˜•ì œ, ì‚¬ì´Œ, ê²½ìŸì, ë™ì—…ì'},
        'é£Ÿç¥(Eating God)': {relation: 'ìë…€(ë”¸)/í›„ë°°', desc: 'ë‚´ê°€ ë‚³ì€ ê²ƒ', detailed: 'ë”¸, ì†ë…€, í›„ë°°, ë¶€í•˜, ì œì'},
        'å‚·å®˜(Hurting Officer)': {relation: 'ìë…€(ì•„ë“¤)/ì¬ëŠ¥', desc: 'ë‚´ê°€ í‘œí˜„í•˜ëŠ” ê²ƒ', detailed: 'Son, grandson, creativity, ideas'},
        'åè²¡(Indirect Wealth)': {relation: 'ì•„ë²„ì§€/ì• ì¸', desc: 'ë‚´ê°€ ë‹¤ìŠ¤ë¦¬ëŠ” ì¬Water', detailed: 'Father, mistress, lover, entertainment, speculation'},
        'æ­£è²¡(Direct Wealth)': {relation: 'Wife/Wealth', desc: 'ë‚´ê°€ ì§€í‚¤ëŠ” ì¬Water', detailed: 'ì•„ë‚´, ì •ì—…ìœ¼ë¡œ ë²ˆ ëˆ, ê¸‰ì—¬'},
        'åå®˜(Seven Killings)': {relation: 'Children(son)/Career', desc: 'ë‚˜ë¥¼ ë‹¤ìŠ¤ë¦¬ëŠ” ê²ƒ', detailed: 'ì•„ë“¤, ì§ì¥ìƒì‚¬, ê¶Œë ¥, ì••ë°•'},
        'æ­£å®˜(Direct Officer)': {relation: 'ìë…€(ë”¸)/ëª…ì˜ˆ', desc: 'ë‚˜ë¥¼ ë°”ë¥´ê²Œ í•˜ëŠ” ê²ƒ', detailed: 'Daughter, honor, career, law'},
        'åå°(Indirect Seal)': {relation: 'ê³„ëª¨/ì˜ë¶€', desc: 'ë‚˜ë¥¼ í¸ì¤‘ë˜ê²Œ ê¸°ë¥´ëŠ” ê²ƒ', detailed: 'Stepmother, foster mother'},
        'æ­£å°(Direct Seal)': {relation: 'ì–´ë¨¸ë‹ˆ/í•™ë¬¸', desc: 'ë‚˜ë¥¼ ë°”ë¥´ê²Œ ê¸°ë¥´ëŠ” ê²ƒ', detailed: 'Mother, studies, documents, certificates'}
    },
    f: { // ì—¬ì
        'æ¯”è‚©(Peer)': {relation: 'ìë§¤/ì¹œêµ¬', desc: 'ë‚˜ì™€ ë™ë“±í•œ ê´€ê³„', detailed: 'ìë§¤, ì¹œêµ¬, ë™ë£Œ, ê²½ìŸì'},
        'åŠ«è²¡(Rob Wealth)': {relation: 'ìë§¤/ê²½ìŸì', desc: 'ë‚˜ì™€ ê²½ìŸí•˜ëŠ” ê´€ê³„', detailed: 'ì´ë³µìë§¤, ì‚¬ì´Œ, ê²½ìŸì'},
        'é£Ÿç¥(Eating God)': {relation: 'ìë…€(ë”¸)/ì¬ëŠ¥', desc: 'ë‚´ê°€ ë‚³ì€ ê²ƒ', detailed: 'ë”¸, ì†ë…€, í‘œí˜„ë ¥, ì¬ëŠ¥'},
        'å‚·å®˜(Hurting Officer)': {relation: 'ìë…€(ì•„ë“¤)/ì´ì„±', desc: 'ë‚´ê°€ í‘œí˜„í•˜ëŠ” ê²ƒ', detailed: 'ì•„ë“¤, ì†ì, ì—°ì¸, ë§¤ë ¥'},
        'åè²¡(Indirect Wealth)': {relation: 'ì‹œì•„ë²„ì§€/ì¬Water', desc: 'ë‚´ê°€ ë‹¤ìŠ¤ë¦¬ëŠ” ì¬Water', detailed: 'ì‹œì•„ë²„ì§€, íˆ¬ê¸°ì¬, íš¡ì¬'},
        'æ­£è²¡(Direct Wealth)': {relation: 'ì‹œì–´ë¨¸ë‹ˆ/ì¬ì‚°', desc: 'ë‚´ê°€ ì§€í‚¤ëŠ” ì¬Water', detailed: 'ì‹œì–´ë¨¸ë‹ˆ, ì •ì—…ì¬, ê¸‰ì—¬'},
        'åå®˜(Seven Killings)': {relation: 'ì• ì¸/ë‚¨ì', desc: 'ë‚˜ë¥¼ ë‹¤ìŠ¤ë¦¬ëŠ” ê²ƒ', detailed: 'ì• ì¸, ë°”ëŒ, ì™¸ë„ë‚¨, í­ë ¥ë‚¨'},
        'æ­£å®˜(Direct Officer)': {relation: 'ë‚¨í¸/ëª…ì˜ˆ', desc: 'ë‚˜ë¥¼ ë°”ë¥´ê²Œ í•˜ëŠ” ê²ƒ', detailed: 'ë‚¨í¸, ëª…ì˜ˆ, ì§ì¥'},
        'åå°(Indirect Seal)': {relation: 'ê³„ëª¨/ì¥ì• ', desc: 'ë‚˜ë¥¼ í¸ì¤‘ë˜ê²Œ ê¸°ë¥´ëŠ” ê²ƒ', detailed: 'ê³„ëª¨, ì˜ëª¨, Fireì™„ì „í•œ í•™ì—…'},
        'æ­£å°(Direct Seal)': {relation: 'ì–´ë¨¸ë‹ˆ/í•™ë¬¸', desc: 'ë‚˜ë¥¼ ë°”ë¥´ê²Œ ê¸°ë¥´ëŠ” ê²ƒ', detailed: 'ì–´ë¨¸ë‹ˆ, í•™ì—…, ë¬¸ì„œ'}
    }
};

// ìœ¡ì¹œ ìœ„ì¹˜ë³„ ì˜ë¯¸
const YUKCHEON_POSITION = {
    year: {name: 'å¹´æŸ±(å¹´æŸ±(Year Pillar))', meaning: 'ì¡°ìƒ, ì‚¬íšŒ, Early years(Ages 1-15)', body: 'ë¨¸ë¦¬/ì–¼êµ´'},
    month: {name: 'Month', meaning: 'ë¶€ëª¨, í˜•ì œ, ì§ì—…, Youth(Ages 16-30)', body: 'ê°€ìŠ´/ì–´ê¹¨'},
    day: {name: 'Day', meaning: 'Self, ë°°ìš°ì, ê°€ì •, Middle age(Ages 31-45)', body: 'í—ˆë¦¬/ë³µë¶€'},
    hour: {name: 'Hour', meaning: 'Children, juniors, ë§ë…„(46ì„¸+)', body: 'ë‹¤ë¦¬/ë°œ'}
};

// ìœ¡ì¹œ ì •ë°€ ë¶„ì„
function analyzeYukcheon(saju, gender) {
    const dm = saju.day.s;
    const g = gender || GENDER || 'm';
    const yukData = YUKCHEON[g];
    
    const result = {
        positions: [],   // ê° ìœ„ì¹˜ë³„ ìœ¡ì¹œ
        counts: {},      // ìœ¡ì¹œë³„ ê°œìˆ˜
        analysis: [],    // ì¢…í•© ë¶„ì„
        spouse: null,    // Spouse Analysis
        children: null,  // Children Analysis
        parents: null    // Parents Analysis
    };
    
    const pillars = [
        {pos: 'year', pillar: saju.year},
        {pos: 'month', pillar: saju.month},
        {pos: 'day', pillar: saju.day},
        {pos: 'hour', pillar: saju.hour}
    ];
    
    // ê° ê¸°ë‘¥ ë¶„ì„
    pillars.forEach(({pos, pillar}) => {
        if (!pillar) return;
        
        // ì²œê°„ ì‹­ì‹ 
        const stemGod = pos === 'day' ? {k: 'æ—¥ä¸»(Day Master)', c: 'æ—¥å¹²'} : getTenGod(pillar.s, dm);
        
        // ì§€ì§€ ë³¸ê¸° ì‹­ì‹ 
        const mainJJ = JIJANGGAN[BRANCH.indexOf(pillar.b)];
        const mainStem = mainJJ && mainJJ.length > 0 ? STEM[mainJJ[mainJJ.length - 1].stem] : null;
        const branchGod = mainStem ? getTenGod(mainStem, dm) : null;
        
        const posInfo = YUKCHEON_POSITION[pos];
        const yukInfo = yukData[stemGod.k];
        
        result.positions.push({
            position: pos,
            posName: posInfo.name,
            posMeaning: posInfo.meaning,
            stem: pillar.s,
            branch: pillar.b,
            stemGod: stemGod.k,
            branchGod: branchGod ? branchGod.k : null,
            relation: yukInfo ? yukInfo.relation : 'Self',
            detailed: yukInfo ? yukInfo.detailed : 'ìê¸° ìì‹ '
        });
        
        // ê°œìˆ˜ ì§‘ê³„
        if (stemGod.k !== 'æ—¥ä¸»(Day Master)') {
            result.counts[stemGod.k] = (result.counts[stemGod.k] || 0) + 1;
        }
        if (branchGod) {
            result.counts[branchGod.k] = (result.counts[branchGod.k] || 0) + 0.5;
        }
    });
    
    // ========== Spouse Analysis ==========
    const spouseGod = g === 'm' ? 'æ­£è²¡(Direct Wealth)' : 'æ­£å®˜(Direct Officer)';
    const spouseCount = result.counts[spouseGod] || 0;
    const dayBranchState = getTwelveState(dm, saju.day.b);
    
    let spouseAnalysis = '';
    if (spouseCount === 0) {
        spouseAnalysis = 'Spouse star absent. Marriage may come late or bonds may be weak. Romance arrives when it appears in å¤§é‹(Life Cycle).';
    } else if (spouseCount >= 2) {
        spouseAnalysis = 'Strong spouse energy. Popular with opposite sex but watch for infidelity! Focus on one person.';
    } else {
        spouseAnalysis = 'Good spouse energy. You can meet a good partner.';
    }
    
    result.spouse = {
        god: spouseGod,
        count: spouseCount,
        dayBranch: dayBranchState,
        analysis: spouseAnalysis
    };
    
    // ========== Children Analysis ==========
    const childGod = g === 'm' ? ['åå®˜(Seven Killings)', 'æ­£å®˜(Direct Officer)'] : ['é£Ÿç¥(Eating God)', 'å‚·å®˜(Hurting Officer)'];
    const childCount = (result.counts[childGod[0]] || 0) + (result.counts[childGod[1]] || 0);
    const hourPillar = saju.hour;
    
    let childAnalysis = '';
    if (!hourPillar) {
        childAnalysis = 'Birth hour needed for children analysis.';
    } else if (childCount === 0) {
        childAnalysis = 'Children star absent. May have children late or few.';
    } else if (childCount >= 2) {
        childAnalysis = 'Strong children stars. Blessed with children fortune.';
    } else {
        childAnalysis = 'Moderate children fortune.';
    }
    
    result.children = {
        gods: childGod,
        count: childCount,
        analysis: childAnalysis
    };
    
    // ========== Parents Analysis ==========
    const fatherGod = 'åè²¡(Indirect Wealth)';
    const motherGod = 'æ­£å°(Direct Seal)';
    const fatherCount = result.counts[fatherGod] || 0;
    const motherCount = result.counts[motherGod] || 0;
    
    result.parents = {
        father: {god: fatherGod, count: fatherCount, analysis: fatherCount > 0 ? 'Strong father connection.' : 'Weak father connection.'},
        mother: {god: motherGod, count: motherCount, analysis: motherCount > 0 ? 'Deep mother connection.' : 'Somewhat weak mother connection.'}
    };
    
    // ========== ì¢…í•© ë¶„ì„ ==========
    // ìœ¡ì¹œ ë‹¤ê³¼(å¤šå¯¡) ë¶„ì„
    for (let [god, count] of Object.entries(result.counts)) {
        if (count >= 2) {
            const info = yukData[god];
            if (info) {
                result.analysis.push({
                    type: 'many',
                    god,
                    count,
                    meaning: `${god} appears many times. Significant life events related to this relation..`
                });
            }
        }
    }
    
    // ì—†ëŠ” ìœ¡ì¹œ ì²´í¬
    const allGods = ['æ¯”è‚©(Peer)','åŠ«è²¡(Rob Wealth)','é£Ÿç¥(Eating God)','å‚·å®˜(Hurting Officer)','åè²¡(Indirect Wealth)','æ­£è²¡(Direct Wealth)','åå®˜(Seven Killings)','æ­£å®˜(Direct Officer)','åå°(Indirect Seal)','æ­£å°(Direct Seal)'];
    allGods.forEach(god => {
        if (!result.counts[god]) {
            const info = yukData[god];
            if (info) {
                result.analysis.push({
                    type: 'none',
                    god,
                    meaning: `${god}is missing. This connection may be weak in life..`
                });
            }
        }
    });
    
    return result;
}

/* ========================================
   10. ê²©êµ­(æ ¼å±€) ì •ë°€ íŒì •
   ======================================== */
   
// ë‚´ê²©(å…§æ ¼) 8ê²© ë°ì´í„°
const FORMATS_INNER = {
    'æ¯”è‚©(Peer)':{n:'æ¯”è‚©æ ¼(Peer Structure) (æ¯”è‚©æ ¼)',d:'The Self-Made Soul. Fierce independence and competitive fire drive you to forge your own path. Deep bonds with siblings and partners lead to success through collaboration. Channel your strong will with flexibility, and kingdoms will rise at your command.',b:'Entrepreneurship, Freelance, Athletics, Competition',lv:'Medium'},
    'åŠ«è²¡(Rob Wealth)':{n:'åŠ«è²¡æ ¼(Rob Wealth Structure) (åŠ«è²¡æ ¼)',d:'The Bold Challenger. Daring ambition and unshakeable courage propel you toward grand ventures. Your hunger for victory runs deep â€” balance boldness with patience, and fortune shall favor the persistent warrior.',b:'Investment, Venture Capital, Sales, High-Risk Enterprise',lv:'Challenging'},
    'é£Ÿç¥(Eating God)':{n:'é£Ÿç¥æ ¼(Eating God Structure) (é£Ÿç¥æ ¼)',d:'The Blessed Creator. Heaven has bestowed abundant talents and life\'s pleasures upon you. Artistic brilliance flows naturally, and fortune follows your optimistic spirit. Guard against complacency â€” your gifts multiply when cultivated with diligence.',b:'Culinary Arts, Entertainment, Education, Creative Fields',lv:'Excellent'},
    'å‚·å®˜(Hurting Officer)':{n:'å‚·å®˜æ ¼(Hurting Officer Structure) (å‚·å®˜æ ¼)',d:'The Rebel Genius. Brilliant creativity and sharp wit define your unconventional soul. Your free spirit resists all chains â€” temper your tongue, for words cut deeper than swords. Channel rebellion into artistry, and the world will remember your name.',b:'Entertainment, Arts, Public Speaking, Innovation',lv:'Medium'},
    'åè²¡(Indirect Wealth)':{n:'åè²¡æ ¼(Indirect Wealth Structure) (åè²¡æ ¼)',d:'The Fortune Magnet. Business intuition and investment instincts run through your veins. Windfall opportunities find you naturally â€” wide social networks amplify your luck. Guard your wandering heart, for stability nurtures lasting prosperity.',b:'Trading, Investment, Sales, Networking',lv:'Excellent'},
    'æ­£è²¡(Direct Wealth)':{n:'æ­£è²¡æ ¼(Direct Wealth Structure) (æ­£è²¡æ ¼)',d:'The Steady Builder. Honest accumulation and patient persistence build your empire brick by brick. Trustworthiness is your greatest currency â€” loyal partnerships and domestic harmony crown your efforts. Wealth grows slowly but eternally under your stewardship.',b:'Finance, Accounting, Management, Civil Service',lv:'Excellent'},
    'åå®˜(Seven Killings)':{n:'åå®˜æ ¼(Seven Killings Structure) (ä¸ƒæ®ºæ ¼)',d:'The Warrior Commander. Charisma and decisive action forge your path to power. The fire of ambition burns bright within â€” master this force, and you become a legendary leader. Unchecked, it creates enemies. Refined, it conquers worlds.',b:'Military, Law, Politics, Martial Arts, Athletics',lv:'Medium'},
    'æ­£å®˜(Direct Officer)':{n:'æ­£å®˜æ ¼(Direct Officer Structure) (æ­£å®˜æ ¼)',d:'The Noble Authority. Dignity and honor illuminate your every step. Organizations recognize your worth and elevate you swiftly. The cosmos favor those who walk the righteous path â€” your integrity becomes your crown.',b:'Government, Corporation, Law, Education',lv:'Supreme'},
    'åå°(Indirect Seal)':{n:'åå°æ ¼(Indirect Seal Structure) (åå°æ ¼)',d:'The Mystic Scholar. Unconventional wisdom and esoteric knowledge call to your soul. Religious, philosophical, and occult matters fascinate your unique mind. Focus your scattered brilliance, and profound discoveries await.',b:'Research, Technology, Spirituality, Medicine',lv:'Medium'},
    'æ­£å°(Direct Seal)':{n:'æ­£å°æ ¼(Direct Seal Structure) (æ­£å°æ ¼)',d:'The Blessed Scholar. Heaven\'s favor flows through maternal bonds and elder blessings. Academic pursuits and teaching call to your gentle soul. Your compassionate nature nurtures all who enter your sphere.',b:'Education, Publishing, Academia, Welfare',lv:'Excellent'}
};

// Special Structures (å¤–æ ¼) - Extraordinary destiny patterns
const FORMATS_SPECIAL = {
    'jongwang': {n:'å¾æ—ºæ ¼(Following Power) (å¾æ—ºæ ¼)', d:'Your Guardian Element blazes with overwhelming force. The cosmos demand you forge your own empire â€” working under others suffocates your spirit. CEOs, entrepreneurs, and independent visionaries carry this rare blessing. Trust your unstoppable will.', b:'CEO, Entrepreneur, Political Leader, Independent Expert', lv:'Special'},
    'jonggang': {n:'å¾å¼·æ ¼(Following Seal) (å¾å¼·æ ¼)', d:'Guardian Element and Seal energy unite in formidable strength. Academic glory and institutional authority await your claim. Professors, researchers, and high officials often bear this distinguished pattern.', b:'Professor, Researcher, High Government Official', lv:'Special'},
    'jonga': {n:'å¾å…’æ ¼(Following Expression) (å¾å…’æ ¼)', d:'Creative energy overflows from your soul. Artistic brilliance and expressive genius demand freedom â€” the stage, the canvas, the page all await your unique voice. Let your spirit roam free.', b:'Artist, Entertainer, Author, Content Creator', lv:'Special'},
    'jongjae': {n:'å¾è²¡æ ¼(Following Wealth) (å¾è²¡æ ¼)', d:'Wealth energy dominates your chart with magnetic force. Financial mastery flows through your veins â€” business empires and investment fortunes bend to your intuition. Money and you share a destined bond.', b:'Financier, Business Mogul, Investor, Real Estate', lv:'Special'},
    'jongsal': {n:'å¾æ®ºæ ¼(Following Authority) (å¾æ®ºæ ¼)', d:'Commanding energy fills every corner of your being. Power and prestige call to your warrior soul â€” military leadership, political influence, and executive authority become your natural domain.', b:'Military Leader, Politician, Executive, Judge', lv:'Special'},
    'yangin': {n:'ç¾Šåˆƒ(ç¾Šåˆƒ(Sheep Blade)) Structure (ç¾Šåˆƒæ ¼)', d:'The cosmic blade rests in your æ—¥æŸ±(æ—¥æŸ±(Day Pillar)) â€” extraordinary power courses through you. Decisive action and crisis mastery define your path. Sharp edges may wound the careless, but heroes are forged from such steel.', b:'Military, Surgeon, Lawyer, Elite Athlete', lv:'Special'},
    'geonrok': {n:'å»ºç¥¿æ ¼(Prime Structure) (å»ºç¥¿æ ¼)', d:'Your Month Palace holds the Prime energy of your Guardian Element. Self-made success through persistent effort awaits â€” career stability and mid-life prosperity reward your steady climb.', b:'Civil Service, Professional, Self-Employed', lv:'Excellent'},
    'woldeok': {n:'æœˆå¾·æ ¼(Moon Virtue Structure) (æœˆå¾·æ ¼)', d:'The Moon\'s blessing graces your chart. Virtue attracts aid in times of need â€” your trustworthy character opens doors that remain closed to others. Official fortune shines upon you.', b:'Government, Education, Religious Service', lv:'Excellent'}
};

// ê²©êµ­ ì„±íŒ¨(æˆæ•—) íŒë‹¨
function isFormatBroken(saju, formatGod) {
    const dm = saju.day.s;
    const dmEl = dm.e;
    const breakReasons = [];
    
    // Direct Officerê²© íŒŒê²© ì¡°ê±´: å‚·å®˜(Hurting Officer)ì´ ìˆìœ¼ë©´ íŒŒê²© (Hurting Officerê²¬ê´€)
    if (formatGod === 'æ­£å®˜(Direct Officer)') {
        const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
        for (let p of allPillars) {
            const god = getTenGod(p.s, dm);
            if (god.k === 'å‚·å®˜(Hurting Officer)') {
                breakReasons.push('Hurting Officerê²¬ê´€(å‚·å®˜è¦‹å®˜): å‚·å®˜(Hurting Officer)ì´ Direct Officerì„ ê·¹í•˜ì—¬ íŒŒê²©');
            }
        }
    }
    
    // Eating Godê²© íŒŒê²© ì¡°ê±´: åå°(Indirect Seal)ì´ ìˆìœ¼ë©´ íŒŒê²© (íš¨ì‹ íƒˆì‹)
    if (formatGod === 'é£Ÿç¥(Eating God)') {
        const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
        for (let p of allPillars) {
            const god = getTenGod(p.s, dm);
            if (god.k === 'åå°(Indirect Seal)') {
                breakReasons.push('íš¨ì‹ íƒˆì‹(æ¢Ÿç¥å¥ªé£Ÿ): åå°(Indirect Seal)ì´ Eating Godì„ ê·¹í•˜ì—¬ íŒŒê²©');
            }
        }
    }
    
    // ì¬ê²© íŒŒê²© ì¡°ê±´: ë¹„ê²ì´ ë§ìœ¼ë©´ íŒŒê²© (êµ°ê²ìŸì¬)
    if (formatGod === 'æ­£è²¡(Direct Wealth)' || formatGod === 'åè²¡(Indirect Wealth)') {
        let biCount = 0;
        const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
        for (let p of allPillars) {
            const god = getTenGod(p.s, dm);
            if (god.k === 'æ¯”è‚©(Peer)' || god.k === 'åŠ«è²¡(Rob Wealth)') biCount++;
        }
        if (biCount >= 2) {
            breakReasons.push('êµ°ê²ìŸì¬(ç¾¤åŠ«çˆ­è²¡): ë¹„ê²ì´ ë§ì•„ ì¬ë¥¼ ë¹¼ì•—ê¹€');
        }
    }
    
    return breakReasons;
}

// íŠ¹ìˆ˜ê²© (ì¢…ê²©) íŒì •
function checkSpecialFormat(saju, strength) {
    if (!strength.extreme) return null;
    
    const dm = saju.day.s;
    const ec = countElements(saju);
    const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
    
    // ì˜¤í–‰ë³„ ì‹­ì‹  ê°œìˆ˜ ì„¸ê¸°
    const godCounts = {bigeop:0, sikSang:0, jae:0, gwan:0, in:0};
    
    allPillars.forEach(p => {
        const god = getTenGod(p.s, dm);
        if (['æ¯”è‚©(Peer)','åŠ«è²¡(Rob Wealth)'].includes(god.k)) godCounts.bigeop++;
        if (['é£Ÿç¥(Eating God)','å‚·å®˜(Hurting Officer)'].includes(god.k)) godCounts.sikSang++;
        if (['åè²¡(Indirect Wealth)','æ­£è²¡(Direct Wealth)'].includes(god.k)) godCounts.jae++;
        if (['åå®˜(Seven Killings)','æ­£å®˜(Direct Officer)'].includes(god.k)) godCounts.gwan++;
        if (['åå°(Indirect Seal)','æ­£å°(Direct Seal)'].includes(god.k)) godCounts.in++;
    });
    
    if (strength.extreme === 'ê·¹Strong') {
        // ì¢…ì™•ê²©: ë¹„ê²ì´ ë§¤ìš° ë§ìŒ
        if (godCounts.bigeop >= 3) return FORMATS_SPECIAL.jongwang;
        // ì¢…ê°•ê²©: ì¸ì„±ì´ ë§¤ìš° ë§ìŒ
        if (godCounts.in >= 2 && godCounts.bigeop >= 2) return FORMATS_SPECIAL.jonggang;
    }
    
    if (strength.extreme === 'ê·¹Weak') {
        // ì¢…ì•„ê²©: ì‹ìƒì´ ë§¤ìš° ë§ìŒ
        if (godCounts.sikSang >= 3) return FORMATS_SPECIAL.jonga;
        // ì¢…ì¬ê²©: ì¬ì„±ì´ ë§¤ìš° ë§ìŒ
        if (godCounts.jae >= 3) return FORMATS_SPECIAL.jongjae;
        // ì¢…ì‚´ê²©: ê´€ì‚´ì´ ë§¤ìš° ë§ìŒ
        if (godCounts.gwan >= 3) return FORMATS_SPECIAL.jongsal;
    }
    
    return null;
}

// ì–‘ì¸ê²©, Primeê²© ì²´í¬
function checkYangInGeonRok(saju) {
    const dm = saju.day.s;
    const dsi = STEM.indexOf(dm);
    const mbi = BRANCH.indexOf(saju.month.b);
    
    // Prime ìœ„ì¹˜ (æ—¥ä¸»(Day Master)ë³„ Primeì§€)
    const geonrokMap = {0:2, 1:3, 2:5, 3:6, 4:5, 5:6, 6:8, 7:9, 8:11, 9:0}; // ê°‘-ì¸, ì„-ë¬˜...
    // ì–‘ì¸ ìœ„ì¹˜ (Prime ë‹¤ìŒ)
    const yanginMap = {0:3, 1:2, 2:6, 3:5, 4:6, 5:5, 6:9, 7:8, 8:0, 9:11}; // ê°‘-ë¬˜, ì„-ì¸...
    
    // Month Branchê°€ Primeì§€ë©´ Primeê²©
    if (mbi === geonrokMap[dsi]) {
        return FORMATS_SPECIAL.geonrok;
    }
    
    // Day Branchê°€ ì–‘ì¸ì´ë©´ ì–‘ì¸ê²©
    const dbi = BRANCH.indexOf(saju.day.b);
    if (dbi === yanginMap[dsi]) {
        return {...FORMATS_SPECIAL.yangin, hasYangIn: true};
    }
    
    return null;
}

// í†µí•© ê²©êµ­ íŒì •
function calcFormat(saju, strength) {
    const str = strength || calcStrength(saju);
    
    // 1. íŠ¹ìˆ˜ê²© ì²´í¬
    const specialFormat = checkSpecialFormat(saju, str);
    if (specialFormat) {
        return {...specialFormat, type:'special', god:'íŠ¹ìˆ˜'};
    }
    
    // 2. ì–‘ì¸ê²©/Primeê²© ì²´í¬
    const yangInGeonRok = checkYangInGeonRok(saju);
    if (yangInGeonRok && yangInGeonRok.n.includes('ì–‘ì¸')) {
        return {...yangInGeonRok, type:'special', god:'ì–‘ì¸'};
    }
    
    // 3. ë‚´ê²© íŒì • (Month Branch æ”¯è—å¹²(Hidden Stems) Mainì˜ ì‹­ì‹ )
    const mbi = BRANCH.indexOf(saju.month.b);
    const jj = JIJANGGAN[mbi];
    
    // Main(ë³¸ê¸°) ì°¾ê¸°
    const mainJj = jj.find(j => j.days >= 16) || jj[jj.length - 1];
    const mainStem = STEM[mainJj.stem];
    const god = getTenGod(mainStem, saju.day.s);
    
    // ì›”ê°„ ì‹­ì‹ ë„ ì²´í¬ (íˆ¬ì¶œ ì—¬ë¶€)
    const monthGod = getTenGod(saju.month.s, saju.day.s);
    
    // íˆ¬ì¶œëœ ì‹­ì‹ ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ê²©êµ­ìœ¼ë¡œ
    let finalGod = god.k;
    if (['é£Ÿç¥(Eating God)','å‚·å®˜(Hurting Officer)','åè²¡(Indirect Wealth)','æ­£è²¡(Direct Wealth)','åå®˜(Seven Killings)','æ­£å®˜(Direct Officer)','åå°(Indirect Seal)','æ­£å°(Direct Seal)'].includes(monthGod.k)) {
        // ì›”ê°„ì´ Month Branch æ”¯è—å¹²(Hidden Stems)ì— í†µê·¼í•˜ëŠ”ì§€ í™•ì¸
        const monthStemIdx = STEM.indexOf(saju.month.s);
        if (jj.some(j => j.stem === monthStemIdx)) {
            finalGod = monthGod.k; // íˆ¬ì¶œëœ ì‹­ì‹ ì´ ê²©êµ­
        }
    }
    
    // Primeê²© ì²´í¬
    if (yangInGeonRok && yangInGeonRok.n.includes('è‡¨å®˜(Official)')) {
        return {...yangInGeonRok, type:'inner', god:'è‡¨å®˜(Official)'};
    }
    
    // 4. íŒŒê²© ì—¬ë¶€ ì²´í¬
    const breakReasons = isFormatBroken(saju, finalGod);
    
    const f = FORMATS_INNER[finalGod] || FORMATS_INNER['æ­£å®˜(Direct Officer)'];
    return {
        ...f,
        god: finalGod,
        type: 'inner',
        broken: breakReasons.length > 0,
        breakReasons,
        tougan: monthGod.k !== god.k ? monthGod.k : null
    };
}

// ê¸°ì¡´ ë‹¨ìˆœ ë²„ì „ (í˜¸í™˜ìš©)
function calcFormatSimple(saju) {
    const god = getTenGod(saju.month.s, saju.day.s);
    const f = FORMATS_INNER[god.k] || FORMATS_INNER['æ­£å®˜(Direct Officer)'];
    f.god = god.k;
    return f;
}

function getIljuDesc(ds, db) {
    // 60ê°‘ì Day ìƒì„¸ í•´ì„¤
    const iljuData = {
        'ç”²å­':{t:'ç”²å­(ê°‘ì)Day - Great tree above the ocean',d:'å­æ°´ê°€ ç”²æœ¨ì„ ìƒí•´ì£¼ë‹ˆ Brilliant mind with scholarly gifts. Intelligent and organized but sometimes prone to worry. Night birth is especially favorable. Deep bond with spouse.',s:'Spouse is intellectual and supportive. Younger partners suit you. Water brings romantic encounters.'},
        'ç”²å¯…':{t:'ç”²å¯…(ê°‘ì¸)Day - Tree riding a tiger',d:'Same element as Day Branch brings strong pride and independence. Firstborn qualities with leadership potential. Stubborn and competitive nature.',s:'Spouse also has strong pride â€” expect clashes. Mutual compromise is essential.'},
        'ç”²è¾°':{t:'ç”²è¾°(ê°‘ì§„)Day - Tree ascending on a dragon',d:'Chen Earth roots the Wood, bringing abundant talent. Great ambition with desire for success. Scholar star energy grants academic prowess and social recognition.',s:'Spouse is reliable with wealth fortune. Good compatibility with Rabbit and Rooster signs.'},
        'ç”²åˆ':{t:'ç”²åˆ(ê°‘ì˜¤)Day - Tree standing tall under the sun',d:'Wood creates Fire bringing talent to bloom. Glamorous with exceptional artistic sense. Quick tempered, passionate, and popular.',s:'Spouse is lively and sociable. Fiery temperaments may clash â€” mutual respect is key.'},
        'ç”²ç”³':{t:'ç”²ç”³(ê°‘ì‹ )Day - Tree struck by an axe',d:'Metal attacks Wood bringing trials but overcoming makes you stronger. Develops decisiveness, drive, and resilience. Career fortune is present.',s:'Conflicts with spouse may arise. Accept differences and show consideration.'},
        'ç”²æˆŒ':{t:'ç”²æˆŒ(ê°‘ìˆ )Day - Tree on autumn mountain',d:'Xu Earth contains Metal attacking Wood bringing solitude. Artistic talent with interest in religion and philosophy. Late bloomer type.',s:'Late marriage likely. Guard against separation.'},
        'ä¹™ä¸‘':{t:'ä¹™ä¸‘(ì„ì¶•)Day - Small grass in winter soil',d:'Chou Earth roots the Yi Wood bringing persistence. Diligent, realistic, steadily accumulates wealth. May be introverted and passive.',s:'Spouse is dependable and financially stable.'},
        'ä¹™å¯':{t:'ä¹™å¯(ì„ë¬˜)Day - Spring flower',d:'Same element brings clear personal principles. Delicate, artistic, and popular. Gentle appearance hides stubborn nature.',s:'Spouse shares similar traits. With mutual respect, a blessed union.'},
        'ä¹™å·³':{t:'ä¹™å·³(ì„ì‚¬)Day - Flower bathed in sunlight',d:'Wood creates Fire releasing talents. Brilliant speaker with great social skills. Popular with opposite sex and blessed romance fortune.',s:'Spouse is passionate and fiery. Guard against infidelity!'},
        'ä¹™æœª':{t:'ä¹™æœª(ì„ë¯¸)Day - Garden flower in summer',d:'Wood controls Earth bringing business acumen. Artistic sense with investment ability. Especially favorable Day for women.',s:'Spouse is gentle and family-oriented. Wealth grows after marriage.'},
        'ä¹™é…‰':{t:'ä¹™é…‰(ì„ìœ )Day - Flower touched by autumn frost',d:'Metal attacks Wood bringing trials but patience brings success. Sharp and critical with easy professional success.',s:'Conflicts with spouse may arise. Effort to harmonize is essential.'},
        'ä¹™äº¥':{t:'ä¹™äº¥(ì„í•´)Day - Duckweed floating on water',d:'Water nurtures Wood bringing abundant talent. Wise and scholarly with easy access to noble helpers. Flexible and adaptable nature.',s:'Spouse is intelligent with strong life skills.'},
        'ä¸™å­':{t:'ä¸™å­(ë³‘ì)Day - Sun in the night sky',d:'Water attacks Fire bringing trials but inner strength prevails. Duality like warm sun reflected in cold water.',s:'Personality differences with spouse may arise. Complementing each other creates blessed union.'},
        'ä¸™å¯…':{t:'ä¸™å¯…(ë³‘ì¸)Day - Sun rising from the east',d:'Wood creates Fire making talents shine. Bright and energetic with leadership. Like morning sun brings hope and energy.',s:'Spouse is solid and dependable. Excellent spousal support awaits.'},
        'ä¸™è¾°':{t:'ä¸™è¾°(ë³‘ì§„)Day - Sun above the clouds',d:'Chen Earth channels Fire energy for talent expression. Great ambition with easy social success.',s:'Spouse brings stability and wealth fortune.'},
        'ä¸™åˆ':{t:'ä¸™åˆ(ë³‘ì˜¤)Day - Midday sun',d:'Fire energy peaks bringing passion and vitality. Quick tempered with strong competitive drive. Leadership qualities present.',s:'Spouse also has a fiery personality. Arguments happen but love burns passionate.'},
        'ä¸™ç”³':{t:'ä¸™ç”³(ë³‘ì‹ )Day - Evening sunset',d:'Fire controls Metal bringing money-making ability. Good business sense with wealth fortune. Type that improves in later years.',s:'Spouse is talented and earns well.'},
        'ä¸™æˆŒ':{t:'ä¸™æˆŒ(ë³‘ìˆ )Day - Bonfire on the mountain',d:'Xu Earth channels Fire bringing stability. Careful, responsible, and trusted. Strong interest in religion and philosophy.',s:'Spouse is solid and trustworthy. Late marriage may be favorable.'},
        'ä¸ä¸‘':{t:'ä¸ä¸‘(ì •ì¶•)Day - Candlelight',d:'Chou Earth channels Fire bringing calm. Introverted but warm-hearted. Steady effort type.',s:'Spouse is diligent and family-oriented. Stable married life awaits.'},
        'ä¸å¯':{t:'ä¸å¯(ì •ë¬˜)Day - Firefly in the forest',d:'Wood creates Fire bringing exceptional talent. Artistic sense with delicate nature. Easy to receive help from noble ones.',s:'Spouse is affectionate and artistic.'},
        'ä¸å·³':{t:'ä¸å·³(ì •ì‚¬)Day - Blazing candle',d:'Strong Fire energy brings passion. Good focus, easy success in one field. May have quick temper.',s:'Spouse is passionate and dynamic.'},
        'ä¸æœª':{t:'ä¸æœª(ì •ë¯¸)Day - Evening sunset',d:'Fire creates Earth bringing children fortune. Warm and embracing nature caring for others. Strong interest in religion and service.',s:'Spouse is gentle and family-oriented.'},
        'ä¸é…‰':{t:'ä¸é…‰(ì •ìœ )Day - Flame that melts jewels',d:'Fire controls Metal bringing ability to handle wealth. Good with hands suited for technical work. Particular and perfectionist.',s:'Spouse is talented but personalities may clash.'},
        'ä¸äº¥':{t:'ä¸äº¥(ì •í•´)Day - Lighthouse over the sea',d:'Water attacks Fire bringing trials but you bring hope to others. Wise with deep thoughts.',s:'Personality differences with spouse may arise.'},
        'æˆŠå­':{t:'æˆŠå­(ë¬´ì)Day - Embankment by the water',d:'Earth controls Water bringing wealth acquisition. Good business sense with wealth fortune. Realistic with quick calculations.',s:'Spouse is intelligent with strong vitality.'},
        'æˆŠå¯…':{t:'æˆŠå¯…(ë¬´ì¸)Day - Mountain in the forest',d:'Wood attacks Earth but roots embrace the mountain. Blessed with virtue and noble helpers. scholarly talent.',s:'Spouse is smart and capable.'},
        'æˆŠè¾°':{t:'æˆŠè¾°(ë¬´ì§„)Day - Mountain where a dragon dwells',d:'Strong Earth energy brings reliability and trust. Great ambition with desire for success. Wealth and career fortune present.',s:'Spouse is trustworthy and stable.'},
        'æˆŠåˆ':{t:'æˆŠåˆ(ë¬´ì˜¤)Day - Earth bathed in sunlight',d:'Fire creates Earth overflowing with energy. Active social and popular. Easy early success.',s:'Spouse is bright and energetic.'},
        'æˆŠç”³':{t:'æˆŠç”³(ë¬´ì‹ )Day - Mountain of minerals',d:'Earth creates Metal bringing wealth creation ability. Good business sense with investment ability. Practical and realistic.',s:'Spouse is brilliant and capable.'},
        'æˆŠæˆŒ':{t:'æˆŠæˆŒ(ë¬´ìˆ )Day - Tall mountain',d:'Earth energy peaks bringing stubbornness and determination. Once decided follows through to the end.',s:'May have stubbornness battles with spouse. Compromise is essential.'},
        'å·±ä¸‘':{t:'å·±ä¸‘(ê¸°ì¶•)Day - Fertile farmland',d:'Double Earth energy brings stability and steadiness. Real estate fortune with good saving habits.',s:'Spouse is diligent and family-oriented.'},
        'å·±å¯':{t:'å·±å¯(ê¸°ë¬˜)Day - Soil of the garden',d:'Wood attacks Earth but like good soil nurturing flowers. Good children fortune with virtuous nature.',s:'Spouse is smart and capable.'},
        'å·±å·³':{t:'å·±å·³(ê¸°ì‚¬)Day - Warm earth',d:'Fire creates Earth bringing noble helpers. Brilliant with many talents. Popular with great social fortune.',s:'Spouse is bright and lively.'},
        'å·±æœª':{t:'å·±æœª(ê¸°ë¯¸)Day - Summer garden',d:'Double Earth energy brings steadiness. Good real estate fortune with comfortable later years.',s:'Spouse is gentle and family-oriented.'},
        'å·±é…‰':{t:'å·±é…‰(ê¸°ìœ )Day - Autumn field',d:'Earth creates Metal bringing wealth creation ability. Talented with artistic sense. Harvest time fortune.',s:'Spouse is brilliant and capable.'},
        'å·±äº¥':{t:'å·±äº¥(ê¸°í•´)Day - Embankment by the water',d:'Earth controls Water bringing wealth acquisition. Wise with quick calculations. Business acumen fortune.',s:'Spouse has strong life skills.'},
        'åºšå­':{t:'åºšå­(ê²½ì)Day - Rock in winter sea',d:'Metal creates Water bringing exceptional wisdom. Intelligent with scholarly talent. Cool and analytical.',s:'Spouse is intellectual and brilliant.'},
        'åºšå¯…':{t:'åºšå¯…(ê²½ì¸)Day - Rock in the forest',d:'Metal controls Wood bringing money-making ability. Decisive with strong drive.',s:'May clash with spouse. Mutual compromise needed.'},
        'åºšè¾°':{t:'åºšè¾°(ê²½ì§„)Day - Swordsman riding a dragon',d:'Earth creates Metal bringing noble helpers. Career fortune with easy social success.',s:'Spouse is trustworthy and solid.'},
        'åºšåˆ':{t:'åºšåˆ(ê²½ì˜¤)Day - Iron forged in fire',d:'Fire forges Metal making you stronger. Overcoming trials brings great success.',s:'Spouse is lively but conflicts may arise.'},
        'åºšç”³':{t:'åºšç”³(ê²½ì‹ )Day - Steel',d:'Metal energy peaks bringing strength. Excellent decisiveness and execution. Warrior qualities present.',s:'Spouse also has a strong personality. Mutual respect is essential.'},
        'åºšæˆŒ':{t:'åºšæˆŒ(ê²½ìˆ )Day - Ore within the mountain',d:'Earth creates Metal with deep roots. Late bloomer but achieves great success.',s:'Spouse is dependable and stable.'},
        'è¾›ä¸‘':{t:'è¾›ä¸‘(ì‹ ì¶•)Day - Gem beneath the earth',d:'Earth creates Metal with precious talent hidden. Late recognition but shines in the end.',s:'Spouse is diligent and family-oriented.'},
        'è¾›å¯':{t:'è¾›å¯(ì‹ ë¬˜)Day - Jewel hanging on a tree',d:'Metal controls Wood bringing money-making ability. Delicate with artistic sense.',s:'Spouse is affectionate but conflicts may arise.'},
        'è¾›å·³':{t:'è¾›å·³(ì‹ ì‚¬)Day - Metal in the furnace',d:'Fire forges Metal through refinement. Overcoming trials makes you a shining jewel. Noble helpers present.',s:'Spouse is passionate but clashes may occur.'},
        'è¾›æœª':{t:'è¾›æœª(ì‹ ë¯¸)Day - Dew on summer grass',d:'Earth creates Metal bringing stability. Artistic sense with rich emotions.',s:'Spouse is gentle and family-oriented.'},
        'è¾›é…‰':{t:'è¾›é…‰(ì‹ ìœ )Day - Perfect jewel',d:'Double Metal energy brings sharpness. Perfectionist with excellent aesthetic sense. artistic and technical talent.',s:'Spouse may also be particular. Effort to harmonize is essential.'},
        'è¾›äº¥':{t:'è¾›äº¥(ì‹ í•´)Day - Pearl in the ocean',d:'Metal creates Water with wisdom flowing. Brilliant with rich emotions. exceptional artistic talent.',s:'Spouse is intellectual and emotional.'},
        'å£¬å­':{t:'å£¬å­(ì„ì)Day - Deep ocean',d:'Water energy peaks bringing deep wisdom. Brilliant mind with scholarly talent.',s:'Spouse is brilliant. Deep conversations are possible.'},
        'å£¬å¯…':{t:'å£¬å¯…(ì„ì¸)Day - Spring rain',d:'Water nurtures Wood reviving all things. Virtuous nature who loves giving. Receives help from noble ones.',s:'Spouse is solid and capable.'},
        'å£¬è¾°':{t:'å£¬è¾°(ì„ì§„)Day - Water where a dragon dwells',d:'Earth blocks Water but dragon rides water to ascend. Great ambition with career fortune.',s:'Spouse is reliable with wealth fortune.'},
        'å£¬åˆ':{t:'å£¬åˆ(ì„ì˜¤)Day - Summer shower',d:'Water attacks Fire bringing trials but inner strength prevails. Emotional fluctuations possible.',s:'Different personalities but complement well.'},
        'å£¬ç”³':{t:'å£¬ç”³(ì„ì‹ )Day - Valley stream',d:'Metal creates Water bringing clarity and brilliance. Intelligent with exceptional technical talent. eloquent speaking fortune.',s:'Spouse is brilliant and capable.'},
        'å£¬æˆŒ':{t:'å£¬æˆŒ(ì„ìˆ )Day - Water blocked by a dam',d:'Earth blocks Water but eventually breaks through. Patience brings great success.',s:'Conflicts with spouse may arise.'},
        'ç™¸ä¸‘':{t:'ç™¸ä¸‘(ê³„ì¶•)Day - Frozen spring',d:'Chou Earth hides Water energy within. Quiet but thinks deeply. Late bloomer type.',s:'Spouse is diligent and family-oriented.'},
        'ç™¸å¯':{t:'ç™¸å¯(ê³„ë¬˜)Day - Morning dew',d:'Water nurtures Wood growing all things. Virtuous with children fortune. Delicate and emotional.',s:'Spouse is affectionate and artistic.'},
        'ç™¸å·³':{t:'ç™¸å·³(ê³„ì‚¬)Day - Hot steam',d:'Water attacks Fire bringing many changes. Good adaptability with quick judgment.',s:'Spouse is active and passionate.'},
        'ç™¸æœª':{t:'ç™¸æœª(ê³„ë¯¸)Day - Summer evening rain',d:'Earth attacks Water but moistens the earth. Embracing nature caring for others.',s:'Spouse is gentle and family-oriented.'},
        'ç™¸é…‰':{t:'ç™¸é…‰(ê³„ìœ )Day - Clear spring water',d:'Metal creates Water bringing brilliance and artistry. Excellent aesthetic sense with intuitive fortune.',s:'Spouse is delicate and artistic.'},
        'ç™¸äº¥':{t:'ç™¸äº¥(ê³„í•´)Day - Deep ocean',d:'Water energy peaks bringing deep wisdom. Excellent intuition with spiritual side.',s:'Spouse is intellectual. Deep conversations possible.'}
    };
    
    const key = ds.c + db.c;
    if (iljuData[key]) {
        return { title: iljuData[key].t, desc: iljuData[key].d, spouse: iljuData[key].s };
    }
    
    // ê¸°ë³¸ í•´ì„¤ (ë°ì´í„° ì—†ì„ ê²½ìš°)
    const stemDesc = {'ç”²':'ì§„ì·¨ì ì´ê³  ë¦¬ë”ì‹­ ìˆëŠ”','ä¹™':'ìœ ì—°í•˜ê³  ì ì‘ë ¥ ì¢‹ì€','ä¸™':'ë°ê³  ì—´ì •ì ì¸','ä¸':'ë”°ëœ»í•˜ê³  ì„¬ì„¸í•œ','æˆŠ':'ë“¬ì§í•˜ê³  ì•ˆì •ì ì¸','å·±':'í¬ìš©ë ¥ ìˆê³  í˜„ì‹¤ì ì¸','åºš':'ê²°ë‹¨ë ¥ ìˆê³  ê°•ì¸í•œ','è¾›':'ì„¬ì„¸í•˜ê³  ì˜ˆë¯¼í•œ','å£¬':'ì§€í˜œë¡­ê³  ìœ ë™ì ì¸','ç™¸':'ì§ê´€ì ì´ê³  ê°ì„±ì ì¸'};
    const branchTrait = ['í™œë°œ','ì„±ì‹¤','ì§„ì·¨ì ','ì„¬ì„¸','ìœµí†µì„±','ì˜ë¦¬','ì—´ì •ì ','í—Œì‹ ì ','ë‹¹ë‹¹','ê°ê°ì ','ì¶©ì§','í˜„ëª…'];
    return { 
        title: `${ds.c}${db.c}Day`, 
        desc: `${stemDesc[ds.c]} ì„±ê²©ì…ë‹ˆë‹¤. ${ELEMENT[ds.e].k}(${ds.c}) æ—¥ä¸»(Day Master)ì´ ${db.c}(${db.a}ë )ì— ì•‰ì•„ ìˆì–´ ${branchTrait[BRANCH.indexOf(db)]}í•œ ì„±í–¥ì´ ë‚´ì¬ë˜ì–´.`, 
        spouse: `ë°°ìš°ìê°€ ${db.a}ë ì²˜ëŸ¼ ${branchTrait[BRANCH.indexOf(db)]}í•©ë‹ˆë‹¤. ${db.a}ë  í•´ì— ì¢‹ì€ ì¸ì—°ì„ ë§Œë‚  ìˆ˜ present.` 
    };
}

/* ========================================
   11. å¤§é‹(Life Cycle)
   ======================================== */
function calcLuck(saju, birthYear, gender, gods) {
    const isYang = saju.year.s.y;
    const isMale = gender === 'm';
    const forward = (isYang && isMale) || (!isYang && !isMale);
    const periods = [];
    const msi = STEM.indexOf(saju.month.s);
    const mbi = BRANCH.indexOf(saju.month.b);
    const curYear = new Date().getFullYear();
    const curAge = curYear - birthYear;
    
    for (let i = 0; i < 10; i++) {
        const si = forward ? (msi + i + 1) % 10 : (msi - i - 1 + 10) % 10;
        const bi = forward ? (mbi + i + 1) % 12 : (mbi - i - 1 + 12) % 12;
        const age = 3 + i * 10;
        const isCur = curAge >= age && curAge < age + 10;
        const s = STEM[si], b = BRANCH[bi];
        
        let score = 0;
        if ([s.e, b.e].includes(gods.yong)) score += 2;
        if ([s.e, b.e].includes(gods.hee)) score += 1;
        if ([s.e, b.e].includes(gods.gi)) score -= 2;
        
        periods.push({ s, b, startAge: age, endAge: age + 9, isCur, rating: score >= 2 ? 'good' : score <= -1 ? 'bad' : 'neutral', score });
    }
    return periods;
}

/* ========================================
   11-2. å¤§é‹(Life Cycle)/æ­²é‹(Annual Fortune)/Monthly Fortune êµì°¨ ë¶„ì„
   ======================================== */
   
// íŠ¹ì • ì—°ë„ì˜ æ­²é‹(Annual Fortune)(æ­²é‹) ê³„ì‚°
function calcYearLuck(year, saju, gods) {
    const yp = calcYearPillar(year, 6, 1);
    const dm = saju.day.s;
    const god = getTenGod(yp.s, dm);
    const state = getTwelveState(dm, yp.b);
    
    let score = 0;
    if ([yp.s.e, yp.b.e].includes(gods.yong)) score += 3;
    if ([yp.s.e, yp.b.e].includes(gods.hee)) score += 2;
    if ([yp.s.e, yp.b.e].includes(gods.gi)) score -= 3;
    
    // 12ìš´ì„± ê°€ì‚°
    if (state.l >= 10) score += 1;
    else if (state.l <= 3) score -= 1;
    
    return {
        year,
        pillar: yp,
        god,
        state,
        score,
        rating: score >= 3 ? 'great' : score >= 1 ? 'good' : score <= -2 ? 'bad' : 'neutral'
    };
}

// å¤§é‹(Life Cycle) + æ­²é‹(Annual Fortune) êµì°¨ ë¶„ì„
function analyzeLuckCross(saju, birthYear, gender, gods, targetYear) {
    const luck = calcLuck(saju, birthYear, gender, gods);
    const curAge = targetYear - birthYear;
    const curDaeun = luck.find(l => curAge >= l.startAge && curAge < l.endAge) || luck[0];
    const yearLuck = calcYearLuck(targetYear, saju, gods);
    
    const result = {
        daeun: curDaeun,
        saeun: yearLuck,
        analysis: []
    };
    
    // å¤§é‹(Life Cycle)-æ­²é‹(Annual Fortune) ê´€ê³„ ë¶„ì„
    const dEl = [curDaeun.s.e, curDaeun.b.e];
    const sEl = [yearLuck.pillar.s.e, yearLuck.pillar.b.e];
    
    // å¤§é‹(Life Cycle)-æ­²é‹(Annual Fortune) Harmony
    const ganHap = [[0,5],[1,6],[2,7],[3,8],[4,9]];
    const dsi = STEM.indexOf(curDaeun.s), ssi = STEM.indexOf(yearLuck.pillar.s);
    for (let [a,b] of ganHap) {
        if ((dsi===a && ssi===b) || (dsi===b && ssi===a)) {
            result.analysis.push({type:'good', text:'å¤§é‹(Life Cycle)-æ­²é‹(Annual Fortune) ì²œê°„í•©! ìš´ì´ ì¡°í™”ë¡­ê²Œ í˜ëŸ¬ìš”.'});
        }
    }
    
    // å¤§é‹(Life Cycle)-æ­²é‹(Annual Fortune) Clash
    const dbi = BRANCH.indexOf(curDaeun.b), sbi = BRANCH.indexOf(yearLuck.pillar.b);
    if (Math.abs(dbi - sbi) === 6 || Math.abs(dbi - sbi) === 6) {
        result.analysis.push({type:'bad', text:'å¤§é‹(Life Cycle)-æ­²é‹(Annual Fortune) ì§€ì§€ì¶©! ë³€í™”ì™€ ì‹œë ¨ì´ ìˆì„ ìˆ˜ present.'});
    }
    
    // å¤§é‹(Life Cycle)-ì›êµ­ ê´€ê³„
    const allBi = [BRANCH.indexOf(saju.year.b), BRANCH.indexOf(saju.month.b), BRANCH.indexOf(saju.day.b)];
    if (saju.hour) allBi.push(BRANCH.indexOf(saju.hour.b));
    
    allBi.forEach((bi, idx) => {
        const positions = ['Year Branch','Month Branch','Day Branch','Hour Branch'];
        // æ­²é‹(Annual Fortune)ê³¼ ì›êµ­ Clash
        if (Math.abs(bi - sbi) === 6) {
            result.analysis.push({type:'warning', text:`æ­²é‹(Annual Fortune)ì´ ${positions[idx]}ì™€ ì¶©! ${idx===2 ? 'ë°°ìš°ìë‚˜ ê±´ê°• Caution!' : idx===0 ? 'ì§‘ì•ˆ ì–´ë¥¸ ê´€ë ¨ ì¼ ìˆì„ ìˆ˜ present.' : idx===1 ? 'ì§ì¥ì´ë‚˜ ì‚¬ì—…ì— ë³€í™” ìˆì„ ìˆ˜ present.' : 'ìë…€ë‚˜ í›„ë°° ê´€ë ¨ ì¼ ìˆì„ ìˆ˜ present.'}`});
        }
    });
    
    // ì¢…í•© ì Water
    result.totalScore = curDaeun.score + yearLuck.score;
    result.totalRating = result.totalScore >= 4 ? 'excellent' : 
                         result.totalScore >= 2 ? 'good' : 
                         result.totalScore >= 0 ? 'neutral' : 
                         result.totalScore >= -2 ? 'caution' : 'difficult';
    
    return result;
}

// å¤§é‹(Life Cycle) ì²œê°„/ì§€ì§€ 5ë…„ì”© ë¶„ë¦¬ í•´ì„
function analyzeDaeunDetail(daeun, saju, gods, startYear) {
    const dm = saju.day.s;
    
    // ì „ë°˜ 5ë…„: ì²œê°„ ìœ„ì£¼
    const stemGod = getTenGod(daeun.s, dm);
    const stemAnalysis = {
        period: 'ì „ë°˜ 5ë…„',
        dominant: 'ì²œê°„',
        pillar: daeun.s.c,
        god: stemGod.k,
        element: daeun.s.e,
        isYong: daeun.s.e === gods.yong,
        isGi: daeun.s.e === gods.gi,
        desc: `${stemGod.k}ì˜ ê¸°ìš´ì´ ì§€ë°°í•˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤.`
    };
    
    // í›„ë°˜ 5ë…„: ì§€ì§€ ìœ„ì£¼
    const branchGod = getTenGod({e: daeun.b.e, y: true, c: '', k: ''}, dm); // ì„ì‹œ ê°ì²´
    const branchAnalysis = {
        period: 'í›„ë°˜ 5ë…„',
        dominant: 'ì§€ì§€',
        pillar: daeun.b.c,
        element: daeun.b.e,
        isYong: daeun.b.e === gods.yong,
        isGi: daeun.b.e === gods.gi,
        state: getTwelveState(dm, daeun.b),
        desc: `${ELEMENT[daeun.b.e].k}(${daeun.b.c}) ê¸°ìš´ê³¼ ${getTwelveState(dm, daeun.b).k}ì˜ Energyê°€ ì‘ìš©í•©ë‹ˆë‹¤.`
    };
    
    return { stem: stemAnalysis, branch: branchAnalysis };
}

// 10ë…„ ìš´ì„¸ ë¯¸ë¦¬ë³´ê¸°
function getNext10Years(saju, birthYear, gender, gods) {
    const curYear = new Date().getFullYear();
    const years = [];
    
    for (let i = 0; i < 10; i++) {
        const year = curYear + i;
        const cross = analyzeLuckCross(saju, birthYear, gender, gods, year);
        years.push({
            year,
            age: year - birthYear,
            rating: cross.totalRating,
            score: cross.totalScore,
            daeun: cross.daeun,
            saeun: cross.saeun
        });
    }
    
    // ê°€ì¥ ì¢‹ì€ í•´, ì¡°ì‹¬í•  í•´ ì°¾ê¸°
    const bestYear = years.reduce((a, b) => a.score > b.score ? a : b);
    const worstYear = years.reduce((a, b) => a.score < b.score ? a : b);
    
    return { years, bestYear, worstYear };
}

// Monthly Fortune(æœˆé‹) ê³„ì‚°
function calcMonthLuck(year, month, saju, gods) {
    const mp = calcMonthPillar(year, month, 15);
    const dm = saju.day.s;
    const god = getTenGod(mp.s, dm);
    
    let score = 0;
    if ([mp.s.e, mp.b.e].includes(gods.yong)) score += 2;
    if ([mp.s.e, mp.b.e].includes(gods.hee)) score += 1;
    if ([mp.s.e, mp.b.e].includes(gods.gi)) score -= 2;
    
    return {
        month,
        pillar: mp,
        god,
        score,
        rating: score >= 2 ? 'good' : score <= -1 ? 'bad' : 'neutral'
    };
}

// 12ê°œì›” Monthly Fortune ë¶„ì„
function getYearlyMonthLuck(year, saju, gods) {
    const months = [];
    for (let m = 1; m <= 12; m++) {
        months.push(calcMonthLuck(year, m, saju, gods));
    }
    
    // ê°€ì¥ ì¢‹ì€ ë‹¬, ë‚˜ìœ ë‹¬
    const best = months.reduce((a, b) => a.score > b.score ? a : b);
    const worst = months.reduce((a, b) => a.score < b.score ? a : b);
    
    return { months, best, worst };
}

/* ========================================
   12. ì‹ ì‚´ ì™„ì „íŒ (30ê°œ+)
   ======================================== */
function calcSinsal(saju) {
    const ss = [];
    const dmi = STEM.indexOf(saju.day.s);
    const ybi = BRANCH.indexOf(saju.year.b);
    const dbi = BRANCH.indexOf(saju.day.b);
    const mbi = BRANCH.indexOf(saju.month.b);
    const hbi = saju.hour ? BRANCH.indexOf(saju.hour.b) : -1;
    const brs = [ybi, mbi, dbi];
    if (hbi >= 0) brs.push(hbi);
    
    // ì²œê°„ ì¸ë±ìŠ¤ë“¤
    const ysi = STEM.indexOf(saju.year.s);
    const msi = STEM.indexOf(saju.month.s);
    const hsi = saju.hour ? STEM.indexOf(saju.hour.s) : -1;
    
    // ========== ê¸¸ì‹ (å‰ç¥) ==========
    
    // 1. å¤©ä¹™è²´äºº(Heavenly Noble) (å¤©ä¹™è²´äºº) - ìµœê³  ê¸¸ì‹ 
    const guiren = {0:[1,7],1:[0,8],2:[11,9],3:[11,9],4:[1,7],5:[0,8],6:[7,1],7:[6,2],8:[5,3],9:[5,3]};
    if (guiren[dmi] && brs.some(b => guiren[dmi].includes(b))) ss.push({n:'å¤©ä¹™è²´äºº(Heavenly Noble)(å¤©ä¹™è²´äºº)',t:'good',d:'Supreme blessing! A guardian angel appears in every crisis. Official fortune and protection surround you.',i:'ğŸ‘¼',lv:'ìµœìƒ'});
    
    // 2. ì²œë•ê·€ì¸ (å¤©å¾·è²´äºº)
    const tiande = [9,8,7,6,5,4,3,2,1,0,9,8]; // ì›”ë³„
    if (mbi < 12 && (dmi === tiande[mbi] || brs.some(b => b === tiande[mbi]))) ss.push({n:'å¤©å¾·è²´äºº(å¤©å¾·è²´äºº(Heavens Virtue Noble)) (å¤©å¾·è²´äºº)',t:'good',d:'Heavens virtue shines upon you! Living righteously multiplies your blessings tenfold.',i:'ğŸŒŸ',lv:'ìƒ'});
    
    // 3. ì›”ë•ê·€ì¸ (æœˆå¾·è²´äºº)
    const yuede = [2,6,2,6,4,8,4,8,0,6,0,6]; // ì›”ë³„ ì²œê°„
    if (mbi < 12 && dmi === yuede[mbi]) ss.push({n:'æœˆå¾·è²´äºº(æœˆå¾·è²´äºº(Moons Virtue Noble)) (æœˆå¾·è²´äºº)',t:'good',d:'Moons blessing graces your path! Natural charisma draws trust and admiration. Official positions favor you.',i:'ğŸŒ™',lv:'ìƒ'});
    
    // 4. ë¬¸ì°½ê·€ì¸ (æ–‡æ˜Œè²´äºº)
    const munchang = {0:5,1:6,2:8,3:9,4:8,5:9,6:11,7:0,8:2,9:3};
    if (brs.includes(munchang[dmi])) ss.push({n:'æ–‡æ˜Œè²´äºº(Scholar Star) (æ–‡æ˜Œè²´äºº)',t:'good',d:'Brilliant scholarly mind! Exams, certifications, and academic pursuits bend to your will. Writing flows naturally.',i:'ğŸ“š',lv:'ìƒ'});
    
    // 5. í•™ë‹¹ê·€ì¸ (å­¸å ‚è²´äºº)
    const xuetang = {0:11,1:6,2:2,3:9,4:2,5:9,6:5,7:0,8:8,9:3};
    if (brs.includes(xuetang[dmi])) ss.push({n:'å­¸å ‚è²´äºº(Academy Noble) (å­¸å ‚è²´äºº)',t:'good',d:'Scholars destiny! Research and education lead to greatness. Professorship and expertise await.',i:'ğŸ“',lv:'ìƒ'});
    
    // 6. ì¥ì„±ê·€ì¸ (å°‡æ˜Ÿè²´äºº)
    const jiangx = {0:0,1:9,2:6,3:3,4:0,5:9,6:6,7:3,8:0,9:9,10:6,11:3}; // Year Branchë³„
    if (brs.includes(jiangx[ybi])) ss.push({n:'å°‡æ˜Ÿ(General Star)',t:'good',d:'Commanders spirit! Natural leadership draws followers. You are destined to lead.',i:'ğŸ–ï¸',lv:'ìƒ'});
    
    // 7. é‡‘è¼¿(Golden Carriage) (é‡‘è¼¿) - ë°°ìš°ì ë³µ
    const jinyu = {0:4,1:5,2:7,3:8,4:7,5:8,6:10,7:11,8:1,9:2};
    if (brs.includes(jinyu[dmi])) ss.push({n:'é‡‘è¼¿(Golden Carriage) (é‡‘è¼¿)',t:'good',d:'Supreme spouse fortune! Marriage unlocks your destiny. An ideal partner awaits.',i:'ğŸ’',lv:'ìƒ'});
    
    // 8. ë³µì„±ê·€ì¸ (ç¦æ˜Ÿè²´äºº)
    const fuxing = {0:2,1:3,2:5,3:6,4:5,5:6,6:8,7:9,8:11,9:0};
    if (brs.includes(fuxing[dmi])) ss.push({n:'ç¦æ˜Ÿè²´äºº(Fortune Noble)',t:'good',d:'Blessed chart! No worries about necessities. Lifetime abundance.',i:'ğŸ€',lv:'ìƒ'});
    
    // 9. ì•”ë¡ (æš—ç¥¿) - ìˆ¨ì€ ë…¹
    const anlu = {0:11,1:10,2:1,3:0,4:1,5:0,6:3,7:2,8:5,9:4};
    if (brs.includes(anlu[dmi])) ss.push({n:'æš—ç¥¿(æš—ç¥¿(Hidden Fortune)) (æš—ç¥¿)',t:'good',d:'Hidden blessings flow! Invisible support guides you when you least expect it.',i:'ğŸ',lv:'ì¤‘'});
    
    // 10. Prime (å»ºç¥¿)
    const jianlu = {0:2,1:3,2:5,3:6,4:5,5:6,6:8,7:9,8:11,9:0};
    if (brs.includes(jianlu[dmi])) ss.push({n:'å»ºç¥¿(Prime)',t:'good',d:'Self-made type! Success through own efforts. Stable career.',i:'ğŸ ',lv:'ìƒ'});
    
    // 11. ì²œì˜ì„± (å¤©é†«æ˜Ÿ)
    const tianyi = [11,0,1,2,3,4,5,6,7,8,9,10]; // ì›”ë³„
    if (mbi < 12 && brs.includes(tianyi[mbi])) ss.push({n:'å¤©é†«æ˜Ÿ(å¤©é†«æ˜Ÿ(Heavenly Doctor))',t:'good',d:'Medical calling! Doctors, nurses, pharmacists â€” healing professions bring great fortune.',i:'ğŸ’Š',lv:'ì¤‘'});
    
    // ========== ì¤‘ì„±(ä¸­æ€§) ==========
    
    // 12. é©›é¦¬(Traveling Horse) (é©›é¦¬æ®º)
    const yima = {0:2,1:11,2:8,3:5,4:2,5:11,6:8,7:5,8:2,9:11,10:8,11:5};
    if (brs.includes(yima[ybi])) ss.push({n:'é©›é¦¬(Traveling Horse)(é©›é¦¬æ®º)',t:'neutral',d:'Movement awakens fortune! Travel, relocation, overseas ventures â€” motion is your medicine.',i:'ğŸ',lv:'ì¤‘'});
    
    // 13. æ¡ƒèŠ±(Peach Blossom) (æ¡ƒèŠ±æ®º)
    const taohua = {0:9,1:6,2:3,3:0,4:9,5:6,6:3,7:0,8:9,9:6,10:3,11:0};
    if (brs.includes(taohua[ybi])) ss.push({n:'æ¡ƒèŠ±(Peach Blossom)(æ¡ƒèŠ±æ®º)',t:'neutral',d:'Irresistible charm! Magnetic attraction to opposite sex. Star quality â€” guard against wandering heart.',i:'ğŸŒ¸',lv:'ì¤‘'});
    
    // 14. Fireê°œì‚´ (è¯è“‹æ®º)
    const huagai = {0:4,1:1,2:10,3:7,4:4,5:1,6:10,7:7,8:4,9:1,10:10,11:7};
    if (brs.includes(huagai[ybi])) ss.push({n:'è¯è“‹(Canopy Star) (è¯è“‹æ®º)',t:'neutral',d:'Artists soul! Music, art, and writing flow naturally. Spiritual and philosophical depths call to you.',i:'ğŸ¨',lv:'ì¤‘'});
    
    // 15. í™ì—¼ì‚´ (ç´…è‰¶æ®º) - ì´ì„± ì¸ê¸°
    const hongyan = {0:6,1:5,2:8,3:7,4:8,5:7,6:9,7:8,8:11,9:10};
    if (brs.includes(hongyan[dmi])) ss.push({n:'ç´…è‰¶(Red Romance)',t:'neutral',d:'Sexy charm! Attractive to opposite sex. Entertainment aptitude, watch infidelity!',i:'ğŸ’‹',lv:'ì¤‘'});
    
    // ========== í‰ì‹ (å‡¶ç¥) ==========
    
    // 16. ê´´ê°•ì‚´ (é­ç½¡æ®º)
    const kuigang = [[6,4],[],[6,4],[],[6,10],[],[6,10],[],[],[]]; // æ—¥ä¸»(Day Master)ë³„ Day Branch
    if (kuigang[dmi] && kuigang[dmi].includes(dbi)) ss.push({n:'é­ç½¡(é­ç½¡(Fierce Star)) (é­ç½¡æ®º)',t:'bad',d:'Fierce fire spirit! Charismatic leader potential â€” temper your autocratic tendencies.',i:'âš¡',lv:'ìƒ'});
    
    // 17. ì–‘ì¸ì‚´ (ç¾Šåˆƒæ®º)
    const yangren = {0:3,1:2,2:6,3:5,4:6,5:5,6:9,7:8,8:0,9:11};
    if (dbi === yangren[dmi]) ss.push({n:'ç¾Šåˆƒ(ç¾Šåˆƒ(Sheep Blade))',t:'bad',d:'Sharp blade energy! Decisive but sharp. Suits military, surgeons, lawyers.',i:'ğŸ—¡ï¸',lv:'ìƒ'});
    
    // 18. ë°±í˜¸ì‚´ (ç™½è™æ®º)
    const baihu = [6,7,8,9,10,11,0,1,2,3,4,5]; // ì›”ë³„
    if (mbi < 12 && brs.includes(baihu[mbi])) ss.push({n:'ç™½è™(ç™½è™(White Tiger)) (ç™½è™æ®º)',t:'bad',d:'Accident alert! However, professions involving blood (medicine, culinary) transform this into blessing.',i:'ğŸ¯',lv:'ì¤‘'});
    
    // 19. ê²ì‚´ (åŠ«æ®º)
    const jiesha = {0:5,1:2,2:11,3:8,4:5,5:2,6:11,7:8,8:5,9:2,10:11,11:8};
    if (brs.includes(jiesha[ybi])) ss.push({n:'åŠ«æ®º(åŠ«æ®º(Robbery Star)) (åŠ«æ®º)',t:'bad',d:'Financial vulnerability! Guard against theft, fraud, bad investments. Never co-sign loans!',i:'ğŸ’¸',lv:'ì¤‘'});
    
    // 20. ë§ì‹ ì‚´ (äº¡ç¥æ®º)
    const wangshen = {0:9,1:6,2:3,3:0,4:9,5:6,6:3,7:0,8:9,9:6,10:3,11:0};
    if (brs.includes(wangshen[ybi]) && wangshen[ybi] !== taohua[ybi]) ss.push({n:'äº¡ç¥(äº¡ç¥(Disgrace Star)) (äº¡ç¥æ®º)',t:'bad',d:'Reputation vulnerability! Guard social media, drinking occasions carefully.',i:'ğŸ˜°',lv:'ì¤‘'});
    
    // 21. ì›ì§„ì‚´ (æ€¨å—”æ®º)
    const yuanchen = [[7],[6],[5],[4],[3],[2],[1],[0],[11],[10],[9],[8]];
    if (yuanchen[ybi] && brs.some(b => yuanchen[ybi].includes(b))) ss.push({n:'æ€¨å—”(æ€¨å—”(Resentment Star)) (æ€¨å—”æ®º)',t:'bad',d:'Love-hate bonds entangle you. Navigate close relationships with care.',i:'ğŸ’”',lv:'ì¤‘'});
    
    // 22. ê·€ë¬¸ê´€ì‚´ (é¬¼é–€é—œæ®º)
    const guimen = [[5,6],[6,7],[7,8],[8,9],[9,10],[10,11],[11,0],[0,1],[1,2],[2,3],[3,4],[4,5]];
    if (guimen[ybi] && brs.some(b => guimen[ybi].includes(b))) ss.push({n:'é¬¼é–€é—œ(é¬¼é–€é—œ(Ghost Gate)) (é¬¼é–€é—œæ®º)',t:'bad',d:'Mental sensitivity present. Guard against anxiety and depression. Meditation and spirituality heal.',i:'ğŸ‘»',lv:'ì¤‘'});
    
    // 23. í˜„ì¹¨ì‚´ (æ‡¸é‡æ®º) - ç”², ç”³, è¾›ì— ì„¸ë¡œíš
    if ([0,7].includes(dmi)) ss.push({n:'æ‡¸é‡(æ‡¸é‡(Needle Star)) (æ‡¸é‡æ®º)',t:'bad',d:'Needle-sharp energy! Critical perfectionist. Talent for acupuncture, precision crafts.',i:'ğŸ“',lv:'í•˜'});
    
    // 24. ìœ¡í•´ì‚´ (å…­å®³æ®º)
    const liuhai = [[7],[6],[5],[4],[3],[2],[1],[0],[11],[10],[9],[8]];
    if (liuhai[dbi] && brs.some(b => liuhai[dbi].includes(b) && b !== dbi)) ss.push({n:'å…­å®³(Six Harms) (å…­å®³æ®º)',t:'bad',d:'Vulnerability through close ones. Navigate spouse and sibling relationships carefully.',i:'âš ï¸',lv:'ì¤‘'});
    
    // 25. ì²œë¼ì§€ë§ (å¤©ç¾…åœ°ç¶²)
    const tianluodiwang = (dbi === 10 && [5,6].includes(mbi)) || (dbi === 11 && [9,10].includes(mbi));
    if (tianluodiwang) ss.push({n:'å¤©ç¾…åœ°ç¶²(å¤©ç¾…åœ°ç¶²(Heavens Net)) (å¤©ç¾…åœ°ç¶²)',t:'bad',d:'Caught in heavens net. Guard against gossip, lawsuits. Feelings of entrapment may arise.',i:'ğŸ•¸ï¸',lv:'ì¤‘'});
    
    // 26. ê³ ë€ì‚´ (å­¤é¸æ®º) - í˜¼ì ìˆëŠ” ê¸°ëŸ¬ê¸°
    const guluanM = [[0,2],[1,3],[2,5],[3,6],[4,5],[5,6],[6,8],[7,9],[8,11],[9,0]]; // æ—¥ä¸»(Day Master)+Day Branch ì¡°í•© (ë‚¨ì)
    const guluanF = [[1,3],[0,2],[3,6],[2,5],[3,6],[2,5],[7,9],[6,8],[9,0],[8,11]]; // ì—¬ì
    const guluanCheck = GENDER === 'm' ? guluanM : guluanF;
    if (guluanCheck[dmi] && guluanCheck[dmi][1] === dbi) ss.push({n:'å­¤é¸(å­¤é¸(Lonely Swan)) (å­¤é¸æ®º)',t:'bad',d:'Solitary spirit dwells within. Late marriage or single tendencies. Solitude becomes your companion.',i:'ğŸ¦¢',lv:'í•˜'});
    
    // 27. ì‚¼ì¬ (ä¸‰ç½) - Year Branch ê¸°ì¤€
    const sanzai = {0:[2,3,4],1:[2,3,4],2:[2,3,4],3:[5,6,7],4:[5,6,7],5:[5,6,7],6:[8,9,10],7:[8,9,10],8:[8,9,10],9:[11,0,1],10:[11,0,1],11:[11,0,1]};
    const curYear = new Date().getFullYear();
    const curYearBranch = (curYear - 4) % 12;
    if (sanzai[ybi] && sanzai[ybi].includes(curYearBranch)) ss.push({n:'ä¸‰ç½(ä¸‰ç½(Three Calamities))',t:'bad',d:'ä¸‰ç½(ä¸‰ç½(Three Calamities)) period active! Exercise caution for 3 years. Avoid reckless expansion and major moves.',i:'ğŸ”¥',lv:'ì¤‘'});
    
    // 28. ë°˜ì•ˆì‚´ (æ”€éæ®º)
    const panan = {0:2,1:3,2:5,3:6,4:5,5:6,6:8,7:9,8:11,9:0};
    if (brs.includes(panan[dmi])) ss.push({n:'æ”€é(Climbing Saddle)',t:'good',d:'Good career luck! Promotion type in stable organizations. Suits corporations.',i:'ğŸ’º',lv:'ì¤‘'});
    
    // 29. ì²œì£¼ê·€ì¸ (å¤©å»šè²´äºº) - ì‹ë³µ
    const tianchu = {0:5,1:6,2:8,3:9,4:8,5:9,6:11,7:0,8:2,9:3};
    if (brs.includes(tianchu[dmi])) ss.push({n:'å¤©å»šè²´äºº(Heavenly Kitchen) (å¤©å»šè²´äºº)',t:'good',d:'Blessed with food fortune! Never worry about hunger. Culinary talent awaits discovery.',i:'ğŸ½ï¸',lv:'ì¤‘'});
    
    // 30. ì²œì‚¬(å¤©èµ¦) - í•˜ëŠ˜ì´ ìš©ì„œí•˜ëŠ” ë‚ 
    const tiansha = [[2,0],[3,1],[5,2],[6,3],[8,4],[9,5],[11,6],[0,7],[2,8],[3,9]]; // [ì§€ì§€,ì²œê°„] ì¡°Harmony
    if (tiansha.some(ts => dbi === ts[0] && dmi === ts[1])) ss.push({n:'å¤©èµ¦æ—¥(Heavens Pardon)',t:'good',d:'å¤©èµ¦æ—¥(Heavens Pardon) Day! Misfortunes transform into blessings. Divine forgiveness surrounds you.',i:'ğŸ•Šï¸',lv:'ìƒ'});
    
    return ss.length ? ss : [{n:'ç„¡ç‰¹æ®Šç¥æ®º(ç„¡ç‰¹æ®Šç¥æ®º(No Special Stars))',t:'neutral',d:'No exceptional divine stars. A peacefully balanced chart brings steady fortune.',i:'â˜¯ï¸',lv:'ì¤‘'}];
}

/* ========================================
   13. í•©ì¶©í˜•íŒŒí•´ (í™•ì¥íŒ)
   ======================================== */
function calcInteractions(saju) {
    const res = [];
    const stems = [STEM.indexOf(saju.year.s), STEM.indexOf(saju.month.s), STEM.indexOf(saju.day.s)];
    const brs = [BRANCH.indexOf(saju.year.b), BRANCH.indexOf(saju.month.b), BRANCH.indexOf(saju.day.b)];
    if (saju.hour) { stems.push(STEM.indexOf(saju.hour.s)); brs.push(BRANCH.indexOf(saju.hour.b)); }
    
    // ì²œê°„Harmony
    const stComb = [[0,5,'ç”²å·±(Jia-Ji) combine to Earth'],[1,6,'ä¹™åºš(Yi-Geng) combine to Metal'],[2,7,'ä¸™è¾›(Bing-Xin) combine to Water'],[3,8,'ä¸å£¬(Ding-Ren) combine to Wood'],[4,9,'æˆŠç™¸(Wu-Gui) combine to Fire']];
    for (let [a,b,n] of stComb) {
        for (let i = 0; i < stems.length; i++) {
            for (let j = i+1; j < stems.length; j++) {
                if ((stems[i]===a && stems[j]===b) || (stems[i]===b && stems[j]===a)) {
                    res.push({t:'å¤©åˆ',c:`${STEM[a].c}+${STEM[b].c}`,m:n,d:'Stems combine creating new energy!'});
                }
            }
        }
    }
    
    // ì²œê°„ì¶© (å¤©å¹²æ²–) - ìƒˆë¡œ ì¶”ê°€
    const stClash = [
        [0,6,'ç”²åºš(Jia-Geng) clash','Strong decisiveness but many conflicts. Leadership vs authority!'],
        [1,7,'ä¹™è¾›(Yi-Xin) clash','Inner conflict. Flexibility vs rigidity collide.'],
        [2,8,'ä¸™å£¬(Bing-Ren) clash','Passion vs wisdom clash. Watch impulsiveness!'],
        [3,9,'ä¸ç™¸(Ding-Gui) clash','Emotion and reason clash. Mood swings possible.'],
        [4,4,'æˆŠæˆŠ(Wu-Wu) Peer','Stubborn with strong self-assertion.'],
        [5,5,'å·±å·±(Ji-Ji) Peer','Pure but may be indecisive.']
    ];
    for (let [a,b,n,desc] of stClash) {
        for (let i = 0; i < stems.length; i++) {
            for (let j = i+1; j < stems.length; j++) {
                if ((stems[i]===a && stems[j]===b) || (stems[i]===b && stems[j]===a)) {
                    res.push({t:'å¤©æ²–',c:`${STEM[a].c}â†”${STEM[b].c}`,m:n,d:desc});
                }
            }
        }
    }
    
    // ì§€ì§€ Six Harmony
    const hap = [[0,1,'å­ä¸‘(Rat-Ox) combine to Earth'],[2,11,'å¯…äº¥(Tiger-Pig) combine to Wood'],[3,10,'å¯æˆŒ(Rabbit-Dog) combine to Fire'],[4,9,'è¾°é…‰(Dragon-Rooster) combine to Metal'],[5,8,'å·³ç”³(Snake-Monkey) combine to Water'],[6,7,'åˆæœª(Horse-Goat) combine to Fire']];
    for (let [a,b,n] of hap) {
        if (brs.includes(a) && brs.includes(b)) res.push({t:'å…­åˆ',c:`${BRANCH[a].c}+${BRANCH[b].c}`,m:n,d:'Branches harmonize! Good relationships!'});
    }
    
    // Trinity
    const samhap = [[2,6,10,'å¯…åˆæˆŒ(Tiger-Horse-Dog) Fire combination'],[5,9,1,'å·³é…‰ä¸‘(Snake-Rooster-Ox) Metal combination'],[8,0,4,'ç”³å­è¾°(Monkey-Rat-Dragon) Water combination'],[11,3,7,'äº¥å¯æœª(Pig-Rabbit-Goat) Wood combination']];
    for (let [a,b,c,n] of samhap) {
        const has = [brs.includes(a), brs.includes(b), brs.includes(c)];
        if (has.filter(x=>x).length === 3) res.push({t:'ä¸‰åˆ',c:`${BRANCH[a].c}${BRANCH[b].c}${BRANCH[c].c}`,m:n,d:'Complete Trinity! Powerful energy forms!'});
        else if (has.filter(x=>x).length === 2 && has[1]) res.push({t:'åŠåˆ',c:has[0]?`${BRANCH[a].c}${BRANCH[b].c}`:has[2]?`${BRANCH[b].c}${BRANCH[c].c}`:'',m:n.split(' ')[0]+' half-combination',d:'Half Trinity. Partial energy forming.'});
    }
    
    // Clash
    const clash = [[0,6,'å­åˆ(Rat-Horse) clash','North-south collision! Heart and reality conflict.'],[1,7,'ä¸‘æœª(Ox-Goat) clash','Wealth-related changes coming.'],[2,8,'å¯…ç”³(Tiger-Monkey) clash','Activity increases. Watch traffic safety!'],[3,9,'å¯é…‰(Rabbit-Rooster) clash','Document and contract issues may arise.'],[4,10,'è¾°æˆŒ(Dragon-Dog) clash','Stubborn nature causes conflicts.'],[5,11,'å·³äº¥(Snake-Pig) clash','Plans may not go as expected.']];
    for (let [a,b,n,desc] of clash) {
        const ia = brs.indexOf(a), ib = brs.indexOf(b);
        if (ia >= 0 && ib >= 0) {
            const dist = Math.abs(ia - ib);
            const strength = dist === 1 ? 'âš¡Strong clash' : dist === 2 ? 'Moderate clash' : 'Weak clash';
            res.push({t:'æ²–',c:`${BRANCH[a].c}â†”${BRANCH[b].c}`,m:`${n} (${strength})`,d:desc});
        }
    }
    
    // í˜• (ì„¸ë¶„Fire) - ì‚¼í˜•, ìƒí˜•, ìí˜•
    // 1. ì‚¼í˜• (ä¸‰åˆ‘) - ì¸ì‚¬ì‹ 
    if (brs.includes(2) && brs.includes(5) && brs.includes(8)) {
        res.push({t:'ä¸‰åˆ‘',c:'å¯…å·³ç”³',m:'Punishment of Ingratitude',d:'Ingratitude punishment! Watch for betrayal. Major accidents or legal issues possible!'});
    }
    // 2. ì¶•ìˆ ë¯¸ ì‚¼í˜•
    if (brs.includes(1) && brs.includes(10) && brs.includes(7)) {
        res.push({t:'ä¸‰åˆ‘',c:'ä¸‘æˆŒæœª',m:'Punishment of Disrespect',d:'Disrespect punishment! Stubborn nature causes conflicts. Watch relationships!'});
    }
    // 3. ìƒí˜• (ç›¸åˆ‘) - ë‘ ê¸€ì
    const brHyung = [
        [2,5,'å¯…å·³(Tiger-Snake) punishment','Part of ingratitude. Watch for betrayal and gossip!'],
        [5,8,'å·³ç”³(Snake-Monkey) punishment','Part of ingratitude. Cold and conflict-prone.'],
        [2,8,'å¯…ç”³(Tiger-Monkey) punishment','Attraction despite clashing. Watch traffic safety!'],
        [1,10,'ä¸‘æˆŒ(Ox-Dog) punishment','Part of disrespect. Stubbornness causes conflicts!'],
        [10,7,'æˆŒæœª(Dog-Goat) punishment','Part of disrespect. Earth signs clash!'],
        [1,7,'ä¸‘æœª(Ox-Goat) punishment','Part of disrespect. Wealth conflicts!'],
        [0,3,'å­å¯(Rat-Rabbit) punishment','Disrespect type. Easy to lose manners. Watch your words!']
    ];
    for (let [a,b,n,desc] of brHyung) {
        const ia = brs.indexOf(a), ib = brs.indexOf(b);
        if (ia >= 0 && ib >= 0) {
            // ì‚¼í˜•ì— ì´ë¯¸ í¬í•¨ëœ ê²½ìš° ì¤‘ë³µ ì œì™¸
            if (!(brs.includes(2) && brs.includes(5) && brs.includes(8) && [2,5,8].includes(a) && [2,5,8].includes(b)) &&
                !(brs.includes(1) && brs.includes(10) && brs.includes(7) && [1,10,7].includes(a) && [1,10,7].includes(b))) {
                res.push({t:'åˆ‘',c:`${BRANCH[a].c}â†”${BRANCH[b].c}`,m:n,d:desc});
            }
        }
    }
    // 4. ìí˜• (è‡ªåˆ‘) - ê°™ì€ ê¸€ìë¼ë¦¬
    const selfPunish = {4:'è¾°è¾°(Dragon-Dragon) self-punishment',6:'åˆåˆ(Horse-Horse) self-punishment',9:'é…‰é…‰(Rooster-Rooster) self-punishment',11:'äº¥äº¥(Pig-Pig) self-punishment'};
    for (let i = 0; i < brs.length; i++) {
        for (let j = i+1; j < brs.length; j++) {
            if (brs[i] === brs[j] && selfPunish[brs[i]]) {
                res.push({t:'è‡ªåˆ‘',c:`${BRANCH[brs[i]].c}+${BRANCH[brs[j]].c}`,m:selfPunish[brs[i]],d:'Self-harm punishment. Watch self-blame and depression! Practice self-love.'});
            }
        }
    }
    
    // íŒŒ
    const brPa = [[0,9,'å­é…‰(Rat-Rooster) destruction','Relationships may break easily.'],[3,6,'å¯åˆ(Rabbit-Horse) destruction','Plans may go awry.'],[2,11,'å¯…äº¥(Tiger-Pig) destruction','Complete tasks properly.'],[4,1,'è¾°ä¸‘(Dragon-Ox) destruction','Foundation may shake.']];
    for (let [a,b,n,desc] of brPa) {
        if (brs.includes(a) && brs.includes(b)) res.push({t:'ç ´',c:`${BRANCH[a].c}â†”${BRANCH[b].c}`,m:n,d:desc});
    }
    
    // í•´
    const brHae = [[0,7,'å­æœª(Rat-Goat) harm','Close ones may hold you back.'],[1,6,'ä¸‘åˆ(Ox-Horse) harm','Watch partnerships!'],[2,5,'å¯…å·³(Tiger-Snake) harm','Jealousy may arise. Avoid showing off.'],[3,4,'å¯è¾°(Rabbit-Dragon) harm','Small matters may cause big fights.']];
    for (let [a,b,n,desc] of brHae) {
        if (brs.includes(a) && brs.includes(b)) res.push({t:'å®³',c:`${BRANCH[a].c}â†”${BRANCH[b].c}`,m:n,d:desc});
    }
    
    // ì›ì§„ (æ€¨å—”) - ê¶í•©ì—ì„œ ì¤‘ìš”
    const wonJin = [[0,7,'å­æœª(Rat-Goat) resentment'],[1,6,'ä¸‘åˆ(Ox-Horse) resentment'],[2,5,'å¯…å·³(Tiger-Snake) resentment'],[3,4,'å¯è¾°(Rabbit-Dragon) resentment'],[4,3,'è¾°å¯(Dragon-Rabbit) resentment'],[5,2,'å·³å¯…(Snake-Tiger) resentment'],[6,1,'åˆä¸‘(Horse-Ox) resentment'],[7,0,'æœªå­(Goat-Rat) resentment'],[8,11,'ç”³äº¥(Monkey-Pig) resentment'],[9,10,'é…‰æˆŒ(Rooster-Dog) resentment'],[10,9,'æˆŒé…‰(Dog-Rooster) resentment'],[11,8,'äº¥ç”³(Pig-Monkey) resentment']];
    for (let [a,b,n] of wonJin) {
        if (brs.includes(a) && brs.includes(b)) {
            res.push({t:'æ€¨å—”',c:`${BRANCH[a].c}â†”${BRANCH[b].c}`,m:n,d:'ë¯¸ì›Œë„ ë–¨ì–´ì§ˆ ìˆ˜ ì—†ëŠ” ì•…ì—°. ë¶€ë¶€ ì‚¬ì´ë©´ ê°ˆë“±ì´ ê¹Šì–´ìš”.'});
        }
    }
    
    // ê·€ë¬¸ (é¬¼é–€)
    const guiMen = [[2,7,'ì¸ë¯¸ê·€ë¬¸'],[3,8,'ë¬˜ì‹ ê·€ë¬¸'],[4,9,'ì§„ìœ ê·€ë¬¸'],[5,10,'ì‚¬ìˆ ê·€ë¬¸'],[6,11,'åˆäº¥(Horse-Pig) Ghost Gate'],[1,6,'ì¶•ì˜¤ê·€ë¬¸']];
    for (let [a,b,n] of guiMen) {
        if (brs.includes(a) && brs.includes(b)) {
            res.push({t:'é¬¼é–€',c:`${BRANCH[a].c}â†”${BRANCH[b].c}`,m:n,d:'ê·€ì‹ ì˜ ë¬¸. ì •ì‹ ì  Fireì•ˆ, ìš°ìš¸ì¦ ì£¼ì˜. ëª…ìƒê³¼ íœ´ì‹ì´ is essential.'});
        }
    }
    
    return res.length ? res : [{t:'-',c:'none',m:'íŠ¹ë³„í•œ í•©ì¶©í˜•íŒŒí•´ none',d:'ì‚¬ì£¼ ë‚´ íŠ¹ë³„í•œ ì‘ìš©ì´ absent. í‰ì˜¨í•œ ì‚¬ì£¼!'}];
}

/* ========================================
   14. ê³µë§
   ======================================== */
function calcGongmang(saju) {
    const stemIdx = STEM.indexOf(saju.day.s);
    const branchIdx = BRANCH.indexOf(saju.day.b);
    
    // 60ê°‘ì ì¸ë±ìŠ¤ ê³„ì‚° (ç”²å­=0, ä¹™ä¸‘=1, ... ç™¸äº¥=59)
    const sexagenaryIdx = (stemIdx * 6 - branchIdx * 5 + 60) % 60;
    
    // ìˆœ(æ—¬) ë²ˆí˜¸ (0=ç”²å­ìˆœ, 1=ç”²æˆŒìˆœ, 2=ç”²ç”³ìˆœ, 3=ç”²åˆìˆœ, 4=ç”²è¾°ìˆœ, 5=ç”²å¯…ìˆœ)
    const xunNum = Math.floor(sexagenaryIdx / 10);
    
    // ê³µë§ ì§€ì§€ ê³„ì‚°
    // ìˆœ0(ç”²å­):æˆŒäº¥, ìˆœ1(ç”²æˆŒ):ç”³é…‰, ìˆœ2(ç”²ç”³):åˆæœª, ìˆœ3(ç”²åˆ):è¾°å·³, ìˆœ4(ç”²è¾°):å¯…å¯, ìˆœ5(ç”²å¯…):å­ä¸‘
    const gm = [(10 - xunNum * 2 + 12) % 12, (11 - xunNum * 2 + 12) % 12];
    
    const names = [BRANCH[gm[0]].c, BRANCH[gm[1]].c];
    const affected = [];
    const pillars = ['Year Branch','Month Branch','Day Branch','Hour Branch'];
    const brs = [BRANCH.indexOf(saju.year.b), BRANCH.indexOf(saju.month.b), BRANCH.indexOf(saju.day.b)];
    if (saju.hour) brs.push(BRANCH.indexOf(saju.hour.b));
    
    brs.forEach((b, i) => { if (gm.includes(b)) affected.push(pillars[i]); });
    
    return { gm, names, affected };
}

/* ========================================
   14-0-1. ìœ¡ì¹œë¡ (å…­è¦ªè«–) - ë¶€ëª¨/í˜•ì œ/ìë…€/ë°°ìš°ì ìš´
   ======================================== */
function analyzeYukChinRon(saju, gender) {
    const dm = saju.day.s;
    const result = {
        father: null,    // ë¶€ì¹œ (åè²¡/Indirect Wealth)
        mother: null,    // ëª¨ì¹œ (Direct Seal/Indirect Seal)
        sibling: null,   // í˜•ì œ (Peer/Rob Wealth)
        spouse: null,    // ë°°ìš°ì (ë‚¨:ì¬ì„±, ì—¬:ê´€ì„±)
        children: null   // ìë…€ (ë‚¨:ê´€ì„±, ì—¬:ì‹ìƒ)
    };
    
    // ì‹­ì‹  ë¶„í¬ ë¶„ì„
    const godCount = {};
    const godPositions = {};
    const pillars = [
        {name: 'å¹´æŸ±(å¹´æŸ±(Year Pillar))', pillar: saju.year},
        {name: 'Month', pillar: saju.month},
        {name: 'Day', pillar: saju.day},
    ];
    if (saju.hour) pillars.push({name: 'Hour', pillar: saju.hour});
    
    pillars.forEach(p => {
        if (p.name === 'Day') return; // æ—¥ä¸»(Day Master)ì€ ì œì™¸
        const sGod = getTenGod(p.pillar.s, dm);
        const bGod = getTenGod(p.pillar.b, dm); // ì§€ì§€ì˜ ë³¸ê¸° ê¸°ì¤€
        
        [sGod, bGod].forEach(god => {
            if (god) {
                if (!godCount[god.k]) godCount[god.k] = 0;
                if (!godPositions[god.k]) godPositions[god.k] = [];
                godCount[god.k]++;
                godPositions[god.k].push(p.name);
            }
        });
    });
    
    // 1. ë¶€ì¹œìš´ (åè²¡/Indirect Wealth)
    const fatherGod = 'åè²¡(Indirect Wealth)';
    const fatherCount = godCount[fatherGod] || 0;
    if (fatherCount >= 2) {
        result.father = {status: 'strong', desc: 'Deep bond with father. You receive paternal support and blessings.', icon: 'ğŸ‘¨â€ğŸ‘¦'};
    } else if (fatherCount === 1) {
        result.father = {status: 'normal', desc: 'Normal relationship with father. Healthy distance works well.', icon: 'ğŸ‘¨'};
    } else {
        result.father = {status: 'weak', desc: 'Weak father bond or early separation possible.', icon: 'ğŸ‘¤'};
    }
    
    // 2. ëª¨ì¹œìš´ (Direct Seal/Indirect Seal)
    const motherCount = (godCount['æ­£å°(Direct Seal)'] || 0) + (godCount['åå°(Indirect Seal)'] || 0);
    if (motherCount >= 2) {
        result.mother = {status: 'strong', desc: 'Deep bond with mother. You receive abundant maternal love.', icon: 'ğŸ‘©â€ğŸ‘¦'};
    } else if (motherCount === 1) {
        result.mother = {status: 'normal', desc: 'Normal relationship with mother.', icon: 'ğŸ‘©'};
    } else {
        result.mother = {status: 'weak', desc: 'Weak mother bond or early independence likely.', icon: 'ğŸ‘¤'};
    }
    
    // 3. í˜•ì œìš´ (Peer/Rob Wealth)
    const siblingCount = (godCount['æ¯”è‚©(Peer)'] || 0) + (godCount['åŠ«è²¡(Rob Wealth)'] || 0);
    if (siblingCount >= 2) {
        result.sibling = {status: 'strong', desc: 'í˜•ì œ ìë§¤ê°€ ë§ê±°ë‚˜ ì¸ì—°ì´ ê¹Šì–´ìš”. ê²½ìŸë„ ìˆì„ ìˆ˜ present.', icon: 'ğŸ‘«'};
    } else if (siblingCount === 1) {
        result.sibling = {status: 'normal', desc: 'í˜•ì œ ìë§¤ì™€ í‰ë²”í•œ ê´€ê³„ì˜ˆìš”.', icon: 'ğŸ§‘â€ğŸ¤â€ğŸ§‘'};
    } else {
        result.sibling = {status: 'weak', desc: 'í˜•ì œ ìë§¤ê°€ ì ê±°ë‚˜ Weak connection. ë…ë¦½ì‹¬ì´ ê°•í•´ìš”.', icon: 'ğŸ§'};
    }
    
    // 4. Spouse Fortune (ë‚¨:ì¬ì„±, ì—¬:ê´€ì„±)
    let spouseCount, spouseGods;
    if (gender === 'm') {
        spouseCount = (godCount['æ­£è²¡(Direct Wealth)'] || 0) + (godCount['åè²¡(Indirect Wealth)'] || 0);
        spouseGods = ['æ­£è²¡(Direct Wealth)', 'åè²¡(Indirect Wealth)'];
    } else {
        spouseCount = (godCount['æ­£å®˜(Direct Officer)'] || 0) + (godCount['åå®˜(Seven Killings)'] || 0);
        spouseGods = ['æ­£å®˜(Direct Officer)', 'åå®˜(Seven Killings)'];
    }
    
    // Day Branch(Spouse Palace) ë¶„ì„
    const spouseGod = getTenGod(saju.day.b, dm);
    const spouseGodMatch = spouseGod && spouseGods.includes(spouseGod.k);
    
    if (spouseCount >= 2 && spouseGodMatch) {
        result.spouse = {status: 'excellent', desc: 'ë°°ìš°ì ë³µì´ ì•„ì£¼ ì¢‹ì•„ìš”! ì¢‹ì€ ì§ì„ ë§Œë‚˜ìš”.', icon: 'ğŸ’‘'};
    } else if (spouseCount >= 1 || spouseGodMatch) {
        result.spouse = {status: 'good', desc: 'ë°°ìš°ì ìš´ì´ ì¢‹ì€ í¸ì´ì—ìš”. ê²°í˜¼í•˜ë©´ ì•ˆì •ë¼ìš”.', icon: 'ğŸ’'};
    } else {
        result.spouse = {status: 'normal', desc: 'ë°°ìš°ì ì¸ì—°ì€ í‰ë²”í•´ìš”. ëŠ¦ê²Œ ë§Œë‚˜ë„ ê´œì°®ì•„ìš”.', icon: 'ğŸ’’'};
    }
    
    // 5. ìë…€ìš´ (ë‚¨:ê´€ì„±, ì—¬:ì‹ìƒ)
    let childCount;
    if (gender === 'm') {
        childCount = (godCount['æ­£å®˜(Direct Officer)'] || 0) + (godCount['åå®˜(Seven Killings)'] || 0);
    } else {
        childCount = (godCount['é£Ÿç¥(Eating God)'] || 0) + (godCount['å‚·å®˜(Hurting Officer)'] || 0);
    }
    
    // Hour(Children Palace) ë¶„ì„
    const hasHour = !!saju.hour;
    if (childCount >= 2) {
        result.children = {status: 'strong', desc: 'Excellent children fortune! Your children will make you proud.', icon: 'ğŸ‘¶ğŸ‘¶'};
    } else if (childCount === 1) {
        result.children = {status: 'normal', desc: 'Normal children fortune. 1-2 children recommended.', icon: 'ğŸ‘¶'};
    } else {
        result.children = {status: 'weak', desc: 'Weak children bond or late arrival possible. Effort is essential.', icon: 'ğŸ¼'};
    }
    
    return result;
}

/* ========================================
   14-0-2. ì§ˆë³‘ë¡ (ç–¾ç—…è«–) - ì˜¤í–‰ë³„ ê±´ê°•
   ======================================== */
function analyzeHealth(saju, gods) {
    const result = {
        strong: [],  // ê°•í•œ ì˜¤í–‰ (ê³¼ì‰)
        weak: [],    // ì•½í•œ ì˜¤í–‰ (ë¶€ì¡±)
        advice: []   // ê±´ê°• ì¡°ì–¸
    };
    
    // äº”è¡Œ(Five Elements) Distribution ê³„ì‚°
    const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if (p && p.s) elCount[p.s.e]++;
        if (p && p.b) elCount[p.b.e]++;
    });
    
    // ì˜¤í–‰ë³„ ì¥ê¸°/ì§ˆë³‘ ë§¤í•‘
    const healthMap = {
        wood: {
            organ: 'ê°„ì¥(è‚), ë‹´ë‚­, ëˆˆ, ê·¼ìœ¡, ì†í†±',
            excess: 'ë‘í†µ, ëˆˆ ì¶©í˜ˆ, ê·¼ìœ¡ ê²½ë ¨, Fireë¥¼ ì˜ ëƒ„',
            deficient: 'ì‹œë ¥ ì €í•˜, í”¼ë¡œ, ê·¼ë ¥ ì•½Fire, ì†í†± ê°ˆë¼ì§',
            advice: 'í‘¸ë¥¸ ì±„ì†Œ ì„­ì·¨, ëˆˆ íœ´ì‹, ìŠ¤íŠ¸ë ˆì¹­'
        },
        fire: {
            organ: 'ì‹¬ì¥(å¿ƒ), ì†Œì¥, í˜€, í˜ˆê´€',
            excess: 'Fireë©´ì¦, ê°€ìŠ´ ë‘ê·¼ê±°ë¦¼, í˜€ ì—¼ì¦, ê³ í˜ˆì••',
            deficient: 'ì €í˜ˆì••, ì†ë°œ ì°¨ê°€ì›€, ìš°ìš¸ì¦, ë¬´ê¸°ë ¥',
            advice: 'ë¶‰ì€ ìŒì‹(Earthë§ˆEarth, ëŒ€ì¶”), ìœ ì‚°ì†Œ ìš´ë™, ëª…ìƒ'
        },
        earth: {
            organ: 'ë¹„ì¥(è„¾), ìœ„ì¥, ì…ìˆ , ì‚´',
            excess: 'ì†ŒFireFireëŸ‰, ë¹„ë§Œ, ì…ìˆ  íŠ¸ê¸°, ê±±ì • ê³¼ë‹¤',
            deficient: 'ì‹ìš•ë¶€ì§„, ë§ˆë¦„, ì†ŒFireë ¥ ì•½í•¨, ë¬´ë ¥ê°',
            advice: 'ë…¸ë€ ìŒì‹(ê³ êµ¬ë§ˆ, í˜¸ë°•), ê·œì¹™ì  ì‹ì‚¬, ê³¼ì‹ Metalì§€'
        },
        metal: {
            organ: 'í(è‚º), ëŒ€ì¥, ì½”, í”¼ë¶€, í„¸',
            excess: 'í”¼ë¶€ íŠ¸ëŸ¬ë¸”, ë³€ë¹„, í˜¸í¡ê¸° ê³¼ë¯¼',
            deficient: 'ê°ê¸° ì¦ìŒ, í”¼ë¶€ ê±´ì¡°, ëŒ€ì¥ ì•½í•¨, ìŠ¬í”” ë§ìŒ',
            advice: 'í° ìŒì‹(ë¬´, ë°°, ë„ë¼ì§€), í˜¸í¡ ìš´ë™, í”¼ë¶€ ë³´ìŠµ'
        },
        water: {
            organ: 'ì‹ ì¥(è…), ë°©ê´‘, ê·€, ë¼ˆ, ë¨¸ë¦¬ì¹´ë½',
            excess: 'ë¶€ì¢…, ì•¼ë‡¨ì¦, ë‘ë ¤ì›€ ê³¼ë‹¤',
            deficient: 'í—ˆë¦¬ ì•½í•¨, íƒˆëª¨, ì´ëª…, ì •ë ¥ ì €í•˜, ë¼ˆ ì•½í•¨',
            advice: 'ê²€ì€ ìŒì‹(ê²€ì€ì½©, ë¯¸ì—­), ì¶©ë¶„í•œ Waterë¶„, í—ˆë¦¬ ìš´ë™'
        }
    };
    
    const elNames = {wood:'Wood(æœ¨)', fire:'Fire(ç«)', earth:'Earth(åœŸ)', metal:'Metal(é‡‘)', water:'Water(æ°´)'};
    
    // ë¶„ì„
    for (const el in elCount) {
        const count = elCount[el];
        const info = healthMap[el];
        
        if (count >= 3) {
            result.strong.push({
                element: elNames[el],
                count: count,
                organ: info.organ,
                symptom: info.excess,
                icon: 'âš ï¸'
            });
        } else if (count === 0) {
            result.weak.push({
                element: elNames[el],
                count: count,
                organ: info.organ,
                symptom: info.deficient,
                icon: 'â—'
            });
        }
    }
    
    // ìš©ì‹ /ê¸°ì‹  ê¸°ë°˜ ì¡°ì–¸
    if (gods.yong) {
        const yongInfo = healthMap[gods.yong];
        if (yongInfo) {
            result.advice.push({
                title: `ìš©ì‹ (${elNames[gods.yong]}) ë³´ê°•`,
                desc: yongInfo.advice,
                icon: 'ğŸ’ª'
            });
        }
    }
    
    // ê°€ì¥ ì•½í•œ ì˜¤í–‰ ì°¾ê¸°
    let minEl = null, minCount = 10;
    for (const el in elCount) {
        if (elCount[el] < minCount) {
            minCount = elCount[el];
            minEl = el;
        }
    }
    if (minEl && healthMap[minEl]) {
        result.advice.push({
            title: `ë¶€ì¡±í•œ ${elNames[minEl]} ë³´ê°•`,
            desc: healthMap[minEl].advice,
            icon: 'ğŸ©º'
        });
    }
    
    // ê³„ì ˆ ì¡°ì–¸ (Month Branch ê¸°ì¤€)
    const monthEl = saju.month.b.e;
    if (monthEl === 'water' || monthEl === 'metal') {
        result.advice.push({
            title: 'ì°¨ê°€ìš´ ê¸°ìš´ ì£¼ì˜',
            desc: 'ê°€ì„/ê²¨ìš¸ì— íƒœì–´ë‚˜ ëª¸ì´ ì°° ìˆ˜ present. ë”°ëœ»í•˜ê²Œ!',
            icon: 'ğŸ”¥'
        });
    } else if (monthEl === 'fire') {
        result.advice.push({
            title: 'ë”ìš´ ê¸°ìš´ ì£¼ì˜',
            desc: 'ì—¬ë¦„ì— íƒœì–´ë‚˜ ì—´ì´ ë§ì„ ìˆ˜ present. cooling!',
            icon: 'â„ï¸'
        });
    }
    
    return result;
}

/* ========================================
   14-0. ê¶ìœ„(å®®ä½) ë¶„ì„
   ======================================== */
function analyzeGungwi(saju, birthYear) {
    const dm = saju.day.s;
    const curAge = new Date().getFullYear() - birthYear;
    
    // ê¶ìœ„ ì •ì˜
    const gungwi = [
        {
            name: 'å¹´æŸ±(å¹´æŸ±(Year Pillar))(å¹´æŸ±)',
            alias: 'Ancestor PalaceÂ·Social Palace',
            pillar: saju.year,
            ageRange: 'Ages 1-15',
            represents: 'Ancestors, grandparents, social environment, early fortune',
            bodyPart: 'Head, face',
            relationM: 'Grandparents, maternal family',
            relationF: 'Grandmother, maternal family'
        },
        {
            name: 'Month(æœˆæŸ±)',
            alias: 'Parents PalaceÂ·Career Palace',
            pillar: saju.month,
            ageRange: 'Ages 16-30',
            represents: 'Parents, siblings, career, business, youth fortune',
            bodyPart: 'Chest, shoulders',
            relationM: 'Father, siblings',
            relationF: 'Mother, sisters'
        },
        {
            name: 'Day(æ—¥æŸ±)',
            alias: 'Spouse PalaceÂ·Self Palace',
            pillar: saju.day,
            ageRange: 'Ages 31-45',
            represents: 'Self, spouse, family, middle age fortune',
            bodyPart: 'Waist, abdomen',
            relationM: 'Spouse, self',
            relationF: 'Husband, self'
        },
        {
            name: 'Hour(æ™‚æŸ±)',
            alias: 'Children PalaceÂ·Later Years Palace',
            pillar: saju.hour,
            ageRange: 'Ages 46+',
            represents: 'Children, students, juniors, later years, outcomes',
            bodyPart: 'Legs, feet',
            relationM: 'Children, juniors',
            relationF: 'Children, juniors'
        }
    ];
    
    // ê° ê¶ìœ„ ë¶„ì„
    return gungwi.map((g, idx) => {
        if (!g.pillar) return {...g, analysis: 'No hour data', god: null, state: null};
        
        const god = idx !== 2 ? getTenGod(g.pillar.s, dm) : null;
        const state = getTwelveState(dm, g.pillar.b);
        
        // í•´ë‹¹ ê¶ìœ„ì˜ ìƒíƒœ ë¶„ì„
        let analysis = '';
        let rating = 'neutral';
        
        // 12ìš´ì„±ìœ¼ë¡œ í•´ë‹¹ ê¶ìœ„ Energy íŒë‹¨
        if (state.l >= 9) {
            analysis = 'Strong energy period! Active and dynamic time.';
            rating = 'good';
        } else if (state.l >= 6) {
            analysis = 'Stable energy. A smooth and fortunate period.';
            rating = 'good';
        } else if (state.l >= 3) {
            analysis = 'Moderate energy. A period requiring effort.';
            rating = 'neutral';
        } else {
            analysis = 'Weak energy period. Avoid overexertion.';
            rating = 'bad';
        }
        
        // ì‹­ì‹ ìœ¼ë¡œ ì¶”ê°€ ë¶„ì„
        if (god) {
            if (['æ­£å®˜(Direct Officer)','æ­£è²¡(Direct Wealth)','æ­£å°(Direct Seal)'].includes(god.k)) {
                analysis += ` ${god.k} brings stability to this period.`;
                rating = 'good';
            } else if (['åå®˜(Seven Killings)','åŠ«è²¡(Rob Wealth)'].includes(god.k)) {
                analysis += ` ${god.k} brings transformation and challenges to this period.`;
            }
        }
        
        // Current ë‚˜ì´ë¡œ í•´ë‹¹ ê¶ìœ„ì¸ì§€ ì²´í¬
        let isCurrent = false;
        if (idx === 0 && curAge <= 15) isCurrent = true;
        else if (idx === 1 && curAge >= 16 && curAge <= 30) isCurrent = true;
        else if (idx === 2 && curAge >= 31 && curAge <= 45) isCurrent = true;
        else if (idx === 3 && curAge >= 46) isCurrent = true;
        
        return {
            ...g,
            god,
            state,
            analysis,
            rating,
            isCurrent
        };
    });
}

/* ========================================
   14-0-2. 12ìš´ì„± ì™„ì „ ë¶„ì„
   ======================================== */
function analyzeTwelveStates(saju) {
    const dm = saju.day.s;
    const result = {
        pillars: [],
        summary: '',
        dominant: null,
        lifeFlow: []
    };
    
    const pillarNames = ['å¹´æŸ±(å¹´æŸ±(Year Pillar))', 'Month', 'Day', 'Hour'];
    const pillars = [saju.year, saju.month, saju.day, saju.hour];
    
    // ê° ê¸°ë‘¥ë³„ 12ìš´ì„±
    pillars.forEach((p, idx) => {
        if (!p) return;
        const state = getTwelveState(dm, p.b);
        result.pillars.push({
            name: pillarNames[idx],
            branch: p.b,
            state: state,
            energy: state.l
        });
    });
    
    // ì¸ìƒ íë¦„ ë¶„ì„ (12ìš´ì„± ìˆœì„œëŒ€ë¡œ)
    const lifeStages = [
        {stage: 'Birth(é•·ç”Ÿ)', desc: 'ìƒˆë¡œìš´ ì‹œì‘, í¬ë§ê³¼ ê°€ëŠ¥ì„±', life: 'ìœ ì•„ê¸°'},
        {stage: 'Woodìš•(æ²æµ´)', desc: 'ë³€í™”ì™€ Fireì•ˆì •, ìƒˆë¡œìš´ í™˜ê²½', life: 'ì²­ì†Œë…„ê¸°'},
        {stage: 'Crown(å† å¸¶)', desc: 'ì„±ì¥ê³¼ ë°œì „, ìë¦½', life: 'Youthê¸°'},
        {stage: 'å»ºç¥¿(Prime)', desc: 'ì•ˆì •ê³¼ ë²ˆì˜, ì „ì„±ê¸°', life: 'ì¥ë…„ê¸°'},
        {stage: 'Peak(å¸æ—º)', desc: 'ì •ì , ìµœê³ ì¡°, ê¶Œë ¥', life: 'Middle ageê¸°'},
        {stage: 'Metal(è¡°)', desc: 'í•˜ë½ì˜ ì‹œì‘, ì •ë¦¬', life: 'Middle ageí›„ê¸°'},
        {stage: 'ë³‘(ç—…)', desc: 'ì•½Fire, ê±´ê°• ì£¼ì˜', life: 'ë…¸ë…„ì´ˆê¸°'},
        {stage: 'Death(æ­»)', desc: 'ë§ˆë¬´ë¦¬, ë', life: 'ë…¸ë…„ê¸°'},
        {stage: 'ë¬˜(å¢“)', desc: 'ì €ì¥, ì¶•ì , ì€í‡´', life: 'ë…¸ë…„í›„ê¸°'},
        {stage: 'ì ˆ(çµ¶)', desc: 'ê³µë°±, ë‹¨ì ˆ', life: 'ë§ë…„'},
        {stage: 'Conception(èƒ)', desc: 'ì‰íƒœ, ì¤€ë¹„', life: 'ìƒˆë¡œìš´ ì¤€ë¹„'},
        {stage: 'Nurture(é¤Š)', desc: 'ì–‘ìœ¡, ë³´í˜¸', life: 'íšŒë³µê¸°'}
    ];
    
    // Day Branch 12ìš´ì„±ìœ¼ë¡œ Self ê¸°ë³¸ Energy íŒë‹¨
    const dayState = getTwelveState(dm, saju.day.b);
    if (dayState.l >= 10) {
        result.summary = 'Very strong base energy! Full of vitality and drive.';
        result.dominant = 'strong';
    } else if (dayState.l >= 7) {
        result.summary = 'ê¸°ë³¸ Energyê°€ ì¢‹ì•„ìš”. ì•ˆì •ì ì´ê³  ê¾¸ì¤€í•´ìš”.';
        result.dominant = 'good';
    } else if (dayState.l >= 4) {
        result.summary = 'ê¸°ë³¸ Energyê°€ ë³´í†µì´ì—ìš”. ë…¸ë ¥ìœ¼ë¡œ ë³´ì™„í•˜ì„¸ìš”.';
        result.dominant = 'neutral';
    } else {
        result.summary = 'ê¸°ë³¸ Energyê°€ ì•½í•´ìš”. ì²´ë ¥ ê´€ë¦¬ê°€ ì¤‘ìš”í•´ìš”.';
        result.dominant = 'weak';
    }
    
    // ì¸ìƒ íë¦„ (ë…„â†’ì›”â†’ì¼â†’ì‹œ)
    result.lifeFlow = result.pillars.map((p, idx) => {
        const ageRange = ['Early years(1-15)', 'Youth(16-30)', 'Middle age(31-45)', 'ë§ë…„(46+)'][idx];
        return {
            period: ageRange,
            state: p.state.k,
            energy: p.energy,
            advice: p.energy >= 8 ? 'Active period!' : p.energy >= 5 ? 'ì•ˆì •ì ì¸ ì‹œê¸°' : p.energy >= 3 ? 'ì¸ë‚´ì˜ ì‹œê¸°' : 'íšŒë³µì˜ ì‹œê¸°'
        };
    });
    
    return result;
}

/* ========================================
   14-0-3. í•©ì¶© ê³ ê¸‰ ë¶„ì„ (í•©í™” ì„±ë¦½, ì¶© í•´ì†Œ)
   ======================================== */
function analyzeAdvancedInteractions(saju) {
    const result = {
        hapHwa: [],      // í•©í™”(åˆåŒ–) ë¶„ì„
        chungHaeso: [],  // ì¶© í•´ì†Œ ë¶„ì„
        samhapGuk: [],   // Trinityêµ­ ë¶„ì„
        warnings: []
    };
    
    const mbi = BRANCH.indexOf(saju.month.b);
    const season = SEASON[mbi];
    const stems = [saju.year?.s, saju.month?.s, saju.day?.s, saju.hour?.s].filter(s => s);
    const stemIdxs = stems.map(s => STEM.indexOf(s));
    const brs = [BRANCH.indexOf(saju.year.b), BRANCH.indexOf(saju.month.b), BRANCH.indexOf(saju.day.b)];
    if (saju.hour) brs.push(BRANCH.indexOf(saju.hour.b));
    
    // ========== ì²œê°„ í•©í™”(åˆåŒ–) ì„±ë¦½ ì¡°ê±´ ì²´í¬ ==========
    const ganHap = [
        {pair: [0,5], result: 'earth', name: 'ç”²å·±(Jia-Ji) combine to Earth(ç”²å·±åˆåœŸ)', condition: 'Earthì›”(è¾°æˆŒä¸‘æœªæœˆ) ë˜ëŠ” Earthê°€ ì™•ì„±í•  ë•Œ'},
        {pair: [1,6], result: 'metal', name: 'ä¹™åºš(Yi-Geng) combine to Metal(ä¹™åºšåˆé‡‘)', condition: 'Metalì›”(ç”³é…‰æœˆ) ë˜ëŠ” Metalì´ ì™•ì„±í•  ë•Œ'},
        {pair: [2,7], result: 'water', name: 'ä¸™è¾›(Bing-Xin) combine to Water(ä¸™è¾›åˆæ°´)', condition: 'Waterì›”(äº¥å­æœˆ) ë˜ëŠ” Waterê°€ ì™•ì„±í•  ë•Œ'},
        {pair: [3,8], result: 'wood', name: 'ä¸å£¬(Ding-Ren) combine to Wood(ä¸å£¬åˆæœ¨)', condition: 'Woodì›”(å¯…å¯æœˆ) ë˜ëŠ” Woodì´ ì™•ì„±í•  ë•Œ'},
        {pair: [4,9], result: 'fire', name: 'æˆŠç™¸(Wu-Gui) combine to Fire(æˆŠç™¸åˆç«)', condition: 'Fireì›”(å·³åˆæœˆ) ë˜ëŠ” Fireê°€ ì™•ì„±í•  ë•Œ'}
    ];
    
    for (let gh of ganHap) {
        if (stemIdxs.includes(gh.pair[0]) && stemIdxs.includes(gh.pair[1])) {
            // í•©ì´ ì¡´ì¬
            const resultEl = gh.result;
            let isHwa = false;
            let reason = '';
            
            // ì›”ë ¹ì´ í•´ë‹¹ ì˜¤í–‰ì¸ì§€ ì²´í¬
            const seasonEl = {spring:'wood', summer:'fire', autumn:'metal', winter:'water'};
            if (seasonEl[season] === resultEl) {
                isHwa = true;
                reason = `ì›”ë ¹ì´ ${ELEMENT[resultEl].k}ì´ë¼ í•©í™” ì„±ë¦½!`;
            }
            // ì§€ì§€ì— í•´ë‹¹ ì˜¤í–‰ì´ ë§ì€ì§€ ì²´í¬
            const resultElCount = brs.filter(b => BRANCH[b].e === resultEl).length;
            if (resultElCount >= 2) {
                isHwa = true;
                reason = `ì§€ì§€ì— ${ELEMENT[resultEl].k}ì´ ${resultElCount}ê°œë¼ í•©í™” ì„±ë¦½!`;
            }
            
            result.hapHwa.push({
                name: gh.name,
                stems: `${STEM[gh.pair[0]].c}+${STEM[gh.pair[1]].c}`,
                result: isHwa ? ELEMENT[resultEl].k : null,
                isHwa,
                reason: isHwa ? reason : 'í•©ì€ ìˆìœ¼ë‚˜ Fire(åŒ–)ë˜ì§€ ì•ŠìŒ - í•©ê±°(åˆå») ìƒíƒœ'
            });
        }
    }
    
    // ========== ì§€ì§€ Trinityêµ­(ä¸‰åˆå±€) ì™„ì „ ì„±ë¦½ ì—¬ë¶€ ==========
    const samhap = [
        {branches: [2,6,10], result: 'fire', name: 'å¯…åˆæˆŒ(Tiger-Horse-Dog) Fire combination(å¯…åˆæˆŒ ç«å±€)'},
        {branches: [5,9,1], result: 'metal', name: 'å·³é…‰ä¸‘(Snake-Rooster-Ox) Metal combination(å·³é…‰ä¸‘ é‡‘å±€)'},
        {branches: [8,0,4], result: 'water', name: 'ç”³å­è¾°(Monkey-Rat-Dragon) Water combination(ç”³å­è¾° æ°´å±€)'},
        {branches: [11,3,7], result: 'wood', name: 'äº¥å¯æœª(Pig-Rabbit-Goat) Wood combination(äº¥å¯æœª æœ¨å±€)'}
    ];
    
    for (let sh of samhap) {
        const hasCount = sh.branches.filter(b => brs.includes(b)).length;
        if (hasCount >= 2) {
            const hasCenter = brs.includes(sh.branches[1]); // ì¤‘ì‹¬ ì§€ì§€ (ì˜¤í–‰ì˜ ì™•ì§€)
            result.samhapGuk.push({
                name: sh.name,
                complete: hasCount === 3,
                hasCenter,
                result: ELEMENT[sh.result].k,
                desc: hasCount === 3 ? 
                    `ì™„ì „í•œ ${sh.name} ì„±ë¦½! ${ELEMENT[sh.result].k} ê¸°ìš´ì´ ê°•í•´ìš”.` :
                    hasCenter ? 
                    `${sh.name} half-combination(åŠåˆ). ì™•ì§€(${BRANCH[sh.branches[1]].c})ê°€ ìˆì–´ì„œ í˜exists.` :
                    `${sh.name} half-combinationì´ì§€ë§Œ ì™•ì§€ê°€ ì—†ì–´ì„œ í˜ì´ ì•½í•´ìš”.`
            });
        }
    }
    
    // ========== ì¶©(æ²–) í•´ì†Œ ì¡°ê±´ ì²´í¬ ==========
    const clashPairs = [[0,6],[1,7],[2,8],[3,9],[4,10],[5,11]];
    for (let [a,b] of clashPairs) {
        if (brs.includes(a) && brs.includes(b)) {
            // ì¶©ì´ ì¡´ì¬
            let isResolved = false;
            let resolveReason = '';
            
            // í•©ìœ¼ë¡œ í•´ì†Œë˜ëŠ”ì§€ ì²´í¬ (Six Harmony)
            const hapPairs = [[0,1],[2,11],[3,10],[4,9],[5,8],[6,7]];
            for (let [ha, hb] of hapPairs) {
                if ((brs.includes(a) && (brs.includes(ha) && a === hb) || (brs.includes(hb) && a === ha)) ||
                    (brs.includes(b) && (brs.includes(ha) && b === hb) || (brs.includes(hb) && b === ha))) {
                    // ì¶© ë‹¹ì‚¬ì ì¤‘ í•˜ë‚˜ê°€ í•©ì„ ë§Œë‚˜ë©´ ì¶©ì´ ì•½í•´ì§
                    isResolved = true;
                    resolveReason = 'í•©(åˆ)ì´ ìˆì–´ì„œ ì¶©ì´ ì™„í™”ë¨';
                }
            }
            
            result.chungHaeso.push({
                clash: `${BRANCH[a].c}${BRANCH[b].c} ì¶©`,
                isResolved,
                reason: isResolved ? resolveReason : 'ì¶©ì´ í•´ì†Œë˜ì§€ ì•ŠìŒ - ì£¼ì˜ í•„ìš”'
            });
        }
    }
    
    // ========== ê²½ê³  ì‚¬í•­ ==========
    // Hurting Officerê²¬ê´€ ì²´í¬
    const dm = saju.day.s;
    const godCounts = {};
    stems.forEach((s, idx) => {
        if (idx === 2) return; // æ—¥ä¸»(Day Master) ì œì™¸
        const god = getTenGod(s, dm);
        godCounts[god.k] = (godCounts[god.k] || 0) + 1;
    });
    
    if (godCounts['å‚·å®˜(Hurting Officer)'] && godCounts['æ­£å®˜(Direct Officer)']) {
        result.warnings.push({
            type: 'Hurting Officerê²¬ê´€(å‚·å®˜è¦‹å®˜)',
            desc: 'Hurting Officerì´ Direct Officerì„ ê·¹í•©ë‹ˆë‹¤. ì§ì¥, ëª…ì˜ˆì— ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ present. ê´€ì§ë³´ë‹¤ ì‚¬ì—…ì´ ì¢‹ì•„ìš”.'
        });
    }
    
    if (godCounts['åå°(Indirect Seal)'] && godCounts['é£Ÿç¥(Eating God)']) {
        result.warnings.push({
            type: 'íš¨ì‹ íƒˆì‹(æ¢Ÿç¥å¥ªé£Ÿ)',
            desc: 'Indirect Sealì´ Eating Godì„ ê·¹í•©ë‹ˆë‹¤. ì¬ëŠ¥ ë°œíœ˜ê°€ ë§‰í ìˆ˜ present. ìš°ìš¸ì¦ Caution!'
        });
    }
    
    return result;
}

/* ========================================
   14-1. æ”¯è—å¹²(Hidden Stems)(åœ°è—å¹²) ë¶„ì„
   ======================================== */
// íŠ¹ì • ì§€ì§€ì˜ æ”¯è—å¹²(Hidden Stems) ì •ë³´ ë°˜í™˜
function getJijanggan(branch) {
    const bi = BRANCH.indexOf(branch);
    return JIJANGGAN[bi] || [];
}

// æ”¯è—å¹²(Hidden Stems)ì—ì„œ íŠ¹ì • ì²œê°„ì´ ìˆëŠ”ì§€ í™•ì¸ (íˆ¬ì¶œ ì—¬ë¶€)
function hasHiddenStem(branch, stemIdx) {
    const jj = getJijanggan(branch);
    return jj.some(j => j.stem === stemIdx);
}

// æ—¥ä¸»(Day Master)ì´ ì§€ì§€ì— Root Connection (Tong-geun)í•˜ëŠ”ì§€ ë¶„ì„
// í†µê·¼: æ—¥ä¸»(Day Master)ê³¼ ê°™ì€ ì˜¤í–‰ì´ æ”¯è—å¹²(Hidden Stems)ì— ìˆëŠ” ê²½ìš°
function analyzeRoot(dayStem, branch) {
    const jj = getJijanggan(branch);
    const dsEl = dayStem.e;
    const roots = [];
    
    jj.forEach(j => {
        const hiddenStem = STEM[j.stem];
        if (hiddenStem.e === dsEl) {
            // í†µê·¼ ë°œê²¬
            const strength = j.days >= 16 ? 'strong' : j.days >= 7 ? 'medium' : 'weak';
            roots.push({
                stem: hiddenStem,
                days: j.days,
                type: j.type,
                strength,
                name: j.name
            });
        }
    });
    return roots;
}

// ì²œê°„ì´ ì§€ì§€ì— Stem Emergence (Tu-gan)í–ˆëŠ”ì§€ ë¶„ì„
// íˆ¬ê°„: ì²œê°„ ê¸€ìê°€ æ”¯è—å¹²(Hidden Stems)ì—ë„ ì¡´ì¬í•˜ëŠ” ê²½ìš°
function analyzeTougan(saju) {
    const result = [];
    const allStems = [
        {pillar: 'ë…„ê°„', stem: saju.year.s},
        {pillar: 'ì›”ê°„', stem: saju.month.s},
        {pillar: 'æ—¥ä¸»(Day Master)', stem: saju.day.s},
    ];
    if (saju.hour) allStems.push({pillar: 'ì‹œê°„', stem: saju.hour.s});
    
    const allBranches = [
        {pillar: 'Year Branch', branch: saju.year.b},
        {pillar: 'Month Branch', branch: saju.month.b},
        {pillar: 'Day Branch', branch: saju.day.b},
    ];
    if (saju.hour) allBranches.push({pillar: 'Hour Branch', branch: saju.hour.b});
    
    allStems.forEach(st => {
        const si = STEM.indexOf(st.stem);
        allBranches.forEach(br => {
            const jj = getJijanggan(br.branch);
            jj.forEach(j => {
                if (j.stem === si) {
                    result.push({
                        stem: st.stem,
                        stemPillar: st.pillar,
                        branch: br.branch,
                        branchPillar: br.pillar,
                        days: j.days,
                        type: j.type,
                        desc: `${st.stem.c}(${st.pillar})ì´ ${br.branch.c}(${br.pillar})ì— ë¿Œë¦¬ë‚´ë¦¼`
                    });
                }
            });
        });
    });
    return result;
}

// ì‚¬ì£¼ ì „ì²´ í†µê·¼ ë¶„ì„
function analyzeAllRoots(saju) {
    const dm = saju.day.s;
    const branches = [
        {name: 'Year Branch', branch: saju.year.b},
        {name: 'Month Branch', branch: saju.month.b},
        {name: 'Day Branch', branch: saju.day.b}
    ];
    if (saju.hour) branches.push({name: 'Hour Branch', branch: saju.hour.b});
    
    const allRoots = [];
    let totalScore = 0;
    
    branches.forEach(b => {
        const roots = analyzeRoot(dm, b.branch);
        roots.forEach(r => {
            let score = 0;
            if (r.strength === 'strong') score = 3;
            else if (r.strength === 'medium') score = 2;
            else score = 1;
            
            // Month Branch í†µê·¼ì€ 2ë°°
            if (b.name === 'Month Branch') score *= 2;
            // Day Branch í†µê·¼ë„ 1.5ë°°
            if (b.name === 'Day Branch') score *= 1.5;
            
            totalScore += score;
            allRoots.push({
                ...r,
                position: b.name,
                branch: b.branch,
                score
            });
        });
    });
    
    return { roots: allRoots, totalScore };
}

// ì˜¤í–‰ ê°œìˆ˜ ê³„ì‚° (æ”¯è—å¹²(Hidden Stems) í¬í•¨ ê³ ê¸‰ ë²„ì „)
function countElementsAdvanced(saju) {
    const ec = {wood:0, fire:0, earth:0, metal:0, water:0};
    const details = {wood:[], fire:[], earth:[], metal:[], water:[]};
    
    // ì²œê°„ (100% ë°˜ì˜)
    const stems = [
        {pos:'ë…„ê°„', s:saju.year.s},
        {pos:'ì›”ê°„', s:saju.month.s},
        {pos:'æ—¥ä¸»(Day Master)', s:saju.day.s}
    ];
    if (saju.hour) stems.push({pos:'ì‹œê°„', s:saju.hour.s});
    
    stems.forEach(st => {
        ec[st.s.e] += 1;
        details[st.s.e].push(`${st.s.c}(${st.pos}) 1.0`);
    });
    
    // ì§€ì§€ ë³¸ê¸° (100% ë°˜ì˜)
    const branches = [
        {pos:'Year Branch', b:saju.year.b},
        {pos:'Month Branch', b:saju.month.b},
        {pos:'Day Branch', b:saju.day.b}
    ];
    if (saju.hour) branches.push({pos:'Hour Branch', b:saju.hour.b});
    
    branches.forEach(br => {
        ec[br.b.e] += 1;
        details[br.b.e].push(`${br.b.c}(${br.pos}) 1.0`);
    });
    
    // æ”¯è—å¹²(Hidden Stems) (ë¹„ìœ¨ ë°˜ì˜)
    branches.forEach(br => {
        const bi = BRANCH.indexOf(br.b);
        const jj = JIJANGGAN[bi] || [];
        jj.forEach(j => {
            const hiddenStem = STEM[j.stem];
            const ratio = j.days / 30; // ì¼Waterì— ë”°ë¥¸ ë¹„ìœ¨
            ec[hiddenStem.e] += ratio * 0.5; // æ”¯è—å¹²(Hidden Stems)ì€ 50% ê°€ì¤‘ì¹˜
            details[hiddenStem.e].push(`${hiddenStem.c}(${br.pos}è—) ${(ratio*0.5).toFixed(2)}`);
        });
    });
    
    return { counts: ec, details };
}

/* ========================================
   14-1-2. ì˜¤í–‰ ê°œìˆ˜ ê³„ì‚° (ë‹¨ìˆœ)
   ======================================== */
function countElements(saju) {
    const ec = {wood:0, fire:0, earth:0, metal:0, water:0};
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if (!p) return;
        ec[p.s.e]++;
        ec[p.b.e]++;
    });
    return ec;
}

/* ========================================
   14-2. ìƒì„¸ í†µë³€ - Today's Fortune
   ======================================== */
function genTodayFortune(saju, gods) {
    const now = new Date();
    const ty = now.getFullYear(), tm = now.getMonth() + 1, td = now.getDate();
    const dp = calcDayPillar(ty, tm, td);
    const dm = saju.day.s;
    const god = getTenGod(dp.s, dm);
    const state = getTwelveState(dm, dp.b);
    
    const godMeaning = {
        'æ¯”è‚©(Peer)': {r:3, l:'ğŸ¥Š ê²½ìŸì˜ ë‚ ', d:'ì˜¤ëŠ˜ì€ ë‚˜ì™€ ë¹„ìŠ·í•œ ì‚¬ëŒë“¤ì´ ë§ì´ ë³´ì´ëŠ” ë‚ . ê²½ìŸìê°€ ë‚˜íƒ€ë‚˜ê±°ë‚˜ ë‚´ ì˜ê²¬ì„ ê°•í•˜ê²Œ ì£¼ì¥í•˜ê²Œ ë  ìˆ˜ present.<br><br><strong>ğŸ’¡ íŒ:</strong> í˜¼ì í•  ìˆ˜ ìˆëŠ” ì¼ì— ì§‘ì¤‘í•˜ì„¸ìš”.'},
        'åŠ«è²¡(Rob Wealth)': {r:2, l:'ğŸ’¸ ì§€ì¶œ ì£¼ì˜ë³´', d:'ì˜¤ëŠ˜ì€ ëˆì´ ë¹ ì ¸ë‚˜ê°€ê¸° ì‰¬ìš´ ë‚ ! ì¶©ë™êµ¬ë§¤, ì¹œêµ¬í•œí…Œ ëˆ ë¹Œë ¤ì£¼ê¸° í”¼í•˜ì„¸ìš”.<br><br><strong>ğŸ’¡ íŒ:</strong> "ë‚´ì¼ ë‹¤ì‹œ ìƒê°í•´ë³¼ê²Œ"ê°€ ì˜¤ëŠ˜ì˜ ë§ˆë²• ì£¼ë¬¸!'},
        'é£Ÿç¥(Eating God)': {r:4, l:'ğŸ½ï¸ ë§›ìˆëŠ” í•˜ë£¨', d:'ë­˜ í•´ë„ ì—¬ìœ ë¡­ê³  ê¸°ë¶„ ì¢‹ì€ ë‚ ! ë§›ìˆëŠ” ê±° ë¨¹ê³  ì·¨ë¯¸ í™œë™ë„ ì¢‹ì•„ìš”.<br><br><strong>ğŸ’¡ íŒ:</strong> ì¢‹ì•„í•˜ëŠ” ìŒì‹ ë¨¹ìœ¼ë©´ì„œ ì˜ê°ì„ ì–»ì–´ë³´ì„¸ìš”.'},
        'å‚·å®˜(Hurting Officer)': {r:3, l:'ğŸ¤ í‘œí˜„ë ¥ UP', d:'ë§ì´ ìˆ ìˆ  ë‚˜ì˜¤ëŠ” ë‚ ! í”„ë ˆì  í…Œì´ì…˜ì´ë‚˜ ë°œí‘œê°€ ìˆë‹¤ë©´ ì˜ ë  ê±°ì˜ˆìš”. ë‹¤ë§Œ ìœ—ì‚¬ëŒí•œí…Œ ëŒ€ë“¤ê³  ì‹¶ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë‹ˆ Caution!<br><br><strong>ğŸ’¡ íŒ:</strong> ë§í•˜ê¸° ì „ì— 3ì´ˆë§Œ ìƒê°í•˜ì„¸ìš”.'},
        'åè²¡(Indirect Wealth)': {r:4, l:'ğŸ’° ëœ»ë°–ì˜ í–‰ìš´', d:'ì˜ˆìƒ ëª» í•œ ëˆì´ ë“¤ì–´ì˜¤ê±°ë‚˜ ì¢‹ì€ ê¸°íšŒê°€ ìƒê¸¸ ìˆ˜ present!<br><br><strong>ğŸ’¡ íŒ:</strong> ì ê·¹ì ìœ¼ë¡œ ì›€ì§ì´ì„¸ìš”. ì§‘ì— ìˆìœ¼ë©´ ê¸°íšŒê°€ ì•ˆ ì™€ìš”!'},
        'æ­£è²¡(Direct Wealth)': {r:4, l:'ğŸ’µ ì•ˆì •ì ì¸ ë‚ ', d:'ëˆ ê´€ë ¨ ì¼ì´ ìˆœì¡°ë¡œì›Œìš”. ê³„ì•½ì´ë‚˜ ê±°ë˜ë„ ì¢‹ì•„ìš”.<br><br><strong>ğŸ’¡ íŒ:</strong> ì €ì¶• ì‹œì‘í•˜ê¸° ì¢‹ì€ ë‚ ì´ì—ìš”.'},
        'åå®˜(Seven Killings)': {r:2, l:'ğŸ˜° ê¸´ì¥ë˜ëŠ” ë‚ ', d:'ê°‘ìê¸° ì¼ì´ ìƒê¸°ê±°ë‚˜ ì••ë°•ì„ ë°›ì„ ìˆ˜ present. ì˜ˆìƒ ëª» í•œ ì—…ë¬´ê°€ ë–¨ì–´ì§ˆ ìˆ˜ present.<br><br><strong>ğŸ’¡ íŒ:</strong> ì»¨ë””ì…˜ ê´€ë¦¬ê°€ ì¤‘ìš”í•´ìš”. avoid overexertion.'},
        'æ­£å®˜(Direct Officer)': {r:5, l:'ğŸ† ì¸ì •ë°›ëŠ” ë‚ ', d:'ìµœê³ ì˜ ë‚ ! ë…¸ë ¥í•œ ê²Œ ì¸ì •ë°›ê±°ë‚˜ ì¹­ì°¬ì„ ë“¤ì„ ìˆ˜ present.<br><br><strong>ğŸ’¡ íŒ:</strong> ì¤‘ìš”í•œ ë¯¸íŒ…ì´ë‚˜ ì•½ì†ì€ ì˜¤ëŠ˜ ì¡ìœ¼ì„¸ìš”.'},
        'åå°(Indirect Seal)': {r:3, l:'ğŸ“š í˜¼ìë§Œì˜ ì‹œê°„', d:'ì‚¬ëŒ ë§ì€ ê³³ë³´ë‹¤ í˜¼ì ìˆê³  ì‹¶ì€ ë‚ . ê³µë¶€ë‚˜ ë…ì„œì— ë”±!<br><br><strong>ğŸ’¡ íŒ:</strong> ì¹´í˜ì—ì„œ í˜¼ì ì±… ì½ê¸° ì–´ë•Œìš”?'},
        'æ­£å°(Direct Seal)': {r:4, l:'ğŸ¤ ë„ì›€ë°›ëŠ” ë‚ ', d:'ëˆ„êµ°ê°€ì˜ ë„ì›€ì„ ë°›ê¸° ì¢‹ì€ ë‚ ! ëª¨ë¥´ëŠ” ê±° ìˆìœ¼ë©´ Waterì–´ë³´ì„¸ìš”.<br><br><strong>ğŸ’¡ íŒ:</strong> ê³„ì•½ì„œ, ì„œë¥˜ ì‘ì—…í•˜ê¸° ì¢‹ì•„ìš”.'}
    };
    
    const info = godMeaning[god.k] || {r:3, l:'â˜€ï¸ í‰ì˜¨í•œ ë‚ ', d:'íŠ¹ë³„í•œ ì¼ ì—†ì´ ë¬´ë‚œí•œ í•˜ë£¨ì˜ˆìš”.'};
    let bonus = '';
    if ([dp.s.e, dp.b.e].includes(gods.yong)) {
        info.r = Math.min(5, info.r + 1);
        bonus = '<div class="info-box good" style="margin-top:12px;"><p>âœ¨ <strong>ì˜¤ëŠ˜ í–‰ìš´ì˜ ê¸°ìš´ì´ ë“¤ì–´ì™€ìš”!</strong> í‰ì†Œë³´ë‹¤ ì¼ì´ ì˜ í’€ë¦´ ê±°ì˜ˆìš”!</p></div>';
    } else if ([dp.s.e, dp.b.e].includes(gods.gi)) {
        info.r = Math.max(1, info.r - 1);
        bonus = '<div class="info-box warn" style="margin-top:12px;"><p>âš ï¸ <strong>ì˜¤ëŠ˜ì€ ì¡°ì‹¬í•˜ëŠ” ê²Œ ì¢‹ì•„ìš”!</strong> í° ê²°ì •ì€ ë‚´ì¼ë¡œ ë¯¸ë£¨ì„¸ìš”.</p></div>';
    }
    
    // ì¢‹ì€ ì‹œê°„/ë‚˜ìœ ì‹œê°„
    const goodH = [], badH = [];
    const hourNames = ['ë°¤ 11ì‹œ~ìƒˆë²½ 1ì‹œ','ìƒˆë²½ 1~3ì‹œ','ìƒˆë²½ 3~5ì‹œ','ì•„ì¹¨ 5~7ì‹œ','ì•„ì¹¨ 7~9ì‹œ','ì˜¤ì „ 9~11ì‹œ','ë‚® 11ì‹œ~ì˜¤í›„ 1ì‹œ','ì˜¤í›„ 1~3ì‹œ','ì˜¤í›„ 3~5ì‹œ','ì €ë… 5~7ì‹œ','ì €ë… 7~9ì‹œ','ë°¤ 9~11ì‹œ'];
    for (let i = 0; i < 12; i++) {
        const hEl = BRANCH[i].e;
        if (hEl === gods.yong) goodH.push(hourNames[i]);
        else if (hEl === gods.gi) badH.push(hourNames[i]);
    }
    
    return `
        <div class="info-box gold">
            <p><strong>ğŸ“… ${tm}ì›” ${td}ì¼ Today's Fortune</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">ì˜¤ëŠ˜ì˜ ê¸°ìš´: ${dp.s.c}${dp.b.c} (${dp.b.m} ${dp.b.a}ì¼)</p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'â­'.repeat(info.r)}${'â˜†'.repeat(5-info.r)}</span>
        </div>
        <div class="info-box">
            <p><strong>${info.l}</strong></p>
            <p style="margin-top:10px;line-height:1.8;">${info.d}</p>
        </div>
        ${bonus}
        <div class="info-box good" style="margin-top:12px;">
            <p><strong>â° í–‰ìš´ì˜ ì‹œê°„</strong><br>${goodH.length ? goodH.join(', ') : 'íŠ¹ë³„íˆ absent'}</p>
        </div>
        <div class="info-box warn" style="margin-top:12px;">
            <p><strong>â° ì¡°ì‹¬í•  ì‹œê°„</strong><br>${badH.length ? badH.join(', ') : 'íŠ¹ë³„íˆ absent'}</p>
        </div>
        <div class="info-box" style="margin-top:12px;">
            <p><strong>ğŸ“Œ ì˜¤ëŠ˜ì˜ Energy: ${state.k}</strong><br>${state.d}</p>
        </div>`;
}

/* ========================================
   14-3. ìƒì„¸ í†µë³€ - ì—°ìš´
   ======================================== */
function genYearFortune(saju, gods, year) {
    const yp = calcYearPillar(year, 2, 5);
    const dm = saju.day.s;
    const god = getTenGod(yp.s, dm);
    const state = getTwelveState(dm, yp.b);
    
    let rating = 3, desc = '';
    if ([yp.s.e, yp.b.e].includes(gods.yong)) { rating = 5; desc = 'ìš©ì‹ ì´ ë“¤ì–´ì˜¤ëŠ” ëŒ€ê¸¸í•œ í•´! ì ê·¹ì ìœ¼ë¡œ ì›€ì§ì´ì„¸ìš”!'; }
    else if ([yp.s.e, yp.b.e].includes(gods.hee)) { rating = 4; desc = 'í¬ì‹ ì´ ë„ì™€ì£¼ëŠ” ì¢‹ì€ í•´! ìˆœíƒ„í•˜ê²Œ í’€ë ¤ìš”.'; }
    else if ([yp.s.e, yp.b.e].includes(gods.gi)) { rating = 2; desc = 'ê¸°ì‹ ì´ ë“¤ì–´ì˜¤ëŠ” ì¡°ì‹¬í•´ì•¼ í•  í•´. avoid overexertion.'; }
    else { desc = 'í‰íƒ„í•œ í•´ì˜ˆìš”. ê¾¸ì¤€íˆ ë…¸ë ¥í•˜ì„¸ìš”.'; }
    
    if (state.l >= 9) { rating = Math.min(5, rating + 1); desc += ' 12ìš´ì„±ì´ ê°•í•´ì„œ Energyê°€ ë„˜ì³ìš”!'; }
    else if (state.l <= 3) { rating = Math.max(1, rating - 1); desc += ' 12ìš´ì„±ì´ ì•½í•´ì„œ ì²´ë ¥ ê´€ë¦¬ê°€ is essential.'; }
    
    // ì›”ë³„ í¬ì¸íŠ¸
    const months = [];
    for (let m = 1; m <= 12; m++) {
        const mp = calcMonthPillar(year, m, 15);
        const mGod = getTenGod(mp.s, dm);
        let tip = '';
        if (['æ­£å®˜(Direct Officer)','æ­£è²¡(Direct Wealth)'].includes(mGod.k)) tip = 'ğŸŸ¢ ì¢‹ìŒ';
        else if (['åå®˜(Seven Killings)','åŠ«è²¡(Rob Wealth)'].includes(mGod.k)) tip = 'ğŸ”´ ì£¼ì˜';
        else tip = 'ğŸŸ¡ ë³´í†µ';
        months.push(`<span style="display:inline-block;margin:3px;padding:5px 8px;background:rgba(255,255,255,0.05);border-radius:5px;font-size:0.75rem;">${m}ì›” ${tip}</span>`);
    }
    
    return `
        <div class="info-box gold">
            <p><strong>ğŸ“† ${year}ë…„ ìš´ì„¸</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">${yp.s.c}${yp.b.c}ë…„ (${yp.b.m} ${yp.b.a}ì˜ í•´)</p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'â­'.repeat(rating)}${'â˜†'.repeat(5-rating)}</span>
        </div>
        <div class="info-box">
            <p><strong>ì˜¬í•´ì˜ ì‹­ì‹ : ${god.k}</strong></p>
            <p style="margin-top:10px;line-height:1.8;">${desc}</p>
        </div>
        <div class="info-box" style="margin-top:12px;">
            <p><strong>ğŸ“Œ ì˜¬í•´ì˜ Energy: ${state.k}</strong><br>${state.d}</p>
        </div>
        <div class="info-box" style="margin-top:12px;">
            <p><strong>ğŸ—“ï¸ ì›”ë³„ í¬ì¸íŠ¸</strong></p>
            <div style="margin-top:10px;">${months.join('')}</div>
        </div>`;
}

/* ========================================
   14-4. ìƒì„¸ í†µë³€ - ì§ì—…ìš´
   ======================================== */
function genCareerFortune(saju, str, gods) {
    const dm = saju.day.s;
    const ec = countElements(saju);
    const jaeEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5];
    const gwanEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 3) % 5];
    const sikEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5];
    
    let rating = 3, style = '', advice = '';
    
    if (str.type === 'strong' && ec[jaeEl] >= 2) {
        rating = 5; style = 'ì‚¬ì¥ë‹˜ ìŠ¤íƒ€ì¼';
        advice = 'Strongí•˜ê³  ì¬ì„±ì´ ë§ì•„ì„œ ì‚¬ì—…ê°€ ìì§ˆexists! ëˆì„ ë‹¤ë£¨ëŠ” ëŠ¥ë ¥ì´ ë›°ì–´ë‚˜ê³  ì§ì ‘ ì‚¬ì—…ì„ í•˜ë©´ í¬ê²Œ ì„±ê³µí•  ìˆ˜ present.';
    } else if (str.type === 'strong' && ec[gwanEl] >= 2) {
        rating = 4; style = 'ë†’ì€ ìë¦¬ ê°ˆ ìƒ';
        advice = 'Strongí•˜ê³  ê´€ì„±ì´ ë§ì•„ì„œ ì¡°ì§ì—ì„œ ì¶œì„¸í•´ìš”! ê³µë¬´ì›, ëŒ€ê¸°ì—…, ì •ì¹˜ ìª½ì—ì„œ ë†’ì€ ìë¦¬ê¹Œì§€ ì˜¬ë¼ê°ˆ ìˆ˜ present.';
    } else if (str.type === 'weak') {
        rating = 3; style = 'ì „ë¬¸ê°€ ìŠ¤íƒ€ì¼';
        advice = 'Weakí•´ì„œ í˜¼ìë³´ë‹¤ëŠ” íŒ€ì—ì„œ ì¼í•˜ëŠ” ê²Œ ì¢‹ì•„ìš”. ì „ë¬¸ ë¶„ì•¼ë¥¼ ê¹Šì´ íŒŒë©´ ì¸ì •ë°›ëŠ” ì „ë¬¸ê°€ê°€ ë  ìˆ˜ present.';
    } else {
        rating = 4; style = 'ë­ë“  ì˜í•˜ëŠ” ìŠ¤íƒ€ì¼';
        advice = 'Balancedë˜ì–´ ê· í˜• ì¡í˜”ì–´ìš”! ì–´ë–¤ ë¶„ì•¼ì—ì„œë“  ì˜ ì ì‘í•˜ê³  ì„±ê³¼ë¥¼ ë‚¼ ìˆ˜ present.';
    }
    
    // Eating God ì²´í¬
    if (ec[sikEl] >= 2) {
        advice += '<br><br>âœ¨ <strong>Eating Godì´ ë§ì•„ì„œ ì¬ëŠ¥ìœ¼ë¡œ ëˆ ë²„ëŠ” êµ¬ì¡°ì˜ˆìš”!</strong> ì˜ˆìˆ , ê¸°ìˆ , ì°½ì‘ ë¶„ì•¼ì—ì„œ ë¹›ì„ ë°œí•´ìš”.';
    }
    
    const careerByElement = {
        wood: 'êµìœ¡, ì¶œíŒ, ì˜ë¥˜, ê°€êµ¬, ì¡°ê²½, ë†ì—…, í•œì˜í•™',
        fire: 'ì—°ì˜ˆ, ë°©ì†¡, ì˜ˆìˆ , IT, ì „ê¸°, ì¡°ëª…, ìŒì‹',
        earth: 'ë¶€ë™ì‚°, ê±´ì¶•, ë†ì—…, ì¤‘ê°œ, ìœ í†µ, ì°½ê³ ì—…',
        metal: 'ê¸ˆìœµ, ì œì¡°, ìë™ì°¨, ê¸°ê³„, ì˜ë£Œê¸°ê¸°, ë²•ì¡°',
        water: 'ë¬´ì—­, ìœ í†µ, ê´€ê´‘, ì–´ì—…, ìŒë£Œ, Waterë¥˜, ì²­ì†Œ'
    };
    
    return `
        <div class="info-box gold">
            <p><strong>ğŸ’¼ ì§ì—…ìš´ ë¶„ì„</strong></p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'â­'.repeat(rating)}${'â˜†'.repeat(5-rating)}</span>
            <p style="margin-top:10px;font-size:1.1rem;color:var(--gold);">${style}</p>
        </div>
        <div class="info-box">
            <p style="line-height:1.8;">${advice}</p>
        </div>
        <div class="info-box good" style="margin-top:12px;">
            <p><strong>ğŸ¯ ìš©ì‹ (${ELEMENT[gods.yong].k}) ê´€ë ¨ ì§ì—…</strong></p>
            <p style="margin-top:8px;">${careerByElement[gods.yong]}</p>
        </div>`;
}

/* ========================================
   14-5. ìƒì„¸ í†µë³€ - ì—°ì• ìš´
   ======================================== */
function genLoveFortune(saju, str, gods) {
    const dm = saju.day.s;
    const dbi = BRANCH.indexOf(saju.day.b);
    const ec = countElements(saju);
    
    // ë°°ìš°ì ì˜¤í–‰ (ë‚¨ìëŠ” ì¬ì„±, ì—¬ìëŠ” ê´€ì„±)
    const spouseEl = GENDER === 'm' ? 
        EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5] : 
        EL_ORDER[(EL_ORDER.indexOf(dm.e) + 3) % 5];
    const spouseCount = ec[spouseEl];
    
    let rating = 3, desc = '';
    
    // ë°°ìš°ì ì˜¤í–‰ ê°œìˆ˜ë³„ í•´ì„
    if (spouseCount === 0) {
        rating = 2;
        desc = 'ë°°ìš°ì ìë¦¬ì— ê¸°ìš´ì´ ì•½í•´ìš”. ì¸ì—°ì´ ëŠ¦ê±°ë‚˜, ë§Œë‚˜ë„ ì˜¤ë˜ ëª» ê°€ëŠ” ê²½ìš°ê°€ ìˆì„ ìˆ˜ present. ë„ˆë¬´ ì¡°ê¸‰í•´í•˜ì§€ ë§ˆì„¸ìš”!';
    } else if (spouseCount === 1) {
        rating = 4;
        desc = 'ë°°ìš°ì ì¸ì—°ì´ ë”± í•˜ë‚˜! ê·¸ ì‚¬ëŒì´ ì§„ì§œ ì¸ì—°ì´ì—ìš”. ì†Œì¤‘íˆ ëŒ€í•˜ì„¸ìš”.';
    } else if (spouseCount === 2) {
        rating = 3;
        desc = 'ë°°ìš°ì ì¸ì—°ì´ ë‘ ê°œ... ì¬í˜¼Waterê°€ ìˆê±°ë‚˜, ë‘ ì‚¬ëŒ ì‚¬ì´ì—ì„œ ê³ ë¯¼í•  ìˆ˜ present.';
    } else {
        rating = 2;
        desc = 'ë°°ìš°ì ì¸ì—°ì´ ë§ì•„ìš”. ë°”ëŒê¸° ì¡°ì‹¬! Focus on one person.';
    }
    
    // Day Branchë¡œ ë³´ëŠ” ë°°ìš°ììƒ
    const spouseByBranch = {
        0: 'ë°°ìš°ìê°€ ë˜‘ë˜‘í•˜ê³  ëˆˆì¹˜ê°€ ë¹¨ë¼ìš”. ê³µë¶€ë„ ì˜í•˜ê³  ìƒê°ì´ ê¹Šì–´ìš”. ë‹¤ë§Œ ê±±ì •ì´ ë§ì„ ìˆ˜ present.',
        1: 'ë°°ìš°ìê°€ ì°©ì‹¤í•˜ê³  ì„±ì‹¤í•´ìš”. ì²œì²œíˆ ê¾¸ì¤€íˆ í•˜ëŠ” íƒ€ì…ì´ì—ìš”. ë¯¿ìŒì§í•´ìš”.',
        2: 'ë°°ìš°ìê°€ í™œë°œí•˜ê³  ë„ì „ì ì´ì—ìš”. í˜¸ê¸°ì‹¬ì´ ë§ê³  Energyê°€ ë„˜ì³ìš”!',
        3: 'ë°°ìš°ìê°€ ì˜ˆë¯¼í•˜ê³  ì„¬ì„¸í•´ìš”. ì˜ˆìˆ ì  ê°ê°ì´ ìˆê³  ì†ì¬ì£¼ë„ ì¢‹ì•„ìš”.',
        4: 'ë°°ìš°ìê°€ í¬ìš©ë ¥ ìˆê³  ì‚¬êµì ì´ì—ìš”. ì¹œêµ¬ê°€ ë§ê³  ë¦¬ë”ì‹­ë„ present.',
        5: 'ë°°ìš°ìê°€ ì˜ë¦¬í•˜ê³  ë§ì„ ì˜í•´ìš”. ëˆˆì¹˜ê°€ ë¹ ë¥´ê³  ì‚¬ëŒ ë‹¤ë£¨ëŠ” ì¬ì£¼is present.',
        6: 'ë°°ìš°ìê°€ ë°ê³  ì—´ì •ì ì´ì—ìš”. ì„±ê²©ì´ ê¸‰í•  ìˆ˜ ìˆì§€ë§Œ Energy ë„˜ì³ìš”!',
        7: 'ë°°ìš°ìê°€ ìˆœí•˜ê³  ì •ì´ ë§ì•„ìš”. ë°°ë ¤ì‹¬ ê¹Šê³  ì°©í•´ìš”.',
        8: 'ë°°ìš°ìê°€ ë˜‘ë¶€ëŸ¬ì§€ê³  ë‹¹ë‹¹í•´ìš”. ê²°ë‹¨ë ¥ ìˆê³  ë…ë¦½ì‹¬ì´ ê°•í•´ìš”.',
        9: 'ë°°ìš°ìê°€ ê¹”ë”í•˜ê³  ê°ê°ì ì´ì—ìš”. ì˜ˆìˆ ì´ë‚˜ ë¯¸ìš© ìª½ì— ì¬ëŠ¥ì´ ìˆì„ ìˆ˜ present.',
        10: 'ë°°ìš°ìê°€ ê³ ì§‘ ì„¸ì§€ë§Œ ì˜ë¦¬ present. í•œë²ˆ ì •í•˜ë©´ ëê¹Œì§€ í•´ìš”.',
        11: 'ë°°ìš°ìê°€ í˜„ëª…í•˜ê³  ì ì‘ë ¥ ì¢‹ì•„ìš”. ì–´ë””ì„œë“  ì˜ ì§€ë‚´ê³  ìœµí†µì„±exists.'
    };
    
    return `
        <div class="info-box gold">
            <p><strong>ğŸ’• ì—°ì• ìš´/ê²°í˜¼ìš´ ë¶„ì„</strong></p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'â­'.repeat(rating)}${'â˜†'.repeat(5-rating)}</span>
        </div>
        <div class="info-box">
            <p style="line-height:1.8;">${desc}</p>
        </div>
        <div class="info-box" style="margin-top:12px;background:rgba(255,182,193,0.15);">
            <p><strong>ğŸ’‘ Day Branchë¡œ ë³´ëŠ” ë°°ìš°ììƒ</strong></p>
            <p style="margin-top:10px;line-height:1.8;">${spouseByBranch[dbi]}</p>
        </div>`;
}

/* ========================================
   14-6. ìƒì„¸ í†µë³€ - ì¬Waterìš´
   ======================================== */
function genWealthFortune(saju, str, gods) {
    const dm = saju.day.s;
    const ec = countElements(saju);
    const jaeEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5];
    const sikEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5];
    const jaeCount = ec[jaeEl];
    const sikCount = ec[sikEl];
    
    let rating = 3, desc = '';
    
    if (str.type === 'strong' && jaeCount >= 2) {
        rating = 5;
        desc = 'ëˆ ë³µì´ ë§ì•„ìš”! Strongí•˜ë©´ì„œ ì¬ì„±ì´ ë§ìœ¼ë‹ˆ ëˆì„ ë²Œ ëŠ¥ë ¥ê³¼ ë³µì´ ëª¨ë‘ present. ì‚¬ì—…ì´ë‚˜ íˆ¬ìì—ì„œ í¬ê²Œ ì„±ê³µí•  ìˆ˜ present!';
    } else if (str.type === 'strong' && jaeCount === 1) {
        rating = 4;
        desc = 'ê¾¸ì¤€íˆ ë²„ëŠ” íƒ€ì…ì´ì—ìš”. í•œ ë²ˆì— í° ëˆë³´ë‹¤ ì›”ê¸‰ì²˜ëŸ¼ ì•ˆì •ì ì¸ Waterì…ì´ ì¢‹ì•„ìš”.';
    } else if (str.type === 'weak' && jaeCount >= 2) {
        rating = 2;
        desc = 'ëˆì´ ë“¤ì–´ì™€ë„ ë‚˜ê°€ê¸° ì‰¬ì›Œìš”. Weakí•œë° ì¬ì„±ì´ ë§ìœ¼ë©´ ê°ë‹¹ì´ ì•ˆ ë¼ìš”. ì €ì¶• ìŠµê´€ì„ ë“¤ì´ì„¸ìš”!';
    } else if (jaeCount === 0) {
        rating = 2;
        desc = 'ì¬ì„±is missing - ëˆì— ê´€ì‹¬ì´ ì ê±°ë‚˜, ëˆ ë²„ëŠ” ê²Œ í˜ë“¤ ìˆ˜ present. ì „ë¬¸ ê¸°ìˆ ì„ ìµíˆì„¸ìš”.';
    } else {
        rating = 3;
        desc = 'í‰ë²”í•œ ì¬Waterìš´ì´ì—ìš”. ê¾¸ì¤€íˆ ë…¸ë ¥í•˜ë©´ ì¤‘ì‚°ì¸µ ì´ìƒì˜ ì‚¶ì„ ì‚´ ìˆ˜ present.';
    }
    
    // Eating God ì²´í¬
    if (sikCount >= 2) {
        rating = Math.min(5, rating + 1);
        desc += '<br><br>âœ¨ <strong>Eating Godì´ ë§ì•„ì„œ ì¬ëŠ¥ìœ¼ë¡œ ëˆ ë²„ëŠ” êµ¬ì¡°!</strong> ê¸°ìˆ , ì˜ˆìˆ , ì°½ì‘ìœ¼ë¡œ ë¶€ì ë  ìˆ˜ present.';
    }
    
    return `
        <div class="info-box gold">
            <p><strong>ğŸ’° ì¬Waterìš´ ë¶„ì„</strong></p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'â­'.repeat(rating)}${'â˜†'.repeat(5-rating)}</span>
        </div>
        <div class="info-box">
            <p style="line-height:1.8;">${desc}</p>
        </div>
        <div class="info-box good" style="margin-top:12px;">
            <p><strong>ğŸ¯ ì¬Water ìš´ ì˜¬ë¦¬ëŠ” ë²•</strong></p>
            <p style="margin-top:8px;">ìš©ì‹ ì¸ <strong>${ELEMENT[gods.yong].k}</strong> ê¸°ìš´ì„ í™œìš©í•˜ì„¸ìš”!<br>í–‰ìš´ì˜ ìˆ«ì: ${ELEMENT[gods.yong].nums.slice(0,5).join(', ')}</p>
        </div>`;
}

/* ========================================
   14-7. ìƒì„¸ í†µë³€ - ê±´ê°•ìš´
   ======================================== */
function genHealthFortune(saju, str, gods) {
    const dm = saju.day.s;
    const ec = countElements(saju);
    
    const healthData = {
        wood: {o:'ê°„, ë‹´ë‚­, ëˆˆ', s:'í”¼ë¡œ, ì‹œë ¥ ì €í•˜, ê·¼ìœ¡ ê²½ë ¨, ì†í†± ê°ˆë¼ì§', a:'ë…¹ìƒ‰ ì±„ì†Œ ì„­ì·¨, ìŠ¤íŠ¸ë ˆì¹­, ëˆˆ íœ´ì‹'},
        fire: {o:'ì‹¬ì¥, ì†Œì¥, í˜€', s:'ê°€ìŠ´ ë‘ê·¼ê±°ë¦¼, Fireë©´ì¦, í˜€ ì—¼ì¦', a:'ê·œì¹™ì ì¸ Waterë©´, ëª…ìƒ, ë¶‰ì€ ìŒì‹'},
        earth: {o:'ìœ„ì¥, ë¹„ì¥, ì…ìˆ ', s:'ì†ŒFireFireëŸ‰, ë³µë¶€ íŒ½ë§Œ, ì…ìˆ  íŠ¸ëŠ” ê²ƒ', a:'ê·œì¹™ì ì¸ ì‹ì‚¬, ë…¸ë€ ìŒì‹, ê±·ê¸°'},
        metal: {o:'í, ëŒ€ì¥, ì½”', s:'í˜¸í¡ê¸° ì§ˆí™˜, í”¼ë¶€ íŠ¸ëŸ¬ë¸”, ë³€ë¹„', a:'ì‹¬í˜¸í¡, ë“±ì‚°, í°ìƒ‰ ìŒì‹, ìœ ì‚°ê· '},
        water: {o:'ì‹ ì¥, ë°©ê´‘, ê·€', s:'ë¶€ì¢…, ìš”í†µ, ìƒì‹ê¸° ë¬¸ì œ, ì²­ë ¥ ì €í•˜', a:'ì¶©ë¶„í•œ Waterë¶„, ê²€ì€ì½©, ë°˜ì‹ ìš•'}
    };
    
    const sorted = Object.entries(ec).sort((a,b) => a[1] - b[1]);
    const weakest = sorted[0];
    const strongest = Object.entries(ec).sort((a,b) => b[1] - a[1])[0];
    
    let rating = str.type === 'weak' ? 3 : 4;
    
    return `
        <div class="info-box gold">
            <p><strong>ğŸ¥ ê±´ê°•ìš´ ë¶„ì„</strong></p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'â­'.repeat(rating)}${'â˜†'.repeat(5-rating)}</span>
        </div>
        <div class="info-box">
            <p><strong>ì•½í•œ ì¥ê¸°:</strong> ${healthData[dm.e].o}</p>
            <p style="margin-top:10px;"><strong>ì£¼ì˜ ì¦ìƒ:</strong><br>${healthData[dm.e].s}</p>
            <p style="margin-top:10px;"><strong>ê±´ê°• ê´€ë¦¬ë²•:</strong><br>${healthData[dm.e].a}</p>
        </div>
        ${weakest[1] === 0 ? `<div class="info-box warn" style="margin-top:12px;"><p><strong>âš ï¸ ${ELEMENT[weakest[0]].k} ê¸°ìš´ì´ absent!</strong><br>${healthData[weakest[0]].o} ê´€ë ¨ ê±´ê°•ì— íŠ¹íˆ ì‹ ê²½ ì“°ì„¸ìš”!<br><br>${healthData[weakest[0]].a}</p></div>` : ''}
        ${strongest[1] >= 4 ? `<div class="info-box" style="margin-top:12px;"><p><strong>ğŸ“Œ ${ELEMENT[strongest[0]].k} ê¸°ìš´ì´ ë„ˆë¬´ ë§ì•„ìš”</strong><br>${healthData[strongest[0]].o} ê´€ë ¨ ì¥ê¸°ì— ë¬´ë¦¬ ê°ˆ ìˆ˜ present. ê· í˜•ì´ ì¤‘ìš”í•´ìš”!</p></div>` : ''}
        <div class="info-box good" style="margin-top:12px;">
            <p><strong>ğŸ—“ï¸ ê³„ì ˆë³„ ê±´ê°• ê´€ë¦¬</strong></p>
            <p style="margin-top:8px;line-height:1.8;">
                â€¢ ë´„: ê°„, ëˆˆ ê´€ë¦¬ / ìŠ¤íŠ¸ë ˆì¹­<br>
                â€¢ ì—¬ë¦„: ì‹¬ì¥, í˜ˆê´€ / Water ë§ì´ ë§ˆì‹œê¸°<br>
                â€¢ í™˜ì ˆê¸°: ì†ŒFireê¸° / ê·œì¹™ì ì¸ ì‹ì‚¬<br>
                â€¢ ê°€ì„: í, í˜¸í¡ê¸° / ë“±ì‚°, ì‹¬í˜¸í¡<br>
                â€¢ ê²¨ìš¸: ì‹ ì¥, ë¼ˆ / ë³´ì˜¨, ë°˜ì‹ ìš•
            </p>
        </div>`;
}

/* ========================================
   14-8. ê¶í•© ë¶„ì„
   ======================================== */
function runMatch() {
    if (!SAJU) { toast('ë¨¼ì € ë‚´ ì‚¬ì£¼ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”!'); return; }
    
    const py = +document.getElementById('partner-year').value;
    const pm = +document.getElementById('partner-month').value;
    const pd = +document.getElementById('partner-day').value;
    
    if (!py || !pm || !pd) { toast('ìƒëŒ€ë°© Please enter your birth date'); return; }
    
    const pSaju = {
        year: calcYearPillar(py, pm, pd),
        month: calcMonthPillar(py, pm, pd),
        day: calcDayPillar(py, pm, pd)
    };
    
    let score = 50, details = [];
    
    // 1. æ—¥ä¸»(Day Master) ê¶í•© (ì²œê°„ í•©)
    const myDm = STEM.indexOf(SAJU.day.s), pDm = STEM.indexOf(pSaju.day.s);
    const ganHap = [[0,5],[1,6],[2,7],[3,8],[4,9]];
    let ganMatch = false;
    for (let [a,b] of ganHap) if ((myDm===a && pDm===b) || (myDm===b && pDm===a)) { ganMatch = true; break; }
    if (ganMatch) { score += 20; details.push({t:'good', txt:'ğŸ’• ì²œê°„í•©! ë‘ ì‚¬ëŒì˜ æ—¥ä¸»(Day Master)ì´ ì²œìƒì—°ë¶„ì´ì—ìš”!'}); }
    
    // 2. Day Branch ê¶í•© (ì§€ì§€ í•©/ì¶©)
    const myDb = BRANCH.indexOf(SAJU.day.b), pDb = BRANCH.indexOf(pSaju.day.b);
    const jiHap = [[0,1],[2,11],[3,10],[4,9],[5,8],[6,7]];
    const jiChung = [[0,6],[1,7],[2,8],[3,9],[4,10],[5,11]];
    for (let [a,b] of jiHap) if ((myDb===a && pDb===b) || (myDb===b && pDb===a)) { score += 15; details.push({t:'good', txt:'ğŸ¤ Day Branch Six Harmony! í•¨ê»˜ ìˆìœ¼ë©´ í¸ì•ˆí•˜ê³  ì•ˆì •ê°ì„ ëŠê»´ìš”.'}); break; }
    for (let [a,b] of jiChung) if ((myDb===a && pDb===b) || (myDb===b && pDb===a)) { score -= 15; details.push({t:'bad', txt:'ğŸ’¥ Day Branch ì¶©! ì„œë¡œ ë¶€ë”ªíˆê¸° ì‰¬ì›Œìš”. Compromise is essential.'}); break; }
    
    // 3. ì˜¤í–‰ ìƒìƒ/ìƒê·¹
    const myEl = EL_ORDER.indexOf(SAJU.day.s.e), pEl = EL_ORDER.indexOf(pSaju.day.s.e);
    const saeng = [[0,2],[2,1],[1,3],[3,4],[4,0]];
    const keuk = [[0,3],[3,1],[1,4],[4,2],[2,0]];
    for (let [a,b] of saeng) if ((myEl===a && pEl===b) || (myEl===b && pEl===a)) { score += 10; details.push({t:'good', txt:`ğŸŒ± ì˜¤í–‰ ìƒìƒ! ${ELEMENT[SAJU.day.s.e].k}ê³¼ ${ELEMENT[pSaju.day.s.e].k}ì´ ì„œë¡œ ë„ì™€ì£¼ëŠ” ê´€ê³„ì˜ˆìš”.`}); break; }
    for (let [a,b] of keuk) if ((myEl===a && pEl===b) || (myEl===b && pEl===a)) { score -= 10; details.push({t:'bad', txt:`âš”ï¸ ì˜¤í–‰ ìƒê·¹! Effort to harmonize is essential.`}); break; }
    if (SAJU.day.s.e === pSaju.day.s.e) { score += 5; details.push({t:'neutral', txt:`ğŸ”„ ê°™ì€ ${ELEMENT[SAJU.day.s.e].k} ì˜¤í–‰! ë¹„ìŠ·í•œ ì„±í–¥ì´ë¼ í†µí•´ìš”.`}); }
    
    // 4. ë  ê¶Harmony
    const myTti = BRANCH.indexOf(SAJU.year.b), pTti = BRANCH.indexOf(pSaju.year.b);
    for (let [a,b] of jiHap) if ((myTti===a && pTti===b) || (myTti===b && pTti===a)) { score += 5; details.push({t:'good', txt:`ğŸ¾ ë  Six Harmony! ${BRANCH[myTti].a}ë ì™€ ${BRANCH[pTti].a}ë ëŠ” ì˜ ë§ì•„ìš”.`}); break; }
    for (let [a,b] of jiChung) if ((myTti===a && pTti===b) || (myTti===b && pTti===a)) { score -= 5; details.push({t:'bad', txt:`ğŸ¾ ë  ì¶©! ${BRANCH[myTti].a}ë ì™€ ${BRANCH[pTti].a}ë ëŠ” ë¶€ë”ªí ìˆ˜ present.`}); break; }
    
    score = Math.max(0, Math.min(100, score));
    
    let grade, color, summary;
    if (score >= 80) { grade = 'ğŸ’– ì²œìƒì—°ë¶„'; color = '#e91e63'; summary = 'ë‘ ë¶„ì€ ì •ë§ ì˜ ë§ì•„ìš”! ìµœê³ ì˜ ê¶í•©ì´ì—ìš”.'; }
    else if (score >= 65) { grade = 'ğŸ’• ì¢‹ì€ ê¶í•©'; color = '#9c27b0'; summary = 'ì˜ ë§ëŠ” í¸ì´ì—ìš”! ì•½ê°„ì˜ ë…¸ë ¥ë§Œ ìˆìœ¼ë©´ í–‰ë³µí•´ìš”.'; }
    else if (score >= 50) { grade = 'ğŸ’› ë³´í†µ ê¶í•©'; color = '#ff9800'; summary = 'í‰ë²”í•œ ê¶í•©ì´ì—ìš”. ì„œë¡œ ë‹¤ë¥¸ ì ì„ ì¸ì •í•˜ë©´ ì¢‹ì•„ì ¸ìš”.'; }
    else if (score >= 35) { grade = 'ğŸ’” ë…¸ë ¥ í•„ìš”'; color = '#ff5722'; summary = 'ë¶€ë”ªíˆëŠ” ë¶€ë¶„exists. ì–‘ë³´ì™€ ì´í•´ê°€ ë§ì´ is essential.'; }
    else { grade = 'ğŸ˜¢ ìƒê·¹ ê¶í•©'; color = '#f44336'; summary = 'ì‰½ì§€ ì•Šì€ ê¶í•©ì´ì—ìš”. í•˜ì§€ë§Œ ì‚¬ë‘ìœ¼ë¡œ ê·¹ë³µ ê°€ëŠ¥í•´ìš”!'; }
    
    document.getElementById('match-result').innerHTML = `
        <div class="info-box" style="text-align:center;">
            <p style="font-size:2rem;color:${color}">${grade}</p>
            <p style="font-size:1.5rem;font-weight:bold;margin-top:10px;">${score}ì </p>
            <div style="background:#333;border-radius:10px;height:20px;margin:15px 0;">
                <div style="background:linear-gradient(90deg,#ff6b6b,#ee5a24);height:100%;border-radius:10px;width:${score}%"></div>
            </div>
            <p>${summary}</p>
        </div>
        <div class="info-box" style="margin-top:15px;">
            <p><strong>ğŸ“Š ìƒì„¸ ë¶„ì„</strong></p>
            <p style="margin-top:8px;"><strong>ë‚˜:</strong> ${SAJU.day.s.c}${SAJU.day.b.c}Day (${ELEMENT[SAJU.day.s.e].k})</p>
            <p><strong>ìƒëŒ€:</strong> ${pSaju.day.s.c}${pSaju.day.b.c}Day (${ELEMENT[pSaju.day.s.e].k})</p>
        </div>
        ${details.map(d => `<div class="info-box ${d.t === 'good' ? 'good' : d.t === 'bad' ? 'warn' : ''}" style="margin-top:10px;"><p>${d.txt}</p></div>`).join('')}
        <div class="info-box" style="margin-top:15px;">
            <p><strong>ğŸ’¡ ê¶í•© íŒ</strong></p>
            <p style="margin-top:8px;">${score >= 65 ? 'ì„œë¡œì˜ ì¥ì ì„ ì¹­ì°¬í•´ì£¼ì„¸ìš”!' : score >= 50 ? 'ì„œë¡œ ë‹¤ë¥¸ ì ì„ ì¸ì •í•˜ê³  ì¡´ì¤‘í•˜ì„¸ìš”.' : 'ëŒ€Fireë¥¼ ë§ì´ í•˜ì„¸ìš”. ì„œë¡œì˜ ê³µê°„ë„ ì¡´ì¤‘í•´ì£¼ì„¸ìš”.'}</p>
        </div>`;
}

/* ========================================
   15. ì‚¬ì£¼ ë¶„ì„ ì‹¤í–‰
   ======================================== */
function analyzeSaju() {
    try {
        const y = +document.getElementById('saju-year').value;
        const m = +document.getElementById('saju-month').value;
        const d = +document.getElementById('saju-day').value;
        const h = document.getElementById('saju-hour').value;
        const hourVal = h === '' ? -1 : +h;
        
        // ì…ë ¥ê°’ ê²€ì¦
        if (!y || !m || !d) { toast('Please enter your birth date'); return; }
        if (y < 1900 || y > 2100) { toast('Year must be between 1900-2100'); return; }
        if (m < 1 || m > 12) { toast('Month must be between 1-12'); return; }
        if (d < 1 || d > 31) { toast('Day must be between 1-31'); return; }
        
        let sy = y, sm = m, sd = d;
        if (CALENDAR === 'lunar') {
            const conv = lunarToSolar(y, m, d);
            if (!conv || !conv.year) { toast('Lunar conversion error. Try solar calendar'); return; }
            sy = conv.year; sm = conv.month; sd = conv.day;
        }
        
        const adj = adjustTime(sy, sm, sd, hourVal);
        if (!adj || !adj.y) { toast('Time adjustment error'); return; }
        
        SAJU = {
            year: calcYearPillar(adj.y, adj.m, adj.d),
            month: calcMonthPillar(adj.y, adj.m, adj.d),
            day: calcDayPillar(adj.y, adj.m, adj.d),
            hour: hourVal >= 0 ? calcHourPillar(calcDayPillar(adj.y, adj.m, adj.d).s, adj.h) : null
        };
        
        // ì‚¬ì£¼ ê³„ì‚° ê²°ê³¼ ê²€ì¦
        if (!SAJU.year || !SAJU.month || !SAJU.day) { 
            toast('Four Pillars calculation error. Please try again'); 
            return; 
        }
        
        BIRTH_YEAR = y;
        const str = calcStrength(SAJU);
        if (!str) { toast('Strength calculation error'); return; }
        
        GODS = calcGods(SAJU, str);
        if (!GODS) { toast('Beneficial element calculation error'); return; }
        
        renderSaju(str);
        document.getElementById('saju-result').style.display = 'block';
        
        // my-info-displayê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
        const infoDisplay = document.getElementById('my-info-display');
        if (infoDisplay) {
            infoDisplay.innerHTML = `<p style="color:var(--gold);">${SAJU.day.s.c}${SAJU.day.b.c}Day (${ELEMENT[SAJU.day.s.e].k})</p>`;
        }
        
        toast('ğŸ”® Fortune analysis complete!');
    } catch (error) {
        console.error('Four Pillars analysis error:', error);
        toast('Analysis error. Please check your input.');
    }
}

/* ========================================
   16. ë Œë”ë§ í•¨ìˆ˜ë“¤
   ======================================== */
function renderSaju(str) {
    try {
    // ì‚¬ì£¼ ê¸°ë‘¥
    const pillars = ['hour','day','month','year'];
    const labels = ['Hour','Day','Month','Year'];
    document.getElementById('pillars').innerHTML = pillars.map((p, i) => {
        const pillar = SAJU[p];
        if (!pillar) return `<div class="pillar"><div class="pillar-label">${labels[i]}</div><div class="pillar-stem">-</div><div class="pillar-branch">-</div></div>`;
        const god = p !== 'day' ? getTenGod(pillar.s, SAJU.day.s) : null;
        return `<div class="pillar ${p === 'day' ? 'dm' : ''}">
            <div class="pillar-label">${labels[i]}</div>
            <div class="pillar-stem el-${pillar.s.e}">${pillar.s.c}</div>
            <div class="pillar-branch el-${pillar.b.e}">${pillar.b.c}</div>
            <div class="pillar-sub">${pillar.s.k}${pillar.b.k}</div>
            ${god ? `<div class="pillar-god">${god.k}</div>` : '<div class="pillar-god">æ—¥ä¸»(Day Master)</div>'}
        </div>`;
    }).join('');
    
    // 12ìš´ì„±
    const un12 = getTwelveState(SAJU.day.s, SAJU.day.b);
    document.getElementById('twelve-states').innerHTML = `<div class="info-box"><p><strong>Day Branch Twelve State:</strong> ${un12.k} (Energy ${un12.l}/12)</p></div>`;
    
    // Strong/Weak
    const typeLabel = {strong:'Strong',weak:'Weak',balanced:'Balanced'};
    document.getElementById('strength-box').innerHTML = `
        <div class="strength-header">
            <span class="strength-title">æ—¥ä¸»(Day Master) Strength</span>
            <span class="strength-badge ${str.type}">${typeLabel[str.type]}${str.extreme ? ` (${str.extreme})` : ''}</span>
        </div>
        <div class="strength-bar"><div class="strength-fill ${str.type}" style="width:${str.pct}%"></div></div>
        <div class="factors">${str.factors.map(f => `<div class="factor"><span class="factor-label">${f.l}</span><span class="factor-value ${f.p ? 'pos' : 'neg'}">${f.v}</span></div>`).join('')}</div>
    `;
    
    // ========== ç´éŸ³(Sound Element)/å‘½å®®(Life Palace)/Conception (NEW) ==========
    const dayNapeum = calcNapeum(SAJU.day.s, SAJU.day.b);
    const yearNapeum = calcNapeum(SAJU.year.s, SAJU.year.b);
    const myunggung = SAJU.hour ? calcMyunggung(SAJU.month.b, SAJU.hour.b) : null;
    const taewon = calcTaewon(SAJU.year.s, SAJU.month.s, SAJU.month.b);
    
    document.getElementById('napeum-myunggung').innerHTML = `
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>ğŸµ Sound-Element (Nap-eum)</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">Sound elements based on the 60 Sexagenary cycle</p>
            <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
                    <p style="font-size:0.8rem;color:var(--gray);">Day ë‚©ìŒ</p>
                    <p style="font-weight:bold;margin-top:5px;color:var(--gold);">${SAJU.day.s.c}${SAJU.day.b.c} â†’ ${dayNapeum.name}</p>
                    <p style="font-size:0.85rem;margin-top:5px;">${dayNapeum.desc}</p>
                </div>
                <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
                    <p style="font-size:0.8rem;color:var(--gray);">Year ë‚©ìŒ</p>
                    <p style="font-weight:bold;margin-top:5px;">${SAJU.year.s.c}${SAJU.year.b.c} â†’ ${yearNapeum.name}</p>
                    <p style="font-size:0.85rem;margin-top:5px;">${yearNapeum.desc}</p>
                </div>
            </div>
        </div>
        
        ${myunggung ? `
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>ğŸ  å‘½å®®(Life Palace) (Myung-gung)</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">Month Branch+Hour Branchë¡œ ê³„ì‚°í•œ ì¸ìƒì˜ ë°©í–¥</p>
            <div style="margin-top:12px;padding:15px;background:rgba(253,216,53,0.1);border-radius:8px;border-left:3px solid var(--gold);">
                <p style="font-weight:bold;font-size:1.1rem;color:var(--gold);">${myunggung.name} (${myunggung.branch.c}${myunggung.branch.k})</p>
                <p style="margin-top:8px;"><strong>Tendency:</strong> ${myunggung.trait}</p>
                <p style="margin-top:5px;"><strong>Suitable fields:</strong> ${myunggung.career}</p>
            </div>
        </div>
        ` : '<div class="info-box" style="margin-bottom:10px;"><p><strong>ğŸ  å‘½å®®(Life Palace) (Myung-gung)</strong></p><p style="color:var(--gray);margin-top:5px;">Birth hour required to calculate å‘½å®®(Life Palace).</p></div>'}
        
        <div class="info-box">
            <p><strong>ğŸŒ± íƒœì›(èƒå…ƒ)</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">Conception point stem-branch (Month stem+1, Month branch+3)</p>
            <div style="margin-top:12px;padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;">
                <p style="font-weight:bold;font-size:1.1rem;">${taewon.pillar} (${taewon.stem.k}${taewon.branch.k})</p>
                <p style="margin-top:8px;">ç´éŸ³(Sound Element): ${taewon.napeum.name} (${taewon.napeum.elementK})</p>
                <p style="margin-top:5px;font-size:0.9rem;color:var(--gray);">${taewon.desc}</p>
            </div>
        </div>
    `;
    
    // ========== æ”¯è—å¹²(Hidden Stems) ë¶„ì„ (NEW) ==========
    const jjAnalysis = analyzeJijanggan(SAJU);
    document.getElementById('jijanggan-analysis').innerHTML = `
        <div class="info-box">
            <p style="margin-bottom:10px;font-size:0.85rem;color:var(--gray);">Analyzing the hidden å¤©å¹²(Heavenly Stems) within åœ°æ”¯(Earthly Branches)</p>
            ${jjAnalysis.pillars.map(p => `
                <div style="margin-bottom:15px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;">
                    <p style="font-weight:bold;color:var(--gold);">${p.name}: ${p.branch.c}(${p.branch.k})</p>
                    <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;">
                        ${p.hidden.map(h => `
                            <span style="padding:4px 10px;border-radius:15px;font-size:0.8rem;
                                background:${h.type === 'Main' ? 'rgba(76,175,80,0.3)' : h.type === 'Middle' ? 'rgba(255,152,0,0.3)' : 'rgba(158,158,158,0.3)'};
                                border:1px solid ${h.type === 'Main' ? 'var(--wood)' : h.type === 'Middle' ? 'var(--earth)' : 'var(--metal)'};">
                                ${h.stem.c}(${h.stem.k}) Â· ${h.type} Â· ${h.days}ì¼ Â· ${h.god.k}
                                ${h.tougan ? '<span style="color:var(--gold);">â˜…íˆ¬ê°„</span>' : ''}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `).join('')}
        </div>
        <div class="info-box" style="margin-top:10px;">
            <p><strong>ğŸ“Š æ”¯è—å¹²(Hidden Stems) Element Distribution</strong></p>
            <div style="margin-top:10px;display:flex;justify-content:space-around;">
                ${EL_ORDER.map(e => `
                    <div style="text-align:center;">
                        <div class="el-${e}" style="font-size:1.2rem;">${ELEMENT[e].c}</div>
                        <div style="font-size:0.9rem;margin-top:3px;">${jjAnalysis.summary.elements[e].toFixed(1)}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // ========== í†µê·¼/íˆ¬ê°„ ë¶„ì„ (NEW) ==========
    const ttAnalysis = analyzeTonggeunTougan(SAJU);
    document.getElementById('tonggeun-analysis').innerHTML = `
        <div class="info-box">
            <p><strong>ğŸŒ³ Root Connection (Tong-geun)</strong> - å¤©å¹²(Heavenly Stems) rooted in åœ°æ”¯(Earthly Branches)</p>
            <div style="margin-top:10px;">
                ${ttAnalysis.tonggeun.length ? ttAnalysis.tonggeun.map(t => `
                    <div style="padding:8px;margin:5px 0;background:rgba(76,175,80,0.1);border-radius:6px;border-left:3px solid var(--wood);">
                        <span style="font-weight:bold;">${t.pillar} ${t.stem}</span> (${t.god}) â†’
                        ${t.roots.map(r => `<span style="margin-left:5px;padding:2px 6px;background:rgba(255,255,255,0.1);border-radius:4px;font-size:0.8rem;">${r.pillar}${r.branch} ${r.type}(${r.strength})</span>`).join('')}
                    </div>
                `).join('') : '<p style="color:var(--gray);font-size:0.9rem;">No rooted stems. Weak foundation.</p>'}
            </div>
        </div>
        <div class="info-box" style="margin-top:10px;">
            <p><strong>â˜€ï¸ Stem Emergence (Tu-gan)</strong> - æ”¯è—å¹²(Hidden Stems) revealed in å¤©å¹²(Heavenly Stems)</p>
            <div style="margin-top:10px;">
                ${ttAnalysis.tougan.length ? ttAnalysis.tougan.map(t => `
                    <div style="padding:8px;margin:5px 0;background:rgba(253,216,53,0.1);border-radius:6px;border-left:3px solid var(--gold);">
                        <span style="font-weight:bold;">${t.stem}</span> (${t.god}) - ${t.pillar}ì—ì„œ ${t.from}energy manifests
                    </div>
                `).join('') : '<p style="color:var(--gray);font-size:0.9rem;">No revealed hidden stems.</p>'}
            </div>
        </div>
    `;
    
    // ìš©ì‹ 
    document.getElementById('gods').innerHTML = `
        <div class="god yong"><div class="god-title">Beneficial God (Yong-sin)</div><div class="god-element el-${GODS.yong}">${ELEMENT[GODS.yong].c}</div><div class="god-name">${ELEMENT[GODS.yong].k} - ${ELEMENT[GODS.yong].n}</div></div>
        <div class="god hee"><div class="god-title">Favorable God (Hee-sin)</div><div class="god-element el-${GODS.hee}">${ELEMENT[GODS.hee].c}</div><div class="god-name">${ELEMENT[GODS.hee].k} - ${ELEMENT[GODS.hee].n}</div></div>
        <div class="god gi"><div class="god-title">Unfavorable God (Gi-sin)</div><div class="god-element el-${GODS.gi}">${ELEMENT[GODS.gi].c}</div><div class="god-name">${ELEMENT[GODS.gi].k} - ${ELEMENT[GODS.gi].n}</div></div>
    `;
    
    // ìš©ì‹  ìƒì„¸ + ì¡°í›„ ê³ ê¸‰
    let godsDetailHtml = `<div class="info-box gold"><p>${ELEMENT[GODS.yong].n} ê¸°ìš´ì´ ë‹¹ì‹ ì—ê²Œ í–‰ìš´ì„ ê°€ì ¸ë‹¤ì¤ë‹ˆë‹¤.</p></div>`;
    
    // ì¡°í›„ ìƒì„¸
    if (GODS.johu) {
        godsDetailHtml += `
            <div class="info-box" style="margin-top:10px;">
                <p><strong>ğŸŒ¡ï¸ Climate Adjustment Analysis</strong></p>
                <p style="margin-top:8px;font-size:0.9rem;">${GODS.johuDesc || 'ê³„ì ˆì— ë§ëŠ” ì¡°í›„ìš©ì‹ ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.'}</p>
                ${GODS.sub ? `<p style="margin-top:5px;font-size:0.85rem;color:var(--gray);">Secondary beneficial: ${ELEMENT[GODS.sub].k}(${ELEMENT[GODS.sub].c})</p>` : ''}
            </div>
        `;
    }
    
    // í•œë‚œdamp balance
    if (GODS.climate) {
        godsDetailHtml += `
            <div class="info-box ${GODS.climate.needs.length ? 'warn' : ''}" style="margin-top:10px;">
                <p><strong>ğŸŒ¡ï¸ Temperature-Humidity Balance: ${GODS.climate.type}</strong></p>
                <p style="margin-top:8px;font-size:0.9rem;">${GODS.climate.desc}</p>
                ${GODS.climate.needs.length ? `<p style="margin-top:5px;font-size:0.85rem;">Needed energy: ${GODS.climate.needs.map(e => ELEMENT[e].k).join(', ')}</p>` : ''}
            </div>
        `;
    }
    
    // ë³‘ì•½
    if (GODS.byungYak && GODS.byungYak.byung) {
        godsDetailHtml += `
            <div class="info-box" style="margin-top:10px;">
                <p><strong>ğŸ’Š ë³‘ì•½(ç—…è—¥) ë¶„ì„</strong></p>
                <p style="margin-top:8px;font-size:0.9rem;">
                    ë³‘(ç—…): ${ELEMENT[GODS.byungYak.byung].k}(${ELEMENT[GODS.byungYak.byung].c}) ê³¼ë‹¤<br>
                    ì•½(è—¥): ${ELEMENT[GODS.byungYak.yak].k}(${ELEMENT[GODS.byungYak.yak].c})ìœ¼ë¡œ ì œì–´
                </p>
            </div>
        `;
    }
    
    document.getElementById('gods-detail').innerHTML = godsDetailHtml;
    
    // ========== å…­è¦ª(Six Relations) Analysis (NEW) ==========
    const yukcheon = analyzeYukcheon(SAJU, GENDER);
    document.getElementById('yukcheon-analysis').innerHTML = `
        <div class="info-box" style="margin-bottom:10px;">
            <p style="font-size:0.85rem;color:var(--gray);">Analyzing family and relationships through the åç¥(Ten Gods)</p>
        </div>
        
        <!-- ìœ„ì¹˜ë³„ ìœ¡ì¹œ -->
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px;">
            ${yukcheon.positions.map(p => `
                <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
                    <p style="font-size:0.8rem;color:var(--gray);">${p.posName}</p>
                    <p style="font-weight:bold;margin:5px 0;">${p.stem.c}${p.branch.c}</p>
                    <p style="font-size:0.9rem;">Stem: <span style="color:var(--gold);">${p.stemGod}</span></p>
                    ${p.branchGod ? `<p style="font-size:0.85rem;color:var(--gray);">Branch: ${p.branchGod}</p>` : ''}
                    <p style="font-size:0.8rem;margin-top:5px;">${p.relation}</p>
                </div>
            `).join('')}
        </div>
        
        <!-- Spouse Analysis -->
        <div class="info-box ${yukcheon.spouse.count > 0 ? 'good' : 'warn'}" style="margin-bottom:10px;">
            <p><strong>ğŸ’• Spouse Analysis</strong></p>
            <p style="margin-top:8px;font-size:0.9rem;">
                Spouse star (${yukcheon.spouse.god}): ${yukcheon.spouse.count > 0 ? yukcheon.spouse.count + 'ê°œ' : 'none'}<br>
                Day Branch Twelve State: ${yukcheon.spouse.dayBranch.k}
            </p>
            <p style="margin-top:5px;font-size:0.85rem;">${yukcheon.spouse.analysis}</p>
        </div>
        
        <!-- Children Analysis -->
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>ğŸ‘¶ Children Analysis</strong></p>
            <p style="margin-top:8px;font-size:0.9rem;">
                Children star (${yukcheon.children.gods.join('/')}): ${yukcheon.children.count > 0 ? yukcheon.children.count.toFixed(1) + 'ê°œ' : 'none'}
            </p>
            <p style="margin-top:5px;font-size:0.85rem;">${yukcheon.children.analysis}</p>
        </div>
        
        <!-- Parents Analysis -->
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parents Analysis</strong></p>
            <p style="margin-top:8px;font-size:0.9rem;">
                Father (åè²¡/Indirect Wealth): ${yukcheon.parents.father.count > 0 ? 'present' : 'none'} - ${yukcheon.parents.father.analysis}<br>
                Mother (æ­£å°/Direct Seal): ${yukcheon.parents.mother.count > 0 ? 'present' : 'none'} - ${yukcheon.parents.mother.analysis}
            </p>
        </div>
        
        <!-- å…­è¦ª(Six Relations) Special Notes -->
        ${yukcheon.analysis.length ? `
            <div class="info-box warn">
                <p><strong>ğŸ“Œ å…­è¦ª(Six Relations) Special Notes</strong></p>
                ${yukcheon.analysis.slice(0, 5).map(a => `
                    <p style="margin-top:8px;font-size:0.85rem;">
                        ${a.type === 'many' ? 'âš¡' : 'â­•'} ${a.meaning}
                    </p>
                `).join('')}
            </div>
        ` : ''}
    `;
    
    // ê²©êµ­
    const fmt = calcFormat(SAJU);
    document.getElementById('format').innerHTML = `
        <div class="info-box gold">
            <p><strong>${fmt.n}</strong></p>
            <p style="margin-top:10px;line-height:1.8;">${fmt.d}</p>
            <p style="margin-top:10px;color:var(--gold);">ğŸ’¼ <strong>Suitable fields:</strong> ${fmt.b}</p>
        </div>`;
    
    // Dayë¡ 
    const ilju = getIljuDesc(SAJU.day.s, SAJU.day.b);
    document.getElementById('ilju').innerHTML = `
        <div class="info-box">
            <p><strong style="font-size:16px;">${ilju.title}</strong></p>
            <p style="margin-top:12px;line-height:1.8;">${ilju.desc}</p>
            <div style="margin-top:15px;padding:12px;background:rgba(255,182,193,0.15);border-radius:8px;">
                <p>ğŸ’• <strong>Spouse Fortune</strong></p>
                <p style="margin-top:8px;line-height:1.6;">${ilju.spouse}</p>
            </div>
        </div>`;
    
    // ========== ê¶ìœ„(å®®ä½) ë¶„ì„ (NEW) ==========
    const gungwi = analyzeGungwi(SAJU, BIRTH_YEAR);
    document.getElementById('gungwi-analysis').innerHTML = `
        <div class="info-box" style="margin-bottom:10px;">
            <p style="font-size:0.85rem;color:var(--gray);">The Four Pillars represent different life periods and relationships</p>
        </div>
        ${gungwi.map(g => `
            <div class="info-box ${g.rating === 'good' ? 'good' : g.rating === 'bad' ? 'warn' : ''}" style="margin-bottom:10px;${g.isCurrent ? 'border:2px solid var(--gold);' : ''}">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <p><strong>${g.name}</strong> <span style="color:var(--gray);font-size:0.85rem;">${g.alias}</span></p>
                    ${g.isCurrent ? '<span style="background:var(--gold);color:#000;padding:2px 8px;border-radius:10px;font-size:0.7rem;">Current</span>' : ''}
                </div>
                <p style="margin-top:8px;font-size:0.85rem;">
                    ğŸ“… <strong>${g.ageRange}</strong> Â· 
                    ${g.pillar ? `${g.pillar.s.c}${g.pillar.b.c}` : '-'} Â· 
                    ${g.god ? g.god.k : 'æ—¥ä¸»(Day Master)'} Â· 
                    ${g.state ? g.state.k : '-'}
                </p>
                <p style="margin-top:5px;font-size:0.85rem;color:var(--gray);">
                    ğŸ‘¤ ${GENDER === 'm' ? g.relationM : g.relationF} Â· ğŸ¦´ ${g.bodyPart}
                </p>
                <p style="margin-top:8px;line-height:1.6;">${g.analysis}</p>
            </div>
        `).join('')}
    `;
    
    // ========== 12ìš´ì„± ì™„ì „ ë¶„ì„ (NEW) ==========
    const ts = analyzeTwelveStates(SAJU);
    document.getElementById('twelve-states-full').innerHTML = `
        <div class="info-box ${ts.dominant === 'strong' ? 'good' : ts.dominant === 'weak' ? 'warn' : ''}">
            <p><strong>ğŸ“Š Base Energy Status</strong></p>
            <p style="margin-top:8px;">${ts.summary}</p>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:15px 0;">
            ${ts.pillars.map(p => `
                <div style="text-align:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;
                    border-bottom:3px solid ${p.energy >= 9 ? 'var(--wood)' : p.energy >= 6 ? 'var(--gold)' : p.energy >= 3 ? 'var(--earth)' : 'var(--fire)'};">
                    <div style="font-size:0.8rem;color:var(--gray);">${p.name}</div>
                    <div style="font-size:1.3rem;margin:8px 0;">${p.state.k}</div>
                    <div style="font-size:0.9rem;">âš¡ ${p.energy}/12</div>
                </div>
            `).join('')}
        </div>
        <div class="info-box">
            <p><strong>ğŸ”„ Life Energy Flow</strong></p>
            <div style="margin-top:10px;">
                ${ts.lifeFlow.map(lf => `
                    <div style="display:flex;align-items:center;padding:8px;margin:5px 0;background:rgba(255,255,255,0.03);border-radius:6px;">
                        <div style="width:80px;font-size:0.8rem;color:var(--gray);">${lf.period}</div>
                        <div style="width:60px;font-weight:bold;">${lf.state}</div>
                        <div style="flex:1;font-size:0.85rem;">${lf.advice}</div>
                        <div>${'â­'.repeat(Math.ceil(lf.energy/3))}${'â˜†'.repeat(4-Math.ceil(lf.energy/3))}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // å¤§é‹(Life Cycle)
    const luck = calcLuck(SAJU, BIRTH_YEAR, GENDER, GODS);
    document.getElementById('luck-timeline').innerHTML = luck.map(l => `
        <div class="luck-item ${l.isCur ? 'current' : ''} ${l.rating}">
            <div class="luck-age">${l.startAge}-${l.endAge}ì„¸</div>
            <div class="luck-pillar el-${l.s.e}">${l.s.c}${l.b.c}</div>
            <div class="luck-rating">${l.rating === 'good' ? 'ğŸ˜Š' : l.rating === 'bad' ? 'ğŸ˜°' : 'ğŸ˜'}</div>
        </div>
    `).join('');
    
    const curLuck = luck.find(l => l.isCur);
    if (curLuck) {
        document.getElementById('luck-detail').innerHTML = `<div class="info-box ${curLuck.rating === 'good' ? 'good' : curLuck.rating === 'bad' ? 'warn' : ''}"><p><strong>Current å¤§é‹(Life Cycle) (${curLuck.startAge}-${curLuck.endAge}ì„¸): ${curLuck.s.c}${curLuck.b.c}</strong><br>${curLuck.rating === 'good' ? 'Great fortune period! Take bold action.' : curLuck.rating === 'bad' ? 'Caution period. Avoid overexertion.' : 'Stable period. Stay consistent.'}</p></div>`;
    }
    
    // ========== å¤§é‹(Life Cycle) êµìš´ê¸° ë¶„ì„ (NEW) ==========
    const gyoungi = analyzeGyoungi(luck, BIRTH_YEAR, new Date().getFullYear());
    document.getElementById('gyoungi-analysis').innerHTML = gyoungi.length ? `
        <div class="info-box" style="margin-bottom:10px;">
            <p style="font-size:0.85rem;color:var(--gray);">å¤§é‹(Life Cycle)ì´ ë°”ë€ŒëŠ” ì‹œì ì„ ë¯¸ë¦¬ ì•Œë©´ ì¸ìƒì˜ ì „í™˜ì ì„ ì¤€ë¹„í•  ìˆ˜.</p>
        </div>
        ${gyoungi.map(g => `
            <div class="info-box ${g.intensity === 'strong' ? 'warn' : ''} ${g.isCurrent ? 'gold' : ''}" style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <p><strong>ğŸ”„ ${g.transitionAge}ì„¸ êµìš´ê¸°</strong> (${g.transitionYear}ë…„)</p>
                    ${g.isCurrent ? '<span style="background:var(--gold);color:#000;padding:2px 8px;border-radius:10px;font-size:0.7rem;">Current êµìš´ê¸°!</span>' : ''}
                </div>
                <p style="margin-top:10px;font-size:1.1rem;text-align:center;">
                    <span style="color:var(--gray);">${g.from}</span>
                    <span style="margin:0 10px;">â†’</span>
                    <span style="color:var(--gold);">${g.to}</span>
                </p>
                <p style="margin-top:10px;line-height:1.6;">${g.warning}</p>
                <p style="margin-top:8px;font-size:0.9rem;color:var(--gray);">ğŸ’¡ ${g.advice}</p>
            </div>
        `).join('')}
    ` : `<div class="info-box"><p style="color:var(--gray);">No major transition period near current age.</p></div>`;
    
    // ========== 10ë…„ ìš´ì„¸ ë¯¸ë¦¬ë³´ê¸° (NEW) ==========
    const next10 = getNext10Years(SAJU, BIRTH_YEAR, GENDER, GODS);
    const ratingEmoji = {excellent:'ğŸŒŸ',good:'ğŸ˜Š',neutral:'ğŸ˜',caution:'âš ï¸',difficult:'ğŸ˜°'};
    const ratingClass = {excellent:'good',good:'good',neutral:'',caution:'warn',difficult:'warn'};
    document.getElementById('ten-years-luck').innerHTML = `
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px;">
            ${next10.years.map(y => `
                <div style="flex:1;min-width:60px;padding:8px;text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;
                    border:1px solid ${y.rating === 'excellent' || y.rating === 'good' ? 'var(--wood)' : y.rating === 'difficult' || y.rating === 'caution' ? 'var(--fire)' : 'transparent'};">
                    <div style="font-size:0.75rem;color:var(--gray);">${y.year}</div>
                    <div style="font-size:1.1rem;">${ratingEmoji[y.rating]}</div>
                    <div style="font-size:0.7rem;color:var(--gray);">${y.age}ì„¸</div>
                </div>
            `).join('')}
        </div>
        <div class="info-box good">
            <p>ğŸŒŸ <strong>Best year: ${next10.bestYear.year}ë…„</strong> (${next10.bestYear.age}ì„¸)<br>
            ${next10.bestYear.saeun.pillar.s.c}${next10.bestYear.saeun.pillar.b.c}ë…„, ${next10.bestYear.saeun.god.k}ì˜ ê¸°ìš´</p>
        </div>
        <div class="info-box warn" style="margin-top:10px;">
            <p>âš ï¸ <strong>Caution year: ${next10.worstYear.year}ë…„</strong> (${next10.worstYear.age}ì„¸)<br>
            ${next10.worstYear.saeun.pillar.s.c}${next10.worstYear.saeun.pillar.b.c}ë…„ - Take care of health!</p>
        </div>
    `;
    
    // ========== ì˜¬í•´ Monthly Fortune (NEW) ==========
    const curYear = new Date().getFullYear();
    const monthlyLuck = getYearlyMonthLuck(curYear, SAJU, GODS);
    document.getElementById('monthly-luck').innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:15px;">
            ${monthlyLuck.months.map(m => `
                <div style="padding:10px;text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;
                    border:1px solid ${m.rating === 'good' ? 'var(--wood)' : m.rating === 'bad' ? 'var(--fire)' : 'transparent'};">
                    <div style="font-weight:bold;">${m.month}ì›”</div>
                    <div style="font-size:1.2rem;margin:5px 0;">${m.rating === 'good' ? 'ğŸ˜Š' : m.rating === 'bad' ? 'ğŸ˜°' : 'ğŸ˜'}</div>
                    <div style="font-size:0.7rem;color:var(--gray);">${m.pillar.s.c}${m.pillar.b.c}</div>
                    <div style="font-size:0.7rem;color:var(--gray);">${m.god.k}</div>
                </div>
            `).join('')}
        </div>
        <div class="info-box good">
            <p>ğŸŒŸ <strong>Best month: ${monthlyLuck.best.month}ì›”</strong><br>${monthlyLuck.best.god.k}energy brings good fortune!</p>
        </div>
        <div class="info-box warn" style="margin-top:10px;">
            <p>âš ï¸ <strong>Caution month: ${monthlyLuck.worst.month}ì›”</strong><br>${monthlyLuck.worst.god.k}energy - take it easy.</p>
        </div>
    `;
    
    // í•©ì¶©í˜•íŒŒí•´
    const ints = calcInteractions(SAJU);
    document.getElementById('interactions').innerHTML = ints.length ? ints.map(i => `<div class="int-item"><div class="int-type">${i.t}</div><div><div class="int-chars">${i.c}</div><div class="int-meaning">${i.m} - ${i.d}</div></div></div>`).join('') : '<p style="color:var(--gray);">No special harmony or clash in chart.</p>';
    
    // ========== æ–¹åˆ(Directional Harmony)/æš—åˆ(Hidden Harmony) ë¶„ì„ (NEW) ==========
    const banghap = analyzeBanghap(SAJU);
    const amhap = analyzeAmhap(SAJU);
    document.getElementById('banghap-amhap').innerHTML = `
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>ğŸŒ€ æ–¹åˆ(Directional Harmony)(æ–¹åˆ)</strong> - Same direction branches form powerful element</p>
            ${banghap.length ? banghap.map(b => `
                <div style="margin-top:10px;padding:12px;background:rgba(${b.type === 'complete' ? '76,175,80' : '255,152,0'},0.1);border-radius:8px;border-left:3px solid ${b.type === 'complete' ? 'var(--wood)' : 'var(--earth)'};">
                    <p style="font-weight:bold;color:${b.type === 'complete' ? 'var(--wood)' : 'var(--earth)'};">${b.name} (${b.branches})</p>
                    <p style="margin-top:5px;font-size:0.9rem;">${b.dir}</p>
                    <p style="margin-top:5px;font-size:0.85rem;">${b.desc}</p>
                    ${b.type === 'partial' ? `<p style="margin-top:5px;font-size:0.8rem;color:var(--gray);">ğŸ’¡ ${b.missing}(ì´)ê°€ ì˜¤ë©´ Complete!</p>` : ''}
                </div>
            `).join('') : '<p style="margin-top:10px;color:var(--gray);font-size:0.9rem;">æ–¹åˆ(Directional Harmony)ì´ absent.</p>'}
        </div>
        
        <div class="info-box">
            <p><strong>ğŸ¤« æš—åˆ(Hidden Harmony)(æš—åˆ)</strong> - Hidden harmony between branch stems (not visible)</p>
            ${amhap.length ? amhap.map(a => `
                <div style="margin-top:10px;padding:12px;background:rgba(156,39,176,0.1);border-radius:8px;border-left:3px solid #9C27B0;">
                    <p style="font-weight:bold;color:#9C27B0;">${a.name}</p>
                    <p style="margin-top:5px;font-size:0.9rem;">${a.positions}</p>
                    <p style="margin-top:5px;font-size:0.85rem;">${a.desc}</p>
                    <p style="margin-top:5px;font-size:0.8rem;color:var(--gray);">ğŸ’« ${a.meaning}</p>
                </div>
            `).join('') : '<p style="margin-top:10px;color:var(--gray);font-size:0.9rem;">No hidden harmony.</p>'}
        </div>
    `;
    
    // ========== í•©ì¶© ê³ ê¸‰ ë¶„ì„ (NEW) ==========
    const advInt = analyzeAdvancedInteractions(SAJU);
    document.getElementById('advanced-interactions').innerHTML = `
        ${advInt.hapHwa.length ? `
            <div class="info-box" style="margin-bottom:10px;">
                <p><strong>ğŸ”® ì²œê°„ í•©í™”(åˆåŒ–) ë¶„ì„</strong></p>
                ${advInt.hapHwa.map(h => `
                    <div style="margin-top:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:6px;border-left:3px solid ${h.isHwa ? 'var(--gold)' : 'var(--gray)'};">
                        <p><strong>${h.name}</strong> (${h.stems})</p>
                        <p style="font-size:0.85rem;color:${h.isHwa ? 'var(--gold)' : 'var(--gray)'};margin-top:5px;">
                            ${h.isHwa ? `âœ¨ ${h.result}ìœ¼ë¡œ í•©í™” ì„±ë¦½! ${h.reason}` : `âšª ${h.reason}`}
                        </p>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        ${advInt.samhapGuk.length ? `
            <div class="info-box" style="margin-bottom:10px;">
                <p><strong>ğŸŒ€ Trinityêµ­(ä¸‰åˆå±€) ë¶„ì„</strong></p>
                ${advInt.samhapGuk.map(s => `
                    <div style="margin-top:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:6px;border-left:3px solid ${s.complete ? 'var(--wood)' : 'var(--earth)'};">
                        <p><strong>${s.name}</strong> â†’ ${s.result} ê¸°ìš´</p>
                        <p style="font-size:0.85rem;margin-top:5px;">${s.desc}</p>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        ${advInt.chungHaeso.length ? `
            <div class="info-box ${advInt.chungHaeso.some(c => !c.isResolved) ? 'warn' : ''}" style="margin-bottom:10px;">
                <p><strong>âš¡ ì¶©(æ²–) í•´ì†Œ ë¶„ì„</strong></p>
                ${advInt.chungHaeso.map(c => `
                    <div style="margin-top:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:6px;border-left:3px solid ${c.isResolved ? 'var(--wood)' : 'var(--fire)'};">
                        <p><strong>${c.clash}</strong></p>
                        <p style="font-size:0.85rem;color:${c.isResolved ? 'var(--wood)' : 'var(--fire)'};margin-top:5px;">${c.reason}</p>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        ${advInt.warnings.length ? `
            <div class="info-box warn">
                <p><strong>âš ï¸ íŠ¹ë³„ ì£¼ì˜ì‚¬í•­</strong></p>
                ${advInt.warnings.map(w => `
                    <div style="margin-top:10px;">
                        <p><strong>${w.type}</strong></p>
                        <p style="font-size:0.85rem;margin-top:5px;">${w.desc}</p>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        ${!advInt.hapHwa.length && !advInt.samhapGuk.length && !advInt.chungHaeso.length && !advInt.warnings.length ?
            '<p style="color:var(--gray);">íŠ¹ë³„í•œ í•©í™”ë‚˜ ì¶© ê´€ê³„ê°€ absent. í‰ì˜¨í•œ ì‚¬ì£¼!</p>' : ''}
    `;
    
    // ê³µë§
    const gm = calcGongmang(SAJU);
    document.getElementById('gongmang').innerHTML = `<div class="info-box"><p><strong>ê³µë§:</strong> ${gm.names.join(', ')}<br>${gm.affected.length ? `âš ï¸ ${gm.affected.join(', ')} has ç©ºäº¡(Empty Void). This area energy is weak.` : 'No ç©ºäº¡(Empty Void) in chart!'}</p></div>`;
    
    // ========== ê³µë§ í•´ì†Œ ë¶„ì„ (NEW) ==========
    const gmHaeso = analyzeGongmangHaeso(SAJU, gm);
    document.getElementById('gongmang-haeso').innerHTML = gmHaeso.hasGongmang ? `
        ${gmHaeso.results.map(r => `
            <div class="info-box ${r.resolved ? 'good' : 'warn'}" style="margin-bottom:10px;">
                <p><strong>${r.position} ê³µë§ (${r.branch})</strong></p>
                <p style="margin-top:8px;font-size:0.9rem;">
                    ${r.resolved ? 
                        `âœ… í•´ì†Œë¨: ${r.method}` : 
                        `âŒ í•´ì†Œë˜ì§€ ì•ŠìŒ`}
                </p>
                <p style="margin-top:5px;font-size:0.85rem;color:var(--gray);">${r.effect}</p>
            </div>
        `).join('')}
        <div class="info-box" style="margin-top:10px;">
            <p><strong>ğŸ’¡ ç©ºäº¡(Empty Void) Resolution Conditions</strong></p>
            <p style="margin-top:8px;font-size:0.85rem;line-height:1.6;">
                1. Clash resolution: Opposite branch present<br>
                2. Trinity resolution: Other two trinity branches present<br>
                3. Luck cycle resolution: Temporary when conditions met in luck cycles
            </p>
        </div>
    ` : '<div class="info-box"><p style="color:var(--gray);">ì‚¬ì£¼ ë‚´ ê³µë§ì´ ì—†ì–´ í•´ì†Œ ë¶„ì„ì´ í•„ìš” absent. ğŸ‘</p></div>';
    
    // ì‹ ì‚´
    const sinsal = calcSinsal(SAJU);
    document.getElementById('sinsal').innerHTML = sinsal.length ? sinsal.map(s => `<div class="sinsal ${s.t}"><div class="sinsal-icon">${s.i}</div><div><div class="sinsal-name">${s.n}</div><div class="sinsal-desc">${s.d}</div></div></div>`).join('') : '<p style="color:var(--gray);">No special divine stars.</p>';
    
    // ========== ì‹ ì‚´ ìœ„ì¹˜ë³„ ë¶„ì„ (NEW) ==========
    const sinsalPos = analyzeSinsalPosition(SAJU);
    document.getElementById('sinsal-position').innerHTML = sinsalPos.length ? `
        <div class="info-box" style="margin-bottom:10px;">
            <p style="font-size:0.85rem;color:var(--gray);">ê°™ì€ ì‹ ì‚´ë„ ì–´ëŠ ìë¦¬ì— ìˆëŠëƒì— ë”°ë¼ ì˜ë¯¸ê°€ ë‹¬ë¼ì§‘ë‹ˆë‹¤.</p>
        </div>
        ${sinsalPos.map(sp => `
            <div class="info-box" style="margin-bottom:10px;border-left:3px solid ${sp.sinsal.includes('ë„í™”') ? '#e91e63' : sp.sinsal.includes('ì—­ë§ˆ') ? '#ff9800' : '#9c27b0'};">
                <p><strong>${sp.sinsal}</strong> - ${sp.position}</p>
                <p style="margin-top:8px;font-size:0.9rem;">${sp.interpretation}</p>
                <p style="margin-top:5px;font-size:0.85rem;color:var(--gold);">ğŸ’¡ ${sp.advice}</p>
            </div>
        `).join('')}
    ` : '<div class="info-box"><p style="color:var(--gray);">No major divine stars to analyze by position.</p></div>';
    
    // AI ì¢…í•© í•´ì„
    document.getElementById('ai-interpretation').innerHTML = generateAIInterpretation(SAJU, GODS, BIRTH_YEAR, GENDER);
    
    // Today's Fortune ì§ì ‘ í‘œì‹œ
    const todayEl = document.getElementById('today-fortune');
    if (todayEl) {
        todayEl.innerHTML = getTodayFortune();
    }
    
    // í†µë³€ ì´ˆê¸°í™” (fortune-contentê°€ ìˆìœ¼ë©´)
    renderFortune('total');
    } catch (error) {
        console.error('ì‚¬ì£¼ ë Œë”ë§ ì˜¤ë¥˜:', error);
        toast('Error displaying results.');
    }
}

function renderFortune(type) {
    const el = document.getElementById('fortune-content');
    if (!el) return; // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
    if (!SAJU) { el.innerHTML = '<p>Please analyze your Four Pillars first.</p>'; return; }
    
    const str = calcStrength(SAJU);
    
    // ìƒˆ ìƒì„¸ í†µë³€ í•¨ìˆ˜ ì‚¬ìš©
    if (type === 'today') {
        el.innerHTML = genTodayFortune(SAJU, GODS);
        return;
    }
    if (type === 'year') {
        const cy = new Date().getFullYear();
        el.innerHTML = genYearFortune(SAJU, GODS, cy);
        return;
    }
    if (type === 'career') {
        el.innerHTML = genCareerFortune(SAJU, str, GODS);
        return;
    }
    if (type === 'love') {
        el.innerHTML = genLoveFortune(SAJU, str, GODS);
        return;
    }
    if (type === 'wealth') {
        el.innerHTML = genWealthFortune(SAJU, str, GODS);
        return;
    }
    if (type === 'health') {
        el.innerHTML = genHealthFortune(SAJU, str, GODS);
        return;
    }
    
    // total (ê¸°ë³¸ê°’)
    const dm = SAJU.day.s;
    const yongEl = ELEMENT[GODS.yong];
    const colorAdvice = {
        wood: { color: 'ì´ˆë¡ìƒ‰, ì²­ë¡ìƒ‰', dir: 'ë™ìª½', num: '3, 8', item: 'Wood ì†Œí’ˆ, ì‹Water, ì±…' },
        fire: { color: 'ë¹¨ê°„ìƒ‰, ë³´ë¼ìƒ‰', dir: 'ë‚¨ìª½', num: '2, 7', item: 'ì¡°ëª…, ìº”ë“¤, ì „ìê¸°ê¸°' },
        earth: { color: 'ë…¸ë€ìƒ‰, ê°ˆìƒ‰', dir: 'ì¤‘ì•™', num: '5, 10', item: 'ë„ìê¸°, í¬ë¦¬ìŠ¤íƒˆ, ë¶€ë™ì‚°' },
        metal: { color: 'í°ìƒ‰, Metalìƒ‰, ì€ìƒ‰', dir: 'ì„œìª½', num: '4, 9', item: 'ê¸ˆì† ì•¡ì„¸ì„œë¦¬, ì‹œê³„, ìë™ì°¨' },
        water: { color: 'ê²€ì€ìƒ‰, íŒŒë€ìƒ‰', dir: 'ë¶ìª½', num: '1, 6', item: 'Waterì¡±ê´€, ë¶„Water, ê·¸ë¦¼' }
    };
    const yongAdvice = colorAdvice[GODS.yong];
    
    const typeDesc = {
        strong: `<strong>ğŸ”¥ ê¸°ìš´ì´ ê°•í•œ ì‚¬ì£¼!</strong><br><br>ìê¸° ì£¼ì¥ì´ í™•ì‹¤í•˜ê³  ë‚¨ì—ê²Œ íœ˜ë‘˜ë¦¬ì§€ ì•ŠëŠ” íƒ€ì…ì´ì—ìš”.<br><br><strong>ì¥ì :</strong> ë¦¬ë”ì‹­, ë¹ ë¥¸ ê²°ì •ë ¥, ë…ë¦½ì‹¬, ì¶”ì§„ë ¥<br><strong>ì£¼ì˜:</strong> ë„ˆë¬´ ê°•í•˜ë©´ "ê³ ì§‘ìŸì´"ë¡œ ë³´ì—¬ìš”. ê°€ë” ë‚¨ì˜ ë§ë„ ë“¤ì–´ì£¼ì„¸ìš”!`,
        weak: `<strong>ğŸ’§ ë¶€ë“œëŸ¬ìš´ ê¸°ìš´ì˜ ì‚¬ì£¼!</strong><br><br>í˜‘ë ¥ ì˜í•˜ê³  ì¡°í™”ë¡­ê²Œ ì§€ë‚´ëŠ” íƒ€ì…ì´ì—ìš”.<br><br><strong>ì¥ì :</strong> ëˆˆì¹˜ ë¹ ë¦„, ì ì‘ë ¥, ë°°ë ¤ì‹¬, ê·€ì¸ìš´<br><strong>ì£¼ì˜:</strong> ë„ˆë¬´ ëˆˆì¹˜ ë³´ë©´ ìê¸° ì˜ê²¬ ëª» ë§í•´ìš”. ë‹¹ë‹¹í•˜ê²Œ!`,
        balanced: `<strong>âš–ï¸ ê· í˜• ì¡íŒ ì‚¬ì£¼!</strong><br><br>ê°•í•  ë•Œ ê°•í•˜ê³ , ë¶€ë“œëŸ¬ìš¸ ë•Œ ë¶€ë“œëŸ¬ìš´ ë§ŒëŠ¥ íƒ€ì…! ì‚¬ì£¼ì—ì„œ ê°€ì¥ ì¢‹ì€ ìƒíƒœì˜ˆìš”!<br><br><strong>ì¥ì :</strong> ìƒí™© íŒë‹¨ ë¹ ë¦„, ì ì‘ë ¥ ìµœê³ , ì–´ë””ì„œë“  ì˜ ì‚´ì•„ë‚¨ì•„ìš”`
    };
    
    el.innerHTML = `
        <div class="info-box gold">
            <p><strong>ğŸ“Š ì´ìš´ ë¶„ì„</strong></p>
        </div>
        <div class="info-box" style="margin-top:12px;">
            <p style="line-height:1.8;">${typeDesc[GODS.type]}</p>
        </div>
        ${str.extreme ? `<div class="info-box warn" style="margin-top:12px;"><p><strong>âš¡ ${str.extreme} ì‚¬ì£¼!</strong><br>${str.extreme === 'ê·¹Strong' ? 'ê¸°ìš´ì´ ë§¤ìš° ê°•í•´ì„œ ì¢…ê²©(ì¢…ì™•ê²©, ì¢…ê°•ê²©)ì¼ ìˆ˜ present. ìê¸° ëœ»ëŒ€ë¡œ ì‚¬ëŠ” ê²Œ ì¢‹ì•„ìš”!' : 'ê¸°ìš´ì´ ë§¤ìš° ì•½í•´ì„œ ì¢…ê²©(ì¢…ì•„ê²©, ì¢…ì¬ê²©, ì¢…ì‚´ê²©)ì¼ ìˆ˜ present. ë‚¨ì„ ì˜ ë”°ë¥´ê³  í˜‘ì¡°í•˜ëŠ” ê²Œ ì¢‹ì•„ìš”!'}</p></div>` : ''}
        <div class="info-box good" style="margin-top:15px;">
            <p><strong>ğŸ¯ ìš©ì‹  í™œìš©ë²•</strong></p>
            <p style="margin-top:8px;">ìš©ì‹ ì¸ <strong>${yongEl.n}(${yongEl.k})</strong> ê¸°ìš´ì„ ê°€ê¹Œì´ í•˜ì„¸ìš”!</p>
            <ul style="margin-top:10px;margin-left:15px;line-height:1.8;">
                <li>ğŸ¨ í–‰ìš´ì˜ ìƒ‰: ${yongAdvice.color}</li>
                <li>ğŸ§­ í–‰ìš´ì˜ ë°©í–¥: ${yongAdvice.dir}</li>
                <li>ğŸ”¢ í–‰ìš´ì˜ ìˆ«ì: ${yongAdvice.num}</li>
                <li>âœ¨ í–‰ìš´ì˜ ì•„ì´í…œ: ${yongAdvice.item}</li>
            </ul>
        </div>`;
}

function getTodayFortune() {
    const today = new Date();
    const dp = calcDayPillar(today.getFullYear(), today.getMonth() + 1, today.getDate());
    const god = getTenGod(dp.s, SAJU.day.s);
    
    const isYong = [dp.s.e, dp.b.e].includes(GODS.yong);
    const isHee = [dp.s.e, dp.b.e].includes(GODS.hee);
    const isGi = [dp.s.e, dp.b.e].includes(GODS.gi);
    
    let rating, advice;
    if (isYong) {
        rating = 'âœ¨ Great Fortune';
        advice = 'Today your Beneficial Element energy is strong! Push forward with important matters. Active movement brings good results.';
    } else if (isHee) {
        rating = 'ğŸ˜Š ê¸¸(å‰)';
        advice = 'í¬ì‹ ì˜ ê¸°ìš´ì´ ë„ì™€ì£¼ëŠ” ë‚ ì…ë‹ˆë‹¤. ê³„íší•œ ì¼ë“¤ì´ ìˆœì¡°ë¡­ê²Œ ì§„í–‰ë©ë‹ˆë‹¤. ìƒˆë¡œìš´ ì‹œë„ë„ brings fortune.';
    } else if (isGi) {
        rating = 'âš ï¸ ì¡°ì‹¬';
        advice = 'ê¸°ì‹ ì˜ ê¸°ìš´ì´ ê°•í•œ ë‚ ì´ë‹ˆ avoid overexertion. ì¤‘ìš”í•œ ê²°ì •ì€ ë¯¸ë£¨ê³ , ê¸°ì¡´ì— í•˜ë˜ ì¼ì— ì§‘ì¤‘í•˜ì„¸ìš”.';
    } else {
        rating = 'ğŸ˜ í‰ì˜¨';
        advice = 'í‰ë²”í•œ í•˜ë£¨ì…ë‹ˆë‹¤. ê¾¸ì¤€íˆ ì¼ìƒì„ ìœ ì§€í•˜ë©´ì„œ ì‘ì€ í–‰ë³µì„ ì°¾ìœ¼ì„¸ìš”.';
    }
    
    return `<div class="info-box">
        <p><strong>ğŸ“… Today's Fortune</strong> <span style="color:var(--gold);">(${dp.s.c}${dp.b.c}ì¼)</span></p>
        <div style="margin-top:12px;text-align:center;font-size:18px;">${rating}</div>
        <p style="margin-top:12px;line-height:1.8;">
            Today's day energy: <strong>${dp.s.c}${dp.b.c}</strong> (${ELEMENT[dp.s.e].k}${ELEMENT[dp.b.e].k})<br>
            Today's Ten God: <strong>${god.k}</strong> - ${god.d}
        </p>
        <div style="margin-top:15px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
            <p><strong>ğŸ’¡ Today's Advice</strong></p>
            <p style="margin-top:8px;line-height:1.6;">${advice}</p>
        </div>
    </div>`;
}

function getYearFortune() {
    const cy = new Date().getFullYear();
    const yp = calcYearPillar(cy, 6, 1);
    const god = getTenGod(yp.s, SAJU.day.s);
    
    const isYong = [yp.s.e, yp.b.e].includes(GODS.yong);
    const isHee = [yp.s.e, yp.b.e].includes(GODS.hee);
    const isGi = [yp.s.e, yp.b.e].includes(GODS.gi);
    
    let rating, advice;
    if (isYong) {
        rating = 'ğŸŒŸ ëŒ€ê¸¸ë…„(å¤§å‰å¹´)';
        advice = 'ì˜¬í•´ëŠ” ìš©ì‹ ì˜ í•´! 10ë…„ì— í•œ ë²ˆ ì˜¤ëŠ” ê¸°íšŒì˜ í•´ì…ë‹ˆë‹¤. ì ê·¹ì ìœ¼ë¡œ ë„ì „í•˜ê³  í™•ì¥í•˜ì„¸ìš”. ì´ì§, ì°½ì—…, ê²°í˜¼ ë“± í° ê²°ì •ì— brings fortune.';
    } else if (isHee) {
        rating = 'ğŸ˜Š ê¸¸ë…„(å‰å¹´)';
        advice = 'í¬ì‹ ì˜ ê¸°ìš´ì´ ë„ì™€ì£¼ëŠ” í•´ì…ë‹ˆë‹¤. í•˜ëŠ” ì¼ì´ ìˆœì¡°ë¡­ê³  ì£¼ë³€ì˜ ë„ì›€ì„ ë°›ê¸° ì‰½ìŠµë‹ˆë‹¤. ì¸ë§¥ì„ ë„“íˆê³  ë°°ì›€ì— íˆ¬ìí•˜ì„¸ìš”.';
    } else if (isGi) {
        rating = 'âš ï¸ ì¡°ì‹¬í•´ì•¼ í•  í•´';
        advice = 'ê¸°ì‹ ì˜ í•´ì´ë‹ˆ ë¬´ë¦¬í•œ í™•ì¥ì´ë‚˜ íˆ¬ìëŠ” í”¼í•˜ì„¸ìš”. ê±´ê°• ê´€ë¦¬ì— ì‹ ê²½ ì“°ê³ , ì•ˆì •ì„ ìœ ì§€í•˜ë©´ì„œ ë‚´ì‹¤ì„ ë‹¤ì§€ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤.';
    } else {
        rating = 'ğŸ˜ í‰ë…„(å¹³å¹´)';
        advice = 'í° ë³€í™” ì—†ì´ í‰íƒ„í•œ í•´ì…ë‹ˆë‹¤. ë¬µë¬µíˆ ìê¸° ì¼ì— ì¶©ì‹¤í•˜ë©´ì„œ ë‹¤ìŒ ê¸°íšŒë¥¼ ì¤€ë¹„í•˜ì„¸ìš”.';
    }
    
    return `<div class="info-box">
        <p><strong>ğŸ“† ${cy}ë…„ ìš´ì„¸</strong> <span style="color:var(--gold);">(${yp.s.c}${yp.b.c}ë…„)</span></p>
        <div style="margin-top:12px;text-align:center;font-size:18px;">${rating}</div>
        <p style="margin-top:12px;line-height:1.8;">
            ì˜¬í•´ì˜ æ­²é‹(Annual Fortune): <strong>${yp.s.c}${yp.b.c}</strong> (${ELEMENT[yp.s.e].k}${ELEMENT[yp.b.e].k})<br>
            ì˜¬í•´ì˜ ì‹­ì‹ : <strong>${god.k}</strong> - ${god.d}
        </p>
        <div style="margin-top:15px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
            <p><strong>ğŸ’¡ ì˜¬í•´ì˜ ì¡°ì–¸</strong></p>
            <p style="margin-top:8px;line-height:1.6;">${advice}</p>
        </div>
        <div style="margin-top:12px;padding:12px;background:rgba(253,216,53,0.1);border-radius:8px;">
            <p><strong>ğŸ“… ì˜¬í•´ ì¢‹ì€ ë‹¬</strong></p>
            <p style="margin-top:8px;">ìš©ì‹ (${ELEMENT[GODS.yong].k})ì´ ê°•í•œ ë‹¬: ${getGoodMonths()}</p>
        </div>
    </div>`;
}

function getGoodMonths() {
    const monthElements = ['water','water','wood','wood','earth','fire','fire','earth','metal','metal','earth','water'];
    const goodMonths = [];
    monthElements.forEach((el, i) => {
        if (el === GODS.yong || el === GODS.hee) goodMonths.push((i + 1) + 'ì›”');
    });
    return goodMonths.length ? goodMonths.join(', ') : 'ìƒë°˜ê¸°ë³´ë‹¤ í•˜ë°˜ê¸°ê°€ brings fortune';
}

/* ========================================
   AI ì¢…í•© í•´ì„ ì—”ì§„
   ======================================== */
function generateAIInterpretation(saju, gods, birthYear, gender) {
    const dm = saju.day.s;
    const str = calcStrength(saju);
    const currentYear = new Date().getFullYear();
    const age = currentYear - birthYear + 1;
    
    // Gather analysis results
    const interactions = calcInteractions(saju);
    const format = calcFormat(saju);
    const sinsal = calcSinsal(saju);
    const gongmang = calcGongmang(saju);
    const luck = calcLuck(saju, birthYear, gender, gods);
    const curLuck = luck.find(l => l.isCur);
    
    // äº”è¡Œ(Five Elements) distribution
    const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if(p && p.s) elCount[p.s.e]++;
        if(p && p.b) elCount[p.b.e]++;
    });
    
    // Strongest/Weakest elements
    const maxEl = Object.entries(elCount).reduce((a,b) => b[1] > a[1] ? b : a);
    const minEl = Object.entries(elCount).filter(e => e[1] === 0);
    
    // Harmony/Clash analysis
    const hasGoodHap = interactions.some(i => i.t.includes('í•©'));
    const hasBadChung = interactions.some(i => i.t.includes('ì¶©'));
    
    // Good/Bad stars
    const goodSinsal = sinsal.filter(s => s.t === 'good');
    const badSinsal = sinsal.filter(s => s.t === 'bad');
    
    // ========== Core Message ==========
    let coreMessage = '';
    let priority = [];
    
    const dmName = `${dm.k} ${ELEMENT[dm.e].k}`;
    const dmHanja = `${dm.c}${ELEMENT[dm.e].c}`;
    
    if (str.type === 'strong') {
        coreMessage = `<strong>${dmName} (${dmHanja})</strong> æ—¥ä¸»(Day Master) is ${str.pct}% <span style="color:var(--fire);">Strong</span>. You have a powerful will and lead your own path in life.`;
        priority.push('Forge your own path - independence suits you best');
    } else if (str.type === 'weak') {
        coreMessage = `<strong>${dmName} (${dmHanja})</strong> æ—¥ä¸»(Day Master) is ${str.pct}% <span style="color:var(--water);">Weak</span>. You shine brightest through cooperation and harmony with others.`;
        priority.push('Partner with the right people - collaboration is your key');
    } else {
        coreMessage = `<strong>${dmName} (${dmHanja})</strong> æ—¥ä¸»(Day Master) is ${str.pct}% <span style="color:var(--gold);">Balanced</span>. You can adapt flexibly to any situation.`;
        priority.push('Adaptability is your superpower');
    }
    
    // Conflict analysis
    let conflictAnalysis = [];
    
    if (hasBadChung && hasGoodHap) {
        conflictAnalysis.push({
            type: 'resolved',
            msg: 'Your chart has both Clash and Harmony - conflicts tend to resolve themselves. You experience growth through challenges.'
        });
    } else if (hasBadChung) {
        conflictAnalysis.push({
            type: 'caution',
            msg: 'Your chart contains Clash energy - expect changes and some conflicts. However, these can become opportunities for growth.'
        });
    }
    
    if (minEl.length >= 2) {
        conflictAnalysis.push({
            type: 'missing',
            msg: `Missing ${minEl.map(e => ELEMENT[e[0]].display).join(', ')} elements. Your Beneficial Element (${ELEMENT[gods.yong].n}) naturally compensates for this.`
        });
    }
    
    if (str.extreme) {
        conflictAnalysis.push({
            type: 'extreme',
            msg: `This is an ${str.extreme === 'ê·¹Strong' ? 'Extremely Strong' : 'Extremely Weak'} chart. ${str.extreme === 'ê·¹Strong' ? 'Following your own will leads to success.' : 'Delegating and collaborating is your key to success.'}`
        });
    }
    
    // Timing guide
    let timingGuide = '';
    const yearPillar = calcYearPillar(currentYear, 6, 1);
    const isYongYear = [yearPillar.s.e, yearPillar.b.e].includes(gods.yong);
    const isGiYear = [yearPillar.s.e, yearPillar.b.e].includes(gods.gi);
    
    if (curLuck) {
        const isGoodLuck = curLuck.rating === 'good';
        const luckEl = ELEMENT[curLuck.s.e].n;
        
        if (isGoodLuck && isYongYear) {
            timingGuide = `ğŸŒŸ <strong>Golden Opportunity!</strong><br>Both your å¤§é‹(Life Cycle) and this year are favorable. Ages ${curLuck.startAge}-${curLuck.endAge} (${curLuck.s.c}${curLuck.b.c}) with ${luckEl} energy supporting you, plus ${currentYear} is your Beneficial Year. <span style="color:var(--gold);">Take bold action now!</span>`;
        } else if (isGoodLuck && isGiYear) {
            timingGuide = `âš–ï¸ <strong>Mixed Energies</strong><br>Your å¤§é‹(Life Cycle) brings fortune but this year has challenging energy. Stay the course - short-term difficulties won't derail your upward trajectory. <span style="color:var(--earth);">Build foundations for next year.</span>`;
        } else if (!isGoodLuck && isYongYear) {
            timingGuide = `ğŸ’« <strong>Year of Reversal!</strong><br>Though your current å¤§é‹(Life Cycle) is weak, this year brings Beneficial energy. Don't miss this window! <span style="color:var(--gold);">Act now for good results.</span>`;
        } else if (!isGoodLuck && isGiYear) {
            timingGuide = `ğŸ›¡ï¸ <strong>Time for Patience</strong><br>Both å¤§é‹(Life Cycle) and yearly energy require caution. Focus on <span style="color:var(--water);">health and inner strength</span> rather than expansion. Better times are coming.`;
        } else {
            timingGuide = `ğŸ˜Š <strong>Steady Flow</strong><br>Ages ${curLuck.startAge}-${curLuck.endAge} å¤§é‹(Life Cycle) (${curLuck.s.c}${curLuck.b.c}). Consistency is your best strategy.`;
        }
    }
    
    // Personal advice
    let personalAdvice = [];
    
    if (age < 30) {
        personalAdvice.push({icon:'ğŸ“š', title:'Advice for 20s', msg:`Study or gain experience in ${ELEMENT[gods.yong].n}-related fields. This becomes a lifelong asset.`});
    } else if (age < 40) {
        personalAdvice.push({icon:'ğŸš€', title:'Advice for 30s', msg:`What you build now bears fruit in your 40s. Develop expertise in ${format.b.split(',')[0]} areas.`});
    } else if (age < 50) {
        personalAdvice.push({icon:'ğŸ¯', title:'Advice for 40s', msg:'Time to leverage your experience and lead. Mentoring others also benefits you.'});
    } else {
        personalAdvice.push({icon:'ğŸŒ³', title:'Life Wisdom', msg:'Share your wisdom and prioritize health. Spiritual richness is true happiness.'});
    }
    
    const yongAdvice = {
        wood: {actions:['East direction', 'Morning exercise', 'Green colors', 'Reading/Learning', 'New beginnings'], avoid:'Excessive competition, metal decor'},
        fire: {actions:['South direction', 'Social gatherings', 'Red accents', 'Social media', 'Public speaking'], avoid:'Dark environments, isolation'},
        earth: {actions:['Center positions', 'Real estate', 'Yellow/Brown colors', 'Building trust', 'Stable investments'], avoid:'Frequent moves, sudden changes'},
        metal: {actions:['West direction', 'Finance/Investment', 'White/Silver colors', 'Setting principles', 'Organization'], avoid:'Indecisiveness, chaotic environments'},
        water: {actions:['North direction', 'Flexible thinking', 'Black/Blue colors', 'Networking', 'Travel'], avoid:'Stubbornness, staying in one place'}
    };
    
    const yongAction = yongAdvice[gods.yong];
    personalAdvice.push({
        icon:'âœ¨',
        title:`Using ${ELEMENT[gods.yong].n} (Beneficial Element)`,
        msg:`Recommended: ${yongAction.actions.slice(0,3).join(', ')}<br>Avoid: ${yongAction.avoid}`
    });
    
    personalAdvice.push({
        icon:'ğŸ’¼',
        title:'Career Aptitude',
        msg:`Based on your ${format.n}: ${format.b}`
    });
    
    if (goodSinsal.length > 0) {
        personalAdvice.push({
            icon:'ğŸŒŸ',
            title:'Lucky Stars',
            msg:`You have ${goodSinsal.map(s => s.n).join(', ')}. Trust this energy and take bold action!`
        });
    }
    
    // ========== Generate HTML ==========
    let html = `
        <div style="padding:15px;background:linear-gradient(135deg,rgba(156,39,176,0.1),rgba(103,58,183,0.05));border-radius:12px;margin-bottom:15px;">
            <p style="font-size:0.85rem;color:var(--gray);margin-bottom:10px;">ğŸ§  AI Comprehensive Analysis of Your Four Pillars</p>
            <p style="line-height:1.8;font-size:1rem;">${coreMessage}</p>
        </div>
    `;
    
    if (conflictAnalysis.length > 0) {
        html += `
            <div class="info-box ${conflictAnalysis.some(c => c.type === 'caution' || c.type === 'extreme') ? 'warn' : ''}" style="margin-bottom:15px;">
                <p style="margin-bottom:10px;"><strong>âš–ï¸ Energy Conflict Analysis</strong></p>
                ${conflictAnalysis.map(c => `
                    <div style="padding:10px;margin:8px 0;background:rgba(255,255,255,0.05);border-radius:8px;border-left:3px solid ${c.type === 'caution' ? 'var(--fire)' : c.type === 'resolved' ? 'var(--wood)' : 'var(--gold)'};">
                        <p style="font-size:0.9rem;line-height:1.6;">${c.msg}</p>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    html += `
        <div class="info-box gold" style="margin-bottom:15px;">
            <p style="margin-bottom:10px;"><strong>ğŸ“… Current Period Guide (${currentYear}, Age ${age})</strong></p>
            <p style="line-height:1.8;font-size:0.95rem;">${timingGuide}</p>
        </div>
    `;
    
    html += `
        <div class="info-box" style="margin-bottom:15px;">
            <p style="margin-bottom:12px;"><strong>ğŸ’¡ Personalized Advice</strong></p>
            ${personalAdvice.map(a => `
                <div style="padding:12px;margin:8px 0;background:rgba(255,255,255,0.05);border-radius:8px;">
                    <p style="font-weight:bold;margin-bottom:5px;">${a.icon} ${a.title}</p>
                    <p style="font-size:0.9rem;line-height:1.6;color:var(--gray);">${a.msg}</p>
                </div>
            `).join('')}
        </div>
    `;
    
    if (priority.length > 0) {
        html += `
            <div style="padding:15px;background:linear-gradient(135deg,var(--gold),var(--gold-dark));border-radius:12px;color:var(--red-dark);text-align:center;">
                <p style="font-weight:bold;font-size:1.1rem;">ğŸ¯ Key Message</p>
                <p style="margin-top:8px;font-size:0.95rem;">"${priority[0]}"</p>
            </div>
        `;
    }
    
    return html;
}

function showTodayFortune() {
    const el = document.getElementById('today-fortune');
    if (!el) return;
    const content = document.getElementById('today-fortune-content');
    if (content) {
        content.innerHTML = getTodayFortune();
    }
}

/* ========================================
   AI Interpretation Copy Function
   ======================================== */
function copySajuForAI() {
    if (!SAJU) { toast('Please analyze your Four Pillars first'); return; }
    
    try {
        const str = calcStrength(SAJU);
        const dm = SAJU.day.s;
        const format = calcFormat(SAJU);
        const interactions = calcInteractions(SAJU) || [];
        const sinsal = calcSinsal(SAJU) || [];
        const gongmang = calcGongmang(SAJU);
        const luck = calcLuck(SAJU, BIRTH_YEAR, GENDER, GODS) || [];
        const curLuck = luck.find(l => l.isCur);
        const currentYear = new Date().getFullYear();
        const age = currentYear - BIRTH_YEAR + 1;
        const ilju = getIljuDesc(SAJU.day.s, SAJU.day.b);
        
        // äº”è¡Œ(Five Elements) Distribution ê³„ì‚°
        const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
        [SAJU.year, SAJU.month, SAJU.day, SAJU.hour].forEach(p => {
            if(p && p.s) elCount[p.s.e]++;
            if(p && p.b) elCount[p.b.e]++;
        });
        
        // ì‹­ì‹  ê³„ì‚°
        const yearGod = getTenGod(SAJU.year.s, dm);
        const monthGod = getTenGod(SAJU.month.s, dm);
        const hourGod = SAJU.hour ? getTenGod(SAJU.hour.s, dm) : null;
        
        // 12ìš´ì„± ê³„ì‚°
        const yearState = getTwelveState(dm, SAJU.year.b);
        const monthState = getTwelveState(dm, SAJU.month.b);
        const dayState = getTwelveState(dm, SAJU.day.b);
        const hourState = SAJU.hour ? getTwelveState(dm, SAJU.hour.b) : null;
        
        // æ”¯è—å¹²(Hidden Stems) Analysis (safe)
        let jjText = '';
        try {
            const jjAnalysis = analyzeJijanggan(SAJU);
            if (jjAnalysis && jjAnalysis.pillars) {
                jjText = `â€¢ Year Branch ${SAJU.year.b.c}: ${jjAnalysis.pillars[0]?.hidden?.map(h => h.stem.c + '(' + h.stem.k + ',' + h.type + ',' + h.god.k + ')').join(', ') || '-'}
â€¢ Month Branch ${SAJU.month.b.c}: ${jjAnalysis.pillars[1]?.hidden?.map(h => h.stem.c + '(' + h.stem.k + ',' + h.type + ',' + h.god.k + ')').join(', ') || '-'}
â€¢ Day Branch ${SAJU.day.b.c}: ${jjAnalysis.pillars[2]?.hidden?.map(h => h.stem.c + '(' + h.stem.k + ',' + h.type + ',' + h.god.k + ')').join(', ') || '-'}`;
                if (SAJU.hour && jjAnalysis.pillars[3]) {
                    jjText += `\nâ€¢ Hour Branch ${SAJU.hour.b.c}: ${jjAnalysis.pillars[3]?.hidden?.map(h => h.stem.c + '(' + h.stem.k + ',' + h.type + ',' + h.god.k + ')').join(', ') || '-'}`;
                }
            }
        } catch(e) { jjText = 'â€¢ æ”¯è—å¹²(Hidden Stems) analysis unavailable'; }
        
        // Root/Stem Analysis (safe)
        let ttText = '';
        try {
            const ttAnalysis = analyzeTonggeunTougan(SAJU);
            const tgText = ttAnalysis?.tonggeun?.length ? 
                ttAnalysis.tonggeun.map(t => t.stem + ' roots in ' + (t.roots?.map(r => r.pillar + r.branch).join(',') || '')).join('; ') : 'No roots';
            const tuText = ttAnalysis?.tougan?.length ? 
                ttAnalysis.tougan.map(t => t.stem + '(' + t.god + ')').join(', ') : 'No stems revealed';
            ttText = `â€¢ Roots (é€šæ ¹): ${tgText}\nâ€¢ Stems Revealed (é€å¹²): ${tuText}`;
        } catch(e) { ttText = 'â€¢ Root/Stem analysis unavailable'; }
        
        // å…­è¦ª(Six Relations) Analysis (safe)
        let ycText = '';
        try {
            const yukcheon = analyzeYukcheon(SAJU, GENDER);
            if (yukcheon) {
                ycText = `â€¢ é…å¶æ˜Ÿ(Spouse Star) (${yukcheon.spouse?.god || '-'}): ${yukcheon.spouse?.count > 0 ? yukcheon.spouse.count + ' present' : 'None'} - ${yukcheon.spouse?.analysis || '-'}
â€¢ å­å¥³æ˜Ÿ(Children Star) (${yukcheon.children?.gods?.join('/') || '-'}): ${yukcheon.children?.count > 0 ? 'Present' : 'None'} - ${yukcheon.children?.analysis || '-'}
â€¢ Father (åè²¡/Indirect Wealth): ${yukcheon.parents?.father?.analysis || '-'}
â€¢ Mother (æ­£å°/Direct Seal): ${yukcheon.parents?.mother?.analysis || '-'}`;
            }
        } catch(e) { ycText = 'â€¢ å…­è¦ª(Six Relations) analysis unavailable'; }
        
        // å®®ä½(Palace Analysis) (safe)
        let gwText = '';
        try {
            const gungwi = analyzeGungwi(SAJU, BIRTH_YEAR);
            if (gungwi && Array.isArray(gungwi)) {
                gwText = gungwi.map(g => 'â€¢ ' + g.name + ' (' + g.ageRange + '): ' + (g.analysis?.substring(0, 50) || '') + '...' + (g.isCurrent ? ' â—€ CURRENT' : '')).join('\n');
            }
        } catch(e) { gwText = 'â€¢ Palace analysis unavailable'; }
        
        // Next 10 Years (safe)
        let next10Text = '';
        try {
            const next10 = getNext10Years(SAJU, BIRTH_YEAR, GENDER, GODS);
            if (next10) {
                next10Text = `â€¢ Best Year: ${next10.bestYear?.year || '-'} (Age ${next10.bestYear?.age || '-'})
â€¢ Caution Year: ${next10.worstYear?.year || '-'} (Age ${next10.worstYear?.age || '-'})`;
            }
        } catch(e) { next10Text = 'â€¢ 10-year forecast unavailable'; }
        
        // Monthly Fortune (safe)
        let monthText = '';
        try {
            const monthlyLuck = getYearlyMonthLuck(currentYear, SAJU, GODS);
            if (monthlyLuck) {
                monthText = `â€¢ Best Month: ${monthlyLuck.best?.month || '-'} (${monthlyLuck.best?.god?.k || '-'})
â€¢ Caution Month: ${monthlyLuck.worst?.month || '-'} (${monthlyLuck.worst?.god?.k || '-'})`;
            }
        } catch(e) { monthText = 'â€¢ Monthly forecast unavailable'; }
        
        // ç´éŸ³(Sound Element)/å‘½å®®(Life Palace)/Conception (safe)
        let napeumText = '';
        try {
            const dayNapeum = calcNapeum(SAJU.day.s, SAJU.day.b);
            const yearNapeum = calcNapeum(SAJU.year.s, SAJU.year.b);
            napeumText = `â€¢ Day ç´éŸ³(Sound Element): ${SAJU.day.s.c}${SAJU.day.b.c} â†’ ${dayNapeum.name} (${dayNapeum.elementK}) - ${dayNapeum.desc}
â€¢ Year ç´éŸ³(Sound Element): ${SAJU.year.s.c}${SAJU.year.b.c} â†’ ${yearNapeum.name} (${yearNapeum.elementK})`;
        } catch(e) { napeumText = 'â€¢ ç´éŸ³(Sound Element) unavailable'; }
        
        let myunggungText = '';
        try {
            if (SAJU.hour) {
                const myunggung = calcMyunggung(SAJU.month.b, SAJU.hour.b);
                myunggungText = `â€¢ å‘½å®®(Life Palace): ${myunggung.name} (${myunggung.branch.c})
â€¢ Tendency: ${myunggung.trait}
â€¢ Suitable Fields: ${myunggung.career}`;
            } else {
                myunggungText = 'â€¢ å‘½å®®(Life Palace): Cannot calculate without Hour';
            }
        } catch(e) { myunggungText = 'â€¢ å‘½å®®(Life Palace) unavailable'; }
        
        let taewonText = '';
        try {
            const taewon = calcTaewon(SAJU.year.s, SAJU.month.s, SAJU.month.b);
            taewonText = `â€¢ èƒå…ƒ(Conception Origin): ${taewon.pillar} (${taewon.stem.k}${taewon.branch.k})
â€¢ Conception ç´éŸ³(Sound Element): ${taewon.napeum.name} (${taewon.napeum.elementK})`;
        } catch(e) { taewonText = 'â€¢ èƒå…ƒ(Conception Origin) unavailable'; }
        
        // æ–¹åˆ(Directional Harmony)/æš—åˆ(Hidden Harmony) (safe)
        let banghapText = '';
        try {
            const banghap = analyzeBanghap(SAJU);
            banghapText = banghap.length ? banghap.map(b => 
                `â€¢ ${b.name} (${b.branches}): ${b.dir} ${b.type === 'complete' ? 'COMPLETE!' : 'Incomplete'}`
            ).join('\n') : 'â€¢ No æ–¹åˆ(Directional Harmony)';
        } catch(e) { banghapText = 'â€¢ æ–¹åˆ(Directional Harmony) unavailable'; }
        
        let amhapText = '';
        try {
            const amhap = analyzeAmhap(SAJU);
            amhapText = amhap.length ? amhap.map(a => 
                `â€¢ ${a.name}: ${a.positions} - ${a.desc}`
            ).join('\n') : 'â€¢ No æš—åˆ(Hidden Harmony)';
        } catch(e) { amhapText = 'â€¢ æš—åˆ(Hidden Harmony) unavailable'; }
        
        // Generate text
        let text = `===== FOUR PILLARS OF DESTINY (SAJU) ANALYSIS =====

ã€BASIC INFOã€‘
â€¢ Birth Year: ${BIRTH_YEAR} (${GENDER === 'm' ? 'Male' : 'Female'}, Age ${age-1})
â€¢ æ—¥ä¸»(Day Master): ${dm.k} ${ELEMENT[dm.e].n} (${dm.c}${ELEMENT[dm.e].c})

ã€FOUR PILLARS CHART (Year/Month/Day/Hour)ã€‘
â€¢ å¤©å¹²(Heavenly Stems): ${SAJU.year.s.c}(${SAJU.year.s.k}) ${SAJU.month.s.c}(${SAJU.month.s.k}) ${SAJU.day.s.c}(${SAJU.day.s.k}) ${SAJU.hour ? SAJU.hour.s.c+'('+SAJU.hour.s.k+')' : 'Unknown'}
â€¢ åœ°æ”¯(Earthly Branches): ${SAJU.year.b.c}(${SAJU.year.b.k}) ${SAJU.month.b.c}(${SAJU.month.b.k}) ${SAJU.day.b.c}(${SAJU.day.b.k}) ${SAJU.hour ? SAJU.hour.b.c+'('+SAJU.hour.b.k+')' : 'Unknown'}

ã€TEN GODS (Based on Stems)ã€‘
â€¢ Year Stem ${SAJU.year.s.c}: ${yearGod.k} - ${yearGod.d}
â€¢ Month Stem ${SAJU.month.s.c}: ${monthGod.k} - ${monthGod.d}
â€¢ Day Stem ${SAJU.day.s.c}: Self (æ—¥ä¸»(Day Master))
${hourGod ? 'â€¢ Hour Stem ' + SAJU.hour.s.c + ': ' + hourGod.k + ' - ' + hourGod.d : 'â€¢ Hour Stem: Unknown'}

ã€TWELVE LIFE STAGES (Based on æ—¥ä¸»(Day Master))ã€‘
â€¢ Year Branch ${SAJU.year.b.c}: ${yearState.k} (Energy ${yearState.l}/12)
â€¢ Month Branch ${SAJU.month.b.c}: ${monthState.k} (Energy ${monthState.l}/12)
â€¢ Day Branch ${SAJU.day.b.c}: ${dayState.k} (Energy ${dayState.l}/12)
${hourState ? 'â€¢ Hour Branch ' + SAJU.hour.b.c + ': ' + hourState.k + ' (Energy ' + hourState.l + '/12)' : 'â€¢ Hour Branch: Unknown'}

ã€FIVE ELEMENTS DISTRIBUTIONã€‘
â€¢ Wood (æœ¨): ${elCount.wood}
â€¢ Fire (ç«): ${elCount.fire}
â€¢ Earth (åœŸ): ${elCount.earth}
â€¢ Metal (é‡‘): ${elCount.metal}
â€¢ Water (æ°´): ${elCount.water}
â€¢ Missing Elements: ${Object.entries(elCount).filter(e => e[1] === 0).map(e => ELEMENT[e[0]].display).join(', ') || 'None'}

ã€DAY MASTER STRENGTHã€‘
â€¢ Strength: ${str.pct}% (${str.type === 'strong' ? 'STRONG Body' : str.type === 'weak' ? 'WEAK Body' : 'BALANCED'})
${str.extreme ? 'â€¢ Special Note: ' + (str.extreme === 'ê·¹ê°•' ? 'Extremely Strong' : 'Extremely Weak') + ' chart (Possible Special Format)' : ''}

ã€BENEFICIAL ELEMENTS (Yong-Shin System)ã€‘
â€¢ Beneficial God (ç”¨ç¥ Yong-shin): ${ELEMENT[GODS.yong].n} (${ELEMENT[GODS.yong].c}) - Most needed element
â€¢ Favorable God (å–œç¥ Hee-shin): ${ELEMENT[GODS.hee].n} (${ELEMENT[GODS.hee].c}) - Supports beneficial element
â€¢ Unfavorable God (å¿Œç¥ Gi-shin): ${ELEMENT[GODS.gi].n} (${ELEMENT[GODS.gi].c}) - Element to avoid
${GODS.johu ? 'â€¢ Seasonal Adjustment: ' + (GODS.johuDesc || '') : ''}
${GODS.climate ? 'â€¢ Climate Balance: ' + GODS.climate.type + ' - ' + GODS.climate.desc : ''}

ã€PERSONALITY STRUCTURE (æ ¼å±€ Geok-guk)ã€‘
â€¢ ${format.n}
â€¢ Characteristics: ${format.d}
â€¢ Suitable Fields: ${format.b}

ã€60 PILLARS DAY MASTER THEORY - ${SAJU.day.s.c}${SAJU.day.b.c} Dayã€‘
â€¢ ${ilju.title}
â€¢ Personality: ${ilju.desc?.substring(0, 100) || ''}...
â€¢ Spouse Fortune: ${ilju.spouse?.substring(0, 80) || ''}...

ã€HIDDEN STEMS (æ”¯è—å¹² Ji-jang-gan)ã€‘
${jjText}

ã€SOUND ELEMENT (ç´éŸ³ Nap-eum)ã€‘
${napeumText}

ã€LIFE PALACE (å‘½å®® Myung-gung)ã€‘
${myunggungText}

ã€CONCEPTION ORIGIN (èƒå…ƒ Tae-won)ã€‘
${taewonText}

ã€ROOT & STEM ANALYSIS (é€šæ ¹é€å¹²)ã€‘
${ttText}

ã€SIX RELATIONS (å…­è¦ª Yuk-chin)ã€‘
${ycText}

ã€PALACE ANALYSIS (å®®ä½) - Life Periodsã€‘
${gwText}

ã€HARMONY & CLASH (åˆæ²–åˆ‘ç ´å®³)ã€‘
${interactions.length ? interactions.map(i => 'â€¢ ' + i.t + ': ' + i.c + ' - ' + i.m).join('\n') : 'â€¢ No significant interactions'}

ã€DIRECTIONAL HARMONY (æ–¹åˆ Bang-hap)ã€‘
${banghapText}

ã€HIDDEN HARMONY (æš—åˆ Am-hap)ã€‘
${amhapText}

ã€EMPTY VOID (ç©ºäº¡ Gong-mang)ã€‘
â€¢ Void Branches: ${gongmang?.names?.join(', ') || 'None'}
${gongmang?.affected?.length ? 'â€¢ Affected Positions: ' + gongmang.affected.join(', ') : 'â€¢ No void in Four Pillars'}

ã€DIVINE STARS (ç¥æ®º Shin-sal)ã€‘
${sinsal.length ? sinsal.map(s => 'â€¢ ' + s.n + ' (' + (s.t === 'good' ? 'Auspicious' : s.t === 'bad' ? 'Inauspicious' : 'Neutral') + '): ' + s.d).join('\n') : 'â€¢ No significant divine stars'}

ã€LIFE CYCLES (å¤§é‹ Dae-un) - 10-Year Periodsã€‘
${luck.slice(0,8).map(l => 'â€¢ Ages ' + l.startAge + '-' + l.endAge + ': ' + l.s.c + l.b.c + ' (' + ELEMENT[l.s.e].n + '/' + ELEMENT[l.b.e].n + ')' + (l.isCur ? ' â—€ CURRENT' : '')).join('\n')}

ã€CURRENT FORTUNEã€‘
â€¢ Current å¤§é‹(Life Cycle): ${curLuck ? curLuck.s.c + curLuck.b.c + ' (Ages ' + curLuck.startAge + '-' + curLuck.endAge + ')' : 'Calculating...'}
â€¢ Cycle Rating: ${curLuck ? (curLuck.rating === 'good' ? 'FAVORABLE' : curLuck.rating === 'bad' ? 'CHALLENGING' : 'NEUTRAL') : '-'}
â€¢ ${currentYear} æ­²é‹(Annual Fortune): ${(() => { const yp = calcYearPillar(currentYear, 6, 1); return yp.s.c + yp.b.c + ' (' + ELEMENT[yp.s.e].n + '/' + ELEMENT[yp.b.e].n + ')'; })()}

ã€NEXT 10 YEARS PREVIEWã€‘
${next10Text}

ã€${currentYear} MONTHLY FORTUNEã€‘
${monthText}

===== AI INTERPRETATION REQUEST =====

[PERSONA SETTING]
You are an expert Korean fortune teller (ëª…ë¦¬í•™ì) with 30 years of experience, combining traditional wisdom with modern insights.
- Use professional terms (Peer, Indirect Wealth, Eating God, Crown, Prime, etc.) but always follow with simple metaphors that anyone can understand.
- Example: "Peer (æ¯”è‚©) represents sibling-like energy - people who share your wavelength and compete at your level."
- Tone should be warm, hopeful, and constructive. Even negative aspects must include practical advice and ways to overcome challenges.
- Write in a professional yet approachable style.
- Provide 2-3 detailed paragraphs for each section.

[ANALYSIS REQUEST]
Based on the Four Pillars data above, please provide detailed narrative interpretations for:

1. INNATE PERSONALITY & TEMPERAMENT
   - æ—¥ä¸»(Day Master) characteristics, Format meaning, 60 Pillars theory
   - Strengths and areas for growth

2. CAREER APTITUDE & PROFESSIONAL FORTUNE
   - Suitable fields based on Format, Beneficial Element, åç¥(Ten Gods)
   - Employee vs Entrepreneur disposition

3. WEALTH FORTUNE & FINANCIAL MANAGEMENT
   - Position and strength of Wealth stars
   - Money-making style and financial advice
   - If æš—åˆ(Hidden Harmony), mention hidden income or secret savings potential

4. LOVE & MARRIAGE FORTUNE
   - Spouse star, Day Branch Twelve Stage, Spouse Palace analysis
   - Ideal partner type and optimal marriage timing
   - If æš—åˆ(Hidden Harmony), mention secret romance or hidden relationship potential

5. HEALTH CONSIDERATIONS
   - Vulnerable areas due to äº”è¡Œ(Five Elements) imbalance
   - Prevention and management advice

6. CURRENT FORTUNE (${currentYear})
   - Interaction between current å¤§é‹(Life Cycle) and æ­²é‹(Annual Fortune)
   - Key opportunities and cautions for this year

7. LIFE JOURNEY OVERVIEW
   - Period analysis by Palace (childhood-youth-middle age-later years)
   - Major turning points and preparation strategies

8. COMPREHENSIVE ADVICE
   - Practical ways to utilize Beneficial Element (colors, directions, career, relationships)
   - One-line summary: The core message of this destiny chart
`;

        navigator.clipboard.writeText(text).then(() => {
            toast('ğŸ“‹ Copied! Paste into Gemini or ChatGPT');
        }).catch(() => {
            // Fallback: textarea
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            toast('ğŸ“‹ Copied to clipboard!');
        });
    } catch(err) {
        console.error('Copy error:', err);
        toast('Error copying to clipboard');
    }
}

/* ========================================
   POWERBALL & MEGA MILLIONS
   ======================================== */
let pbHistory = [];
let megaHistory = [];

function generatePowerball(type) {
    const y = +document.getElementById('pb-year').value;
    const m = +document.getElementById('pb-month').value;
    const d = +document.getElementById('pb-day').value;
    
    let numbers = [];
    let powerball;
    
    if(type === 'destiny' && y && m && d) {
        // ì‚¬ì£¼ ê¸°ë°˜ ë²ˆí˜¸ ìƒì„±
        const saju = {
            year: calcYearPillar(y, m, d),
            month: calcMonthPillar(y, m, d),
            day: calcDayPillar(y, m, d)
        };
        
        // SHA-256 í•´ì‹œë¡œ ì‹œë“œ ìƒì„±
        const seed = `${y}-${m}-${d}-PB-${Date.now()}`;
        let hash = 0;
        for(let i = 0; i < seed.length; i++) {
            hash = ((hash << 5) - hash) + seed.charCodeAt(i);
            hash = hash & hash;
        }
        
        // 5ê°œ ë²ˆí˜¸ (1-69)
        const used = new Set();
        while(numbers.length < 5) {
            hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
            const n = (hash % 69) + 1;
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        numbers.sort((a,b) => a-b);
        
        // íŒŒì›Œë³¼ (1-26)
        hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
        powerball = (hash % 26) + 1;
        
        toast('ğŸ”® Destiny numbers generated!');
    } else {
        // Quick Pick
        const used = new Set();
        while(numbers.length < 5) {
            const n = Math.floor(Math.random() * 69) + 1;
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        numbers.sort((a,b) => a-b);
        powerball = Math.floor(Math.random() * 26) + 1;
        
        toast('ğŸ² Quick Pick generated!');
    }
    
    // í‘œì‹œ
    const container = document.getElementById('pb-balls');
    container.innerHTML = '';
    
    numbers.forEach((n, i) => {
        setTimeout(() => {
            const ball = document.createElement('div');
            ball.className = 'ball';
            ball.textContent = n;
            ball.style.animationDelay = `${i * 0.1}s`;
            container.appendChild(ball);
        }, i * 200);
    });
    
    setTimeout(() => {
        const pb = document.createElement('div');
        pb.className = 'ball powerball';
        pb.textContent = powerball;
        container.appendChild(pb);
    }, 1200);
    
    document.getElementById('pb-result').style.display = 'block';
    
    // íˆìŠ¤í† ë¦¬ ì €ì¥
    pbHistory.unshift({ type: type === 'destiny' ? 'DESTINY' : 'QUICK', numbers, powerball });
    if(pbHistory.length > 5) pbHistory.pop();
    renderPbHistory();
}

function renderPbHistory() {
    if(pbHistory.length === 0) return;
    document.getElementById('pb-history').style.display = 'block';
    document.getElementById('pb-history-list').innerHTML = pbHistory.map(h => `
        <div class="history-item">
            <span class="history-type">${h.type}</span>
            <div class="history-balls">
                ${h.numbers.map(n => `<div class="ball" style="animation:none;opacity:1;">${n}</div>`).join('')}
                <div class="ball powerball" style="animation:none;opacity:1;">${h.powerball}</div>
            </div>
        </div>
    `).join('');
}

function generateMega(type) {
    const y = +document.getElementById('mega-year').value;
    const m = +document.getElementById('mega-month').value;
    const d = +document.getElementById('mega-day').value;
    
    let numbers = [];
    let megaball;
    
    if(type === 'destiny' && y && m && d) {
        const seed = `${y}-${m}-${d}-MEGA-${Date.now()}`;
        let hash = 0;
        for(let i = 0; i < seed.length; i++) {
            hash = ((hash << 5) - hash) + seed.charCodeAt(i);
            hash = hash & hash;
        }
        
        // 5ê°œ ë²ˆí˜¸ (1-70)
        const used = new Set();
        while(numbers.length < 5) {
            hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
            const n = (hash % 70) + 1;
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        numbers.sort((a,b) => a-b);
        
        // ë©”ê°€ë³¼ (1-25)
        hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
        megaball = (hash % 25) + 1;
        
        toast('ğŸ”® Destiny numbers generated!');
    } else {
        const used = new Set();
        while(numbers.length < 5) {
            const n = Math.floor(Math.random() * 70) + 1;
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        numbers.sort((a,b) => a-b);
        megaball = Math.floor(Math.random() * 25) + 1;
        
        toast('ğŸ² Quick Pick generated!');
    }
    
    const container = document.getElementById('mega-balls');
    container.innerHTML = '';
    
    numbers.forEach((n, i) => {
        setTimeout(() => {
            const ball = document.createElement('div');
            ball.className = 'ball mega';
            ball.textContent = n;
            ball.style.animationDelay = `${i * 0.1}s`;
            container.appendChild(ball);
        }, i * 200);
    });
    
    setTimeout(() => {
        const mb = document.createElement('div');
        mb.className = 'ball megaball';
        mb.textContent = megaball;
        container.appendChild(mb);
    }, 1200);
    
    document.getElementById('mega-result').style.display = 'block';
    
    megaHistory.unshift({ type: type === 'destiny' ? 'DESTINY' : 'QUICK', numbers, megaball });
    if(megaHistory.length > 5) megaHistory.pop();
    renderMegaHistory();
}

function renderMegaHistory() {
    if(megaHistory.length === 0) return;
    document.getElementById('mega-history').style.display = 'block';
    document.getElementById('mega-history-list').innerHTML = megaHistory.map(h => `
        <div class="history-item">
            <span class="history-type">${h.type}</span>
            <div class="history-balls">
                ${h.numbers.map(n => `<div class="ball mega" style="animation:none;opacity:1;">${n}</div>`).join('')}
                <div class="ball megaball" style="animation:none;opacity:1;">${h.megaball}</div>
            </div>
        </div>
    `).join('');
}

/* ========================================
   TAB SWITCHING
   ======================================== */
function switchGame(game) {
    // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.game-btn').forEach(b => b.classList.remove('active'));
    
    // ì„ íƒí•œ íƒ­ í™œì„±í™”
    document.getElementById(`tab-${game}`).classList.add('active');
    event.target.closest('.game-btn').classList.add('active');
    
    // í…Œë§ˆ ë³€ê²½
    document.body.className = game + '-mode';
}

/* ========================================
   INITIALIZATION
   ======================================== */
document.addEventListener('DOMContentLoaded', function() {
    // ì‚¬ì£¼ ì…€ë ‰íŠ¸ ì´ˆê¸°í™”
    const sajuYear = document.getElementById('saju-year');
    const sajuMonth = document.getElementById('saju-month');
    const sajuDay = document.getElementById('saju-day');
    const sajuHour = document.getElementById('saju-hour');
    
    for(let y = 2025; y >= 1940; y--) {
        const opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        if(y === 1990) opt.selected = true;
        sajuYear.appendChild(opt);
    }
    for(let m = 1; m <= 12; m++) {
        const opt = document.createElement('option');
        opt.value = m; opt.textContent = m;
        sajuMonth.appendChild(opt);
    }
    for(let d = 1; d <= 31; d++) {
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = d;
        sajuDay.appendChild(opt);
    }
    
    const hourOpts = ['Unknown','å­(23-01)','ä¸‘(01-03)','å¯…(03-05)','å¯(05-07)','è¾°(07-09)','å·³(09-11)','åˆ(11-13)','æœª(13-15)','ç”³(15-17)','é…‰(17-19)','æˆŒ(19-21)','äº¥(21-23)'];
    hourOpts.forEach((h,i) => {
        const opt = document.createElement('option');
        opt.value = i === 0 ? '' : (i-1);
        opt.textContent = h;
        sajuHour.appendChild(opt);
    });
    
    // Powerball ì…€ë ‰íŠ¸ ì´ˆê¸°í™”
    ['pb', 'mega'].forEach(prefix => {
        const yearSel = document.getElementById(`${prefix}-year`);
        const monthSel = document.getElementById(`${prefix}-month`);
        const daySel = document.getElementById(`${prefix}-day`);
        
        for(let y = 2010; y >= 1940; y--) {
            const opt = document.createElement('option');
            opt.value = y; opt.textContent = y;
            if(y === 1990) opt.selected = true;
            yearSel.appendChild(opt);
        }
        for(let m = 1; m <= 12; m++) {
            const opt = document.createElement('option');
            opt.value = m; opt.textContent = m;
            monthSel.appendChild(opt);
        }
        for(let d = 1; d <= 31; d++) {
            const opt = document.createElement('option');
            opt.value = d; opt.textContent = d;
            daySel.appendChild(opt);
        }
    });
});

</script>
</body>
</html>
